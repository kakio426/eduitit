{% extends "base.html" %}
{% load parentcomm_extras %}

{% block content %}
<section class="pt-32 pb-20 px-4 min-h-screen bg-[#E0E5EC]">
    <div class="max-w-7xl mx-auto space-y-6" x-data="{ tab: '{{ active_tab|default:'today' }}' }">
        <header class="clay-card p-6 md:p-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-start gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-white shadow-clay-inner flex items-center justify-center text-3xl">ğŸ“¨</div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-700">{{ service.title|default:"í•™ë¶€ëª¨ ì†Œí†µ í—ˆë¸Œ" }}</h1>
                        <p class="text-gray-600 mt-2">ì˜¤ëŠ˜ ì²˜ë¦¬í•  ì¼ë¶€í„° í™•ì¸í•˜ê³ , ìª½ì§€/ìƒë‹´/ì•Œë¦¼ì¥ì„ ë‹¨ê³„ë³„ë¡œ ê´€ë¦¬í•˜ì„¸ìš”.</p>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div class="px-3 py-2 rounded-xl bg-red-50 border border-red-200">
                        <p class="text-xs text-red-600 font-semibold">ë¯¸í™•ì¸ ê¸´ê¸‰</p>
                        <p class="text-xl font-bold text-red-700">{{ urgent_unchecked|length }}</p>
                    </div>
                    <div class="px-3 py-2 rounded-xl bg-amber-50 border border-amber-200">
                        <p class="text-xs text-amber-700 font-semibold">ë‹µì¥ í•„ìš”</p>
                        <p class="text-xl font-bold text-amber-700">{{ reply_waiting_messages|length }}</p>
                    </div>
                    <div class="px-3 py-2 rounded-xl bg-indigo-50 border border-indigo-200">
                        <p class="text-xs text-indigo-700 font-semibold">ìƒë‹´ ì¡°ìœ¨</p>
                        <p class="text-xl font-bold text-indigo-700">{{ consult_waiting_items|length }}</p>
                    </div>
                </div>
            </div>
        </header>

        <nav class="clay-card p-3">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                <button type="button" @click="tab='today'" :class="tab==='today' ? 'bg-purple-600 text-white' : 'bg-[#E0E5EC] text-gray-700'" class="rounded-xl py-2 font-semibold transition">ì˜¤ëŠ˜ í•  ì¼</button>
                <button type="button" @click="tab='messages'" :class="tab==='messages' ? 'bg-purple-600 text-white' : 'bg-[#E0E5EC] text-gray-700'" class="rounded-xl py-2 font-semibold transition">í•™ë¶€ëª¨ ìª½ì§€</button>
                <button type="button" @click="tab='consult'" :class="tab==='consult' ? 'bg-purple-600 text-white' : 'bg-[#E0E5EC] text-gray-700'" class="rounded-xl py-2 font-semibold transition">ìƒë‹´ ì¡°ìœ¨</button>
                <button type="button" @click="tab='notices'" :class="tab==='notices' ? 'bg-purple-600 text-white' : 'bg-[#E0E5EC] text-gray-700'" class="rounded-xl py-2 font-semibold transition">ì•Œë¦¼ì¥</button>
                <button type="button" @click="tab='contacts'" :class="tab==='contacts' ? 'bg-purple-600 text-white' : 'bg-[#E0E5EC] text-gray-700'" class="rounded-xl py-2 font-semibold transition">í•™ë¶€ëª¨ ì—°ë½ì²˜</button>
            </div>
        </nav>

        <div x-show="tab==='today'" x-cloak class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <section class="clay-card p-5">
                <h2 class="text-xl font-bold text-gray-700 mb-3">ê¸´ê¸‰ ì•ˆë‚´</h2>
                <ul class="space-y-3">
                    {% for alert in urgent_unchecked|slice:":6" %}
                    <li class="p-3 rounded-xl border border-red-300 bg-red-50">
                        <div class="flex items-center justify-between">
                            <p class="font-semibold text-gray-800">{{ alert.parent_contact.student_name }} / {{ alert.get_alert_type_display }}</p>
                            <p class="text-xs text-gray-500">{{ alert.created_at|date:"H:i" }}</p>
                        </div>
                        <p class="text-sm text-gray-700 mt-1">{{ alert.short_message }}</p>
                        <form method="post" action="{% url 'parentcomm:acknowledge_urgent_alert' alert_id=alert.id %}" class="mt-2">
                            {% csrf_token %}
                            <button type="submit" class="px-3 py-1 rounded-lg bg-red-600 text-white text-sm">í™•ì¸ ì²˜ë¦¬</button>
                        </form>
                    </li>
                    {% empty %}
                    <li class="text-gray-500">ë¯¸í™•ì¸ ê¸´ê¸‰ ì•ˆë‚´ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                    {% endfor %}
                </ul>
            </section>

            <section class="clay-card p-5">
                <h2 class="text-xl font-bold text-gray-700 mb-3">ë‹µì¥ í•„ìš”í•œ ìª½ì§€</h2>
                <ul class="space-y-3">
                    {% for item in reply_waiting_messages|slice:":6" %}
                    <li class="p-3 rounded-xl bg-[#E0E5EC] shadow-clay-inner">
                        <p class="font-semibold text-gray-800">{{ item.subject }}</p>
                        <p class="text-sm text-gray-600 mt-1">{{ item.parent_contact.student_name }} í•™ë¶€ëª¨</p>
                        <button type="button" @click="tab='messages'" class="mt-2 px-3 py-1 rounded-lg bg-slate-700 text-white text-sm">ìª½ì§€í•¨ìœ¼ë¡œ ì´ë™</button>
                    </li>
                    {% empty %}
                    <li class="text-gray-500">ì§€ê¸ˆ ë‹µì¥í•  ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
                    {% endfor %}
                </ul>
            </section>

            <section class="clay-card p-5">
                <h2 class="text-xl font-bold text-gray-700 mb-3">ìƒë‹´ ì¡°ìœ¨ ëŒ€ê¸°</h2>
                <ul class="space-y-3">
                    {% for item in consult_waiting_items|slice:":6" %}
                    <li class="p-3 rounded-xl bg-[#E0E5EC] shadow-clay-inner">
                        <p class="font-semibold text-gray-800">{{ item.parent_contact.student_name }} í•™ë¶€ëª¨ ìƒë‹´</p>
                        <p class="text-sm text-gray-600 mt-1">{{ item.get_status_display }}</p>
                        <button type="button" @click="tab='consult'" class="mt-2 px-3 py-1 rounded-lg bg-indigo-600 text-white text-sm">ìƒë‹´ ì¡°ìœ¨ë¡œ ì´ë™</button>
                    </li>
                    {% empty %}
                    <li class="text-gray-500">ì¡°ìœ¨ ì¤‘ì¸ ìƒë‹´ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                    {% endfor %}
                </ul>
            </section>
        </div>

        <div x-show="tab==='messages'" x-cloak class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <section class="clay-card p-6 space-y-3">
                <h2 class="text-2xl font-bold text-gray-700">ìƒˆ ìª½ì§€ ì‹œì‘</h2>
                <form method="post" class="space-y-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_thread">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">{{ thread_form.parent_contact.label }}</label>
                        {{ thread_form.parent_contact }}
                        {% if thread_form.parent_contact.errors %}<p class="text-red-600 text-sm mt-1">{{ thread_form.parent_contact.errors|join:", " }}</p>{% endif %}
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">{{ thread_form.subject.label }}</label>
                        {{ thread_form.subject }}
                        {% if thread_form.subject.errors %}<p class="text-red-600 text-sm mt-1">{{ thread_form.subject.errors|join:", " }}</p>{% endif %}
                    </div>
                    <button type="submit" class="px-5 py-2 rounded-xl bg-slate-700 text-white font-semibold">ìª½ì§€ ì‹œì‘</button>
                </form>
            </section>

            <section class="space-y-4">
                {% for thread in threads %}
                <article class="clay-card p-5">
                    <div class="flex items-center justify-between">
                        <p class="font-bold text-gray-800">{{ thread.subject }}</p>
                        <span class="text-xs px-2 py-1 rounded-lg {% if thread.status == 'waiting_teacher' %}bg-amber-100 text-amber-700{% else %}bg-slate-100 text-slate-600{% endif %}">
                            {{ thread.get_status_display }}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">{{ thread.parent_contact.student_name }} í•™ë¶€ëª¨</p>
                    <div class="mt-3 space-y-2">
                        {% for message in thread.messages.all|slice:"-3:" %}
                        <div class="p-2 rounded-lg bg-[#E0E5EC] shadow-clay-inner">
                            <p class="text-xs text-gray-500">{{ message.get_sender_role_display }} Â· {{ message.created_at|date:"m-d H:i" }}</p>
                            <p class="text-sm text-gray-700 whitespace-pre-wrap mt-1">{{ message.body }}</p>
                        </div>
                        {% empty %}
                        <p class="text-sm text-gray-500">ì•„ì§ ì‘ì„±ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endfor %}
                    </div>
                    <form method="post" class="mt-3">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="reply_thread">
                        <input type="hidden" name="thread_id" value="{{ thread.id }}">
                        {% with message_form=thread_message_forms|get_item:thread.id %}
                        {{ message_form.body }}
                        {% if message_form.body.errors %}<p class="text-red-600 text-sm mt-1">{{ message_form.body.errors|join:", " }}</p>{% endif %}
                        {% endwith %}
                        <button type="submit" class="mt-2 px-4 py-2 rounded-lg bg-slate-700 text-white text-sm font-semibold">ë‹µì¥ ë‚¨ê¸°ê¸°</button>
                    </form>
                </article>
                {% empty %}
                <div class="clay-card p-6 text-gray-500">í˜„ì¬ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endfor %}
            </section>
        </div>

        <div x-show="tab==='consult'" x-cloak class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <section class="clay-card p-6 space-y-3">
                <h2 class="text-2xl font-bold text-gray-700">ìƒë‹´ í•„ìš” ë“±ë¡</h2>
                <form method="post" class="space-y-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_consultation_request">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">{{ consultation_request_form.parent_contact.label }}</label>
                        {{ consultation_request_form.parent_contact }}
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">{{ consultation_request_form.reason.label }}</label>
                        {{ consultation_request_form.reason }}
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">{{ consultation_request_form.escalation_reason.label }}</label>
                        {{ consultation_request_form.escalation_reason }}
                    </div>
                    <button type="submit" class="px-5 py-2 rounded-xl bg-indigo-600 text-white font-semibold">ìƒë‹´ í•„ìš” ë“±ë¡</button>
                </form>
            </section>

            <section class="space-y-4">
                {% for req in consultation_requests %}
                <article class="clay-card p-5">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-gray-800">{{ req.parent_contact.student_name }} í•™ë¶€ëª¨ ìƒë‹´</h3>
                        <span class="text-xs px-2 py-1 rounded-lg bg-indigo-100 text-indigo-700">{{ req.get_status_display }}</span>
                    </div>
                    <p class="text-sm text-gray-700 mt-2">{{ req.reason }}</p>

                    <div class="mt-4 p-3 rounded-xl bg-[#E0E5EC] shadow-clay-inner">
                        <p class="font-semibold text-gray-700 mb-2">1ë‹¨ê³„: ìƒë‹´ ë°©ë²• ì œì•ˆ</p>
                        <form method="post" class="space-y-2">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="create_proposal">
                            <input type="hidden" name="consultation_request_id" value="{{ req.id }}">
                            {% with proposal_form=request_proposal_forms|get_item:req.id %}
                            <div class="space-y-1">
                                {% for checkbox in proposal_form.allowed_methods %}
                                <label class="flex items-center gap-2 text-sm text-gray-700">
                                    {{ checkbox.tag }} <span>{{ checkbox.choice_label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            {% if proposal_form.allowed_methods.errors %}<p class="text-red-600 text-sm">{{ proposal_form.allowed_methods.errors|join:", " }}</p>{% endif %}
                            {{ proposal_form.note }}
                            {% if proposal_form.note.errors %}<p class="text-red-600 text-sm">{{ proposal_form.note.errors|join:", " }}</p>{% endif %}
                            {% endwith %}
                            <button type="submit" class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm">ìƒë‹´ ë°©ë²• ì €ì¥</button>
                        </form>
                    </div>

                    <div class="mt-3 space-y-2">
                        {% for proposal in req.proposals.all %}
                        <div class="p-3 rounded-xl bg-white border border-gray-200">
                            <p class="font-semibold text-gray-700">ì œì•ˆëœ ë°©ë²•: {{ proposal.allowed_method_labels|join:", " }}</p>
                            {% if proposal.note %}<p class="text-sm text-gray-600 mt-1">{{ proposal.note }}</p>{% endif %}
                            <form method="post" class="mt-2 space-y-2">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="add_slot">
                                <input type="hidden" name="proposal_id" value="{{ proposal.id }}">
                                {% with slot_form=proposal_slot_forms|get_item:proposal.id %}
                                <p class="text-sm font-semibold text-gray-700">2ë‹¨ê³„: ê°€ëŠ¥í•œ ì‹œê°„ ì œì•ˆ</p>
                                {{ slot_form.method }}
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    {{ slot_form.starts_at }}
                                    {{ slot_form.ends_at }}
                                </div>
                                {{ slot_form.location_note }}
                                {{ slot_form.channel_hint }}
                                {% if slot_form.non_field_errors %}<p class="text-red-600 text-sm">{{ slot_form.non_field_errors|join:", " }}</p>{% endif %}
                                {% endwith %}
                                <button type="submit" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm">ì‹œê°„ ì¶”ê°€</button>
                            </form>
                            <ul class="mt-2 text-sm text-gray-600 list-disc list-inside">
                                {% for slot in proposal.slots.all %}
                                <li>{{ slot.get_method_display }} / {{ slot.starts_at|date:"Y-m-d H:i" }} ~ {{ slot.ends_at|date:"H:i" }}</li>
                                {% empty %}
                                <li>ë“±ë¡ëœ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% empty %}
                        <p class="text-sm text-gray-500">ì•„ì§ ìƒë‹´ ë°©ë²• ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endfor %}
                    </div>
                </article>
                {% empty %}
                <div class="clay-card p-6 text-gray-500">ìƒë‹´ ì¡°ìœ¨ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endfor %}
            </section>
        </div>

        <div x-show="tab==='notices'" x-cloak class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <section class="clay-card p-6 space-y-3">
                <h2 class="text-2xl font-bold text-gray-700">ì•Œë¦¼ì¥ ë³´ë‚´ê¸°</h2>
                <form method="post" enctype="multipart/form-data" class="space-y-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_notice">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">{{ notice_form.classroom_label.label }}</label>
                        {{ notice_form.classroom_label }}
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">{{ notice_form.title.label }}</label>
                        {{ notice_form.title }}
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">{{ notice_form.content.label }}</label>
                        {{ notice_form.content }}
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">{{ notice_form.attachment.label }}</label>
                        {{ notice_form.attachment }}
                    </div>
                    <label class="inline-flex items-center gap-2 text-sm text-gray-700">
                        {{ notice_form.is_pinned }} {{ notice_form.is_pinned.label }}
                    </label>
                    <button type="submit" class="px-5 py-2 rounded-xl bg-teal-600 text-white font-semibold">ì•Œë¦¼ì¥ ë“±ë¡</button>
                </form>
            </section>

            <section class="space-y-3">
                {% for notice in notices %}
                <article class="clay-card p-5">
                    <p class="font-semibold text-gray-800">{{ notice.title }}</p>
                    <p class="text-sm text-gray-700 mt-1 whitespace-pre-wrap">{{ notice.content|truncatechars:130 }}</p>
                    <p class="text-xs text-gray-500 mt-2">{{ notice.published_at|date:"Y-m-d H:i" }}</p>
                    {% if notice.attachment %}
                    <a href="{{ notice.attachment.url }}" class="inline-flex mt-2 px-3 py-1.5 rounded-lg bg-slate-700 text-white text-sm" download>ì²¨ë¶€íŒŒì¼ ë°›ê¸°</a>
                    {% endif %}
                </article>
                {% empty %}
                <div class="clay-card p-6 text-gray-500">ë“±ë¡ëœ ì•Œë¦¼ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endfor %}
            </section>
        </div>

        <div x-show="tab==='contacts'" x-cloak class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <section class="clay-card p-6 space-y-3">
                <h2 class="text-2xl font-bold text-gray-700">í•™ë¶€ëª¨ ì—°ë½ì²˜ ë“±ë¡</h2>
                <form method="post" class="space-y-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_contact">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">{{ contact_form.student_name.label }}</label>
                            {{ contact_form.student_name }}
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">{{ contact_form.parent_name.label }}</label>
                            {{ contact_form.parent_name }}
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">{{ contact_form.student_grade.label }}</label>
                            {{ contact_form.student_grade }}
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">{{ contact_form.student_classroom.label }}</label>
                            {{ contact_form.student_classroom }}
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">{{ contact_form.relationship.label }}</label>
                            {{ contact_form.relationship }}
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">{{ contact_form.contact_phone.label }}</label>
                            {{ contact_form.contact_phone }}
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm text-gray-600 mb-1">{{ contact_form.contact_email.label }}</label>
                            {{ contact_form.contact_email }}
                        </div>
                    </div>
                    <button type="submit" class="px-5 py-2 rounded-xl bg-blue-600 text-white font-semibold">ì—°ë½ì²˜ ì¶”ê°€</button>
                </form>
            </section>

            <section class="space-y-3">
                {% for contact in contacts %}
                <article class="clay-card p-5" x-data="{ copied: false }">
                    <p class="font-semibold text-gray-800">{{ contact.student_name }} / {{ contact.parent_name }}</p>
                    <p class="text-sm text-gray-600 mt-1">{{ contact.contact_email }} {{ contact.contact_phone }}</p>
                    <div class="mt-2 flex flex-wrap gap-2 items-center">
                        <a href="{% url 'parentcomm:urgent_entry' access_id=contact.emergency_access_id %}" class="px-3 py-1.5 rounded-lg bg-red-600 text-white text-sm font-semibold">ê¸´ê¸‰ì•ˆë‚´ í˜ì´ì§€</a>
                        <button type="button"
                                class="px-3 py-1.5 rounded-lg bg-slate-700 text-white text-sm"
                                data-link="{{ request.scheme }}://{{ request.get_host }}{% url 'parentcomm:urgent_entry' access_id=contact.emergency_access_id %}"
                                @click="navigator.clipboard.writeText($el.dataset.link); copied=true; setTimeout(()=>copied=false, 1500)">
                            ë§í¬ ë³µì‚¬
                        </button>
                        <span x-show="copied" x-cloak class="text-xs text-emerald-700 font-semibold">ë³µì‚¬ë¨</span>
                    </div>
                </article>
                {% empty %}
                <div class="clay-card p-6 text-gray-500">ë“±ë¡ëœ í•™ë¶€ëª¨ ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endfor %}
            </section>
        </div>
    </div>
</section>
{% endblock %}

