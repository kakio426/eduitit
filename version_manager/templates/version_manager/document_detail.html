{% extends 'base.html' %}

{% block title %}{{ document.base_name }} | 최신본 센터{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-4 min-h-screen">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-wrap items-start justify-between gap-4 mb-8">
            <div>
                <a href="{% url 'version_manager:document_list' %}" class="text-sm text-purple-600 font-semibold hover:underline">목록으로</a>
                <h1 class="text-4xl font-bold text-gray-700 font-title mt-2">{{ document.base_name }}</h1>
                <p class="text-gray-600 mt-1">{{ document.group.name }}</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <a href="{% url 'version_manager:download_latest' document.id %}" class="px-4 py-2 bg-purple-500 text-white rounded-full font-semibold">최신본 다운로드</a>
                {% if published_version %}
                <a href="{% url 'version_manager:download_published' document.id %}" class="px-4 py-2 bg-green-500 text-white rounded-full font-semibold">배포본 다운로드</a>
                {% endif %}
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
                <div class="clay-card p-6">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">버전 업로드</h2>
                    <form method="post" action="{% url 'version_manager:upload_version' document.id %}" enctype="multipart/form-data" class="space-y-4">
                        {% csrf_token %}
                        <input type="file" name="file" required class="block w-full text-sm text-gray-700">
                        <button type="submit" class="w-full px-4 py-3 bg-purple-500 text-white rounded-full font-bold">업로드</button>
                    </form>
                    <p class="text-xs text-gray-500 mt-4">파일명/경로/버전은 자동으로 정리됩니다.</p>
                </div>

                <div class="clay-card p-6 mt-6">
                    <h2 class="text-xl font-bold text-gray-700 mb-3">보호 문구</h2>
                    <form method="post" action="{% url 'version_manager:add_protected_phrase' document.id %}" class="space-y-3">
                        {% csrf_token %}
                        <input type="text" name="phrase" required class="w-full rounded-2xl px-4 py-3 shadow-clay-inner bg-[#E0E5EC] focus:outline-none" placeholder="예: 학교명, 학년명 등">
                        <button type="submit" class="w-full px-4 py-3 bg-orange-500 text-white rounded-full font-bold">문구 추가</button>
                    </form>
                    <div class="mt-4 space-y-2">
                        {% for phrase in phrases %}
                        <div class="flex items-center justify-between gap-2 text-sm">
                            <span class="text-gray-700">{{ phrase.phrase }}</span>
                            <form method="post" action="{% url 'version_manager:remove_protected_phrase' document.id phrase.id %}">
                                {% csrf_token %}
                                <button type="submit" class="text-red-600 font-semibold hover:underline">제거</button>
                            </form>
                        </div>
                        {% empty %}
                        <p class="text-xs text-gray-500">등록된 보호 문구가 없습니다.</p>
                        {% endfor %}
                    </div>
                </div>

                <div class="clay-card p-6 mt-6">
                    <h2 class="text-xl font-bold text-gray-700 mb-3">공유 링크</h2>
                    <form method="post" action="{% url 'version_manager:create_share_link' document.id %}">
                        {% csrf_token %}
                        <button type="submit" class="w-full px-4 py-3 bg-blue-500 text-white rounded-full font-bold">공유 링크 생성</button>
                    </form>
                    <div class="mt-4 space-y-3">
                        {% for link in share_links %}
                        <div class="text-xs text-gray-600 p-3 bg-white/40 rounded-xl">
                            <p class="break-all">{{ link.url }}</p>
                            <div class="mt-2 flex items-center justify-between">
                                <span>{% if link.is_valid %}활성{% else %}비활성{% endif %}</span>
                                <form method="post" action="{% url 'version_manager:toggle_share_link' document.id link.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="text-purple-600 font-semibold hover:underline">{% if link.is_active %}비활성화{% else %}활성화{% endif %}</button>
                                </form>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-xs text-gray-500">생성된 공유 링크가 없습니다.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="clay-card p-6 overflow-x-auto">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">버전 목록</h2>
                    <table class="w-full min-w-[760px] text-left">
                        <thead>
                            <tr class="text-gray-600 border-b border-gray-200">
                                <th class="py-3">버전</th>
                                <th class="py-3">업로드 시간</th>
                                <th class="py-3">업로더</th>
                                <th class="py-3">상태</th>
                                <th class="py-3 text-right">액션</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for version in versions %}
                            <tr class="border-b border-gray-100">
                                <td class="py-4 font-semibold text-gray-700">v{{ version.version|stringformat:'02d' }}</td>
                                <td class="py-4 text-gray-600">{{ version.created_at|date:'Y-m-d H:i' }}</td>
                                <td class="py-4 text-gray-600">{{ version.uploaded_by_name|default:'-' }}</td>
                                <td class="py-4">
                                    {% if published_version and version.id == published_version.id %}
                                    <span class="inline-flex px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-semibold">published</span>
                                    {% elif latest_version and version.id == latest_version.id %}
                                    <span class="inline-flex px-3 py-1 rounded-full bg-purple-100 text-purple-700 text-xs font-semibold">latest</span>
                                    {% else %}
                                    <span class="inline-flex px-3 py-1 rounded-full bg-gray-100 text-gray-600 text-xs font-semibold">{{ version.status }}</span>
                                    {% endif %}
                                </td>
                                <td class="py-4 text-right">
                                    <div class="flex justify-end items-center gap-2">
                                        <a href="{% url 'version_manager:download_version' document.id version.id %}" class="text-purple-600 text-sm font-semibold hover:underline">다운로드</a>
                                        {% if version.missing_protected_phrases %}
                                        <span class="text-orange-600 text-xs font-semibold">문구경고 {{ version.missing_protected_phrases|length }}</span>
                                        {% endif %}
                                        {% if request.user.is_staff %}
                                        <form method="post" action="{% url 'version_manager:set_published' document.id version.id %}">
                                            {% csrf_token %}
                                            <button type="submit" class="text-green-700 text-sm font-semibold hover:underline">배포본으로 지정</button>
                                        </form>
                                        {% endif %}
                                        {% if request.user.is_staff or version.uploaded_by_id == request.user.id %}
                                        <form method="post" action="{% url 'version_manager:delete_version' document.id version.id %}">
                                            {% csrf_token %}
                                            <button type="submit" class="text-red-600 text-sm font-semibold hover:underline">삭제</button>
                                        </form>
                                        {% endif %}
                                    </div>
                                    {% if version.diff_supported and version.diff_summary %}
                                    <details class="mt-3 text-left">
                                        <summary class="text-xs text-blue-600 font-semibold cursor-pointer">변경 diff 보기</summary>
                                        <pre class="mt-2 p-3 text-[11px] bg-white/50 rounded-lg whitespace-pre-wrap break-words">{{ version.diff_summary }}</pre>
                                    </details>
                                    {% elif version.diff_error %}
                                    <p class="mt-2 text-xs text-gray-500">{{ version.diff_error }}</p>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="py-10 text-center text-gray-500">아직 업로드된 버전이 없습니다.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
