{% extends 'base.html' %}
{% load static %}

{% block title %}ì²´ìŠ¤ í”Œë ˆì´ - Eduitit{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
<style>
    .board-container {
        max-width: 600px;
        margin: 0 auto;
    }

    #myBoard {
        width: 100%;
    }

    .game-info {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 8px 8px 16px rgb(163, 177, 198, 0.5), -8px -8px 16px rgba(255, 255, 255, 0.6);
    }

    .move-history {
        max-height: 300px;
        overflow-y: auto;
    }

    .move-item {
        padding: 0.5rem;
        border-radius: 10px;
        margin-bottom: 0.25rem;
        transition: all 0.2s;
    }

    .move-item:hover {
        background: #f3f4f6;
    }

    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .status-white {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        color: #374151;
    }

    .status-black {
        background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
        color: white;
    }

    .status-check {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    .btn-game {
        padding: 0.75rem 1.5rem;
        border-radius: 15px;
        font-weight: bold;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }

    .btn-primary {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        color: white;
        box-shadow: 0 4px 6px rgba(124, 58, 237, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(124, 58, 237, 0.4);
    }

    .btn-secondary {
        background: #e5e7eb;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #d1d5db;
    }

    .ai-thinking {
        display: none;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-radius: 15px;
        color: #1e40af;
        font-weight: bold;
    }

    .ai-thinking.active {
        display: flex;
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 3px solid #93c5fd;
        border-top-color: #1e40af;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
    .white-1e1d7 {
        background-color: #f0d9b5;
    }

    .black-3c85d {
        background-color: #b58863;
    }

    .highlight-selected {
        box-shadow: inset 0 0 3px 3px yellow;
    }

    .highlight-hint {
        position: relative;
    }

    .highlight-hint::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 25%;
        height: 25%;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 50%;
    }

    .highlight-attack {
        box-shadow: inset 0 0 3px 3px rgba(255, 0, 0, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen pt-32 pb-20 px-6">
    <div class="max-w-7xl mx-auto">

        <!-- Game Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-black text-gray-700 mb-2">
                {% if mode == 'ai' %}
                ğŸ¤– AIì™€ ëŒ€ì „
                {% else %}
                ğŸ‘¥ 1ëŒ€1 ë¡œì»¬ ëŒ€ì „
                {% endif %}
            </h1>
            {% if mode == 'ai' %}
            <p class="text-xl text-gray-500">
                ë‚œì´ë„:
                {% if difficulty == 'easy' %}ğŸŒ± ì´ˆê¸‰
                {% elif difficulty == 'medium' %}ğŸŒ¿ ì¤‘ê¸‰
                {% elif difficulty == 'hard' %}ğŸŒ³ ê³ ê¸‰
                {% else %}ğŸ”¥ ìµœê°•{% endif %}
            </p>
            {% endif %}
        </div>

        <div class="grid lg:grid-cols-3 gap-8">

            <!-- Chessboard -->
            <div class="lg:col-span-2">
                <div class="clay-card p-6">
                    <div class="board-container">
                        <div id="myBoard"></div>
                    </div>

                    <!-- AI Thinking Indicator -->
                    <div id="aiThinking" class="ai-thinking mt-4">
                        <div class="spinner"></div>
                        <span>AIê°€ ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...</span>
                    </div>
                </div>
            </div>

            <!-- Game Info Panel -->
            <div class="lg:col-span-1">
                <div class="game-info mb-4">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">ê²Œì„ ì •ë³´</h2>

                    <!-- Status -->
                    <div class="mb-4">
                        <div id="status" class="status-badge status-white">ë°±ì˜ ì°¨ë¡€</div>
                    </div>

                    <!-- Game Controls -->
                    <div class="flex flex-col gap-3">
                        <button onclick="resetGame()" class="btn-game btn-primary">
                            <i class="fa-solid fa-rotate-right mr-2"></i>
                            ìƒˆ ê²Œì„
                        </button>
                        <button onclick="undoMove()" class="btn-game btn-secondary" id="undoBtn">
                            <i class="fa-solid fa-rotate-left mr-2"></i>
                            ë˜ëŒë¦¬ê¸°
                        </button>
                        <a href="{% url 'chess:index' %}" class="btn-game btn-secondary text-center">
                            <i class="fa-solid fa-home mr-2"></i>
                            ë©”ì¸ìœ¼ë¡œ
                        </a>
                    </div>
                </div>

                <!-- Move History -->
                <div class="game-info">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-history text-purple-500"></i>
                        ì´ë™ ê¸°ë¡
                    </h2>
                    <div id="moveHistory" class="move-history">
                        <p class="text-gray-400 italic">ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Game Over Modal -->
<div id="gameOverModal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500/20 backdrop-blur-md transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div
                class="relative transform overflow-hidden rounded-[2.5rem] bg-white text-center shadow-2xl p-10 max-w-md w-full">
                <div class="text-6xl mb-4" id="gameOverIcon">ğŸ†</div>
                <h3 class="text-3xl font-bold text-gray-800 mb-3" id="gameOverTitle">ì²´í¬ë©”ì´íŠ¸!</h3>
                <p class="text-xl text-gray-600 mb-6" id="gameOverMessage">ë°± ìŠ¹ë¦¬!</p>
                <div class="flex flex-col gap-3">
                    <button onclick="resetGame()" class="btn-game btn-primary w-full">
                        <i class="fa-solid fa-rotate-right mr-2"></i>
                        ë‹¤ì‹œ ì‹œì‘í•˜ê¸°
                    </button>
                    <button onclick="closeGameOverModal()" class="btn-game btn-secondary w-full">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
{% if mode == 'ai' %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js"></script>
{% endif %}

<script>
    var board = null;
    var game = new Chess();
    var moveHistory = [];
    var isAIMode = '{{ mode }}' === 'ai';
    var aiDifficulty = '{{ difficulty }}';
    var stockfish = null;
    var isAIThinking = false;
    var selectedSquare = null;

    // AI ì—”ì§„ ì´ˆê¸°í™”
    if (isAIMode && typeof STOCKFISH === 'function') {
        try {
            stockfish = STOCKFISH();
            stockfish.onmessage = onStockfishMessage;

            // UCI ì´ˆê¸°í™”
            stockfish.postMessage('uci');

            // OOM ë°©ì§€ë¥¼ ìœ„í•œ ë©”ëª¨ë¦¬ ì œí•œ ë° ìµœì í™”
            stockfish.postMessage('setoption name Hash value 16'); // 16MBë¡œ ëŒ€í­ ì¶•ì†Œ
            stockfish.postMessage('setoption name Threads value 1'); // ìŠ¤ë ˆë“œ 1ê°œë¡œ ì œí•œ

            // AI ë‚œì´ë„ ì„¤ì •
            var skillLevel = 10;
            if (aiDifficulty === 'easy') skillLevel = 2;
            else if (aiDifficulty === 'medium') skillLevel = 8;
            else if (aiDifficulty === 'hard') skillLevel = 13;
            else if (aiDifficulty === 'expert') skillLevel = 18;

            stockfish.postMessage('setoption name Skill Level value ' + skillLevel);
        } catch (e) {
            console.error('AI Initialization failed:', e);
        }
    }

    function removeHighlights() {
        $('#myBoard .square-55d63').removeClass('highlight-selected highlight-hint highlight-attack');
    }

    function highlightSquare(square, type) {
        var $square = $('#myBoard .square-' + square);
        if (type === 'selected') $square.addClass('highlight-selected');
        else if (type === 'hint') $square.addClass('highlight-hint');
        else if (type === 'attack') $square.addClass('highlight-attack');
    }

    function onSquareClick(square) {
        // ê²Œì„ ì˜¤ë²„ ìƒíƒœë©´ ë¬´ì‹œ
        if (game.game_over()) return;

        // AI í„´ì´ë©´ ë¬´ì‹œ
        if (isAIMode && game.turn() === 'b') return;

        var piece = game.get(square);

        // 1. ì´ë¯¸ ë§ì„ ì„ íƒí•œ ìƒíƒœì—ì„œ ë‹¤ë¥¸ ì¹¸(ë˜ëŠ” ë¹ˆì¹¸)ì„ ëˆ„ë¥¸ ê²½ìš° -> ì´ë™ ì‹œë„
        if (selectedSquare) {
            var move = game.move({
                from: selectedSquare,
                to: square,
                promotion: 'q'
            });

            if (move) {
                // ì´ë™ ì„±ê³µ
                board.position(game.fen());
                moveHistory.push(move);
                updateMoveHistory();
                updateStatus();
                selectedSquare = null;
                removeHighlights();

                if (isAIMode && !game.game_over()) {
                    window.setTimeout(makeAIMove, 250);
                }
                return;
            }
        }

        // 2. ì´ë™ì— ì‹¤íŒ¨í–ˆê±°ë‚˜ ìƒˆë¡œ ë§ì„ ì„ íƒí•˜ëŠ” ê²½ìš°
        removeHighlights();

        // ë‚´ ë§ì´ ì•„ë‹ˆë©´ ì„ íƒ ì·¨ì†Œ
        if (!piece || piece.color !== game.turn()) {
            selectedSquare = null;
            return;
        }

        // ìê¸° ë§ ì„ íƒ
        selectedSquare = square;
        highlightSquare(square, 'selected');

        // ê°€ëŠ¥í•œ ì´ë™ ê²½ë¡œ í‘œì‹œ
        var moves = game.moves({
            square: square,
            verbose: true
        });

        moves.forEach(function (m) {
            highlightSquare(m.to, m.captured ? 'attack' : 'hint');
        });
    }

    function onDragStart(source, piece, position, orientation) {
        // ëª¨ë°”ì¼ í™˜ê²½ ì²´í¬
        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // ëª¨ë°”ì¼ì—ì„œëŠ” ë“œë˜ê·¸ë¥¼ ë§‰ê³  í´ë¦­ë§Œ í—ˆìš© (ìŠ¤í¬ë¡¤ ë°©í•´ ê¸ˆì§€)
        if (isMobile) return false;

        if (game.game_over()) return false;
        if (isAIMode && game.turn() === 'b') return false;
        if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
            (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
            return false;
        }
    }

    function onDrop(source, target) {
        removeHighlights();
        var move = game.move({
            from: source,
            to: target,
            promotion: 'q'
        });

        if (move === null) return 'snapback';

        moveHistory.push(move);
        updateMoveHistory();
        updateStatus();
        selectedSquare = null;

        if (isAIMode && !game.game_over()) {
            window.setTimeout(makeAIMove, 250);
        }
    }

    function onSnapEnd() {
        board.position(game.fen());
    }

    function updateStatus() {
        var status = '';
        var statusEl = document.getElementById('status');
        var moveColor = game.turn() === 'w' ? 'ë°±' : 'í‘';

        if (game.in_checkmate()) {
            status = 'ê²Œì„ ì¢…ë£Œ - ' + (game.turn() === 'w' ? 'í‘' : 'ë°±') + ' ìŠ¹ë¦¬!';
            statusEl.className = 'status-badge status-check';
            showGameOver(game.turn() === 'w' ? 'í‘ ìŠ¹ë¦¬!' : 'ë°± ìŠ¹ë¦¬!', 'ì²´í¬ë©”ì´íŠ¸!');
        } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition()) {
            status = 'ê²Œì„ ì¢…ë£Œ - ë¬´ìŠ¹ë¶€';
            statusEl.className = 'status-badge status-white';
            showGameOver('ë¬´ìŠ¹ë¶€', 'ë¬´ìŠ¹ë¶€ ìƒí™©ì…ë‹ˆë‹¤.');
        } else {
            status = moveColor + 'ì˜ ì°¨ë¡€' + (game.in_check() ? ' - ì²´í¬!' : '');
            statusEl.className = game.turn() === 'w' ? 'status-badge status-white' : 'status-badge status-black';
            if (game.in_check()) statusEl.className += ' status-check';
        }

        statusEl.textContent = status;
    }

    function updateMoveHistory() {
        var historyEl = document.getElementById('moveHistory');
        historyEl.innerHTML = '';

        if (moveHistory.length === 0) {
            historyEl.innerHTML = '<p class="text-gray-400 italic">ì•„ì§ ì´ë™ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            return;
        }

        for (var i = 0; i < moveHistory.length; i += 2) {
            var moveNum = Math.floor(i / 2) + 1;
            var whiteMove = moveHistory[i].san;
            var blackMove = moveHistory[i + 1] ? moveHistory[i + 1].san : '...';

            var moveDiv = document.createElement('div');
            moveDiv.className = 'move-item flex items-center gap-3 text-sm';
            moveDiv.innerHTML = `
                <span class="font-bold text-gray-400 w-8">${moveNum}.</span>
                <span class="flex-1 text-gray-700">${whiteMove}</span>
                ${blackMove !== '...' ? `<span class="flex-1 text-gray-700">${blackMove}</span>` : ''}
            `;
            historyEl.appendChild(moveDiv);
        }
        historyEl.scrollTop = historyEl.scrollHeight;
    }

    function makeAIMove() {
        if (game.game_over() || !stockfish || isAIThinking) return;

        isAIThinking = true;
        document.getElementById('aiThinking').classList.add('active');

        var fen = game.fen();
        stockfish.postMessage('position fen ' + fen);
        stockfish.postMessage('go depth 10');
    }

    function onStockfishMessage(event) {
        var line = event.data;
        if (line.indexOf('bestmove') !== -1) {
            var match = line.match(/bestmove\s+(\w+)/);
            if (match) {
                var move = game.move({
                    from: match[1].substring(0, 2),
                    to: match[1].substring(2, 4),
                    promotion: match[1].length > 4 ? match[1][4] : 'q'
                });

                if (move) {
                    board.position(game.fen());
                    moveHistory.push(move);
                    updateMoveHistory();
                    updateStatus();
                }

                isAIThinking = false;
                document.getElementById('aiThinking').classList.remove('active');
            }
        }
    }

    function resetGame() {
        game.reset();
        board.start();
        moveHistory = [];
        selectedSquare = null;
        removeHighlights();
        updateMoveHistory();
        updateStatus();
        closeGameOverModal();
    }

    function undoMove() {
        if (moveHistory.length === 0) return;
        if (isAIMode && moveHistory.length >= 2) {
            game.undo(); game.undo();
            moveHistory.pop(); moveHistory.pop();
        } else if (!isAIMode) {
            game.undo(); moveHistory.pop();
        }
        board.position(game.fen());
        selectedSquare = null;
        removeHighlights();
        updateMoveHistory();
        updateStatus();
    }

    function showGameOver(title, message) {
        document.getElementById('gameOverTitle').textContent = title;
        document.getElementById('gameOverMessage').textContent = message;
        var icon = 'ğŸ†';
        if (message.includes('ë¬´ìŠ¹ë¶€')) icon = 'ğŸ¤';
        else if (title.includes('í‘')) icon = 'â™š';
        else icon = 'â™”';
        document.getElementById('gameOverIcon').textContent = icon;
        setTimeout(function () { document.getElementById('gameOverModal').classList.remove('hidden'); }, 500);
    }

    function closeGameOverModal() {
        document.getElementById('gameOverModal').classList.add('hidden');
    }

    var config = {
        draggable: true,
        position: 'start',
        pieceTheme: function (piece) {
            return 'https://raw.githubusercontent.com/oakmac/chessboardjs/master/website/img/chesspieces/wikipedia/' + piece + '.png';
        },
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd
    };

    board = Chessboard('myBoard', config);

    // í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²° (ë¬¸ì„œ ë ˆë²¨ì—ì„œ ìœ„ì„)
    $(document).on('click', '.square-55d63', function (e) {
        var square = $(this).attr('data-square');
        if (square) {
            onSquareClick(square);
        }
    });

    updateStatus();

    // ë°˜ì‘í˜• ëŒ€ì‘
    window.addEventListener('resize', function () {
        if (board) board.resize();
    });
</script>
{% endblock %}