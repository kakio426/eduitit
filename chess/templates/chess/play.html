{% extends 'base.html' %}
{% load static %}

{% block title %}ì²´ìŠ¤ í”Œë ˆì´ - Eduitit{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
<style>
    .board-container {
        max-width: 600px;
        margin: 0 auto;
    }

    #myBoard {
        width: 100%;
    }

    .game-info {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 8px 8px 16px rgb(163, 177, 198, 0.5), -8px -8px 16px rgba(255, 255, 255, 0.6);
    }

    .move-history {
        max-height: 300px;
        overflow-y: auto;
    }

    .move-item {
        padding: 0.5rem;
        border-radius: 10px;
        margin-bottom: 0.25rem;
        transition: all 0.2s;
    }

    .move-item:hover {
        background: #f3f4f6;
    }

    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .status-white {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        color: #374151;
    }

    .status-black {
        background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
        color: white;
    }

    .status-check {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    .btn-game {
        padding: 0.75rem 1.5rem;
        border-radius: 15px;
        font-weight: bold;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }

    .btn-primary {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        color: white;
        box-shadow: 0 4px 6px rgba(124, 58, 237, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(124, 58, 237, 0.4);
    }

    .btn-secondary {
        background: #e5e7eb;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #d1d5db;
    }

    .ai-thinking {
        display: none;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-radius: 15px;
        color: #1e40af;
        font-weight: bold;
    }

    .ai-thinking.active {
        display: flex;
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 3px solid #93c5fd;
        border-top-color: #1e40af;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
    .white-1e1d7 {
        background-color: #f0d9b5;
    }

    .black-3c85d {
        background-color: #b58863;
    }

    .highlight-selected {
        box-shadow: inset 0 0 3px 3px yellow;
    }

    .highlight-hint {
        position: relative;
    }

    .highlight-hint::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 25%;
        height: 25%;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 50%;
    }

    .highlight-attack {
        box-shadow: inset 0 0 3px 3px rgba(255, 0, 0, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen pt-32 pb-20 px-6">
    <div class="max-w-7xl mx-auto">

        <!-- Game Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-black text-gray-700 mb-2">
                {% if mode == 'ai' %}
                ğŸ¤– AIì™€ ëŒ€ì „
                {% else %}
                ğŸ‘¥ 1ëŒ€1 ë¡œì»¬ ëŒ€ì „
                {% endif %}
            </h1>
            {% if mode == 'ai' %}
            <p class="text-xl text-gray-500">
                ë‚œì´ë„:
                {% if difficulty == 'easy' %}ğŸŒ± ì´ˆê¸‰
                {% elif difficulty == 'medium' %}ğŸŒ¿ ì¤‘ê¸‰
                {% elif difficulty == 'hard' %}ğŸŒ³ ê³ ê¸‰
                {% else %}ğŸ”¥ ìµœê°•{% endif %}
            </p>
            {% endif %}
        </div>

        <div class="grid lg:grid-cols-3 gap-8">

            <!-- Chessboard -->
            <div class="lg:col-span-2">
                <div class="clay-card p-6">
                    <div class="board-container">
                        <div id="myBoard"></div>
                    </div>

                    <!-- AI Thinking Indicator -->
                    <div id="aiThinking" class="ai-thinking mt-4">
                        <div class="spinner"></div>
                        <span>AIê°€ ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...</span>
                    </div>
                </div>
            </div>

            <!-- Game Info Panel -->
            <div class="lg:col-span-1">
                <div class="game-info mb-4">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">ê²Œì„ ì •ë³´</h2>

                    <!-- Status -->
                    <div class="mb-4">
                        <div id="status" class="status-badge status-white">ë°±ì˜ ì°¨ë¡€</div>
                    </div>

                    <!-- Game Controls -->
                    <div class="flex flex-col gap-3">
                        <button onclick="resetGame()" class="btn-game btn-primary">
                            <i class="fa-solid fa-rotate-right mr-2"></i>
                            ìƒˆ ê²Œì„
                        </button>
                        <button onclick="undoMove()" class="btn-game btn-secondary" id="undoBtn">
                            <i class="fa-solid fa-rotate-left mr-2"></i>
                            ë˜ëŒë¦¬ê¸°
                        </button>
                        <a href="{% url 'chess:index' %}" class="btn-game btn-secondary text-center">
                            <i class="fa-solid fa-home mr-2"></i>
                            ë©”ì¸ìœ¼ë¡œ
                        </a>
                    </div>
                </div>

                <!-- Move History -->
                <div class="game-info">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-history text-purple-500"></i>
                        ì´ë™ ê¸°ë¡
                    </h2>
                    <div id="moveHistory" class="move-history">
                        <p class="text-gray-400 italic">ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Game Over Modal -->
<div id="gameOverModal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500/20 backdrop-blur-md transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div
                class="relative transform overflow-hidden rounded-[2.5rem] bg-white text-center shadow-2xl p-10 max-w-md w-full">
                <div class="text-6xl mb-4" id="gameOverIcon">ğŸ†</div>
                <h3 class="text-3xl font-bold text-gray-800 mb-3" id="gameOverTitle">ì²´í¬ë©”ì´íŠ¸!</h3>
                <p class="text-xl text-gray-600 mb-6" id="gameOverMessage">ë°± ìŠ¹ë¦¬!</p>
                <div class="flex flex-col gap-3">
                    <button onclick="resetGame()" class="btn-game btn-primary w-full">
                        <i class="fa-solid fa-rotate-right mr-2"></i>
                        ë‹¤ì‹œ ì‹œì‘í•˜ê¸°
                    </button>
                    <button onclick="closeGameOverModal()" class="btn-game btn-secondary w-full">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
{% if mode == 'ai' %}
<!-- StockfishëŠ” Workerë¡œë§Œ ë¡œë“œë¨ (chess_logic.jsì—ì„œ ì²˜ë¦¬) -->
{% endif %}

<script>
    // Configuration for chess_logic.js
    var STOCKFISH_PATH = "{% static 'chess/js/stockfish.js' %}";
    var IS_AI_MODE = '{{ mode }}' === 'ai';
    var AI_DIFFICULTY = '{{ difficulty }}';
</script>
<script src="{% static 'chess/js/chess_logic.js' %}"></script>
{% endblock %}