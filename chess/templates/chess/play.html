{% extends 'base.html' %}
{% load static %}

{% block title %}ì²´ìŠ¤ í”Œë ˆì´ - Eduitit{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
<style>
    .board-container {
        max-width: 600px;
        margin: 0 auto;
    }

    #myBoard {
        width: 100%;
    }

    .game-info {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 8px 8px 16px rgb(163, 177, 198, 0.5), -8px -8px 16px rgba(255, 255, 255, 0.6);
    }

    .move-history {
        max-height: 300px;
        overflow-y: auto;
    }

    .move-item {
        padding: 0.5rem;
        border-radius: 10px;
        margin-bottom: 0.25rem;
        transition: all 0.2s;
    }

    .move-item:hover {
        background: #f3f4f6;
    }

    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .status-white {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        color: #374151;
    }

    .status-black {
        background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
        color: white;
    }

    .status-check {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    .btn-game {
        padding: 0.75rem 1.5rem;
        border-radius: 15px;
        font-weight: bold;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }

    .btn-primary {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        color: white;
        box-shadow: 0 4px 6px rgba(124, 58, 237, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(124, 58, 237, 0.4);
    }

    .btn-secondary {
        background: #e5e7eb;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #d1d5db;
    }

    .ai-thinking {
        display: none;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-radius: 15px;
        color: #1e40af;
        font-weight: bold;
    }

    .ai-thinking.active {
        display: flex;
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 3px solid #93c5fd;
        border-top-color: #1e40af;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
    .white-1e1d7 {
        background-color: #f0d9b5;
    }

    .black-3c85d {
        background-color: #b58863;
    }

    .highlight-selected {
        box-shadow: inset 0 0 3px 3px yellow;
    }

    .highlight-hint {
        position: relative;
    }

    .highlight-hint::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 25%;
        height: 25%;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 50%;
    }

    .highlight-attack {
        box-shadow: inset 0 0 3px 3px rgba(255, 0, 0, 0.3);
    }

    .highlight-last-move {
        background-color: rgba(255, 255, 0, 0.4) !important;
        box-shadow: inset 0 0 5px 2px rgba(255, 200, 0, 0.6);
    }

    .highlight-check-king {
        background: radial-gradient(circle, rgba(220, 38, 38, 0.6) 0%, rgba(185, 28, 28, 0.3) 70%) !important;
        animation: pulse-check 1.5s infinite;
    }

    @keyframes pulse-check {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    /* Captured Pieces Styles */
    .captured-pieces {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        min-height: 2rem;
        padding: 0.5rem;
        background: #f9fafb;
        border-radius: 10px;
    }

    .captured-piece {
        font-size: 1.5rem;
        opacity: 0.8;
    }

    /* Promotion Modal Styles */
    .promotion-btn {
        padding: 1rem;
        border-radius: 15px;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s;
    }

    .promotion-btn:hover {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(124, 58, 237, 0.4);
    }

    /* Toast Notification Styles */
    .toast {
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        color: white;
        padding: 1rem 2rem;
        border-radius: 20px;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: 0 10px 25px rgba(124, 58, 237, 0.5);
        opacity: 0;
        transition: all 0.5s ease;
        z-index: 1000;
        pointer-events: none;
    }

    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
</style>
{% endblock %}

{% block content %}
<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<div class="min-h-screen pt-32 pb-20 px-6">
    <div class="max-w-7xl mx-auto">

        <!-- Game Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-black text-gray-700 mb-2">
                {% if mode == 'ai' %}
                ğŸ¤– AIì™€ ëŒ€ì „
                {% else %}
                ğŸ‘¥ 1ëŒ€1 ë¡œì»¬ ëŒ€ì „
                {% endif %}
            </h1>
            {% if mode == 'ai' %}
            <p class="text-xl text-gray-500">
                ë‚œì´ë„:
                {% if difficulty == 'easy' %}ğŸŒ± ì´ˆê¸‰
                {% elif difficulty == 'medium' %}ğŸŒ¿ ì¤‘ê¸‰
                {% elif difficulty == 'hard' %}ğŸŒ³ ê³ ê¸‰
                {% else %}ğŸ”¥ ìµœê°•{% endif %}
            </p>
            {% endif %}
        </div>

        <div class="grid lg:grid-cols-3 gap-8">

            <!-- Chessboard -->
            <div class="lg:col-span-2">
                <div class="clay-card p-6">
                    <div class="board-container">
                        <div id="myBoard"></div>
                    </div>

                    <!-- AI Thinking Indicator -->
                    <div id="aiThinking" class="ai-thinking mt-4">
                        <div class="spinner"></div>
                        <span>AIê°€ ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...</span>
                    </div>
                </div>
            </div>

            <!-- Game Info Panel -->
            <div class="lg:col-span-1">
                <div class="game-info mb-4">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">ê²Œì„ ì •ë³´</h2>

                    <!-- Status -->
                    <div class="mb-4">
                        <div id="status" class="status-badge status-white">ë°±ì˜ ì°¨ë¡€</div>
                    </div>

                    <!-- Game Controls -->
                    <div class="flex flex-col gap-3">
                        <button onclick="resetGame()" class="btn-game btn-primary">
                            <i class="fa-solid fa-rotate-right mr-2"></i>
                            ìƒˆ ê²Œì„
                        </button>
                        <button onclick="undoMove()" class="btn-game btn-secondary" id="undoBtn">
                            <i class="fa-solid fa-rotate-left mr-2"></i>
                            ë˜ëŒë¦¬ê¸°
                        </button>
                        <a href="{% url 'chess:index' %}" class="btn-game btn-secondary text-center">
                            <i class="fa-solid fa-home mr-2"></i>
                            ë©”ì¸ìœ¼ë¡œ
                        </a>
                    </div>

                    <!-- Display Options -->
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <button id="highlightToggleBtn" onclick="toggleLastMoveHighlight()"
                            class="btn-game text-sm py-2 px-4 bg-yellow-100 text-yellow-700 border border-yellow-300 rounded-xl w-full">
                            ì´ì „ ìˆ˜ í‘œì‹œ: ON
                        </button>
                    </div>
                </div>

                <!-- Captured Pieces -->
                <div class="game-info mb-4">
                    <h2 class="text-2xl font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-chess text-purple-500"></i>
                        ì¡ì€ ê¸°ë¬¼
                    </h2>

                    <!-- White's Captured Pieces -->
                    <div class="mb-3">
                        <h3 class="text-sm font-semibold text-gray-600 mb-1">ë°±ì´ ì¡ì€ ê¸°ë¬¼</h3>
                        <div id="whiteCaptured" class="captured-pieces">
                            <span class="text-gray-400 text-sm italic">ì—†ìŒ</span>
                        </div>
                    </div>

                    <!-- Black's Captured Pieces -->
                    <div>
                        <h3 class="text-sm font-semibold text-gray-600 mb-1">í‘ì´ ì¡ì€ ê¸°ë¬¼</h3>
                        <div id="blackCaptured" class="captured-pieces">
                            <span class="text-gray-400 text-sm italic">ì—†ìŒ</span>
                        </div>
                    </div>
                </div>

                <!-- Move History -->
                <div class="game-info">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-history text-purple-500"></i>
                        ì´ë™ ê¸°ë¡
                    </h2>
                    <div id="moveHistory" class="move-history">
                        <p class="text-gray-400 italic">ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Pawn Promotion Modal -->
<div id="promotionModal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500/40 backdrop-blur-md transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div
                class="relative transform overflow-hidden rounded-[2rem] bg-white text-center shadow-2xl p-8 max-w-md w-full">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">â™Ÿï¸ í° ìŠ¹ê¸‰</h3>
                <p class="text-gray-600 mb-6">ìŠ¹ê¸‰í•  ê¸°ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
                <div class="grid grid-cols-4 gap-4">
                    <button onclick="selectPromotion('q')" class="promotion-btn">
                        <span class="text-6xl">â™›</span>
                        <span class="block text-sm mt-2">í€¸</span>
                    </button>
                    <button onclick="selectPromotion('r')" class="promotion-btn">
                        <span class="text-6xl">â™œ</span>
                        <span class="block text-sm mt-2">ë£©</span>
                    </button>
                    <button onclick="selectPromotion('b')" class="promotion-btn">
                        <span class="text-6xl">â™</span>
                        <span class="block text-sm mt-2">ë¹„ìˆ</span>
                    </button>
                    <button onclick="selectPromotion('n')" class="promotion-btn">
                        <span class="text-6xl">â™</span>
                        <span class="block text-sm mt-2">ë‚˜ì´íŠ¸</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Game Over Modal -->
<div id="gameOverModal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500/20 backdrop-blur-md transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4">
            <div
                class="relative transform overflow-hidden rounded-[2.5rem] bg-white text-center shadow-2xl p-10 max-w-md w-full">
                <div class="text-6xl mb-4" id="gameOverIcon">ğŸ†</div>
                <h3 class="text-3xl font-bold text-gray-800 mb-3" id="gameOverTitle">ê²Œì„ ì¢…ë£Œ</h3>
                <p class="text-xl text-gray-600 mb-6" id="gameOverMessage">ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                <div class="flex flex-col gap-3">
                    <button onclick="resetGame()" class="btn-game btn-primary w-full">
                        <i class="fa-solid fa-rotate-right mr-2"></i>
                        ë‹¤ì‹œ ì‹œì‘í•˜ê¸°
                    </button>
                    <button onclick="closeGameOverModal()" class="btn-game btn-secondary w-full">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if mode == 'ai' %}
<!-- StockfishëŠ” Workerë¡œë§Œ ë¡œë“œë¨ (chess_logic.jsì—ì„œ ì²˜ë¦¬) -->
{% endif %}

<script>
    // Configuration for chess_logic.js
    var STOCKFISH_PATH = "{% static 'chess/js/stockfish.js' %}";
    var IS_AI_MODE = '{{ mode }}' === 'ai';
    var AI_DIFFICULTY = '{{ difficulty }}';

    (function () {
        function loadScript(urls) {
            return new Promise(function (resolve, reject) {
                var index = 0;
                function tryNext() {
                    if (index >= urls.length) {
                        reject(new Error('script load failed'));
                        return;
                    }
                    var s = document.createElement('script');
                    s.src = urls[index++];
                    s.onload = resolve;
                    s.onerror = tryNext;
                    document.body.appendChild(s);
                }
                tryNext();
            });
        }

        function showLoadError() {
            var board = document.getElementById('myBoard');
            var status = document.getElementById('status');
            if (board) {
                board.innerHTML = '<div style="padding:16px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b;border-radius:12px;font-weight:600;">ì²´ìŠ¤ ë³´ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì„ í™•ì¸í•˜ê³  ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.</div>';
            }
            if (status) {
                status.textContent = 'ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨';
                status.className = 'status-badge status-check';
            }
        }

        Promise.resolve()
            .then(function () {
                return loadScript([
                    'https://code.jquery.com/jquery-3.6.0.min.js',
                    'https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js'
                ]);
            })
            .then(function () {
                return loadScript([
                    'https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js',
                    'https://cdn.jsdelivr.net/npm/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js'
                ]);
            })
            .then(function () {
                return loadScript([
                    'https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js',
                    'https://cdn.jsdelivr.net/npm/chess.js@0.10.3/chess.min.js'
                ]);
            })
            .then(function () {
                return loadScript(["{% static 'chess/js/chess_logic.js' %}"]);
            })
            .catch(showLoadError);
    })();
</script>
{% endblock %}
