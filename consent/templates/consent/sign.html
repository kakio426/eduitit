{% extends "base.html" %}

{% block title %}동의서 서명{% endblock %}

{% block extra_css %}
<style>
  #signaturePad {
    width: 100%;
    height: 180px;
    background: #fff;
    border-radius: 16px;
  }
</style>
{% endblock %}

{% block content %}
<main class="pt-32 pb-16 px-4 min-h-screen bg-[#E0E5EC]">
  <div class="max-w-2xl mx-auto">
    <div class="clay-card p-5 mb-4">
      <h1 class="text-2xl font-bold text-gray-800">{{ consent_request.title }}</h1>
      <p class="text-sm text-gray-500 mt-1">{{ recipient.student_name }} 학생 / {{ recipient.parent_name }} 학부모</p>
      {% if expires_at %}
      <p class="text-xs text-gray-500 mt-1">링크 만료: {{ expires_at|date:"Y-m-d H:i" }}</p>
      {% endif %}
      <a href="{% url 'consent:public_document' token=recipient.access_token %}" target="_blank" rel="noopener noreferrer" class="inline-block mt-3 px-3 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-sm text-gray-700 font-semibold">
        첨부 문서 다운로드
      </a>
      <div class="mt-3 rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-xs text-gray-700">
        <p class="font-semibold mb-1">동의 대상 문서 확인값</p>
        <p>파일명: {{ document_evidence.document_name|default:"(미기록)" }}</p>
        <p>SHA-256: <span class="break-all">{{ document_evidence.document_sha256|default:"(미기록)" }}</span></p>
      </div>
    </div>

    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 text-sm text-amber-900 mb-4">
      <p class="font-semibold mb-1">법적 고지</p>
      <p class="whitespace-pre-line">{{ consent_request.legal_notice }}</p>
    </div>

    <form method="post" id="signForm" class="clay-card p-5 space-y-4">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-semibold mb-2">동의 여부</label>
        <div class="space-y-1">{{ form.decision }}</div>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">비동의 사유(선택)</label>
        {{ form.decline_reason }}
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">학부모 서명</label>
        <canvas id="signaturePad" class="shadow-clay-inner"></canvas>
        <div class="flex gap-2 mt-2">
          <button type="button" id="clearBtn" class="px-4 py-2 rounded-xl shadow-clay-inner bg-bg-soft">지우기</button>
        </div>
        {{ form.signature_data }}
      </div>

      {{ form.non_field_errors }}
      <button type="submit" class="w-full py-2.5 rounded-xl bg-purple-600 text-white font-semibold hover:bg-purple-700">제출하기</button>
    </form>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
  const canvas = document.getElementById("signaturePad");
  const clearBtn = document.getElementById("clearBtn");
  const hidden = document.getElementById("id_signature_data");
  const ctx = canvas.getContext("2d");
  let drawing = false;

  function fitCanvas() {
    const ratio = window.devicePixelRatio || 1;
    const width = canvas.clientWidth;
    const height = canvas.clientHeight;
    canvas.width = Math.floor(width * ratio);
    canvas.height = Math.floor(height * ratio);
    ctx.scale(ratio, ratio);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#111827";
    ctx.clearRect(0, 0, width, height);
  }

  function point(e) {
    const r = canvas.getBoundingClientRect();
    const p = e.touches ? e.touches[0] : e;
    return { x: p.clientX - r.left, y: p.clientY - r.top };
  }

  function start(e) {
    drawing = true;
    const p = point(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    e.preventDefault();
  }

  function move(e) {
    if (!drawing) return;
    const p = point(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    hidden.value = canvas.toDataURL("image/png");
    e.preventDefault();
  }

  function end() {
    drawing = false;
  }

  clearBtn.addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);
    hidden.value = "";
  });
  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", end);
  canvas.addEventListener("touchstart", start, { passive: false });
  canvas.addEventListener("touchmove", move, { passive: false });
  window.addEventListener("touchend", end);
  window.addEventListener("resize", fitCanvas);
  fitCanvas();
</script>
{% endblock %}
