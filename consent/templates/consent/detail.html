{% extends "base.html" %}

{% block title %}동의서 상세{% endblock %}

{% block content %}
<main class="pt-32 pb-16 px-4 min-h-screen bg-[#E0E5EC]">
  <div class="max-w-6xl mx-auto">
    <div class="mb-5">
      <a href="{% url 'consent:dashboard' %}" class="text-sm text-gray-500 hover:text-purple-600">목록으로</a>
      <h1 class="text-3xl font-bold text-gray-800 mt-2">{{ consent_request.title }}</h1>
      <p class="text-sm text-gray-500">{{ consent_request.document.title }}</p>
      {% if link_expires_at %}
      <p class="text-xs text-gray-500 mt-1">링크 만료 시각: {{ link_expires_at|date:"Y-m-d H:i" }}</p>
      {% endif %}
    </div>

    <div class="flex flex-wrap gap-2 mb-4">
      <a href="{% url 'consent:send' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">발송 링크 생성</a>
      <a href="{% url 'consent:recipients' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-gray-700 font-semibold">수신자 편집</a>
      <a href="{% url 'consent:download_csv' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">CSV 다운로드</a>
      <a href="{% url 'consent:download_summary_pdf' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl bg-purple-600 text-white font-semibold hover:bg-purple-700">요약 PDF 다운로드</a>
    </div>

    {% if consent_request.is_link_expired %}
    <div class="mb-4 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900">
      현재 발송 링크가 만료되었습니다. 필요한 수신자 링크를 재발급해 주세요.
    </div>
    {% endif %}
    {% if not source_file_available %}
    <div class="mb-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-900">
      첨부 안내문 파일에 접근할 수 없습니다. 현재 상태로는 학부모가 안내문을 열 때 오류가 발생합니다.
      문서를 다시 업로드한 뒤 발송 링크를 생성해 주세요.
    </div>
    {% endif %}

    <div class="mb-4 rounded-xl border border-indigo-200 bg-indigo-50 px-4 py-3 text-sm text-indigo-900">
      <p class="font-semibold mb-1">학부모 안내 기본 문구 복사 지원</p>
      <p>각 수신자 행의 `문구+링크 복사` 버튼을 누르면 동의 요청 멘트와 접속 링크가 함께 복사됩니다.</p>
    </div>

    <div class="clay-card p-0 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm min-w-[1280px]">
          <thead class="bg-gray-50 text-gray-600">
            <tr>
              <th class="text-left px-4 py-3">학생명</th>
              <th class="text-left px-4 py-3">학부모명</th>
              <th class="text-left px-4 py-3">상태</th>
              <th class="text-left px-4 py-3">처리시각</th>
              <th class="text-left px-4 py-3">접속 링크 / QR</th>
              <th class="text-left px-4 py-3">관리</th>
            </tr>
          </thead>
          <tbody>
            {% for row in recipient_rows %}
            {% with r=row.recipient %}
            <tr class="border-t border-gray-100">
              <td class="px-4 py-3">{{ r.student_name }}</td>
              <td class="px-4 py-3">{{ r.parent_name }}</td>
              <td class="px-4 py-3">
                {{ r.get_status_display }}
                {% if consent_request.is_link_expired and r.status == "pending" %}
                <span class="ml-1 text-xs text-amber-700">(만료)</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">
                {% if r.signed_at %}
                {{ r.signed_at|date:"Y-m-d H:i" }}
                {% else %}
                <span class="text-gray-400">-</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">
                <div class="flex items-start gap-3">
                  <img src="data:image/png;base64,{{ row.qr_code_base64 }}" alt="접속 링크 QR 코드" class="w-20 h-20 rounded border border-gray-200 bg-white p-1">
                  <div class="space-y-2">
                    <input id="sign-link-{{ r.id }}" type="text" readonly value="{{ row.sign_url }}" class="w-[420px] px-3 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-xs">
                    <textarea id="sign-message-{{ r.id }}" class="hidden">{{ row.copy_message }}</textarea>
                    <div class="flex flex-wrap gap-2">
                      <button type="button" class="js-copy px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-xs font-semibold hover:bg-indigo-700" data-copy-source="sign-link-{{ r.id }}">링크 복사</button>
                      <button type="button" class="js-copy px-3 py-1.5 rounded-lg bg-purple-600 text-white text-xs font-semibold hover:bg-purple-700" data-copy-source="sign-message-{{ r.id }}">문구+링크 복사</button>
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3">
                {% if r.status == "pending" or r.status == "verified" %}
                <a href="{% url 'consent:regenerate_link' recipient_id=r.id %}" class="text-indigo-600 font-semibold hover:underline">링크 재발급</a>
                {% else %}
                <span class="text-gray-400">-</span>
                {% endif %}
              </td>
            </tr>
            {% endwith %}
            {% empty %}
            <tr>
              <td colspan="6" class="px-4 py-8 text-center text-gray-500">수신자가 없습니다.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
  async function copyFromElement(sourceId, buttonEl) {
    const source = document.getElementById(sourceId);
    if (!source) return;
    const text = source.value !== undefined ? source.value : source.textContent;
    const original = buttonEl.textContent;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        source.classList.remove("hidden");
        source.select && source.select();
        document.execCommand("copy");
        source.classList.add("hidden");
      }
      buttonEl.textContent = "복사됨";
      setTimeout(() => {
        buttonEl.textContent = original;
      }, 1300);
    } catch (err) {
      buttonEl.textContent = "복사 실패";
      setTimeout(() => {
        buttonEl.textContent = original;
      }, 1300);
    }
  }

  document.querySelectorAll(".js-copy").forEach((btn) => {
    btn.addEventListener("click", () => {
      copyFromElement(btn.dataset.copySource, btn);
    });
  });
</script>
{% endblock %}
