{% extends "base.html" %}

{% block title %}동의서 상세{% endblock %}

{% block content %}
<main class="pt-32 pb-16 px-4 min-h-screen bg-[#E0E5EC]">
  <div class="max-w-6xl mx-auto">
    <div class="mb-5">
      <a href="{% url 'consent:dashboard' %}" class="text-sm text-gray-500 hover:text-purple-600">목록으로</a>
      <h1 class="text-3xl font-bold text-gray-800 mt-2">{{ consent_request.title }}</h1>
      <p class="text-sm text-gray-500">{{ consent_request.document.title }}</p>
    </div>

    <div class="flex flex-wrap gap-2 mb-4">
      <a href="{% url 'consent:send' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">발송 링크 생성</a>
      <a href="{% url 'consent:preview_positions' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl bg-amber-600 text-white font-semibold hover:bg-amber-700">위치 미리보기</a>
      <a href="{% url 'consent:setup_positions' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-gray-700 font-semibold">서명 위치 설정</a>
      <a href="{% url 'consent:recipients' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-gray-700 font-semibold">수신자 편집</a>
      <a href="{% url 'consent:download_merged' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl bg-purple-600 text-white font-semibold hover:bg-purple-700">통합 PDF 다운로드</a>
      <a href="{% url 'consent:download_merged' request_id=consent_request.request_id %}?include_decline_summary=1" class="min-h-11 px-4 py-2 rounded-xl bg-rose-600 text-white font-semibold hover:bg-rose-700">비동의 사유 포함 다운로드</a>
    </div>

    {% if not consent_request.preview_checked_at %}
    <div class="mb-4 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900">
      발송 전에 반드시 위치 미리보기를 확인해 주세요.
    </div>
    {% endif %}

    <div class="clay-card p-0 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm min-w-[1080px]">
          <thead class="bg-gray-50 text-gray-600">
            <tr>
              <th class="text-left px-4 py-3">학생명</th>
              <th class="text-left px-4 py-3">학부모명</th>
              <th class="text-left px-4 py-3">전화번호</th>
              <th class="text-left px-4 py-3">상태</th>
              <th class="text-left px-4 py-3">접근 링크</th>
              <th class="text-left px-4 py-3">개별 PDF</th>
            </tr>
          </thead>
          <tbody>
            {% for r in recipients %}
            <tr class="border-t border-gray-100">
              <td class="px-4 py-3">{{ r.student_name }}</td>
              <td class="px-4 py-3">{{ r.parent_name }}</td>
              <td class="px-4 py-3">{{ r.phone_number }}</td>
              <td class="px-4 py-3">{{ r.get_status_display }}</td>
              <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <input type="text" readonly value="{{ host_base }}{% url 'consent:verify' token=r.access_token %}" class="w-[420px] px-3 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-xs">
                </div>
              </td>
              <td class="px-4 py-3">
                {% if r.signed_pdf %}
                <a href="{% url 'consent:download_recipient_pdf' recipient_id=r.id %}" class="text-purple-600 font-semibold hover:underline">다운로드</a>
                {% else %}
                <span class="text-gray-400">-</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="px-4 py-8 text-center text-gray-500">수신자가 없습니다.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</main>
{% endblock %}
