{% extends "base.html" %}

{% block title %}동의서 상세{% endblock %}

{% block content %}
<main class="pt-32 pb-16 px-4 min-h-screen bg-[#E0E5EC]">
  <div class="max-w-6xl mx-auto">
    <div class="mb-5">
      <a href="{% url 'consent:dashboard' %}" class="text-sm text-gray-500 hover:text-purple-600">목록으로</a>
      <h1 class="text-3xl font-bold text-gray-800 mt-2">{{ consent_request.title }}</h1>
      <p class="text-sm text-gray-500">안내문: {{ consent_request.document.title }}</p>
      {% if link_expires_at %}
      <p class="text-xs text-gray-500 mt-1">현재 링크 만료 시각: {{ link_expires_at|date:"Y-m-d H:i" }}</p>
      {% endif %}
    </div>

    <div class="flex flex-wrap gap-2 mb-4">
      <a href="{% url 'consent:send' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">학부모 제출 링크 만들기</a>
      <a href="{% url 'consent:recipients' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-gray-700 font-semibold">수신자 등록/수정</a>
      <a href="{% url 'consent:download_csv' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">제출 현황 CSV 다운로드</a>
      <a href="{% url 'consent:download_summary_pdf' request_id=consent_request.request_id %}" class="min-h-11 px-4 py-2 rounded-xl bg-purple-600 text-white font-semibold hover:bg-purple-700">제출 결과 PDF 다운로드</a>
    </div>

    {% if consent_request.is_link_expired %}
    <div class="mb-4 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900">
      현재 발송 링크가 만료되었습니다. 수신자별로 링크를 다시 만들어 주세요.
    </div>
    {% endif %}

    {% if not source_file_available %}
    <div class="mb-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-900">
      업로드한 안내문 파일을 찾을 수 없어 링크 발송이 불가합니다. 문서를 다시 업로드해 주세요.
    </div>
    {% endif %}

    <div class="mb-4 rounded-xl border border-indigo-200 bg-indigo-50 px-4 py-3 text-sm text-indigo-900">
      <p class="font-semibold mb-1">학부모 안내문 복사 지원</p>
      <p>각 수신자 카드의 <code>안내문+링크 복사</code> 버튼으로 메시지와 제출 링크를 함께 복사할 수 있습니다.</p>
    </div>

    <section class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2 mb-4">
      <article class="rounded-xl border border-gray-200 bg-white px-3 py-3">
        <p class="text-xs text-gray-500">전체 수신자</p>
        <p class="text-xl font-bold text-gray-800 mt-1">{{ recipient_stats.total }}명</p>
      </article>
      <article class="rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-3">
        <p class="text-xs text-emerald-700">응답 완료</p>
        <p class="text-xl font-bold text-emerald-800 mt-1">{{ recipient_stats.responded }}명</p>
      </article>
      <article class="rounded-xl border border-amber-200 bg-amber-50 px-3 py-3">
        <p class="text-xs text-amber-700">미응답</p>
        <p class="text-xl font-bold text-amber-800 mt-1">{{ recipient_stats.pending }}명</p>
      </article>
      <article class="rounded-xl border border-indigo-200 bg-indigo-50 px-3 py-3">
        <p class="text-xs text-indigo-700">동의</p>
        <p class="text-xl font-bold text-indigo-800 mt-1">{{ recipient_stats.agree }}명</p>
      </article>
      <article class="rounded-xl border border-rose-200 bg-rose-50 px-3 py-3">
        <p class="text-xs text-rose-700">비동의</p>
        <p class="text-xl font-bold text-rose-800 mt-1">{{ recipient_stats.disagree }}명</p>
      </article>
      <article class="rounded-xl border border-purple-200 bg-purple-50 px-3 py-3">
        <p class="text-xs text-purple-700">완료율</p>
        <p class="text-xl font-bold text-purple-800 mt-1">{{ recipient_stats.completion_rate }}%</p>
      </article>
    </section>

    <section class="clay-card p-4 sm:p-5 space-y-4">
      <h2 class="text-lg font-bold text-gray-700">수신자별 진행상태</h2>

      {% for row in recipient_rows %}
      {% with r=row.recipient %}
      <article class="rounded-2xl border border-gray-200 bg-white/90 p-4 shadow-sm space-y-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <p class="text-base font-bold text-gray-800">{{ r.student_name }}</p>
            <p class="text-sm text-gray-600">{{ r.parent_name }}</p>
            {% if r.phone_number %}
            <p class="text-xs text-gray-500 mt-1">연락처: {{ r.phone_number }}</p>
            {% endif %}
          </div>
          <div class="text-right">
            <p class="text-sm font-semibold text-gray-700">{{ r.get_status_display }}</p>
            {% if r.signed_at %}
            <p class="text-xs text-gray-500">처리시각: {{ r.signed_at|date:"Y-m-d H:i" }}</p>
            {% endif %}
          </div>
        </div>

        <div class="rounded-xl bg-gray-50 border border-gray-200 p-3 space-y-3">
          <div class="flex items-start gap-3">
            <img src="data:image/png;base64,{{ row.qr_code_base64 }}" alt="학부모 제출 링크 QR 코드" class="w-16 h-16 rounded border border-gray-200 bg-white p-1 shrink-0">
            <div class="min-w-0 w-full space-y-2">
              <input id="sign-link-{{ r.id }}" type="text" readonly value="{{ row.sign_url }}" class="w-full px-3 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-xs">
              <textarea id="sign-message-{{ r.id }}" class="hidden">{{ row.copy_message }}</textarea>
              <div class="flex flex-wrap gap-2">
                <button type="button" class="js-copy px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-xs font-semibold hover:bg-indigo-700" data-copy-source="sign-link-{{ r.id }}">링크 복사</button>
                <button type="button" class="js-copy px-3 py-1.5 rounded-lg bg-purple-600 text-white text-xs font-semibold hover:bg-purple-700" data-copy-source="sign-message-{{ r.id }}">안내문+링크 복사</button>
                {% if r.status == "pending" or r.status == "verified" %}
                <a href="{% url 'consent:regenerate_link' recipient_id=r.id %}" class="px-3 py-1.5 rounded-lg bg-slate-700 text-white text-xs font-semibold hover:bg-slate-800">링크 재발급</a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        {% if r.status == "pending" or r.status == "verified" %}
        <div class="flex flex-wrap gap-2">
          <button
            type="button"
            class="js-toggle-edit px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700"
            data-target-id="edit-form-{{ r.id }}"
            data-open-label="수정 열기"
            data-close-label="수정 닫기"
            aria-expanded="false"
          >
            수정 열기
          </button>
          <form method="post" action="{% url 'consent:delete_recipient' recipient_id=r.id %}" onsubmit="return confirm('이 수신자를 삭제할까요?');">
            {% csrf_token %}
            <button type="submit" class="px-3 py-2 rounded-lg bg-red-600 text-white text-sm font-semibold hover:bg-red-700">삭제</button>
          </form>
        </div>

        <form id="edit-form-{{ r.id }}" method="post" action="{% url 'consent:update_recipient' recipient_id=r.id %}" class="hidden grid grid-cols-1 sm:grid-cols-3 gap-2">
          {% csrf_token %}
          <input type="text" name="student_name" value="{{ r.student_name }}" required maxlength="100" class="w-full px-3 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-sm" placeholder="학생명">
          <input type="text" name="parent_name" value="{{ r.parent_name }}" required maxlength="100" class="w-full px-3 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-sm" placeholder="학부모명">
          <input type="text" name="phone_number" value="{{ r.phone_number }}" maxlength="20" class="w-full px-3 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-sm" placeholder="연락처(선택)">
          <div class="sm:col-span-3 flex flex-wrap gap-2 pt-1">
            <button type="submit" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700">수정 저장</button>
          </div>
        </form>
        {% else %}
        <p class="text-xs text-gray-500">응답이 완료된 수신자는 수정/삭제가 잠겨 있습니다.</p>
        {% endif %}
      </article>
      {% endwith %}
      {% empty %}
      <div class="rounded-xl border border-dashed border-gray-300 bg-white/60 px-4 py-8 text-center text-gray-500">
        수신자가 없습니다.
      </div>
      {% endfor %}
    </section>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
  async function copyFromElement(sourceId, buttonEl) {
    const source = document.getElementById(sourceId);
    if (!source) return;
    const text = source.value !== undefined ? source.value : source.textContent;
    const original = buttonEl.textContent;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        source.classList.remove("hidden");
        source.select && source.select();
        document.execCommand("copy");
        source.classList.add("hidden");
      }
      buttonEl.textContent = "복사됨";
      setTimeout(() => {
        buttonEl.textContent = original;
      }, 1300);
    } catch (err) {
      buttonEl.textContent = "복사 실패";
      setTimeout(() => {
        buttonEl.textContent = original;
      }, 1300);
    }
  }

  document.querySelectorAll(".js-copy").forEach((btn) => {
    btn.addEventListener("click", () => {
      copyFromElement(btn.dataset.copySource, btn);
    });
  });

  document.querySelectorAll(".js-toggle-edit").forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = document.getElementById(btn.dataset.targetId);
      if (!target) return;
      const isHidden = target.classList.contains("hidden");
      target.classList.toggle("hidden");
      btn.textContent = isHidden ? btn.dataset.closeLabel : btn.dataset.openLabel;
      btn.setAttribute("aria-expanded", isHidden ? "true" : "false");
    });
  });
</script>
{% endblock %}
