{% extends 'base.html' %}
{% load cloudinary_extras %}

{% block title %}Insight Library - Eduitit{% endblock %}

{% block extra_css %}
<style>
    .filter-tab {
        transition: all 0.2s ease;
    }
    .filter-tab.active {
        transform: scale(1.05);
    }
    .tag-chip {
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .tag-chip:hover {
        transform: translateY(-1px);
    }
    .featured-badge {
        background: linear-gradient(135deg, #f59e0b, #ef4444);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
</style>
{% endblock %}

{% block content %}
<main class="pt-32 pb-20 px-4 md:px-8 min-h-screen max-w-7xl mx-auto">

    <!-- Header Section -->
    <header class="text-center mb-10">
        <span class="inline-block px-4 py-1 rounded-full bg-indigo-100 text-indigo-600 font-bold text-2xl mb-4 shadow-sm font-hand tracking-wide">
            âœ¨ Teacher's Inspiration
        </span>
        <h1 class="text-6xl md:text-8xl font-bold text-gray-700 font-hand mb-2 leading-none"
            style="text-shadow: 2px 2px 4px rgba(0,0,0,0.1)">
            Insight Library
        </h1>
        <p class="text-2xl md:text-3xl text-gray-500 font-hand max-w-2xl mx-auto leading-tight">
            AI ì‹œëŒ€ë¥¼ ì´ë„ëŠ” ì„ ìƒë‹˜ì˜ ì‹œì„ .<br>
            ìœ íŠœë¸Œ ì˜ìƒê³¼ í•¨ê»˜ ì„ ìƒë‹˜ë§Œì˜ í†µì°°ì„ ê¸°ë¡í•˜ê³  ê³µìœ í•©ë‹ˆë‹¤.
        </p>
    </header>

    <!-- Filter Section -->
    <section class="mb-8">
        <!-- Category Tabs -->
        <div class="flex flex-wrap justify-center gap-3 mb-4">
            <a href="?sort={{ current_sort }}{% if current_tag %}&tag={{ current_tag }}{% endif %}"
                class="filter-tab px-5 py-2 rounded-full font-bold text-lg transition-all {% if not current_category %}bg-gray-700 text-white shadow-clay active{% else %}bg-white text-gray-600 shadow-clay-inner hover:bg-gray-100{% endif %}">
                ğŸŒ ì „ì²´
            </a>
            <a href="?category=youtube&sort={{ current_sort }}{% if current_tag %}&tag={{ current_tag }}{% endif %}"
                class="filter-tab px-5 py-2 rounded-full font-bold text-lg transition-all {% if current_category == 'youtube' %}bg-red-500 text-white shadow-clay active{% else %}bg-white text-gray-600 shadow-clay-inner hover:bg-red-50{% endif %}">
                â–¶ï¸ YouTube
            </a>
            <a href="?category=devlog&sort={{ current_sort }}{% if current_tag %}&tag={{ current_tag }}{% endif %}"
                class="filter-tab px-5 py-2 rounded-full font-bold text-lg transition-all {% if current_category == 'devlog' %}bg-green-500 text-white shadow-clay active{% else %}bg-white text-gray-600 shadow-clay-inner hover:bg-green-50{% endif %}">
                ğŸ’» DevLog
            </a>
            <a href="?category=column&sort={{ current_sort }}{% if current_tag %}&tag={{ current_tag }}{% endif %}"
                class="filter-tab px-5 py-2 rounded-full font-bold text-lg transition-all {% if current_category == 'column' %}bg-blue-500 text-white shadow-clay active{% else %}bg-white text-gray-600 shadow-clay-inner hover:bg-blue-50{% endif %}">
                ğŸ“ Column
            </a>
        </div>

        <!-- Sort Buttons -->
        <div class="flex justify-center gap-3">
            <a href="?sort=recent{% if current_category %}&category={{ current_category }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}"
                class="px-5 py-2 rounded-full font-bold text-base transition-all {% if current_sort == 'recent' %}bg-indigo-500 text-white shadow-clay{% else %}bg-white text-gray-600 shadow-clay-inner hover:bg-indigo-100{% endif %}">
                <i class="fa-solid fa-clock mr-1"></i>ìµœì‹ ìˆœ
            </a>
            <a href="?sort=popular{% if current_category %}&category={{ current_category }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}"
                class="px-5 py-2 rounded-full font-bold text-base transition-all {% if current_sort == 'popular' %}bg-pink-500 text-white shadow-clay{% else %}bg-white text-gray-600 shadow-clay-inner hover:bg-pink-100{% endif %}">
                <i class="fa-solid fa-fire mr-1"></i>ì¸ê¸°ìˆœ
            </a>
            <a href="?sort=oldest{% if current_category %}&category={{ current_category }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}"
                class="px-5 py-2 rounded-full font-bold text-base transition-all {% if current_sort == 'oldest' %}bg-purple-500 text-white shadow-clay{% else %}bg-white text-gray-600 shadow-clay-inner hover:bg-purple-100{% endif %}">
                <i class="fa-solid fa-history mr-1"></i>ì˜¤ë˜ëœìˆœ
            </a>
        </div>

        <!-- Active Tag Filter Notice -->
        {% if current_tag %}
        <div class="flex justify-center mt-4">
            <span class="flex items-center gap-2 px-4 py-2 bg-indigo-50 border border-indigo-200 rounded-full text-indigo-700 font-bold">
                <i class="fa-solid fa-tag text-sm"></i>
                #{{ current_tag }} í•„í„° ì¤‘
                <a href="?sort={{ current_sort }}{% if current_category %}&category={{ current_category }}{% endif %}"
                    class="ml-1 text-indigo-400 hover:text-red-500 transition-colors">
                    <i class="fa-solid fa-circle-xmark"></i>
                </a>
            </span>
        </div>
        {% endif %}
    </section>

    <!-- Featured Section (ìƒë‹¨ ê³ ì •) -->
    {% if featured_insights and not current_tag %}
    <section class="mb-12">
        <div class="flex items-center gap-3 mb-6">
            <span class="text-3xl">â­</span>
            <h2 class="text-3xl font-bold featured-badge font-hand">Featured Insights</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {% for insight in featured_insights %}
            <article class="clay-card p-6 rounded-[2rem] hover:scale-[1.02] transition-transform duration-300 flex flex-col h-full bg-gradient-to-br from-[#E0E5EC] to-[#d4dae8] shadow-clay relative group ring-2 ring-amber-300/50"
                x-data="{ showDeleteModal: false }">

                <!-- Featured Badge -->
                <div class="absolute -top-3 -right-3 z-10">
                    <span class="px-3 py-1 bg-gradient-to-r from-amber-400 to-orange-400 text-white text-sm font-bold rounded-full shadow-md">
                        â­ Featured
                    </span>
                </div>

                {% include 'insights/partials/insight_card_body.html' with insight=insight %}
            </article>
            {% endfor %}
        </div>
        <div class="mt-8 border-t-2 border-dashed border-gray-200"></div>
    </section>
    {% endif %}

    <!-- Main Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">

        {% for insight in insights %}
        <article
            class="clay-card p-6 rounded-[2rem] hover:scale-[1.02] transition-transform duration-300 flex flex-col h-full bg-[#E0E5EC] shadow-clay relative group"
            x-data="{ showDeleteModal: false }">

            {% include 'insights/partials/insight_card_body.html' with insight=insight %}
        </article>
        {% empty %}
        <div class="col-span-3 text-center py-20 text-gray-400">
            <i class="fa-solid fa-inbox text-6xl mb-4 block"></i>
            <p class="text-2xl font-hand">
                {% if current_category or current_tag %}
                    í•´ë‹¹ ì¡°ê±´ì˜ ì¸ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.
                {% else %}
                    ì•„ì§ ë“±ë¡ëœ ì¸ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.
                {% endif %}
            </p>
        </div>
        {% endfor %}

        <!-- Add Button -->
        {% if user.is_authenticated %}
        <div class="clay-card p-6 rounded-[2rem] border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 hover:border-purple-400 hover:text-purple-500 cursor-pointer transition-all min-h-[400px] bg-[#E0E5EC]/50 hover:bg-white/40 group"
            onclick="location.href='{% url 'insights:create' %}'">
            <div class="w-24 h-24 rounded-full shadow-clay flex items-center justify-center text-4xl mb-6 group-hover:scale-110 transition-transform bg-[#E0E5EC]">
                <i class="fa-solid fa-plus"></i>
            </div>
            <span class="font-hand text-4xl font-bold mb-2">ê¸°ë¡í•˜ê¸°</span>
            <p class="font-sans text-lg text-center px-4">
                ìœ íŠœë¸Œ ë§í¬ë§Œ ìˆìœ¼ë©´<br>ë‚˜ë§Œì˜ ì¸ì‚¬ì´íŠ¸ ì¹´ë“œê°€ ì™„ì„±ë©ë‹ˆë‹¤.
            </p>
        </div>
        {% else %}
        <div class="clay-card p-6 rounded-[2rem] border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 transition-all min-h-[400px] bg-[#E0E5EC]/50 cursor-pointer"
            onclick="location.href='{% url 'account_login' %}?next={% url 'insights:create' %}'">
            <div class="w-24 h-24 rounded-full shadow-clay-inner flex items-center justify-center text-4xl mb-6 bg-[#E0E5EC]">
                <i class="fa-solid fa-lock"></i>
            </div>
            <span class="font-hand text-4xl font-bold mb-2">ë¡œê·¸ì¸ í•„ìš”</span>
            <p class="font-sans text-lg text-center px-4">
                ì¸ì‚¬ì´íŠ¸ë¥¼ ë“±ë¡í•˜ë ¤ë©´<br>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
            </p>
        </div>
        {% endif %}

    </div>
</main>

{% endblock %}

{% block extra_js %}
<script>
    async function toggleLike(insightId, button) {
        try {
            const response = await fetch(`/insights/${insightId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            });

            if (!response.ok) throw new Error('Failed to toggle like');

            const data = await response.json();

            if (data.liked) {
                button.classList.remove('bg-gray-200', 'text-gray-600', 'hover:bg-pink-100', 'hover:text-pink-600');
                button.classList.add('bg-pink-500', 'text-white');
            } else {
                button.classList.remove('bg-pink-500', 'text-white');
                button.classList.add('bg-gray-200', 'text-gray-600', 'hover:bg-pink-100', 'hover:text-pink-600');
            }

            document.querySelector(`.like-count-${insightId}`).textContent = data.total_likes;

        } catch (error) {
            console.error('Error:', error);
        }
    }
</script>
{% endblock %}
