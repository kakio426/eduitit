{% extends 'base.html' %}
{% load cloudinary_extras insight_extras %}

{% block title %}{{ insight.title }} - Insight Library{% endblock %}

{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-4 min-h-screen">
    <div class="max-w-3xl mx-auto">

        <!-- Back Button + Actions Row -->
        <div class="flex items-center justify-between mb-8">
            <a href="{% url 'insights:list' %}"
                class="flex items-center gap-2 px-5 py-2 rounded-full bg-white shadow-clay-inner text-gray-600 hover:text-indigo-600 font-bold transition-all">
                <i class="fa-solid fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
            </a>

            {% if user.is_superuser %}
            <div class="flex items-center gap-2" x-data="{ showDeleteModal: false }">
                <a href="{% url 'insights:update' insight.pk %}"
                    class="flex items-center gap-2 px-5 py-2 rounded-full bg-white shadow-clay-inner text-gray-600 hover:text-blue-600 font-bold transition-all">
                    <i class="fa-solid fa-pen"></i> ìˆ˜ì •
                </a>
                <button @click="showDeleteModal = true"
                    class="flex items-center gap-2 px-5 py-2 rounded-full bg-white shadow-clay-inner text-gray-600 hover:text-red-600 font-bold transition-all">
                    <i class="fa-solid fa-trash"></i> ì‚­ì œ
                </button>
                <noscript>
                    <form method="POST" action="{% url 'insights:delete' insight.pk %}">
                        {% csrf_token %}
                        <button type="submit"
                            class="flex items-center gap-2 px-5 py-2 rounded-full bg-red-500 text-white font-bold">
                            <i class="fa-solid fa-trash"></i> ì‚­ì œ
                        </button>
                    </form>
                </noscript>

                <!-- Delete Modal -->
                <div x-show="showDeleteModal" x-cloak
                    class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm"
                    @click.self="showDeleteModal = false">
                    <div class="clay-card p-8 rounded-3xl max-w-sm w-full mx-4 bg-[#E0E5EC]">
                        <div class="text-center mb-6">
                            <div class="text-5xl mb-3">ğŸ—‘ï¸</div>
                            <h3 class="text-2xl font-bold text-gray-700 font-hand mb-2">ì •ë§ ì‚­ì œí• ê¹Œìš”?</h3>
                            <p class="text-gray-500">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                        <div class="flex gap-3">
                            <button @click="showDeleteModal = false"
                                class="flex-1 py-3 rounded-full bg-gray-300 text-gray-700 font-bold hover:bg-gray-400 transition-all">
                                ì·¨ì†Œ
                            </button>
                            <form method="POST" action="{% url 'insights:delete' insight.pk %}" class="flex-1">
                                {% csrf_token %}
                                <button type="submit"
                                    class="w-full py-3 rounded-full bg-red-500 text-white font-bold hover:bg-red-600 transition-all">
                                    <i class="fa-solid fa-trash mr-1"></i> ì‚­ì œ
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center gap-2 mb-4 flex-wrap">
                <span class="px-3 py-1 rounded-full text-sm font-bold
                    {% if insight.category == 'devlog' %}bg-green-100 text-green-700
                    {% elif insight.category == 'column' %}bg-blue-100 text-blue-700
                    {% else %}bg-red-100 text-red-700{% endif %}">
                    {{ insight.get_category_display }}
                </span>
                {% if insight.is_featured %}
                <span class="px-3 py-1 rounded-full text-sm font-bold bg-amber-100 text-amber-700">
                    â­ Featured
                </span>
                {% endif %}
                <span class="text-neutral-500 text-sm">{{ insight.created_at|date:"Y.m.d" }}</span>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-neutral-800 mb-4 font-hand">{{ insight.title }}</h1>

            <!-- Tag Chips -->
            {% if insight.tags %}
            <div class="flex flex-wrap gap-2 mb-4">
                {% for tag in insight.tags|parse_tags %}
                <a href="{% url 'insights:list' %}?tag={{ tag|slice:'1:' }}"
                    class="px-3 py-1 bg-indigo-100 text-indigo-600 text-sm font-bold rounded-full hover:bg-indigo-200 transition-colors cursor-pointer">
                    {{ tag }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </header>

        <!-- Video Player -->
        {% if insight.video_url %}
        <div class="mb-8 rounded-2xl overflow-hidden shadow-clay">
            <iframe src="https://www.youtube.com/embed/{{ insight.get_video_id }}"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                class="w-full h-64 md:h-96">
            </iframe>
        </div>
        {% endif %}

        <!-- Content -->
        <article class="clay-card p-8 rounded-3xl bg-[#E0E5EC] mb-8">
            <i class="fa-solid fa-quote-left text-4xl text-gray-300 mb-4 block"></i>
            <div class="prose prose-lg max-w-none text-neutral-700">
                {{ insight.content|linebreaks }}
            </div>
        </article>

        <!-- Kakio's Note -->
        {% if insight.kakio_note %}
        <div class="clay-card p-8 rounded-3xl bg-purple-50 border border-purple-100 mb-8">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-8 h-8 rounded-full bg-purple-200 text-purple-600 flex items-center justify-center">
                    <i class="fa-solid fa-pen"></i>
                </div>
                <h3 class="text-2xl font-bold text-purple-700 font-hand">ğŸ’¡ Kakio's Note</h3>
            </div>
            <div class="text-purple-800 leading-relaxed">
                {{ insight.kakio_note|linebreaks }}
            </div>
        </div>
        {% endif %}

        <!-- Like Section -->
        <div class="text-center">
            {% if user.is_authenticated %}
            <button id="like-btn-{{ insight.pk }}" onclick="toggleLikeDetail({{ insight.pk }}, this)"
                class="inline-flex items-center gap-3 px-8 py-4 rounded-full text-xl font-bold transition-all shadow-clay
                    {% if user in insight.likes.all %}bg-pink-500 text-white{% else %}bg-white text-gray-600 hover:bg-pink-100 hover:text-pink-600{% endif %}">
                <i class="fa-solid fa-heart text-2xl"></i>
                <span id="like-count-detail">{{ insight.total_likes }}</span>
                <span>ì¢‹ì•„ìš”</span>
            </button>
            {% else %}
            <a href="{% url 'account_login' %}?next={{ request.path }}"
                class="inline-flex items-center gap-3 px-8 py-4 rounded-full text-xl font-bold bg-white text-gray-600 shadow-clay hover:bg-pink-50 transition-all">
                <i class="fa-solid fa-heart text-2xl"></i>
                {{ insight.total_likes }} ì¢‹ì•„ìš”
            </a>
            {% endif %}
        </div>

    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-django.min.js"></script>
<script>
    async function toggleLikeDetail(insightId, button) {
        try {
            const response = await fetch(`/insights/${insightId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            });
            if (!response.ok) throw new Error('Failed');
            const data = await response.json();

            if (data.liked) {
                button.classList.remove('bg-white', 'text-gray-600', 'hover:bg-pink-100', 'hover:text-pink-600');
                button.classList.add('bg-pink-500', 'text-white');
            } else {
                button.classList.remove('bg-pink-500', 'text-white');
                button.classList.add('bg-white', 'text-gray-600', 'hover:bg-pink-100', 'hover:text-pink-600');
            }
            document.getElementById('like-count-detail').textContent = data.total_likes;
        } catch (e) {
            console.error(e);
        }
    }
</script>
{% endblock %}
