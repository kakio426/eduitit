{% extends 'base.html' %}
{% load cloudinary_extras insight_extras %}

{% block title %}{{ insight.title }} - Insight Library{% endblock %}

{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
{% endblock %}

{% block extra_css %}
<style>
    .insight-reading-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
    }

    .insight-reading-body p {
        margin: 0 0 1rem;
        color: #1f2937;
        font-size: 1.1rem;
        line-height: 1.95;
        font-weight: 500;
        letter-spacing: -0.01em;
    }

    .insight-reading-body p:last-child {
        margin-bottom: 0;
    }

    .insight-note-card {
        background: #fffdf6;
        border: 1px solid #fde68a;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.05);
    }

    .insight-note-body p {
        margin: 0 0 0.85rem;
        color: #334155;
        font-size: 1.03rem;
        line-height: 1.85;
        font-weight: 500;
        letter-spacing: -0.01em;
    }

    .insight-note-body p:last-child {
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-4 min-h-screen">
    <div class="max-w-3xl mx-auto">

        <!-- Back Button + Actions Row -->
        <div class="flex items-center justify-between mb-8">
            <a href="{% url 'insights:list' %}"
                class="flex items-center gap-2 px-5 py-2 rounded-full bg-white shadow-clay-inner text-gray-600 hover:text-indigo-600 font-bold transition-all">
                <i class="fa-solid fa-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
            </a>

            {% if user.is_superuser %}
            <div class="flex items-center gap-2" x-data="{ showDeleteModal: false }">
                <a href="{% url 'insights:update' insight.pk %}"
                    class="flex items-center gap-2 px-5 py-2 rounded-full bg-white shadow-clay-inner text-gray-600 hover:text-blue-600 font-bold transition-all">
                    <i class="fa-solid fa-pen"></i> ìˆ˜ì •
                </a>
                <button @click="showDeleteModal = true"
                    class="flex items-center gap-2 px-5 py-2 rounded-full bg-white shadow-clay-inner text-gray-600 hover:text-red-600 font-bold transition-all">
                    <i class="fa-solid fa-trash"></i> ì‚­ì œ
                </button>
                <noscript>
                    <form method="POST" action="{% url 'insights:delete' insight.pk %}">
                        {% csrf_token %}
                        <button type="submit"
                            class="flex items-center gap-2 px-5 py-2 rounded-full bg-red-500 text-white font-bold">
                            <i class="fa-solid fa-trash"></i> ì‚­ì œ
                        </button>
                    </form>
                </noscript>

                <!-- Delete Modal -->
                <div x-show="showDeleteModal" x-cloak
                    class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm"
                    @click.self="showDeleteModal = false">
                    <div class="clay-card p-8 rounded-3xl max-w-sm w-full mx-4 bg-[#E0E5EC]">
                        <div class="text-center mb-6">
                            <div class="text-5xl mb-3">ğŸ—‘ï¸</div>
                            <h3 class="text-2xl font-bold text-gray-700 font-hand mb-2">ì •ë§ ì‚­ì œí• ê¹Œìš”?</h3>
                            <p class="text-gray-500">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                        <div class="flex gap-3">
                            <button @click="showDeleteModal = false"
                                class="flex-1 py-3 rounded-full bg-gray-300 text-gray-700 font-bold hover:bg-gray-400 transition-all">
                                ì·¨ì†Œ
                            </button>
                            <form method="POST" action="{% url 'insights:delete' insight.pk %}" class="flex-1">
                                {% csrf_token %}
                                <button type="submit"
                                    class="w-full py-3 rounded-full bg-red-500 text-white font-bold hover:bg-red-600 transition-all">
                                    <i class="fa-solid fa-trash mr-1"></i> ì‚­ì œ
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center gap-2 mb-4 flex-wrap">
                <span class="px-3 py-1 rounded-full text-sm font-bold
                    {% if insight.category == 'devlog' %}bg-green-100 text-green-700
                    {% elif insight.category == 'column' %}bg-blue-100 text-blue-700
                    {% else %}bg-red-100 text-red-700{% endif %}">
                    {{ insight.get_category_display }}
                </span>
                {% if insight.is_featured %}
                <span class="px-3 py-1 rounded-full text-sm font-bold bg-amber-100 text-amber-700">
                    â­ Featured
                </span>
                {% endif %}
                <span class="text-neutral-500 text-sm">{{ insight.created_at|date:"Y.m.d" }}</span>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-neutral-800 mb-4 font-hand">{{ insight.title }}</h1>

            <!-- Tag Chips -->
            {% if insight.tags %}
            <div class="flex flex-wrap gap-2 mb-4">
                {% for tag in insight.tags|parse_tags %}
                <a href="{% url 'insights:list' %}?tag={{ tag|slice:'1:' }}"
                    class="px-3 py-1 bg-indigo-100 text-indigo-600 text-sm font-bold rounded-full hover:bg-indigo-200 transition-colors cursor-pointer">
                    {{ tag }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </header>

        <!-- Video Player -->
        {% with video_id=insight.get_video_id %}
        {% if video_id %}
        <div class="mb-8 rounded-2xl overflow-hidden shadow-clay">
            <iframe src="https://www.youtube.com/embed/{{ video_id }}"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                class="w-full h-64 md:h-96">
            </iframe>
        </div>
        {% elif insight.video_url %}
        <div class="mb-8 clay-card p-6 rounded-3xl bg-[#E0E5EC] border border-slate-200">
            <div class="flex items-start gap-3">
                <i class="fa-solid fa-circle-info text-slate-500 mt-1"></i>
                <div>
                    <p class="text-slate-700 font-bold mb-1">ì´ ì˜ìƒì€ ì„ë² ë“œê°€ ì œí•œë˜ì–´ ìˆì–´ìš”.</p>
                    <p class="text-sm text-slate-500 mb-3">ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì›ë³¸ ì˜ìƒì„ ìƒˆ ì°½ì—ì„œ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <a href="{{ insight.video_url }}" target="_blank" rel="noopener noreferrer"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-indigo-600 text-white text-sm font-bold hover:bg-indigo-500 transition">
                        ì›ë³¸ ì˜ìƒ ì—´ê¸° <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i>
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
        {% endwith %}

        <!-- Content -->
        <article class="insight-reading-card rounded-3xl p-6 md:p-8 mb-8">
            <header class="pb-4 mb-5 border-b border-slate-100">
                <div class="flex items-center gap-2 mb-1">
                    <i class="fa-solid fa-quote-left text-slate-400"></i>
                    <h2 class="text-xl md:text-2xl font-extrabold text-slate-900">í•µì‹¬ ì¸ì‚¬ì´íŠ¸</h2>
                </div>
                <p class="text-sm text-slate-500">ì˜ìƒì—ì„œ ë½‘ì€ í•µì‹¬ ë‚´ìš©ì„ ì½ê¸° ì‰½ê²Œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.</p>
            </header>
            <div class="insight-reading-body">
                {{ insight.content|linebreaks }}
            </div>
        </article>

        <!-- Kakio's Note -->
        {% if insight.kakio_note %}
        <div class="insight-note-card rounded-3xl p-6 md:p-8 mb-8">
            <div class="flex items-start gap-3 pb-4 mb-4 border-b border-amber-100">
                <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center shrink-0">
                    <i class="fa-solid fa-lightbulb"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-amber-900 font-hand">Kakio's Note</h3>
                    <p class="text-sm text-amber-700">ìˆ˜ì—… ì ìš© ê´€ì ì—ì„œ ë§ë¶™ì¸ ë©”ëª¨ì…ë‹ˆë‹¤.</p>
                </div>
            </div>
            <div class="insight-note-body">
                {{ insight.kakio_note|linebreaks }}
            </div>
        </div>
        {% endif %}

        <!-- Like Section -->
        <div class="text-center">
            {% if user.is_authenticated %}
            <button id="like-btn-{{ insight.pk }}" onclick="toggleLikeDetail({{ insight.pk }}, this)"
                class="inline-flex items-center gap-3 px-8 py-4 rounded-full text-xl font-bold transition-all shadow-clay
                    {% if user in insight.likes.all %}bg-pink-500 text-white{% else %}bg-white text-gray-600 hover:bg-pink-100 hover:text-pink-600{% endif %}">
                <i class="fa-solid fa-heart text-2xl"></i>
                <span id="like-count-detail">{{ insight.total_likes }}</span>
                <span>ì¢‹ì•„ìš”</span>
            </button>
            {% else %}
            <a href="{% url 'account_login' %}?next={{ request.path }}"
                class="inline-flex items-center gap-3 px-8 py-4 rounded-full text-xl font-bold bg-white text-gray-600 shadow-clay hover:bg-pink-50 transition-all">
                <i class="fa-solid fa-heart text-2xl"></i>
                {{ insight.total_likes }} ì¢‹ì•„ìš”
            </a>
            {% endif %}
        </div>

    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-django.min.js"></script>
<script>
    async function toggleLikeDetail(insightId, button) {
        try {
            const response = await fetch(`/insights/${insightId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            });
            if (!response.ok) throw new Error('Failed');
            const data = await response.json();

            if (data.liked) {
                button.classList.remove('bg-white', 'text-gray-600', 'hover:bg-pink-100', 'hover:text-pink-600');
                button.classList.add('bg-pink-500', 'text-white');
            } else {
                button.classList.remove('bg-pink-500', 'text-white');
                button.classList.add('bg-white', 'text-gray-600', 'hover:bg-pink-100', 'hover:text-pink-600');
            }
            document.getElementById('like-count-detail').textContent = data.total_likes;
        } catch (e) {
            console.error(e);
        }
    }
</script>
{% endblock %}
