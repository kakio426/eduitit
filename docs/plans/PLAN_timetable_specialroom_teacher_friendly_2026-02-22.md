# **Implementation Plan: 전담 시간표 + 특별실 연동 서비스 (교사용 언어 중심)**

**Status**: 🔄 In Progress  
**Started**: 2026-02-22  
**Last Updated**: 2026-02-22  
**Estimated Completion**: 2026-03-20

---

## **0) 이 계획의 최우선 원칙**

### **A. 교사용 용어 우선 (절대 규칙)**
- 교사에게 보이는 화면/엑셀/안내문에는 개발 용어를 쓰지 않는다.
- 예시:
  - `규칙 타입` -> `배치 방법`
  - `하드/소프트 제약` -> `반드시 지킬 조건 / 가능하면 지킬 조건`
  - `슬롯` -> `시간칸`
  - `검증` -> `점검`
  - `충돌` -> `겹침`
  - `PREVIEW/APPLY` -> `미리보기/바로 반영`

### **B. 배치 목표 우선순위**
1. 같은 시간에 겹치지 않게 배치 (전담 선생님/학급/특별실 겹침 0건)
2. 전담 시간표 결과를 1순위로 제공
3. 특별실은 학교 정책에 따라 자동 배치와 예약 연동을 함께 지원

### **C. 시스템 역할**
- 이 서비스는 **전담 시간표와 특별실 시간표**를 만드는 도구다.
- 담임 시간표 전체를 강제로 만들지 않는다.
- 담임 선생님이 나중에 빈 시간칸에 자율 입력할 수 있도록 `학급별 전담 점유표`를 함께 제공한다.

---

## **1) 범위 선언 (Target Service Lock)**

- `target_app`: 신규 앱 `timetable` (예정)
- `do_not_touch_apps`: 기존 주요 앱 전체(`seed_quiz`, `fortune`, `collect`, `signatures`, 기타 비대상 앱)
- 공용 파일 수정은 신규 서비스 연결에 필요한 최소 범위에서만 수행:
  - `config/settings.py`, `config/settings_production.py` (앱 등록 시)
  - `config/urls.py` (라우팅 연결 시)
  - `products/management/commands/ensure_timetable.py` (서비스 카드/이용방법 등록)
  - `core/management/commands/bootstrap_runtime.py` (런타임 등록)

---

## **2) 사용자 시나리오 (교무부/연구부 기준)**

1. 학교 기본 정보(요일/교시 수/학년별 점심시간 차이)를 입력한다.
2. 전담 배정표를 엑셀로 올린다.
3. 전담 선생님이 불가능한 시간칸을 입력한다.
4. 필요한 배치 조건(예: 과학 3시간은 2+1) 을 추가한다.
5. `자동 배치`를 누른다.
6. 결과에서 `겹침 없음`을 확인한다.
7. 특별실 정책을 보고:
   - 자동 배치할 특별실은 시간표로 확정
   - 예약으로 운영할 특별실은 예약 전송 목록으로 확인
8. `미리보기` 또는 `바로 반영`으로 예약 시스템 연동을 선택한다.

---

## **3) 데이터 입력 포맷 (엑셀 표준안 v1, 교사용 이름)**

### **시트 1: 기본설정**
- 컬럼:
  - `항목`
  - `값`
- 예시:
  - `운영요일` / `월,화,수,목,금`
  - `기본교시수` / `6`
  - `시간칸형식` / `기본` 또는 `분할` (예: 5A, 5B)

### **시트 2: 학급목록**
- 컬럼:
  - `학년`
  - `반`
  - `사용여부`

### **시트 3: 전담선생님목록**
- 컬럼:
  - `선생님코드`
  - `이름`
  - `담당교과`
  - `하루최대수업칸`

### **시트 4: 전담배정표 (핵심)**
- 컬럼:
  - `배정번호`
  - `선생님코드`
  - `교과`
  - `학년`
  - `반`
  - `주당시수`
  - `특별실처리` (자동배치 / 예약연동 / 해당없음)
  - `특별실명` (과학실, 음악실 등)

### **시트 5: 배치불가시간**
- 컬럼:
  - `선생님코드`
  - `요일`
  - `시간칸`
  - `사유`

### **시트 6: 배치조건**
- 컬럼:
  - `조건이름`
  - `적용대상` (교과/선생님/학년)
  - `대상값`
  - `배치방법` (피하기 / 나눠배치 / 순환배치)
  - `세부값` (예: 월,수 / 2+1 / ON 또는 OFF)
  - `중요도` (반드시/권장)
- 예시:
  - `과학 3시간 분리`
  - `교과`
  - `과학`
  - `나눠배치`
  - `2+1`
  - `반드시`
  - `영어 순환배치 해제`
  - `교과`
  - `영어`
  - `순환배치`
  - `OFF`
  - `권장`

### **시트 7: 수동고정**
- 컬럼:
  - `배정번호`
  - `요일`
  - `시간칸`
  - `처리` (고정 / 배치금지)
  - `메모`

### **시트 8: 특별실설정**
- 컬럼:
  - `특별실명`
  - `대상교과`
  - `운영방식` (자동배치 / 예약연동)
  - `연동선택` (연동안함 / 미리보기 / 바로반영)

---

## **4) 출력 포맷 (결과물 우선순위 반영)**

### **출력 1 (최우선): 전담선생님 시간표**
- 선생님별 주간표
- 빈칸/수업칸/고정칸 구분 표시

### **출력 2: 학급별 전담 점유표**
- 담임용 참고표
- 어느 시간칸이 전담으로 이미 사용되는지 표시

### **출력 3: 특별실 시간표**
- 자동배치 대상 특별실의 확정표

### **출력 4: 예약 전송 대상표**
- 예약연동 대상 특별실의 `요일-시간칸-학년반` 목록

### **출력 5: 점검결과표**
- `오류`와 `안내`를 쉬운 문장으로 분리
- 예:
  - `오류: 월 2교시에 3학년 1반 수업이 두 개 겹칩니다.`
  - `안내: 과학(3시간) 중 1시간이 아직 배치되지 않았습니다.`

---

## **5) 배치 엔진 설계 원칙**

### **A. 필수 조건 (반드시 지킬 조건)**
- 같은 시간칸에 전담 선생님 중복 배정 금지
- 같은 시간칸에 같은 학급 중복 배정 금지
- 같은 시간칸에 같은 특별실 중복 배정 금지 (자동배치 대상만)
- 같은 학급 같은 교과는 기본 하루 1회만 배치
- 2시간 이상 연속 블록은 `나눠배치`를 명시한 경우에만 허용
- 주당시수 총량 일치
- 수동고정 조건 준수

### **B. 권장 조건 (가능하면 지킬 조건)**
- 교과 분산 배치 (연속/분리 선호)
- 특정 요일/시간칸 선호 반영
- 불필요한 공강 최소화

### **C. 시간칸 모델**
- 기본은 `1~6교시`
- 학교별 필요 시 `5A/5B` 같은 분할 시간칸 지원
- 학년별 점심시간 차이는 `학년별 시간칸 사용 가능표`로 처리

---

## **6) AI 사용 전략 (혼란 방지형)**

### **원칙**
- AI가 직접 시간표를 최종 생성하지 않는다.
- AI는 교사의 자연어 요청을 `배치조건`으로 정리하는 보조 역할만 수행한다.

### **예시**
- 교사 입력: `과학 3시간은 2시간+1시간으로 넣고 싶어요`
- AI 변환 결과:
  - `조건이름: 과학 3시간 분리`
  - `배치방법: 나눠배치`
  - `세부값: 2+1`
  - `중요도: 반드시`

### **장점**
- 같은 입력이면 같은 결과를 재현하기 쉽다.
- 오류 원인을 교사가 이해하기 쉽다.
- “AI가 매번 다르게 답해서 생기는 스트레스”를 줄인다.

---

## **7) 특별실 + 예약 시스템 연동 설계**

### **운영방식 선택**
1. `연동안함`: 파일만 생성
2. `미리보기`: 예약으로 보낼 목록만 확인
3. `바로반영`: 예약 시스템에 즉시 생성

### **기본 추천값**
- 기본은 `미리보기`
- 이유: 학교 운영에서 오반영 리스크를 줄이고, 최종 확인 후 반영 가능

### **연동 대상**
- `특별실설정`에서 `운영방식=예약연동`으로 지정된 건만 대상
- `자동배치` 특별실은 내부 시간표에서 확정

---

## **8) 경고/오류 안내 체계 (수동수정 이후 포함)**

### **오류 (즉시 수정 필요)**
- 같은 시간칸 겹침(선생님/학급/특별실)
- 주당시수 부족/초과
- 반드시 지킬 조건 위반

### **안내 (선택 개선)**
- 권장 조건 미반영
- 특정 선생님의 연속 수업 과다
- 특정 요일 쏠림

### **표시 원칙**
- 코드(E001 등)도 내부 저장은 가능하나, 화면에는 쉬운 문장을 우선 표시

---

## **9) 구현 단계 (Phase)**

### **Phase 1: 입력 포맷 + 점검기**
- 엑셀 템플릿 다운로드
- 업로드 파싱
- 필수 컬럼 누락/형식 오류 점검
- 결과: “올바른 입력인지” 먼저 확실히 확인

### **Phase 2: 전담 자동배치 엔진 (겹침 0건 목표)**
- 반드시 지킬 조건 기반 배치
- 전담선생님 시간표 출력
- 학급 전담 점유표 출력

### **Phase 3: 배치조건(교사 직접 추가)**
- 배치조건 등록/수정/삭제 화면
- `반드시/권장` 우선순위 반영
- 수동고정 반영

### **Phase 4: 특별실 자동배치 + 예약연동**
- 자동배치 특별실 시간표 생성
- 예약연동 목록 생성
- `연동안함/미리보기/바로반영` 선택 처리

### **Phase 5: 수정 후 점검 + 운영 안정화**
- 수동 수정 후 즉시 점검
- 오류/안내 문장형 피드백
- 엑셀 재내보내기

---

## **10) 품질 점검 항목 (배포 전)**

1. `python manage.py check` 통과
2. 엑셀 업로드 실패 케이스 안내문이 쉬운 한국어인지 확인
3. 전담선생님 시간표 생성 시 겹침 0건 보장 테스트
4. 수동고정 후 재점검 동작 확인
5. 특별실 `미리보기`와 `바로반영` 차이 동작 확인
6. 신규 서비스 등록/이용방법(3개 섹션 이상) 노출 확인

---

## **11) 데이터/화면에서 금지할 표현**

- 금지: 하드코딩, 소프트코딩, 룰타입, 스키마, 슬롯, 파서, 모델 바인딩
- 대체:
  - `미리 정한 값`
  - `선택 조건`
  - `배치 방법`
  - `입력 양식`
  - `시간칸`
  - `읽어오기`
  - `연결 정보`

---

## **12) 산출물 정의 (Definition of Done)**

1. 교사가 엑셀 템플릿만으로 입력을 완료할 수 있다.
2. 전담 시간표가 겹침 없이 자동 생성된다.
3. 수동 수정 후 겹침/누락 안내가 쉬운 문장으로 표시된다.
4. 특별실은 자동배치와 예약연동을 동시에 지원한다.
5. 예약연동은 `연동안함/미리보기/바로반영` 선택이 가능하다.
6. 교사 화면에 개발 용어가 노출되지 않는다.
