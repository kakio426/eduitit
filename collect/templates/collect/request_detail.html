{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block extra_head %}
<meta property="og:title" content="{{ req.title }} - 간편 수합" />
{% endblock %}

{% block extra_css %}
<style>
    .qr-container {
        background: white;
        border-radius: 20px;
        box-shadow: 8px 8px 16px #b8bec5, -8px -8px 16px #ffffff;
        padding: 2rem;
        text-align: center;
    }

    .qr-image {
        width: 220px;
        height: 220px;
        margin: 0 auto;
        border-radius: 12px;
    }

    .submission-row {
        background: white;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 0.75rem;
        box-shadow: 4px 4px 8px #b8bec5, -4px -4px 8px #ffffff;
        transition: all 0.2s;
    }

    .submission-row:hover {
        transform: translateX(4px);
    }
</style>
{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-6 min-h-screen bg-[#E0E5EC]">
    <div class="max-w-5xl mx-auto">

        <!-- 뒤로가기 -->
        <div class="mb-6">
            <a href="{% url 'collect:dashboard' %}"
                class="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 transition-colors">
                <i class="fa-solid fa-arrow-left"></i>
                <span class="font-medium">대시보드로 돌아가기</span>
            </a>
        </div>

        <!-- 헤더 -->
        <div class="clay-card p-6 mb-6">
            <div class="flex items-start justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-700 mb-2">{{ req.title }}</h1>
                    {% if req.description %}
                    <p class="text-gray-500 mb-3">{{ req.description }}</p>
                    {% endif %}
                    <div class="flex items-center gap-4 flex-wrap text-sm text-gray-500">
                        {% if req.status == 'active' %}
                        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold">진행중</span>
                        {% elif req.status == 'closed' %}
                        <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full font-bold">마감</span>
                        {% else %}
                        <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full font-bold">보관</span>
                        {% endif %}
                        {% if req.deadline %}
                        <span><i class="fa-solid fa-clock mr-1"></i>마감: {{ req.deadline|date:"Y-m-d H:i" }}</span>
                        {% endif %}
                        <span><i class="fa-solid fa-paper-plane mr-1"></i><span id="total-count">{{ total_count }}건</span> 제출</span>
                        {% if req.template_file %}
                        <span class="text-emerald-600"><i class="fa-solid fa-file-lines mr-1"></i>양식 첨부됨</span>
                        {% endif %}
                    </div>
                </div>
                <div class="flex gap-2">
                    <form action="{% url 'collect:request_toggle' req.id %}" method="post">
                        {% csrf_token %}
                        {% if req.status == 'active' %}
                        <button type="submit"
                            class="px-4 py-2 bg-red-100 text-red-600 rounded-xl font-bold hover:bg-red-200 transition text-sm">
                            <i class="fa-solid fa-stop mr-1"></i>마감하기
                        </button>
                        {% else %}
                        <button type="submit"
                            class="px-4 py-2 bg-green-100 text-green-600 rounded-xl font-bold hover:bg-green-200 transition text-sm">
                            <i class="fa-solid fa-play mr-1"></i>재개하기
                        </button>
                        {% endif %}
                    </form>
                    <a href="{% url 'collect:export_csv' req.id %}"
                        class="px-4 py-2 bg-blue-100 text-blue-600 rounded-xl font-bold hover:bg-blue-200 transition text-sm">
                        <i class="fa-solid fa-file-csv mr-1"></i>CSV
                    </a>
                </div>
            </div>
        </div>

        <!-- 자동 정리 안내 -->
        <div
            class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6 text-sm text-amber-700 flex items-start gap-2">
            <i class="fa-solid fa-clock mt-0.5"></i>
            <div>
                <p>수합 마감 후 <strong>7일</strong> 뒤 제출 파일이 자동 삭제됩니다. 필요한 파일은 미리 다운로드해주세요.</p>
                <p>수합 요청은 첫 제출 후 <strong>30일</strong> 뒤 자동 삭제됩니다. (제출 없으면 60일)</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
            <div class="space-y-6">
                <div class="qr-container">
                    <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="QR Code" class="qr-image mb-4">
                    <p class="text-sm text-gray-500 mb-4">이 QR 코드를 스캔하면<br>제출 페이지로 바로 연결됩니다.</p>

                    <div class="space-y-3" x-data="{ 
                copied: false,
                copyInvite() {
                    const title = '{{ req.title|escapejs }}';
                    const code = '{{ req.access_code }}';
                    const link = window.location.origin + '{% url 'collect:short_link' req.access_code %}';
                    /* 아래 줄의 따옴표 충돌을 막기 위해 제목 주변을 작은따옴표(')로 변경했습니다 */
                    const message = `[간편수합] '${title}' 요청에 참여해주세요.\n\n▶ 참여 링크: ${link}\n▶ 입장 코드: ${code}`;
                    navigator.clipboard.writeText(message);
                    this.copied = true;
                    setTimeout(() => { this.copied = false }, 2000);
                }
            }">
                        <div class="bg-gray-100 rounded-xl p-3 flex items-center justify-between gap-2">
                            <div class="flex flex-col items-start px-2">
                                <span class="text-xs text-gray-400 font-medium">입장코드</span>
                                <span class="text-2xl font-bold text-emerald-600 tracking-widest">{{ req.access_code }}</span>
                            </div>
                            <button @click="copyInvite()"
                                class="px-4 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition flex items-center gap-2 shadow-sm">
                                <i class="fa-solid" :class="copied ? 'fa-check' : 'fa-copy'"></i>
                                <span x-text="copied ? '복사됨' : '초대장 복사'"></span>
                            </button>
                        </div>
                    </div>
                </div>


                <!-- 제출 유형 통계 -->
                <div class="clay-card p-4">
                    <h3 class="font-bold text-gray-700 mb-3"><i
                            class="fa-solid fa-chart-pie text-emerald-500 mr-2"></i>제출 현황</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500"><i class="fa-solid fa-file mr-1"></i>파일</span>
                            <span class="font-bold">{{ type_stats.file|default:"0" }}건</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500"><i class="fa-solid fa-link mr-1"></i>링크</span>
                            <span class="font-bold">{{ type_stats.link|default:"0" }}건</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500"><i class="fa-solid fa-align-left mr-1"></i>텍스트</span>
                            <span class="font-bold">{{ type_stats.text|default:"0" }}건</span>
                        </div>
                    </div>
                </div>

                <!-- 미제출자 현황 -->
                {% if expected_submitters %}
                <div class="clay-card p-4">
                    <h3 class="font-bold text-gray-700 mb-3">
                        <i class="fa-solid fa-user-check text-emerald-500 mr-2"></i>제출 대상자
                        <span class="text-xs font-normal text-gray-400 ml-1">{{ expected_submitters|length }}명</span>
                    </h3>
                    {% if not_submitted %}
                    <p class="text-xs text-red-500 font-bold mb-2">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i>미제출 {{ not_submitted|length }}명
                    </p>
                    <div class="flex flex-wrap gap-1.5 mb-3">
                        {% for name in not_submitted %}
                        <span class="px-2 py-1 bg-red-100 text-red-600 rounded-lg text-xs font-medium">{{ name }}</span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-xs text-emerald-600 font-bold mb-2">
                        <i class="fa-solid fa-circle-check mr-1"></i>전원 제출 완료!
                    </p>
                    {% endif %}
                    <div class="flex flex-wrap gap-1.5">
                        {% for name in expected_submitters %}
                        <span
                            class="px-2 py-1 rounded-lg text-xs font-medium {% if name in not_submitted %}bg-gray-100 text-gray-400 line-through{% else %}bg-emerald-100 text-emerald-600{% endif %}">{{ name }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- 전체 다운로드 -->
                {% if total_count > 0 %}
                <button id="download-all-btn" onclick="downloadAllFiles()"
                    class="w-full py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition text-sm">
                    <i class="fa-solid fa-download mr-2"></i>
                    <span id="download-label">전체 파일 다운로드 (ZIP)</span>
                </button>
                {% endif %}
            </div>

            <!-- 우측: 제출물 목록 (HTMX 폴링) -->
            <div class="lg:col-span-2">
                <div class="clay-card p-6">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-inbox text-emerald-500"></i>
                        제출물 목록
                        <span class="text-sm font-normal text-gray-400">(5초마다 자동 갱신)</span>
                    </h2>

                    <div id="submissions-list" hx-get="{% url 'collect:submissions_partial' req.id %}"
                        hx-trigger="every 5s" hx-target="#submissions-list" hx-swap="innerHTML">
                        {% include 'collect/partials/submissions_list.html' %}
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<!-- JSZip CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="{% static 'collect/js/download_all.js' %}"></script>
{{ files_data|json_script:"collect-files-data" }}
<script>
    // 파일 데이터를 JS에 안전하게 전달
    const filesDataElement = document.getElementById('collect-files-data');
    if (filesDataElement) {
        window.collectFiles = JSON.parse(filesDataElement.textContent);
    } else {
        window.collectFiles = [];
    }
    window.collectTitle = "{{ req.title|escapejs }}";
</script>
{% endblock %}