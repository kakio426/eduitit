{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}ì œì¶œë¬¼ ìˆ˜ì •{% else %}{{ req.title }} - ì œì¶œí•˜ê¸°{% endif %}{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-4 md:px-6 min-h-screen bg-[#E0E5EC]">
    <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
            <div class="text-5xl mb-3">{% if is_edit %}âœï¸{% else %}ğŸ“¥{% endif %}</div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">{% if is_edit %}ì œì¶œë¬¼ ìˆ˜ì •{% else %}{{ req.title }}{% endif %}</h1>
            {% if is_edit %}
            <p class="text-gray-500"><strong>{{ submission.contributor_name }}</strong>ë‹˜ì˜ ì œì¶œ ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.</p>
            {% else %}
            {% if req.description %}<p class="text-gray-500 leading-relaxed break-keep">{{ req.description }}</p>{% endif %}
            {% if req.deadline %}<p class="text-sm text-orange-500 mt-2 font-medium"><i class="fa-solid fa-clock mr-1"></i>ë§ˆê°: {{ req.deadline|date:"Yë…„ mì›” dì¼ H:i" }}</p>{% endif %}
            {% endif %}
        </div>

        {% if req.template_file %}
        <div class="clay-card p-5 mb-6 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-200">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl bg-amber-100 flex items-center justify-center text-2xl"><i class="fa-solid fa-file-lines text-amber-600"></i></div>
                    <div>
                        <p class="font-bold text-gray-700">ì–‘ì‹ íŒŒì¼</p>
                        <p class="text-sm text-gray-500">{{ req.template_file_name|default:"ì–‘ì‹ ë‹¤ìš´ë¡œë“œ" }}</p>
                    </div>
                </div>
                <a href="{% url 'collect:template_download' req.id %}" class="px-5 py-2.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition hover:scale-105 text-sm" target="_blank" rel="noopener noreferrer">
                    <i class="fa-solid fa-download mr-1"></i>ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                </a>
            </div>
        </div>
        {% endif %}

        {% if error %}
        <div class="bg-red-100 text-red-700 p-4 rounded-xl mb-6 text-sm font-medium"><i class="fa-solid fa-circle-exclamation mr-1"></i> {{ error }}</div>
        {% endif %}

        <div class="bg-red-50 border border-red-100 text-red-700 rounded-xl mb-6 p-4 text-sm leading-relaxed">
            <p class="font-bold mb-1"><i class="fa-solid fa-shield-exclamation mr-1"></i>ë³´ì•ˆ ë° ì±…ì„ ì•ˆë‚´</p>
            <p>- ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ì—°ë½ì²˜ ë“± ë¯¼ê°í•œ ê°œì¸ì •ë³´ê°€ í¬í•¨ëœ ìë£ŒëŠ” ì œì¶œí•˜ì§€ ë§ˆì„¸ìš”.</p>
            <p>- ëŒ€ì™¸ ìœ ì¶œì´ ê¸ˆì§€ëœ ê³µë¬¸/ë‚´ë¶€ ë¬¸ì„œëŠ” ì—…ë¡œë“œí•˜ì§€ ë§ˆì„¸ìš”.</p>
            <p>- ì œì¶œ ìë£Œì˜ ê´€ë¦¬ ë° ìœ ì¶œ ì±…ì„ì€ ìš”ì²­ì/ì œì¶œìì—ê²Œ ìˆìœ¼ë©°, ì„œë¹„ìŠ¤ëŠ” í•´ë‹¹ ì±…ì„ì„ ë¶€ë‹´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="clay-card p-6" x-data="submitForm()">
            <form action="{% if is_edit %}{% url 'collect:submission_edit' submission.management_id %}{% else %}{% url 'collect:submit_process' req.id %}{% endif %}" method="post" enctype="multipart/form-data" @submit="isSubmitting = true">
                {% csrf_token %}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">ì´ë¦„ <span class="text-red-500">*</span></label>
                        {% if req.expected_submitters_list %}
                        <div x-data="{ customName: false }">
                            <template x-if="!customName">
                                <div class="flex gap-2">
                                    <select name="contributor_name_select" required @change="if ($event.target.value === '__custom__') { customName = true; $nextTick(() => $refs.customInput.focus()); }" class="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none">
                                        <option value="">-- ì´ë¦„ ì„ íƒ --</option>
                                        {% for name in req.expected_submitters_list %}
                                        <option value="{{ name }}" {% if submission.contributor_name == name %}selected{% endif %}>{{ name }}</option>
                                        {% endfor %}
                                        <option value="__custom__">ì§ì ‘ ì…ë ¥...</option>
                                    </select>
                                </div>
                            </template>
                            <template x-if="customName">
                                <div class="flex gap-2">
                                    <input type="text" name="contributor_name_custom" x-ref="customInput" :required="customName" class="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none" placeholder="ì´ë¦„ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”">
                                    <button type="button" @click="customName = false" class="px-3 py-2 bg-gray-100 text-gray-500 rounded-xl text-sm hover:bg-gray-200 transition"><i class="fa-solid fa-list"></i></button>
                                </div>
                            </template>
                        </div>
                        {% else %}
                        <input type="text" name="contributor_name" required value="{% if is_edit %}{{ submission.contributor_name }}{% elif form_data %}{{ form_data.contributor_name }}{% endif %}" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                        {% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">ì†Œì† <span class="text-gray-400 font-normal">(ì„ íƒ)</span></label>
                        <input type="text" name="contributor_affiliation" value="{% if is_edit %}{{ submission.contributor_affiliation }}{% elif form_data %}{{ form_data.contributor_affiliation }}{% endif %}" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none" placeholder="ì˜ˆ: OOí•™êµ, OOë°˜">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-600 mb-2">ì œì¶œ ìœ í˜•</label>
                    {% if is_edit %}
                    <div class="mb-4">
                        <span class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-xl font-bold text-sm border border-emerald-200">
                            <i class="fa-solid {% if submission.submission_type == 'file' %}fa-file{% elif submission.submission_type == 'link' %}fa-link{% elif submission.submission_type == 'choice' %}fa-list-check{% else %}fa-align-left{% endif %} mr-1"></i>
                            {{ submission.get_submission_type_display }}
                        </span>
                        <input type="hidden" name="submission_type" value="{{ submission.submission_type }}">
                    </div>
                    {% else %}
                    <div class="flex gap-2 mb-4">
                        {% if req.allow_file %}<button type="button" @click="tab='file'" :class="tab==='file' ? 'bg-emerald-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600'" class="px-4 py-2 rounded-xl font-bold text-sm transition-all"><i class="fa-solid fa-file mr-1"></i>íŒŒì¼</button>{% endif %}
                        {% if req.allow_link %}<button type="button" @click="tab='link'" :class="tab==='link' ? 'bg-emerald-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600'" class="px-4 py-2 rounded-xl font-bold text-sm transition-all"><i class="fa-solid fa-link mr-1"></i>ë§í¬</button>{% endif %}
                        {% if req.allow_text %}<button type="button" @click="tab='text'" :class="tab==='text' ? 'bg-emerald-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600'" class="px-4 py-2 rounded-xl font-bold text-sm transition-all"><i class="fa-solid fa-align-left mr-1"></i>í…ìŠ¤íŠ¸</button>{% endif %}
                        {% if req.allow_choice %}<button type="button" @click="tab='choice'" :class="tab==='choice' ? 'bg-emerald-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600'" class="px-4 py-2 rounded-xl font-bold text-sm transition-all"><i class="fa-solid fa-list-check mr-1"></i>ì„ íƒí˜•</button>{% endif %}
                    </div>
                    <input type="hidden" name="submission_type" :value="tab">
                    {% endif %}

                    {% if is_edit and submission.submission_type == 'file' %}
                    <div x-show="tab==='file'" class="bg-gray-50 p-4 rounded-xl mb-4 border border-gray-200">
                        <p class="text-sm font-medium text-gray-700 mb-1">í˜„ì¬ ì œì¶œ íŒŒì¼</p>
                        <div class="flex items-center justify-between">
                            <p class="text-sm text-emerald-600 font-bold truncate pr-4"><i class="fa-solid fa-file mr-1"></i> {{ submission.original_filename }}</p>
                            <button type="button" @click="$dispatch('open-delete-modal')" class="flex-shrink-0 text-xs bg-white border border-red-200 text-red-500 px-2 py-1.5 rounded-lg font-bold hover:bg-red-500 hover:text-white transition shadow-sm"><i class="fa-solid fa-trash-can mr-1"></i>ì‚­ì œ</button>
                        </div>
                        <p class="text-[11px] text-gray-400 mt-2 leading-tight">ìƒˆ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ íŒŒì¼ì´ êµì²´ë©ë‹ˆë‹¤.</p>
                    </div>
                    {% endif %}

                    <div x-show="tab==='file'">
                        <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center transition-colors mb-3" :class="{'border-red-400 bg-red-50': fileError, 'border-emerald-400 bg-emerald-50': fileName && !fileError}">
                            <input type="file" name="file" @change="checkFileSize($event)" class="hidden" id="file-input" :required="tab==='file' && !isEdit">
                            <label for="file-input" class="cursor-pointer">
                                <div class="text-4xl mb-2"><i class="fa-solid fa-cloud-arrow-up" :class="fileName ? 'text-emerald-500' : 'text-gray-400'"></i></div>
                                <p class="text-sm text-gray-500 mb-1" x-text="fileName ? 'íŒŒì¼ ë³€ê²½í•˜ê¸°' : 'í´ë¦­í•´ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”'"></p>
                                <p class="text-xs text-gray-400">ìµœëŒ€ {{ req.max_file_size_mb }}MB</p>
                            </label>
                            <div x-show="fileName" class="mt-3 text-sm text-emerald-600 font-bold bg-white/60 py-2 rounded-lg inline-block px-4">
                                <i class="fa-solid fa-check-circle mr-1"></i><span x-text="fileName"></span>
                                <span x-text="'(' + fileSizeMB + 'MB)'" class="text-gray-400 font-normal"></span>
                            </div>
                            <div x-show="fileError" class="mt-3 text-sm text-red-600 font-medium"><i class="fa-solid fa-circle-exclamation mr-1"></i><span x-text="fileError"></span></div>
                        </div>
                        <p class="text-xs text-gray-500 mb-4"><i class="fa-solid fa-info-circle mr-1"></i>íŒŒì¼ì´ {{ req.max_file_size_mb }}MBë¥¼ ì´ˆê³¼í•˜ë©´ ë§í¬ ì œì¶œì„ ì´ìš©í•˜ì„¸ìš”.</p>
                        <textarea name="file_description" rows="3" placeholder="íŒŒì¼ ì„¤ëª…ì´ë‚˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none mb-1">{% if is_edit and submission.submission_type == 'file' %}{{ submission.text_content }}{% elif form_data %}{{ form_data.file_description }}{% endif %}</textarea>
                    </div>

                    <div x-show="tab==='link'" class="space-y-3">
                        <input type="url" name="link_url" placeholder="https://drive.google.com/..." value="{% if is_edit %}{{ submission.link_url }}{% elif form_data %}{{ form_data.link_url }}{% endif %}" :required="tab==='link'" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none">
                        <input type="text" name="link_description" placeholder="ë§í¬ ì„¤ëª… (ì„ íƒ)" value="{% if is_edit %}{{ submission.link_description }}{% elif form_data %}{{ form_data.link_description }}{% endif %}" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none">
                    </div>

                    <div x-show="tab==='text'">
                        <textarea name="text_content" rows="6" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." :required="tab==='text'" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none">{% if is_edit %}{{ submission.text_content }}{% elif form_data %}{{ form_data.text_content }}{% endif %}</textarea>
                    </div>

                    {% if req.allow_choice or submission.submission_type == 'choice' %}
                    <div x-show="tab==='choice'" class="space-y-3">
                        <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
                            <p class="text-sm text-gray-600 mb-3">
                                <i class="fa-solid fa-list-check mr-1 text-emerald-600"></i>
                                {% if req.choice_mode == 'single' %}
                                ë³´ê¸° ì¤‘ í•œ ê°€ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.
                                {% else %}
                                ë³´ê¸° ì¤‘ ì—¬ëŸ¬ ê°œë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                {% endif %}
                            </p>

                            {% if req.normalized_choice_options %}
                            <div class="space-y-2">
                                {% for option in req.normalized_choice_options %}
                                <label class="flex items-center gap-2 text-sm text-gray-700">
                                    <input
                                        type="{% if req.choice_mode == 'single' %}radio{% else %}checkbox{% endif %}"
                                        name="choice_answers"
                                        value="{{ option }}"
                                        class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
                                        {% if option in choice_values %}checked{% endif %}
                                        {% if req.choice_mode == 'single' %}:required="tab==='choice'" @change="useOtherChoice = false"{% endif %}
                                    >
                                    <span>{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>

                            {% if req.choice_allow_other %}
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <label class="flex items-center gap-2 text-sm text-gray-700 mb-2">
                                    <input
                                        type="{% if req.choice_mode == 'single' %}radio{% else %}checkbox{% endif %}"
                                        name="choice_answers"
                                        value="__other__"
                                        class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
                                        {% if "__other__" in choice_values %}checked{% endif %}
                                        {% if req.choice_mode == 'single' %}:required="tab==='choice'" @change="useOtherChoice = true"{% else %}@change="useOtherChoice = $event.target.checked"{% endif %}
                                    >
                                    <span>ê¸°íƒ€(ì§ì ‘ ì…ë ¥)</span>
                                </label>
                                <input
                                    type="text"
                                    name="choice_other_text"
                                    value="{{ choice_other_text }}"
                                    placeholder="ì§ì ‘ ì…ë ¥ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”"
                                    class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none"
                                    :disabled="tab !== 'choice' || !useOtherChoice"
                                    :required="tab==='choice' && useOtherChoice"
                                >
                            </div>
                            {% endif %}
                            {% else %}
                            <p class="text-sm text-red-600">ì„ íƒí˜• ë³´ê¸°ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìš”ì²­ ìƒì„±ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.</p>
                            {% endif %}
                        </div>
                        <p class="text-xs text-gray-500">
                            {% if req.choice_mode == 'single' %}
                            ë‹¨ì¼ ì„ íƒ ìš”ì²­ì…ë‹ˆë‹¤.
                            {% else %}
                            ìµœì†Œ {{ req.choice_min_selections|default:1 }}ê°œ ì´ìƒ
                            {% if req.choice_max_selections %}
                            / ìµœëŒ€ {{ req.choice_max_selections }}ê°œ ì´í•˜ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.
                            {% else %}
                            ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            {% endif %}
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                </div>

                <button type="submit" :disabled="(tab==='file' && fileError) || isSubmitting" class="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <template x-if="!isSubmitting"><span><i class="fa-solid fa-paper-plane mr-2"></i><span x-text="isEdit ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì œì¶œí•˜ê¸°'"></span></span></template>
                    <template x-if="isSubmitting"><span><i class="fa-solid fa-spinner fa-spin mr-2"></i>ì²˜ë¦¬ ì¤‘...</span></template>
                </button>

                {% if is_edit %}
                <a href="{% url 'collect:submission_manage' submission.management_id %}" class="block text-center mt-4 text-sm text-gray-500 hover:text-gray-700"><i class="fa-solid fa-arrow-left mr-1"></i>ì·¨ì†Œí•˜ê³  ëŒì•„ê°€ê¸°</a>
                {% endif %}
            </form>
        </div>
    </div>
</section>

{% if is_edit %}
<div x-data="{ show: false }" @open-delete-modal.window="show = true" x-show="show" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" style="display: none;">
    <div @click.away="show = false" class="clay-card w-full max-w-sm p-6 bg-white shadow-2xl">
        <div class="text-4xl text-red-500 mb-4 text-center"><i class="fa-solid fa-circle-exclamation"></i></div>
        <h3 class="text-xl font-bold text-gray-800 mb-2 text-center">ì œì¶œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
        <p class="text-gray-500 text-sm mb-6 text-center">ì‚­ì œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <div class="flex gap-3">
            <button @click="show = false" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">ì·¨ì†Œ</button>
            <form action="{% url 'collect:submission_delete' submission.management_id %}" method="post" class="flex-1">
                {% csrf_token %}
                <button type="submit" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold shadow-lg shadow-red-200">ì‚­ì œ</button>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
    function submitForm() {
        return {
            tab: '{{ initial_submission_type|default:"link" }}' || 'link',
            isEdit: {{ is_edit|yesno:"true,false" }},
            useOtherChoice: {% if "__other__" in choice_values %}true{% else %}false{% endif %},
            fileName: '',
            fileSizeMB: '',
            fileError: '',
            isSubmitting: false,
            init() {
                if (this.tab !== 'choice') {
                    this.useOtherChoice = false;
                }
            },
            checkFileSize(event) {
                const file = event.target.files[0];
                if (!file) {
                    this.fileName = '';
                    this.fileSizeMB = '';
                    this.fileError = '';
                    return;
                }

                const maxMB = parseInt('{{ req.max_file_size_mb|default:30 }}', 10);
                const maxSize = maxMB * 1024 * 1024;
                this.fileName = file.name;
                this.fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);

                if (file.size > maxSize) {
                    this.fileError = `íŒŒì¼ í¬ê¸°ê°€ ${maxMB}MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ë§í¬ ì œì¶œì„ ì´ìš©í•´ì£¼ì„¸ìš”.`;
                } else {
                    this.fileError = '';
                }
            }
        };
    }
</script>
{% endblock %}

