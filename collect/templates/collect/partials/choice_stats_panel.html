{% if req.allow_choice %}
<div class="clay-card p-5 h-full">
    <div class="flex items-center justify-between mb-3 gap-2">
        <h3 class="text-2xl md:text-3xl font-black text-gray-700">
            <i class="fa-solid fa-chart-column text-indigo-500 mr-2"></i>선택형 응답 대시보드
        </h3>
        <span class="px-3 py-1 rounded-full bg-indigo-100 text-indigo-700 text-base md:text-lg font-bold">
            {% if choice_stats.is_multi %}복수 선택{% else %}단일 선택{% endif %}
        </span>
    </div>

    {% if choice_stats.has_responses %}
    <div class="flex flex-wrap items-center gap-2 mb-4">
        <button type="button"
                onclick="clearSubmissionFilter()"
                class="px-3 py-1.5 rounded-full text-base md:text-lg font-bold transition {% if not choice_filter_key %}bg-slate-800 text-white{% else %}bg-slate-100 text-slate-700 hover:bg-slate-200{% endif %}">
            전체 보기
        </button>
        {% if active_choice_filter_label %}
        <span class="px-3 py-1.5 rounded-full text-base md:text-lg font-bold bg-indigo-100 text-indigo-700">
            현재 필터: {{ active_choice_filter_label }}
        </span>
        {% endif %}
    </div>

    <div class="grid lg:grid-cols-3 gap-3 mb-4">
        <div class="lg:col-span-2 rounded-2xl bg-slate-50 border border-slate-200 p-4">
            <div class="flex items-center justify-between mb-1">
                <p class="text-base md:text-lg font-bold text-gray-700">선택 비중 (총 선택 대비)</p>
                <p class="text-sm md:text-base text-gray-500">합계 100%</p>
            </div>
            <div class="h-5 w-full bg-gray-200 rounded-full overflow-hidden flex mb-2">
                {% for item in choice_stats.active_items %}
                <div class="h-full"
                     style="width: {{ item.selection_pct|floatformat:2 }}%; background-color: {{ item.color }};"
                     title="{{ item.label }} {{ item.selection_pct|floatformat:1 }}%"></div>
                {% endfor %}
            </div>
            <div class="flex flex-wrap gap-2">
                {% for item in choice_stats.active_items|slice:":6" %}
                <button type="button"
                        onclick="applySubmissionFilter('{{ item.filter_key|escapejs }}', '{{ item.label|escapejs }}')"
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm md:text-base font-semibold border transition {% if choice_filter_key == item.filter_key %}bg-indigo-600 text-white border-indigo-600{% else %}bg-white border-slate-200 text-slate-700 hover:border-indigo-300{% endif %}">
                    <span class="w-3 h-3 rounded-full {% if choice_filter_key == item.filter_key %}bg-white/90{% endif %}"
                          style="{% if choice_filter_key != item.filter_key %}background-color: {{ item.color }};{% endif %}"></span>
                    {{ item.label }}
                </button>
                {% endfor %}
            </div>
        </div>

        <div class="rounded-2xl bg-violet-50 border border-violet-200 p-4">
            <p class="text-base md:text-lg font-bold text-violet-700 mb-2">Top 3 항목</p>
            <div class="space-y-2">
                {% for item in choice_stats.items|slice:":3" %}
                <button type="button"
                        onclick="applySubmissionFilter('{{ item.filter_key|escapejs }}', '{{ item.label|escapejs }}')"
                        class="w-full text-left px-3 py-2.5 rounded-lg border transition {% if choice_filter_key == item.filter_key %}bg-violet-600 border-violet-600 text-white{% else %}bg-white/70 border-violet-200 hover:bg-white text-violet-800{% endif %}">
                    <div class="flex items-center justify-between text-base md:text-lg">
                        <span class="font-bold truncate pr-2">{{ item.rank }}위 {{ item.label }}</span>
                        <span class="font-black">{{ item.respondent_pct|floatformat:1 }}%</span>
                    </div>
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="space-y-3">
        {% for item in choice_stats.items %}
        <button type="button"
                onclick="applySubmissionFilter('{{ item.filter_key|escapejs }}', '{{ item.label|escapejs }}')"
                class="w-full text-left rounded-xl border p-4 transition {% if choice_filter_key == item.filter_key %}bg-indigo-50 border-indigo-400 ring-1 ring-indigo-200{% else %}bg-white border-slate-200 hover:border-indigo-300{% endif %}">
            <div class="flex items-center justify-between mb-1.5 gap-2">
                <div class="flex items-center gap-2 min-w-0">
                    <span class="w-3 h-3 rounded-full shrink-0" style="background-color: {{ item.color }};"></span>
                    <span class="text-base md:text-lg font-bold text-slate-700 truncate">{{ item.rank }}위 {{ item.label }}</span>
                </div>
                <span class="text-base md:text-lg font-black text-slate-700 shrink-0">{{ item.count }}건</span>
            </div>
            <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
                <div class="h-full rounded-full"
                     style="width: {{ item.respondent_pct|floatformat:2 }}%; background-color: {{ item.color }};{% if item.count > 0 %} min-width: 8px;{% endif %}"></div>
            </div>
            <div class="mt-1.5 flex items-center justify-between text-sm md:text-base text-slate-600">
                <span>응답자 대비 {{ item.respondent_pct|floatformat:1 }}%</span>
                <span>선택 비중 {{ item.selection_pct|floatformat:1 }}%</span>
            </div>
        </button>
        {% endfor %}
    </div>

    {% if choice_stats.is_multi %}
    <p class="mt-3 text-sm md:text-base text-amber-700 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2.5">
        복수 선택은 동시에 여러 항목을 고를 수 있으므로, 응답자 대비 비율 합계가 100%를 넘을 수 있습니다.
    </p>
    {% endif %}
    {% else %}
    <div class="rounded-xl bg-slate-50 border border-slate-200 p-5 text-center">
        <p class="text-xl md:text-2xl font-bold text-slate-600 mb-1">아직 선택형 응답이 없습니다.</p>
        <p class="text-base md:text-lg text-slate-500">응답이 들어오면 항목별 퍼센트와 건수를 이 영역에서 바로 보여드립니다.</p>
    </div>
    {% endif %}
</div>
{% endif %}
