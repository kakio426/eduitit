{% load static %}

<style>
    /* Result Content Readability Improvements */
    .zoo-result-content {
        font-family: 'NanumSquareRound', 'Inter', sans-serif;
        font-size: 18px;
        line-height: 1.8;
        color: #374151;
        word-break: keep-all;
        overflow-wrap: break-word;
    }

    @media (min-width: 768px) {
        .zoo-result-content {
            font-size: 20px;
        }
    }

    .zoo-result-content h1,
    .zoo-result-content h2,
    .zoo-result-content h3 {
        font-family: 'NanumSquareRound', sans-serif;
        font-weight: 800;
        color: #1f2937;
        margin-top: 1.5em;
        margin-bottom: 0.75em;
        line-height: 1.4;
    }

    .zoo-result-content p {
        margin-bottom: 1em;
    }

    .zoo-result-content ul,
    .zoo-result-content ol {
        margin-left: 1.5em;
        margin-bottom: 1em;
    }

    .zoo-result-content li {
        margin-bottom: 0.5em;
    }

    .zoo-result-content strong {
        font-weight: 800;
        color: #7c3aed;
    }

    /* Share Card Styles (Premium Design) */
    #shareCard {
        position: fixed;
        left: -9999px;
        top: 0;
        width: 600px;
        height: 1066px;
        /* 9:16 Ratio */
        background: linear-gradient(135deg, #F9FAFB 0%, #FFFFFF 50%, #F3F4F6 100%);
        font-family: 'NanumSquareRound', 'Malgun Gothic', sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 60px 40px;
        text-align: center;
        overflow: hidden;
        border: 6px solid #64748B !important;
        /* Thicker card border */
        border-radius: 24px !important;
        box-sizing: border-box !important;
    }

    /* Decorative Background Elements */
    #shareCard::before {
        content: '';
        position: absolute;
        top: -100px;
        right: -100px;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(139, 92, 246, 0.4) 0%, rgba(255, 255, 255, 0) 70%);
        border-radius: 50%;
        z-index: 0;
    }

    /* Header */
    #shareCard .card-header {
        position: relative;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 40px;
        width: 100%;
    }

    #shareCard .card-logo-icon {
        font-size: 48px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    #shareCard .card-logo-text {
        font-size: 42px;
        font-weight: 800;
        color: #374151;
        letter-spacing: -0.02em;
    }

    /* Prefix */
    #shareCard .card-title-prefix {
        position: relative;
        z-index: 10;
        font-size: 24px;
        font-weight: 700;
        color: #F97316;
        margin-bottom: 30px;
        font-family: 'NanumSquareRound', sans-serif;
    }

    /* Animal Image Container */
    #shareCard .card-animal-container {
        position: relative;
        z-index: 10;
        width: 440px;
        height: 440px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 10px 20px rgba(0, 0, 0, 0.04), inset 0 0 0 4px rgba(255, 255, 255, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
        padding: 30px;
    }

    #shareCard .card-animal-img {
        width: 100%;
        height: 100%;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        filter: drop-shadow(0 15px 30px rgba(0, 0, 0, 0.15));
    }

    /* Typography */
    #shareCard .card-animal-name {
        position: relative;
        z-index: 10;
        font-size: 64px;
        font-weight: 900;
        color: #1F2937;
        margin-bottom: 30px;
        line-height: 1.1;
        letter-spacing: -0.03em;
        word-break: keep-all;
    }

    #shareCard .card-subtitle-box {
        position: relative;
        z-index: 10;
        background: rgba(255, 255, 255, 0.85);
        padding: 24px 30px;
        border-radius: 20px;
        margin-bottom: auto;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        max-width: 90%;
    }

    #shareCard .card-subtitle {
        font-size: 22px;
        color: #4B5563;
        font-weight: 700;
        line-height: 1.5;
        word-break: keep-all;
    }

    /* Footer */
    #shareCard .card-footer {
        position: relative;
        z-index: 10;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid rgba(229, 231, 235, 0.8);
        width: 80%;
        text-align: center;
    }

    #shareCard .card-footer-text {
        font-size: 16px;
        color: #9CA3AF;
        font-weight: 600;
        margin-bottom: 8px;
    }

    #shareCard .card-url {
        font-size: 22px;
        font-weight: 800;
        color: #7C3AED;
        letter-spacing: 0.02em;
    }
</style>

<div class="w-full max-w-4xl mx-auto space-y-8 animate-fade-in-up pb-20">

    <!-- 1. í—¤ë” ì¹´ë“œ (ë™ë¬¼ ì´ë¯¸ì§€ & íƒ€ì´í‹€) -->
    <div class="clay-card p-10 text-center relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-300 to-orange-500"></div>

        <div class="inline-block p-4 rounded-full bg-white shadow-clay-inner mb-6 relative z-10">
            <img src="{% static 'ssambti/images/animals/' %}{{ animal_image }}" alt="{{ animal_name }}"
                class="w-80 h-80 object-contain rounded-full">
        </div>

        <h2 class="text-5xl md:text-6xl font-bold text-gray-800 font-title mb-4">
            <span class="text-orange-500 block text-3xl mb-3">êµì‹¤ ì† ë‹¹ì‹ ì˜ ë™ë¬¼ì€</span>
            {{ animal_name }}
        </h2>
    </div>

    <!-- 2. AI ë¶„ì„ ë‚´ìš© -->
    <div class="zoo-result-content">
        {{ result_html|safe }}
    </div>

    <!-- 3. ê³µìœ  ì•¡ì…˜ ì¹´ë“œ -->
    <div class="clay-card p-8 bg-white/50 border border-white/60 text-center">

        {% if not user.is_authenticated %}
        <div class="mb-6 p-4 bg-orange-50 rounded-2xl border border-orange-100 animate-pulse">
            <p class="text-orange-700 font-bold text-xl">
                <i class="fa-solid fa-triangle-exclamation mr-2"></i> ë¡œê·¸ì¸í•˜ì§€ ì•Šìœ¼ë©´ ì´ ê²°ê³¼ëŠ” ì €ì¥ë˜ì§€ ì•Šì•„ìš”!
            </p>
            <a href="{% url 'account_login' %}?next={% url 'ssambti:main' %}"
                class="inline-block mt-2 text-sm text-orange-600 underline font-bold hover:text-orange-800">
                ë¡œê·¸ì¸í•˜ê³  ê²°ê³¼ ì˜êµ¬ ì €ì¥í•˜ê¸°
            </a>
        </div>
        {% endif %}

        <h3 class="text-2xl font-bold text-gray-700 mb-6 font-title">
            ë™ë£Œ ì„ ìƒë‹˜ë“¤ì—ê²Œë„ ì•Œë ¤ì£¼ì„¸ìš”! ğŸ“¢
        </h3>
        <div class="flex flex-col md:flex-row gap-4 justify-center">
            <button onclick="shareToKakao()"
                class="px-8 py-4 rounded-full bg-[#FEE500] text-[#3C1E1E] font-bold hover:scale-105 transition shadow-clay flex items-center justify-center gap-2 text-lg">
                <i class="fa-solid fa-comment"></i> ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
            </button>
            <button onclick="downloadImage()"
                class="px-8 py-4 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-full font-bold flex items-center justify-center gap-2 hover:scale-105 transition shadow-clay text-lg">
                <i class="fa-solid fa-share-nodes"></i> ì´ë¯¸ì§€ ì €ì¥/ê³µìœ 
            </button>
            <a href="{% url 'ssambti:main' %}"
                class="px-8 py-4 rounded-full bg-orange-500 text-white font-bold hover:bg-orange-600 transition shadow-clay flex items-center justify-center gap-2 text-lg">
                <i class="fa-solid fa-rotate-right"></i> ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°
            </a>
        </div>
    </div>
</div>

<!-- Hidden Share Card for Image Generation -->
<div id="shareCard">
    <div class="card-header">
        <span class="card-logo-icon">ğŸ¦</span>
        <span class="card-logo-text">ìŒ¤BTI</span>
    </div>

    <div class="card-title-prefix">êµì‹¤ ì† ë‹¹ì‹ ì˜ ë™ë¬¼ì€</div>

    <div class="card-animal-container">
        <!-- background-image div to prevent squashing in html2canvas -->
        <div class="card-animal-img"
            style="background-image: url('{% static 'ssambti/images/animals/' %}{{ animal_image }}');">
        </div>
    </div>

    <div class="card-animal-name">{{ animal_name }}</div>

    <div class="card-subtitle-box">
        <div class="card-subtitle">"{{ summary }}"</div>
    </div>

    <div class="card-footer">
        <div class="card-footer-text">ë‚˜ì˜ êµì‹¤ ì† ë³¸ìº ì°¾ê¸°</div>
        <div class="card-url">eduitit.site/ssambti</div>
    </div>
</div>

<!-- html2canvas Library -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


<!-- Kakao SDK -->
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>
<script>
    // HTMX ë“±ìœ¼ë¡œ ë‚˜ì¤‘ì— ì‚½ì…ë˜ì–´ë„ ì¦‰ì‹œ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜(IIFE) ì‚¬ìš©
    (function () {
        // [Hotfix] Remove 'font-hand' class from legacy data (run once on load)
        (function removeHandwrittenFont() {
            var elements = document.querySelectorAll('.font-hand');
            if (elements.length > 0) {
                elements.forEach(function (el) {
                    el.classList.remove('font-hand');
                });
                console.log('âœ… Removed font-hand from ' + elements.length + ' legacy elements');
            }
        })();

        function initKakao() {
            if (typeof Kakao !== 'undefined') {
                if (!Kakao.isInitialized()) {
                    try {
                        Kakao.init('{{ KAKAO_JS_KEY }}');
                        console.log('âœ… Kakao SDK initialized (Direct)');
                    } catch (error) {
                        console.error('âŒ Kakao init error:', error);
                    }
                } else {
                    console.log('âœ… Kakao SDK already initialized');
                }
            } else {
                // ì•„ì§ SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì¬ì‹œë„
                console.log('â³ Waiting for Kakao SDK...');
                setTimeout(initKakao, 200);
            }
        }
        initKakao();
    })();

    function shareToKakao() {
        if (typeof Kakao === 'undefined') {
            alert('ì¹´ì¹´ì˜¤í†¡ SDKë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!Kakao.isInitialized()) {
            // í•œë²ˆ ë” ì´ˆê¸°í™” ì‹œë„
            try {
                Kakao.init('{{ KAKAO_JS_KEY }}');
            } catch (e) {
                alert('ì¹´ì¹´ì˜¤í†¡ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
                return;
            }
        }

        try {
            {% if saved_result_id %}
            // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì: ì¹´ë“œ í´ë¦­ ì‹œ ì €ì¥ëœ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
            var shareUrl = 'https://{{ request.get_host }}{% url "ssambti:detail" saved_result_id %}';
            {% else %}
            // ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì: ì¹´ë“œ í´ë¦­ ì‹œ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
            var shareUrl = 'https://{{ request.get_host }}{% url "ssambti:main" %}';
            {% endif %}

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: 'ğŸ¯ ë‚˜ëŠ” [{{ animal_name }}] ì„ ìƒë‹˜!',
                    description: '{{ animal_name }} ì„ ìƒë‹˜ì˜ íŠ¹ì§•: {{ summary }}\n\në‹¹ì‹ ì€ ì–´ë–¤ ì„ ìƒë‹˜ì¸ê°€ìš”? ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”! ğŸ«',
                    imageUrl: 'https://{{ request.get_host }}{% static "ssambti/images/share_cards/" %}{{ mbti_type }}_card.png',
                    link: {
                        mobileWebUrl: shareUrl,
                        webUrl: shareUrl,
                    },
                },
                buttons: [
                    {
                        title: 'ë‚˜ë„ ìŒ¤BTI í…ŒìŠ¤íŠ¸í•˜ê¸° ğŸ¦',
                        link: {
                            mobileWebUrl: 'https://{{ request.get_host }}{% url "ssambti:main" %}',
                            webUrl: 'https://{{ request.get_host }}{% url "ssambti:main" %}',
                        },
                    },
                ],
            });
        } catch (error) {
            console.error('âŒ Kakao share error:', error);
            alert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function downloadImage() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        const imageUrl = '{% static "ssambti/images/share_cards/" %}{{ mbti_type }}_card.png';

        try {
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ì´ë¯¸ì§€ ì¤€ë¹„ ì¤‘...';
            button.disabled = true;

            const response = await fetch(imageUrl);
            const blob = await response.blob();
            const file = new File([blob], 'ssambti_{{ animal_name }}.png', { type: 'image/png' });

            button.innerHTML = originalText;
            button.disabled = false;

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'ìŒ¤BTI ê²°ê³¼',
                        text: '{{ animal_name }} ì„ ìƒë‹˜ì˜ êµì‹¤ ì† ë³¸ìºë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!'
                    });
                    return;
                } catch (shareError) {
                    if (shareError.name !== 'AbortError') console.log('Share failed:', shareError);
                    else return;
                }
            }

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ssambti_{{ animal_name }}.png';
            link.click();
            URL.revokeObjectURL(link.href);

        } catch (error) {
            console.error('âŒ Download error:', error);
            button.innerHTML = originalText;
            button.disabled = false;
            alert('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>