{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<!-- Open Graph ë©”íƒ€ íƒœê·¸ -->
<meta property="og:title" content="ìŒ¤BTI ê²°ê³¼: {{ result.animal_name }} ì„ ìƒë‹˜" />
<meta property="og:description" content="{{ result.mbti_type }} - êµì‹¤ ì† ë‹¹ì‹ ì˜ ë™ë¬¼ì€?" />
<meta property="og:image" content="https://eduitit.site{% static 'ssambti/images/animals/' %}{{ animal_image }}" />
<meta property="og:url" content="https://eduitit.site/ssambti/detail/{{ result.pk }}/" />
<meta property="og:type" content="website" />
{% endblock %}

{% block extra_css %}
<style>
    /* Animation for results */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.8s ease-out forwards;
    }

    /* Badges for AI Result */
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: bold;
        font-size: 0.875rem;
        box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.05), inset -2px -2px 4px rgba(255, 255, 255, 0.8);
    }

    .badge-orange {
        background-color: #ffedd5;
        color: #c2410c;
    }

    .badge-purple {
        background-color: #f3e8ff;
        color: #7e22ce;
    }

    .badge-green {
        background-color: #dcfce7;
        color: #15803d;
    }

    /* Result Content Readability Improvements */
    .zoo-result-content {
        font-family: 'NanumSquareRound', 'Inter', sans-serif;
        font-size: 18px;
        line-height: 1.8;
        color: #374151;
        word-break: keep-all;
        overflow-wrap: break-word;
    }

    @media (min-width: 768px) {
        .zoo-result-content {
            font-size: 20px;
        }
    }

    .zoo-result-content h1,
    .zoo-result-content h2,
    .zoo-result-content h3 {
        font-family: 'NanumSquareRound', sans-serif;
        font-weight: 800;
        color: #1f2937;
        margin-top: 1.5em;
        margin-bottom: 0.75em;
        line-height: 1.4;
    }

    .zoo-result-content p {
        margin-bottom: 1em;
    }

    .zoo-result-content ul,
    .zoo-result-content ol {
        margin-left: 1.5em;
        margin-bottom: 1em;
    }

    .zoo-result-content li {
        margin-bottom: 0.5em;
    }

    .zoo-result-content strong {
        font-weight: 800;
        color: #7c3aed;
    }



    /* Share Card Styles (Premium Design - 9:16 Ratio) */
</style>
{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-6 min-h-screen bg-[#E0E5EC]">
    <div class="max-w-4xl mx-auto space-y-8 animate-fade-in-up">

        <!-- Navigation -->
        <div class="flex justify-between items-center px-2">
            <a href="{% url 'ssambti:history' %}"
                class="inline-flex items-center gap-2 text-gray-500 hover:text-orange-500 transition font-bold">
                <i class="fa-solid fa-arrow-left"></i> ë³´ê´€í•¨ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </a>
            <p class="text-orange-700 font-bold text-xl">
                <i class="fa-solid fa-triangle-exclamation mr-2"></i> ë¡œê·¸ì¸í•˜ì§€ ì•Šìœ¼ë©´ ì´ ê²°ê³¼ëŠ” ì €ì¥ë˜ì§€ ì•Šì•„ìš”!
            </p>
            <span class="text-gray-400">{{ result.created_at|date:"Y.m.d" }} ë¶„ì„</span>
        </div>

        <!-- 1. í—¤ë” ì¹´ë“œ (ë™ë¬¼ ì´ë¯¸ì§€ & íƒ€ì´í‹€) -->
        <div class="clay-card p-10 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-300 to-orange-500"></div>

            <div class="inline-block p-2 rounded-full bg-white shadow-clay-inner mb-6 relative z-10">
                <img src="{% static 'ssambti/images/animals/' %}{{ animal_image }}" alt="{{ result.animal_name }}"
                    class="w-48 h-48 object-cover rounded-full">
            </div>

            <h2 class="text-5xl md:text-6xl font-bold text-gray-800 font-title mb-4">
                <span class="text-orange-500 block text-3xl mb-3">êµì‹¤ ì† ë‹¹ì‹ ì˜ ë™ë¬¼ì€</span>
                {{ result.animal_name }}
            </h2>
        </div>

        <!-- 2. AI ë¶„ì„ ë‚´ìš© -->
        <div class="zoo-result-content">
            {{ result.result_text|safe }}
        </div>

        <!-- 3. ê³µìœ  ì•¡ì…˜ ì¹´ë“œ -->
        <div class="clay-card p-8 bg-white/50 border border-white/60 text-center">
            <h3 class="text-2xl font-bold text-gray-700 mb-6 font-title">
                ë™ë£Œ ì„ ìƒë‹˜ë“¤ì—ê²Œë„ ì•Œë ¤ì£¼ì„¸ìš”! ğŸ“¢
            </h3>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button onclick="shareToKakao()"
                    class="px-8 py-4 bg-[#FEE500] text-[#3C1E1E] rounded-full font-bold flex items-center justify-center gap-2 hover:scale-105 transition shadow-clay text-lg">
                    <i class="fa-solid fa-comment"></i> ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
                </button>
                <button onclick="downloadImage()"
                    class="px-8 py-4 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-full font-bold flex items-center justify-center gap-2 hover:scale-105 transition shadow-clay text-lg">
                    <i class="fa-solid fa-share-nodes"></i> ì´ë¯¸ì§€ ì €ì¥/ê³µìœ 
                </button>
                <button onclick="copyLink()"
                    class="px-8 py-4 bg-white text-gray-600 rounded-full font-bold flex items-center justify-center gap-2 hover:scale-105 transition shadow-clay border border-gray-100 text-lg">
                    <i class="fa-solid fa-link"></i> ë§í¬ ë³µì‚¬
                </button>
                <a href="{% url 'ssambti:main' %}"
                    class="px-8 py-4 bg-orange-500 text-white rounded-full font-bold flex items-center justify-center gap-2 hover:scale-105 transition shadow-clay text-lg">
                    <i class="fa-solid fa-rotate-right"></i> ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Hidden Share Card for Image Generation -->


<!-- html2canvas Library -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Kakao SDK -->
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>
<script>
    // [Hotfix] Remove 'font-hand' class from legacy data (run once on load)
    (function removeHandwrittenFont() {
        var elements = document.querySelectorAll('.font-hand');
        if (elements.length > 0) {
            elements.forEach(function (el) {
                el.classList.remove('font-hand');
            });
            console.log('âœ… Removed font-hand from ' + elements.length + ' legacy elements');
        }
    })();

    if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
        Kakao.init('{{ KAKAO_JS_KEY }}');
    }

    function shareToKakao() {
        Kakao.Share.sendDefault({
            objectType: 'feed',
            content: {
                title: 'ğŸ¯ ìŒ¤BTI ê²°ê³¼: {{ result.animal_name }} ì„ ìƒë‹˜',
                description: '{{ result.animal_name }} ì„ ìƒë‹˜ ({{ result.mbti_type }})ìœ¼ë¡œ íŒì •ë°›ì•˜ì–´ìš”!\n\në‹¹ì‹ ë„ êµì‹¤ ì† ë‹¹ì‹ ì˜ ë™ë¬¼ì„ ì°¾ì•„ë³´ì„¸ìš”! ğŸ¦ğŸ§ğŸ¦',
                imageUrl: 'https://{{ request.get_host }}{% static "ssambti/images/share_cards/" %}{{ animal_image|slice:":-4" }}_card.png',
                link: {
                    mobileWebUrl: window.location.href,
                    webUrl: window.location.href,
                },
            },
            buttons: [
                {
                    title: 'ë‚˜ë„ í…ŒìŠ¤íŠ¸í•´ë³´ê¸°',
                    link: {
                        mobileWebUrl: 'https://{{ request.get_host }}{% url "ssambti:main" %}',
                        webUrl: 'https://{{ request.get_host }}{% url "ssambti:main" %}',
                    },
                },
            ],
        });
    }

    function copyLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });
    }

    async function downloadImage() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        const imageUrl = '{% static "ssambti/images/share_cards/" %}{{ result.mbti_type }}_card.png';

        try {
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ì´ë¯¸ì§€ ì¤€ë¹„ ì¤‘...';
            button.disabled = true;

            const response = await fetch(imageUrl);
            const blob = await response.blob();
            const file = new File([blob], 'ssambti_{{ result.animal_name }}.png', { type: 'image/png' });

            button.innerHTML = originalText;
            button.disabled = false;

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'ìŒ¤BTI ê²°ê³¼',
                        text: '{{ result.animal_name }} ì„ ìƒë‹˜ì˜ êµì‹¤ ì† ë³¸ìºë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!'
                    });
                    return;
                } catch (shareError) {
                    if (shareError.name !== 'AbortError') console.log('Share failed:', shareError);
                    else return;
                }
            }

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ssambti_{{ result.animal_name }}.png';
            link.click();
            URL.revokeObjectURL(link.href);

        } catch (error) {
            console.error('âŒ Download error:', error);
            button.innerHTML = originalText;
            button.disabled = false;
            alert('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>
{% endblock %}