{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<!-- Open Graph Î©îÌÉÄ ÌÉúÍ∑∏ -->
<meta property="og:title" content="Ïå§BTI - ÍµêÏã§ ÏÜç ÎÇòÏùò ÎèôÎ¨º Ï∞æÍ∏∞" />
<meta property="og:description" content="12Í∞ÄÏßÄ ÏßàÎ¨∏ÏúºÎ°ú ÏïåÏïÑÎ≥¥Îäî ÏÑ†ÏÉùÎãòÏùò ÍµêÏã§ ÏÜç ÏûêÏïÑ!" />
<meta property="og:image" content="https://eduitit.site/static/images/eduitit_og.png" />
<meta property="og:url" content="https://eduitit.site/ssambti/" />
<meta property="og:type" content="website" />
{% endblock %}

{% block extra_css %}
<style>
    .quiz-step {
        display: none;
        min-height: 400px;
    }

    .quiz-step.active {
        display: block;
        animation: slideIn 0.5s ease-out;
        min-height: 400px;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .progress-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #f97316, #fbbf24);
        transition: width 0.3s ease;
    }

    .option-btn {
        width: 100%;
        padding: 1.5rem;
        background: #E0E5EC;
        border-radius: 20px;
        box-shadow: 6px 6px 12px #b8bec5, -6px -6px 12px #ffffff;
        text-align: left;
        font-size: 1.25rem;
        font-weight: bold;
        color: #4a5568;
        transition: all 0.2s;
        border: 2px solid transparent;
        margin-bottom: 1rem;
    }

    .option-btn:hover {
        transform: translateY(-2px);
        box-shadow: 8px 8px 16px #b8bec5, -8px -8px 16px #ffffff;
    }

    .option-btn.selected {
        box-shadow: inset 4px 4px 8px #b8bec5, inset -4px -4px 8px #ffffff;
        border-color: #f97316;
        color: #f97316;
    }

    /* Animation for results */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.8s ease-out forwards;
    }

    /* Badges for AI Result */
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: bold;
        font-size: 0.875rem;
        box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.05), inset -2px -2px 4px rgba(255, 255, 255, 0.8);
    }

    .badge-orange {
        background-color: #ffedd5;
        color: #c2410c;
    }

    .badge-purple {
        background-color: #f3e8ff;
        color: #7e22ce;
    }

    .badge-green {
        background-color: #dcfce7;
        color: #15803d;
    }

    /* Loader Visibility Control */
    #zoo-loader {
        display: none;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    #zoo-loader.htmx-request {
        display: flex;
        opacity: 1;
        pointer-events: auto;
    }

    /* Modal Animations */
    #animal-modal.flex {
        display: flex;
    }

    .modal-enter {
        animation: modalZoom 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    @keyframes modalZoom {
        from {
            opacity: 0;
            transform: scale(0.9);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-6 min-h-screen bg-[#E0E5EC]">
    <div class="max-w-3xl mx-auto" id="results-wrapper">

        <!-- Everything inside this div will be replaced by the result -->
        <div id="quiz-ui-container">
            <!-- 1. Ìó§Îçî ÏÑπÏÖò -->
            <div class="text-center mb-12" data-aos="fade-up">
                <div class="mb-10 rounded-3xl overflow-hidden shadow-clay-inner">
                    <img src="{% static 'ssambti/images/animals/main_header.png' %}" alt="Teachable Zoo"
                        class="w-full h-auto object-cover max-h-[400px]">
                </div>
                <h1 class="text-5xl md:text-6xl font-bold text-gray-700 font-title mb-4">
                    {{ title }}
                </h1>
                {% if user.is_authenticated %}
                <a href="{% url 'ssambti:history' %}"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/50 text-gray-500 hover:text-orange-500 transition shadow-sm mb-4">
                    <i class="fa-solid fa-box-archive"></i> ÎÇ¥ Í≤∞Í≥º Î≥¥Í¥ÄÌï®
                </a>
                {% else %}
                <div
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/50 text-gray-400 mb-4 cursor-default">
                    <i class="fa-solid fa-info-circle"></i> Í≤∞Í≥º Ï†ÄÏû•ÏùÑ ÏúÑÌï¥ÏÑ† Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï¥Ïöî
                </div>
                {% endif %}
                <div class="flex items-center justify-between mb-4 mt-8">
                    <span class="text-xl font-bold text-orange-600 font-title">ÎèôÎ¨º MBTI ÌÖåÏä§Ìä∏</span>
                    <span class="text-xl font-bold text-gray-400" id="stepIndicator">1 / 12</span>
                </div>
                <div class="progress-bar mb-6 shadow-clay-inner">
                    <div class="progress-fill" id="progressBar" style="width: 8.33%;"></div>
                </div>
            </div>

            <!-- Quiz Container -->
            <div class="clay-card p-8 md:p-12 relative min-h-[300px] flex flex-col justify-center" data-aos="zoom-in">
                <form id="quizForm" hx-post="{% url 'ssambti:analyze' %}" hx-target="#results-wrapper"
                    hx-indicator="#zoo-loader" hx-swap="innerHTML" onsubmit="return validateQuiz()">
                    {% csrf_token %}
                    {% if collect_code %}
                    <input type="hidden" name="collect_code" value="{{ collect_code }}">
                    {% endif %}
                    {% if collect_affiliation %}
                    <input type="hidden" name="collect_affiliation" value="{{ collect_affiliation }}">
                    {% endif %}

                    <!-- Q1-Q12 steps will be injected here via JS for cleaner template -->
                    <div id="quizSteps">
                        <!-- Steps will be generated by JS -->
                    </div>

                    <!-- Navigation -->
                    <div class="mt-8 flex justify-between items-center">
                        <button type="button" id="prevBtn" onclick="prevStep()"
                            class="hidden px-8 py-3 rounded-full text-gray-400 font-bold hover:text-gray-600 transition">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Ïù¥Ï†Ñ
                        </button>
                        <!-- 'Îã§Ïùå' Î≤ÑÌäº ÏÇ≠Ï†ú (ÏûêÎèô Ïù¥Îèô) -->
                        <button type="submit" id="submitBtn"
                            class="hidden ml-auto px-10 py-4 bg-gradient-to-r from-orange-600 to-orange-400 text-white rounded-full text-2xl font-bold shadow-clay hover:shadow-clay-hover transition transform active:scale-95">
                            Í≤∞Í≥º ÌôïÏù∏ÌïòÍ∏∞ <i class="fa-solid fa-wand-sparkles ml-2"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Statistics Graph Section -->
            {% if total_participants > 0 %}
            <div class="clay-card p-6 md:p-8 bg-white/60 text-left mt-8" data-aos="fade-up">
                <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 font-title flex items-center gap-2">
                    <span class="text-2xl md:text-3xl">üìä</span> Ï†ÑÏ≤¥ Ï∞∏Ïó¨ ÍµêÏÇ¨ ÌÜµÍ≥Ñ
                    <span class="text-sm font-normal text-gray-500 ml-2">(Ï¥ù {{ total_participants }}Î™Ö Ï∞∏Ïó¨)</span>
                </h3>

                <div class="space-y-4">
                    {% for item in stats %}
                    <div class="group cursor-pointer hover:scale-[1.01] transition-transform"
                        hx-get="{% url 'ssambti:preview' item.mbti_type %}" hx-target="#modalContent"
                        onclick="openUnifiedModal()">
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-lg font-bold text-gray-700 flex items-center gap-2">
                                <span class="text-xl inline-block w-8 text-center">{{ forloop.counter }}</span>
                                <span class="text-2xl">{{ item.theme.emoji }}</span>
                                {{ item.animal_name }}
                            </span>
                            <span class="text-sm font-bold text-gray-500">
                                {{ item.count }}Î™Ö <span class="text-purple-600 ml-1">({{ item.percentage }}%)</span>
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 md:h-4 overflow-hidden shadow-inner">
                            <div class="bg-gradient-to-r h-3 md:h-4 rounded-full transition-all duration-1000 ease-out stats-bar-fill"
                                data-w="{{ item.percentage }}%" data-bg="{{ item.theme.primary }}"
                                data-delay="{{ forloop.counter }}00ms">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-6 text-right text-xs text-gray-400">
                    * Î™®Îì† Ï∞∏Ïó¨ÏûêÏùò Í≤∞Í≥ºÎ•º Î∞îÌÉïÏúºÎ°ú ÏßëÍ≥ÑÎêú Îç∞Ïù¥ÌÑ∞ÏûÖÎãàÎã§.
                </div>
                <script>
                    (function () {
                        document.querySelectorAll('.stats-bar-fill').forEach(el => {
                            if (el.dataset.w) el.style.width = el.dataset.w;
                            if (el.dataset.bg) el.style.backgroundColor = el.dataset.bg;
                            if (el.dataset.delay) el.style.animationDelay = el.dataset.delay;
                            el.style.animation = 'slideRight 1s ease-out forwards';
                        });
                    })();
                </script>
            </div>

            <style>
                @keyframes slideRight {
                    from {
                        transform: translateX(-100%);
                    }

                    to {
                        transform: translateX(0);
                    }
                }
            </style>
            {% endif %}
        </div>
    </div>

    <!-- Loader -->
    <div id="zoo-loader"
        class="htmx-indicator fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white/60 backdrop-blur-md">
        <div class="w-32 h-32 rounded-full shadow-clay flex items-center justify-center bg-white mb-6">
            <i class="fa-solid fa-calculator fa-bounce text-5xl text-orange-500"></i>
        </div>
    </div>
</section>


<script>
    const questions = [
        { id: 1, title: "Q1. Ïâ¨Îäî ÏãúÍ∞ÑÏóê ÏïÑÏù¥Îì§Ïù¥ Ïö∞Î•¥Î•¥ Ï∞æÏïÑÏò§Î©¥?", options: ["ÏïÑÏù¥Îì§Í≥º ÏàòÎã§ Îñ®Î©∞ Ï¶êÍ≤ÅÍ≤å Î≥¥ÎÇ∏Îã§", "Ï°∞Í∏à ÌûòÎì§ÏßÄÎßå ÏõÉÏúºÎ©∞ ÏùëÎåÄÌïòÍ≥† ÌòºÏûê ÏûàÍ≥† Ïã∂Ïñ¥ÌïúÎã§"] },
        { id: 2, title: "Q2. ÎèôÎ£å ÏÑ†ÏÉùÎãòÎì§Í≥ºÏùò Ï†êÏã¨ÏãúÍ∞ÑÏùÄ?", options: ["Îã§Ìï®Íªò Î∂ÅÏ†ÅÎ∂ÅÏ†Å Ïù¥ÏïºÍ∏∞ÍΩÉÏùÑ ÌîºÏö∞ÎäîÍ≤å Ï¢ãÎã§", "ÏπúÌïú Î∂Ñ ÌïúÎëê Î∂ÑÍ≥º Ï°∞Ïö©Ìûà ÏãùÏÇ¨ÌïòÎäîÍ±∏ ÏÑ†Ìò∏ÌïúÎã§"] },
        { id: 3, title: "Q3. ÏÑ†Ìò∏ÌïòÎäî ÍµêÏã§ Î∂ÑÏúÑÍ∏∞Îäî?", options: ["ÏïÑÏù¥Îì§Ïùò ÌôúÍ∏∞Ï∞¨ ÏõÉÏùåÏÜåÎ¶¨Í∞Ä ÎÅäÏù¥ÏßÄ ÏïäÎäî Î∂ÑÏúÑÍ∏∞", "Î™®ÎëêÍ∞Ä Í∞ÅÏûêÏùò ÏùºÏóê ÏßëÏ§ëÌïòÎäî Ï∞®Î∂ÑÌïú Î∂ÑÏúÑÍ∏∞"] },
        { id: 4, title: "Q4. ÏàòÏóÖ Ï§ÄÎπÑÎ•º Ìï† Îïå Í∞ÄÏû• Î®ºÏ†Ä Ï±ôÍ∏∞Îäî Í≤ÉÏùÄ?", options: ["ÍµêÍ≥ºÏÑú ÎÇ¥Ïö©Í≥º ÏßÄÎèÑÏïàÏùò ÌùêÎ¶Ñ", "Ïù¥Î≤à ÏàòÏóÖÏóêÏÑú ÎçòÏßà ÌïµÏã¨ ÏßàÎ¨∏Í≥º ÏòÅÍ∞ê"] },
        { id: 5, title: "Q5. Ï≤òÏùå Îß°ÏùÄ ÌïôÏÉùÏùÑ ÌååÏïÖÌï† Îïå ÎÇòÎäî?", options: ["ÏÉùÌôúÍ∏∞Î°ùÎ∂ÄÏôÄ Í¥ÄÏ∞∞Îêú ÌñâÎèô Îç∞Ïù¥ÌÑ∞Î•º Ï§ëÏãúÌïúÎã§", "Îßê ÌïúÎßàÎîî ÏÑ±Í≤©Ïùò Ïù¥Î©¥ÏùÑ ÏßÅÍ¥ÄÏ†ÅÏúºÎ°ú ÎäêÎÇÄÎã§"] },
        { id: 6, title: "Q6. ÌïôÍ∏âÏóê Î¨∏Ï†úÍ∞Ä ÏÉùÍ≤ºÏùÑ Îïå Ìï¥Í≤∞ Î∞©ÏãùÏùÄ?", options: ["ÎπÑÏä∑Ìïú Í≥ºÍ±∞ ÏÇ¨Î°ÄÎÇò Îß§Îâ¥ÏñºÏùÑ Ï∞æÏïÑÎ≥∏Îã§", "ÏÉÅÌô©Ïóê ÎßûÎäî Ï∞ΩÏùòÏ†ÅÏù∏ Ìï¥Í≤∞Ï±ÖÏùÑ Îñ†Ïò¨Î¶∞Îã§"] },
        { id: 7, title: "Q7. ÌïôÏÉùÏùÑ Íæ∏Ï§ëÌï† Îïå ÎÇ¥Í∞Ä Îçî Ïã†Í≤Ω Ïì∞Îäî Í≤ÉÏùÄ?", options: ["ÏûòÎ™ªÎêú Ïù¥Ïú†Î•º Î™ÖÌôïÌûà ÏßöÏñ¥Ï£ºÎäî Í≤É", "ÌïôÏÉùÏù¥ ÏÉÅÏ≤òÎ∞õÏßÄ ÏïäÍ≤å ÎßàÏùåÏùÑ Ïñ¥Î£®ÎßåÏßÄÎäî Í≤É"] },
        { id: 8, title: "Q8. ÏàòÌñâÌèâÍ∞Ä Ï†êÏàòÎ•º Ï§Ñ Îïå ÎÇòÏùò Í∏∞Ï§ÄÏùÄ?", options: ["Í≤∞Í≥ºÎ¨ºÏù¥ Î£®Î∏åÎ¶≠(Ï±ÑÏ†êÍ∏∞Ï§Ä)Ïóê ÏñºÎßàÎÇò Î∂ÄÌï©ÌïòÎäîÍ∞Ä", "Í≥ºÏ†ï ÏÜçÏóêÏÑú ÌïôÏÉùÏù¥ ÏñºÎßàÎÇò ÎÖ∏Î†•ÌïòÍ≥† ÏÑ±Ïû•ÌñàÎäîÍ∞Ä"] },
        { id: 9, title: "Q9. ÌûòÎì§Ïñ¥ÌïòÎäî ÎèôÎ£å ÏÑ†ÏÉùÎãòÏùÑ ÏúÑÎ°úÌï† Îïå ÎÇòÎäî?", options: ["Î¨∏Ï†úÎ•º Ìï¥Í≤∞Ìï† Ïàò ÏûàÎäî ÌòÑÏã§Ï†ÅÏù∏ Ï°∞Ïñ∏ÏùÑ Ìï¥Ï§ÄÎã§", "Í∑∏ ÎßàÏùå Ï∂©Î∂ÑÌûà Ïù¥Ìï¥ÌïúÎã§Î©∞ ÎÅùÍπåÏßÄ Îì§Ïñ¥Ï§ÄÎã§"] },
        { id: 10, title: "Q10. ÎÇòÏùò ÌïòÎ£® ÏùºÍ≥º Ïä§ÌÉÄÏùºÏùÄ?", options: ["Í≥ÑÌöçÎêú ÏãúÍ∞ÑÌëúÎåÄÎ°ú ÏõÄÏßÅÏó¨Ïïº ÎßàÏùåÏù¥ Ìé∏ÌïòÎã§", "ÏÉÅÌô©Ïóê Îî∞Îùº Ïú†Ïó∞ÌïòÍ≤å ÏùºÏ†ïÏùÑ Ï°∞Ï†ïÌïúÎã§"] },
        { id: 11, title: "Q11. ÌòÑÏû¨ ÎÇòÏùò ÍµêÎ¨¥Ïã§ Ï±ÖÏÉÅ ÏÉÅÌÉúÎäî?", options: ["Ïñ¥ÎîîÏóê Î¨¥ÏóáÏù¥ ÏûàÎäîÏßÄ ÏïåÎèÑÎ°ù Ïö©ÎèÑÎ≥ÑÎ°ú Ï†ïÎèàÎê®", "ÎÇòÎßåÏùò ÏßàÏÑúÍ∞Ä ÏûàÎäî ÏûêÏú†Î°úÏö¥ ÏÉÅÌÉú"] },
        { id: 12, title: "Q12. ÌòÑÏû•Ï≤¥ÌóòÌïôÏäµ Í≥ÑÌöçÏùÑ Ïß§ Îïå ÎÇòÎäî?", options: ["Î∂Ñ Îã®ÏúÑÎ°ú ÏÉÅÏÑ∏ ÎèôÏÑ†ÏùÑ ÎØ∏Î¶¨ Í≥ÑÌöçÌïúÎã§", "ÍµµÏßÅÌïú ÏùºÏ†ïÎßå Ï†ïÌïòÍ≥† ÌòÑÏû• ÏÉÅÌô©ÏùÑ Ï¶êÍ∏¥Îã§"] }
    ];

    let currentStep = 1;
    const totalSteps = questions.length;

    function renderQuestions() {
        const container = document.getElementById('quizSteps');
        container.innerHTML = questions.map(q => `
            <div class="quiz-step ${q.id === 1 ? 'active' : ''}" id="step-${q.id}">
                <h2 class="text-3xl font-bold text-gray-700 mb-8 break-keep">${q.title}</h2>
                <div class="space-y-4">
                    ${q.options.map((opt, idx) => `
                        <button type="button" class="option-btn" onclick="selectOption(${q.id}, ${idx}, this)">
                            ${opt}
                        </button>
                    `).join('')}
                    <input type="hidden" name="q${q.id}" id="input-q${q.id}" value="">
                </div>
            </div>
        `).join('');
    }

    function selectOption(step, value, btn) {
        // Mark as selected
        const buttons = document.getElementById(`step-${step}`).querySelectorAll('.option-btn');
        buttons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');

        // Set input value
        document.getElementById(`input-q${step}`).value = value;

        // Auto move to next step after short delay
        setTimeout(() => {
            if (currentStep < totalSteps) {
                nextStep();
            } else {
                updateStepUI();
            }
        }, 300);
    }

    function updateStepUI() {
        document.querySelectorAll('.quiz-step').forEach(s => s.classList.remove('active'));
        document.getElementById(`step-${currentStep}`).classList.add('active');

        document.getElementById('stepIndicator').innerText = `${currentStep} / ${totalSteps}`;
        document.getElementById('progressBar').style.width = `${(currentStep / totalSteps) * 100}%`;

        document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);

        const submitBtn = document.getElementById('submitBtn');
        // ÎßàÏßÄÎßâ Îã®Í≥ÑÏù¥Í≥†, 12Î≤à Î¨∏Ìï≠Ïóê ÎãµÏù¥ Ï±ÑÏõåÏ°åÏùÑ ÎïåÎßå 'Í≤∞Í≥º ÌôïÏù∏ÌïòÍ∏∞' ÎÖ∏Ï∂ú
        if (currentStep === totalSteps && document.getElementById(`input-q${totalSteps}`).value !== "") {
            submitBtn.classList.remove('hidden');
        } else {
            submitBtn.classList.add('hidden');
        }
    }

    function nextStep() {
        if (currentStep < totalSteps) {
            currentStep++;
            updateStepUI();
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepUI();
        }
    }

    function validateQuiz() {
        for (let i = 1; i <= totalSteps; i++) {
            if (!document.getElementById(`input-q${i}`).value) {
                alert(`ÏßàÎ¨∏ ${i}Î≤àÏóê ÎãµÎ≥ÄÌï¥Ï£ºÏÑ∏Ïöî!`);
                currentStep = i;
                updateStepUI();
                return false;
            }
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', renderQuestions);

    document.body.addEventListener('htmx:afterSwap', function (evt) {
        if (evt.detail.target.id === 'zoo-result-area') {
            document.getElementById('quizForm').classList.add('hidden');
            document.getElementById('zoo-result-area').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });

</script>
{% endblock %}
