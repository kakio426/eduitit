{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<!-- Open Graph ë©”íƒ€ íƒœê·¸ -->
<meta property="og:title" content="ìŒ¤BTI - êµì‹¤ ì† ë‚˜ì˜ ë™ë¬¼ ì°¾ê¸°" />
<meta property="og:description" content="12ê°€ì§€ ì§ˆë¬¸ìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ì„ ìƒë‹˜ì˜ êµì‹¤ ì† ìì•„!" />
<meta property="og:image" content="https://eduitit.site/static/images/eduitit_og.png" />
<meta property="og:url" content="https://eduitit.site/ssambti/" />
<meta property="og:type" content="website" />
{% endblock %}

{% block extra_css %}
<style>
    .quiz-step {
        display: none;
        min-height: 400px;
    }

    .quiz-step.active {
        display: block;
        animation: slideIn 0.5s ease-out;
        min-height: 400px;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .progress-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #f97316, #fbbf24);
        transition: width 0.3s ease;
    }

    .option-btn {
        width: 100%;
        padding: 1.5rem;
        background: #E0E5EC;
        border-radius: 20px;
        box-shadow: 6px 6px 12px #b8bec5, -6px -6px 12px #ffffff;
        text-align: left;
        font-size: 1.25rem;
        font-weight: bold;
        color: #4a5568;
        transition: all 0.2s;
        border: 2px solid transparent;
        margin-bottom: 1rem;
    }

    .option-btn:hover {
        transform: translateY(-2px);
        box-shadow: 8px 8px 16px #b8bec5, -8px -8px 16px #ffffff;
    }

    .option-btn.selected {
        box-shadow: inset 4px 4px 8px #b8bec5, inset -4px -4px 8px #ffffff;
        border-color: #f97316;
        color: #f97316;
    }

    /* Animation for results */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.8s ease-out forwards;
    }

    /* Badges for AI Result */
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: bold;
        font-size: 0.875rem;
        box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.05), inset -2px -2px 4px rgba(255, 255, 255, 0.8);
    }

    .badge-orange {
        background-color: #ffedd5;
        color: #c2410c;
    }

    .badge-purple {
        background-color: #f3e8ff;
        color: #7e22ce;
    }

    .badge-green {
        background-color: #dcfce7;
        color: #15803d;
    }

    /* Loader Visibility Control */
    #zoo-loader {
        display: none;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    #zoo-loader.htmx-request {
        display: flex;
        opacity: 1;
        pointer-events: auto;
    }
</style>
{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-6 min-h-screen bg-[#E0E5EC]">
    <div class="max-w-3xl mx-auto" id="results-wrapper">

        <!-- Everything inside this div will be replaced by the result -->
        <div id="quiz-ui-container">
            <!-- 1. í—¤ë” ì„¹ì…˜ -->
            <div class="text-center mb-12" data-aos="fade-up">
                <div class="mb-10 rounded-3xl overflow-hidden shadow-clay-inner">
                    <img src="{% static 'ssambti/images/animals/main_header.png' %}" alt="Teachable Zoo"
                        class="w-full h-auto object-cover max-h-[400px]">
                </div>
                <h1 class="text-5xl md:text-6xl font-bold text-gray-700 font-title mb-4">
                    {{ title }}
                </h1>
                {% if user.is_authenticated %}
                <a href="{% url 'ssambti:history' %}"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/50 text-gray-500 hover:text-orange-500 transition shadow-sm mb-4">
                    <i class="fa-solid fa-box-archive"></i> ë‚´ ê²°ê³¼ ë³´ê´€í•¨
                </a>
                {% else %}
                <div
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/50 text-gray-400 mb-4 cursor-default">
                    <i class="fa-solid fa-info-circle"></i> ê²°ê³¼ ì €ì¥ì„ ìœ„í•´ì„  ë¡œê·¸ì¸ì´ í•„ìš”í•´ìš”
                </div>
                {% endif %}
                <div class="flex items-center justify-between mb-4 mt-8">
                    <span class="text-xl font-bold text-orange-600 font-title">ë™ë¬¼ MBTI í…ŒìŠ¤íŠ¸</span>
                    <span class="text-xl font-bold text-gray-400" id="stepIndicator">1 / 12</span>
                </div>
                <div class="progress-bar mb-6 shadow-clay-inner">
                    <div class="progress-fill" id="progressBar" style="width: 8.33%;"></div>
                </div>
            </div>

            <!-- Quiz Container -->
            <div class="clay-card p-8 md:p-12 relative min-h-[350px] flex flex-col justify-center" data-aos="zoom-in">
                <form id="quizForm" hx-post="{% url 'ssambti:analyze' %}" hx-target="#results-wrapper"
                    hx-indicator="#zoo-loader" hx-swap="innerHTML" onsubmit="return validateQuiz()">
                    {% csrf_token %}

                    <!-- Q1-Q12 steps will be injected here via JS for cleaner template -->
                    <div id="quizSteps">
                        <!-- Steps will be generated by JS -->
                    </div>

                    <!-- Navigation -->
                    <div class="mt-8 flex justify-between items-center">
                        <button type="button" id="prevBtn" onclick="prevStep()"
                            class="hidden px-8 py-3 rounded-full text-gray-400 font-bold hover:text-gray-600 transition">
                            <i class="fa-solid fa-arrow-left mr-2"></i> ì´ì „
                        </button>
                        <!-- 'ë‹¤ìŒ' ë²„íŠ¼ ì‚­ì œ (ìë™ ì´ë™) -->
                        <button type="submit" id="submitBtn"
                            class="hidden ml-auto px-10 py-4 bg-gradient-to-r from-orange-600 to-orange-400 text-white rounded-full text-2xl font-bold shadow-clay hover:shadow-clay-hover transition transform active:scale-95">
                            ê²°ê³¼ í™•ì¸í•˜ê¸° <i class="fa-solid fa-wand-sparkles ml-2"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Statistics Graph Section -->
            {% if total_participants > 0 %}
            <div class="clay-card p-6 md:p-8 bg-white/60 text-left mt-8" data-aos="fade-up">
                <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 font-title flex items-center gap-2">
                    <span class="text-2xl md:text-3xl">ğŸ“Š</span> ì „ì²´ ì°¸ì—¬ êµì‚¬ í†µê³„
                    <span class="text-sm font-normal text-gray-500 ml-2">(ì´ {{ total_participants }}ëª… ì°¸ì—¬)</span>
                </h3>

                <div class="space-y-4">
                    {% for item in stats %}
                    <div class="group">
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-lg font-bold text-gray-700 flex items-center gap-2">
                                <span class="text-xl inline-block w-8 text-center">{{ forloop.counter }}</span>
                                <span class="text-2xl">{{ item.theme.emoji }}</span>
                                {{ item.animal_name }}
                            </span>
                            <span class="text-sm font-bold text-gray-500">
                                {{ item.count }}ëª… <span class="text-purple-600 ml-1">({{ item.percentage }}%)</span>
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 md:h-4 overflow-hidden shadow-inner">
                            <div class="bg-gradient-to-r h-3 md:h-4 rounded-full transition-all duration-1000 ease-out"
                                style="width: {{ item.percentage }}%; background-color: {{ item.theme.primary }}; animation: slideRight 1s ease-out forwards; animation-delay: {{ forloop.counter }}00ms;">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-6 text-right text-xs text-gray-400">
                    * ëª¨ë“  ì°¸ì—¬ìì˜ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§‘ê³„ëœ ë°ì´í„°ì…ë‹ˆë‹¤.
                </div>
            </div>

            <style>
                @keyframes slideRight {
                    from {
                        transform: translateX(-100%);
                    }

                    to {
                        transform: translateX(0);
                    }
                }
            </style>
            {% endif %}
        </div>
    </div>

    <!-- Loader -->
    <div id="zoo-loader"
        class="htmx-indicator fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white/60 backdrop-blur-md">
        <div class="w-32 h-32 rounded-full shadow-clay flex items-center justify-center bg-white mb-6">
            <i class="fa-solid fa-calculator fa-bounce text-5xl text-orange-500"></i>
        </div>
        <p class="text-3xl font-title text-orange-600 animate-pulse">ê²°ê³¼ ê³„ì‚° ì¤‘...</p>
    </div>
</section>

<script>
    const questions = [
        { id: 1, title: "Q1. ì‰¬ëŠ” ì‹œê°„ì— ì•„ì´ë“¤ì´ ìš°ë¥´ë¥´ ì°¾ì•„ì˜¤ë©´?", options: ["ì•„ì´ë“¤ê³¼ ìˆ˜ë‹¤ ë–¨ë©° ì¦ê²ê²Œ ë³´ë‚¸ë‹¤", "ì¡°ê¸ˆ í˜ë“¤ì§€ë§Œ ì›ƒìœ¼ë©° ì‘ëŒ€í•˜ê³  í˜¼ì ìˆê³  ì‹¶ì–´í•œë‹¤"] },
        { id: 2, title: "Q2. ë™ë£Œ ì„ ìƒë‹˜ë“¤ê³¼ì˜ ì ì‹¬ì‹œê°„ì€?", options: ["ë‹¤í•¨ê»˜ ë¶ì ë¶ì  ì´ì•¼ê¸°ê½ƒì„ í”¼ìš°ëŠ”ê²Œ ì¢‹ë‹¤", "ì¹œí•œ ë¶„ í•œë‘ ë¶„ê³¼ ì¡°ìš©íˆ ì‹ì‚¬í•˜ëŠ”ê±¸ ì„ í˜¸í•œë‹¤"] },
        { id: 3, title: "Q3. ì„ í˜¸í•˜ëŠ” êµì‹¤ ë¶„ìœ„ê¸°ëŠ”?", options: ["ì•„ì´ë“¤ì˜ í™œê¸°ì°¬ ì›ƒìŒì†Œë¦¬ê°€ ëŠì´ì§€ ì•ŠëŠ” ë¶„ìœ„ê¸°", "ëª¨ë‘ê°€ ê°ìì˜ ì¼ì— ì§‘ì¤‘í•˜ëŠ” ì°¨ë¶„í•œ ë¶„ìœ„ê¸°"] },
        { id: 4, title: "Q4. ìˆ˜ì—… ì¤€ë¹„ë¥¼ í•  ë•Œ ê°€ì¥ ë¨¼ì € ì±™ê¸°ëŠ” ê²ƒì€?", options: ["êµê³¼ì„œ ë‚´ìš©ê³¼ ì§€ë„ì•ˆì˜ íë¦„", "ì´ë²ˆ ìˆ˜ì—…ì—ì„œ ë˜ì§ˆ í•µì‹¬ ì§ˆë¬¸ê³¼ ì˜ê°"] },
        { id: 5, title: "Q5. ì²˜ìŒ ë§¡ì€ í•™ìƒì„ íŒŒì•…í•  ë•Œ ë‚˜ëŠ”?", options: ["ìƒí™œê¸°ë¡ë¶€ì™€ ê´€ì°°ëœ í–‰ë™ ë°ì´í„°ë¥¼ ì¤‘ì‹œí•œë‹¤", "ë§ í•œë§ˆë”” ì„±ê²©ì˜ ì´ë©´ì„ ì§ê´€ì ìœ¼ë¡œ ëŠë‚€ë‹¤"] },
        { id: 6, title: "Q6. í•™ê¸‰ì— ë¬¸ì œê°€ ìƒê²¼ì„ ë•Œ í•´ê²° ë°©ì‹ì€?", options: ["ë¹„ìŠ·í•œ ê³¼ê±° ì‚¬ë¡€ë‚˜ ë§¤ë‰´ì–¼ì„ ì°¾ì•„ë³¸ë‹¤", "ìƒí™©ì— ë§ëŠ” ì°½ì˜ì ì¸ í•´ê²°ì±…ì„ ë– ì˜¬ë¦°ë‹¤"] },
        { id: 7, title: "Q7. í•™ìƒì„ ê¾¸ì¤‘í•  ë•Œ ë‚´ê°€ ë” ì‹ ê²½ ì“°ëŠ” ê²ƒì€?", options: ["ì˜ëª»ëœ ì´ìœ ë¥¼ ëª…í™•íˆ ì§šì–´ì£¼ëŠ” ê²ƒ", "í•™ìƒì´ ìƒì²˜ë°›ì§€ ì•Šê²Œ ë§ˆìŒì„ ì–´ë£¨ë§Œì§€ëŠ” ê²ƒ"] },
        { id: 8, title: "Q8. ìˆ˜í–‰í‰ê°€ ì ìˆ˜ë¥¼ ì¤„ ë•Œ ë‚˜ì˜ ê¸°ì¤€ì€?", options: ["ê²°ê³¼ë¬¼ì´ ë£¨ë¸Œë¦­(ì±„ì ê¸°ì¤€)ì— ì–¼ë§ˆë‚˜ ë¶€í•©í•˜ëŠ”ê°€", "ê³¼ì • ì†ì—ì„œ í•™ìƒì´ ì–¼ë§ˆë‚˜ ë…¸ë ¥í•˜ê³  ì„±ì¥í–ˆëŠ”ê°€"] },
        { id: 9, title: "Q9. í˜ë“¤ì–´í•˜ëŠ” ë™ë£Œ ì„ ìƒë‹˜ì„ ìœ„ë¡œí•  ë•Œ ë‚˜ëŠ”?", options: ["ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆëŠ” í˜„ì‹¤ì ì¸ ì¡°ì–¸ì„ í•´ì¤€ë‹¤", "ê·¸ ë§ˆìŒ ì¶©ë¶„íˆ ì´í•´í•œë‹¤ë©° ëê¹Œì§€ ë“¤ì–´ì¤€ë‹¤"] },
        { id: 10, title: "Q10. ë‚˜ì˜ í•˜ë£¨ ì¼ê³¼ ìŠ¤íƒ€ì¼ì€?", options: ["ê³„íšëœ ì‹œê°„í‘œëŒ€ë¡œ ì›€ì§ì—¬ì•¼ ë§ˆìŒì´ í¸í•˜ë‹¤", "ìƒí™©ì— ë”°ë¼ ìœ ì—°í•˜ê²Œ ì¼ì •ì„ ì¡°ì •í•œë‹¤"] },
        { id: 11, title: "Q11. í˜„ì¬ ë‚˜ì˜ êµë¬´ì‹¤ ì±…ìƒ ìƒíƒœëŠ”?", options: ["ì–´ë””ì— ë¬´ì—‡ì´ ìˆëŠ”ì§€ ì•Œë„ë¡ ìš©ë„ë³„ë¡œ ì •ëˆë¨", "ë‚˜ë§Œì˜ ì§ˆì„œê°€ ìˆëŠ” ììœ ë¡œìš´ ìƒíƒœ"] },
        { id: 12, title: "Q12. í˜„ì¥ì²´í—˜í•™ìŠµ ê³„íšì„ ì§¤ ë•Œ ë‚˜ëŠ”?", options: ["ë¶„ ë‹¨ìœ„ë¡œ ìƒì„¸ ë™ì„ ì„ ë¯¸ë¦¬ ê³„íší•œë‹¤", "êµµì§í•œ ì¼ì •ë§Œ ì •í•˜ê³  í˜„ì¥ ìƒí™©ì„ ì¦ê¸´ë‹¤"] }
    ];

    let currentStep = 1;
    const totalSteps = questions.length;

    function renderQuestions() {
        const container = document.getElementById('quizSteps');
        container.innerHTML = questions.map(q => `
            <div class="quiz-step ${q.id === 1 ? 'active' : ''}" id="step-${q.id}">
                <h2 class="text-3xl font-bold text-gray-700 mb-8 break-keep">${q.title}</h2>
                <div class="space-y-4">
                    ${q.options.map((opt, idx) => `
                        <button type="button" class="option-btn" onclick="selectOption(${q.id}, ${idx}, this)">
                            ${opt}
                        </button>
                    `).join('')}
                    <input type="hidden" name="q${q.id}" id="input-q${q.id}" value="">
                </div>
            </div>
        `).join('');
    }

    function selectOption(step, value, btn) {
        // Mark as selected
        const buttons = document.getElementById(`step-${step}`).querySelectorAll('.option-btn');
        buttons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');

        // Set input value
        document.getElementById(`input-q${step}`).value = value;

        // Auto move to next step after short delay
        setTimeout(() => {
            if (currentStep < totalSteps) {
                nextStep();
            } else {
                updateStepUI();
            }
        }, 300);
    }

    function updateStepUI() {
        document.querySelectorAll('.quiz-step').forEach(s => s.classList.remove('active'));
        document.getElementById(`step-${currentStep}`).classList.add('active');

        document.getElementById('stepIndicator').innerText = `${currentStep} / ${totalSteps}`;
        document.getElementById('progressBar').style.width = `${(currentStep / totalSteps) * 100}%`;

        document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);

        const submitBtn = document.getElementById('submitBtn');
        // ë§ˆì§€ë§‰ ë‹¨ê³„ì´ê³ , 12ë²ˆ ë¬¸í•­ì— ë‹µì´ ì±„ì›Œì¡Œì„ ë•Œë§Œ 'ê²°ê³¼ í™•ì¸í•˜ê¸°' ë…¸ì¶œ
        if (currentStep === totalSteps && document.getElementById(`input-q${totalSteps}`).value !== "") {
            submitBtn.classList.remove('hidden');
        } else {
            submitBtn.classList.add('hidden');
        }
    }

    function nextStep() {
        if (currentStep < totalSteps) {
            currentStep++;
            updateStepUI();
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepUI();
        }
    }

    function validateQuiz() {
        for (let i = 1; i <= totalSteps; i++) {
            if (!document.getElementById(`input-q${i}`).value) {
                alert(`ì§ˆë¬¸ ${i}ë²ˆì— ë‹µë³€í•´ì£¼ì„¸ìš”!`);
                currentStep = i;
                updateStepUI();
                return false;
            }
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', renderQuestions);

    document.body.addEventListener('htmx:afterSwap', function (evt) {
        if (evt.detail.target.id === 'zoo-result-area') {
            document.getElementById('quizForm').classList.add('hidden');
            document.getElementById('zoo-result-area').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
</script>
{% endblock %}