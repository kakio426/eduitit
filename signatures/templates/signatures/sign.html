{% extends 'base.html' %}

{% block title %}?쒕챸?섍린 - {{ session.title }}{% endblock %}

{% block extra_css %}
<style>
    .signature-pad-wrapper {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
    }

    .signature-pad {
        width: 100%;
        height: 200px;
        border-radius: 1rem;
        background: #f8f9fa;
        touch-action: none;
    }

    @media (max-width: 640px) {
        .signature-pad {
            height: 180px;
        }
    }
</style>
{% endblock %}

{% block content %}
<main class="pt-24 pb-16 px-4 min-h-screen">
    <div class="max-w-lg mx-auto">
        <!-- Session Info -->
        <div class="clay-card p-6 mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-700 mb-2">{{ session.title }}</h1>
            <div class="text-xl text-gray-500 space-y-1">
                <p><i class="fa-solid fa-user-tie mr-1"></i>{{ session.instructor }}</p>
                <p><i class="fa-solid fa-calendar mr-1"></i>{{ session.datetime|date:"Y.m.d H:i" }}</p>
                <p><i class="fa-solid fa-location-dot mr-1"></i>{{ session.location }}</p>
            </div>
        </div>

        <!-- Signature Form -->
        <form method="post" id="signForm" class="clay-card p-6">
            {% csrf_token %}

            <!-- Position/Class Input -->
            <div class="mb-6">
                <label class="block text-2xl font-bold text-gray-600 mb-3">
                    <i class="fa-solid fa-id-card mr-1"></i> 吏곸쐞/?숇뀈諛?                </label>
                {{ form.participant_affiliation }}
            </div>

            <!-- Name Input -->
            <div class="mb-6">
                <label class="block text-2xl font-bold text-gray-600 mb-3">
                    <i class="fa-solid fa-user mr-1"></i> ?대쫫
                </label>
                {{ form.participant_name }}
            </div>

            <!-- Signature Pad -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <label class="block text-2xl font-bold text-gray-600">
                        <i class="fa-solid fa-signature mr-1"></i> ?쒕챸
                    </label>
                    {% if user.is_authenticated %}
                    <button type="button" onclick="loadMySignatures()"
                        class="px-4 py-2 bg-indigo-100 text-indigo-600 rounded-xl font-bold hover:bg-indigo-200 transition">
                        <i class="fa-solid fa-folder-open mr-1"></i>???쒕챸 遺덈윭?ㅺ린
                    </button>
                    {% endif %}
                </div>
                <div class="signature-pad-wrapper">
                    <canvas id="signaturePad" class="signature-pad shadow-clay-inner"></canvas>
                    <button type="button" onclick="clearSignature()"
                        class="absolute top-2 right-2 w-10 h-10 rounded-full bg-white/80 shadow text-gray-400 hover:text-red-500 transition">
                        <i class="fa-solid fa-eraser"></i>
                    </button>
                </div>
                {{ form.signature_data }}
                <p class="text-lg text-gray-400 mt-2 text-center">??移몄뿉 ?쒕챸??二쇱꽭??/p>
            </div>

            <!-- Saved Signatures Modal -->
            <div id="signatureModal"
                class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
                <div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl relative">
                    <button type="button" onclick="closeModal()"
                        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">???쒕챸 蹂닿???/h3>
                    <div id="signatureList" class="grid grid-cols-2 gap-4 max-h-60 overflow-y-auto p-2">
                        <!-- JS Loaded -->
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <button type="submit" id="submitBtn"
                class="w-full clay-card py-4 text-2xl font-bold text-white bg-purple-500 hover:bg-purple-600 transition rounded-2xl disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fa-solid fa-paper-plane mr-2"></i>?쒕챸 ?쒖텧?섍린
            </button>
        </form>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<!-- Signature Pad Library -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script>
    // Initialize Signature Pad
    const canvas = document.getElementById('signaturePad');
    const signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(248, 249, 250)',
        penColor: 'rgb(30, 30, 30)',
    });

    // Resize canvas to fit container
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const wrapper = canvas.parentElement;
        canvas.width = wrapper.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        signaturePad.clear();
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Clear signature
    function clearSignature() {
        signaturePad.clear();
    }

    // Form submission
    document.getElementById('signForm').addEventListener('submit', function (e) {
        const nameInput = document.querySelector('input[name="participant_name"]');
        const signatureInput = document.getElementById('id_signature_data');

        // Validate name
        if (!nameInput.value.trim()) {
            e.preventDefault();
            alert('?대쫫???낅젰??二쇱꽭??');
            nameInput.focus();
            return;
        }

        // Validate signature
        if (signaturePad.isEmpty()) {
            e.preventDefault();
            alert('?쒕챸????二쇱꽭??');
            return;
        }

        // Save signature data
        signatureInput.value = signaturePad.toDataURL('image/png');
    });

    // Load Signatures
    async function loadMySignatures() {
        try {
            const response = await fetch('{% url "signatures:get_my_signatures_api" %}');
            const data = await response.json();

            const list = document.getElementById('signatureList');
            list.innerHTML = '';

            if (data.signatures && data.signatures.length > 0) {
                data.signatures.forEach(sig => {
                    const div = document.createElement('div');
                    div.className = 'border-2 border-slate-100 rounded-lg p-2 hover:border-indigo-500 cursor-pointer transition';
                    div.onclick = () => pickSignature(sig.image_data);

                    const img = document.createElement('img');
                    img.src = sig.image_data;
                    img.className = 'w-full h-auto object-contain bg-white';

                    div.appendChild(img);
                    list.appendChild(div);
                });
            } else {
                list.innerHTML = '<p class="text-gray-400 col-span-2 text-center py-4">??λ맂 ?쒕챸???놁뒿?덈떎.</p>';
            }

            document.getElementById('signatureModal').classList.remove('hidden');
            document.getElementById('signatureModal').classList.add('flex');
        } catch (e) {
            console.error(e);
            alert('?쒕챸 紐⑸줉??遺덈윭?ㅻ뒗 以??ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        }
    }

    function closeModal() {
        document.getElementById('signatureModal').classList.add('hidden');
        document.getElementById('signatureModal').classList.remove('flex');
    }

    function pickSignature(imageData) {
        signaturePad.clear();
        signaturePad.fromDataURL(imageData);
        closeModal();
    }
</script>
{% endblock %}
