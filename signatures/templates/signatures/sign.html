{% extends 'base.html' %}

{% block title %}서명하기 - {{ session.title }}{% endblock %}

{% block extra_css %}
<style>
    .signature-pad-wrapper {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
    }
    .signature-pad {
        width: 100%;
        height: 200px;
        border-radius: 1rem;
        background: #f8f9fa;
        touch-action: none;
    }
    @media (max-width: 640px) {
        .signature-pad {
            height: 180px;
        }
    }
</style>
{% endblock %}

{% block content %}
<main class="pt-24 pb-16 px-4 min-h-screen">
    <div class="max-w-lg mx-auto">
        <!-- Session Info -->
        <div class="clay-card p-6 mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-700 mb-2">{{ session.title }}</h1>
            <div class="text-xl text-gray-500 space-y-1">
                <p><i class="fa-solid fa-user-tie mr-1"></i>{{ session.instructor }}</p>
                <p><i class="fa-solid fa-calendar mr-1"></i>{{ session.datetime|date:"Y.m.d H:i" }}</p>
                <p><i class="fa-solid fa-location-dot mr-1"></i>{{ session.location }}</p>
            </div>
        </div>

        <!-- Signature Form -->
        <form method="post" id="signForm" class="clay-card p-6">
            {% csrf_token %}

            <!-- Name Input -->
            <div class="mb-6">
                <label class="block text-2xl font-bold text-gray-600 mb-3">
                    <i class="fa-solid fa-user mr-1"></i> 이름
                </label>
                {{ form.participant_name }}
            </div>

            <!-- Signature Pad -->
            <div class="mb-6">
                <label class="block text-2xl font-bold text-gray-600 mb-3">
                    <i class="fa-solid fa-signature mr-1"></i> 서명
                </label>
                <div class="signature-pad-wrapper">
                    <canvas id="signaturePad" class="signature-pad shadow-clay-inner"></canvas>
                    <button type="button" onclick="clearSignature()"
                        class="absolute top-2 right-2 w-10 h-10 rounded-full bg-white/80 shadow text-gray-400 hover:text-red-500 transition">
                        <i class="fa-solid fa-eraser"></i>
                    </button>
                </div>
                {{ form.signature_data }}
                <p class="text-lg text-gray-400 mt-2 text-center">위 칸에 서명해 주세요</p>
            </div>

            <!-- Submit -->
            <button type="submit" id="submitBtn"
                class="w-full clay-card py-4 text-2xl font-bold text-white bg-purple-500 hover:bg-purple-600 transition rounded-2xl disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fa-solid fa-paper-plane mr-2"></i>서명 제출하기
            </button>
        </form>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<!-- Signature Pad Library -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script>
    // Initialize Signature Pad
    const canvas = document.getElementById('signaturePad');
    const signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(248, 249, 250)',
        penColor: 'rgb(30, 30, 30)',
    });

    // Resize canvas to fit container
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const wrapper = canvas.parentElement;
        canvas.width = wrapper.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        signaturePad.clear();
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Clear signature
    function clearSignature() {
        signaturePad.clear();
    }

    // Form submission
    document.getElementById('signForm').addEventListener('submit', function(e) {
        const nameInput = document.querySelector('input[name="participant_name"]');
        const signatureInput = document.getElementById('id_signature_data');

        // Validate name
        if (!nameInput.value.trim()) {
            e.preventDefault();
            alert('이름을 입력해 주세요.');
            nameInput.focus();
            return;
        }

        // Validate signature
        if (signaturePad.isEmpty()) {
            e.preventDefault();
            alert('서명을 해 주세요.');
            return;
        }

        // Save signature data
        signatureInput.value = signaturePad.toDataURL('image/png');
    });
</script>
{% endblock %}
