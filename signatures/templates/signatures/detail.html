{% extends 'base.html' %}

{% block title %}{{ session.title }} - Eduitit{% endblock %}

{% block content %}
<main class="pt-28 pb-16 px-4 min-h-screen">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="mb-6">
            <a href="{% url 'signatures:list' %}" class="text-xl text-gray-500 hover:text-purple-600 transition">
                <i class="fa-solid fa-arrow-left mr-1"></i> ëª©ë¡ìœ¼ë¡œ
            </a>
        </div>

        <!-- Messages -->
        {% if messages %}
        {% for message in messages %}
        <div class="clay-card p-4 mb-6 bg-green-50 text-green-700 text-xl font-bold">
            <i class="fa-solid fa-check-circle mr-2"></i>{{ message }}
        </div>
        {% endfor %}
        {% endif %}

        <!-- Session Info Card -->
        <div class="clay-card p-8 mb-8">
            <div class="flex flex-col lg:flex-row justify-between gap-6">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-4">
                        <h1 class="text-4xl font-bold text-gray-700">{{ session.title }}</h1>
                        <button onclick="toggleActive()" id="statusBadge"
                            class="px-4 py-1 text-lg rounded-full font-bold transition cursor-pointer
                            {% if session.is_active %}bg-green-100 text-green-600 hover:bg-green-200{% else %}bg-gray-100 text-gray-500 hover:bg-gray-200{% endif %}">
                            <i class="fa-solid fa-circle text-xs mr-1"></i>
                            <span id="statusText">{% if session.is_active %}í™œì„±{% else %}ë¹„í™œì„±{% endif %}</span>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-xl text-gray-600">
                        <p><i class="fa-solid fa-user-tie mr-2 text-purple-400"></i><strong>ê°•ì‚¬:</strong> {{
                            session.instructor }}</p>
                        <p><i class="fa-solid fa-calendar mr-2 text-purple-400"></i><strong>ì¼ì‹œ:</strong> {{
                            session.datetime|date:"Yë…„ mì›” dì¼ H:i" }}</p>
                        <p><i class="fa-solid fa-location-dot mr-2 text-purple-400"></i><strong>ì¥ì†Œ:</strong> {{
                            session.location }}</p>
                        <p>
                            <i class="fa-solid fa-pen-nib mr-2 text-purple-400"></i><strong>ì„œëª…:</strong> {{
                            signatures.count }}ëª…
                            {% if has_duplicates %}<span class="text-orange-500 text-sm">(ì¤‘ë³µ ì˜ì‹¬)</span>{% endif %}
                        </p>
                    </div>
                    {% if session.description %}
                    <p class="mt-4 text-xl text-gray-500">{{ session.description }}</p>
                    {% endif %}
                </div>
                <div class="flex flex-col gap-3">
                    <a href="{% url 'signatures:edit' uuid=session.uuid %}"
                        class="px-6 py-3 text-xl font-bold text-gray-600 rounded-xl shadow-clay-inner hover:text-purple-600 transition text-center">
                        <i class="fa-solid fa-edit mr-1"></i> ìˆ˜ì •
                    </a>
                    <a href="{% url 'signatures:print' uuid=session.uuid %}"
                        class="px-6 py-3 text-xl font-bold text-gray-600 rounded-xl shadow-clay-inner hover:text-purple-600 transition text-center">
                        <i class="fa-solid fa-print mr-1"></i> ì¶œì„ë¶€ ì¶œë ¥
                    </a>
                    <a href="{% url 'signatures:delete' uuid=session.uuid %}"
                        class="px-6 py-3 text-xl font-bold text-red-400 rounded-xl shadow-clay-inner hover:text-red-600 transition text-center">
                        <i class="fa-solid fa-trash mr-1"></i> ì‚­ì œ
                    </a>
                </div>
            </div>
        </div>

        <!-- Progress Indicator -->
        {% if session.expected_count %}
        <div class="clay-card p-6 mb-8 bg-blue-50/50">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">
                <i class="fa-solid fa-chart-line text-purple-500 mr-2"></i>ì„œëª… ì§„í–‰ë¥ 
            </h2>
            <div class="flex items-center gap-6">
                <div class="flex-1">
                    <div class="flex justify-between mb-2">
                        <span class="text-xl text-gray-600">
                            {{ signatures.count }} / {{ session.expected_count }}ëª…
                        </span>
                        <span class="text-xl font-bold text-purple-600">
                            {% widthratio signatures.count session.expected_count 100 %}%
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-6">
                        <div class="bg-purple-500 h-6 rounded-full transition-all"
                            style="width: {% widthratio signatures.count session.expected_count 100 %}%">
                        </div>
                    </div>
                </div>
                {% if signatures.count < session.expected_count %} <div class="text-center">
                    <div class="text-3xl text-orange-500 mb-1">âš ï¸</div>
                    <div class="text-lg font-bold text-orange-600">
                        {{ session.expected_count|add:"-"|add:signatures.count }}ëª… ë¯¸ì„œëª…
                    </div>
            </div>
            {% elif signatures.count == session.expected_count %}
            <div class="text-center">
                <div class="text-3xl text-green-500 mb-1">âœ…</div>
                <div class="text-lg font-bold text-green-600">ì „ì› ì™„ë£Œ!</div>
            </div>
            {% else %}
            <div class="text-center">
                <div class="text-3xl text-blue-500 mb-1">ğŸ“</div>
                <div class="text-lg font-bold text-blue-600">+{{ signatures.count|add:"-"|add:session.expected_count }}ëª…
                    ì¶”ê°€</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Unmatched Signatures Warnings -->
    {% if has_unmatched %}
    <div class="clay-card p-6 mb-8 bg-orange-50/50">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">
            <i class="fa-solid fa-triangle-exclamation text-orange-500 mr-2"></i>ë¯¸ë§¤ì¹­ ì„œëª… ({{ unmatched_suggestions|length
            }}ê±´)
        </h2>
        <p class="text-gray-600 mb-4">ëª…ë‹¨ê³¼ ì—°ê²°ë˜ì§€ ì•Šì€ ì„œëª…ì…ë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì—°ê²°í•˜ê±°ë‚˜ ì‚­ì œí•´ì£¼ì„¸ìš”.</p>
        <div class="space-y-4">
            {% for item in unmatched_suggestions %}
            <div class="p-4 bg-white rounded-xl shadow-sm border-l-4 border-orange-400">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-xl font-bold text-gray-700">{{ item.signature.participant_name }}</span>
                            {% if item.signature.participant_affiliation %}
                            <span class="text-gray-500">({{ item.signature.participant_affiliation }})</span>
                            {% endif %}
                            <span class="text-sm text-gray-400">{{ item.signature.created_at|date:"H:i" }}</span>
                        </div>
                        <img src="{{ item.signature.signature_data }}" alt="ì„œëª…"
                            class="h-16 max-w-[200px] object-contain border rounded p-1">
                    </div>
                </div>
                {% if item.has_matches %}
                <div class="mb-3">
                    <p class="text-sm text-gray-600 mb-2">ğŸ’¡ ì¼ì¹˜í•˜ëŠ” ì˜ˆìƒ ì°¸ì„ì:</p>
                    <div class="flex flex-wrap gap-2">
                        {% for participant in item.exact_matches %}
                        <button onclick="matchSignature({{ item.signature.id }}, {{ participant.id }})"
                            class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-bold">
                            {{ participant.name }}{% if participant.affiliation %} ({{ participant.affiliation }}){%
                            endif %}ì™€ ì—°ê²°
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                <div class="flex gap-2">
                    <button onclick="deleteSignature('{{ item.signature.pk }}')"
                        class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition text-sm font-bold">
                        <i class="fa-solid fa-trash mr-1"></i> ì„œëª… ì‚­ì œ
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Duplicate Signatures Warnings -->
    {% if has_duplicates %}
    <div class="clay-card p-6 mb-8 bg-yellow-50/50">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">
            <i class="fa-solid fa-copy text-yellow-600 mr-2"></i>ì¤‘ë³µ ì„œëª… ê°ì§€ ({{ duplicates|length }}ê±´)
        </h2>
        <div class="space-y-4">
            {% for dup_group in duplicates %}
            <div class="p-4 bg-white rounded-xl shadow-sm border-l-4 border-yellow-400">
                <p class="font-bold text-gray-700 mb-3">
                    {{ dup_group.0.participant_name }} ({{ dup_group.0.participant_affiliation|default:"-" }}) - {{
                    dup_group|length }}ë²ˆ ì„œëª…
                </p>
                <div class="grid md:grid-cols-2 gap-3">
                    {% for sig in dup_group %}
                    <div class="p-3 bg-gray-50 rounded-lg flex items-center justify-between">
                        <div>
                            <img src="{{ sig.signature_data }}" alt="ì„œëª…" class="h-12 max-w-[150px] object-contain mb-1">
                            <p class="text-sm text-gray-500">{{ sig.created_at|date:"H:i:s" }}</p>
                        </div>
                        <button onclick="deleteSignature('{{ sig.pk }}')"
                            class="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 transition text-sm">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Expected Participants Management -->
    <div class="clay-card p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">
            <i class="fa-solid fa-users text-purple-500 mr-2"></i>ì˜ˆìƒ ì°¸ì„ì ëª…ë‹¨ ê´€ë¦¬
        </h2>
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Inputs -->
            <div>
                <div class="mb-6">
                    <label class="text-lg font-bold mb-2 block">í…ìŠ¤íŠ¸ë¡œ ì…ë ¥</label>
                    <textarea id="bulkInput" rows="5" placeholder="ì´ë¦„, ì†Œì† (í•œ ì¤„ì— í•œ ëª…)"
                        class="w-full p-4 rounded-xl shadow-clay-inner bg-bg-soft focus:outline-none focus:ring-2 focus:ring-purple-300 resize-none"></textarea>
                    <button onclick="submitBulkInput()"
                        class="mt-3 px-6 py-3 bg-purple-500 text-white rounded-xl font-bold hover:bg-purple-600 transition">
                        <i class="fa-solid fa-plus mr-1"></i> ëª…ë‹¨ ë“±ë¡
                    </button>
                </div>
                <div class="pt-6 border-t border-gray-100">
                    <label class="text-lg font-bold mb-2 block">íŒŒì¼ë¡œ ì—…ë¡œë“œ (.csv, .xlsx)</label>
                    <div class="flex gap-2">
                        <input type="file" id="participantFile" accept=".csv, .xlsx"
                            class="flex-1 px-4 py-2 rounded-xl shadow-clay-inner bg-bg-soft text-sm">
                        <button onclick="uploadFile()"
                            class="px-6 py-2 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition">
                            <i class="fa-solid fa-upload mr-1"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">ì²« ë²ˆì§¸ ì—´: ì´ë¦„, ë‘ ë²ˆì§¸ ì—´: ì†Œì†</p>
                </div>
            </div>
            <!-- List -->
            <div>
                <label class="text-lg font-bold mb-2 block">ë“±ë¡ëœ ëª…ë‹¨ (<span id="participantCount">0</span>ëª…)</label>
                <div id="participantList" class="h-80 overflow-y-auto p-4 rounded-xl shadow-clay-inner bg-bg-soft">
                    <p class="text-gray-400 text-center py-8">ëª…ë‹¨ì„ ë“±ë¡í•´ì£¼ì„¸ìš”</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Link -->
    <div class="clay-card p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-700 mb-3">
            <i class="fa-solid fa-share-nodes text-purple-500 mr-2"></i>ì„œëª… ë§í¬ ê³µìœ 
        </h2>
        <div class="flex gap-3">
            <input type="text" id="shareLink" readonly
                value="{{ request.scheme }}://{{ request.get_host }}{% url 'signatures:sign' uuid=session.uuid %}"
                class="flex-1 px-4 py-3 rounded-xl shadow-clay-inner bg-bg-soft text-xl text-gray-600">
            <button onclick="copyLink()"
                class="px-6 py-3 clay-card text-xl font-bold text-purple-600 hover:shadow-clay-hover transition">
                <i class="fa-solid fa-copy mr-1"></i> ë³µì‚¬
            </button>
        </div>
    </div>

    <!-- Signature List -->
    <div class="clay-card p-6">
        <h2 class="text-3xl font-bold text-gray-700 mb-6">
            <i class="fa-solid fa-list-check text-purple-500 mr-2"></i>ì„œëª… ëª©ë¡ ({{ signatures.count }}ëª…)
        </h2>
        {% if signatures %}
        <div class="overflow-x-auto">
            <table class="w-full text-xl text-left">
                <thead class="border-b-2 border-gray-200 text-gray-500">
                    <tr>
                        <th class="py-3 px-4">ë²ˆí˜¸</th>
                        <th class="py-3 px-4">ì´ë¦„</th>
                        <th class="py-3 px-4">ì„œëª…</th>
                        <th class="py-3 px-4">ì‹œê°„</th>
                        <th class="py-3 px-4 text-center">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sig in signatures %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50" id="row-{{ sig.pk }}">
                        <td class="py-3 px-4 text-gray-600">{{ forloop.counter }}</td>
                        <td class="py-3 px-4 font-bold text-gray-700">{{ sig.participant_name }}</td>
                        <td class="py-3 px-4"><img src="{{ sig.signature_data }}" alt="ì„œëª…" class="h-10"></td>
                        <td class="py-3 px-4 text-gray-500">{{ sig.created_at|date:"H:i:s" }}</td>
                        <td class="py-3 px-4 text-center">
                            <button onclick="deleteSignature('{{ sig.pk }}')" class="text-red-400 hover:text-red-600">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center py-12 text-gray-400 text-2xl">ì•„ì§ ì„œëª…ì´ ì—†ìŠµë‹ˆë‹¤</p>
        {% endif %}
    </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    const sessionUuid = '{{ session.uuid }}';

    function copyLink() {
        const input = document.getElementById('shareLink');
        input.select();
        navigator.clipboard.writeText(input.value);
        alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function toggleActive() {
        fetch(`/signatures/${sessionUuid}/toggle/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        }).then(res => res.json()).then(data => {
            const badge = document.getElementById('statusBadge');
            const text = document.getElementById('statusText');
            if (data.is_active) {
                badge.className = 'px-4 py-1 text-lg rounded-full font-bold transition cursor-pointer bg-green-100 text-green-600 hover:bg-green-200';
                text.textContent = 'í™œì„±';
            } else {
                badge.className = 'px-4 py-1 text-lg rounded-full font-bold transition cursor-pointer bg-gray-100 text-gray-500 hover:bg-gray-200';
                text.textContent = 'ë¹„í™œì„±';
            }
        });
    }

    function deleteSignature(pk) {
        if (!confirm('ì´ ì„œëª…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        fetch(`/signatures/signature/${pk}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        }).then(res => res.json()).then(data => {
            if (data.success) location.reload();
        });
    }

    function submitBulkInput() {
        const input = document.getElementById('bulkInput');
        if (!input.value.trim()) return alert('ëª…ë‹¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        fetch(`/signatures/${sessionUuid}/participants/add/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ participants: input.value.trim() })
        }).then(res => res.json()).then(data => {
            if (data.success) { alert(data.message); input.value = ''; loadParticipants(); location.reload(); }
        });
    }

    function uploadFile() {
        const fileInput = document.getElementById('participantFile');
        if (!fileInput.files[0]) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        fetch(`/signatures/${sessionUuid}/participants/upload/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        }).then(res => res.json()).then(data => {
            if (data.success) { alert(data.message); loadParticipants(); location.reload(); }
            else alert('ì˜¤ë¥˜: ' + data.error);
        });
    }

    function loadParticipants() {
        fetch(`/signatures/${sessionUuid}/participants/`).then(res => res.json()).then(data => {
            const list = document.getElementById('participantList');
            document.getElementById('participantCount').textContent = data.participants.length;
            if (data.participants.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center py-8">ëª…ë‹¨ì„ ë“±ë¡í•´ì£¼ì„¸ìš”</p>';
                return;
            }
            let html = '<div class="space-y-2">';
            data.participants.forEach(p => {
                html += `
                <div class="flex items-center justify-between p-2 rounded hover:bg-white/50 transition">
                    <div class="flex items-center gap-2">
                        ${p.has_signed ? '<span class="text-green-600">âœ…</span>' : '<span class="text-orange-400">â³</span>'}
                        <span class="font-bold text-gray-700">${p.name}</span>
                        <span class="text-gray-400 text-sm">${p.affiliation || ''}</span>
                    </div>
                    <button onclick="deleteParticipant(${p.id})" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash text-sm"></i></button>
                </div>`;
            });
            list.innerHTML = html + '</div>';
        });
    }

    function deleteParticipant(id) {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        fetch(`/signatures/${sessionUuid}/participants/${id}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        }).then(res => res.json()).then(data => { if (data.success) loadParticipants(); });
    }

    function matchSignature(sigId, partId) {
        if (!confirm('ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        fetch(`/signatures/${sessionUuid}/signatures/${sigId}/match/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ participant_id: partId })
        }).then(res => res.json()).then(data => {
            if (data.success) location.reload();
            else alert('ì˜¤ë¥˜: ' + data.error);
        });
    }

    document.addEventListener('DOMContentLoaded', loadParticipants);
</script>
{% endblock %}