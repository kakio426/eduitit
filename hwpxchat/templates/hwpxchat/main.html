{% extends 'base.html' %}
{% load static %}

{% block title %}í•œê¸€ë¬¸ì„œ AIì•¼ ì½ì–´ì¤˜{% endblock %}

{% block content %}
<style>
    #hwpx-chat-loading {
        display: none;
        pointer-events: none;
    }

    #hwpx-chat-loading.htmx-request {
        display: flex;
        pointer-events: auto;
    }
</style>

<section class="pt-32 pb-20 px-4 md:px-6 min-h-screen bg-[#E0E5EC]" x-data="hwpxChatPage()">
    <div class="max-w-5xl mx-auto">
        <div class="mb-6 flex items-center justify-between gap-3 flex-wrap">
            <a href="{% url 'home' %}" class="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 transition-colors">
                <i class="fa-solid fa-arrow-left"></i>
                <span class="font-medium">ì„œë¹„ìŠ¤ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
            </a>

            <form
                hx-post="{% url 'hwpxchat:chat_reset' %}"
                hx-target="#hwpx-chat-result"
                hx-swap="innerHTML"
                hx-indicator="#hwpx-chat-loading"
                class="inline-flex"
            >
                {% csrf_token %}
                <button type="submit" class="px-3 py-2 bg-white text-gray-600 rounded-xl text-sm font-bold border border-gray-200 hover:bg-gray-50 transition">
                    ëŒ€í™” ì´ˆê¸°í™”
                </button>
            </form>
        </div>

        <div class="text-center mb-8" data-aos="fade-up">
            <div class="text-6xl mb-3 float-icon">{{ service.icon|default:"ğŸ“„" }}</div>
            <h1 class="text-4xl md:text-5xl font-bold text-gray-700 font-title mb-3">í•œê¸€ë¬¸ì„œ AIì•¼ ì½ì–´ì¤˜</h1>
            <p class="text-lg md:text-xl text-gray-500">í•œê¸€(HWPX) ë¬¸ì„œë¥¼ ì½ê³  AIì™€ ë°”ë¡œ ëŒ€í™”í•´ìš”.</p>
        </div>

        <div class="clay-card p-6 md:p-8 mb-6" data-aos="fade-up">
            <p class="text-sm md:text-base text-amber-700 bg-amber-50 border border-amber-200 rounded-xl p-4 mb-5 leading-relaxed">
                AIê°€ ë¬¸ì„œë¥¼ ì™„ë²½í•˜ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡, í•œê¸€ íŒŒì¼ì€ <strong>'ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥ â¡ï¸ HWPX'</strong>ë¡œ ë³€í™˜ í›„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.
            </p>

            <form
                hx-post="{% url 'hwpxchat:chat_process' %}"
                hx-target="#hwpx-chat-result"
                hx-swap="innerHTML"
                hx-indicator="#hwpx-chat-loading"
                enctype="multipart/form-data"
                class="space-y-4"
            >
                {% csrf_token %}

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-gray-600 mb-1">í•œê¸€ íŒŒì¼(HWPX) ì—…ë¡œë“œ</label>
                        <input
                            type="file"
                            name="hwpx_file"
                            accept=".hwpx,.hwp"
                            @change="validateHwpxFile($event)"
                            class="w-full px-3 py-2.5 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none bg-white"
                        >
                        <p class="text-xs text-gray-500 mt-1">
                            ë¬¸ì„œë¥¼ ë°”ê¾¸ì§€ ì•Šì„ ë•ŒëŠ” íŒŒì¼ì„ ë‹¤ì‹œ ì˜¬ë¦¬ì§€ ì•Šê³  ì§ˆë¬¸ë§Œ ì´ì–´ì„œ ì…ë ¥í•´ë„ ë©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">AI Provider</label>
                        <select
                            name="provider"
                            class="w-full px-3 py-2.5 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none bg-white"
                        >
                            <option value="gemini" {% if selected_provider == 'gemini' %}selected{% endif %}>Gemini</option>
                            <option value="claude" {% if selected_provider == 'claude' %}selected{% endif %}>Claude</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-1">ì§ˆë¬¸</label>
                    <textarea
                        name="question"
                        rows="4"
                        required
                        class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-emerald-500 focus:outline-none bg-white"
                        placeholder="ë¬¸ì„œì—ì„œ í™•ì¸í•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ì§ˆë¬¸í•´ ì£¼ì„¸ìš”."
                    ></textarea>
                </div>

                <button type="submit" class="w-full py-3.5 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-bold text-base shadow-lg hover:shadow-xl transition">
                    <i class="fa-solid fa-paper-plane mr-1"></i>ë¬¸ì„œ ê¸°ë°˜ìœ¼ë¡œ AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°
                </button>
            </form>
        </div>

        <div id="hwpx-chat-result">
            {% include 'hwpxchat/partials/chat_result.html' %}
        </div>
    </div>
</section>

<div id="hwpx-chat-loading" class="htmx-indicator fixed inset-0 z-[120] flex items-center justify-center bg-white/55 backdrop-blur-sm">
    <div class="clay-card px-6 py-5 flex items-center gap-3">
        <i class="fa-solid fa-circle-notch fa-spin text-2xl text-emerald-500"></i>
        <span class="text-gray-700 font-bold">ë¬¸ì„œë¥¼ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function hwpxChatPage() {
        return {
            validateHwpxFile(event) {
                const input = event.target;
                if (!input || !input.files || input.files.length === 0) {
                    return;
                }

                const file = input.files[0];
                const name = (file.name || '').toLowerCase();
                if (name.endsWith('.hwp')) {
                    input.value = '';
                    Swal.fire({
                        icon: 'warning',
                        title: 'HWP íŒŒì¼ì€ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                        html: "ë¬¸ì„œë¥¼ <b>ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥ â¡ï¸ HWPX</b>ë¡œ ë³€í™˜í•œ ë’¤ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.",
                        confirmButtonText: 'í™•ì¸',
                        confirmButtonColor: '#10b981'
                    });
                }
            }
        };
    }
</script>
{% endblock %}
