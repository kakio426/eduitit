{% extends "base.html" %}
{% load static %}

{% block title %}별빛 추첨기 | EDUITIT{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'ppobgi/css/ppobgi.css' %}">
{% endblock %}

{% block content %}
<main
    id="ppobgi-app"
    class="ppb-root"
    data-default-names="{{ default_names|escapejs }}"
    data-roster-url="{% url 'ppobgi:roster_names' %}"
    {% if active_classroom %}data-classroom-url="{% url 'ppobgi:classroom_students' active_classroom.pk %}" data-classroom-name="{{ active_classroom.name|escapejs }}"{% endif %}
>
    <div class="ppb-bg-gradient" aria-hidden="true"></div>
    <div id="ppb-stars" class="ppb-stars" aria-hidden="true"></div>
    <div id="ppb-flash" class="ppb-flash" aria-hidden="true"></div>

    <header class="ppb-topbar">
        <div class="ppb-top-main">
            <div class="ppb-brand">
                <span class="ppb-brand-icon">✨</span>
                <div>
                    <h1>별빛 추첨기</h1>
                    <p>교실용 멀티 추첨 스테이션</p>
                </div>
            </div>
            <div class="ppb-top-controls">
                <label class="ppb-toggle">
                    <input id="ppb-reduce-motion" type="checkbox">
                    <span>애니메이션 줄이기</span>
                </label>
                <button id="ppb-fullscreen-btn" type="button" class="ppb-ghost-btn">전체화면</button>
            </div>
        </div>
        <div class="ppb-mode-tabs" role="tablist" aria-label="뽑기 모드 선택">
            <button
                id="ppb-mode-stars-btn"
                type="button"
                class="ppb-mode-tab is-active"
                data-mode="stars"
                role="tab"
                aria-selected="true"
            >
                별빛 추첨기
            </button>
            <button
                id="ppb-mode-ladder-btn"
                type="button"
                class="ppb-mode-tab"
                data-mode="ladder"
                role="tab"
                aria-selected="false"
            >
                사다리 뽑기
            </button>
        </div>
    </header>

    <div id="ppb-mode-stars" class="ppb-mode-view">
        <section id="ppb-setup" class="ppb-screen">
            <div class="ppb-setup-shell">
                <article class="ppb-panel ppb-panel-info">
                    <h2>추첨 준비</h2>
                    <p class="ppb-muted">
                        줄바꿈으로 이름을 넣고 추첨을 시작하세요.
                        기본은 비복원 추첨이라 한 번 뽑힌 학생은 자동 제외됩니다.
                    </p>

                    <div class="ppb-btn-row">
                        <button id="ppb-load-sample-btn" type="button" class="ppb-soft-btn">예시 명단 불러오기</button>
                        <button id="ppb-load-roster-btn" type="button" class="ppb-soft-btn">당번 명단 불러오기</button>
                        <button id="ppb-clear-input-btn" type="button" class="ppb-soft-btn">입력 비우기</button>
                    </div>

                    <div class="ppb-stats-grid">
                        <div class="ppb-stat-card">
                            <span class="ppb-stat-label">유효 인원</span>
                            <strong id="ppb-stat-valid">0</strong>
                        </div>
                        <div class="ppb-stat-card">
                            <span class="ppb-stat-label">중복 제외</span>
                            <strong id="ppb-stat-dup">0</strong>
                        </div>
                        <div class="ppb-stat-card">
                            <span class="ppb-stat-label">최대 40명 초과</span>
                            <strong id="ppb-stat-cut">0</strong>
                        </div>
                    </div>

                    <div id="ppb-setup-message" class="ppb-message" aria-live="polite"></div>

                    <button id="ppb-start-btn" type="button" class="ppb-primary-btn">
                        추첨 우주 시작
                    </button>
                </article>

                <article class="ppb-panel ppb-panel-input">
                    <label for="ppb-name-input">학생 이름 명단</label>
                    <textarea
                        id="ppb-name-input"
                        class="ppb-textarea"
                        placeholder="예)&#10;김별빛&#10;이은하&#10;박우주"
                    ></textarea>
                    <p class="ppb-input-hint">한 줄에 한 명, 최대 40명까지 진행됩니다.</p>
                </article>
            </div>
        </section>

        <section id="ppb-universe" class="ppb-screen is-hidden">
            <div class="ppb-universe-shell">
                <div class="ppb-universe-main">
                    <div class="ppb-chip-row">
                        <span class="ppb-chip">총 <strong id="ppb-chip-total">0</strong>명</span>
                        <span class="ppb-chip">남은 <strong id="ppb-chip-left">0</strong>명</span>
                        <span class="ppb-chip">추첨 <strong id="ppb-chip-round">0</strong>회</span>
                    </div>
                    <h2 class="ppb-universe-title">빛나는 별 하나를 선택하세요</h2>
                    <div id="ppb-orb-grid" class="ppb-orb-grid"></div>
                    <div class="ppb-bottom-actions">
                        <button id="ppb-reset-from-universe-btn" type="button" class="ppb-ghost-btn">처음으로 돌아가기</button>
                    </div>
                </div>
                <aside class="ppb-history-panel">
                    <h3>추첨 기록</h3>
                    <ol id="ppb-history-list-universe" class="ppb-history-list"></ol>
                </aside>
            </div>
        </section>

        <section id="ppb-reveal" class="ppb-screen is-hidden">
            <div class="ppb-reveal-bg" aria-hidden="true"></div>
            <div id="ppb-particles" class="ppb-particles" aria-hidden="true"></div>

            <div class="ppb-reveal-shell">
                <p class="ppb-reveal-label">이번에 선택된 학생</p>
                <div class="ppb-selected-wrap">
                    <div class="ppb-selected-glow" aria-hidden="true"></div>
                    <h2 id="ppb-selected-name" class="ppb-selected-name"></h2>
                </div>
                <p class="ppb-reveal-meta">
                    남은 인원 <strong id="ppb-reveal-left">0</strong>명 /
                    누적 추첨 <strong id="ppb-reveal-round">0</strong>회
                </p>

                <div class="ppb-reveal-actions">
                    <button id="ppb-next-draw-btn" type="button" class="ppb-primary-btn">다음 추첨</button>
                    <button id="ppb-reset-btn" type="button" class="ppb-ghost-btn">새 명단으로 다시 시작</button>
                </div>

                <div class="ppb-history-inline">
                    <h3>최근 추첨 기록</h3>
                    <ol id="ppb-history-list-reveal" class="ppb-history-list"></ol>
                </div>
            </div>
        </section>
    </div>

    <div id="ppb-mode-ladder" class="ppb-mode-view is-hidden">
        <section id="pbl-setup" class="ppb-screen">
            <div class="pbl-setup-shell">
                <article class="ppb-panel ppb-panel-info">
                    <h2>사다리 뽑기 준비</h2>
                    <p class="ppb-muted">
                        사다리를 생성한 뒤 참가자 이름을 클릭하면 경로를 따라 결과가 공개됩니다.
                        역할 배정 모드에서는 자동 쇼로 1명씩 화려하게 발표할 수 있습니다.
                    </p>

                    <div class="ppb-btn-row">
                        <button id="pbl-load-sample-btn" type="button" class="ppb-soft-btn">예시 명단 불러오기</button>
                        <button id="pbl-load-roster-btn" type="button" class="ppb-soft-btn">당번 명단 불러오기</button>
                        <button id="pbl-clear-input-btn" type="button" class="ppb-soft-btn">입력 비우기</button>
                    </div>

                    <fieldset class="pbl-role-switch">
                        <legend>사다리 방식</legend>
                        <label class="pbl-radio">
                            <input type="radio" name="pbl-mode" value="single" checked>
                            <span>단일 당첨 (당첨 1명)</span>
                        </label>
                        <label class="pbl-radio">
                            <input type="radio" name="pbl-mode" value="roles">
                            <span>역할 배정 (역할별 1명 발표)</span>
                        </label>
                    </fieldset>

                    <div class="ppb-stats-grid">
                        <div class="ppb-stat-card">
                            <span class="ppb-stat-label">유효 인원</span>
                            <strong id="pbl-stat-valid">0</strong>
                        </div>
                        <div class="ppb-stat-card">
                            <span class="ppb-stat-label">역할 개수</span>
                            <strong id="pbl-stat-roles">0</strong>
                        </div>
                        <div class="ppb-stat-card">
                            <span class="ppb-stat-label">예정 발표 수</span>
                            <strong id="pbl-stat-plan">0</strong>
                        </div>
                    </div>

                    <div id="pbl-setup-message" class="ppb-message" aria-live="polite"></div>

                    <button id="pbl-start-btn" type="button" class="ppb-primary-btn">
                        사다리 생성하기
                    </button>
                </article>

                <article class="ppb-panel ppb-panel-input">
                    <label for="pbl-name-input">참가자 이름 명단</label>
                    <textarea
                        id="pbl-name-input"
                        class="ppb-textarea pbl-textarea-names"
                        placeholder="예)&#10;김별빛&#10;이은하&#10;박우주"
                    ></textarea>
                    <p class="ppb-input-hint">한 줄에 한 명, 최대 24명까지 권장됩니다.</p>

                    <div id="pbl-role-wrap" class="pbl-role-wrap">
                        <label for="pbl-role-input">배정할 역할 목록 (역할 배정 모드)</label>
                        <textarea
                            id="pbl-role-input"
                            class="ppb-textarea pbl-textarea-roles"
                            placeholder="예)&#10;발표자&#10;칠판 정리&#10;자료 배부"
                        ></textarea>
                        <p class="ppb-input-hint">역할이 인원보다 적으면 남은 칸은 '대기'로 채워집니다.</p>
                    </div>
                </article>
            </div>
        </section>

        <section id="pbl-stage" class="ppb-screen is-hidden">
            <div class="pbl-stage-shell">
                <div class="pbl-stage-main">
                    <div class="ppb-chip-row">
                        <span class="ppb-chip">총 <strong id="pbl-chip-total">0</strong>명</span>
                        <span class="ppb-chip">발표 완료 <strong id="pbl-chip-revealed">0</strong>명</span>
                        <span class="ppb-chip">남은 <strong id="pbl-chip-left">0</strong>명</span>
                    </div>

                    <h2 id="pbl-stage-title" class="ppb-universe-title pbl-stage-title">참가자를 선택해 사다리를 타세요</h2>
                    <p class="pbl-stage-guide">상단 이름을 누르면 네온 경로를 따라 결과가 공개됩니다.</p>

                    <div class="pbl-board-wrap">
                        <div id="pbl-top-row" class="pbl-top-row"></div>
                        <div class="pbl-svg-wrap">
                            <svg id="pbl-svg" class="pbl-svg" viewBox="0 0 1200 680" preserveAspectRatio="none" aria-label="사다리 경로"></svg>
                        </div>
                        <div id="pbl-bottom-row" class="pbl-bottom-row"></div>
                    </div>

                    <div id="pbl-stage-message" class="ppb-message pbl-stage-message" aria-live="polite"></div>

                    <div class="ppb-bottom-actions pbl-bottom-actions">
                        <button id="pbl-auto-btn" type="button" class="ppb-soft-btn">역할 발표 쇼 시작</button>
                        <button id="pbl-reroll-btn" type="button" class="ppb-soft-btn">사다리 다시 생성</button>
                        <button id="pbl-reset-btn" type="button" class="ppb-ghost-btn">준비 화면으로</button>
                    </div>
                </div>

                <aside class="pbl-side-panel">
                    <div class="pbl-live-card">
                        <p class="pbl-live-label">지금 발표</p>
                        <h3 id="pbl-live-name" class="pbl-live-name">준비 완료</h3>
                        <p id="pbl-live-role" class="pbl-live-role">사다리 결과가 여기 표시됩니다.</p>
                        <div id="pbl-live-sparks" class="pbl-live-sparks" aria-hidden="true"></div>
                    </div>

                    <div class="pbl-history-box">
                        <h3>역할 발표 기록</h3>
                        <ol id="pbl-reveal-list" class="pbl-reveal-list"></ol>
                    </div>
                </aside>
            </div>
        </section>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'ppobgi/js/ppobgi.js' %}"></script>
{% if active_classroom %}
<script>
(function() {
    var root = document.getElementById('ppobgi-app');
    if (!root) return;
    var classroomUrl = root.dataset.classroomUrl;
    var classroomName = root.dataset.classroomName;
    if (!classroomUrl) return;
    // 세션 학급이 설정된 경우 자동으로 학생 명단 로드
    var textarea = document.getElementById('ppb-name-input');
    var laderTextarea = document.getElementById('pbl-name-input');
    var msgEl = document.getElementById('ppb-setup-message');
    if (!textarea) return;
    fetch(classroomUrl, {credentials: 'same-origin'})
        .then(function(r) { return r.json(); })
        .then(function(d) {
            var names = Array.isArray(d.names) ? d.names : [];
            if (!names.length) return;
            textarea.value = names.join('\n');
            if (laderTextarea) laderTextarea.value = names.join('\n');
            textarea.dispatchEvent(new Event('input'));
            if (laderTextarea) laderTextarea.dispatchEvent(new Event('input'));
            if (msgEl) {
                msgEl.textContent = '현재 학급 [' + classroomName + '] 명단 ' + names.length + '명이 자동으로 불러와졌습니다.';
                msgEl.className = 'ppb-message ppb-message--info';
            }
        })
        .catch(function() {});
})();
</script>
{% endif %}
{% endblock %}
