{% extends 'base.html' %}

{% block content %}
<section id="PAGE_LIVE" class="pt-32 pb-20 px-4 min-h-screen">
    <div class="max-w-4xl mx-auto">

        <div class="mb-8">
            <a href="{% url 'happy_seed:classroom_detail' classroom_id=classroom.id %}" class="text-sm text-gray-400 hover:text-gray-600">&larr; {{ classroom.name }}</a>
        </div>

        <h1 class="text-2xl font-bold text-gray-800 mb-2">ğŸŒ¸ ê½ƒí”¼ì›€ ì¶”ì²¨</h1>
        <p class="text-sm text-gray-500 mb-6 break-keep">êµì‚¬ìš© ë¼ì´ë¸Œ íŒ¨ë„ì…ë‹ˆë‹¤. ë””ìŠ¤í”Œë ˆì´ í™”ë©´ì€ ë³„ë„ ì°½ìœ¼ë¡œ ì—¬ì„¸ìš”.</p>

        <div class="flex gap-2 mb-6">
            <a href="{% url 'happy_seed:garden_public' slug=classroom.slug %}" target="_blank" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl text-sm font-bold hover:bg-gray-200 transition-colors">
                ê½ƒë°­ í™”ë©´ ì—´ê¸°(ë””ìŠ¤í”Œë ˆì´)
            </a>
            <a href="{% url 'happy_seed:analysis_dashboard' classroom_id=classroom.id %}" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl text-sm font-bold hover:bg-gray-200 transition-colors">
                ë¶„ì„ ë³´ê¸°
            </a>
        </div>

        <div class="clay-card p-5 rounded-2xl mb-6">
            <h2 class="font-bold text-gray-800 mb-3">ğŸ‘¥ ëª¨ë‘  ë¯¸ì…˜ ì„±ê³µ ì²˜ë¦¬</h2>
            {% if group_infos %}
            <form method="post" action="{% url 'happy_seed:group_mission_success' classroom_id=classroom.id %}" class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
                {% csrf_token %}
                <div class="md:col-span-2">
                    <label class="text-xs text-gray-500 mb-1 block">ëª¨ë‘  ì„ íƒ</label>
                    <select name="group_id" class="w-full px-3 py-2 rounded-xl border border-gray-200">
                        {% for item in group_infos %}
                        <option value="{{ item.group.id }}">{{ item.group.name }} (ê°€ëŠ¥ {{ item.eligible_count }} / ì „ì²´ {{ item.member_count }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-500 mb-1 block">ëœë¤ ì§€ê¸‰ ì¸ì›</label>
                    <select name="draw_count" class="w-full px-3 py-2 rounded-xl border border-gray-200">
                        <option value="1" {% if default_group_draw_count == 1 %}selected{% endif %}>1ëª…</option>
                        <option value="2" {% if default_group_draw_count == 2 %}selected{% endif %}>2ëª…</option>
                    </select>
                </div>
                <div>
                    <button id="BTN_GROUP_MISSION_SUCCESS" type="submit" class="w-full py-2.5 bg-indigo-500 text-white rounded-xl text-sm font-bold hover:bg-indigo-600">
                        ëª¨ë‘  ë¯¸ì…˜ ì„±ê³µ ì²˜ë¦¬
                    </button>
                </div>
            </form>
            <p class="text-xs text-gray-500 mt-2">ë™ì˜ ì™„ë£Œ + í™œì„± í•™ìƒ ê¸°ì¤€ìœ¼ë¡œ ëª¨ë‘  ë‚´ ëœë¤ 1~2ëª…ì—ê²Œ í‹°ì¼“ +1 ì§€ê¸‰í•©ë‹ˆë‹¤.</p>
            {% else %}
            <p class="text-sm text-gray-500">ë“±ë¡ëœ ëª¨ë‘ ì´ ì—†ìŠµë‹ˆë‹¤. (ëª¨ë‘ ì€ ê´€ë¦¬ì ë˜ëŠ” ì¶”í›„ ëª¨ë‘  ê´€ë¦¬ í™”ë©´ì—ì„œ êµ¬ì„±)</p>
            {% endif %}
        </div>

        {% if not has_rewards %}
        <div class="mb-6 p-4 bg-amber-50 text-amber-700 rounded-xl text-sm break-keep">
            ë³´ìƒì„ 1ê°œ ì´ìƒ/ì¬ê³ ë¥¼ í™•ë³´í•´ì•¼ ê½ƒí”¼ì›€ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            <a href="{% url 'happy_seed:prize_manage' classroom_id=classroom.id %}" class="underline font-bold ml-1">ë³´ìƒ ê´€ë¦¬ë¡œ ì´ë™</a>
        </div>
        {% endif %}

        {% if last_draw %}
        <div class="clay-card p-5 rounded-2xl mb-6">
            <h2 class="font-bold text-gray-800 mb-3">ìµœê·¼ ì‹¤í–‰ ê²°ê³¼</h2>
            <div class="text-sm text-gray-600 space-y-1">
                <p>ëŒ€ìƒ í•™ìƒ: <span class="font-bold text-gray-800">{{ last_draw.student.name }}</span></p>
                <p>
                    ê²°ê³¼:
                    {% if last_draw.is_win %}
                    <span class="font-bold text-pink-700">WIN</span>
                    {% else %}
                    <span class="font-bold text-green-700">LOSE</span>
                    {% endif %}
                </p>
                {% if last_draw.is_win and last_draw.prize %}
                <p>ë³´ìƒ: <span class="font-bold text-gray-800">{{ last_draw.prize.name }}</span></p>
                {% elif not last_draw.is_win %}
                <p>ë¯¸ë‹¹ì²¨ ì²˜ë¦¬: ì”¨ì•— +1 ìë™ ì ë¦½</p>
                {% endif %}
            </div>
            <div class="flex flex-wrap gap-2 mt-4">
                <a href="{% url 'happy_seed:celebration' draw_id=last_draw.id %}?token={{ last_draw_token }}" target="_blank" class="px-4 py-2 bg-pink-500 text-white rounded-xl text-sm font-bold hover:bg-pink-600">
                    ë””ìŠ¤í”Œë ˆì´ ì¶•í•˜ ì—´ê¸°
                </a>
                <form method="post" action="{% url 'happy_seed:close_celebration' draw_id=last_draw.id %}">
                    {% csrf_token %}
                    <button type="submit" class="px-4 py-2 bg-gray-800 text-white rounded-xl text-sm font-bold hover:bg-gray-900">
                        ë‹¤ìŒ
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        {% if students %}
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            {% for student in students %}
            <div class="clay-card p-5 rounded-2xl text-center" x-data="{ confirming: false }">
                <div class="text-3xl mb-2">ğŸŒ¸</div>
                <div class="font-bold text-gray-800 text-lg">{{ student.name }}</div>
                <div class="text-sm text-gray-500 mt-1">{{ student.number }}ë²ˆ</div>
                <div class="flex items-center justify-center gap-2 mt-2">
                    <span class="text-xs px-2 py-1 bg-pink-100 text-pink-700 rounded-full">í‹°ì¼“ {{ student.ticket_count }}ì¥</span>
                    <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">ì”¨ì•— {{ student.seed_count }}ê°œ</span>
                </div>

                <div x-show="!confirming" class="mt-4">
                    <button id="BTN_EXECUTE_DRAW_NEXT__{{ student.id }}" @click="confirming = true"
                            {% if not has_rewards or student.consent.status != 'approved' %}disabled{% endif %}
                            class="w-full py-2.5 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-xl font-bold text-sm hover:shadow-lg transition-all">
                        ì¶”ì²¨í•˜ê¸°
                    </button>
                    {% if student.consent.status != 'approved' %}
                    <p class="text-[11px] text-gray-400 mt-2">ë™ì˜ ì™„ë£Œ í›„ ì‚¬ìš© ê°€ëŠ¥</p>
                    {% endif %}
                </div>
                <div x-show="confirming" x-transition class="mt-4 space-y-2">
                    <p class="text-xs text-gray-500">ì •ë§ ì¶”ì²¨í• ê¹Œìš”?</p>
                    <form method="post" action="{% url 'happy_seed:bloom_draw' student_id=student.id %}" class="flex gap-2">
                        {% csrf_token %}
                        <input type="hidden" name="request_id" value="{{ student.id }}-{{ student.ticket_count }}">
                        <button type="button" @click="confirming = false" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl text-sm font-bold">ì·¨ì†Œ</button>
                        <button type="submit" class="flex-1 py-2 bg-pink-500 text-white rounded-xl text-sm font-bold hover:bg-pink-600">í™•ì¸</button>
                    </form>
                </div>

                <form method="post" action="{% url 'happy_seed:set_teacher_override' student_id=student.id %}" class="mt-2">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="w-full py-2 bg-amber-100 text-amber-700 rounded-xl text-xs font-bold hover:bg-amber-200">
                        êµìœ¡ì  ê°œì…: ë‹¤ìŒ íšŒ ê°•ì œ ë‹¹ì²¨ ì˜ˆì•½
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="clay-card p-12 rounded-2xl text-center">
            <div class="text-5xl mb-4">ğŸŒ°</div>
            <p class="text-gray-500 break-keep">ë¸”ë£¸ í‹°ì¼“ì„ ë³´ìœ í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.<br>ë¨¼ì € í•™ìƒì—ê²Œ í‹°ì¼“ì„ ë¶€ì—¬í•´ì£¼ì„¸ìš”.</p>
            <a href="{% url 'happy_seed:classroom_detail' classroom_id=classroom.id %}" class="inline-block mt-4 px-6 py-2.5 bg-green-500 text-white rounded-xl font-bold text-sm hover:bg-green-600">êµì‹¤ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
        {% endif %}

    </div>
</section>
{% endblock %}
