# **Antigravity Self-Verification Protocol (ASVP)**

이 문서는 Antigravity 에이전트가 코드를 완성하고 사용자에게 제출하기 전, 스스로 품질을 검증하기 위한 **최종 체크리스트**입니다. 2026년 2월 9일 체스 업그레이드 작업에서 발생한 중대 과실들을 바탕으로 작성되었습니다.

---

## **1. 상태 관리 및 동기화 (State & Sync)**
- [ ] **상태 역행(Undo) 완결성**: `undo` 기능 구현 시, 라이브러리 상태(e.g. `game.undo()`)뿐만 아니라 내가 추가한 모든 커스텀 UI 상태(`capturedPieces`, `lastMove`, `highlights`)를 역방향으로 동기화했는가?
- [ ] **초기화(Reset) 시각화**: 데이터 구조만 초기화하지 않고, 실제 DOM이나 UI 컴포넌트에 즉시 반영(`render()` 함수 호출 등)했는가?
- [ ] **데이터 일관성**: 저장된 기록(`moveHistory`)과 화면에 표시된 정보가 항상 일치하는가?

## **2. 자바스크립트 표준 및 프론트엔드 통합 (JS & Frontend Integration)**
- [ ] **Anti-var Policy**: 절대 `var`를 사용하지 않는다. 반드시 `let` 또는 `const`를 사용한다.
- [ ] **섀도잉(Shadowing) 금지**: 동일 함수 내에서 변수명을 재사용하여 이전 분기의 값을 덮어쓰는 실수를 하지 않았는가?
- [ ] **Alpine.js 스코프(Scope)**: `x-data`가 선언된 엘리먼트가 상호작용이 필요한 모든 요소(모달, 오버레이 등)를 포함하고 있는가?
- [ ] **Django-to-JS 데이터 전송**: 
    - [ ] `|safe` 단독 사용 금지: 줄바꿈(`\n`)이나 따옴표(`'`)로 인해 JS 구문이 깨질 가능성이 없는가?
    - [ ] **json_script 사용 권장**: 대량의 데이터를 JS 객체로 넘길 때 `{% for %}` 루프 내 인라인 조립 대신 `json_script` 필터와 `JSON.parse`를 사용하는가?
    - [ ] **escapejs 사용**: 인라인 스크립트 삽입 시 반드시 `|escapejs`를 병행하여 문법 오류를 방지했는가?
- [ ] **비동기 안전성**: `setTimeout`이나 `Worker` 통신 시, 상태가 변한 후(이전으로 되돌린 후)에 콜백이 실행되어 상태가 꼬이는 경우는 없는가?

## **3. 자원 및 성능 관리 (Resource & Perf)**
- [ ] **싱글톤 패턴**: `AudioContext`, `Web Worker` 등 생성 비용이 큰 객체는 전역/공유 컨텍스트를 사용하는가? (과도 생성 금지)
- [ ] **자원 해제**: 사용이 끝난 이벤트 리스너나 타이머가 메모리 누수를 일으키진 않는가?
- [ ] **데이터 중복 배출**: 템플릿 루프 내에서 동일한 데이터를 여러 번 JS 객체로 직렬화하여 HTML 용량을 낭비하고 있지는 않은가?

## **4. UI/UX 정합성 및 디테일 (Visual Integrity)**
- [ ] **설명과 구현의 일치**: 사용자에게 제공하는 매뉴얼/텍스트(e.g. "드래그")와 실제 조작 방식(e.g. "클릭")이 일치하는가?
- [ ] **시각적 로직 피드백**: 프로모션 기물의 색상, 킹의 위치 표시 등 상황에 맞는 정확한 에셋을 선택했는가?
- [ ] **Z-index 계층**: 오버레이(z-50)와 모달(z-60) 등 레이어 간의 z-index가 명확히 분리되어 상호작용 간섭이 없는가?
- [ ] **모달 중앙 정렬(Centering) 보호**: 
    - [ ] 모달에 `clay-card`, `clay-btn` 등 전역 hover transform이 있는 클래스를 사용하고 있는가?
    - [ ] 사용한다면, 모달 전용 클래스로 hover transform을 `translate(-50%, -50%) !important`로 고정하여 중앙 정렬이 깨지는(반짝거림) 현상을 방지했는가?
- [ ] **애니메이션 완결성**: `animation` 속성을 썼다면 대응하는 `@keyframes`가 반드시 같은 파일이나 base 파일에 정의되어 있는가?
- [ ] **모바일 대응**: 가장 작은 화면(320px)에서 버튼이나 모달이 겹치거나 잘리지 않는가?


## **5. 환경 격리 및 정리 (Cleanup)**
- [ ] **불필요한 파일 제거**: 작업 영역(static, templates 등)에 다른 앱에서 온 임시 파일이나 스크린샷이 남아있지 않은가?
- [ ] **디버그 코드 제거**: `console.log`나 테스트용 하드코딩 값이 남아있지 않은가?

---

## **🚨 반성 및 금지 패턴 (Lessons Learned)**
*2026-02-09 도구 페이지(Tools Overhaul) 작업의 중대 실패 항목:*

1. **파편화된 Alpine.js 스코프 금지**: 상호작용이 필요한 모달/오버레이가 `x-data` 영역 밖에 있어 작동하지 않는 "개같은 상황"을 만들지 않았는가? (전체를 감싸는 Wrapper에 `x-data` 배치 필수)
2. **인라인 객체 조립 금지**: `{% for %}` 루프 내에서 `@click="openModal({...})"` 처럼 대량의 데이터를 수십 번 반복해서 HTML에 뱉어내고 있지는 않은가? 
    - **해결**: `{{ tools_json|json_script:"id" }}`로 한 번만 주입하고 인덱스(`forloop.counter0`)로 참조할 것.
3. **모달 사용성 무시 금지**: 긴 내용의 모달이 화면 위아래로 잘리는 현상을 방지하기 위해 `max-h-[85vh]`와 `overflow-y-auto`를 설정했는가?
4. **ID 남용 금지**: 자바스크립트나 CSS에서 반복되거나 동적으로 표시되는 요소에는 `#id` 대신 `.class`를 사용하여 스타일링과 선택의 유연성을 확보했는가?
5. **무지성 |safe 필터링 금지**: 문자열 내에 줄바꿈이나 따옴표가 섞여 JS 문법을 파괴할 위험을 인지하고 `json_script`나 `escapejs`를 사용했는가?
6. **모달 정렬 깨짐(2026-02-09 파악)**: tools 페이지 모달이 `.clay-card:hover`의 `translateY(-4px)`에 의해 centering이 깨지면서 반짝거림 발생. `.tool-modal.clay-card:hover`로 transform 고정하여 해결.

---

## **명령어 (준수 여부 확인용)**
- [ ] `grep -r "var " .` (JS 파일에서 var 사용 여부 체크)
- [ ] `grep -r "console.log" .` (디버그 로그 체크)
- [ ] `grep -r "|safe" .` (HTML에서 위험한 데이터 주입 체크)

---
**"동작하게 만드는 것은 시작일 뿐이다. 완벽하게 상태를 관리하고 자원을 배려하는 것이 전문성이다."**

