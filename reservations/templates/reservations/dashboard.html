{% extends 'base.html' %}

{% block content %}
<section class="pb-20 px-6 min-h-screen bg-[#E0E5EC]"
    style="padding-top: calc(var(--main-nav-height, 88px) + 1.75rem);">
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4" data-aos="fade-down">
            <div>
                <h1 class="text-4xl font-bold text-gray-800 font-title flex items-center gap-3">
                    <span class="text-5xl">ğŸ›ï¸</span>
                    <span>{{ school.name }} ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</span>
                </h1>
                <p class="text-gray-500 mt-2 ml-1">íŠ¹ë³„ì‹¤, ê³ ì • ìˆ˜ì—…, ë¸”ë™ì•„ì›ƒ ê¸°ê°„ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
            </div>

            <div class="flex flex-wrap justify-center md:justify-end gap-3">
                <a href="{% url 'reservations:reservation_index' school.slug %}" target="_blank" rel="noopener noreferrer"
                    class="clay-btn-primary px-6 py-3 font-bold flex items-center gap-2">
                    <i class="fas fa-external-link-alt"></i> ì˜ˆì•½ í˜„í™©íŒ (ìƒˆ íƒ­)
                </a>
                <a href="{% url 'reservations:dashboard_landing' %}"
                    class="clay-btn px-6 py-3 text-purple-600 font-bold hover:shadow-clay-hover flex items-center gap-2">
                    <i class="fas fa-list"></i> ë‚´ í•™êµ ëª©ë¡
                </a>
                <a href="{% url 'home' %}"
                    class="clay-btn px-6 py-3 text-gray-600 font-bold hover:text-purple-600 flex items-center gap-2">
                    <i class="fas fa-home"></i> í™ˆìœ¼ë¡œ
                </a>
            </div>
        </div>

        <!-- Share Section -->
        <div class="clay-card p-6 mb-8 border-l-8 border-purple-500 bg-white/80" data-aos="zoom-in" 
             x-data="{ 
                copied: false,
                shareUrl: '{{ request.scheme }}://{{ request.get_host }}{% url 'reservations:reservation_index' school.slug %}',
                getShareMessage() {
                    return `[{{ school.name }} íŠ¹ë³„ì‹¤ ì˜ˆì•½ ì•ˆë‚´]\n\nì„ ìƒë‹˜ ì•ˆë…•í•˜ì„¸ìš”,\níŠ¹ë³„ì‹¤ ì˜ˆì•½ ì‹œìŠ¤í…œì´ ì˜¤í”ˆë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë§í¬ë¥¼ í†µí•´ ì›í•˜ì‹œëŠ” ì‹œê°„ëŒ€ì— ì˜ˆì•½ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.\n\nğŸ”— ì˜ˆì•½ ë§í¬: ${this.shareUrl}\n\n* í•„ìš” ì‹œ 'ì´ ê¸°ê¸°ì—ì„œ ì •ë³´ ê¸°ì–µ'ì„ ì¼œë©´ ë‹¤ìŒ ì˜ˆì•½ì´ ë¹¨ë¼ì§‘ë‹ˆë‹¤.`;
                },
                copyToClipboard() {
                    const text = this.getShareMessage();
                    navigator.clipboard.writeText(text);
                    this.copied = true;
                    setTimeout(() => this.copied = false, 2000);
                }
             }">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2 mb-2">
                        <i class="fas fa-share-alt text-purple-600"></i> ì„ ìƒë‹˜ë“¤ê»˜ ë§í¬ ê³µìœ í•˜ê¸°
                    </h3>
                    <p class="text-gray-600 text-sm">
                        ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ <strong>ì•ˆë‚´ ë¬¸êµ¬ê°€ í¬í•¨ëœ ì˜ˆì•½ ë§í¬</strong>ê°€ ë³µì‚¬ë©ë‹ˆë‹¤.<br>
                        ë³µì‚¬ëœ ë‚´ìš©ì„ ì¹´ì¹´ì˜¤í†¡, ë©”ì‹ ì € ë“±ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
                    </p>
                </div>
                <div class="w-full md:w-auto">
                    <button @click="copyToClipboard()" 
                            class="w-full md:w-auto clay-btn-primary px-8 py-4 flex items-center justify-center gap-3 text-lg transition-transform active:scale-95">
                        <i class="fas" :class="copied ? 'fa-check-circle' : 'fa-copy'"></i>
                        <span x-text="copied ? 'ë³µì‚¬ ì™„ë£Œ!' : 'ì´ˆëŒ€ ë¬¸êµ¬ ë³µì‚¬'"></span>
                    </button>
                </div>
            </div>
            
            <div class="mt-4 p-4 clay-inner bg-gray-50/50 rounded-xl">
                <p class="text-xs text-gray-500 font-bold uppercase mb-1">ë³µì‚¬ë  ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°</p>
                <pre class="text-xs text-gray-600 whitespace-pre-wrap font-sans" x-text="getShareMessage()"></pre>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- 1. íŠ¹ë³„ì‹¤ ê´€ë¦¬ (Special Rooms) -->
            <div class="clay-card p-5 md:p-8" data-aos="fade-up" data-aos-delay="100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-door-open text-purple-500"></i> íŠ¹ë³„ì‹¤ ê´€ë¦¬
                    </h2>
                </div>

                <!-- Room List (HTMX) -->
                <div id="room-list-container" hx-get="{% url 'reservations:room_settings' school.slug %}"
                    hx-trigger="load" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                    <div class="flex justify-center py-8">
                        <i class="fas fa-circle-notch fa-spin text-3xl text-gray-400"></i>
                    </div>
                </div>

                <!-- Add Room Form -->
                <form hx-post="{% url 'reservations:room_settings' school.slug %}" hx-target="#room-list-container"
                    hx-indicator="#room-add-indicator" hx-disabled-elt="find button[type='submit']"
                    hx-on::response-error="alert('íŠ¹ë³„ì‹¤ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.')"
                    class="mt-6 pt-6 border-t border-gray-200" @htmx:after-request="this.reset()">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add">
                    <input type="hidden" name="action" value="add">
                    <div class="flex gap-2 items-stretch h-12">
                        <!-- Icon Select -->
                        <div class="relative w-20 flex-shrink-0 group">
                            <select name="icon" class="w-full h-full shadow-clay-inner pl-3 pr-8 text-xl bg-[#E0E5EC] outline-none focus:ring-2 focus:ring-purple-300 rounded-xl appearance-none cursor-pointer text-center font-emoji">
                                <option value="ğŸ«">ğŸ«</option>
                                <option value="ğŸ”¬">ğŸ”¬</option>
                                <option value="ğŸ’»">ğŸ’»</option>
                                <option value="ğŸ¨">ğŸ¨</option>
                                <option value="ğŸ¤¸">ğŸ¤¸</option>
                                <option value="ğŸµ">ğŸµ</option>
                                <option value="ğŸ“š">ğŸ“š</option>
                                <option value="ğŸ—£ï¸">ğŸ—£ï¸</option>
                                <option value="ğŸ³">ğŸ³</option>
                                <option value="ğŸ“" selected>ğŸ“</option>
                            </select>
                            <div class="absolute inset-y-0 right-2 flex items-center pointer-events-none text-gray-400">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                        
                        <!-- Name Input -->
                        <div class="flex-1 min-w-0">
                            <input type="text" name="name" placeholder="íŠ¹ë³„ì‹¤ ì´ë¦„"
                                class="w-full h-full shadow-clay-inner px-4 text-sm md:text-base bg-[#E0E5EC] outline-none focus:ring-2 focus:ring-purple-300 rounded-xl" required>
                        </div>
                        
                        <!-- Submit Button -->
                        <button type="submit" class="flex-shrink-0 clay-btn-primary w-12 md:w-auto md:px-6 flex items-center justify-center gap-2 rounded-xl">
                            <span id="room-add-indicator" class="htmx-indicator">
                                <i class="fas fa-circle-notch fa-spin text-xs"></i>
                            </span>
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- 2. ë¸”ë™ì•„ì›ƒ ê´€ë¦¬ (Blackout Dates) -->
            <div class="clay-card p-5 md:p-8" data-aos="fade-up" data-aos-delay="200">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-ban text-red-500"></i> ì˜ˆì•½ ì œí•œ(ë¸”ë™ì•„ì›ƒ) ì„¤ì •
                    </h2>
                </div>

                <!-- Blackout List (HTMX) -->
                <div id="blackout-list-container" hx-get="{% url 'reservations:blackout_settings' school.slug %}"
                    hx-trigger="load" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                    <div class="flex justify-center py-8">
                        <i class="fas fa-circle-notch fa-spin text-3xl text-gray-400"></i>
                    </div>
                </div>

                <!-- Add Blackout Form -->
                <form hx-post="{% url 'reservations:blackout_settings' school.slug %}"
                    hx-target="#blackout-list-container" hx-indicator="#blackout-add-indicator"
                    hx-disabled-elt="find button[type='submit']"
                    hx-on::response-error="alert('ë¸”ë™ì•„ì›ƒ ê¸°ê°„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.')"
                    class="mt-6 pt-6 border-t border-gray-200" @htmx:after-request="this.reset()">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add">
                    <div class="flex flex-col gap-3">
                        <div class="flex gap-2">
                            <input type="date" name="start_date" class="flex-1 shadow-clay-inner p-3 rounded-xl text-sm bg-[#E0E5EC] outline-none focus:ring-2 focus:ring-purple-300"
                                required>
                            <span class="self-center text-gray-400">~</span>
                            <input type="date" name="end_date" class="flex-1 shadow-clay-inner p-3 rounded-xl text-sm bg-[#E0E5EC] outline-none focus:ring-2 focus:ring-purple-300"
                                required>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" name="reason" placeholder="ì‚¬ìœ  (ì˜ˆ: ì¤‘ê°„ê³ ì‚¬ê¸°ê°„)"
                                class="flex-1 shadow-clay-inner p-3 rounded-xl text-sm bg-[#E0E5EC] outline-none focus:ring-2 focus:ring-purple-300" required>
                            <button type="submit"
                                class="px-6 py-3 bg-red-100 text-red-600 rounded-xl font-bold hover:bg-red-200 transition-colors inline-flex items-center gap-2">
                                <span id="blackout-add-indicator" class="htmx-indicator">
                                    <i class="fas fa-circle-notch fa-spin text-xs"></i>
                                </span>
                                <span>ì¶”ê°€</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 3. êµì‹œ(Period) ê´€ë¦¬ -->
            <div class="lg:col-span-2 clay-card p-5 md:p-8" data-aos="fade-up" data-aos-delay="300">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-clock text-orange-500"></i> êµì‹œ(Period) ì„¤ì •
                    </h2>
                    <p class="hidden md:block text-sm text-gray-500">
                        * êµì‹œëª…/ì‹œê°„ì„ í•œ ì¤„ì”© ì…ë ¥í•´ ì§ê´€ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”.
                    </p>
                </div>

                <form hx-post="{% url 'reservations:update_config' school.slug %}"
                    hx-indicator="#config-save-indicator" hx-disabled-elt="find button[type='submit']"
                    hx-on::response-error="alert('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.')"
                    class="space-y-6"
                    x-data="periodEditor('{{ school.config.period_labels|escapejs }}', '{{ school.config.period_times|escapejs }}')"
                    x-init="init()"
                    @submit="syncHiddenFields()">
                    {% csrf_token %}
                    <input type="hidden" name="period_labels" x-ref="periodLabelsInput">
                    <input type="hidden" name="period_times" x-ref="periodTimesInput">

                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-2 ml-1">í•™êµ ì´ë¦„</label>
                        <input type="text" name="school_name" value="{{ school.name }}"
                            class="w-full shadow-clay-inner p-4 rounded-2xl font-bold bg-[#E0E5EC] outline-none focus:ring-2 focus:ring-purple-300" required>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-2 ml-1">êµì‹œ êµ¬ì„±/ì‹œê°„</label>
                        <div class="bg-white/60 border border-white/70 rounded-2xl p-3 md:p-4 space-y-2">
                            <div class="hidden md:grid grid-cols-[88px_minmax(0,1fr)_minmax(0,1fr)_72px] gap-2 px-1 text-[11px] font-bold text-gray-500">
                                <span>ìˆœì„œ</span>
                                <span>êµì‹œ ì´ë¦„</span>
                                <span>êµì‹œ ì‹œê°„(ì„ íƒ)</span>
                                <span class="text-center">ì‚­ì œ</span>
                            </div>

                            <template x-for="(slot, idx) in periodSlots" :key="slot.id">
                                <div class="grid grid-cols-1 md:grid-cols-[88px_minmax(0,1fr)_minmax(0,1fr)_72px] gap-2 items-center bg-[#E0E5EC]/80 rounded-xl p-2.5">
                                    <div class="flex items-center justify-between md:justify-center px-1">
                                        <span class="text-xs font-bold text-gray-500 md:hidden">ìˆœì„œ</span>
                                        <span class="inline-flex items-center justify-center rounded-lg bg-white px-2.5 py-1 text-sm font-extrabold text-gray-700"
                                            x-text="`${idx + 1}êµì‹œ`"></span>
                                    </div>
                                    <input type="text"
                                        x-model="slot.label"
                                        @input="syncHiddenFields()"
                                        class="w-full shadow-clay-inner px-3 py-2.5 rounded-xl text-sm bg-[#E0E5EC] outline-none focus:ring-2 focus:ring-purple-300"
                                        placeholder="ì˜ˆ: 1êµì‹œ, ì ì‹¬, ì°½ì²´">
                                    <input type="text"
                                        x-model="slot.time"
                                        @input="syncHiddenFields()"
                                        class="w-full shadow-clay-inner px-3 py-2.5 rounded-xl text-sm font-mono bg-[#E0E5EC] outline-none focus:ring-2 focus:ring-purple-300"
                                        placeholder="ì˜ˆ: 09:00-09:40">
                                    <button type="button"
                                        @click="removeSlot(idx)"
                                        :disabled="periodSlots.length === 1"
                                        class="h-10 rounded-xl border border-red-200 bg-red-50 text-red-600 text-xs font-bold hover:bg-red-100 disabled:opacity-50 disabled:cursor-not-allowed transition">
                                        ì‚­ì œ
                                    </button>
                                </div>
                            </template>

                            <div class="flex flex-wrap gap-2 pt-1">
                                <button type="button"
                                    @click="addSlot()"
                                    class="inline-flex items-center gap-1.5 px-3 py-2 rounded-xl bg-indigo-50 text-indigo-700 text-xs font-bold hover:bg-indigo-100 transition">
                                    <i class="fas fa-plus text-[10px]"></i> êµì‹œ ì¶”ê°€
                                </button>
                                <button type="button"
                                    @click="fillDefaultLabels()"
                                    class="inline-flex items-center gap-1.5 px-3 py-2 rounded-xl bg-gray-100 text-gray-700 text-xs font-bold hover:bg-gray-200 transition">
                                    ê¸°ë³¸ ì´ë¦„ ì±„ìš°ê¸°
                                </button>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-2 ml-2">
                            * êµì‹œ ì´ë¦„ì€ í•„ìˆ˜, ì‹œê°„ì€ ì„ íƒì…ë‹ˆë‹¤. í–‰ì„ ì¶”ê°€/ì‚­ì œí•˜ë©´ ì˜ˆì•½íŒ í–‰ì´ ê·¸ëŒ€ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="flex flex-col md:flex-row justify-between items-center bg-orange-50/50 p-4 rounded-xl border border-orange-100 gap-4">
                        <p class="text-xs text-orange-600">
                            <strong>ğŸ”’ ë³´ì•ˆ íŒ:</strong> ì˜ˆì•½ ì£¼ì†ŒëŠ” ë‹¤ë¥¸ ì‚¬ëŒì´ ì¶”ì¸¡í•  ìˆ˜ ì—†ë„ë¡ ë¬´ì‘ìœ„ ë¬¸ìì—´ë¡œ ìƒì„±ë©ë‹ˆë‹¤. <br>
                            ì´ˆëŒ€ ë¬¸êµ¬ ë³µì‚¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì•ˆì „í•œ ë§í¬ë¥¼ ì„ ìƒë‹˜ë“¤ê»˜ ì „ë‹¬í•˜ì„¸ìš”.
                        </p>
                        <button type="submit" class="w-full md:w-auto clay-btn-primary px-8 py-3 font-bold whitespace-nowrap inline-flex items-center justify-center gap-2">
                            <span id="config-save-indicator" class="htmx-indicator">
                                <i class="fas fa-circle-notch fa-spin"></i>
                            </span>
                            <span>ì„¤ì • ì „ì²´ ì €ì¥</span>
                        </button>
                    </div>

                    <div class="border-t border-gray-200 pt-6 mt-6">
                        <label class="block text-sm font-bold text-gray-600 mb-4 ml-1 flex items-center gap-2">
                            <i class="fas fa-calendar-check text-green-500"></i> ì˜ˆì•½ ì˜¤í”ˆ ê·œì¹™ ì„¤ì •
                        </label>
                        
                        <div class="bg-white/50 rounded-2xl p-4 md:p-6" x-data="{ weeklyMode: {{ school.config.weekly_opening_mode|yesno:'true,false' }} }">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h4 class="font-bold text-gray-700">ì£¼ê°„ ì˜ˆì•½ ì œí•œ ëª¨ë“œ</h4>
                                    <p class="text-xs text-gray-500 mt-1">
                                        ì¼œë©´ ë§¤ì£¼ ì§€ì •ëœ ìš”ì¼/ì‹œê°„ì— <strong class="text-purple-600">ë‹¤ìŒ ì£¼ ì˜ˆì•½</strong>ì´ ì—´ë¦½ë‹ˆë‹¤.<br>
                                        êº¼ë‘ë©´ ë‚ ì§œ ì œí•œ ì—†ì´ ì–¸ì œë“  ë¯¸ë˜ ì˜ˆì•½ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="weekly_opening_mode" class="sr-only peer" x-model="weeklyMode">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>

                            <div x-show="weeklyMode" class="flex flex-col md:flex-row gap-4 mt-4 bg-purple-50 p-4 rounded-xl border border-purple-100"
                                x-transition:enter="transition ease-out duration-200"
                                x-transition:enter-start="opacity-0 -translate-y-2"
                                x-transition:enter-end="opacity-100 translate-y-0">
                                
                                <div class="flex-1">
                                    <label class="block text-xs font-bold text-purple-800 mb-1">ì˜¤í”ˆ ìš”ì¼</label>
                                    <select name="weekly_opening_weekday" class="w-full clay-inner p-3 rounded-xl bg-white text-sm">
                                        <option value="0" {% if school.config.weekly_opening_weekday == 0 %}selected{% endif %}>ì›”ìš”ì¼</option>
                                        <option value="1" {% if school.config.weekly_opening_weekday == 1 %}selected{% endif %}>í™”ìš”ì¼</option>
                                        <option value="2" {% if school.config.weekly_opening_weekday == 2 %}selected{% endif %}>ìˆ˜ìš”ì¼</option>
                                        <option value="3" {% if school.config.weekly_opening_weekday == 3 %}selected{% endif %}>ëª©ìš”ì¼</option>
                                        <option value="4" {% if school.config.weekly_opening_weekday == 4 %}selected{% endif %}>ê¸ˆìš”ì¼</option>
                                        <option value="5" {% if school.config.weekly_opening_weekday == 5 %}selected{% endif %}>í† ìš”ì¼</option>
                                        <option value="6" {% if school.config.weekly_opening_weekday == 6 %}selected{% endif %}>ì¼ìš”ì¼</option>
                                    </select>
                                </div>
                                
                                <div class="flex-1">
                                    <label class="block text-xs font-bold text-purple-800 mb-1">ì˜¤í”ˆ ì‹œê°„</label>
                                    <select name="weekly_opening_hour" class="w-full clay-inner p-3 rounded-xl bg-white text-sm">
                                        {% for i in "012345678901234567890123"|make_list %}
                                            {% if forloop.counter0 < 24 %}
                                            <option value="{{ forloop.counter0 }}" {% if school.config.weekly_opening_hour == forloop.counter0 %}selected{% endif %}>
                                                {{ forloop.counter0|stringformat:"02d" }}:00
                                            </option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="flex items-center text-xs text-purple-600 font-bold px-2">
                                    <span>ë¶€í„° ë‹¤ìŒ ì£¼ ì˜ˆì•½ ê°€ëŠ¥</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 4. ê³ ì • ì‹œê°„í‘œ ë§¤íŠ¸ë¦­ìŠ¤ (Full Width) -->
            <div class="lg:col-span-2 clay-card p-5 md:p-8" data-aos="fade-up" data-aos-delay="400">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-700 flex items-center gap-2">
                        <i class="fas fa-th text-blue-500"></i> ê³ ì • ìˆ˜ì—…(Recurring) ì„¤ì •
                    </h2>
                    <p class="hidden md:block text-sm text-gray-500">
                        * íŠ¹ì • êµì‹œë¥¼ í´ë¦­í•˜ì—¬ ê³ ì • ìˆ˜ì—…ì„ ì„¤ì •í•˜ê±°ë‚˜ í•´ì œí•˜ì„¸ìš”.
                    </p>
                </div>

                <div id="recurring-matrix-container" hx-get="{% url 'reservations:recurring_settings' school.slug %}"
                    hx-trigger="load" class="overflow-x-auto no-scrollbar">
                    <div class="flex justify-center py-12">
                        <i class="fas fa-circle-notch fa-spin text-4xl text-gray-400"></i>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2" data-aos="fade-up">
                {% include 'core/partials/service_suggestion.html' with service_key='reservations' %}
            </div>

            <!-- Danger Zone -->
            <div class="lg:col-span-2 mt-12 pt-8 border-t border-gray-300" data-aos="fade-up">
                <div class="clay-card p-6 border-2 border-red-200 bg-red-50/30" x-data="{ showDeleteModal: false }">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h3 class="text-lg font-bold text-red-600 flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle"></i> ìœ„í—˜ êµ¬ì—­
                            </h3>
                            <p class="text-sm text-gray-500 mt-1">í•™êµì™€ ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°(ì˜ˆì•½, íŠ¹ë³„ì‹¤ ì„¤ì • ë“±)ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</p>
                        </div>
                        <button @click="showDeleteModal = true" 
                                class="px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition active:scale-95 shadow-lg">
                            í•™êµ ì „ì²´ ì‚­ì œí•˜ê¸°
                        </button>
                    </div>

                    <!-- Delete Confirmation Modal -->
                    <template x-if="showDeleteModal">
                        <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0"
                             x-transition:enter-end="opacity-100">
                            <div class="clay-card w-full max-w-md p-8 bg-white" @click.away="showDeleteModal = false">
                                <div class="text-center mb-6">
                                    <div class="w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                                        <i class="fas fa-trash-alt"></i>
                                    </div>
                                    <h4 class="text-2xl font-bold text-gray-800">ì •ë§ ì‚­ì œí• ê¹Œìš”?</h4>
                                    <p class="text-gray-500 mt-2">'{{ school.name }}'ì˜ ëª¨ë“  ì •ë³´ê°€ ì‚­ì œë˜ë©°, ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                                </div>
                                <div class="flex gap-3">
                                    <button @click="showDeleteModal = false" 
                                            class="flex-1 py-4 clay-btn text-gray-600 font-bold">ì·¨ì†Œ</button>
                                    <form action="{% url 'reservations:delete_school' school.slug %}" method="post" class="flex-1">
                                        {% csrf_token %}
                                        <button type="submit" class="w-full py-4 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 shadow-clay active:scale-95 transition">
                                            ì‚­ì œ í™•ì¸
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

        </div>
    </div>
</section>

<script>
    function periodEditor(initialLabels, initialTimes) {
        const parseCsv = function (value) {
            return String(value || '')
                .split(',')
                .map(function (item) { return item.trim(); });
        };

        const labels = parseCsv(initialLabels).filter(function (item) { return item.length > 0; });
        const times = parseCsv(initialTimes);
        const slotCount = Math.max(labels.length, 1);
        const slots = [];

        for (let i = 0; i < slotCount; i += 1) {
            slots.push({
                id: i + 1,
                label: labels[i] || `${i + 1}êµì‹œ`,
                time: times[i] || '',
            });
        }

        return {
            periodSlots: slots,
            nextId: slotCount + 1,

            init() {
                this.syncHiddenFields();
            },

            addSlot() {
                this.periodSlots.push({
                    id: this.nextId,
                    label: `${this.periodSlots.length + 1}êµì‹œ`,
                    time: '',
                });
                this.nextId += 1;
                this.syncHiddenFields();
            },

            removeSlot(index) {
                if (this.periodSlots.length <= 1) {
                    return;
                }
                this.periodSlots.splice(index, 1);
                this.syncHiddenFields();
            },

            fillDefaultLabels() {
                this.periodSlots.forEach(function (slot, idx) {
                    if (!String(slot.label || '').trim()) {
                        slot.label = `${idx + 1}êµì‹œ`;
                    }
                });
                this.syncHiddenFields();
            },

            syncHiddenFields() {
                let normalized = this.periodSlots
                    .map(function (slot) {
                        return {
                            label: String(slot.label || '').trim(),
                            time: String(slot.time || '').trim(),
                        };
                    })
                    .filter(function (slot) { return slot.label.length > 0; });

                if (!normalized.length) {
                    normalized = [{ label: '1êµì‹œ', time: '' }];
                    if (this.periodSlots.length) {
                        this.periodSlots[0].label = '1êµì‹œ';
                    } else {
                        this.periodSlots.push({ id: this.nextId, label: '1êµì‹œ', time: '' });
                        this.nextId += 1;
                    }
                }

                this.$refs.periodLabelsInput.value = normalized.map(function (slot) { return slot.label; }).join(',');
                this.$refs.periodTimesInput.value = normalized.map(function (slot) { return slot.time; }).join(',');
            },
        };
    }

    (function () {
        let recurringScrollY = null;

        document.body.addEventListener('htmx:beforeRequest', function (evt) {
            if (evt.target && evt.target.closest && evt.target.closest('#recurring-matrix-container')) {
                recurringScrollY = window.scrollY || window.pageYOffset || 0;
            }
        });

        document.body.addEventListener('htmx:afterSwap', function (evt) {
            const target = evt.detail && evt.detail.target;
            if (!target || target.id !== 'recurring-matrix-container' || recurringScrollY === null) {
                return;
            }

            const restoreY = recurringScrollY;
            recurringScrollY = null;
            window.requestAnimationFrame(function () {
                window.scrollTo(0, restoreY);
            });
        });
    })();
</script>
{% endblock %}

