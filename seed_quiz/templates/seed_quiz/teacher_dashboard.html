{% extends 'base.html' %}

{% block title %}ì”¨ì•— í€´ì¦ˆ â€” {{ classroom.name }}{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-4 min-h-screen">
<div class="max-w-4xl mx-auto">

    <!-- í—¤ë” -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
        <div>
            <a href="{% url 'happy_seed:classroom_detail' classroom_id=classroom.id %}" class="text-sm text-gray-400 hover:text-gray-600">&larr; êµì‹¤ë¡œ ëŒì•„ê°€ê¸°</a>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mt-1">ğŸ“ ì”¨ì•— í€´ì¦ˆ</h1>
            <p class="text-sm text-gray-500">{{ classroom.name }} &middot; {{ classroom.school_name }}</p>
        </div>
        <div class="w-full sm:w-auto">
            <div class="hidden sm:flex flex-wrap items-center gap-2 justify-end">
                <a href="{% url 'seed_quiz:teacher_student_dashboard' classroom_id=classroom.id %}"
                   target="_blank"
                   rel="noopener"
                   class="px-3 py-2 rounded-lg border border-indigo-200 bg-indigo-50 text-indigo-700 text-xs font-bold hover:bg-indigo-100 transition-colors whitespace-nowrap">
                    í•™ìƒ ëŒ€ì‹œë³´ë“œ â†—
                </a>
                <a href="{% url 'seed_quiz:teacher_result_analysis' classroom_id=classroom.id %}"
                   target="_blank"
                   rel="noopener"
                   class="px-3 py-2 rounded-lg border border-emerald-200 bg-emerald-50 text-emerald-700 text-xs font-bold hover:bg-emerald-100 transition-colors whitespace-nowrap">
                    ì •ë‹µ ë¶„ì„ â†—
                </a>
            </div>
            <details class="sm:hidden relative">
                <summary class="list-none cursor-pointer inline-flex items-center justify-between w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm font-bold">
                    ìš´ì˜ í™”ë©´ ì—´ê¸° (ìƒˆ íƒ­)
                    <span class="text-xs text-gray-400">â–¼</span>
                </summary>
                <div class="absolute right-0 mt-2 w-48 rounded-xl border border-gray-200 bg-white shadow-lg p-2 z-20">
                    <a href="{% url 'seed_quiz:teacher_student_dashboard' classroom_id=classroom.id %}"
                       target="_blank"
                       rel="noopener"
                       class="block px-3 py-2 rounded-lg text-xs font-bold text-indigo-700 hover:bg-indigo-50">
                        í•™ìƒ ëŒ€ì‹œë³´ë“œ (ìƒˆ íƒ­)
                    </a>
                    <a href="{% url 'seed_quiz:teacher_result_analysis' classroom_id=classroom.id %}"
                       target="_blank"
                       rel="noopener"
                       class="block px-3 py-2 rounded-lg text-xs font-bold text-emerald-700 hover:bg-emerald-50">
                        ì •ë‹µ ë¶„ì„ (ìƒˆ íƒ­)
                    </a>
                </div>
            </details>
        </div>
    </div>

    <!-- ì…ë ¥ ë°©ì‹ ì„ íƒ -->
    <div class="clay-card p-5 rounded-2xl mb-4 border border-violet-200 bg-violet-50/60">
        <p class="text-sm font-bold text-violet-800">A) ìƒˆ ë¬¸ì œ ë§Œë“¤ê¸° Â· ë°©ë²•ì€ <span class="underline">í•˜ë‚˜ë§Œ</span> ì„ íƒí•˜ë©´ ë©ë‹ˆë‹¤.</p>
        <p class="mt-1 text-xs text-violet-700">
            ë°©ë²• A(ë¶™ì—¬ë„£ê¸°) ë˜ëŠ” ë°©ë²• B(íŒŒì¼ ì˜¬ë¦¬ê¸°) ì¤‘ í•˜ë‚˜ë§Œ ì§„í–‰í•˜ì„¸ìš”. ë‘˜ ë‹¤ ë„£ì„ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
        </p>
        <div class="mt-3 flex flex-col sm:flex-row gap-2">
            <button type="button"
                    data-input-method="paste"
                    class="w-full sm:w-auto px-4 py-2 rounded-lg text-sm text-center font-bold transition-colors bg-violet-600 text-white whitespace-nowrap">
                ë°©ë²• A. ë¶™ì—¬ë„£ê¸° (ê¶Œì¥)
            </button>
            <button type="button"
                    data-input-method="file"
                    class="w-full sm:w-auto px-4 py-2 rounded-lg text-sm text-center font-bold transition-colors bg-white border border-violet-200 text-violet-700 hover:bg-violet-100 whitespace-nowrap">
                ë°©ë²• B. íŒŒì¼ ì˜¬ë¦¬ê¸°
            </button>
        </div>
    </div>

    <!-- íŒŒì¼ ì—…ë¡œë“œ -->
    <div id="input-method-file" class="clay-card p-6 rounded-2xl mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
            <h2 class="font-bold text-gray-700">ë°©ë²• B) ë¬¸ì œ íŒŒì¼ ì˜¬ë¦¬ê¸°</h2>
            <div class="flex flex-wrap items-center justify-end gap-2">
                <a href="{% url 'seed_quiz:download_csv_guide' classroom_id=classroom.id %}"
                   class="w-full sm:w-auto text-center px-3 py-2 bg-emerald-100 text-emerald-700 rounded-lg text-xs font-bold hover:bg-emerald-200 transition-colors whitespace-nowrap">
                    ì œì‘ ê°€ì´ë“œ ë³´ê¸°
                </a>
                <a href="{% url 'seed_quiz:download_xlsx_template' classroom_id=classroom.id %}"
                   class="w-full sm:w-auto text-center px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-200 transition-colors whitespace-nowrap">
                    XLSX í…œí”Œë¦¿
                </a>
                <a href="{% url 'seed_quiz:download_csv_template' classroom_id=classroom.id %}"
                   class="w-full sm:w-auto text-center px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-bold hover:bg-gray-200 transition-colors whitespace-nowrap">
                    CSV í…œí”Œë¦¿
                </a>
            </div>
        </div>
        <p class="mb-3 text-xs text-gray-500">
            íŒŒì¼ ë°©ì‹ì€ <strong>íŒŒì¼ í™•ì¸</strong> í›„, ì•„ë˜ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ <strong>ë¬¸ì œ ë§Œë“¤ê¸°</strong>ë¥¼ ëˆŒëŸ¬ ì €ì¥ì´ ì™„ë£Œë©ë‹ˆë‹¤.
        </p>
        <details class="mb-3">
            <summary class="cursor-pointer text-xs font-bold text-gray-500 list-none inline-flex items-center gap-1">
                ê³ ê¸‰ ìë£Œ(ìƒ˜í”Œ íŒ©)
            </summary>
            <div class="mt-2">
                <a href="{% url 'seed_quiz:download_csv_sample_pack' classroom_id=classroom.id %}"
                   class="inline-flex px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg text-xs font-bold hover:bg-indigo-200 transition-colors whitespace-nowrap">
                    ìƒ˜í”Œ íŒ© ë‹¤ìš´ë¡œë“œ
                </a>
                <p class="mt-1 text-xs text-gray-400">LLMìœ¼ë¡œ ìƒì„±ì´ ì–´ë ¤ìš¸ ë•Œ ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
            </div>
        </details>
        <form id="csv-upload-form"
              data-client-check-state="idle"
              data-max-file-bytes="{{ csv_limits.max_file_bytes }}"
              data-max-rows="{{ csv_limits.max_rows }}"
              hx-post="{% url 'seed_quiz:htmx_csv_upload' classroom_id=classroom.id %}"
              hx-encoding="multipart/form-data"
              hx-target="#csv-upload-result"
              hx-swap="innerHTML"
              class="flex flex-wrap items-end gap-3">
            {% csrf_token %}
            <div class="flex-1 min-w-[260px]">
                <label class="block text-xs font-bold text-gray-500 mb-1">ë¬¸ì œ íŒŒì¼</label>
                <input type="file"
                       id="csv-file-input"
                       name="csv_file"
                       accept=".csv,text/csv"
                       required
                       class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
            </div>
            <button type="submit"
                    class="px-5 py-2 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all">
                íŒŒì¼ í™•ì¸
            </button>
        </form>
        <p class="mt-2 text-xs text-gray-500">
            íŒŒì¼ ì²« ì¤„ì€ ì´ ìˆœì„œë¡œ ë§ì¶° ì£¼ì„¸ìš”: {{ csv_headers_ko_text }}
        </p>
        <p class="mt-1 text-xs text-gray-400">
            í•œ íŒŒì¼ì€ í•œ ì„¸íŠ¸ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ë¬¸ì œëŠ” 1~200ê°œê¹Œì§€ ë„£ì„ ìˆ˜ ìˆê³ , í•œ íŒŒì¼ ì•ˆì—ì„œëŠ” ê°™ì€ ì£¼ì œ/ê°™ì€ í•™ë…„ìœ¼ë¡œ ë§ì¶° ì£¼ì„¸ìš”.
        </p>
        <p class="mt-1 text-xs text-gray-400">
            íŒŒì¼ ì œí•œ: {{ csv_limits_human.max_file }} ì´í•˜ / ìµœëŒ€ {{ csv_limits_human.max_rows }}ë¬¸í•­
        </p>
        <div id="csv-client-check" class="mt-2 hidden"></div>
    </div>

    <!-- í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° ì—…ë¡œë“œ -->
    <div id="input-method-paste" class="clay-card p-6 rounded-2xl mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
            <h2 class="font-bold text-gray-700">ë°©ë²• A) AI ë‹µë³€ í‘œ ë¶™ì—¬ë„£ê¸° (ê¶Œì¥)</h2>
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                <button type="button"
                        id="copy-seed-quiz-prompt"
                        class="w-full sm:w-auto px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg text-xs font-bold hover:bg-indigo-200 transition-colors whitespace-nowrap text-center">
                    ìš”ì²­ë¬¸ ë³µì‚¬
                </button>
                <button type="button"
                        id="copy-seed-quiz-template"
                        class="w-full sm:w-auto px-3 py-2 bg-violet-100 text-violet-700 rounded-lg text-xs font-bold hover:bg-violet-200 transition-colors whitespace-nowrap text-center">
                    ì…ë ¥ í˜•ì‹ í•œ ì¤„ ë³µì‚¬
                </button>
            </div>
        </div>
        <div class="mb-3 p-4 rounded-xl bg-violet-50 border border-violet-200">
            <p class="text-sm font-black text-violet-900">âœ¨ AIë¡œ ìˆœì‹ê°„ì— í€´ì¦ˆ ë§Œë“¤ê¸° (GPT / GEMS í™œìš©ë²•)</p>
            <ol class="mt-2 text-xs sm:text-sm text-violet-800 space-y-1.5 list-decimal pl-5">
                <li>
                    <strong>[ìš”ì²­ë¬¸ ë³µì‚¬]</strong>ë¥¼ ëˆŒëŸ¬ GPT/GEMS ì§€ì¹¨(Instructions)ì— ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤.
                </li>
                <li>
                    AIì—ê²Œ ì›í•˜ëŠ” ì¡°ê±´ì„ ì£¼ë¬¸í•©ë‹ˆë‹¤. ì˜ˆ: <code>ì´ˆ3 ë§ì¶¤ë²• 20ë¬¸í•­</code>
                </li>
                <li>
                    AIê°€ ë§Œë“  í‘œ ì „ì²´ë¥¼ ì•„ë˜ ì…ë ¥ì¹¸ì— ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤.
                </li>
                <li>
                    <strong>[í˜•ì‹ë§Œ í™•ì¸]</strong> ë˜ëŠ” <strong>[ë¬¸ì œ ë§Œë“¤ê¸°(ë°”ë¡œ ì €ì¥)]</strong>ì„ ì„ íƒí•©ë‹ˆë‹¤.
                </li>
                <li>
                    ì €ì¥ í›„ <strong>[í•™ìƒì—ê²Œ ë°°í¬í•˜ê¸°]</strong>ë¡œ ìˆ˜ì—…ì— ë°”ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                </li>
            </ol>
            <details class="mt-3">
                <summary class="cursor-pointer text-xs font-bold text-violet-700">ìì„¸í•œ 6ë‹¨ê³„ ì•ˆë‚´ ë³´ê¸°</summary>
                <ol class="mt-2 text-xs text-violet-800 space-y-1.5 list-decimal pl-5">
                    <li><strong>ë‚˜ë§Œì˜ í€´ì¦ˆ ë„ìš°ë¯¸ ë§Œë“¤ê¸°</strong> ChatGPTì˜ GPTs ë˜ëŠ” Geminiì˜ Gems ë§Œë“¤ê¸° í™”ë©´ì„ ì—½ë‹ˆë‹¤.</li>
                    <li><strong>AIì—ê²Œ í€´ì¦ˆ ìƒì„± ê·œì¹™ ì•Œë ¤ì£¼ê¸°</strong> ìœ„ìª½ì˜ [ìš”ì²­ë¬¸ ë³µì‚¬] ë²„íŠ¼ì„ í´ë¦­í•œ ë’¤, ì„ ìƒë‹˜ì´ ë§Œë“œì‹  AI ì„¤ì •ì˜ ì§€ì¹¨(Instructions) ì¹¸ì— ë³µì‚¬í•œ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤.</li>
                    <li><strong>ì›í•˜ëŠ” í€´ì¦ˆ ì¡°ê±´ ì£¼ë¬¸í•˜ê¸°</strong> ì™„ì„±ëœ AIì™€ ëŒ€í™”í•˜ë©° ì¡°ê±´ì„ ììœ ë¡­ê²Œ ì…ë ¥í•©ë‹ˆë‹¤. (ì˜ˆì‹œ: ì´ˆë“±í•™êµ 3í•™ë…„ ìˆ˜ì¤€ ë§ì¶¤ë²• í€´ì¦ˆ 20ë¬¸ì œ)</li>
                    <li><strong>ì™„ì„±ëœ ë¬¸ì œ ê°€ì ¸ì˜¤ê¸°</strong> AIê°€ ì¡°ê±´ì— ë§ì¶° ë§Œë“¤ì–´ ì¤€ í‘œ ì „ì²´ë¥¼ ë³µì‚¬í•´ ì•„ë˜ [ì…ë ¥ì¹¸]ì— ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤.</li>
                    <li><strong>í€´ì¦ˆ ì ê²€ ë° ì €ì¥í•˜ê¸°</strong> [í˜•ì‹ë§Œ í™•ì¸]ì€ ì‚¬ì „ ì ê²€, [ë¬¸ì œ ë§Œë“¤ê¸°(ë°”ë¡œ ì €ì¥)]ì€ ì¦‰ì‹œ ì €ì¥ì…ë‹ˆë‹¤.</li>
                    <li><strong>ìš°ë¦¬ ë°˜ í•™ìƒë“¤ê³¼ ìˆ˜ì—…í•˜ê¸°</strong> ì €ì¥ ì™„ë£Œ í›„ [í•™ìƒì—ê²Œ ë°°í¬í•˜ê¸°] ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ì—…ì— í™œìš©í•©ë‹ˆë‹¤.</li>
                </ol>
            </details>
        </div>
        <form id="text-upload-form"
              hx-post="{% url 'seed_quiz:htmx_text_upload' classroom_id=classroom.id %}"
              hx-target="#csv-upload-result"
              hx-swap="innerHTML"
              hx-indicator="#text-upload-indicator"
              class="space-y-3">
            {% csrf_token %}
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ë¬¸ì œ ë‚´ìš©</label>
                <textarea name="pasted_text"
                          rows="8"
                          required
                          placeholder="GPT/GEMS ë˜ëŠ” ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ í‘œ ì „ì²´ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."
                          class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white resize-y"></textarea>
            </div>
            <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                <button type="submit"
                        name="submit_mode"
                        value="save"
                        class="w-full sm:w-auto px-5 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-lg text-sm text-center font-bold hover:shadow-md transition-all whitespace-nowrap">
                    ë¬¸ì œ ë§Œë“¤ê¸°(ë°”ë¡œ ì €ì¥)
                </button>
                <button type="submit"
                        name="submit_mode"
                        value="preview"
                        class="w-full sm:w-auto px-4 py-2 bg-white border border-violet-200 text-violet-700 rounded-lg text-sm text-center font-bold hover:bg-violet-50 transition-colors whitespace-nowrap">
                    í˜•ì‹ë§Œ í™•ì¸
                </button>
                <span id="text-upload-indicator" class="htmx-indicator text-xs text-violet-600 font-bold sm:ml-1">
                    ì²˜ë¦¬ ì¤‘...
                </span>
            </div>
        </form>
        <p class="mt-1 text-xs text-gray-400">
            ì´ ì¹¸ì€ ì‚¬ëŒì´ í•œ ì¤„ì”© ì“°ëŠ” ìš©ë„ê°€ ì•„ë‹ˆë¼, GPT/GEMSê°€ ë§Œë“  í‘œ ì „ì²´ë¥¼ í•œ ë²ˆì— ë¶™ì—¬ë„£ëŠ” ìš©ë„ì…ë‹ˆë‹¤. ìµœëŒ€ {{ text_limits.max_chars }}ì.
        </p>
    </div>

    <div id="csv-upload-result" class="mb-6"></div>

    {% if allow_rag %}
    <!-- ì œí•œí˜• RAG -->
    <div class="clay-card p-6 rounded-2xl mb-6">
        <h2 class="font-bold text-gray-700 mb-2">ì§€ë¬¸ ê¸°ë°˜ ë§ì¶¤ ìƒì„±</h2>
        <p class="text-xs text-gray-500 mb-4">êµì‹¤ë‹¹ í•˜ë£¨ {{ rag_daily_limit }}íšŒ ì œí•œ</p>
        <form hx-post="{% url 'seed_quiz:htmx_rag_generate' classroom_id=classroom.id %}"
              hx-target="#preview-area"
              hx-swap="innerHTML"
              class="space-y-3">
            {% csrf_token %}
            <div class="flex flex-wrap gap-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì£¼ì œ</label>
                    <select name="preset_type" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                        {% for value, label in preset_choices %}
                        <option value="{{ value }}" {% if value == generation_preset %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">í•™ë…„</label>
                    <select name="grade" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                        {% for g in "123456"|make_list %}
                        <option value="{{ g }}" {% if g == generation_grade %}selected{% endif %}>{{ g }}í•™ë…„</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ì§€ë¬¸ í…ìŠ¤íŠ¸ (20~4000ì)</label>
                <textarea name="source_text" rows="4"
                          placeholder="ì˜¤ëŠ˜ ìˆ˜ì—…í•œ ì§€ë¬¸ì´ë‚˜ í•µì‹¬ ë¬¸ì¥ì„ ë¶™ì—¬ ë„£ì–´ ì£¼ì„¸ìš”."
                          class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white resize-y"
                          required></textarea>
            </div>
            <button type="submit"
                    class="px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all">
                ë§ì¶¤ í€´ì¦ˆ ë§Œë“¤ê¸°
            </button>
        </form>
    </div>
    {% endif %}

    <!-- ë¬¸ì œ ê°€ì ¸ì˜¤ê¸° + ì€í–‰ ëª©ë¡ -->
    <div class="clay-card p-6 rounded-2xl mb-6">
        <h2 class="font-bold text-gray-700 mb-2">B) ê¸°ì¡´ ë¬¸ì œ ê°€ì ¸ì˜¤ê¸° Â· í€´ì¦ˆ ì€í–‰ ëª©ë¡</h2>
        <p class="text-sm text-gray-500 mb-1">ì €ì¥ëœ ì„¸íŠ¸ë¥¼ ì°¾ê³  ë°”ë¡œ ì•„ë˜ ëª©ë¡ì—ì„œ ì ìš©í•˜ì„¸ìš”.</p>
        <p class="text-xs text-gray-400 mb-4">ì „ì²´ ë³´ê¸°ì—ì„œë„ ë‚´ê°€ ë§Œë“  ìµœì‹  ì„¸íŠ¸ê°€ ë¨¼ì € ë³´ì´ë„ë¡ ì •ë ¬ë©ë‹ˆë‹¤.</p>
        <form id="bank-filter-form"
              hx-get="{% url 'seed_quiz:htmx_bank_browse' classroom_id=classroom.id %}"
              hx-target="#bank-area"
              hx-swap="innerHTML"
              hx-indicator="#bank-spinner"
              class="grid grid-cols-1 md:grid-cols-[auto_auto_1fr_auto] gap-3 items-end">
            {% csrf_token %}
            <input type="hidden" name="scope" value="all">

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ì£¼ì œ</label>
                <select name="preset_type" class="w-full md:w-auto min-w-[140px] px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    <option value="all" {% if not initial_preset %}selected{% endif %}>ì „ì²´</option>
                    {% for value, label in preset_choices %}
                    <option value="{{ value }}" {% if value == initial_preset %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">í•™ë…„</label>
                <select name="grade" class="w-full md:w-auto min-w-[110px] px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    <option value="all" {% if initial_grade_str == "all" %}selected{% endif %}>ì „ì²´</option>
                    {% for g in "123456"|make_list %}
                    <option value="{{ g }}" {% if g == initial_grade_str %}selected{% endif %}>{{ g }}í•™ë…„</option>
                    {% endfor %}
                </select>
            </div>

            <div class="min-w-[220px]">
                <label class="block text-xs font-bold text-gray-500 mb-1">ê²€ìƒ‰</label>
                <input type="text"
                       name="q"
                       value="{{ initial_query }}"
                       placeholder="ì„¸íŠ¸ ì œëª©/ë¬¸í•­ ë‚´ìš© ê²€ìƒ‰"
                       class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
            </div>

            <button type="submit" class="inline-flex items-center justify-center w-full md:w-auto px-5 py-2.5 bg-gradient-to-r from-indigo-600 to-sky-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all whitespace-nowrap shrink-0 gap-2">
                <span id="bank-spinner" class="htmx-indicator">
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </span>
                ì€í–‰ ì¡°íšŒ
            </button>
        </form>
        <div id="bank-query-feedback"
              class="mt-2 hidden rounded-lg border border-indigo-100 bg-indigo-50 px-3 py-2 text-xs font-bold text-indigo-700"
              role="status"
              aria-live="polite"></div>

        <div id="bank-area" class="mt-4"
             hx-get="{% url 'seed_quiz:htmx_bank_browse' classroom_id=classroom.id %}"
             hx-trigger="load, bankUpdated from:body"
             hx-include="#bank-filter-form"
             hx-swap="innerHTML">
            <p class="text-sm text-gray-400">í€´ì¦ˆ ì€í–‰ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
    <div id="preview-area" class="mb-6"></div>

    <!-- ì£¼ì œë³„ ìš´ì˜ ìš”ì•½ -->
    <div class="clay-card p-6 rounded-2xl mb-6"
         hx-get="{% url 'seed_quiz:htmx_topic_summary' classroom_id=classroom.id %}"
         hx-trigger="load, every 30s"
         hx-swap="innerHTML">
        <p class="text-sm text-gray-400">ì£¼ì œë³„ ìš”ì•½ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

</div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    const pasteSection = document.getElementById('input-method-paste');
    const fileSection = document.getElementById('input-method-file');
    const modeButtons = Array.from(document.querySelectorAll('[data-input-method]'));
    if (!pasteSection || !fileSection || !modeButtons.length) {
        return;
    }

    function applyButtonState(button, selected) {
        button.classList.remove(
            'bg-violet-600', 'text-white',
            'bg-white', 'border', 'border-violet-200', 'text-violet-700', 'hover:bg-violet-100'
        );
        if (selected) {
            button.classList.add('bg-violet-600', 'text-white');
        } else {
            button.classList.add('bg-white', 'border', 'border-violet-200', 'text-violet-700', 'hover:bg-violet-100');
        }
    }

    function setMode(mode) {
        const showPaste = mode !== 'file';
        pasteSection.classList.toggle('hidden', !showPaste);
        fileSection.classList.toggle('hidden', showPaste);
        modeButtons.forEach((button) => {
            applyButtonState(button, button.dataset.inputMethod === (showPaste ? 'paste' : 'file'));
        });
    }

    modeButtons.forEach((button) => {
        button.addEventListener('click', function () {
            setMode(button.dataset.inputMethod || 'paste');
        });
    });

    setMode('paste');
})();

(function () {
    const form = document.getElementById('csv-upload-form');
    const input = document.getElementById('csv-file-input');
    const panel = document.getElementById('csv-client-check');
    if (!form || !input || !panel) {
        return;
    }

    const headerAliases = {
        preset_type: ['preset_type', 'ì£¼ì œ'],
        grade: ['grade', 'í•™ë…„'],
        question_text: ['question_text', 'ë¬¸ì œ', 'ë¬¸í•­'],
        choice_1: ['choice_1', 'ë³´ê¸°1', 'ë³´ê¸° 1'],
        choice_2: ['choice_2', 'ë³´ê¸°2', 'ë³´ê¸° 2'],
        choice_3: ['choice_3', 'ë³´ê¸°3', 'ë³´ê¸° 3'],
        choice_4: ['choice_4', 'ë³´ê¸°4', 'ë³´ê¸° 4'],
        correct_index: ['correct_index', 'ì •ë‹µë²ˆí˜¸', 'ì •ë‹µì¸ë±ìŠ¤', 'ì •ë‹µ'],
        explanation: ['explanation', 'í•´ì„¤'],
        difficulty: ['difficulty', 'ë‚œì´ë„']
    };
    const headerLabels = {
        preset_type: 'ì£¼ì œ',
        grade: 'í•™ë…„',
        question_text: 'ë¬¸ì œ',
        choice_1: 'ë³´ê¸°1',
        choice_2: 'ë³´ê¸°2',
        choice_3: 'ë³´ê¸°3',
        choice_4: 'ë³´ê¸°4',
        correct_index: 'ì •ë‹µë²ˆí˜¸',
        explanation: 'í•´ì„¤',
        difficulty: 'ë‚œì´ë„'
    };
    const requiredHeaders = [
        'preset_type', 'grade', 'question_text',
        'choice_1', 'choice_2', 'choice_3', 'choice_4', 'correct_index'
    ];
    const aliasToCanonical = new Map();
    Object.keys(headerAliases).forEach((canonical) => {
        headerAliases[canonical].forEach((alias) => {
            aliasToCanonical.set(String(alias || '').trim().toLowerCase(), canonical);
        });
    });
    const maxFileBytes = parseInt(form.dataset.maxFileBytes || '0', 10) || 0;
    const maxRows = parseInt(form.dataset.maxRows || '0', 10) || 0;
    const presetCanonicalMap = new Map();
    Array.from(document.querySelectorAll('#bank-filter-form select[name="preset_type"] option'))
        .forEach((opt) => {
            const key = (opt.value || '').trim().toLowerCase();
            const label = (opt.textContent || '').trim().toLowerCase();
            if (key && key !== 'all') {
                presetCanonicalMap.set(key, key);
            }
            if (label && key !== 'all') {
                presetCanonicalMap.set(label, key || label);
            }
        });
    const allowedPresetTypes = new Set(Array.from(presetCanonicalMap.keys()));

    function normalizeHeaderName(raw) {
        const normalized = String(raw || '').trim().toLowerCase();
        if (!normalized) {
            return '';
        }
        return aliasToCanonical.get(normalized) || normalized;
    }

    function humanizeBytes(num) {
        let value = Number(num) || 0;
        const units = ['B', 'KB', 'MB', 'GB'];
        let unitIdx = 0;
        while (value >= 1024 && unitIdx < units.length - 1) {
            value /= 1024;
            unitIdx += 1;
        }
        if (unitIdx === 0) {
            return String(Math.floor(value)) + units[unitIdx];
        }
        return value.toFixed(1) + units[unitIdx];
    }

    function setState(state) {
        form.dataset.clientCheckState = state;
    }

    function escapeHtml(text) {
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function showInfo(message) {
        panel.className = 'mt-2 rounded-lg border border-slate-200 bg-slate-50 text-slate-700 text-xs p-3';
        panel.innerHTML = '<p class="font-bold">ë¸Œë¼ìš°ì € 1ì°¨ ê²€ì‚¬</p><p class="mt-1">' + escapeHtml(message) + '</p>';
    }

    function showErrors(errors) {
        const visible = errors.slice(0, 6).map((e) => '<li>' + escapeHtml(e) + '</li>').join('');
        const more = errors.length > 6 ? '<p class="mt-2 text-[11px]">ì™¸ ' + (errors.length - 6) + 'ê±´</p>' : '';
        panel.className = 'mt-2 rounded-lg border border-amber-200 bg-amber-50 text-amber-700 text-xs p-3';
        panel.innerHTML = (
            '<p class="font-bold">ë¸Œë¼ìš°ì € 1ì°¨ ê²€ì‚¬ì—ì„œ ìˆ˜ì • í•„ìš” í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.</p>' +
            '<ul class="list-disc pl-5 mt-1 space-y-0.5">' + visible + '</ul>' +
            more
        );
    }

    function hidePanel() {
        panel.className = 'mt-2 hidden';
        panel.innerHTML = '';
    }

    function parseCsv(text) {
        const rows = [];
        let row = [];
        let cell = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i += 1) {
            const ch = text[i];
            if (ch === '"') {
                if (inQuotes && text[i + 1] === '"') {
                    cell += '"';
                    i += 1;
                } else {
                    inQuotes = !inQuotes;
                }
                continue;
            }
            if (!inQuotes && ch === ',') {
                row.push(cell);
                cell = '';
                continue;
            }
            if (!inQuotes && (ch === '\n' || ch === '\r')) {
                if (ch === '\r' && text[i + 1] === '\n') {
                    i += 1;
                }
                row.push(cell);
                rows.push(row);
                row = [];
                cell = '';
                continue;
            }
            cell += ch;
        }
        if (cell.length > 0 || row.length > 0) {
            row.push(cell);
            rows.push(row);
        }
        return rows;
    }

    function isGuideRow(raw) {
        if (!raw || !raw.length) {
            return false;
        }
        const firstNonEmpty = raw
            .map((v) => String(v || '').trim())
            .find((v) => v.length > 0);
        if (!firstNonEmpty) {
            return false;
        }
        return firstNonEmpty.startsWith('#') || firstNonEmpty.startsWith('â€»');
    }

    function validateRows(rows) {
        const errors = [];
        const maxErrors = 120;
        let isOverflow = false;
        let dataRowsCount = 0;
        let basePreset = '';
        let baseGrade = '';

        function addError(msg) {
            if (errors.length < maxErrors) {
                errors.push(msg);
            } else {
                isOverflow = true;
            }
        }

        if (!rows.length) {
            return ['CSV ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'];
        }

        const headers = rows[0].map((h) => normalizeHeaderName(h));
        const headerIndex = {};
        headers.forEach((h, idx) => {
            if (!h) {
                return;
            }
            if (!(h in headerIndex)) {
                headerIndex[h] = idx;
            }
        });

        requiredHeaders.forEach((col) => {
            if (!(col in headerIndex)) {
                addError('í•„ìˆ˜ í—¤ë” ëˆ„ë½: ' + (headerLabels[col] || col));
            }
        });
        if (errors.length) {
            return errors;
        }

        for (let i = 1; i < rows.length; i += 1) {
            const raw = rows[i];
            if (!raw || !raw.length || raw.every((v) => String(v || '').trim() === '')) {
                continue;
            }
            if (isGuideRow(raw)) {
                continue;
            }
            dataRowsCount += 1;
            if (maxRows && dataRowsCount > maxRows) {
                addError('CSV í–‰ ìˆ˜ê°€ ì œí•œ(' + maxRows + 'í–‰)ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.');
                break;
            }

            const lineNo = i + 1;
            const get = (key) => (raw[headerIndex[key]] || '').trim();
            const presetRaw = get('preset_type');
            const presetCanonical = presetCanonicalMap.get(String(presetRaw).toLowerCase()) || String(presetRaw).toLowerCase();
            const gradeRaw = get('grade');

            requiredHeaders.forEach((col) => {
                if (!get(col)) {
                    addError(lineNo + 'í–‰: ' + (headerLabels[col] || col) + ' ê°’ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
                }
            });

            const choices = [get('choice_1'), get('choice_2'), get('choice_3'), get('choice_4')];
            const nonEmptyChoices = choices.filter(Boolean);
            if (nonEmptyChoices.length === 4 && new Set(nonEmptyChoices).size !== 4) {
                addError(lineNo + 'í–‰: ì„ íƒì§€ ì¤‘ë³µì´ ìˆìŠµë‹ˆë‹¤.');
            }

            const ci = get('correct_index');
            if (ci && !/^[1-4]$/.test(ci)) {
                addError(lineNo + 'í–‰: ì •ë‹µë²ˆí˜¸ëŠ” 1~4ì´ì–´ì•¼ í•©ë‹ˆë‹¤ (ë³´ê¸°1=1, ë³´ê¸°2=2, ë³´ê¸°3=3, ë³´ê¸°4=4).');
            }

            if (presetRaw && !allowedPresetTypes.has(String(presetRaw).toLowerCase())) {
                addError(lineNo + 'í–‰: ì£¼ì œê°€ í—ˆìš© ëª©ë¡ì— ì—†ìŠµë‹ˆë‹¤ (' + presetRaw + ')');
            }
            if (gradeRaw && gradeRaw !== 'í•™ë…„ë¬´ê´€' && !/^[0-6]$/.test(gradeRaw)) {
                addError(lineNo + 'í–‰: í•™ë…„ì€ 0~6 ë˜ëŠ” í•™ë…„ë¬´ê´€ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            }

            if (!basePreset && presetCanonical) {
                basePreset = presetCanonical;
            } else if (basePreset && presetCanonical && presetCanonical !== basePreset) {
                addError('í•œ íŒŒì¼ì˜ ì£¼ì œëŠ” ëª¨ë‘ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤. (' + lineNo + 'í–‰)');
            }
            if (!baseGrade && gradeRaw) {
                baseGrade = gradeRaw;
            } else if (baseGrade && gradeRaw && gradeRaw !== baseGrade) {
                addError('í•œ íŒŒì¼ì˜ í•™ë…„ì€ ëª¨ë‘ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤. (' + lineNo + 'í–‰)');
            }
        }

        if (dataRowsCount === 0) {
            addError('ì—…ë¡œë“œ ê°€ëŠ¥í•œ ì‹¤ì œ ë¬¸í•­ í–‰ì´ ì—†ìŠµë‹ˆë‹¤. ì•ˆë‚´í–‰(#ê°€ì´ë“œ) ì•„ë˜ì— ë¬¸í•­ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        }

        if (isOverflow) {
            errors.push('ì˜¤ë¥˜ê°€ ë§ì•„ ì²˜ìŒ 120ê±´ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.');
        }
        return errors;
    }

    function runClientCheck(callback) {
        const file = input.files && input.files[0];
        if (!file) {
            setState('invalid');
            showErrors(['CSV íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.']);
            if (callback) callback(false);
            return;
        }
        if (maxFileBytes && file.size > maxFileBytes) {
            setState('invalid');
            showErrors([
                'CSV íŒŒì¼ ìš©ëŸ‰ì´ ì œí•œì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. (ìµœëŒ€ ' + humanizeBytes(maxFileBytes) + ')'
            ]);
            if (callback) callback(false);
            return;
        }

        const reader = new FileReader();
        setState('checking');
        showInfo('íŒŒì¼ êµ¬ì¡°ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...');
        reader.onload = function (event) {
            try {
                const text = String(event.target && event.target.result ? event.target.result : '');
                const rows = parseCsv(text);
                const errors = validateRows(rows);
                if (errors.length) {
                    setState('invalid');
                    showErrors(errors);
                    if (callback) callback(false);
                    return;
                }
                setState('valid');
                showInfo('1ì°¨ ê²€ì‚¬ í†µê³¼. ì„œë²„ ê²€ì¦ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                if (callback) callback(true);
            } catch (e) {
                setState('invalid');
                showErrors(['ë¸Œë¼ìš°ì € ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°”ë¡œ ì—…ë¡œë“œí•´ ì„œë²„ ê²€ì¦ì„ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.']);
                if (callback) callback(false);
            }
        };
        reader.onerror = function () {
            setState('invalid');
            showErrors(['íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.']);
            if (callback) callback(false);
        };
        reader.readAsText(file, 'utf-8');
    }

    input.addEventListener('change', function () {
        if (!input.files || !input.files.length) {
            setState('idle');
            hidePanel();
            return;
        }
        runClientCheck();
    });

    form.addEventListener('submit', function (event) {
        const state = form.dataset.clientCheckState || 'idle';
        if (state === 'valid') {
            return;
        }
        event.preventDefault();
        if (state === 'checking') {
            showInfo('ê²€ì‚¬ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.');
            return;
        }
        runClientCheck(function (ok) {
            if (ok) {
                form.requestSubmit();
            } else {
                showErrors(['1ì°¨ ê²€ì‚¬ ì˜¤ë¥˜ë¥¼ ë¨¼ì € ìˆ˜ì •í•œ ë’¤ ë‹¤ì‹œ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.']);
            }
        });
    });
})();

(function () {
    const templateBtn = document.getElementById('copy-seed-quiz-template');
    const promptBtn = document.getElementById('copy-seed-quiz-prompt');
    if (!templateBtn && !promptBtn) {
        return;
    }
    const header = 'ì£¼ì œ\tí•™ë…„\të¬¸ì œ\të³´ê¸°1\të³´ê¸°2\të³´ê¸°3\të³´ê¸°4\tì •ë‹µë²ˆí˜¸\tí•´ì„¤\të‚œì´ë„';
    const topicOptionLabels = Array.from(
        document.querySelectorAll('#bank-filter-form select[name="preset_type"] option')
    )
        .map((option) => String(option.textContent || '').trim())
        .filter(Boolean);
    const allowedTopicGuide = topicOptionLabels.length
        ? topicOptionLabels.join(', ')
        : 'ë§ì¶¤ë²•, ë„ì–´ì“°ê¸°, ì–´íœ˜ ëœ»';
    const promptTemplate = [
        'ë„ˆëŠ” eduitit ì”¨ì•— í€´ì¦ˆ ì—…ë¡œë“œ ì „ìš© ìƒì„±ê¸°ë‹¤.',
        '',
        '[ëª©í‘œ]',
        '- ì‚¬ìš©ìê°€ ì¤€ ì£¼ì œ, í•™ë…„, ë¬¸í•­ ìˆ˜ì— ë§ì¶° ê°ê´€ì‹ 4ì§€ì„ ë‹¤ í€´ì¦ˆë¥¼ ë§Œë“ ë‹¤.',
        '',
        '[ì¶œë ¥ ì ˆëŒ€ ê·œì¹™]',
        '- ì˜¤ì§ TSV í‰ë¬¸ë§Œ ì¶œë ¥í•œë‹¤.',
        '- ë§ˆí¬ë‹¤ìš´, ì½”ë“œë¸”ë¡, ì„¤ëª… ë¬¸ì¥, ë²ˆí˜¸/ë¶ˆë¦¿, JSON, CSVë¥¼ ì¶œë ¥í•˜ì§€ ì•ŠëŠ”ë‹¤.',
        '- ì²« ì¤„ í—¤ë”ëŠ” ë°˜ë“œì‹œ ì•„ë˜ì™€ ë™ì¼í•˜ê²Œ ì¶œë ¥í•œë‹¤.',
        header,
        '- 2ì¤„ì§¸ë¶€í„°ëŠ” ë¬¸í•­ ë°ì´í„°ë§Œ ì¶œë ¥í•œë‹¤.',
        '- êµ¬ë¶„ìëŠ” íƒ­(Tab)ë§Œ ì‚¬ìš©í•œë‹¤.',
        '',
        '[ë°ì´í„° ê·œì¹™]',
        '- ê° í–‰ì€ ì •í™•íˆ 10ì—´ì´ì–´ì•¼ í•œë‹¤: ì£¼ì œ, í•™ë…„, ë¬¸ì œ, ë³´ê¸°1, ë³´ê¸°2, ë³´ê¸°3, ë³´ê¸°4, ì •ë‹µë²ˆí˜¸, í•´ì„¤, ë‚œì´ë„',
        '- í•œ ë²ˆì˜ ì¶œë ¥ì—ì„œ ëª¨ë“  í–‰ì˜ ì£¼ì œëŠ” ë™ì¼í•´ì•¼ í•œë‹¤.',
        '- í•œ ë²ˆì˜ ì¶œë ¥ì—ì„œ ëª¨ë“  í–‰ì˜ í•™ë…„ì€ ë™ì¼í•´ì•¼ í•œë‹¤.',
        '- ë³´ê¸°1~ë³´ê¸°4ëŠ” ëª¨ë‘ ë¹„ì–´ ìˆì§€ ì•Šì•„ì•¼ í•˜ê³  ì„œë¡œ ë‹¬ë¼ì•¼ í•œë‹¤.',
        '- ì •ë‹µë²ˆí˜¸ëŠ” 1~4 ìˆ«ìë§Œ ì‚¬ìš©í•œë‹¤. (ë³´ê¸°1=1, ë³´ê¸°2=2, ë³´ê¸°3=3, ë³´ê¸°4=4)',
        '- ë‚œì´ë„ëŠ” ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€ ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©í•œë‹¤.',
        '- í•´ì„¤ì€ 1ë¬¸ì¥ìœ¼ë¡œ ì§§ê³  ëª…í™•í•˜ê²Œ ì‘ì„±í•œë‹¤.',
        '',
        '[ìƒì„± ê·œì¹™]',
        '- ì£¼ì œëŠ” ë°˜ë“œì‹œ ì•„ë˜ í—ˆìš© ëª©ë¡ ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©í•œë‹¤: ' + allowedTopicGuide,
        '- ì‚¬ìš©ìê°€ ì¤€ ì£¼ì œê°€ í—ˆìš© ëª©ë¡ ë°–ì´ë©´ ê°€ì¥ ê°€ê¹Œìš´ í—ˆìš© ì£¼ì œë¡œ ë°”ê¿”ì„œ ë„£ëŠ”ë‹¤.',
        '- í•™ë…„ì€ 1, 2, 3, 4, 5, 6 ë˜ëŠ” í•™ë…„ë¬´ê´€(0)ë§Œ ì‚¬ìš©í•œë‹¤.',
        '- í•™ë…„ì´ ì´ˆ3/3í•™ë…„/grade3/g3 í˜•íƒœë¼ë©´ 3ìœ¼ë¡œ ì •ê·œí™”í•œë‹¤.',
        '- ìš”ì²­í•œ ë¬¸í•­ ìˆ˜ë¥¼ ì •í™•íˆ ë§ì¶˜ë‹¤.',
        '',
        '[ê²€ì¦ ê·œì¹™]',
        '- ì¶œë ¥ ì „ ìŠ¤ìŠ¤ë¡œ í˜•ì‹ì„ ê²€ì¦í•˜ê³ , ìœ„ë°˜ì´ ìˆìœ¼ë©´ ìˆ˜ì •í•œ ë’¤ ìµœì¢…ë³¸ë§Œ ì¶œë ¥í•œë‹¤.',
        '- ìµœì¢… ì¶œë ¥ì—ëŠ” ë°ì´í„° ì™¸ ì–´ë–¤ ë¬¸ì¥ë„ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.',
        '',
        'ìš”ì²­ê°’ ì…ë ¥ í˜•ì‹(ì˜ˆì‹œ):',
        'ì£¼ì œ: ë§ì¶¤ë²•',
        'í•™ë…„: 3',
        'ë¬¸í•­ ìˆ˜: 20',
        'ë‚œì´ë„ ë¶„í¬: ì‰¬ì›€ 7, ë³´í†µ 8, ì–´ë ¤ì›€ 5',
    ].join('\n');

    function flashButtonState(button, idleText, successText, failText, idleClass, successClass, failClass) {
        return function (ok) {
            button.textContent = ok ? successText : failText;
            button.classList.remove(...idleClass, ...successClass, ...failClass);
            button.classList.add(...(ok ? successClass : failClass));
            window.setTimeout(function () {
                button.textContent = idleText;
                button.classList.remove(...successClass, ...failClass);
                button.classList.add(...idleClass);
            }, 1200);
        };
    }

    if (templateBtn) {
        const flash = flashButtonState(
            templateBtn,
            'ì…ë ¥ í˜•ì‹ í•œ ì¤„ ë³µì‚¬',
            'ë³µì‚¬ ì™„ë£Œ',
            'ë³µì‚¬ ì‹¤íŒ¨',
            ['bg-violet-100', 'text-violet-700'],
            ['bg-emerald-100', 'text-emerald-700'],
            ['bg-red-100', 'text-red-700']
        );
        templateBtn.addEventListener('click', async function () {
            try {
                await navigator.clipboard.writeText(header + '\n');
                flash(true);
            } catch (e) {
                flash(false);
            }
        });
    }

    if (promptBtn) {
        const flash = flashButtonState(
            promptBtn,
            'ìš”ì²­ë¬¸ ë³µì‚¬',
            'ë³µì‚¬ ì™„ë£Œ',
            'ë³µì‚¬ ì‹¤íŒ¨',
            ['bg-indigo-100', 'text-indigo-700'],
            ['bg-emerald-100', 'text-emerald-700'],
            ['bg-red-100', 'text-red-700']
        );
        promptBtn.addEventListener('click', async function () {
            try {
                await navigator.clipboard.writeText(promptTemplate);
                flash(true);
            } catch (e) {
                flash(false);
            }
        });
    }
})();

(function () {
    const bankForm = document.getElementById('bank-filter-form');
    const bankArea = document.getElementById('bank-area');
    const feedback = document.getElementById('bank-query-feedback');
    if (!bankForm || !bankArea || !feedback) {
        return;
    }

    let shouldScrollToResult = false;
    let shouldFocusFirstApply = false;
    let feedbackTimer = null;

    function isBankFormRequestElement(element) {
        return !!(element && (element === bankForm || bankForm.contains(element)));
    }

    function resolveTargetElement(detail) {
        if (!detail) {
            return null;
        }
        const targetRaw = detail.target || (detail.requestConfig ? detail.requestConfig.target : null);
        if (!targetRaw) {
            return null;
        }
        if (typeof targetRaw === 'string') {
            return document.querySelector(targetRaw);
        }
        return targetRaw && targetRaw.nodeType === 1 ? targetRaw : null;
    }

    function buildFeedbackMessage(totalCount, queryText) {
        const count = Number.isFinite(totalCount) ? Math.max(0, Math.floor(totalCount)) : 0;
        const query = String(queryText || '').trim();
        if (query) {
            return '"' + query + '" ê²€ìƒ‰ ê²°ê³¼ ' + count + 'ì„¸íŠ¸ ì¡°íšŒë¨';
        }
        return 'ì´ ' + count + 'ì„¸íŠ¸ ì¡°íšŒë¨';
    }

    function showFeedback(message) {
        feedback.textContent = message;
        feedback.classList.remove('hidden');
        if (feedbackTimer) {
            window.clearTimeout(feedbackTimer);
        }
        feedbackTimer = window.setTimeout(function () {
            feedback.classList.add('hidden');
            feedback.textContent = '';
        }, 4000);
    }

    document.body.addEventListener('htmx:beforeRequest', function (event) {
        const detail = event.detail || {};
        const requestElement = detail.elt || (detail.requestConfig ? detail.requestConfig.elt : null);
        const openBankRequest = !!(requestElement && requestElement.closest('[data-seed-quiz-open-bank]'));
        const fromBankFilter = isBankFormRequestElement(requestElement);
        if (!fromBankFilter && !openBankRequest) {
            return;
        }
        shouldScrollToResult = true;
        shouldFocusFirstApply = openBankRequest;
    });

    document.body.addEventListener('htmx:afterSwap', function (event) {
        if (!event || event.target !== bankArea) {
            return;
        }
        const summaryBox = bankArea.querySelector('[data-bank-result-count]');
        if (summaryBox) {
            const total = Number(summaryBox.dataset.bankResultCount || '0');
            const query = summaryBox.dataset.bankQuery || '';
            showFeedback(buildFeedbackMessage(total, query));
        }
        if (shouldScrollToResult) {
            shouldScrollToResult = false;
            bankArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        if (shouldFocusFirstApply) {
            shouldFocusFirstApply = false;
            const firstApplyButton = bankArea.querySelector('form[hx-post*="/htmx/bank/select/"] button[type="submit"]');
            if (firstApplyButton) {
                showFeedback('ì•„ë˜ ëª©ë¡ì—ì„œ ì›í•˜ëŠ” ì„¸íŠ¸ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                window.setTimeout(function () {
                    try {
                        firstApplyButton.focus({ preventScroll: true });
                    } catch (_e) {
                        firstApplyButton.focus();
                    }
                }, 140);
            }
        }
    });
})();

(function () {
    const resultArea = document.getElementById('csv-upload-result');
    const previewArea = document.getElementById('preview-area');
    const bankArea = document.getElementById('bank-area');
    const textForm = document.getElementById('text-upload-form');
    const csvForm = document.getElementById('csv-upload-form');
    if (!resultArea || (!textForm && !csvForm)) {
        return;
    }

    function isOwnedRequestElement(element, ownerForm) {
        return !!(element && ownerForm && (element === ownerForm || ownerForm.contains(element)));
    }

    function isResultAreaRequestElement(element) {
        return !!(element && resultArea.contains(element));
    }

    function isPreviewAreaRequestElement(element) {
        return !!(element && previewArea && (element === previewArea || previewArea.contains(element)));
    }

    function resolveTargetElement(detail) {
        if (!detail) {
            return null;
        }
        const targetRaw = detail.target || (detail.requestConfig ? detail.requestConfig.target : null);
        if (!targetRaw) {
            return null;
        }
        if (typeof targetRaw === 'string') {
            return document.querySelector(targetRaw);
        }
        return targetRaw && targetRaw.nodeType === 1 ? targetRaw : null;
    }

    function showErrorAlertFromResultArea() {
        const errorBox = resultArea.querySelector('[data-seed-quiz-error="true"]');
        if (!errorBox) {
            return;
        }
        const lines = Array.from(errorBox.querySelectorAll('li'))
            .map(function (node) { return String(node.textContent || '').trim(); })
            .filter(Boolean);
        if (!lines.length) {
            window.alert('ë¬¸ì œ ë§Œë“¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í™”ë©´ì˜ ì˜¤ë¥˜ ë‚´ìš©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
            return;
        }
        const totalRaw = Number(errorBox.dataset.errorTotal || lines.length);
        const totalCount = Number.isFinite(totalRaw) && totalRaw > 0 ? Math.floor(totalRaw) : lines.length;
        const preview = lines.slice(0, 3).join('\n');
        const restCount = Math.max(0, totalCount - 3);
        const rest = restCount > 0 ? '\nì™¸ ' + restCount + 'ê±´' : '';
        window.alert('ë¬¸ì œ ë§Œë“¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì•„ë˜ í•­ëª©ì„ ìˆ˜ì • í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.\n\n' + preview + rest);
    }

    function openLatestPreviewFromResultArea() {
        const openButton = resultArea.querySelector('[data-open-latest-preview]');
        if (!openButton) {
            return;
        }
        window.setTimeout(function () {
            openButton.click();
        }, 80);
    }

    function scrollAndFocusPublishButton() {
        if (!previewArea) {
            return;
        }
        const publishButton = previewArea.querySelector('[data-seed-quiz-publish-button]');
        if (!publishButton) {
            return;
        }
        previewArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        window.setTimeout(function () {
            try {
                publishButton.focus({ preventScroll: true });
            } catch (_e) {
                publishButton.focus();
            }
        }, 220);
    }

    document.body.addEventListener('htmx:afterSwap', function (event) {
        if (!event || event.target !== resultArea) {
            return;
        }
        const successBox = resultArea.querySelector('[data-seed-quiz-success="true"]');
        if (successBox) {
            const title = successBox.dataset.successTitle || 'ë¬¸ì œ ë§Œë“¤ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            const created = successBox.dataset.createdCount || '0';
            const updated = successBox.dataset.updatedCount || '0';
            window.alert(title + '\nì‹ ê·œ ìƒì„± ' + created + 'ê°œ / ê¸°ì¡´ ê°±ì‹  ' + updated + 'ê°œ');
            openLatestPreviewFromResultArea();
            return;
        }
        showErrorAlertFromResultArea();
    });

    if (previewArea) {
        document.body.addEventListener('htmx:afterSwap', function (event) {
            if (!event || event.target !== previewArea) {
                return;
            }
            scrollAndFocusPublishButton();
        });
    }

    document.body.addEventListener('htmx:responseError', function (event) {
        const detail = event.detail || {};
        const requestElement = detail.elt || (detail.requestConfig ? detail.requestConfig.elt : null);
        const targetElement = resolveTargetElement(detail);
        const previewRequest = isPreviewAreaRequestElement(requestElement) || !!(targetElement && previewArea && targetElement === previewArea);
        if (
            !isOwnedRequestElement(requestElement, textForm) &&
            !isOwnedRequestElement(requestElement, csvForm) &&
            !isResultAreaRequestElement(requestElement) &&
            !previewRequest
        ) {
            return;
        }
        const xhr = detail.xhr;
        if (!xhr) {
            return;
        }
        if (previewRequest) {
            const previewTarget = targetElement || previewArea || bankArea;
            if (previewTarget && xhr.responseText) {
                previewTarget.innerHTML = xhr.responseText;
                previewTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else if (previewTarget) {
                previewTarget.innerHTML = (
                    '<div class="p-4 rounded-xl border border-red-200 bg-red-50 text-red-700 text-sm">' +
                    'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.' +
                    '</div>'
                );
            }
            const statusText = xhr.status ? '\nì˜¤ë¥˜ ì½”ë“œ: ' + xhr.status : '';
            window.alert('ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.' + statusText);
            return;
        }
        if (xhr.status === 400 && xhr.responseText) {
            resultArea.innerHTML = xhr.responseText;
            resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            showErrorAlertFromResultArea();
            return;
        }
        resultArea.innerHTML = (
            '<div class="p-4 rounded-xl border border-red-200 bg-red-50 text-red-700 text-sm">' +
            'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.' +
            '</div>'
        );
        window.alert('ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
    });
})();
</script>
{% endblock %}
