{% extends 'base.html' %}

{% block title %}ì”¨ì•— í€´ì¦ˆ â€” {{ classroom.name }}{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-4 min-h-screen">
<div class="max-w-4xl mx-auto">

    <!-- í—¤ë” -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <a href="{% url 'happy_seed:classroom_detail' classroom_id=classroom.id %}" class="text-sm text-gray-400 hover:text-gray-600">&larr; êµì‹¤ë¡œ ëŒì•„ê°€ê¸°</a>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mt-1">ğŸ“ ì”¨ì•— í€´ì¦ˆ</h1>
            <p class="text-sm text-gray-500">{{ classroom.name }} &middot; {{ classroom.school_name }}</p>
        </div>
    </div>

    <!-- 3ë‹¨ê³„ ì•ˆë‚´ -->
    <div class="clay-card p-6 rounded-2xl mb-6 border border-indigo-100 bg-indigo-50/40">
        <h2 class="font-bold text-indigo-800 mb-3">3ë‹¨ê³„ë¡œ ëë‚˜ìš”</h2>
        <div class="grid md:grid-cols-3 gap-3 text-sm">
            <div class="bg-white rounded-xl px-4 py-3 border border-indigo-100">
                <p class="font-bold text-indigo-700">1) ë¬¸ì œ ì¤€ë¹„</p>
                <p class="text-gray-600 mt-1">ë¬¸ì œë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ íŒŒì¼ë¡œ ì˜¬ë¦½ë‹ˆë‹¤.</p>
            </div>
            <div class="bg-white rounded-xl px-4 py-3 border border-indigo-100">
                <p class="font-bold text-indigo-700">2) ë¯¸ë¦¬ë³´ê¸° í™•ì¸</p>
                <p class="text-gray-600 mt-1">ë¬¸ì œ ìˆ˜ì™€ ì •ë‹µ ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.</p>
            </div>
            <div class="bg-white rounded-xl px-4 py-3 border border-indigo-100">
                <p class="font-bold text-indigo-700">3) í•™ìƒì—ê²Œ ë°°í¬</p>
                <p class="text-gray-600 mt-1">ë°°í¬ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í•™ìƒì´ ë°”ë¡œ í’€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- í€´ì¦ˆ ì€í–‰ ì„ íƒ ì¹´ë“œ -->
    <div class="clay-card p-6 rounded-2xl mb-6">
        <h2 class="font-bold text-gray-700 mb-4">ì˜¤ëŠ˜ì˜ í€´ì¦ˆ ì„ íƒ</h2>
        <p class="text-sm text-gray-500 mb-4">
            ê³µì‹/ê³µìœ  í€´ì¦ˆ ì€í–‰ì—ì„œ ì„ íƒí•´ ë°”ë¡œ ë°°í¬í•˜ì„¸ìš”.
        </p>
        <form id="bank-filter-form"
              hx-get="{% url 'seed_quiz:htmx_bank_browse' classroom_id=classroom.id %}"
              hx-target="#bank-area"
              hx-swap="innerHTML"
              hx-indicator="#bank-spinner"
              class="flex flex-wrap gap-3 items-end">
            {% csrf_token %}

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ë²”ìœ„</label>
                <select name="scope" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    <option value="mine">ë‚´ ì„¸íŠ¸</option>
                    <option value="official">ê³µì‹</option>
                    <option value="public">ê³µìœ </option>
                    <option value="all">ì „ì²´</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ì£¼ì œ</label>
                <select name="preset_type" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    {% for value, label in preset_choices %}
                    <option value="{{ value }}" {% if value == initial_preset %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">í•™ë…„</label>
                <select name="grade" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    <option value="all" {% if initial_grade_str == "all" %}selected{% endif %}>ì „ì²´</option>
                    <option value="0" {% if initial_grade_str == "0" %}selected{% endif %}>í•™ë…„ë¬´ê´€</option>
                    {% for g in "123456"|make_list %}
                    <option value="{{ g }}" {% if g == initial_grade_str %}selected{% endif %}>{{ g }}í•™ë…„</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="px-5 py-2 bg-gradient-to-r from-indigo-600 to-sky-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all flex items-center gap-2">
                <span id="bank-spinner" class="htmx-indicator">
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </span>
                ì€í–‰ ì¡°íšŒ
            </button>
            <button type="button"
                    hx-post="{% url 'seed_quiz:htmx_bank_random_select' classroom_id=classroom.id %}"
                    hx-include="#bank-filter-form"
                    hx-target="#preview-area"
                    hx-swap="innerHTML"
                    class="px-5 py-2 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all">
                ëœë¤ 1ì„¸íŠ¸ ì„ íƒ
            </button>
        </form>
    </div>

    <!-- íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="clay-card p-6 rounded-2xl mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="font-bold text-gray-700">ë¬¸ì œ íŒŒì¼ ì˜¬ë¦¬ê¸° (ì„ íƒ)</h2>
            <div class="flex items-center gap-2">
                <a href="{% url 'seed_quiz:download_csv_guide' classroom_id=classroom.id %}"
                   class="px-3 py-2 bg-emerald-100 text-emerald-700 rounded-lg text-xs font-bold hover:bg-emerald-200 transition-colors">
                    ì œì‘ ê°€ì´ë“œ ë³´ê¸°
                </a>
                <a href="{% url 'seed_quiz:download_xlsx_template' classroom_id=classroom.id %}"
                   class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-200 transition-colors">
                    XLSX í…œí”Œë¦¿
                </a>
                <a href="{% url 'seed_quiz:download_csv_template' classroom_id=classroom.id %}"
                   class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-bold hover:bg-gray-200 transition-colors">
                    CSV í…œí”Œë¦¿
                </a>
                <a href="{% url 'seed_quiz:download_csv_sample_pack' classroom_id=classroom.id %}"
                   class="px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg text-xs font-bold hover:bg-indigo-200 transition-colors">
                    ìƒ˜í”Œ íŒ© ë‹¤ìš´ë¡œë“œ
                </a>
            </div>
        </div>
        <form id="csv-upload-form"
              data-client-check-state="idle"
              data-max-file-bytes="{{ csv_limits.max_file_bytes }}"
              data-max-rows="{{ csv_limits.max_rows }}"
              hx-post="{% url 'seed_quiz:htmx_csv_upload' classroom_id=classroom.id %}"
              hx-encoding="multipart/form-data"
              hx-target="#csv-upload-result"
              hx-swap="innerHTML"
              class="flex flex-wrap items-end gap-3">
            {% csrf_token %}
            <div class="flex-1 min-w-[260px]">
                <label class="block text-xs font-bold text-gray-500 mb-1">ë¬¸ì œ íŒŒì¼</label>
                <input type="file"
                       id="csv-file-input"
                       name="csv_file"
                       accept=".csv,text/csv"
                       required
                       class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
            </div>
            <button type="submit"
                    class="px-5 py-2 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all">
                íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
            </button>
        </form>
        <p class="mt-2 text-xs text-gray-500">
            íŒŒì¼ ì²« ì¤„ì€ ì´ ìˆœì„œë¡œ ë§ì¶° ì£¼ì„¸ìš”: {{ csv_headers_ko_text }}
        </p>
        <p class="mt-1 text-xs text-gray-400">
            í•œ íŒŒì¼ì€ í•œ ì„¸íŠ¸ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ë¬¸ì œëŠ” 1~200ê°œê¹Œì§€ ë„£ì„ ìˆ˜ ìˆê³ , í•œ íŒŒì¼ ì•ˆì—ì„œëŠ” ê°™ì€ ì£¼ì œ/ê°™ì€ í•™ë…„ìœ¼ë¡œ ë§ì¶° ì£¼ì„¸ìš”.
        </p>
        <p class="mt-1 text-xs text-gray-400">
            íŒŒì¼ ì œí•œ: {{ csv_limits_human.max_file }} ì´í•˜ / ìµœëŒ€ {{ csv_limits_human.max_rows }}ë¬¸í•­
        </p>
        <div id="csv-client-check" class="mt-2 hidden"></div>
        <div id="csv-upload-result" class="mt-3"></div>
    </div>

    <!-- í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° ì—…ë¡œë“œ -->
    <div class="clay-card p-6 rounded-2xl mb-6">
        <div class="flex items-center justify-between mb-3">
            <h2 class="font-bold text-gray-700">1) ë¬¸ì œ ë¶™ì—¬ë„£ê¸° (ê°€ì¥ ì‰¬ìš´ ë°©ë²•)</h2>
            <button type="button"
                    id="copy-seed-quiz-template"
                    class="px-3 py-2 bg-violet-100 text-violet-700 rounded-lg text-xs font-bold hover:bg-violet-200 transition-colors">
                ë¶™ì—¬ë„£ê¸° ì–‘ì‹ ë³µì‚¬
            </button>
        </div>
        <form id="text-upload-form"
              hx-post="{% url 'seed_quiz:htmx_text_upload' classroom_id=classroom.id %}"
              hx-target="#csv-upload-result"
              hx-swap="innerHTML"
              class="space-y-3">
            {% csrf_token %}
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ë¬¸ì œ ë‚´ìš©</label>
                <textarea name="pasted_text"
                          rows="8"
                          required
                          placeholder="ë‹¤ë¥¸ í™”ë©´ì—ì„œ ë³µì‚¬í•œ ë¬¸ì œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."
                          class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white resize-y"></textarea>
            </div>
            <div class="flex items-center gap-2">
                <button type="submit"
                        class="px-5 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all">
                    ë¶™ì—¬ë„£ê¸° ë¯¸ë¦¬ë³´ê¸°
                </button>
            </div>
        </form>
        <p class="mt-2 text-xs text-gray-500">
            ì²« ì¤„ì— í•­ëª© ì´ë¦„(ì£¼ì œ, í•™ë…„, ë¬¸ì œ, ë³´ê¸°1~4, ì •ë‹µë²ˆí˜¸, í•´ì„¤, ë‚œì´ë„)ì´ ìˆìœ¼ë©´ ê°€ì¥ ì •í™•í•˜ê²Œ ì½ìŠµë‹ˆë‹¤.
        </p>
        <p class="mt-1 text-xs text-gray-400">
            í‘œ í˜•íƒœ ë¶™ì—¬ë„£ê¸°, ì¤„ë³„ ë¶™ì—¬ë„£ê¸° ëª¨ë‘ ê°€ëŠ¥í•©ë‹ˆë‹¤. ìµœëŒ€ {{ text_limits.max_chars }}ì.
        </p>
    </div>

    <!-- CSV ì—…ë¡œë“œ ì´ë ¥ -->
    <div class="clay-card p-6 rounded-2xl mb-6"
         hx-get="{% url 'seed_quiz:htmx_csv_history' classroom_id=classroom.id %}"
         hx-trigger="load, csvHistoryUpdated from:body, every 20s"
         hx-swap="innerHTML">
        <p class="text-sm text-gray-400">CSV ì—…ë¡œë“œ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ë‚´ ë¬¸ì œ ë³´ê´€í•¨ -->
    <div class="clay-card p-6 rounded-2xl mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="font-bold text-gray-700">ë‚´ ë¬¸ì œ ë³´ê´€í•¨ ì°¾ê¸°</h2>
                <p class="text-xs text-gray-500 mt-1">ì£¼ì œ/í•™ë…„/ë‚œì´ë„ë¡œ ì°¾ê³  ë‹¤ì‹œ ë°°í¬í•  ìˆ˜ ìˆì–´ìš”.</p>
            </div>
        </div>
        <form id="my-bank-filter-form"
              class="flex flex-wrap gap-3 items-end mb-4"
              hx-get="{% url 'seed_quiz:htmx_my_bank_library' classroom_id=classroom.id %}"
              hx-target="#my-bank-area"
              hx-swap="innerHTML">
            {% csrf_token %}
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ì£¼ì œ</label>
                <select name="preset_type" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    <option value="all">ì „ì²´</option>
                    {% for value, label in preset_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">í•™ë…„</label>
                <select name="grade" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    <option value="all">ì „ì²´</option>
                    <option value="0">í•™ë…„ë¬´ê´€</option>
                    {% for g in "123456"|make_list %}
                    <option value="{{ g }}">{{ g }}í•™ë…„</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ë‚œì´ë„</label>
                <select name="difficulty" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    <option value="all">ì „ì²´</option>
                    <option value="easy">ì‰¬ì›€ í¬í•¨</option>
                    <option value="medium">ë³´í†µ í¬í•¨</option>
                    <option value="hard">ì–´ë ¤ì›€ í¬í•¨</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ê¸°ê°„</label>
                <select name="period_days" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    <option value="all">ì „ì²´</option>
                    <option value="7">ìµœê·¼ 7ì¼</option>
                    <option value="30">ìµœê·¼ 30ì¼</option>
                    <option value="90">ìµœê·¼ 90ì¼</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ì •ë ¬</label>
                <select name="sort" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    <option value="latest">ìµœì‹ ìˆœ</option>
                    <option value="use_count">ì‚¬ìš© ë§ì€ ìˆœ</option>
                    <option value="oldest">ì˜¤ë˜ëœ ìˆœ</option>
                </select>
            </div>
            <div class="min-w-[220px] flex-1">
                <label class="block text-xs font-bold text-gray-500 mb-1">ê²€ìƒ‰</label>
                <input type="text"
                       name="q"
                       placeholder="ì„¸íŠ¸ ì œëª©/ë¬¸ì œ ë‚´ìš©"
                       class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
            </div>
            <button type="submit"
                    class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-sky-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all">
                ë³´ê´€í•¨ ì¡°íšŒ
            </button>
            <button type="button"
                    hx-post="{% url 'seed_quiz:htmx_my_bank_random_select' classroom_id=classroom.id %}"
                    hx-include="#my-bank-filter-form"
                    hx-target="#preview-area"
                    hx-swap="innerHTML"
                    class="px-4 py-2 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all">
                ì¡°ê±´ìœ¼ë¡œ ëœë¤ 1ì„¸íŠ¸
            </button>
        </form>

        <div id="my-bank-area"
             hx-get="{% url 'seed_quiz:htmx_my_bank_library' classroom_id=classroom.id %}"
             hx-trigger="load, bankUpdated from:body"
             hx-include="#my-bank-filter-form"
             hx-swap="innerHTML">
            <p class="text-sm text-gray-400">ë‚´ ë¬¸ì œ ë³´ê´€í•¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    {% if allow_rag %}
    <!-- ì œí•œí˜• RAG -->
    <div class="clay-card p-6 rounded-2xl mb-6">
        <h2 class="font-bold text-gray-700 mb-2">ì§€ë¬¸ ê¸°ë°˜ ë§ì¶¤ ìƒì„±</h2>
        <p class="text-xs text-gray-500 mb-4">êµì‹¤ë‹¹ í•˜ë£¨ {{ rag_daily_limit }}íšŒ ì œí•œ</p>
        <form hx-post="{% url 'seed_quiz:htmx_rag_generate' classroom_id=classroom.id %}"
              hx-target="#preview-area"
              hx-swap="innerHTML"
              class="space-y-3">
            {% csrf_token %}
            <div class="flex flex-wrap gap-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì£¼ì œ</label>
                    <select name="preset_type" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                        {% for value, label in preset_choices %}
                        <option value="{{ value }}" {% if value == initial_preset %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">í•™ë…„</label>
                    <select name="grade" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                        <option value="all" {% if initial_grade_str == "all" %}selected{% endif %}>ì „ì²´</option>
                        {% for g in "123456"|make_list %}
                        <option value="{{ g }}" {% if g == initial_grade_str %}selected{% endif %}>{{ g }}í•™ë…„</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ì§€ë¬¸ í…ìŠ¤íŠ¸ (20~4000ì)</label>
                <textarea name="source_text" rows="4"
                          placeholder="ì˜¤ëŠ˜ ìˆ˜ì—…í•œ ì§€ë¬¸ì´ë‚˜ í•µì‹¬ ë¬¸ì¥ì„ ë¶™ì—¬ ë„£ì–´ ì£¼ì„¸ìš”."
                          class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white resize-y"
                          required></textarea>
            </div>
            <button type="submit"
                    class="px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all">
                ë§ì¶¤ í€´ì¦ˆ ë§Œë“¤ê¸°
            </button>
        </form>
    </div>
    {% endif %}

    <!-- ì€í–‰ ëª©ë¡ -->
    <div id="bank-area" class="mb-6"
         hx-get="{% url 'seed_quiz:htmx_bank_browse' classroom_id=classroom.id %}"
         hx-trigger="load, bankUpdated from:body"
         hx-include="#bank-filter-form"
         hx-swap="innerHTML">
        <p class="text-sm text-gray-400">í€´ì¦ˆ ì€í–‰ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
    <div id="preview-area" class="mb-6"></div>

    <!-- ì£¼ì œë³„ ìš´ì˜ ìš”ì•½ -->
    <div class="clay-card p-6 rounded-2xl mb-6"
         hx-get="{% url 'seed_quiz:htmx_topic_summary' classroom_id=classroom.id %}"
         hx-trigger="load, every 30s"
         hx-swap="innerHTML">
        <p class="text-sm text-gray-400">ì£¼ì œë³„ ìš”ì•½ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ì§„í–‰ í˜„í™© -->
    <div class="clay-card p-6 rounded-2xl"
         hx-get="{% url 'seed_quiz:htmx_progress' classroom_id=classroom.id %}"
         hx-trigger="load, every 15s"
         hx-swap="innerHTML">
        <p class="text-sm text-gray-400">ì§„í–‰ í˜„í™© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

</div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    const form = document.getElementById('csv-upload-form');
    const input = document.getElementById('csv-file-input');
    const panel = document.getElementById('csv-client-check');
    if (!form || !input || !panel) {
        return;
    }

    const headerAliases = {
        preset_type: ['preset_type', 'ì£¼ì œ'],
        grade: ['grade', 'í•™ë…„'],
        question_text: ['question_text', 'ë¬¸ì œ', 'ë¬¸í•­'],
        choice_1: ['choice_1', 'ë³´ê¸°1', 'ë³´ê¸° 1'],
        choice_2: ['choice_2', 'ë³´ê¸°2', 'ë³´ê¸° 2'],
        choice_3: ['choice_3', 'ë³´ê¸°3', 'ë³´ê¸° 3'],
        choice_4: ['choice_4', 'ë³´ê¸°4', 'ë³´ê¸° 4'],
        correct_index: ['correct_index', 'ì •ë‹µë²ˆí˜¸', 'ì •ë‹µì¸ë±ìŠ¤', 'ì •ë‹µ'],
        explanation: ['explanation', 'í•´ì„¤'],
        difficulty: ['difficulty', 'ë‚œì´ë„']
    };
    const headerLabels = {
        preset_type: 'ì£¼ì œ',
        grade: 'í•™ë…„',
        question_text: 'ë¬¸ì œ',
        choice_1: 'ë³´ê¸°1',
        choice_2: 'ë³´ê¸°2',
        choice_3: 'ë³´ê¸°3',
        choice_4: 'ë³´ê¸°4',
        correct_index: 'ì •ë‹µë²ˆí˜¸',
        explanation: 'í•´ì„¤',
        difficulty: 'ë‚œì´ë„'
    };
    const requiredHeaders = [
        'preset_type', 'grade', 'question_text',
        'choice_1', 'choice_2', 'choice_3', 'choice_4', 'correct_index'
    ];
    const aliasToCanonical = new Map();
    Object.keys(headerAliases).forEach((canonical) => {
        headerAliases[canonical].forEach((alias) => {
            aliasToCanonical.set(String(alias || '').trim().toLowerCase(), canonical);
        });
    });
    const maxFileBytes = parseInt(form.dataset.maxFileBytes || '0', 10) || 0;
    const maxRows = parseInt(form.dataset.maxRows || '0', 10) || 0;
    const presetCanonicalMap = new Map();
    Array.from(document.querySelectorAll('#bank-filter-form select[name="preset_type"] option'))
        .forEach((opt) => {
            const key = (opt.value || '').trim().toLowerCase();
            const label = (opt.textContent || '').trim().toLowerCase();
            if (key) {
                presetCanonicalMap.set(key, key);
            }
            if (label) {
                presetCanonicalMap.set(label, key || label);
            }
        });
    const allowedPresetTypes = new Set(Array.from(presetCanonicalMap.keys()));

    function normalizeHeaderName(raw) {
        const normalized = String(raw || '').trim().toLowerCase();
        if (!normalized) {
            return '';
        }
        return aliasToCanonical.get(normalized) || normalized;
    }

    function humanizeBytes(num) {
        let value = Number(num) || 0;
        const units = ['B', 'KB', 'MB', 'GB'];
        let unitIdx = 0;
        while (value >= 1024 && unitIdx < units.length - 1) {
            value /= 1024;
            unitIdx += 1;
        }
        if (unitIdx === 0) {
            return String(Math.floor(value)) + units[unitIdx];
        }
        return value.toFixed(1) + units[unitIdx];
    }

    function setState(state) {
        form.dataset.clientCheckState = state;
    }

    function escapeHtml(text) {
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function showInfo(message) {
        panel.className = 'mt-2 rounded-lg border border-slate-200 bg-slate-50 text-slate-700 text-xs p-3';
        panel.innerHTML = '<p class="font-bold">ë¸Œë¼ìš°ì € 1ì°¨ ê²€ì‚¬</p><p class="mt-1">' + escapeHtml(message) + '</p>';
    }

    function showErrors(errors) {
        const visible = errors.slice(0, 6).map((e) => '<li>' + escapeHtml(e) + '</li>').join('');
        const more = errors.length > 6 ? '<p class="mt-2 text-[11px]">ì™¸ ' + (errors.length - 6) + 'ê±´</p>' : '';
        panel.className = 'mt-2 rounded-lg border border-amber-200 bg-amber-50 text-amber-700 text-xs p-3';
        panel.innerHTML = (
            '<p class="font-bold">ë¸Œë¼ìš°ì € 1ì°¨ ê²€ì‚¬ì—ì„œ ìˆ˜ì • í•„ìš” í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.</p>' +
            '<ul class="list-disc pl-5 mt-1 space-y-0.5">' + visible + '</ul>' +
            more
        );
    }

    function hidePanel() {
        panel.className = 'mt-2 hidden';
        panel.innerHTML = '';
    }

    function parseCsv(text) {
        const rows = [];
        let row = [];
        let cell = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i += 1) {
            const ch = text[i];
            if (ch === '"') {
                if (inQuotes && text[i + 1] === '"') {
                    cell += '"';
                    i += 1;
                } else {
                    inQuotes = !inQuotes;
                }
                continue;
            }
            if (!inQuotes && ch === ',') {
                row.push(cell);
                cell = '';
                continue;
            }
            if (!inQuotes && (ch === '\n' || ch === '\r')) {
                if (ch === '\r' && text[i + 1] === '\n') {
                    i += 1;
                }
                row.push(cell);
                rows.push(row);
                row = [];
                cell = '';
                continue;
            }
            cell += ch;
        }
        if (cell.length > 0 || row.length > 0) {
            row.push(cell);
            rows.push(row);
        }
        return rows;
    }

    function isGuideRow(raw) {
        if (!raw || !raw.length) {
            return false;
        }
        const firstNonEmpty = raw
            .map((v) => String(v || '').trim())
            .find((v) => v.length > 0);
        if (!firstNonEmpty) {
            return false;
        }
        return firstNonEmpty.startsWith('#') || firstNonEmpty.startsWith('â€»');
    }

    function validateRows(rows) {
        const errors = [];
        const maxErrors = 120;
        let isOverflow = false;
        let dataRowsCount = 0;
        let basePreset = '';
        let baseGrade = '';

        function addError(msg) {
            if (errors.length < maxErrors) {
                errors.push(msg);
            } else {
                isOverflow = true;
            }
        }

        if (!rows.length) {
            return ['CSV ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'];
        }

        const headers = rows[0].map((h) => normalizeHeaderName(h));
        const headerIndex = {};
        headers.forEach((h, idx) => {
            if (!h) {
                return;
            }
            if (!(h in headerIndex)) {
                headerIndex[h] = idx;
            }
        });

        requiredHeaders.forEach((col) => {
            if (!(col in headerIndex)) {
                addError('í•„ìˆ˜ í—¤ë” ëˆ„ë½: ' + (headerLabels[col] || col));
            }
        });
        if (errors.length) {
            return errors;
        }

        for (let i = 1; i < rows.length; i += 1) {
            const raw = rows[i];
            if (!raw || !raw.length || raw.every((v) => String(v || '').trim() === '')) {
                continue;
            }
            if (isGuideRow(raw)) {
                continue;
            }
            dataRowsCount += 1;
            if (maxRows && dataRowsCount > maxRows) {
                addError('CSV í–‰ ìˆ˜ê°€ ì œí•œ(' + maxRows + 'í–‰)ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.');
                break;
            }

            const lineNo = i + 1;
            const get = (key) => (raw[headerIndex[key]] || '').trim();
            const presetRaw = get('preset_type');
            const presetCanonical = presetCanonicalMap.get(String(presetRaw).toLowerCase()) || String(presetRaw).toLowerCase();
            const gradeRaw = get('grade');

            requiredHeaders.forEach((col) => {
                if (!get(col)) {
                    addError(lineNo + 'í–‰: ' + (headerLabels[col] || col) + ' ê°’ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
                }
            });

            const choices = [get('choice_1'), get('choice_2'), get('choice_3'), get('choice_4')];
            const nonEmptyChoices = choices.filter(Boolean);
            if (nonEmptyChoices.length === 4 && new Set(nonEmptyChoices).size !== 4) {
                addError(lineNo + 'í–‰: ì„ íƒì§€ ì¤‘ë³µì´ ìˆìŠµë‹ˆë‹¤.');
            }

            const ci = get('correct_index');
            if (ci && !/^[1-4]$/.test(ci)) {
                addError(lineNo + 'í–‰: ì •ë‹µë²ˆí˜¸ëŠ” 1~4ì´ì–´ì•¼ í•©ë‹ˆë‹¤ (ë³´ê¸°1=1, ë³´ê¸°2=2, ë³´ê¸°3=3, ë³´ê¸°4=4).');
            }

            if (presetRaw && !allowedPresetTypes.has(String(presetRaw).toLowerCase())) {
                addError(lineNo + 'í–‰: ì£¼ì œê°€ í—ˆìš© ëª©ë¡ì— ì—†ìŠµë‹ˆë‹¤ (' + presetRaw + ')');
            }
            if (gradeRaw && gradeRaw !== 'í•™ë…„ë¬´ê´€' && !/^[0-6]$/.test(gradeRaw)) {
                addError(lineNo + 'í–‰: í•™ë…„ì€ 0~6 ë˜ëŠ” í•™ë…„ë¬´ê´€ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            }

            if (!basePreset && presetCanonical) {
                basePreset = presetCanonical;
            } else if (basePreset && presetCanonical && presetCanonical !== basePreset) {
                addError('í•œ íŒŒì¼ì˜ ì£¼ì œëŠ” ëª¨ë‘ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤. (' + lineNo + 'í–‰)');
            }
            if (!baseGrade && gradeRaw) {
                baseGrade = gradeRaw;
            } else if (baseGrade && gradeRaw && gradeRaw !== baseGrade) {
                addError('í•œ íŒŒì¼ì˜ í•™ë…„ì€ ëª¨ë‘ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤. (' + lineNo + 'í–‰)');
            }
        }

        if (dataRowsCount === 0) {
            addError('ì—…ë¡œë“œ ê°€ëŠ¥í•œ ì‹¤ì œ ë¬¸í•­ í–‰ì´ ì—†ìŠµë‹ˆë‹¤. ì•ˆë‚´í–‰(#ê°€ì´ë“œ) ì•„ë˜ì— ë¬¸í•­ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        }

        if (isOverflow) {
            errors.push('ì˜¤ë¥˜ê°€ ë§ì•„ ì²˜ìŒ 120ê±´ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.');
        }
        return errors;
    }

    function runClientCheck(callback) {
        const file = input.files && input.files[0];
        if (!file) {
            setState('invalid');
            showErrors(['CSV íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.']);
            if (callback) callback(false);
            return;
        }
        if (maxFileBytes && file.size > maxFileBytes) {
            setState('invalid');
            showErrors([
                'CSV íŒŒì¼ ìš©ëŸ‰ì´ ì œí•œì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. (ìµœëŒ€ ' + humanizeBytes(maxFileBytes) + ')'
            ]);
            if (callback) callback(false);
            return;
        }

        const reader = new FileReader();
        setState('checking');
        showInfo('íŒŒì¼ êµ¬ì¡°ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...');
        reader.onload = function (event) {
            try {
                const text = String(event.target && event.target.result ? event.target.result : '');
                const rows = parseCsv(text);
                const errors = validateRows(rows);
                if (errors.length) {
                    setState('invalid');
                    showErrors(errors);
                    if (callback) callback(false);
                    return;
                }
                setState('valid');
                showInfo('1ì°¨ ê²€ì‚¬ í†µê³¼. ì„œë²„ ê²€ì¦ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                if (callback) callback(true);
            } catch (e) {
                setState('invalid');
                showErrors(['ë¸Œë¼ìš°ì € ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°”ë¡œ ì—…ë¡œë“œí•´ ì„œë²„ ê²€ì¦ì„ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.']);
                if (callback) callback(false);
            }
        };
        reader.onerror = function () {
            setState('invalid');
            showErrors(['íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.']);
            if (callback) callback(false);
        };
        reader.readAsText(file, 'utf-8');
    }

    input.addEventListener('change', function () {
        if (!input.files || !input.files.length) {
            setState('idle');
            hidePanel();
            return;
        }
        runClientCheck();
    });

    form.addEventListener('submit', function (event) {
        const state = form.dataset.clientCheckState || 'idle';
        if (state === 'valid') {
            return;
        }
        event.preventDefault();
        if (state === 'checking') {
            showInfo('ê²€ì‚¬ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.');
            return;
        }
        runClientCheck(function (ok) {
            if (ok) {
                form.requestSubmit();
            } else {
                showErrors(['1ì°¨ ê²€ì‚¬ ì˜¤ë¥˜ë¥¼ ë¨¼ì € ìˆ˜ì •í•œ ë’¤ ë‹¤ì‹œ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.']);
            }
        });
    });
})();

(function () {
    const btn = document.getElementById('copy-seed-quiz-template');
    if (!btn) {
        return;
    }
    const header = 'ì£¼ì œ\tí•™ë…„\të¬¸ì œ\të³´ê¸°1\të³´ê¸°2\të³´ê¸°3\të³´ê¸°4\tì •ë‹µë²ˆí˜¸\tí•´ì„¤\të‚œì´ë„';
    btn.addEventListener('click', async function () {
        try {
            await navigator.clipboard.writeText(header + '\n');
            btn.textContent = 'ë³µì‚¬ ì™„ë£Œ';
            btn.classList.remove('bg-violet-100', 'text-violet-700');
            btn.classList.add('bg-emerald-100', 'text-emerald-700');
            window.setTimeout(function () {
                btn.textContent = 'ë¶™ì—¬ë„£ê¸° ì–‘ì‹ ë³µì‚¬';
                btn.classList.remove('bg-emerald-100', 'text-emerald-700');
                btn.classList.add('bg-violet-100', 'text-violet-700');
            }, 1200);
        } catch (e) {
            btn.textContent = 'ë³µì‚¬ ì‹¤íŒ¨';
            btn.classList.remove('bg-violet-100', 'text-violet-700');
            btn.classList.add('bg-red-100', 'text-red-700');
            window.setTimeout(function () {
                btn.textContent = 'ë¶™ì—¬ë„£ê¸° ì–‘ì‹ ë³µì‚¬';
                btn.classList.remove('bg-red-100', 'text-red-700');
                btn.classList.add('bg-violet-100', 'text-violet-700');
            }, 1200);
        }
    });
})();
</script>
{% endblock %}
