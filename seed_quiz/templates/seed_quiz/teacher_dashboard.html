{% extends 'base.html' %}

{% block title %}ì”¨ì•— í€´ì¦ˆ â€” {{ classroom.name }}{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-4 min-h-screen">
<div class="max-w-4xl mx-auto">

    <!-- í—¤ë” -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <a href="{% url 'happy_seed:classroom_detail' classroom_id=classroom.id %}" class="text-sm text-gray-400 hover:text-gray-600">&larr; êµì‹¤ë¡œ ëŒì•„ê°€ê¸°</a>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mt-1">ğŸ“ ì”¨ì•— í€´ì¦ˆ</h1>
            <p class="text-sm text-gray-500">{{ classroom.name }} &middot; {{ classroom.school_name }}</p>
        </div>
    </div>

    <!-- í€´ì¦ˆ ì€í–‰ ì„ íƒ ì¹´ë“œ -->
    <div class="clay-card p-6 rounded-2xl mb-6">
        <h2 class="font-bold text-gray-700 mb-4">ì˜¤ëŠ˜ì˜ í€´ì¦ˆ ì„ íƒ</h2>
        <p class="text-sm text-gray-500 mb-4">
            ê³µì‹/ê³µìœ  í€´ì¦ˆ ì€í–‰ì—ì„œ ì„ íƒí•´ ë°”ë¡œ ë°°í¬í•˜ì„¸ìš”.
        </p>
        <form id="bank-filter-form"
              hx-get="{% url 'seed_quiz:htmx_bank_browse' classroom_id=classroom.id %}"
              hx-target="#bank-area"
              hx-swap="innerHTML"
              hx-indicator="#bank-spinner"
              class="flex flex-wrap gap-3 items-end">
            {% csrf_token %}

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ë²”ìœ„</label>
                <select name="scope" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    <option value="official">ê³µì‹</option>
                    <option value="public">ê³µìœ </option>
                    <option value="all">ì „ì²´</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ì£¼ì œ</label>
                <select name="preset_type" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    {% for value, label in preset_choices %}
                    <option value="{{ value }}" {% if value == initial_preset %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">í•™ë…„</label>
                <select name="grade" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                    <option value="all" {% if initial_grade_str == "all" %}selected{% endif %}>ì „ì²´</option>
                    {% for g in "123456"|make_list %}
                    <option value="{{ g }}" {% if g == initial_grade_str %}selected{% endif %}>{{ g }}í•™ë…„</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="px-5 py-2 bg-gradient-to-r from-indigo-600 to-sky-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all flex items-center gap-2">
                <span id="bank-spinner" class="htmx-indicator">
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </span>
                ì€í–‰ ì¡°íšŒ
            </button>
            <button type="button"
                    hx-post="{% url 'seed_quiz:htmx_bank_random_select' classroom_id=classroom.id %}"
                    hx-include="#bank-filter-form"
                    hx-target="#preview-area"
                    hx-swap="innerHTML"
                    class="px-5 py-2 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all">
                ëœë¤ 1ì„¸íŠ¸ ì„ íƒ
            </button>
        </form>
    </div>

    <!-- CSV ì—…ë¡œë“œ -->
    <div class="clay-card p-6 rounded-2xl mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="font-bold text-gray-700">CSV ì—…ë¡œë“œ</h2>
            <a href="{% url 'seed_quiz:download_csv_template' classroom_id=classroom.id %}"
               class="px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-bold hover:bg-gray-200 transition-colors">
                í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
            </a>
        </div>
        <form id="csv-upload-form"
              data-client-check-state="idle"
              hx-post="{% url 'seed_quiz:htmx_csv_upload' classroom_id=classroom.id %}"
              hx-encoding="multipart/form-data"
              hx-target="#csv-upload-result"
              hx-swap="innerHTML"
              class="flex flex-wrap items-end gap-3">
            {% csrf_token %}
            <div class="flex-1 min-w-[260px]">
                <label class="block text-xs font-bold text-gray-500 mb-1">CSV íŒŒì¼</label>
                <input type="file"
                       id="csv-file-input"
                       name="csv_file"
                       accept=".csv,text/csv"
                       required
                       class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
            </div>
            <button type="submit"
                    class="px-5 py-2 bg-gradient-to-r from-emerald-600 to-teal-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all">
                CSV ê°€ì ¸ì˜¤ê¸°
            </button>
        </form>
        <p class="mt-2 text-xs text-gray-500">
            í—¤ë”: set_title,preset_type,grade,question_text,choice_1,choice_2,choice_3,choice_4,correct_index,explanation,difficulty (preset_typeì—ëŠ” ì£¼ì œ í‚¤ ì‚¬ìš©)
        </p>
        <p class="mt-1 text-xs text-gray-400">
            set_title í‘œì¤€: <code>SQ-{topic}-basic-L1-G{grade}-S{seq}-V{ver}</code> ì˜ˆ: <code>SQ-orthography-basic-L1-G3-S001-V1</code>
        </p>
        <div id="csv-client-check" class="mt-2 hidden"></div>
        <div id="csv-upload-result" class="mt-3"></div>
    </div>

    {% if allow_rag %}
    <!-- ì œí•œí˜• RAG -->
    <div class="clay-card p-6 rounded-2xl mb-6">
        <h2 class="font-bold text-gray-700 mb-2">ì§€ë¬¸ ê¸°ë°˜ ë§ì¶¤ ìƒì„±</h2>
        <p class="text-xs text-gray-500 mb-4">êµì‹¤ë‹¹ í•˜ë£¨ {{ rag_daily_limit }}íšŒ ì œí•œ</p>
        <form hx-post="{% url 'seed_quiz:htmx_rag_generate' classroom_id=classroom.id %}"
              hx-target="#preview-area"
              hx-swap="innerHTML"
              class="space-y-3">
            {% csrf_token %}
            <div class="flex flex-wrap gap-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ì£¼ì œ</label>
                    <select name="preset_type" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                        {% for value, label in preset_choices %}
                        <option value="{{ value }}" {% if value == initial_preset %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">í•™ë…„</label>
                    <select name="grade" class="px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white">
                        <option value="all" {% if initial_grade_str == "all" %}selected{% endif %}>ì „ì²´</option>
                        {% for g in "123456"|make_list %}
                        <option value="{{ g }}" {% if g == initial_grade_str %}selected{% endif %}>{{ g }}í•™ë…„</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ì§€ë¬¸ í…ìŠ¤íŠ¸ (20~4000ì)</label>
                <textarea name="source_text" rows="4"
                          placeholder="ì˜¤ëŠ˜ ìˆ˜ì—…í•œ ì§€ë¬¸ì´ë‚˜ í•µì‹¬ ë¬¸ì¥ì„ ë¶™ì—¬ ë„£ì–´ ì£¼ì„¸ìš”."
                          class="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm bg-white resize-y"
                          required></textarea>
            </div>
            <button type="submit"
                    class="px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-lg text-sm font-bold hover:shadow-md transition-all">
                ë§ì¶¤ í€´ì¦ˆ ë§Œë“¤ê¸°
            </button>
        </form>
    </div>
    {% endif %}

    <!-- ì€í–‰ ëª©ë¡ -->
    <div id="bank-area" class="mb-6"
         hx-get="{% url 'seed_quiz:htmx_bank_browse' classroom_id=classroom.id %}"
         hx-trigger="load, bankUpdated from:body"
         hx-include="#bank-filter-form"
         hx-swap="innerHTML">
        <p class="text-sm text-gray-400">í€´ì¦ˆ ì€í–‰ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
    <div id="preview-area" class="mb-6"></div>

    <!-- ì£¼ì œë³„ ìš´ì˜ ìš”ì•½ -->
    <div class="clay-card p-6 rounded-2xl mb-6"
         hx-get="{% url 'seed_quiz:htmx_topic_summary' classroom_id=classroom.id %}"
         hx-trigger="load, every 30s"
         hx-swap="innerHTML">
        <p class="text-sm text-gray-400">ì£¼ì œë³„ ìš”ì•½ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ì§„í–‰ í˜„í™© -->
    <div class="clay-card p-6 rounded-2xl"
         hx-get="{% url 'seed_quiz:htmx_progress' classroom_id=classroom.id %}"
         hx-trigger="load, every 15s"
         hx-swap="innerHTML">
        <p class="text-sm text-gray-400">ì§„í–‰ í˜„í™© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

</div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    const form = document.getElementById('csv-upload-form');
    const input = document.getElementById('csv-file-input');
    const panel = document.getElementById('csv-client-check');
    if (!form || !input || !panel) {
        return;
    }

    const requiredHeaders = [
        'set_title', 'preset_type', 'grade', 'question_text',
        'choice_1', 'choice_2', 'choice_3', 'choice_4', 'correct_index'
    ];

    function setState(state) {
        form.dataset.clientCheckState = state;
    }

    function escapeHtml(text) {
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function showInfo(message) {
        panel.className = 'mt-2 rounded-lg border border-slate-200 bg-slate-50 text-slate-700 text-xs p-3';
        panel.innerHTML = '<p class="font-bold">ë¸Œë¼ìš°ì € 1ì°¨ ê²€ì‚¬</p><p class="mt-1">' + escapeHtml(message) + '</p>';
    }

    function showErrors(errors) {
        const visible = errors.slice(0, 6).map((e) => '<li>' + escapeHtml(e) + '</li>').join('');
        const more = errors.length > 6 ? '<p class="mt-2 text-[11px]">ì™¸ ' + (errors.length - 6) + 'ê±´</p>' : '';
        panel.className = 'mt-2 rounded-lg border border-amber-200 bg-amber-50 text-amber-700 text-xs p-3';
        panel.innerHTML = (
            '<p class="font-bold">ë¸Œë¼ìš°ì € 1ì°¨ ê²€ì‚¬ì—ì„œ ìˆ˜ì • í•„ìš” í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.</p>' +
            '<ul class="list-disc pl-5 mt-1 space-y-0.5">' + visible + '</ul>' +
            more
        );
    }

    function hidePanel() {
        panel.className = 'mt-2 hidden';
        panel.innerHTML = '';
    }

    function parseCsv(text) {
        const rows = [];
        let row = [];
        let cell = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i += 1) {
            const ch = text[i];
            if (ch === '"') {
                if (inQuotes && text[i + 1] === '"') {
                    cell += '"';
                    i += 1;
                } else {
                    inQuotes = !inQuotes;
                }
                continue;
            }
            if (!inQuotes && ch === ',') {
                row.push(cell);
                cell = '';
                continue;
            }
            if (!inQuotes && (ch === '\n' || ch === '\r')) {
                if (ch === '\r' && text[i + 1] === '\n') {
                    i += 1;
                }
                row.push(cell);
                rows.push(row);
                row = [];
                cell = '';
                continue;
            }
            cell += ch;
        }
        if (cell.length > 0 || row.length > 0) {
            row.push(cell);
            rows.push(row);
        }
        return rows;
    }

    function validateRows(rows) {
        const errors = [];
        if (!rows.length) {
            return ['CSV ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'];
        }

        const headers = rows[0].map((h) => (h || '').trim());
        const headerIndex = {};
        headers.forEach((h, idx) => { headerIndex[h] = idx; });

        requiredHeaders.forEach((col) => {
            if (!(col in headerIndex)) {
                errors.push('í•„ìˆ˜ í—¤ë” ëˆ„ë½: ' + col);
            }
        });
        if (errors.length) {
            return errors;
        }

        const maxRows = Math.min(rows.length, 121);
        for (let i = 1; i < maxRows; i += 1) {
            const raw = rows[i];
            if (!raw || !raw.length || raw.every((v) => String(v || '').trim() === '')) {
                continue;
            }
            const lineNo = i + 1;
            const get = (key) => (raw[headerIndex[key]] || '').trim();

            const rowRequired = [
                'set_title', 'preset_type', 'grade', 'question_text',
                'choice_1', 'choice_2', 'choice_3', 'choice_4', 'correct_index'
            ];
            rowRequired.forEach((col) => {
                if (!get(col)) {
                    errors.push(lineNo + 'í–‰: ' + col + ' ê°’ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
                }
            });

            const choices = [get('choice_1'), get('choice_2'), get('choice_3'), get('choice_4')];
            const nonEmptyChoices = choices.filter(Boolean);
            if (nonEmptyChoices.length === 4 && new Set(nonEmptyChoices).size !== 4) {
                errors.push(lineNo + 'í–‰: ì„ íƒì§€ ì¤‘ë³µì´ ìˆìŠµë‹ˆë‹¤.');
            }

            const ci = get('correct_index');
            if (ci && !/^[0-3]$/.test(ci)) {
                errors.push(lineNo + 'í–‰: correct_indexëŠ” 0~3ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            }
        }

        if (rows.length > 121) {
            errors.push('1ì°¨ ê²€ì‚¬ëŠ” ì²˜ìŒ 120í–‰ê¹Œì§€ë§Œ ê²€ì‚¬í–ˆìŠµë‹ˆë‹¤. ì „ì²´ ê²€ì¦ì€ ì„œë²„ì—ì„œ ì§„í–‰ë©ë‹ˆë‹¤.');
        }
        return errors;
    }

    function runClientCheck(callback) {
        const file = input.files && input.files[0];
        if (!file) {
            setState('invalid');
            showErrors(['CSV íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.']);
            if (callback) callback(false);
            return;
        }

        const reader = new FileReader();
        setState('checking');
        showInfo('íŒŒì¼ êµ¬ì¡°ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...');
        reader.onload = function (event) {
            try {
                const text = String(event.target && event.target.result ? event.target.result : '');
                const rows = parseCsv(text);
                const errors = validateRows(rows);
                if (errors.length) {
                    setState('invalid');
                    showErrors(errors);
                    if (callback) callback(false);
                    return;
                }
                setState('valid');
                showInfo('1ì°¨ ê²€ì‚¬ í†µê³¼. ì„œë²„ ê²€ì¦ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                if (callback) callback(true);
            } catch (e) {
                setState('invalid');
                showErrors(['ë¸Œë¼ìš°ì € ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°”ë¡œ ì—…ë¡œë“œí•´ ì„œë²„ ê²€ì¦ì„ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.']);
                if (callback) callback(false);
            }
        };
        reader.onerror = function () {
            setState('invalid');
            showErrors(['íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.']);
            if (callback) callback(false);
        };
        reader.readAsText(file, 'utf-8');
    }

    input.addEventListener('change', function () {
        if (!input.files || !input.files.length) {
            setState('idle');
            hidePanel();
            return;
        }
        runClientCheck();
    });

    form.addEventListener('submit', function (event) {
        if (form.dataset.clientCheckState === 'invalid') {
            event.preventDefault();
            showErrors(['1ì°¨ ê²€ì‚¬ ì˜¤ë¥˜ë¥¼ ë¨¼ì € ìˆ˜ì •í•œ ë’¤ ë‹¤ì‹œ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.']);
        }
    });
})();
</script>
{% endblock %}
