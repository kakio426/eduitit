{% extends 'base.html' %}

{% block title %}í•™ìƒ ëŒ€ì‹œë³´ë“œ â€” {{ classroom.name }}{% endblock %}

{% block extra_css %}
<style>
    .sq-student-shell {
        background: #E0E5EC;
    }

    .sq-student-card {
        background: linear-gradient(135deg, #E0E5EC 0%, #F5F7FA 100%);
        border-radius: 20px;
        box-shadow: 8px 8px 16px #b8bec5, -8px -8px 16px #ffffff;
    }

    .sq-student-soft-card {
        background: #ECF1F8;
        border-radius: 16px;
        border: 1px solid #d8e0ea;
    }

    .sq-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.65rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 700;
    }
</style>
{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-4 md:px-6 min-h-screen sq-student-shell">
<div class="max-w-5xl mx-auto">
    <div class="text-center mb-8">
        <div class="text-6xl mb-2">ğŸ§‘â€ğŸ«</div>
        <h1 class="text-3xl md:text-4xl font-black text-gray-700">í•™ìƒ ëª¨ì§‘ ëŒ€ì‹œë³´ë“œ</h1>
        <p class="mt-2 text-sm md:text-base text-gray-500">{{ classroom.name }} &middot; {{ classroom.school_name }}</p>
        <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-2">
            <a href="{% url 'seed_quiz:teacher_dashboard' classroom_id=classroom.id %}"
               class="w-full sm:w-auto px-4 py-2 rounded-xl border border-gray-200 bg-white text-gray-600 text-sm font-bold hover:bg-gray-50 transition-colors whitespace-nowrap">
                &larr; ì”¨ì•— í€´ì¦ˆë¡œ ëŒì•„ê°€ê¸°
            </a>
            <a href="{% url 'seed_quiz:teacher_result_analysis' classroom_id=classroom.id %}{% if quiz_set %}?set_id={{ quiz_set.id }}{% endif %}"
               target="_blank"
               rel="noopener"
               class="w-full sm:w-auto px-4 py-2 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-700 text-sm font-bold hover:bg-emerald-100 transition-colors whitespace-nowrap">
                ì •ë‹µ ë¶„ì„ ì—´ê¸° (ìƒˆ íƒ­)
            </a>
        </div>
    </div>

    {% if published_sets %}
    <form method="get" class="sq-student-card p-5 mb-6 flex flex-col sm:flex-row sm:items-end gap-3">
        <div class="w-full sm:w-auto">
            <label class="block text-xs font-bold text-gray-500 mb-1">ë°°í¬ ì„¸íŠ¸ ì„ íƒ</label>
            <select name="set_id" class="w-full px-3 py-2 rounded-xl border border-gray-200 text-sm bg-white min-w-[280px]">
                {% for row in published_sets %}
                <option value="{{ row.id }}" {% if quiz_set and row.id == quiz_set.id %}selected{% endif %}>
                    {{ row.target_date|date:"Y-m-d" }} Â· {{ row.get_preset_type_display }} Â· {{ row.title }}
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit"
                class="w-full sm:w-auto px-5 py-2.5 bg-gradient-to-r from-indigo-600 to-sky-600 text-white rounded-xl text-sm font-bold hover:shadow-md transition-all whitespace-nowrap">
            ë¶ˆëŸ¬ì˜¤ê¸°
        </button>
    </form>
    {% endif %}

    {% if quiz_set %}
    <div class="grid gap-4 lg:grid-cols-[1.45fr_1fr] mb-6">
        <div class="sq-student-card p-6">
            <div class="flex flex-wrap items-center gap-2">
                <span class="sq-chip bg-indigo-100 text-indigo-700">ìš´ì˜ ì¤‘ ì„¸íŠ¸</span>
                <span class="sq-chip bg-sky-100 text-sky-700">{{ quiz_set.get_preset_type_display }}</span>
            </div>
            <h2 class="mt-3 text-lg font-black text-gray-700 break-words">{{ quiz_set.title }}</h2>
            <p class="mt-1 text-xs text-gray-500">{{ quiz_set.target_date|date:"Y-m-d" }} ë°°í¬</p>
            <div class="mt-4 p-4 sq-student-soft-card">
                <p class="text-xs font-bold text-gray-500 mb-2">í•™ìƒ ì ‘ì† ì£¼ì†Œ</p>
                <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                    <code class="text-sm text-purple-700 font-mono break-all flex-1">{{ student_url }}</code>
                    <button type="button"
                            data-student-dashboard-copy-url
                            data-copy-url="{{ student_url }}"
                            class="w-full sm:w-auto shrink-0 px-3 py-2 bg-purple-100 text-purple-700 rounded-xl text-xs font-bold hover:bg-purple-200 transition-colors whitespace-nowrap">
                        ë§í¬ ë³µì‚¬
                    </button>
                </div>
            </div>
            <p class="mt-3 text-xs text-gray-500">êµì‹¤ í™”ë©´ì—ëŠ” QRë§Œ í¬ê²Œ ë„ì›Œ ë‘ê³ , ì§„í–‰ í˜„í™©ì€ ì´ í™”ë©´ì—ì„œ í™•ì¸í•˜ë©´ ì•ˆì •ì ì…ë‹ˆë‹¤.</p>
        </div>
        <div class="sq-student-card p-6 flex flex-col items-center justify-center text-center">
            <p class="text-xs font-bold text-gray-500 mb-3">í•™ìƒ QR ì…ì¥</p>
            {% if student_qr_data_url %}
            <img src="{{ student_qr_data_url }}" alt="í•™ìƒ ì ‘ì† QR" class="w-52 h-52 max-w-full rounded-xl bg-white p-2 border border-gray-100">
            {% else %}
            <p class="text-xs text-gray-400">QR ì¤€ë¹„ ì¤‘...</p>
            {% endif %}
            <p class="mt-3 text-xs text-gray-500">í•™ìƒì´ ë²ˆí˜¸/ì´ë¦„ ì…ë ¥ í›„ ë°”ë¡œ ì…ì¥í•©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <div class="sq-student-card p-6"
         hx-get="{% url 'seed_quiz:htmx_progress' classroom_id=classroom.id %}?set_id={{ quiz_set.id }}"
         hx-trigger="load, every 10s"
         hx-swap="innerHTML">
        <p class="text-sm text-gray-400">ì…ì¥ í˜„í™© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
    {% else %}
    <div class="sq-student-card p-8 text-center">
        <div class="text-4xl mb-2">ğŸ“­</div>
        <p class="text-sm text-gray-500">í˜„ì¬ ë°°í¬ ì¤‘ì¸ í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ ë§Œë“  ë’¤ ë°°í¬í•´ ì£¼ì„¸ìš”.</p>
    </div>
    {% endif %}
</div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function () {
    const copyButton = document.querySelector('[data-student-dashboard-copy-url]');
    if (!copyButton) {
        return;
    }
    copyButton.addEventListener('click', async function () {
        const targetUrl = copyButton.dataset.copyUrl || '';
        if (!targetUrl) {
            return;
        }
        try {
            await navigator.clipboard.writeText(targetUrl);
            window.alert('í•™ìƒ ì ‘ì† ë§í¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
        } catch (_error) {
            window.alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });
})();
</script>
{% endblock %}
