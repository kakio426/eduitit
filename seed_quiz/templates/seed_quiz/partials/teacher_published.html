<div class="clay-card p-6 rounded-2xl">
    <div class="flex items-center gap-3 mb-4">
        <span class="text-3xl">ğŸš€</span>
        <div>
            {% if rollback_done %}
            <h2 class="font-bold text-gray-800">ì§ì „ ë°°í¬ë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤.</h2>
            <p class="text-sm text-gray-500">ì´ì œ êµì‹¤ í™”ë©´ì— QRì„ ë„ìš°ë©´ í•™ìƒì´ ë°”ë¡œ ë‹¤ì‹œ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            {% else %}
            <h2 class="font-bold text-gray-800">í€´ì¦ˆê°€ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
            <p class="text-sm text-gray-500">êµì‹¤ í™”ë©´ì— QRì„ ë„ìš°ê³  í•™ìƒë“¤ì´ ë°”ë¡œ ìŠ¤ìº”í•˜ë„ë¡ ì•ˆë‚´í•´ ì£¼ì„¸ìš”.</p>
            {% endif %}
        </div>
    </div>

    <div class="grid gap-4 lg:grid-cols-[1.4fr_1fr]">
        <div class="p-4 bg-gray-50 rounded-xl">
            <p class="text-xs font-bold text-gray-500 mb-2">í•™ìƒ ì ‘ì† ì£¼ì†Œ</p>
            <div class="flex items-center gap-2">
                <code class="text-sm text-purple-700 font-mono break-all flex-1">{{ student_url }}</code>
                <button type="button"
                        data-seed-quiz-copy-url
                        data-copy-url="{{ student_url }}"
                        class="shrink-0 px-3 py-1.5 bg-purple-100 text-purple-600 rounded-lg text-xs font-bold hover:bg-purple-200 transition-colors">
                    ë§í¬ ë³µì‚¬
                </button>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">
                <button type="button"
                        data-seed-quiz-qr-open
                        class="px-3 py-2 bg-indigo-100 text-indigo-700 rounded-lg text-xs font-bold hover:bg-indigo-200 transition-colors">
                    QR ì „ì²´í™”ë©´
                </button>
                <span class="text-xs text-gray-500 self-center">í•™ìƒì€ QR ìŠ¤ìº” í›„ ë²ˆí˜¸/ì´ë¦„ ì…ë ¥ìœ¼ë¡œ ë°”ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.</span>
            </div>
        </div>

        <div class="p-4 bg-white border border-indigo-100 rounded-xl flex items-center justify-center">
            {% if student_qr_data_url %}
            <img src="{{ student_qr_data_url }}" alt="ì”¨ì•—í€´ì¦ˆ í•™ìƒ ì ‘ì† QR" class="w-44 h-44 sm:w-52 sm:h-52 max-w-full">
            {% else %}
            <p class="text-xs text-gray-400">QR ì¤€ë¹„ ì¤‘...</p>
            {% endif %}
        </div>
    </div>

    <div class="mt-4 p-4 rounded-xl bg-emerald-50 border border-emerald-200">
        <div class="flex items-center gap-2 text-sm text-emerald-700 font-bold">
            <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
            ì‹¤ì‹œê°„ ì…ì¥ í˜„í™© (10ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ )
        </div>
        <p class="mt-1 text-xs text-emerald-700/90">ìš°ë¦¬ë°˜BTIì²˜ëŸ¼ í•™ìƒ ì…ì¥/ì œì¶œ ìƒí™©ì„ ì—¬ê¸°ì„œ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <div class="mt-3 bg-white rounded-xl border border-emerald-100 p-3"
             hx-get="{% url 'seed_quiz:htmx_progress' classroom_id=classroom.id %}"
             hx-trigger="load, every 10s"
             hx-swap="innerHTML">
            <p class="text-sm text-gray-400">ì…ì¥ í˜„í™© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    {% if rollback_restore_set_id and not rollback_done %}
    <div class="mt-4 p-3 rounded-xl bg-amber-50 border border-amber-200">
        <p class="text-xs text-amber-700 mb-2">ê¸°ì¡´ ë°°í¬ë¥¼ ë®ì–´ì¼ìŠµë‹ˆë‹¤. ë¬¸ì œê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì§ì „ ë°°í¬ë¡œ ë˜ëŒë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <form hx-post="{% url 'seed_quiz:htmx_publish_rollback' classroom_id=classroom.id %}"
              hx-target="#preview-area"
              hx-swap="innerHTML">
            {% csrf_token %}
            <input type="hidden" name="restore_set_id" value="{{ rollback_restore_set_id }}">
            <input type="hidden" name="current_set_id" value="{{ rollback_from_set_id }}">
            <button type="submit"
                    class="px-4 py-2 rounded-lg bg-amber-100 text-amber-800 text-xs font-bold hover:bg-amber-200 transition-colors">
                ì§ì „ ë°°í¬ë¡œ ë˜ëŒë¦¬ê¸°
            </button>
        </form>
    </div>
    {% endif %}
</div>

<div id="seed-quiz-qr-modal"
     class="fixed inset-0 z-[120] hidden"
     aria-hidden="true"
     role="dialog"
     aria-label="í•™ìƒ ì ‘ì† QR ì „ì²´í™”ë©´">
    <div class="absolute inset-0 bg-black/80" data-seed-quiz-qr-close></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-4 sm:p-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-base sm:text-lg font-bold text-gray-800">í•™ìƒ ì ‘ì† QR ì½”ë“œ</h3>
                <button type="button"
                        data-seed-quiz-qr-close
                        class="px-3 py-1.5 rounded-lg bg-gray-100 text-gray-600 text-xs font-bold hover:bg-gray-200 transition-colors">
                    ë‹«ê¸°
                </button>
            </div>
            <div class="rounded-xl border border-gray-100 bg-gray-50 p-4 flex items-center justify-center">
                {% if student_qr_data_url %}
                <img src="{{ student_qr_data_url }}" alt="ì”¨ì•—í€´ì¦ˆ í•™ìƒ ì ‘ì† QR ì „ì²´í™”ë©´" class="w-full max-w-[520px] aspect-square object-contain">
                {% else %}
                <p class="text-xs text-gray-400">QR ì¤€ë¹„ ì¤‘...</p>
                {% endif %}
            </div>
            <p class="mt-3 text-xs text-gray-500">í•™ìƒì€ ì¹´ë©”ë¼ë¡œ QRì„ ì°ê³  ë²ˆí˜¸/ì´ë¦„ ì…ë ¥ í›„ ë°”ë¡œ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>
</div>

<script>
(function () {
    const modal = document.getElementById('seed-quiz-qr-modal');
    const openButton = document.querySelector('[data-seed-quiz-qr-open]');
    const copyButton = document.querySelector('[data-seed-quiz-copy-url]');
    if (!modal || !openButton) {
        return;
    }

    const closeButtons = Array.from(modal.querySelectorAll('[data-seed-quiz-qr-close]'));

    function openModal() {
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('overflow-hidden');
    }

    function closeModal() {
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('overflow-hidden');
    }

    openButton.addEventListener('click', openModal);
    closeButtons.forEach((button) => button.addEventListener('click', closeModal));

    if (copyButton) {
        copyButton.addEventListener('click', async function () {
            const targetUrl = copyButton.dataset.copyUrl || '';
            if (!targetUrl) {
                return;
            }
            try {
                await navigator.clipboard.writeText(targetUrl);
                window.alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (_error) {
                window.alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    if (!window.__seedQuizQrEscBound) {
        window.__seedQuizQrEscBound = true;
        document.addEventListener('keydown', function (event) {
            if (event.key !== 'Escape') {
                return;
            }
            const activeModal = document.getElementById('seed-quiz-qr-modal');
            if (!activeModal || activeModal.classList.contains('hidden')) {
                return;
            }
            activeModal.classList.add('hidden');
            activeModal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('overflow-hidden');
        });
    }
})();
</script>

{% include 'core/partials/service_suggestion.html' with service_key='seed_quiz' %}
