{% extends 'base.html' %}
{% load static %}

{% block title %}ClassBoard{% endblock %}

{% block extra_css %}
<style>
    :root {
        --dt-bg: #0f172a;
        --dt-card: rgba(30, 41, 59, 0.5);
        --dt-indigo: #6366f1;
        --dt-violet: #8b5cf6;
        --dt-emerald: #10b981;
    }

    body {
        background-color: var(--dt-bg);
        color: #f8fafc;
        overflow: hidden;
    }

    .glass-card {
        background: rgba(30, 41, 59, 0.4);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 5px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    /* Animation Utilities */
    @keyframes pulse-soft {

        0%,
        100% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.02);
            opacity: 0.9;
        }
    }

    .animate-pulse-soft {
        animation: pulse-soft 2s infinite ease-in-out;
    }

    @keyframes dt-role-glow {
        0%,
        100% {
            box-shadow: 0 0 0 rgba(56, 189, 248, 0);
        }
        50% {
            box-shadow: 0 0 24px rgba(56, 189, 248, 0.28);
        }
    }

    @keyframes dt-role-spotlight-sweep {
        0% {
            background-position: 0% 50%;
        }
        100% {
            background-position: 100% 50%;
        }
    }

    .dt-role-current-muted {
        border-color: rgba(56, 189, 248, 0.32) !important;
        background: rgba(15, 23, 42, 0.62) !important;
    }

    .dt-role-current-spotlight {
        border-color: rgba(129, 140, 248, 0.68) !important;
        background: linear-gradient(120deg, rgba(15, 23, 42, 0.65), rgba(30, 41, 59, 0.88), rgba(30, 64, 175, 0.58));
        background-size: 220% 220%;
        animation: dt-role-glow 2.1s ease-in-out infinite, dt-role-spotlight-sweep 2.8s linear infinite;
    }

    .dt-callmode-overlay {
        background: radial-gradient(circle at top, rgba(79, 70, 229, 0.28), rgba(2, 6, 23, 0.95) 60%);
    }

    #mainAppContainer {
        min-height: 100dvh;
    }

    .dt-timer-card {
        padding: clamp(1.25rem, 2.2vw, 2rem);
    }

    .dt-timer-main {
        display: grid;
        align-content: center;
        justify-items: center;
        gap: clamp(0.5rem, 1.6vh, 1.25rem);
        width: 100%;
        min-height: 0;
    }

    #mainTimerDisplay {
        font-size: clamp(4rem, 18vw, 10rem);
        line-height: 0.88;
        margin-bottom: clamp(0.5rem, 1.8vh, 1.5rem);
        background: transparent;
        border: 0;
        padding: 0;
    }

    #mainTimerDisplay:focus-visible {
        outline: 2px solid rgba(255, 255, 255, 0.45);
        outline-offset: 0.5rem;
        border-radius: 1rem;
    }

    #mainMissionTitle {
        font-size: clamp(2rem, 7.5vw, 4.75rem);
        line-height: 1.06;
    }

    #mainMissionDesc {
        font-size: clamp(1.1rem, 4vw, 2rem);
        line-height: 1.22;
    }

    #timerControls {
        margin-top: clamp(0.75rem, 2vh, 2rem);
        max-width: 100%;
        row-gap: 0.65rem;
        column-gap: 0.65rem;
    }

    @media (max-width: 1023px) {
        #mainAppContainer {
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        }

        .dt-main-grid {
            min-height: auto;
        }

        .dt-left-column,
        .dt-right-column {
            height: auto;
        }

        .dt-timer-card {
            min-height: min(74dvh, 760px);
            border-radius: 2rem;
        }

        .dt-student-card,
        .dt-role-card,
        .dt-notice-card {
            border-radius: 2rem;
            padding: 1.25rem;
        }

        .dt-student-grid {
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.75rem;
        }

        #timerControls .timer-btn,
        #timerControls .timer-reset-btn {
            padding: 0.6rem 0.95rem;
            font-size: 1.05rem;
            line-height: 1;
        }

        #timerControls .timer-custom-wrap {
            padding: 0.4rem 0.6rem;
        }

        #timerControls .timer-custom-wrap input {
            width: 3rem;
            font-size: 1rem;
        }

        .timer-divider {
            display: none;
        }

        .mission-edit-btn {
            opacity: 1;
        }
    }

    @media (max-height: 860px) {
        #mainAppContainer {
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        }

        .dt-main-grid {
            min-height: auto;
        }

        .dt-left-column,
        .dt-right-column {
            height: auto;
        }

        .dt-timer-card {
            min-height: min(74dvh, 760px);
        }
    }

    @media (max-height: 760px) {
        #mainTimerDisplay {
            font-size: clamp(3.4rem, 14vh, 7rem);
        }

        #mainMissionTitle {
            font-size: clamp(1.8rem, 5.8vh, 3.4rem);
        }

        #mainMissionDesc {
            font-size: clamp(1rem, 3vh, 1.4rem);
        }

        .dt-timer-hint {
            display: none;
        }
    }

    @media (hover: none),
    (pointer: coarse) {
        #timerControls {
            opacity: 1 !important;
            transform: none !important;
        }

        .mission-edit-btn {
            opacity: 1 !important;
        }
    }

    @media (prefers-reduced-motion: reduce) {
        .animate-pulse-soft {
            animation: none !important;
        }

        #mainTimerDisplay,
        #timerControls,
        .mission-edit-btn {
            transition: none !important;
        }

        #mainTimerDisplay.scale-105,
        #mainTimerDisplay:hover,
        #mainTimerDisplay:active {
            transform: none !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Main App Container -->
<div id="mainAppContainer"
    class="fixed inset-0 bg-slate-900 text-white p-4 md:p-6 font-sans overflow-hidden flex flex-col z-[100]">

    <!-- Header -->
    <header class="flex-shrink-0 flex justify-between items-center mb-6 px-2">
        <div class="flex items-center gap-3">
            <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                <div class="bg-indigo-600 p-2.5 rounded-xl shadow-lg shadow-indigo-500/20">
                    <i class="fa-solid fa-wand-magic-sparkles text-yellow-300 text-xl"></i>
                </div>
                <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-white flex items-center gap-2">
                    <span class="text-indigo-400 font-extrabold">Eduitit</span>
                </h1>
            </a>
        </div>

        <div class="flex items-center gap-3">
            <div
                class="hidden md:flex items-center gap-4 bg-slate-800/50 backdrop-blur-xl px-6 py-2 rounded-full border border-slate-700/50 shadow-xl">
                <div class="flex items-center gap-2 text-slate-300">
                    <i class="fa-regular fa-calendar text-indigo-400"></i>
                    <span class="text-base font-medium" id="headerDate">--. --. (.)</span>
                </div>
                <!-- Schedule Strip -->
                <div class="h-4 w-px bg-slate-700 hidden lg:block"></div>
                <div id="headerScheduleStrip"
                    class="hidden lg:flex lg:flex-wrap items-center content-center gap-x-2 gap-y-1 max-w-[380px] xl:max-w-[560px]">
                    <!-- JS Populated -->
                </div>
                <div class="h-4 w-px bg-slate-700"></div>
                <div class="flex items-center gap-2 text-white font-mono text-xl font-bold tracking-wider">
                    <i class="fa-regular fa-clock text-indigo-400"></i>
                    <span id="headerTime">--:--</span>
                </div>
            </div>

            <!-- Global Controls -->
            <div class="flex items-center gap-2">
                {% if student_games_launch_url %}
                <button onclick="openStudentGamesQrModal()"
                    class="w-10 h-10 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl flex items-center justify-center border border-indigo-400/40 transition"
                    title="í•™ìƒ ê²Œì„ QR">
                    <i class="fa-solid fa-qrcode"></i>
                </button>
                {% endif %}
                <a href="{% url 'ppobgi:main' %}"
                    class="w-10 h-10 bg-amber-500/20 hover:bg-amber-500/35 text-amber-200 rounded-xl flex items-center justify-center border border-amber-300/30 transition"
                    title="ë³„ë¹› ì¶”ì²¨ê¸°">
                    <i class="fa-solid fa-shuffle"></i>
                </a>
                <button onclick="window.dtApp.toggleFullscreen()"
                    class="w-10 h-10 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl flex items-center justify-center border border-slate-700 transition"
                    title="ì „ì²´í™”ë©´">
                    <i class="fa-solid fa-expand"></i>
                </button>
                <button id="toggleSoundBtn" onclick="window.dtApp.toggleBroadcastSound()"
                    class="w-10 h-10 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl flex items-center justify-center border border-slate-700 transition"
                    title="ì†Œë¦¬ ì„¤ì •">
                    <i class="fa-solid fa-volume-high"></i>
                </button>
                <a href="{% url 'dt_admin_dashboard' %}"
                    class="w-10 h-10 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl flex items-center justify-center border border-slate-700 transition"
                    title="ì„¤ì •">
                    <i class="fa-solid fa-gear"></i>
                </a>
                <div class="w-px h-6 bg-slate-700 mx-1"></div>
                <a href="/"
                    class="w-10 h-10 bg-slate-800 hover:bg-indigo-600 text-white rounded-xl flex items-center justify-center shadow-lg border border-slate-700 transition"
                    title="ë‚˜ê°€ê¸°">
                    <i class="fa-solid fa-house"></i>
                </a>
            </div>
        </div>
    </header>

    {% if not user.is_authenticated %}
    <!-- Guest Mode Banner -->
    <div id="guestBanner"
        class="flex-shrink-0 mb-6 bg-indigo-600/20 border border-indigo-500/30 rounded-2xl p-4 flex flex-col md:flex-row items-center justify-between gap-4 animate-in fade-in slide-in-from-top duration-700">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center text-xl">
                <i class="fa-solid fa-cloud-arrow-up"></i>
            </div>
            <div>
                <p class="font-bold text-indigo-100">í˜„ì¬ ê²ŒìŠ¤íŠ¸ ëª¨ë“œì…ë‹ˆë‹¤</p>
                <p class="text-sm text-indigo-300">ë¸Œë¼ìš°ì €ë¥¼ ë‹«ìœ¼ë©´ í•™ìƒ ëª…ê³¼ ì„¤ì •ì´ ì‚¬ë¼ì ¸ìš”. ğŸ˜¥</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <a href="{% url 'account_signup' %}"
                class="px-5 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition-all shadow-lg hover:-translate-y-1">
                ê³„ì • ë§Œë“¤ê³  ì €ì¥í•˜ê¸°
            </a>
            <button onclick="this.closest('#guestBanner').remove()"
                class="p-2 text-indigo-400 hover:text-white transition-colors">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>
    {% endif %}


    <!-- Main Grid -->
    <main class="dt-main-grid flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0">

        <!-- [Left Column - 8] Mission & Status -->
        <div class="dt-left-column lg:col-span-8 flex flex-col gap-6 h-full min-h-0">

            <!-- 1. Timer & Current Mission Card -->
            <div
                class="dt-timer-card flex-1 bg-gradient-to-br from-indigo-600 to-violet-700 rounded-[2.5rem] p-8 shadow-2xl relative overflow-hidden flex flex-col items-center text-center border-4 border-indigo-500/20 group">

                <!-- Decor -->
                <div
                    class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-yellow-400 via-pink-500 to-cyan-400 opacity-80">
                </div>
                <div
                    class="absolute -right-20 -top-20 w-80 h-80 bg-white/10 rounded-full blur-3xl pointer-events-none group-hover:bg-white/15 transition-all duration-1000">
                </div>

                <!-- Main Content (Timer + Message) -->
                <div class="dt-timer-main flex-1 flex flex-col justify-center items-center w-full min-h-0 z-10">
                    <!-- Giant Timer -->
                    <button id="mainTimerDisplay" type="button" aria-pressed="false" aria-label="íƒ€ì´ë¨¸ ì‹œì‘/ì¼ì‹œì •ì§€"
                        class="font-mono text-[8rem] lg:text-[10rem] leading-none font-black tracking-tighter mb-6 cursor-pointer select-none transition-all duration-300 text-white drop-shadow-[0_10px_10px_rgba(0,0,0,0.3)] hover:scale-105 active:scale-95 appearance-none bg-transparent border-0 p-0 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-white/30 rounded-2xl"
                        onclick="window.dtApp.toggleTimer()" title="íƒ€ì´ë¨¸ ì‹œì‘/ì •ì§€">
                        05:00
                    </button>
                    <p class="dt-timer-hint text-sm md:text-base text-indigo-100/70 font-bold mb-4">
                        ìˆ«ìë¥¼ ëˆ„ë¥´ë©´ ì‹œì‘/ì¼ì‹œì •ì§€
                    </p>

                    <!-- Mission Text -->
                    <div class="max-w-3xl px-4 relative group/mission">
                        <div class="flex items-center justify-center gap-4 mb-3">
                            <h2 class="text-4xl md:text-6xl font-black text-white drop-shadow-lg leading-tight break-keep"
                                id="mainMissionTitle">
                                ìˆ˜í•™ ìµí˜ì±… í’€ê¸°
                            </h2>
                            <button onclick="window.dtApp.openMissionModal()"
                                class="mission-edit-btn opacity-0 group-hover/mission:opacity-100 transition-opacity text-white/40 hover:text-white bg-white/10 w-10 h-10 rounded-full flex items-center justify-center">
                                <i class="fa-solid fa-pen-to-square text-sm"></i>
                            </button>
                        </div>
                        <p class="text-xl md:text-3xl text-indigo-100 font-bold opacity-80 break-keep"
                            id="mainMissionDesc">
                            24~25í˜ì´ì§€ í’€ê³  ì±„ì í•˜ê¸°
                        </p>
                    </div>
                </div>

                <!-- Timer Controls -->
                <div
                    id="timerControls"
                    class="flex-shrink-0 mt-8 flex flex-wrap justify-center gap-3 opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-all duration-500 z-10 lg:translate-y-4 lg:group-hover:translate-y-0">
                    <button onclick="window.dtApp.addTimerMinutes(1)"
                        class="timer-btn px-5 py-2.5 bg-white/10 backdrop-blur-xl rounded-xl text-white font-black hover:bg-white/20 border border-white/10 active:scale-95 transition-all">+1ë¶„</button>
                    <button onclick="window.dtApp.setTimerMode(300, true)"
                        class="timer-btn px-5 py-2.5 bg-white/10 backdrop-blur-xl rounded-xl text-white font-black hover:bg-white/20 border border-white/10 active:scale-95 transition-all">5ë¶„</button>
                    <button onclick="window.dtApp.setTimerMode(600, true)"
                        class="timer-btn px-5 py-2.5 bg-white/10 backdrop-blur-xl rounded-xl text-white font-black hover:bg-white/20 border border-white/10 active:scale-95 transition-all">10ë¶„</button>
                    <div
                        class="timer-custom-wrap flex items-center gap-2 px-3 py-1.5 bg-white/10 backdrop-blur-xl rounded-xl border border-white/10">
                        <input id="customTimerMinutesInput" type="number" min="1" max="999" step="1" value="5"
                            inputmode="numeric"
                            class="w-16 bg-transparent text-center text-white font-black focus:outline-none"
                            aria-label="íƒ€ì´ë¨¸ ë¶„ ë‹¨ìœ„ ì„¤ì •">
                        <span class="text-indigo-100 font-bold">ë¶„</span>
                        <button onclick="window.dtApp.applyCustomTimerMinutes()"
                            class="px-3 py-1.5 bg-white/20 rounded-lg text-white font-black hover:bg-white/30 active:scale-95 transition-all">ì„¤ì •</button>
                    </div>
                    <div class="timer-divider w-px h-auto bg-white/10 mx-1"></div>
                    <button onclick="window.dtApp.resetTimer()"
                        class="timer-reset-btn px-5 py-2.5 bg-red-500/20 backdrop-blur-xl rounded-xl text-red-200 font-extrabold hover:bg-red-500/40 border border-red-500/20 active:scale-95 transition-all">ì´ˆê¸°í™”</button>
                </div>
            </div>

            <!-- 2. Student Status Grid (Bottom) -->
            <div
                class="dt-student-card h-64 bg-slate-800/40 backdrop-blur-xl rounded-[2.5rem] p-8 border border-slate-700/50 flex flex-col shadow-2xl">
                <div class="flex justify-between items-center mb-6 px-2">
                    <div class="flex items-center gap-4">
                        <h3 class="text-2xl font-black flex items-center gap-2 text-white">
                            <span class="text-yellow-400">ğŸ†</span>
                            ë¯¸ì…˜ í˜„í™©
                        </h3>
                        <!-- Progress Bar -->
                        <div
                            class="flex items-center gap-4 ml-6 bg-slate-900/40 px-5 py-2.5 rounded-2xl border border-slate-700/50">
                            <div class="text-xs text-slate-400 font-bold uppercase tracking-widest">ì™„ë£Œìœ¨</div>
                            <div
                                class="w-48 h-2.5 bg-slate-800 rounded-full overflow-hidden border border-slate-700 flex-shrink-0">
                                <div id="missionProgressBar"
                                    class="h-full bg-gradient-to-r from-indigo-500 to-emerald-400 w-[0%] transition-all duration-1000 shadow-[0_0_10px_rgba(52,211,153,0.3)]">
                                </div>
                            </div>
                            <div id="missionProgressText" class="text-sm font-black text-emerald-400 min-w-[30px]">0%
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.dtApp.resetToMockup()"
                            class="p-2.5 bg-slate-700/50 hover:bg-red-500/20 text-slate-400 hover:text-red-400 rounded-xl transition-all"
                            title="ë°ì´í„° ì´ˆê¸°í™”">
                            <i class="fa-solid fa-rotate-left"></i>
                        </button>
                    </div>
                </div>

                <!-- Student Grid Container -->
                <div id="mainStudentGrid"
                    class="dt-student-grid grid grid-cols-6 lg:grid-cols-8 gap-4 overflow-y-auto pr-2 custom-scrollbar h-full content-start">
                    <div class="col-span-full text-center text-sm font-semibold text-slate-500 py-8">
                        í•™ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>

        <!-- [Right Column - 4] Roles & Notices -->
        <div class="dt-right-column lg:col-span-4 flex flex-col gap-6 h-full min-h-0">

            <!-- 3. Today's Roles -->
            <div
                class="dt-role-card bg-slate-800/40 backdrop-blur-xl rounded-[2.5rem] p-8 border border-slate-700/50 flex-1 flex flex-col shadow-2xl min-h-0">
                <div class="flex justify-between items-center mb-6 px-2">
                    <h3 class="text-2xl font-black text-white flex items-center gap-2">
                        <span
                            class="bg-pink-500/20 text-pink-400 w-10 h-10 flex items-center justify-center rounded-xl text-lg">ğŸ‘‘</span>
                        ì˜¤ëŠ˜ì˜ ì—­í• 
                    </h3>
                    <div class="flex items-center gap-2">
                        <button onclick="window.dtApp.openCallMode()" title="í˜¸ëª… ëª¨ë“œ"
                            class="w-10 h-10 flex items-center justify-center rounded-xl text-amber-400/80 hover:text-amber-300 hover:bg-amber-500/10 transition-all border border-transparent hover:border-amber-300/30">
                            <i class="fa-solid fa-bullhorn"></i>
                        </button>
                        <button onclick="window.dtApp.rotateRolesManually()" title="ì—­í•  ìˆœí™˜"
                            class="w-10 h-10 flex items-center justify-center rounded-xl text-slate-500 hover:text-white hover:bg-slate-700 transition-all">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </button>
                    </div>
                </div>

                <div id="mainRoleList" class="flex-1 flex flex-col gap-4 overflow-y-auto custom-scrollbar pr-2">
                    <div class="text-center text-sm font-semibold text-slate-500 py-8">
                        ì—­í•  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.
                    </div>
                </div>
            </div>

            <!-- 4. Notices / Broadcast -->
            <div
                class="dt-notice-card bg-slate-800/40 backdrop-blur-xl rounded-[2.5rem] p-8 border border-slate-700/50 h-60 flex flex-col shadow-2xl">
                <div class="flex justify-between items-start mb-4 px-2">
                    <h3 class="text-xl font-black text-white flex items-center gap-2" id="noticeTitleDisplay">
                        <i class="fa-regular fa-bell text-yellow-400"></i>
                        ì•Œë¦¼ì‚¬í•­ ì—†ìŒ
                    </h3>
                    <button id="broadcastToggleBtn"
                        class="w-10 h-10 flex items-center justify-center rounded-xl text-slate-500 hover:text-yellow-400 hover:bg-slate-700/50 transition-all"
                        onclick="window.dtApp.openBroadcastModal()">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                </div>

                <div class="flex-1 relative overflow-hidden">
                    <p class="text-slate-400 font-bold leading-relaxed whitespace-pre-line" id="dashboardBroadcastText">í´ë¦­í•´ì„œ ì•„ì´ë“¤ì—ê²Œ ì „ë‹¬í•  ê³µì§€ì‚¬í•­ì´ë‚˜ ì¤€ë¹„ë¬¼ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Quote -->
    <footer class="mt-4 text-center text-slate-600 text-sm font-medium">
        "ì²œë¦¬ ê¸¸ë„ í•œ ê±¸ìŒë¶€í„°! ì˜¤ëŠ˜ë„ ë©‹ì§„ í•˜ë£¨ ë³´ë‚´ì! ğŸš€"
    </footer>

    <!-- Conflict Resolution Modal -->
    <div id="assignmentConflictModal"
        class="fixed inset-0 z-[220] hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div
            class="bg-slate-800 p-8 rounded-3xl shadow-2xl w-full max-w-lg border border-slate-700 transform scale-95 transition-transform">
            <h3 class="text-2xl font-black text-white mb-2">ë°°ì • ì¶©ëŒ</h3>
            <p class="text-slate-300 leading-relaxed">
                <span id="conflictStudentName" class="font-black text-indigo-300"></span> í•™ìƒì€ ì´ë¯¸
                <span id="conflictFromRole" class="font-black text-rose-300"></span> ì—­í• ì— ë°°ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
            </p>
            <p class="text-slate-400 text-sm mt-2 mb-6">
                <span id="conflictToRole" class="font-bold text-sky-300"></span> ì—­í• ë¡œ ì˜®ê¸¸ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”.
            </p>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="window.dtApp.resolveConflict('swap')"
                    class="w-full py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-black transition">
                    ìŠ¤ì™‘ ë°°ì • (ì¶”ì²œ)
                </button>
                <button onclick="window.dtApp.resolveConflict('move')"
                    class="w-full py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-100 font-bold transition">
                    ê¸°ì¡´ ì—­í•  í•´ì œ í›„ ì´ë™
                </button>
                <button onclick="window.dtApp.closeConflictModal()"
                    class="w-full py-3 rounded-xl border border-slate-600 text-slate-300 hover:bg-slate-700/60 font-bold transition">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>

    <!-- Call Mode Modal -->
    <div id="callModeModal"
        class="fixed inset-0 z-[230] hidden items-center justify-center dt-callmode-overlay backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div
            class="w-full max-w-3xl mx-4 bg-slate-900/85 border border-indigo-400/25 rounded-[2rem] p-8 shadow-2xl">
            <div class="flex justify-between items-center gap-3 mb-6">
                <h3 class="text-2xl md:text-3xl font-black text-white flex items-center gap-3">
                    <span class="text-amber-300 text-3xl">ğŸ“£</span>
                    í˜¸ëª… ëª¨ë“œ
                </h3>
                <button onclick="window.dtApp.closeCallMode()"
                    class="w-11 h-11 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 flex items-center justify-center transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div id="callModeFocusCard" class="rounded-3xl border border-indigo-300/20 bg-slate-800/70 p-8 text-center">
                <p class="text-xs uppercase tracking-[0.18em] font-extrabold text-indigo-300 mb-3" id="callModeTimeSlot">TIME SLOT</p>
                <p class="text-4xl md:text-5xl font-black text-white leading-tight break-keep" id="callModeRoleName">ì—­í•  ì´ë¦„</p>
                <p class="mt-4 text-5xl md:text-6xl font-black text-emerald-300 break-keep" id="callModeStudentName">ë‹´ë‹¹ í•™ìƒ</p>
                <p class="mt-6 text-sm font-bold text-slate-400" id="callModeIndexText">1 / 1</p>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-3">
                <button onclick="window.dtApp.prevCallRole()"
                    class="py-3 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-100 font-bold transition">
                    ì´ì „
                </button>
                <button onclick="window.dtApp.nextCallRole()"
                    class="py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-black transition">
                    ë‹¤ìŒ
                </button>
                <button id="callModeAutoBtn" onclick="window.dtApp.toggleCallAuto()"
                    class="py-3 rounded-xl bg-emerald-600/90 hover:bg-emerald-500 text-white font-black transition">
                    ìë™ ì¬ìƒ ì¼œê¸°
                </button>
                <button onclick="window.dtApp.playCallChime()"
                    class="py-3 rounded-xl bg-amber-500/90 hover:bg-amber-400 text-slate-900 font-black transition">
                    íš¨ê³¼ìŒ ë¯¸ë¦¬ë“£ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- Modals (Hidden) -->
    <div id="broadcastModal"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div
            class="bg-slate-800 p-8 rounded-3xl shadow-2xl w-full max-w-lg border border-slate-700 transform scale-95 transition-transform">
            <h3 class="text-2xl font-bold text-white mb-6">ğŸ“¢ ì•Œë¦¼ì‚¬í•­ ë“±ë¡</h3>
            <textarea id="broadcastInput" rows="4"
                class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-white text-lg focus:outline-none focus:border-indigo-500 transition-colors resize-none mb-6"
                placeholder="í•™ìƒë“¤ì—ê²Œ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <div class="flex gap-4">
                <button id="broadcastCancelBtn"
                    class="flex-1 py-3 bg-slate-700 text-slate-300 rounded-xl font-bold hover:bg-slate-600 transition">ì·¨ì†Œ</button>
                <button id="broadcastSubmitBtn"
                    class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-500 transition">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Settings/Student Modal Reuse -->
    <div id="studentModal"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div
            class="bg-slate-800 p-8 rounded-3xl shadow-2xl w-full max-w-2xl border border-slate-700 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white" id="studentModalTitle">í•™ìƒ ì„ íƒ</h3>
                <button onclick="window.dtApp.closeStudentModal()" class="text-slate-400 hover:text-white"><i
                        class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div id="studentListGrid" class="grid grid-cols-4 gap-3 overflow-y-auto custom-scrollbar p-1">
                <!-- Populated by JS -->
            </div>
            <div class="mt-6 pt-6 border-t border-slate-700 flex justify-end">
                <button id="toggleRoleStatusBtn"
                    class="px-6 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-check"></i> ì™„ë£Œ ì²˜ë¦¬ / ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>

    <!-- Mission Update Modal -->
    <div id="missionModal"
        class="fixed inset-0 z-[200] hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div
            class="bg-slate-800 p-8 rounded-3xl shadow-2xl w-full max-w-lg border border-slate-700 transform scale-95 transition-transform">
            <h3 class="text-2xl font-bold text-white mb-6">ğŸ¯ ë¯¸ì…˜ ë‚´ìš© ë³€ê²½</h3>
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-slate-400 text-sm font-bold mb-2 ml-1">ëŒ€ì œëª©</label>
                    <input id="missionTitleInput" type="text"
                        class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-white text-lg focus:outline-none focus:border-indigo-500 transition-colors"
                        placeholder="ì˜ˆ: ìˆ˜ì—… ì‹œê°„ì— ì§‘ì¤‘í•˜ê¸°">
                </div>
                <div>
                    <label class="block text-slate-400 text-sm font-bold mb-2 ml-1">ì†Œì œëª©/ì„¤ëª…</label>
                    <textarea id="missionDescInput" rows="3"
                        class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-white text-base focus:outline-none focus:border-indigo-500 transition-colors resize-none"
                        placeholder="ì˜ˆ: êµê³¼ì„œ 24ìª½ì„ í´ê³  ì„ ìƒë‹˜ì„ ë³´ì„¸ìš”."></textarea>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="window.dtApp.closeMissionModal()"
                    class="flex-1 py-3 bg-slate-700 text-slate-300 rounded-xl font-bold hover:bg-slate-600 transition">ì·¨ì†Œ</button>
                <button onclick="window.dtApp.handleUpdateMission()"
                    class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-500 transition">ë³€ê²½í•˜ê¸°</button>
            </div>
        </div>
    </div>

    {% if student_games_launch_url %}
    <div id="studentGamesQrModal"
        class="fixed inset-0 z-[240] hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div
            class="bg-slate-800 p-5 md:p-6 rounded-3xl shadow-2xl w-full max-w-md border border-slate-700 transform scale-95 transition-transform">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="text-xl md:text-2xl font-black text-white">í•™ìƒ ê²Œì„ ì…ì¥ QR</h3>
                    <p class="text-xs md:text-sm text-slate-400 mt-1">ìœ íš¨ì‹œê°„: {{ student_games_expires_hours }}ì‹œê°„</p>
                </div>
                <button onclick="closeStudentGamesQrModal()" class="text-slate-400 hover:text-white transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="bg-white rounded-2xl p-3 flex justify-center mb-3">
                <img src="{{ student_games_qr_data_url }}" alt="í•™ìƒ ê²Œì„ ì…ì¥ QR ì½”ë“œ" class="w-44 h-44 md:w-48 md:h-48 max-w-full">
            </div>

            <label for="studentGamesLaunchUrl" class="block text-xs font-bold text-slate-400 mb-1">í•™ìƒìš© ë§í¬</label>
            <input id="studentGamesLaunchUrl" type="text" readonly value="{{ student_games_launch_url }}"
                class="w-full bg-slate-900 border border-slate-600 rounded-xl p-2.5 text-slate-200 text-xs md:text-sm mb-3">

            <div class="flex gap-3">
                <button onclick="copyStudentGamesLink()"
                    class="flex-1 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold transition">
                    ë§í¬ ë³µì‚¬
                </button>
                <a href="{{ student_games_launch_url }}" target="_blank" rel="noopener noreferrer"
                    class="flex-1 py-2.5 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-100 font-bold text-center transition">
                    ìƒˆ ì°½ ë¯¸ë¦¬ë³´ê¸°
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tier Limit Modal (Friendly UX) -->
    <div id="limitModal" class="fixed inset-0 z-[300] hidden items-center justify-center bg-black/90 backdrop-blur-md">
        <div
            class="bg-slate-800 p-8 rounded-[2.5rem] shadow-2xl w-full max-w-lg border border-slate-700 text-center relative overflow-hidden">
            <div class="absolute -top-24 -left-24 w-48 h-48 bg-indigo-600/10 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-24 -right-24 w-48 h-48 bg-purple-600/10 rounded-full blur-3xl"></div>

            <div class="relative z-10">
                <div
                    class="w-20 h-20 bg-indigo-600/20 text-indigo-400 rounded-3xl flex items-center justify-center text-4xl mx-auto mb-6">
                    <i class="fa-solid fa-lock"></i>
                </div>
                <h3 class="text-3xl font-black text-white mb-2">ì„ ìƒë‹˜, ê³ ìƒ ë§ìœ¼ì…¨ì–´ìš”!</h3>
                <p class="text-slate-400 text-lg mb-8 leading-relaxed">
                    ì˜¤ëŠ˜ì˜ ì†Œì¤‘í•œ ê¸°ë¡ì´ <span class="text-indigo-400 font-bold">íœ˜ë°œì„± ë©”ëª¨ë¦¬</span>ì— ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.<br>
                    ê°€ì…í•˜ì‹œë©´ ì´ ë°ì´í„°ë“¤ì„ ì•ˆì „í•œ í´ë¼ìš°ë“œë¡œ ì˜®ê²¨ ë“œë¦´ê¹Œìš”? ğŸ˜Š
                </p>

                <div class="space-y-3">
                    <a href="{% url 'account_signup' %}"
                        class="block w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black text-xl transition-all shadow-xl shadow-indigo-600/30 hover:-translate-y-1">
                        ê³„ì • ë§Œë“¤ê³  ë°ì´í„° ë³´ì¡´í•˜ê¸°
                    </a>
                    <button onclick="document.getElementById('limitModal').classList.add('hidden')"
                        class="block w-full py-3 text-slate-500 hover:text-slate-300 font-bold transition-colors">
                        ë‚˜ì¤‘ì— í• ê²Œìš”
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Audio Elements -->
    <div id="audioContainer"></div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    window.dtApiEndpoints = {
        dataUrl: "{% url 'dt_api_data' %}",
        assignUrl: "{% url 'dt_api_assign' %}",
        rotateUrl: "{% url 'dt_api_rotate' %}",
        broadcastUrl: "{% url 'dt_api_broadcast_update' %}",
        missionUrl: "{% url 'dt_api_mission_update' %}",
        spotlightUrl: "{% url 'dt_api_spotlight_update' %}",
        resetUrl: "{% url 'dt_api_reset' %}",
        toggleMissionUrlTemplate: "{% url 'dt_api_toggle_mission' 999999 %}",
        toggleAssignmentUrlTemplate: "{% url 'dt_api_toggle' 999999 %}",
    };
</script>
<script src="{% static 'products/dutyticker/js/dutyticker.js' %}"></script>
<script>
    // Header Clock Logic
    function updateHeaderClock() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });
        const timeStr = now.toLocaleTimeString('ko-KR', { hour12: true, hour: '2-digit', minute: '2-digit' });

        const dateEl = document.getElementById('headerDate');
        const timeEl = document.getElementById('headerTime');
        if (dateEl) dateEl.textContent = dateStr;
        if (timeEl) timeEl.textContent = timeStr;
    }
    setInterval(updateHeaderClock, 1000);
    updateHeaderClock();

    // App Init (DOMContentLoaded ì´í›„ì—ë„ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”)
    function bootDutyTicker() {
        if (window.dtApp) return;
        window.dtApp = new DutyTickerManager();
        window.dtApp.init();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bootDutyTicker);
    } else {
        bootDutyTicker();
    }

    function openStudentGamesQrModal() {
        const modal = document.getElementById('studentGamesQrModal');
        if (!modal) return;
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
            modal.classList.remove('opacity-0');
            const panel = modal.firstElementChild;
            if (panel) panel.classList.remove('scale-95');
        });
    }

    function closeStudentGamesQrModal() {
        const modal = document.getElementById('studentGamesQrModal');
        if (!modal) return;
        modal.classList.add('opacity-0');
        const panel = modal.firstElementChild;
        if (panel) panel.classList.add('scale-95');
        setTimeout(() => modal.classList.add('hidden'), 180);
    }

    async function copyStudentGamesLink() {
        const input = document.getElementById('studentGamesLaunchUrl');
        if (!input) return;
        const text = input.value;
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
            } else {
                input.select();
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
            }
            alert('í•™ìƒìš© ë§í¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
            alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì„ íƒí•´ì„œ ë³µì‚¬í•´ ì£¼ì„¸ìš”.');
        }
    }
</script>
{% endblock %}
