{% extends 'base.html' %}

{% block title %}?⑤뱾由?AI 梨쀫큸 - Eduitit{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 280px);
        min-height: 400px;
    }

    .chat-messages {
        scrollbar-width: thin;
        scrollbar-color: rgba(163, 177, 198, 0.5) transparent;
    }

    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(163, 177, 198, 0.5);
        border-radius: 3px;
    }

    .message-bubble {
        max-width: 80%;
        word-wrap: break-word;
    }

    .message-bubble.user {
        background: linear-gradient(135deg, #EC4899, #DB2777);
        color: white;
        border-radius: 20px 20px 4px 20px;
    }

    .message-bubble.assistant {
        background: white;
        color: #374151;
        border-radius: 20px 20px 20px 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* ??댄븨 ?좊땲硫붿씠??*/
    .typing-indicator span {
        animation: typing 1.4s infinite;
        display: inline-block;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-4px);
        }
    }

    /* 留덊겕?ㅼ슫 ?ㅽ???*/
    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3 {
        font-weight: bold;
        margin-top: 1em;
        margin-bottom: 0.5em;
    }

    .markdown-content ul,
    .markdown-content ol {
        margin-left: 1.5em;
        margin-bottom: 0.5em;
    }

    .markdown-content li {
        margin-bottom: 0.25em;
    }

    .markdown-content p {
        margin-bottom: 0.5em;
    }

    .markdown-content code {
        background: rgba(0, 0, 0, 0.05);
        padding: 0.1em 0.3em;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .markdown-content pre {
        background: rgba(0, 0, 0, 0.05);
        padding: 1em;
        border-radius: 8px;
        overflow-x: auto;
        margin: 0.5em 0;
    }

    .markdown-content strong {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<main class="pt-24 pb-8 px-4 min-h-screen">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-5xl font-bold text-gray-700 mb-2">
                <i class="fa-solid fa-comments text-pink-500 mr-2"></i>?⑤뱾由?AI 梨쀫큸
            </h1>
            <p class="text-2xl text-gray-500">?⑤뱾由?寃뚯떆臾?湲곕컲 吏덈Ц ?듬?</p>

            <!-- ?곹깭 ?쒖떆 -->
            <div class="flex flex-wrap justify-center gap-3 mt-4">
                <span class="px-4 py-2 rounded-full bg-pink-100 text-pink-700 text-lg">
                    <i class="fa-solid fa-file-lines mr-1"></i>
                    臾몄꽌 {{ doc_count }}媛?
                </span>
                <span class="px-4 py-2 rounded-full bg-blue-100 text-blue-700 text-lg">
                    <i class="fa-solid fa-plug mr-1"></i>
                    ?곕룞 {{ linked_count }}媛?
                </span>
                <span class="px-4 py-2 rounded-full bg-purple-100 text-purple-700 text-lg">
                    <i class="fa-solid fa-puzzle-piece mr-1"></i>
                    泥?겕 {{ chunk_count }}媛?
                </span>
                <a href="{% url 'padlet_bot:manage_docs' %}"
                    class="px-4 py-2 rounded-full bg-orange-100 text-orange-700 text-lg hover:bg-orange-200 transition">
                    <i class="fa-solid fa-folder-open mr-1"></i>
                    ?먮즺 ?낅줈??
                </a>
                <a href="{% url 'padlet_bot:api_connect' %}"
                    class="px-4 py-2 rounded-full bg-blue-100 text-blue-700 text-lg hover:bg-blue-200 transition">
                    <i class="fa-solid fa-plug mr-1"></i>
                    API ?곕룞
                </a>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="clay-card p-4 sm:p-6">
            <!-- Chat Messages -->
            <div id="chatMessages" class="chat-container chat-messages overflow-y-auto mb-4 p-4 rounded-2xl shadow-clay-inner">
                <!-- ?섏쁺 硫붿떆吏 -->
                <div id="welcomeMessage" class="text-center py-12 {% if chat_history %}hidden{% endif %}">
                    <div class="w-24 h-24 mx-auto mb-4 rounded-full shadow-clay flex items-center justify-center">
                        <i class="fa-solid fa-robot text-5xl text-pink-400"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-600 mb-2">{{ welcome_message }}</h2>
                    <p class="text-xl text-gray-500 mb-4">
                        {% if doc_count > 0 %}
                        {{ doc_count }}媛쒖쓽 ?⑤뱾由?臾몄꽌媛 以鍮꾨릺???덉뒿?덈떎.
                        {% else %}
                        ?꾩쭅 ?깅줉???⑤뱾由??곗씠?곌? ?놁뒿?덈떎.
                        {% endif %}
                    </p>
                    <div class="flex flex-wrap justify-center gap-2">
                        <button onclick="sendQuickMessage('?⑤뱾由우뿉 ?대뼡 ?댁슜???덈굹??')"
                            class="px-4 py-2 rounded-full shadow-clay-inner text-lg text-gray-500 hover:text-pink-600 transition">
                            <i class="fa-solid fa-lightbulb mr-1"></i> ?대뼡 ?댁슜???덈굹??
                        </button>
                        <button onclick="sendQuickMessage('媛??留롮씠 ?щ씪??二쇱젣??')"
                            class="px-4 py-2 rounded-full shadow-clay-inner text-lg text-gray-500 hover:text-pink-600 transition">
                            <i class="fa-solid fa-fire mr-1"></i> ?멸린 二쇱젣
                        </button>
                        <button onclick="sendQuickMessage('理쒓렐 寃뚯떆臾??붿빟?댁쨾')"
                            class="px-4 py-2 rounded-full shadow-clay-inner text-lg text-gray-500 hover:text-pink-600 transition">
                            <i class="fa-solid fa-clock mr-1"></i> 理쒓렐 寃뚯떆臾?
                        </button>
                    </div>
                </div>

                <!-- 湲곗〈 梨꾪똿 湲곕줉 -->
                {% for msg in chat_history %}
                <div class="flex {% if msg.role == 'user' %}justify-end{% else %}justify-start{% endif %} mb-4">
                    <div class="message-bubble {{ msg.role }} px-4 py-3 text-xl">
                        {% if msg.role == 'assistant' %}
                        <div class="markdown-content">{{ msg.content|linebreaks }}</div>
                        {% else %}
                        {{ msg.content }}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Input Area -->
            <form id="chatForm" class="flex gap-3">
                {% csrf_token %}
                <div class="flex-1 relative">
                    <input type="text" id="messageInput" name="message"
                        class="w-full px-5 py-4 rounded-2xl shadow-clay-inner bg-transparent text-xl focus:outline-none focus:ring-2 focus:ring-pink-300 pr-12"
                        placeholder="?⑤뱾由우뿉 ???吏덈Ц?섏꽭??.." autocomplete="off">
                    <button type="button" onclick="clearChat()"
                        class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 transition flex items-center justify-center"
                        title="???珥덇린??>
                        <i class="fa-solid fa-trash-can text-sm"></i>
                    </button>
                </div>
                <button type="submit" id="sendButton"
                    class="clay-card px-6 py-4 text-xl font-bold text-pink-600 hover:text-pink-700 hover:shadow-clay-hover transition flex items-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i>
                    <span class="hidden sm:inline">?꾩넚</span>
                </button>
            </form>
        </div>

        <!-- Privacy Notice -->
        <p class="text-center text-lg text-gray-400 mt-4">
            <i class="fa-solid fa-lock mr-1"></i>
            ????댁슜? 釉뚮씪?곗? ?몄뀡?먮쭔 ??λ릺硫? 李쎌쓣 ?レ쑝硫???젣?⑸땲??
        </p>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<script>
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const welcomeMessage = document.getElementById('welcomeMessage');

    // ?ㅽ겕濡ㅼ쓣 留??꾨옒濡?
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // 硫붿떆吏 異붽?
    function addMessage(content, role) {
        welcomeMessage.classList.add('hidden');

        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} mb-4`;

        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${role} px-4 py-3 text-xl`;

        if (role === 'assistant') {
            // DOMPurify濡?XSS 諛⑹?
            const sanitizedHTML = DOMPurify.sanitize(marked.parse(content));
            bubble.innerHTML = `<div class="markdown-content">${sanitizedHTML}</div>`;
        } else {
            bubble.textContent = content;
        }

        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // ??댄븨 ?몃뵒耳?댄꽣 異붽?
    function addTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typingIndicator';
        typingDiv.className = 'flex justify-start mb-4';
        typingDiv.innerHTML = `
            <div class="message-bubble assistant px-4 py-3 text-xl">
                <span class="typing-indicator">
                    <span class="inline-block w-2 h-2 bg-gray-400 rounded-full mx-0.5"></span>
                    <span class="inline-block w-2 h-2 bg-gray-400 rounded-full mx-0.5"></span>
                    <span class="inline-block w-2 h-2 bg-gray-400 rounded-full mx-0.5"></span>
                </span>
            </div>
        `;
        chatMessages.appendChild(typingDiv);
        scrollToBottom();
    }

    // ??댄븨 ?몃뵒耳?댄꽣 ?쒓굅
    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    // 硫붿떆吏 ?꾩넚
    async function sendMessage(message) {
        if (!message.trim()) return;

        // UI ?낅뜲?댄듃
        addMessage(message, 'user');
        messageInput.value = '';
        messageInput.disabled = true;
        sendButton.disabled = true;
        addTypingIndicator();

        try {
            const formData = new FormData();
            formData.append('message', message);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            const response = await fetch('{% url "padlet_bot:send_message" %}', {
                method: 'POST',
                body: formData,
            });

            const data = await response.json();
            removeTypingIndicator();

            if (data.success) {
                addMessage(data.response, 'assistant');
            } else {
                addMessage(`?ㅻ쪟: ${data.error}`, 'assistant');
            }
        } catch (error) {
            removeTypingIndicator();
            addMessage('?ㅽ듃?뚰겕 ?ㅻ쪟媛 諛쒖깮?덉뒿?덈떎. ?ㅼ떆 ?쒕룄?댁＜?몄슂.', 'assistant');
        } finally {
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }
    }

    // 鍮좊Ⅸ 硫붿떆吏 ?꾩넚
    function sendQuickMessage(message) {
        sendMessage(message);
    }

    // ???쒖텧
    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        sendMessage(messageInput.value);
    });

    // ???珥덇린??
    async function clearChat() {
        if (!confirm('????댁슜??紐⑤몢 ??젣?섏떆寃좎뒿?덇퉴?')) return;

        try {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            await fetch('{% url "padlet_bot:clear_chat" %}', {
                method: 'POST',
                body: formData,
            });

            // UI 珥덇린??
            chatMessages.innerHTML = '';
            welcomeMessage.classList.remove('hidden');
            chatMessages.appendChild(welcomeMessage);
        } catch (error) {
            console.error('珥덇린???ㅽ뙣:', error);
        }
    }

    // ?섏씠吏 濡쒕뱶 ???ㅽ겕濡?
    scrollToBottom();
</script>
{% endblock %}

