{% extends 'base.html' %}

{% block title %}?⑤뱾由?API ?곕룞 - Eduitit{% endblock %}

{% block extra_css %}
<style>
    .board-card {
        transition: all 0.3s ease;
    }

    .board-card:hover {
        transform: translateY(-2px);
    }

    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
    }

    .status-synced {
        background: #D1FAE5;
        color: #059669;
    }

    .status-pending {
        background: #FEF3C7;
        color: #D97706;
    }
</style>
{% endblock %}

{% block content %}
<main class="pt-24 pb-8 px-4 min-h-screen">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-gray-700 mb-2">
                <i class="fa-solid fa-plug text-blue-500 mr-2"></i>?⑤뱾由?API ?곕룞
            </h1>
            <p class="text-2xl text-gray-500">?⑤뱾由?URL???낅젰?섏뿬 ?ㅼ떆媛??곕룞</p>
            <div class="flex justify-center gap-4 mt-4">
                <a href="{% url 'padlet_bot:chat' %}"
                    class="px-6 py-3 rounded-full shadow-clay text-pink-600 hover:text-pink-700 transition">
                    <i class="fa-solid fa-comments mr-2"></i>梨쀫큸
                </a>
                <a href="{% url 'padlet_bot:manage_docs' %}"
                    class="px-6 py-3 rounded-full shadow-clay text-orange-600 hover:text-orange-700 transition">
                    <i class="fa-solid fa-folder-open mr-2"></i>?뚯씪 ?낅줈??                </a>
            </div>
        </div>

        {% if not api_configured %}
        <!-- API ??誘몄꽕??寃쎄퀬 -->
        <div class="clay-card p-6 mb-8 bg-pink-50 border-2 border-pink-200" data-aos="fade-up">
            <div class="flex items-start gap-4">
                <i class="fa-solid fa-key text-4xl text-pink-500 mt-1"></i>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-pink-700 mb-2">?⑤뱾由?API ?ㅻ? ?깅줉?댁＜?몄슂!</h2>
                    <p class="text-xl text-pink-600 mb-2 font-hand">?⑤뱾由?API ?곕룞 湲곕뒫? ?ъ슜?먯쓽 <strong>媛쒖씤 API ??Pro/Platinum
                            ?댁긽)</strong>媛 ?꾩슂?⑸땲??</p>
                    <p class="text-lg text-pink-500 mb-6 font-hand">
                        <i class="fa-solid fa-info-circle mr-1"></i>
                        李멸퀬: ?⑤뱾由?API??Pro ?뚮옖 ?댁긽???좊즺 ?ъ슜?먮쭔 諛쒓툒諛쏆쓣 ???덉뒿?덈떎.
                    </p>

                    <div class="flex flex-col sm:flex-row gap-4">
                        <a href="{% url 'settings' %}"
                            class="px-6 py-3 rounded-2xl bg-pink-500 text-white font-bold text-xl hover:bg-pink-600 transition shadow-clay inline-flex items-center gap-2">
                            <i class="fa-solid fa-gear"></i> ???꾨줈?꾩뿉?????ㅼ젙?섍린
                        </a>
                        <a href="https://padlet.com/settings/developer" target="_blank"
                            class="px-6 py-3 rounded-2xl bg-white text-gray-700 font-bold text-xl hover:bg-gray-50 transition border border-gray-200 inline-flex items-center gap-2">
                            <i class="fa-solid fa-external-link text-sm"></i> ?⑤뱾由우뿉????諛쒓툒諛쏄린
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- ?곕룞 ??-->
            <div class="lg:col-span-1">
                <div class="clay-card p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">
                        <i class="fa-solid fa-link text-blue-500 mr-2"></i>???⑤뱾由??곕룞
                    </h2>

                    <form id="linkForm" class="space-y-4">
                        {% csrf_token %}
                        <div>
                            <label class="block text-lg text-gray-600 mb-2">?⑤뱾由?URL</label>
                            <input type="url" id="padletUrl" name="padlet_url"
                                class="w-full px-4 py-3 rounded-2xl shadow-clay-inner bg-transparent text-xl focus:outline-none focus:ring-2 focus:ring-blue-300"
                                placeholder="https://padlet.com/..." {% if not api_configured %}disabled{% endif %}>
                        </div>

                        <button type="submit" id="linkBtn"
                            class="w-full py-4 rounded-2xl shadow-clay text-xl font-bold text-blue-600 hover:text-blue-700 hover:shadow-clay-hover transition disabled:opacity-50 disabled:cursor-not-allowed"
                            {% if not api_configured %}disabled{% endif %}>
                            <i class="fa-solid fa-plug mr-2"></i>?곕룞?섍린
                        </button>
                    </form>

                    <!-- ?덈궡 -->
                    <div class="mt-6 p-4 rounded-xl bg-blue-50 text-blue-700 text-lg">
                        <p class="font-bold mb-2"><i class="fa-solid fa-lightbulb mr-1"></i> ?ъ슜 諛⑸쾿</p>
                        <ol class="list-decimal list-inside space-y-1 text-base">
                            <li>?⑤뱾由?URL??蹂듭궗</li>
                            <li>???낅젰李쎌뿉 遺숈뿬?ｊ린</li>
                            <li>"?곕룞?섍린" ?대┃</li>
                            <li>"?숆린?? 踰꾪듉?쇰줈 ?곗씠??媛?몄삤湲?/li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- ?곕룞???⑤뱾由?紐⑸줉 -->
            <div class="lg:col-span-2">
                <div class="clay-card p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">
                        <i class="fa-solid fa-list text-purple-500 mr-2"></i>?곕룞???⑤뱾由?                        <span class="text-lg text-gray-400 ml-2">({{ linked_boards.count }}媛?</span>
                    </h2>

                    {% if linked_boards %}
                    <div class="space-y-4">
                        {% for board in linked_boards %}
                        <div class="board-card p-4 rounded-2xl shadow-clay-inner flex flex-col sm:flex-row sm:items-center gap-4"
                            id="board-{{ board.pk }}">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span
                                        class="status-badge {% if board.is_processed %}status-synced{% else %}status-pending{% endif %}">
                                        {% if board.is_processed %}?숆린?붾맖{% else %}?湲곗쨷{% endif %}
                                    </span>
                                    <h3 class="text-xl font-bold text-gray-700">{{ board.title }}</h3>
                                </div>
                                <p class="text-gray-500 text-base mb-1">
                                    <i class="fa-solid fa-sticky-note mr-1"></i>{{ board.post_count }}媛?寃뚯떆臾?                                    {% if board.chunk_count > 0 %}
                                    쨌 <i class="fa-solid fa-puzzle-piece mr-1"></i>{{ board.chunk_count }}泥?겕
                                    {% endif %}
                                </p>
                                <p class="text-gray-400 text-sm">
                                    {% if board.last_synced %}
                                    留덉?留??숆린?? {{ board.last_synced|date:"Y.m.d H:i" }}
                                    {% else %}
                                    ?꾩쭅 ?숆린?붾릺吏 ?딆쓬
                                    {% endif %}
                                </p>
                            </div>

                            <div class="flex items-center gap-2">
                                <button onclick="syncPadlet('{{ board.pk }}')"
                                    class="px-4 py-2 rounded-full shadow-clay text-blue-600 hover:text-blue-700 text-base font-bold transition sync-btn"
                                    data-board-id="{{ board.pk }}" {% if not api_configured %}disabled{% endif %}>
                                    <i class="fa-solid fa-sync mr-1"></i>?숆린??                                </button>

                                <button onclick="unlinkPadlet('{{ board.pk }}', '{{ board.title|escapejs }}')"
                                    class="px-4 py-2 rounded-full shadow-clay text-red-500 hover:text-red-600 text-base font-bold transition">
                                    <i class="fa-solid fa-unlink"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-12 text-gray-400">
                        <i class="fa-solid fa-plug text-6xl mb-4"></i>
                        <p class="text-xl">?꾩쭅 ?곕룞???⑤뱾由우씠 ?놁뒿?덈떎.</p>
                        <p class="text-lg">?쇱そ?먯꽌 ?⑤뱾由?URL???낅젰?댁＜?몄슂.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    const linkForm = document.getElementById('linkForm');
    const linkBtn = document.getElementById('linkBtn');
    const padletUrlInput = document.getElementById('padletUrl');

    // ?⑤뱾由??곕룞
    linkForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const url = padletUrlInput.value.trim();
        if (!url) {
            alert('?⑤뱾由?URL???낅젰?댁＜?몄슂.');
            return;
        }

        linkBtn.disabled = true;
        linkBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>?곕룞 以?..';

        try {
            const formData = new FormData();
            formData.append('padlet_url', url);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            const response = await fetch('{% url "padlet_bot:link_padlet" %}', {
                method: 'POST',
                body: formData,
            });

            const data = await response.json();

            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('?ㅻ쪟: ' + data.error);
            }
        } catch (error) {
            alert('?ㅽ듃?뚰겕 ?ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        } finally {
            linkBtn.disabled = false;
            linkBtn.innerHTML = '<i class="fa-solid fa-plug mr-2"></i>?곕룞?섍린';
        }
    });

    // ?숆린??    async function syncPadlet(boardId) {
        const btn = document.querySelector(`button[data-board-id="${boardId}"]`);
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>?숆린??以?..';

        try {
            const response = await fetch(`/padlet/api/${boardId}/sync/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });

            const data = await response.json();

            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('?ㅻ쪟: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (error) {
            alert('?ㅽ듃?뚰겕 ?ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // ?곕룞 ?댁젣
    async function unlinkPadlet(boardId, title) {
        if (!confirm(`"${title}" ?곕룞???댁젣?섏떆寃좎뒿?덇퉴?\n踰≫꽣DB???곗씠?곕룄 ?④퍡 ??젣?⑸땲??`)) {
            return;
        }

        try {
            const response = await fetch(`/padlet/api/${boardId}/unlink/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            });

            const data = await response.json();

            if (data.success) {
                document.getElementById(`board-${boardId}`).remove();
                alert(data.message);

                // 紐⑸줉??鍮꾨㈃ ?덈줈怨좎묠
                const boards = document.querySelectorAll('.board-card');
                if (boards.length === 0) {
                    location.reload();
                }
            } else {
                alert('?ㅻ쪟: ' + data.error);
            }
        } catch (error) {
            alert('?ㅽ듃?뚰겕 ?ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        }
    }
</script>
{% endblock %}
