{% extends 'base.html' %}

{% block title %}HWP → PDF 초간편 변환기 - Eduitit{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-6 min-h-screen">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12 space-y-4">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-700 font-logo">
                📄 HWP → PDF 초간편 변환기
            </h1>
            <p class="text-xl text-gray-500">
                선생님 컴퓨터에 설치된 '한글' 프로그램을 사용하는 가장 빠르고 안전한 방법입니다.
            </p>
        </div>

        <div class="bg-white/80 backdrop-blur-md rounded-[2.5rem] p-10 shadow-clay-lg border-2 border-white/50">
            <div class="space-y-8">
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-xl">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fa-solid fa-circle-info text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>개인정보 보안:</strong> 파일이 외부 서버로 전송되지 않고 선생님의 PC 내에서만 처리되므로 더욱 안심하고 사용하실 수 있습니다.
                            </p>
                        </div>
                    </div>
                </div>

                {% if not disabled %}
                <form method="post" enctype="multipart/form-data" id="uploadForm" class="space-y-6">
                    {% csrf_token %}

                    <!-- Drag and Drop Area -->
                    <div id="drop-zone"
                        class="border-4 border-dashed border-gray-200 rounded-3xl p-12 text-center transition-all hover:border-purple-300 hover:bg-purple-50/30 group cursor-pointer relative">
                        <input type="file" name="hwp_files" id="file-input" multiple accept=".hwp,.hwpx"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div class="space-y-4">
                            <i
                                class="fa-solid fa-cloud-arrow-up text-6xl text-gray-300 group-hover:text-purple-400 transition-colors"></i>
                            <div class="text-xl text-gray-600">
                                파일을 여기로 드래그하거나 <span class="text-purple-600 font-bold">클릭하여 선택</span>하세요.
                            </div>
                            <p class="text-sm text-gray-400">HWP, HWPX 파일 지원 (여러 장 가능)</p>
                        </div>
                        <div id="file-list" class="mt-6 text-left hidden">
                            <h4 class="font-bold text-gray-700 mb-2">선택된 파일:</h4>
                            <ul class="text-sm text-gray-500 space-y-1" id="selected-files"></ul>
                        </div>
                    </div>

                    <button type="submit" id="convertBtn" disabled
                        class="w-full py-4 bg-gray-200 text-gray-500 rounded-2xl text-xl font-bold transition-all shadow-clay hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed">
                        🚀 변환 시작하기
                    </button>
                </form>
                {% else %}
                <div class="text-center py-10 space-y-4">
                    <i class="fa-solid fa-triangle-exclamation text-5xl text-amber-500"></i>
                    <p class="text-xl text-gray-600">이 기능은 로컬 Windows 환경에서만 사용할 수 있습니다.</p>
                </div>
                {% endif %}

                <!-- Processing UI (Hidden by default) -->
                <div id="processingUI" class="hidden space-y-6 py-10">
                    <div class="flex flex-col items-center space-y-4">
                        <div class="relative w-20 h-20">
                            <div class="absolute inset-0 border-4 border-purple-200 rounded-full"></div>
                            <div
                                class="absolute inset-0 border-4 border-purple-600 rounded-full border-t-transparent animate-spin">
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-700">변환이 진행 중입니다...</h3>
                        <p class="text-gray-500">한글 프로그램이 파일을 PDF로 굽고 있어요. 잠시만 기다려주세요!</p>
                    </div>
                </div>

                <!-- Result Area (Used for success messages/feedback) -->
                {% if messages %}
                <div class="space-y-4">
                    {% for message in messages %}
                    {% if 'download_links' in message.extra_tags %}
                    <!-- Download links are handled separately below -->
                    {% else %}
                    <div
                        class="p-4 rounded-xl {% if message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                        {{ message }}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                {% if result_files %}
                <div class="mt-10 space-y-4">
                    <h3 class="text-2xl font-bold text-gray-700">✅ 변환 완료!</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {% for file in result_files %}
                        <div
                            class="bg-gray-50 p-4 rounded-2xl flex items-center justify-between shadow-sm border border-gray-100">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-file-pdf text-red-500 text-2xl"></i>
                                <span class="font-medium text-gray-700 truncate max-w-[150px]">{{ file.name }}</span>
                            </div>
                            <a href="{{ file.url }}" download
                                class="px-4 py-2 bg-purple-600 text-white rounded-xl text-sm font-bold hover:bg-purple-700 transition">
                                <i class="fa-solid fa-download mr-1"></i> 다운로드
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Guide -->
        <div class="mt-16 bg-[#F8FAFC] rounded-3xl p-8 border border-gray-100">
            <h3 class="text-xl font-bold text-gray-700 mb-6 flex items-center gap-2">
                <i class="fa-solid fa-lightbulb text-yellow-500"></i> 알아두면 좋아요!
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="space-y-2">
                    <div
                        class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-purple-600 font-bold">
                        1</div>
                    <h4 class="font-bold text-gray-800">100% 원본 유지</h4>
                    <p class="text-sm text-gray-500">한글 엔진을 직접 사용하므로 폰트나 표가 깨지지 않습니다.</p>
                </div>
                <div class="space-y-2">
                    <div
                        class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-purple-600 font-bold">
                        2</div>
                    <h4 class="font-bold text-gray-800">인터넷 연결 무관</h4>
                    <p class="text-sm text-gray-500">내부 서버를 거치지 않아 인터넷이 느려도 변환 속도가 빠릅니다.</p>
                </div>
                <div class="space-y-2">
                    <div
                        class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-purple-600 font-bold">
                        3</div>
                    <h4 class="font-bold text-gray-800">한글 설치 필수</h4>
                    <p class="text-sm text-gray-500">선생님 컴퓨터에 아래아한글 프로그램이 설치되어 있어야 작동합니다.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const fileList = document.getElementById('file-list');
    const selectedFilesUl = document.getElementById('selected-files');
    const convertBtn = document.getElementById('convertBtn');
    const uploadForm = document.getElementById('uploadForm');
    const processingUI = document.getElementById('processingUI');

    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            updateFileList(e.target.files);
        });
    }

    function updateFileList(files) {
        if (!selectedFilesUl || !fileList || !convertBtn) return;
        selectedFilesUl.innerHTML = '';
        if (files.length > 0) {
            fileList.classList.remove('hidden');
            convertBtn.disabled = false;
            convertBtn.classList.remove('bg-gray-200', 'text-gray-500');
            convertBtn.classList.add('bg-purple-600', 'text-white');

            Array.from(files).forEach(file => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="fa-regular fa-file-lines mr-2"></i>${file.name}`;
                selectedFilesUl.appendChild(li);
            });
        } else {
            fileList.classList.add('hidden');
            convertBtn.disabled = true;
            convertBtn.classList.add('bg-gray-200', 'text-gray-500');
            convertBtn.classList.remove('bg-purple-600', 'text-white');
        }
    }

    if (uploadForm && processingUI) {
        uploadForm.addEventListener('submit', () => {
            uploadForm.classList.add('hidden');
            processingUI.classList.remove('hidden');
        });
    }

    if (dropZone) {
        ['dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
    }

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
</script>
{% endblock %}