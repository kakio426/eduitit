{% extends 'base.html' %}

{% block title %}Eduitit - ì„ ìƒë‹˜ì˜ ìŠ¤ë§ˆíŠ¸í•œ í•˜ë£¨{% endblock %}

{% block content %}
<!-- URL Definitions -->
{% url 'yut_game' as yut_url %}
{% url 'prompt_lab' as prompt_lab_url %}
{% url 'tool_guide' as tool_guide_url %}

<!-- Main Content -->
<main class="pt-32 pb-20 px-4 md:px-8 min-h-screen max-w-7xl mx-auto">

    <!-- Header -->
    <div class="mb-16 text-center" data-aos="fade-down" data-aos-duration="1000">
        <h1 class="text-7xl md:text-9xl font-bold text-gray-700 mb-2 tracking-tight leading-none text-shadow">
            ì„ ìƒë‹˜ì˜ <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-blue-500">ë””ì§€í„¸ ë¹„ì„œ</span>
        </h1>
        <p class="text-3xl md:text-4xl text-gray-400 font-hand max-w-3xl mx-auto mt-4 leading-relaxed">
            ì„¤ì¹˜ ì—†ì´, ë¡œê·¸ì¸ ì—†ì´. ìˆ˜ì—… ì¤€ë¹„ë¶€í„° í–‰ì • ì—…ë¬´ê¹Œì§€<br>
            ê°€ì¥ ìŠ¤ë§ˆíŠ¸í•œ ë„êµ¬ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”.
        </p>
    </div>

    <!-- BENTO GRID -->
    <div class="bento-grid">

        <!-- 1. [Hero Card] Dynamic Featured Product -->
        <div class="col-span-4 md:col-span-2 row-span-2" data-aos="fade-up" data-aos-delay="100">
            <div class="clay-card p-10 h-full relative overflow-hidden group cursor-pointer bg-[#E0E5EC] focus:ring-4 focus:ring-purple-300 focus:outline-none rounded-3xl"
                role="button" tabindex="0" onkeydown="handleCardKeydown(event, '{{ featured_product.id }}')"
                onclick="openQuickView('{{ featured_product.id }}')">

                <!-- Background decoration -->
                <div
                    class="absolute top-0 right-0 w-80 h-80 bg-purple-100 rounded-bl-full -mr-20 -mt-20 transition-transform duration-500 group-hover:scale-125 z-0">
                </div>

                <div class="relative z-10 h-full flex flex-col justify-between">
                    <div>
                        <span
                            class="px-4 py-1 bg-purple-200 text-purple-700 rounded-full text-xl font-bold shadow-sm mb-6 inline-block">BEST
                            Popular</span>
                        <h2 class="text-6xl font-bold text-gray-700 mb-2 group-hover:text-purple-600 transition-colors">
                            {{ featured_product.title }}
                        </h2>
                        <p class="text-3xl text-gray-500 font-hand leading-tight">
                            {{ featured_product.description|truncatechars:80 }}
                        </p>
                    </div>

                    <div class="flex justify-between items-end mt-8">
                        <div class="text-8xl float-icon">
                            {% if "fa-" in featured_product.icon %}
                            <i class="{{ featured_product.icon }}"></i>
                            {% else %}
                            {{ featured_product.icon }}
                            {% endif %}
                        </div>
                        <div
                            class="w-16 h-16 rounded-full bg-purple-500 text-white shadow-lg flex items-center justify-center text-3xl group-hover:rotate-45 transition-transform duration-300">
                            <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- 2. [Dynamic Product Cards] All Active Products -->
        {% for product in products %}
        {% if product.id != featured_product.id %}

        {% if product.card_size == "wide" %}
        <!-- Wide Card (2 columns) -->
        <div class="col-span-4 md:col-span-2" data-aos="fade-up"
            data-aos-delay="{% widthratio forloop.counter 1 100 %}">
            <div class="clay-card p-10 h-full relative overflow-hidden group cursor-pointer bg-[#E0E5EC] focus:ring-4 focus:ring-purple-300 focus:outline-none rounded-3xl"
                role="button" tabindex="0" onkeydown="handleCardKeydown(event, '{{ product.id }}')"
                onclick="openQuickView('{{ product.id }}')">

                <div class="flex items-center justify-between h-full relative z-10">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            {% if "fa-" in product.icon %}
                            <i class="{{ product.icon }} text-purple-500 text-3xl"></i>
                            {% else %}
                            <span class="text-3xl">{{ product.icon }}</span>
                            {% endif %}
                            <h3 class="text-4xl font-bold text-gray-700 mt-1">{{ product.title }}</h3>
                        </div>
                        <p class="text-2xl text-gray-500 font-hand leading-tight">{{ product.description }}</p>
                    </div>
                    <div
                        class="text-7xl text-purple-200/50 group-hover:text-purple-300/50 transition-colors absolute right-0 bottom-0">
                        {% if "fa-" in product.icon %}
                        <i class="fa-solid fa-magnifying-glass-plus"></i>
                        {% else %}
                        <span>{{ product.icon }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% elif product.card_size == "tall" %}
        <!-- Tall Card (1 column, 2 rows) -->
        <div class="col-span-2 md:col-span-1 row-span-2" data-aos="fade-up"
            data-aos-delay="{% widthratio forloop.counter 1 100 %}">
            <div class="clay-card h-full p-8 {% if product.color_theme == 'dark' %}bg-gray-800 text-white{% else %}bg-[#E0E5EC]{% endif %} group cursor-pointer relative overflow-hidden focus:ring-4 focus:ring-purple-300 focus:outline-none rounded-3xl"
                role="button" tabindex="0" onkeydown="handleCardKeydown(event, '{{ product.id }}')"
                onclick="openQuickView('{{ product.id }}')">

                <div class="relative z-10 flex flex-col h-full justify-between">
                    <div>
                        <span
                            class="{% if product.color_theme == 'dark' %}text-blue-300{% else %}text-purple-600{% endif %} font-bold text-lg tracking-wider uppercase mb-2 block">
                            {{ product.service_type|title }}
                        </span>
                        <h3 class="text-5xl font-bold mb-4 leading-tight mt-2">{{ product.title }}</h3>
                        <p
                            class="{% if product.color_theme == 'dark' %}text-gray-400{% else %}text-gray-600{% endif %} text-2xl leading-tight">
                            {{ product.description }}
                        </p>
                    </div>
                    <div class="mt-4">
                        <span
                            class="inline-block border {% if product.color_theme == 'dark' %}border-gray-600 hover:bg-gray-700{% else %}border-gray-300 hover:bg-gray-100{% endif %} rounded-full px-5 py-2 text-lg transition-colors">
                            ë³´ëŸ¬ê°€ê¸° &rarr;
                        </span>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Small Card (default) -->
        <div class="col-span-2 md:col-span-1" data-aos="fade-up"
            data-aos-delay="{% widthratio forloop.counter 1 100 %}">
            <div class="clay-card p-8 h-full flex flex-col justify-between group cursor-pointer hover:bg-purple-50 transition-colors relative focus:ring-4 focus:ring-purple-300 focus:outline-none rounded-3xl"
                role="button" tabindex="0" onkeydown="handleCardKeydown(event, '{{ product.id }}')"
                onclick="openQuickView('{{ product.id }}')">

                <div
                    class="w-16 h-16 rounded-3xl bg-purple-100 flex items-center justify-center text-purple-500 text-3xl mb-4 shadow-sm">
                    {% if "fa-" in product.icon %}
                    <i class="{{ product.icon }}"></i>
                    {% else %}
                    {{ product.icon }}
                    {% endif %}
                </div>
                <div>
                    <h3 class="text-3xl font-bold text-gray-700 mb-1">{{ product.title }}</h3>
                    <p class="text-xl text-gray-500 leading-tight">{{ product.description|truncatechars:100 }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% endif %}
        {% endfor %}

        {% endif %}
        {% endfor %}

        <!-- 7. [Info Card] Why Eduitit? -->
        <div class="col-span-4 md:col-span-2 clay-card p-8 h-full bg-gradient-to-br from-blue-50 to-purple-50"
            data-aos="fade-up" data-aos-delay="700">
            <h3 class="text-3xl font-bold text-gray-700 mb-6">ì™œ EDUITITì¸ê°€ìš”?</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-check-circle text-green-500 text-2xl"></i>
                    <span class="text-gray-600 font-bold text-2xl pt-1">100% ë¬´ë£Œ</span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-bolt text-yellow-500 text-2xl"></i>
                    <span class="text-gray-600 font-bold text-2xl pt-1">ì„¤ì¹˜ ë¶ˆí•„ìš”</span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-user-shield text-purple-500 text-2xl"></i>
                    <span class="text-gray-600 font-bold text-2xl pt-1">ë¡œê·¸ì¸ ë¶ˆí•„ìš”</span>
                </div>
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-heart text-pink-500 text-2xl"></i>
                    <span class="text-gray-600 font-bold text-2xl pt-1">í˜„ì§ êµì‚¬ ì œì‘</span>
                </div>
            </div>
        </div>

        <!-- 8. [Contact Card] Feedback -->
        <div class="col-span-4 md:col-span-2 clay-card p-8 h-full flex items-center justify-between group bg-[#E0E5EC]"
            data-aos="fade-up" data-aos-delay="800">
            <div>
                <h3 class="text-3xl font-bold text-gray-700 mb-1">ì•„ì´ë””ì–´ ì œì•ˆí•˜ê¸°</h3>
                <p class="text-gray-500 font-hand text-2xl">ì„ ìƒë‹˜ê»˜ í•„ìš”í•œ ë„êµ¬ë¥¼ ë§Œë“¤ì–´ë“œë ¤ìš”.</p>
            </div>
            <a href="mailto:kakio@naver.com"
                class="clay-card px-8 py-3 text-purple-600 font-bold text-2xl hover:text-purple-700 transition-all flex items-center gap-2 shadow-clay hover:shadow-clay-hover">
                <i class="fa-regular fa-envelope"></i> <span class="hidden sm:inline">ë³´ë‚´ê¸°</span>
            </a>
        </div>

    </div> <!-- End Bento Grid -->
</main>

<!-- Quick View Modal Container -->
<div id="quickViewModal"
    class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50 p-4 backdrop-blur-sm transition-all duration-300 opacity-0"
    onclick="if(event.target === this) closeQuickView();">
    <div class="clay-card p-0 max-w-lg w-full mx-auto relative transform scale-95 transition-all duration-300 bg-[#E0E5EC] overflow-hidden min-h-[400px]"
        id="modalPanel">
        <!-- Loading Spinner -->
        <div id="modalLoading" class="absolute inset-0 flex items-center justify-center bg-white/50 z-20 hidden">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-purple-500"></i>
        </div>

        <!-- Content Injected via AJAX -->
        <div id="modalContent" class="p-10 relative">
            <!-- Content Loads Here -->
        </div>
    </div>
</div>

<script>
    // ğŸš€ Performance Optimization: Cache loaded modal content
    const modalCache = {};
    let currentRequestId = null;

    /**
     * Handle keyboard accessibility for cards
     */
    function handleCardKeydown(event, productId) {
        // Execute on Enter or Space
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault(); // Prevent scrolling on Space
            openQuickView(productId);
        }
    }

    /**
     * Open the Quick View modal with caching and race condition protection
     */
    function openQuickView(productId) {
        const modal = document.getElementById('quickViewModal');
        const panel = document.getElementById('modalPanel');
        const loading = document.getElementById('modalLoading');
        const content = document.getElementById('modalContent');
        const body = document.body;

        // UI Transition: Show Modal Wrapper
        modal.classList.remove('hidden');

        // Use setTimeout to allow browser to render 'block' before applying opacity transition
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.classList.add('flex');
            panel.classList.remove('scale-95');
            panel.classList.add('scale-100');
        }, 10);

        body.style.overflow = 'hidden';

        // 1. Check Cache
        if (modalCache[productId]) {
            content.innerHTML = modalCache[productId];
            loading.classList.add('hidden');
            return;
        }

        // 2. Fetch Data if not cached
        loading.classList.remove('hidden'); // Show spinner
        content.innerHTML = ''; // Clear previous content while loading

        currentRequestId = productId; // Set current request ID for race condition check

        fetch(`/products/preview/${productId}/`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.text();
            })
            .then(html => {
                // ğŸ›¡ï¸ Race Condition Check: Only render if this is still the requested product
                if (currentRequestId === productId) {
                    modalCache[productId] = html; // Save to cache
                    content.innerHTML = html;
                    loading.classList.add('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (currentRequestId === productId) {
                    content.innerHTML = `
                        <div class="text-center py-10 flex flex-col items-center">
                            <i class="fa-solid fa-triangle-exclamation text-gray-300 text-5xl mb-4"></i>
                            <p class="text-gray-500 text-xl font-bold">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                            <button onclick="openQuickView('${productId}')" class="mt-4 px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-full text-gray-600 font-bold transition">
                                ë‹¤ì‹œ ì‹œë„
                            </button>
                        </div>`;
                    loading.classList.add('hidden');
                }
            });
    }

    function closeQuickView() {
        const modal = document.getElementById('quickViewModal');
        const panel = document.getElementById('modalPanel');

        modal.classList.add('opacity-0');
        panel.classList.remove('scale-100');
        panel.classList.add('scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = 'auto';
            // We do NOT clear modalContent here anymore to preserve visual state during transition,
            // or we clear it if we want to reset scroll. 
            // Clearing it prevents "flashing" old content when opening a new slow-loading modal, 
            // but our loading spinner logic handles that by clearing content ON OPEN.
        }, 300);
    }
</script>
{% endblock %}