{% extends 'base.html' %}

{% block title %}에듀잇잇 - 선생님의 스마트한 하루{% endblock %}

{% block extra_css %}
<link rel="stylesheet" as="style" crossorigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar { scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }

    /* 퀵 액션 스크롤 */
    .quick-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    .quick-scroll::-webkit-scrollbar { display: none; }

    /* 카테고리 탭 공통 (전체 서비스 보기 내부) */
    .category-tab { white-space: nowrap; padding: 0.5rem 1.25rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 700; transition: all 0.25s cubic-bezier(0.4,0,0.2,1); border: 2px solid transparent; cursor: pointer; flex-shrink: 0; }
    .category-tab:not(.active) { background: white; color: #64748b; border-color: #e2e8f0; }
    .cat-all.active { background: linear-gradient(135deg,#1e293b,#334155); color: #fff; box-shadow: 0 4px 14px rgba(30,41,59,0.3); }
    .cat-all:not(.active):hover { border-color: #94a3b8; color: #334155; background: #f8fafc; }
    .cat-classroom.active { background: linear-gradient(135deg,#2563eb,#3b82f6); color: #fff; box-shadow: 0 4px 14px rgba(37,99,235,0.35); }
    .cat-classroom:not(.active):hover { border-color: #93c5fd; color: #2563eb; background: #eff6ff; }
    .cat-work.active { background: linear-gradient(135deg,#059669,#10b981); color: #fff; box-shadow: 0 4px 14px rgba(5,150,105,0.35); }
    .cat-work:not(.active):hover { border-color: #6ee7b7; color: #059669; background: #ecfdf5; }
    .cat-game.active { background: linear-gradient(135deg,#dc2626,#ef4444); color: #fff; box-shadow: 0 4px 14px rgba(220,38,38,0.35); }
    .cat-game:not(.active):hover { border-color: #fca5a5; color: #dc2626; background: #fef2f2; }
    .cat-counsel.active { background: linear-gradient(135deg,#7c3aed,#a78bfa); color: #fff; box-shadow: 0 4px 14px rgba(124,58,237,0.35); }
    .cat-counsel:not(.active):hover { border-color: #c4b5fd; color: #7c3aed; background: #f5f3ff; }
    .cat-edutech.active { background: linear-gradient(135deg,#0891b2,#06b6d4); color: #fff; box-shadow: 0 4px 14px rgba(8,145,178,0.35); }
    .cat-edutech:not(.active):hover { border-color: #67e8f9; color: #0891b2; background: #ecfeff; }
    .cat-etc.active { background: linear-gradient(135deg,#6b7280,#9ca3af); color: #fff; box-shadow: 0 4px 14px rgba(107,114,128,0.3); }
    .cat-etc:not(.active):hover { border-color: #d1d5db; color: #6b7280; background: #f9fafb; }

    .category-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    .category-scroll::-webkit-scrollbar { display: none; }

    .sns-preview-card { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.06); transition: all 0.3s ease; }
    .sns-preview-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // 미니 카드 & 기존 product-card 모달 바인딩
    document.querySelectorAll('.product-card').forEach(card => {
        card.addEventListener('click', function(e) {
            const id = this.getAttribute('data-product-id');
            if (window.openModal) window.openModal(id);
        });
        card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); card.click(); }
        });
    });

    // 클릭 계측 + 사용 기록
    document.addEventListener('click', function(e) {
        const el = e.target.closest('[data-track]');
        if (!el) return;
        const track = el.dataset.track;
        const productId = el.dataset.productId || el.closest('[data-product-id]')?.dataset?.productId;
        if (productId) {
            const token = (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value || (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || '';
            if (token) {
                const sourceMap = { quick_action: 'home_quick', mini_card: 'home_section', game_card: 'home_game', show_all_toggle: 'home_grid' };
                fetch('/api/track-usage/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': token },
                    body: JSON.stringify({ product_id: parseInt(productId), action: 'launch', source: sourceMap[track] || 'other' })
                }).catch(function() {});
            }
        }
    });
});
</script>
{% endblock %}

{% block content %}
<div x-data="{ showAll: false, activeCategory: 'all' }" class="min-h-screen bg-[#E0E5EC] font-[Pretendard]">
    <div class="flex flex-col xl:flex-row pt-44 md:pt-40 max-w-[1920px] mx-auto">

        <!-- PC 전용 SNS 사이드바 -->
        <div class="hidden xl:block flex-shrink-0">
            {% include 'core/partials/sns_widget.html' %}
        </div>

        <!-- 메인 콘텐츠 -->
        <main class="flex-1 p-4 md:px-6 lg:px-8 xl:px-12 pt-0 md:pt-0">

            <!-- 인사말 + 검색 -->
            <div class="mb-6 flex items-start justify-between gap-4">
                <div>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800">{% if request.user.userprofile and request.user.userprofile.nickname %}{{ request.user.userprofile.nickname }}{% else %}{{ request.user.username }}{% endif %} 선생님, 안녕하세요!</h2>
                    <p class="text-sm text-slate-500 mt-1">오늘도 스마트한 하루를 시작해 보세요.</p>
                </div>
                {% if search_products_json %}
                <button onclick="if(window.openSearchModal) openSearchModal()" class="flex-shrink-0 flex items-center gap-2 bg-white rounded-xl px-3.5 py-2.5 border border-slate-200 text-slate-400 hover:border-indigo-300 hover:text-indigo-500 transition-all text-sm" title="Ctrl+K">
                    <i class="fa-solid fa-magnifying-glass text-xs"></i>
                    <span class="hidden sm:inline">검색</span>
                    <kbd class="hidden sm:inline-block ml-1 px-1.5 py-0.5 text-[10px] font-bold bg-slate-100 rounded border border-slate-200">⌘K</kbd>
                </button>
                {% endif %}
            </div>

            <!-- 추천 빠른 실행 -->
            {% if quick_actions %}
            <div class="mb-6">
                <h3 class="text-sm font-bold text-slate-500 mb-3 flex items-center gap-1.5">
                    <i class="fa-solid fa-bolt text-amber-500"></i> 추천 빠른 실행
                </h3>
                <div class="flex gap-3 overflow-x-auto quick-scroll pb-2">
                    {% for qa in quick_actions %}
                    <a href="{{ qa.href }}"
                        {% if qa.is_external %}target="_blank" rel="noopener noreferrer"{% endif %}
                        class="flex-shrink-0 flex items-center gap-2.5 bg-white rounded-2xl px-4 py-3 shadow-sm border border-slate-100 hover:shadow-md hover:border-indigo-200 transition-all group"
                        data-track="quick_action" data-track-label="{{ qa.product.title }}">
                        <span class="text-lg">{% if "fa-" in qa.product.icon %}<i class="{{ qa.product.icon }} {% if qa.product.service_type == 'classroom' %}text-blue-500{% elif qa.product.service_type == 'work' %}text-emerald-500{% elif qa.product.service_type == 'game' %}text-red-500{% elif qa.product.service_type == 'counsel' %}text-violet-500{% elif qa.product.service_type == 'edutech' %}text-cyan-500{% else %}text-slate-500{% endif %}"></i>{% else %}{{ qa.product.icon }}{% endif %}</span>
                        <span class="font-bold text-sm text-slate-700 group-hover:text-indigo-600 transition-colors whitespace-nowrap">{{ qa.product.title }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- 목적별 섹션 -->
            <div class="mb-6">
                {% include 'core/includes/purpose_sections.html' with sections=sections %}
            </div>

            <!-- 쉬는 시간 게임 배너 -->
            <div class="mb-6">
                {% include 'core/includes/game_banner.html' with games=games %}
            </div>

            <!-- 전체 서비스 보기 토글 -->
            <div class="mb-8">
                <button @click="showAll = !showAll"
                    class="w-full py-3.5 rounded-2xl font-bold text-sm transition-all flex items-center justify-center gap-2"
                    :class="showAll ? 'bg-indigo-100 text-indigo-700 border border-indigo-200' : 'bg-white text-slate-500 border border-slate-200 hover:border-indigo-300 hover:text-indigo-600'"
                    data-track="show_all_toggle" data-track-label="toggle">
                    <i class="fa-solid fa-grid-2 text-xs"></i>
                    <span x-text="showAll ? '전체 서비스 접기' : '전체 서비스 보기'"></span>
                    <i class="fa-solid fa-chevron-down text-xs transition-transform duration-300" :class="showAll && 'rotate-180'"></i>
                </button>

                <div x-show="showAll" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-y-4" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-4" class="mt-4">
                    <!-- 카테고리 탭 -->
                    <div class="mb-5">
                        <div class="flex gap-2 overflow-x-auto category-scroll pb-2 px-1">
                            <button class="category-tab cat-all" :class="activeCategory === 'all' ? 'active' : ''" @click="activeCategory = 'all'"><i class="fa-solid fa-border-all mr-1.5"></i>전체</button>
                            <button class="category-tab cat-classroom" :class="activeCategory === 'classroom' ? 'active' : ''" @click="activeCategory = 'classroom'"><i class="fa-solid fa-chalkboard-user mr-1.5"></i>운영과 수업</button>
                            <button class="category-tab cat-work" :class="activeCategory === 'work' ? 'active' : ''" @click="activeCategory = 'work'"><i class="fa-solid fa-bolt mr-1.5"></i>업무경감</button>
                            <button class="category-tab cat-game" :class="activeCategory === 'game' ? 'active' : ''" @click="activeCategory = 'game'"><i class="fa-solid fa-gamepad mr-1.5"></i>게임모음</button>
                            <button class="category-tab cat-counsel" :class="activeCategory === 'counsel' ? 'active' : ''" @click="activeCategory = 'counsel'"><i class="fa-solid fa-hand-holding-heart mr-1.5"></i>상담·운세</button>
                            <button class="category-tab cat-edutech" :class="activeCategory === 'edutech' ? 'active' : ''" @click="activeCategory = 'edutech'"><i class="fa-solid fa-microchip mr-1.5"></i>에듀테크</button>
                            <button class="category-tab cat-etc" :class="activeCategory === 'etc' ? 'active' : ''" @click="activeCategory = 'etc'"><i class="fa-solid fa-ellipsis mr-1.5"></i>기타</button>
                        </div>
                    </div>
                    <!-- 기존 Bento Grid -->
                    <div class="bento-grid">
                        {% for product in products %}
                        <div x-show="activeCategory === 'all' || activeCategory === '{{ product.service_type }}'" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" class="{% if product.card_size == 'hero' and product.description|length > 100 %}col-span-2 md:col-span-2 md:row-span-2{% elif product.card_size == 'wide' %}col-span-2 md:col-span-2{% elif product.card_size == 'tall' %}md:row-span-2{% endif %}">
                            {% include 'core/includes/card_product.html' with product=product delay='100' is_filtered=True %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- 모바일 전용 SNS 미리보기 -->
            <div class="block xl:hidden mt-4 px-1">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                        <i class="ph-fill ph-chat-circle-text text-indigo-600 text-xl"></i>
                        실시간 소통
                    </h3>
                    <a href="#sns-full-section-auth-v2" class="text-sm font-bold text-indigo-600 flex items-center gap-1 hover:text-indigo-800 transition-colors">
                        더보기 <i class="fa-solid fa-chevron-down text-xs"></i>
                    </a>
                </div>

                {% for post in posts|slice:":2" %}
                <div class="sns-preview-card p-4 mb-3">
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white text-sm font-bold flex-shrink-0">{% if post.author.userprofile and post.author.userprofile.nickname %}{{ post.author.userprofile.nickname|truncatechars:1 }}{% else %}{{ post.author.username|truncatechars:1 }}{% endif %}</div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-sm text-slate-800">{% if post.author.userprofile and post.author.userprofile.nickname %}{{ post.author.userprofile.nickname }}{% else %}{{ post.author.username }}{% endif %}</span>
                                {% if post.author.is_staff %}<i class="ph-fill ph-seal-check text-indigo-500 text-sm"></i>{% endif %}
                                <span class="text-xs text-slate-400">{{ post.created_at|timesince }} 전</span>
                            </div>
                            <p class="text-sm text-slate-600 line-clamp-2 leading-relaxed">{{ post.content }}</p>
                            <div class="flex items-center gap-4 mt-2 text-xs text-slate-400">
                                <span class="flex items-center gap-1"><i class="ph ph-heart"></i> {{ post.likes_count_annotated|default:"0" }}</span>
                                <span class="flex items-center gap-1"><i class="ph ph-chat-circle"></i> {{ post.comments_count_annotated|default:"0" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="sns-preview-card p-6 text-center">
                    <p class="text-sm text-slate-400">아직 게시글이 없습니다. 첫 글을 남겨보세요!</p>
                </div>
                {% endfor %}

                <div x-data="{ snsOpen: false }" id="sns-full-section-auth-v2">
                    <button @click="snsOpen = !snsOpen" class="w-full py-3 mt-2 rounded-2xl font-bold text-sm transition-all flex items-center justify-center gap-2" :class="snsOpen ? 'bg-indigo-100 text-indigo-700' : 'bg-white text-slate-500 border border-slate-200 hover:border-indigo-300 hover:text-indigo-600'">
                        <i class="ph-fill ph-chat-circle-text"></i>
                        <span x-text="snsOpen ? '소통창 접기' : '소통창 열기'"></span>
                        <i class="fa-solid fa-chevron-down text-xs transition-transform duration-300" :class="snsOpen && 'rotate-180'"></i>
                    </button>
                    <div x-show="snsOpen" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-y-4" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-4" class="mt-4">
                        {% include 'core/partials/sns_widget_mobile.html' %}
                    </div>
                </div>
            </div>

        </main>
    </div>
</div>
{% endblock %}
