<!DOCTYPE html>
{% load static %}
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="description" content="{{ og_description|default:default_og_description|default:'AI 프롬프트 레시피, 도구 가이드, 교육용 게임까지. 교실에서의 혁신을 지금 시작하세요.' }}">
    <meta property="og:title" content="{{ og_title|default:default_og_title|default:'Eduitit - 선생님의 스마트한 하루' }}">
    <meta property="og:description" content="{{ og_description|default:default_og_description|default:'AI 프롬프트 레시피, 도구 가이드, 교육용 게임까지. 교실에서의 혁신을 지금 시작하세요.' }}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ og_url|default:'https://eduitit.site/' }}">
    <meta property="og:image" content="{{ og_image|default:default_og_image|default:'https://eduitit.site/static/images/eduitit_og.png' }}">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ og_title|default:default_og_title|default:'Eduitit - 선생님의 스마트한 하루' }}">
    <meta name="twitter:description" content="{{ og_description|default:default_og_description|default:'AI 프롬프트 레시피, 도구 가이드, 교육용 게임까지. 교실에서의 혁신을 지금 시작하세요.' }}">
    <meta name="twitter:image" content="{{ og_image|default:default_og_image|default:'https://eduitit.site/static/images/eduitit_og.png' }}">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='100%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%236366F1'/%3E%3Cstop offset='100%25' stop-color='%232DD4BF'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='22' fill='url(%23grad)'/%3E%3Cpath d='M50 20 C50 20 60 40 80 50 C60 60 50 80 50 80 C50 80 40 60 20 50 C40 40 50 20 50 20 Z' fill='white'/%3E%3C/svg%3E">
    <title>{% block title %}Eduitit - 선생님의 스마트한 하루{% endblock %}</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-round.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Dongle:wght@300;400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@800;900&display=swap" rel="stylesheet">
    <!-- Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>

    <script>
        document.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });
    </script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        /* Tailwind CDN preflight 미적용 방어 */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-soft': '#E0E5EC',
                        'clay-text': '#495057',
                    },
                    fontFamily: {
                        'sans': ['NanumSquareRound', 'Inter', 'sans-serif'],
                        'round': ['NanumSquareRound', 'sans-serif'],
                        'hand': ['Dongle', 'sans-serif'],
                    },
                    boxShadow: {
                        'clay': '9px 9px 16px rgb(163,177,198,0.6), -9px -9px 16px rgba(255,255,255, 0.5)',
                        'clay-inner': 'inset 6px 6px 10px 0 rgba(163, 177, 198, 0.7), inset -6px -6px 10px 0 rgba(255, 255, 255, 0.8)',
                        'clay-hover': '12px 12px 24px rgba(163, 177, 198, 0.8), -12px -12px 24px rgba(255, 255, 255, 0.7)',
                    },
                    borderRadius: {
                        'clay': '30px',
                    }
                }
            }
        }
    </script>


    <style>
        html,
        body {
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }

        body {
            background-color: #E0E5EC;
            color: #4A5568;
            font-family: 'NanumSquareRound', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        h4,
        .font-title {
            font-weight: 800;
            line-height: 1.3;
            letter-spacing: -0.02em;
        }

        /* Bento Grid Layout - Expert Refinement */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: minmax(200px, auto);
            gap: 1.5rem;
            grid-auto-flow: dense;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .bento-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-auto-rows: minmax(180px, auto);
                gap: 1.25rem;
            }
        }

        @media (max-width: 640px) {
            .bento-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-auto-rows: minmax(130px, auto);
                gap: 0.5rem;
                padding: 0.25rem;
            }
        }



        /* Spans */
        .col-span-2 {
            grid-column: span 2;
        }

        .col-span-4 {
            grid-column: span 4;
        }

        .row-span-2 {
            grid-row: span 2;
        }

        /* Card Styles - Modern Soft Clay */
        .clay-card {
            background-color: #E0E5EC;
            border-radius: 24px;
            /* Zero horizontal offset on mobile to prevent viewport stretching */
            box-shadow: 0 4px 12px rgba(163, 177, 198, 0.4), 0 -2px 8px rgba(255, 255, 255, 0.6);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(255, 255, 255, 0.4);
            max-width: 100%;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .clay-card {
                box-shadow: 8px 8px 16px rgb(163, 177, 198, 0.5), -8px -8px 16px rgba(255, 255, 255, 0.6);
            }
        }

        /* Prevent hover effects on touch devices as they cause layout shifts/clipping */
        @media (hover: hover) {
            .clay-card:hover {
                transform: translateY(-4px) scale(1.005);
                box-shadow: 12px 12px 20px rgba(163, 177, 198, 0.6), -12px -12px 20px rgba(255, 255, 255, 0.7);
                z-index: 10;
            }
        }

        .shadow-clay-inner {
            box-shadow: inset 4px 4px 8px 0 rgba(163, 177, 198, 0.6), inset -4px -4px 8px 0 rgba(255, 255, 255, 0.8);
        }

        /* Animations */
        .float-icon {
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* PREMIUM LOGO STYLING */
        .logo-text {
            font-family: 'Outfit', sans-serif;
            font-weight: 900;
            font-size: 1.4rem;
            /* Reduced for mobile */
            background: linear-gradient(135deg, #7c3aed 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.04em;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
            margin-top: 4px;
        }

        @media (min-width: 768px) {
            .logo-text {
                font-size: 2.2rem;
            }
        }

        .nav-logo-group:hover .logo-text {
            transform: scale(1.08) rotate(-2deg);
            filter: drop-shadow(0 4px 10px rgba(124, 58, 237, 0.3));
        }

        .logo-icon-box {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .nav-logo-group:hover .logo-icon-box {
            transform: scale(1.15) rotate(10deg);
            background: #ffffff;
            box-shadow: 0 10px 20px rgba(124, 58, 237, 0.2);
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body class="selection:bg-purple-200 overflow-x-hidden">
    <div id="app-root" class="w-full relative overflow-x-hidden min-h-screen">

        <!-- Toast Notification System -->
        <div x-data="{
        toasts: [],
        init() {
            {% for toast in toast_messages %}
            this.addToast('{{ toast.message|escapejs }}', '{{ toast.tag }}');
            {% endfor %}
        },
        addToast(message, tag) {
            const id = Date.now() + Math.random();
            this.toasts.push({ id, message, tag });
            setTimeout(() => this.removeToast(id), 3000);
        },
        removeToast(id) {
            this.toasts = this.toasts.filter(t => t.id !== id);
        },
        tagIcon(tag) {
            return { success: 'fa-circle-check', error: 'fa-circle-xmark', warning: 'fa-triangle-exclamation', info: 'fa-circle-info' }[tag] || 'fa-circle-info';
        },
        tagColor(tag) {
            return { success: 'text-green-500', error: 'text-red-500', warning: 'text-orange-500', info: 'text-blue-500' }[tag] || 'text-blue-500';
        }
    }" class="fixed top-28 md:top-24 right-4 md:right-6 z-[200] flex flex-col gap-3 pointer-events-none" style="max-width: 380px;">
            <template x-for="toast in toasts" :key="toast.id">
                <div x-show="true" x-transition:enter="transition ease-out duration-300"
                    x-transition:enter-start="opacity-0 translate-x-8"
                    x-transition:enter-end="opacity-100 translate-x-0"
                    x-transition:leave="transition ease-in duration-200"
                    x-transition:leave-start="opacity-100 translate-x-0"
                    x-transition:leave-end="opacity-0 translate-x-8"
                    class="clay-card px-5 py-4 flex items-start gap-3 pointer-events-auto bg-white/90 backdrop-blur-sm"
                    style="min-width: 280px;">
                    <i class="fa-solid mt-0.5 text-lg" :class="[tagIcon(toast.tag), tagColor(toast.tag)]"></i>
                    <span class="flex-1 text-sm font-bold text-gray-700" x-text="toast.message"></span>
                    <button @click="removeToast(toast.id)" class="text-gray-400 hover:text-gray-600 transition ml-2">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </template>
        </div>

        <!-- Global Banner -->
        {% if banner_active and banner_text and not request.session.dutyticker_student_games_mode %}
        <div x-data="{
            show: true,
            bannerColor: '{{ banner_color|default:" #000000"|escapejs }}',
            hiddenDateKey: 'eduitit_banner_hidden_date',
            todayKey() {
                const d = new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            },
            initBanner() {
                try {
                    this.show = localStorage.getItem(this.hiddenDateKey) !== this.todayKey();
                } catch (e) {
                    this.show = true;
                }
                this.$nextTick(() => {
                    if (window.syncGlobalBannerOffset) window.syncGlobalBannerOffset();
                });
            },
            hideForToday() {
                this.show = false;
                try {
                    localStorage.setItem(this.hiddenDateKey, this.todayKey());
                } catch (e) {}
                this.$nextTick(() => {
                    if (window.syncGlobalBannerOffset) window.syncGlobalBannerOffset();
                });
            }
        }" x-init="initBanner()" x-show="show"
            x-cloak x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="fixed w-full z-[55] top-0 left-0 text-center text-white text-sm font-bold py-2.5 px-6"
            :style="{ backgroundColor: bannerColor }" id="globalBanner">
            <div class="max-w-7xl mx-auto flex items-center justify-center gap-3">
                {% if banner_link %}
                <a href="{{ banner_link }}" class="hover:underline">{{ banner_text }}</a>
                {% else %}
                <span>{{ banner_text }}</span>
                {% endif %}
                <button @click="hideForToday()"
                    class="ml-4 text-white/80 hover:text-white transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Navbar -->
        {% if not hide_navbar %}
        <nav id="mainNav" class="fixed w-full z-50 left-0 px-2 md:px-6 py-4 transition-all duration-300"
            style="will-change: transform, opacity; top: var(--global-banner-height, 0px);">
            <div
                class="max-w-7xl mx-auto clay-card px-3 md:px-6 py-3 flex justify-between items-center bg-[#E0E5EC]/90 backdrop-blur-sm overflow-visible">
                <div class="flex items-center gap-3">
                    <a href="/" class="flex items-center gap-3 group nav-logo-group">
                        <div
                            class="w-12 h-12 rounded-2xl shadow-clay-inner flex items-center justify-center text-purple-600 text-2xl bg-white logo-icon-box">
                            <i class="fa-solid fa-cloud"></i>
                        </div>
                        <span class="logo-text">EDUITIT</span>
                    </a>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex gap-8 mt-2 text-2xl font-bold text-gray-500 items-center">
                    <a href="{% url 'service_guide_list' %}" class="hover:text-purple-600 transition">이용방법</a>
                    <a href="{% url 'portfolio:list' %}" class="hover:text-purple-600 transition">포트폴리오</a>

                    {% if show_visitor_counts %}
                    <!-- Visitor Count (Desktop / Superuser only) -->
                    <div class="hidden lg:flex items-center gap-3 px-4 py-2 rounded-full bg-white/60 shadow-clay-inner text-sm transition hover:scale-105 cursor-help select-none"
                        title="오늘 방문자 / 전체 방문자">
                        <span class="text-orange-500 font-extrabold flex items-center gap-1.5"><i
                                class="fa-solid fa-user-clock"></i> {{ today_visitor_count|default:"0" }}</span>
                        <span class="text-gray-300 font-light">|</span>
                        <span class="text-purple-600 font-extrabold flex items-center gap-1.5"><i
                                class="fa-solid fa-users-line"></i> {{ total_visitor_count|default:"0" }}</span>
                    </div>
                    {% endif %}
                    {% if user.is_authenticated %}



                    <!-- User Dropdown -->
                    <div class="relative" x-data="{ open: false }" @click.away="open = false">
                        <button id="userMenuBtn" @click="open = !open" onclick="if(!window.Alpine){toggleDesktopMenu()}"
                            class="flex items-center gap-3 px-5 py-2 rounded-full shadow-clay-inner bg-[#E0E5EC]/50 hover:bg-white/50 transition-all font-bold text-gray-700">
                            <div
                                class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-500 text-sm shadow-sm">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <span class="text-xl">
                                {% if user.userprofile.nickname %}{{ user.userprofile.nickname }}{% elif user.username %}{{ user.username }}{% else %}사용자{% endif %}님
                            </span>
                            <i class="fa-solid fa-chevron-down text-sm transition-transform" :class="open ? 'rotate-180' : ''"></i>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="desktopDropdownMenu" x-show="open" x-cloak
                            class="absolute right-0 top-full mt-4 w-56 transition-all duration-300 transform z-[60]"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 translate-y-2 scale-95"
                            x-transition:enter-end="opacity-100 translate-y-0 scale-100"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 translate-y-0 scale-100"
                            x-transition:leave-end="opacity-0 translate-y-2 scale-95">
                            <div class="clay-card p-3 bg-white/90 backdrop-blur-xl border border-white/50">
                                <a href="{% url 'dashboard' %}"
                                    class="flex items-center gap-3 px-4 py-3 rounded-2xl hover:bg-purple-50 text-gray-600 hover:text-purple-600 transition-all">
                                    <i class="fa-solid fa-gauge-high"></i>
                                    <span>내 홈페이지</span>
                                </a>
                                <a href="{% url 'fortune:history' %}"
                                    class="flex items-center gap-3 px-4 py-3 rounded-2xl hover:bg-purple-50 text-gray-600 hover:text-purple-600 transition-all">
                                    <i class="fa-solid fa-box-archive"></i>
                                    <span>사주 보관함</span>
                                </a>
                                <a href="{% url 'settings' %}"
                                    class="flex items-center gap-3 px-4 py-3 rounded-2xl hover:bg-purple-50 text-gray-600 hover:text-purple-600 transition-all">
                                    <i class="fa-solid fa-gear"></i>
                                    <span>내 설정</span>
                                </a>
                                <div class="h-px bg-gray-100 my-2"></div>
                                <form action="{% url 'account_logout' %}" method="post" class="block">
                                    {% csrf_token %}
                                    <button type="submit"
                                        class="w-full flex items-center gap-3 px-4 py-3 rounded-2xl hover:bg-red-50 text-red-400 hover:text-red-500 transition-all text-left">
                                        <i class="fa-solid fa-arrow-right-from-bracket"></i>
                                        <span>로그아웃</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <a href="{% url 'account_login' %}"
                        class="hover:text-purple-600 transition px-5 py-1.5 rounded-full shadow-clay text-purple-600 font-bold bg-[#E0E5EC] hover:shadow-clay-hover">
                        <i class="fa-solid fa-user-lock mr-1"></i> 로그인
                    </a>
                    {% endif %}
                </div>

                <!-- Mobile Hamburger Button -->
                <button id="mobileMenuBtn" onclick="toggleMobileMenu()"
                    class="md:hidden w-12 h-12 rounded-full shadow-clay-inner flex items-center justify-center text-gray-500 hover:text-purple-600 transition"
                    aria-label="메뉴 열기" aria-expanded="false" aria-controls="mobileMenu">
                    <i class="fa-solid fa-bars text-xl" id="menuIcon"></i>
                </button>
            </div>
        </nav>
        {% endif %}

        <!-- Mobile Menu Panel -->
        <div id="mobileMenu"
            class="fixed inset-x-0 z-40 md:hidden transform -translate-y-full opacity-0 transition-all duration-300 ease-in-out pointer-events-none"
            style="top: var(--mobile-menu-top, 88px); max-height: calc(100vh - var(--mobile-menu-top, 88px)); overflow-y: auto;"
            aria-hidden="true">
            <div class="mx-4 clay-card p-6 bg-[#E0E5EC]/95 backdrop-blur-sm">
                <div class="flex flex-col gap-4 text-2xl font-bold text-gray-600">
                    <a href="{% url 'service_guide_list' %}"
                        class="hover:text-purple-600 transition py-2 border-b border-gray-200/50">
                        <i class="fa-solid fa-circle-info mr-3 text-purple-400"></i> 이용방법
                    </a>
                    <a href="{% url 'portfolio:list' %}"
                        class="hover:text-purple-600 transition py-2 border-b border-gray-200/50">
                        <i class="fa-solid fa-briefcase mr-3 text-blue-400"></i> 포트폴리오
                    </a>

                    {% if show_visitor_counts %}
                    <!-- Visitor Count (Mobile / Superuser only) -->
                    <div
                        class="flex md:hidden items-center gap-4 px-4 py-3 rounded-2xl bg-white/60 shadow-inner text-gray-500 font-bold text-sm justify-center mb-2">
                        <span class="text-orange-500 flex items-center gap-2"><i class="fa-solid fa-user-clock"></i>
                            Today:
                            {{ today_visitor_count|default:"0" }}</span>
                        <span class="text-gray-400">|</span>
                        <span class="text-purple-600 flex items-center gap-2"><i class="fa-solid fa-users-line"></i>
                            Total:
                            {{ total_visitor_count|default:"0" }}</span>
                    </div>
                    {% endif %}

                    {% if user.is_authenticated %}
                    <div class="py-2 border-b border-gray-200/50 flex items-center gap-3 text-purple-500">
                        <i class="fa-solid fa-user-circle text-2xl"></i>
                        <span>{% if user.userprofile.nickname %}{{ user.userprofile.nickname }}{% elif user.username %}{{user.username }}{% else %}사용자{% endif %}님</span>
                    </div>


                    <a href="{% url 'fortune:history' %}"
                        class="hover:text-purple-600 transition py-2 border-b border-gray-200/50">
                        <i class="fa-solid fa-box-archive mr-3 text-purple-400"></i> 사주 보관함
                    </a>

                    <a href="{% url 'settings' %}"
                        class="hover:text-purple-600 transition py-2 border-b border-gray-200/50">
                        <i class="fa-solid fa-gear mr-3 text-gray-400"></i> 내 설정
                    </a>
                    <form action="{% url 'account_logout' %}" method="post" class="py-2">
                        {% csrf_token %}
                        <button type="submit" class="w-full text-left text-red-500 hover:text-red-600 transition">
                            <i class="fa-solid fa-arrow-right-from-bracket mr-3"></i> 로그아웃
                        </button>
                    </form>
                    {% else %}
                    <a href="{% url 'account_login' %}"
                        class="py-3 mt-2 text-center rounded-full shadow-clay text-purple-600 hover:shadow-clay-hover transition">
                        <i class="fa-solid fa-user-lock mr-2"></i> 로그인
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div id="pageContent" style="padding-top: var(--global-banner-height, 0px);">
            {% block content %}{% endblock %}
        </div>

        <!-- Floating Feedback Widget -->
        <div x-data="{ open: false }" class="fixed bottom-6 right-6 z-[90] hidden md:block">
            <!-- Toggle Button -->
            <button @click="open = !open"
                class="w-14 h-14 rounded-full shadow-clay bg-purple-600 text-white flex items-center justify-center hover:bg-purple-700 transition transform hover:scale-110 active:scale-95">
                <i class="fa-solid" :class="open ? 'fa-xmark text-xl' : 'fa-comment-dots text-xl'"></i>
            </button>

            <!-- Feedback Form Panel -->
            <div x-show="open" x-cloak x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 translate-y-4 scale-95"
                x-transition:enter-end="opacity-100 translate-y-0 scale-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100 translate-y-0 scale-100"
                x-transition:leave-end="opacity-0 translate-y-4 scale-95"
                class="absolute bottom-16 right-0 w-80 clay-card p-5 bg-white/95 backdrop-blur-sm">
                <h3 class="text-lg font-bold text-gray-700 mb-3">
                    <i class="fa-solid fa-paper-plane text-purple-500 mr-2"></i>의견 보내기
                </h3>
                <form hx-post="{% url 'feedback' %}" hx-target="#feedback-result" hx-swap="innerHTML"
                    class="flex flex-col gap-3"
                    @htmx:after-request="if(event.detail.successful) setTimeout(() => { open = false }, 1500)">
                    {% csrf_token %}
                    <input type="text" name="name" placeholder="이름" required {% if user.is_authenticated and user.userprofile.nickname %}value="{{ user.userprofile.nickname }}" {% endif %}
                        class="w-full px-4 py-2.5 rounded-xl shadow-clay-inner bg-[#E0E5EC] text-sm font-medium text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-300">
                    <input type="email" name="email" placeholder="이메일 (선택)" {% if user.is_authenticated and user.email %}value="{{ user.email }}" {% endif %}
                        class="w-full px-4 py-2.5 rounded-xl shadow-clay-inner bg-[#E0E5EC] text-sm font-medium text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-300">
                    <select name="category"
                        class="w-full px-4 py-2.5 rounded-xl shadow-clay-inner bg-[#E0E5EC] text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-300">
                        <option value="bug">버그 신고</option>
                        <option value="suggestion">제안/건의</option>
                        <option value="other" selected>기타</option>
                    </select>
                    <textarea name="message" placeholder="의견을 남겨주세요..." required rows="3" maxlength="1000"
                        class="w-full px-4 py-2.5 rounded-xl shadow-clay-inner bg-[#E0E5EC] text-sm font-medium text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-300 resize-none"></textarea>
                    <button type="submit"
                        class="w-full py-2.5 bg-purple-600 text-white rounded-xl font-bold shadow-clay hover:bg-purple-700 transition transform hover:scale-[1.02] active:scale-[0.98] text-sm">
                        보내기
                    </button>
                    <div id="feedback-result"></div>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer class="py-16 px-6 bg-white/30 backdrop-blur-md mt-20 border-t border-white/20">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-10">
                <div class="text-center md:text-left space-y-4">
                    <div class="flex items-center justify-center md:justify-start gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-white shadow-clay flex items-center justify-center text-purple-600">
                            <i class="fa-solid fa-cloud"></i>
                        </div>
                        <span class="text-2xl font-black tracking-tighter text-gray-700">EDUITIT</span>
                    </div>
                    <p class="text-2xl font-hand text-gray-500">선생님의 칼퇴를 응원합니다.</p>
                    <div class="text-sm text-gray-400 font-medium">
                        대표 워너비풀스택 | <a href="mailto:kakio@korea.kr"
                            class="hover:text-purple-600 transition">kakio@korea.kr</a><br>
                        © 2026 Eduitit. All rights reserved.
                    </div>
                </div>

                <div class="flex flex-wrap justify-center gap-8 text-sm font-bold text-gray-500">
                    <a href="{% url 'policy' %}#terms" class="hover:text-purple-600 transition">이용약관</a>
                    <a href="{% url 'policy' %}#privacy" class="hover:text-purple-600 transition">개인정보처리방침</a>
                    <a href="{% url 'service_guide_list' %}" class="hover:text-purple-600 transition">이용방법</a>
                    <a href="mailto:kakio@korea.kr" class="hover:text-purple-600 transition">의견 보내기</a>
                </div>
            </div>
        </footer>

        <!-- Auto Logout Warning Modal -->
        <div id="autoLogoutModal" class="fixed inset-0 z-[110] hidden" aria-labelledby="autoLogoutModalTitle" role="dialog"
            aria-modal="true">
            <div class="fixed inset-0 bg-gray-500/20 backdrop-blur-md transition-opacity duration-300"></div>
            <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
                <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                    <div
                        class="relative transform overflow-hidden rounded-[2.5rem] bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md border-2 border-purple-100 p-8">
                        <div class="flex flex-col items-center text-center space-y-6">
                            <div
                                class="w-20 h-20 rounded-full bg-purple-50 flex items-center justify-center text-purple-500 text-3xl shadow-clay-inner">
                                <i class="fa-solid fa-clock-rotate-left float-icon"></i>
                            </div>
                            <div>
                                <h3 id="autoLogoutModalTitle" class="text-2xl font-bold text-gray-800 mb-2">자동 로그아웃 안내</h3>
                                <p class="text-gray-500 font-medium">보안을 위해 장기간 활동이 없어<br><span id="logoutTimer"
                                        class="text-purple-600 font-bold">60</span>초 후 자동으로 로그아웃됩니다.</p>
                            </div>
                            <div class="flex flex-col w-full gap-3">
                                <button onclick="extendSession()"
                                    class="w-full py-4 bg-purple-600 text-white rounded-2xl font-bold shadow-clay hover:bg-purple-700 transition transform hover:scale-[1.02] active:scale-[0.98]">
                                    로그인 연장하기
                                </button>
                                <form action="{% url 'account_logout' %}" method="post" class="w-full">
                                    {% csrf_token %}
                                    <button type="submit"
                                        class="w-full py-4 text-gray-400 font-bold hover:text-gray-600 transition">
                                        지금 로그아웃
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unified Modal for All Product Previews -->
        <div id="unifiedModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="unifiedModalTitle" role="dialog"
            aria-modal="true">
            <!-- Backdrop -->
            <div class="fixed inset-0 bg-gray-500/20 backdrop-blur-md transition-opacity duration-300 opacity-0"
                id="modalBackdrop" aria-hidden="true" onclick="closeModal()"></div>

            <div class="fixed inset-0 z-10 flex items-end md:items-center justify-center p-2 pt-6 md:p-6 overflow-y-auto overscroll-y-contain">
                <div class="relative w-full max-w-2xl h-[calc(100dvh-1rem)] md:h-auto max-h-[calc(100dvh-1rem)] md:max-h-[85vh] flex flex-col overflow-hidden rounded-2xl md:rounded-3xl bg-white shadow-2xl transform transition-all duration-300 scale-95 opacity-0"
                    id="modalPanel">
                    <h2 id="unifiedModalTitle" class="sr-only">서비스 미리보기</h2>

                    <!-- Loading Spinner Overlay -->
                    <div id="modalLoading"
                        class="absolute inset-0 z-20 flex items-center justify-center bg-white/80 rounded-2xl md:rounded-3xl hidden">
                        <div class="flex flex-col items-center gap-4">
                            <i class="fa-solid fa-circle-notch fa-spin text-5xl text-purple-500"></i>
                            <p class="text-lg font-bold text-gray-500">정보를 가져오는 중...</p>
                        </div>
                    </div>

                    <!-- Close Button -->
                    <button onclick="closeModal()"
                        class="absolute top-4 right-4 z-30 w-10 h-10 rounded-full bg-gray-100/80 hover:bg-gray-200 flex items-center justify-center text-gray-400 hover:text-gray-600 transition-colors"
                        aria-label="Close modal">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>

                    <!-- Content Container: flex-1 + min-h-0 ensures flex overflow works -->
                    <div id="modalContent" class="flex-1 min-h-0 flex flex-col overflow-hidden">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Desktop Dropdown Fallback (when Alpine.js fails to load)
            function toggleDesktopMenu() {
                const menu = document.getElementById('desktopDropdownMenu');
                if (!menu) return;
                const isHidden = menu.style.display === 'none' || !menu.style.display;
                menu.style.display = isHidden ? 'block' : 'none';
                // Remove x-cloak inline style if present
                menu.removeAttribute('x-cloak');
            }
            // Close desktop dropdown on outside click (fallback)
            document.addEventListener('click', function(e) {
                if (window.Alpine) return; // Alpine handles this
                const menu = document.getElementById('desktopDropdownMenu');
                const btn = document.getElementById('userMenuBtn');
                if (menu && btn && !btn.contains(e.target) && !menu.contains(e.target)) {
                    menu.style.display = 'none';
                }
            });

            // Mobile Menu Toggle
            function toggleMobileMenu() {
                const menu = document.getElementById('mobileMenu');
                const btn = document.getElementById('mobileMenuBtn');
                const icon = document.getElementById('menuIcon');
                const isOpen = menu.classList.contains('translate-y-0');

                if (isOpen) {
                    // Close menu
                    menu.classList.remove('translate-y-0', 'opacity-100', 'pointer-events-auto');
                    menu.classList.add('-translate-y-full', 'opacity-0', 'pointer-events-none');
                    menu.setAttribute('aria-hidden', 'true');
                    btn.setAttribute('aria-expanded', 'false');
                    btn.setAttribute('aria-label', '메뉴 열기');
                    icon.classList.remove('fa-xmark');
                    icon.classList.add('fa-bars');
                    document.body.style.overflow = 'auto';
                } else {
                    // Open menu
                    menu.classList.remove('-translate-y-full', 'opacity-0', 'pointer-events-none');
                    menu.classList.add('translate-y-0', 'opacity-100', 'pointer-events-auto');
                    menu.setAttribute('aria-hidden', 'false');
                    btn.setAttribute('aria-expanded', 'true');
                    btn.setAttribute('aria-label', '메뉴 닫기');
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-xmark');
                    document.body.style.overflow = 'hidden';
                }
            }

            // Close mobile menu when clicking outside
            document.addEventListener('click', function (e) {
                const menu = document.getElementById('mobileMenu');
                const btn = document.getElementById('mobileMenuBtn');
                if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {
                    if (menu.classList.contains('translate-y-0')) {
                        toggleMobileMenu();
                    }
                }
            });

            // Close mobile menu on resize to desktop
            window.addEventListener('resize', function () {
                const menu = document.getElementById('mobileMenu');
                if (window.innerWidth >= 768 && menu && menu.classList.contains('translate-y-0')) {
                    toggleMobileMenu();
                }
            });

            let unifiedModalPrevBodyOverflow = '';

            function openUnifiedModal() {
                const modal = document.getElementById('unifiedModal');
                const backdrop = document.getElementById('modalBackdrop');
                const panel = document.getElementById('modalPanel');
                const body = document.body;
                if (!modal || !backdrop || !panel || !body) return;

                // Already open.
                if (!modal.classList.contains('hidden')) return;

                // Show modal and prevent scroll
                modal.classList.remove('hidden');
                unifiedModalPrevBodyOverflow = body.style.overflow || '';
                body.style.overflow = 'hidden';

                // Reset scale for animation
                panel.classList.add('scale-95', 'opacity-0');

                // Animate in
                requestAnimationFrame(() => {
                    backdrop.classList.remove('opacity-0');
                    panel.classList.remove('scale-95', 'opacity-0');
                    panel.classList.add('scale-100', 'opacity-100');
                });
            }

            function openModal(productId) {
                openUnifiedModal();

                const content = document.getElementById('modalContent');
                const loading = document.getElementById('modalLoading');

                // Show loading
                loading.classList.remove('hidden');
                content.innerHTML = '';

                // Load content
                fetch(`/products/preview/${productId}/?t=${Date.now()}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.text();
                    })
                    .then(html => {
                        content.innerHTML = html;
                        loading.classList.add('hidden');
                    })
                    .catch(error => {
                        console.error('Error loading modal content:', error);
                        content.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-20 text-center space-y-6">
                            <i class="fa-solid fa-triangle-exclamation text-7xl text-gray-200"></i>
                            <h3 class="text-3xl font-bold text-gray-700">정보를 불러오지 못했습니다</h3>
                            <p class="text-xl text-gray-400 font-hand">잠시 후 다시 시도해 주세요.</p>
                            <button onclick="openModal(${productId})" class="px-8 py-3 bg-purple-500 text-white rounded-full font-bold shadow-clay hover:scale-105 transition">다시 시도</button>
                        </div>
                    `;
                        loading.classList.add('hidden');
                    });
            }

            function closeModal() {
                const modal = document.getElementById('unifiedModal');
                const backdrop = document.getElementById('modalBackdrop');
                const panel = document.getElementById('modalPanel');
                const body = document.body;
                if (!modal || !backdrop || !panel || !body) return;

                // Already closed.
                if (modal.classList.contains('hidden')) return;

                // Animate out
                backdrop.classList.add('opacity-0');
                panel.classList.remove('scale-100', 'opacity-100');
                panel.classList.add('scale-95', 'opacity-0');

                setTimeout(() => {
                    modal.classList.add('hidden');
                    body.style.overflow = unifiedModalPrevBodyOverflow;
                    unifiedModalPrevBodyOverflow = '';
                }, 300);
            }

            // Force reset modal UI state (useful for back/forward cache restore)
            function resetUnifiedModalState() {
                const modal = document.getElementById('unifiedModal');
                const backdrop = document.getElementById('modalBackdrop');
                const panel = document.getElementById('modalPanel');
                const loading = document.getElementById('modalLoading');
                const content = document.getElementById('modalContent');
                if (!modal || !backdrop || !panel) return;

                modal.classList.add('hidden');
                backdrop.classList.add('opacity-0');
                panel.classList.remove('scale-100', 'opacity-100');
                panel.classList.add('scale-95', 'opacity-0');
                document.body.style.overflow = unifiedModalPrevBodyOverflow;
                unifiedModalPrevBodyOverflow = '';

                if (loading) loading.classList.add('hidden');
                if (content) content.innerHTML = '';
            }

            // Close on escape key
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && !document.getElementById('unifiedModal').classList.contains('hidden')) {
                    closeModal();
                }
            });

            // Prevent clicks inside modal from closing it
            document.addEventListener('DOMContentLoaded', function () {
                const panel = document.getElementById('modalPanel');
                if (panel) {
                    panel.addEventListener('click', function (e) {
                        e.stopPropagation();
                    });
                }

                // If user enters a service from modal, close modal first.
                const content = document.getElementById('modalContent');
                if (content) {
                    content.addEventListener('click', function (e) {
                        const anchor = e.target.closest('a[href]');
                        if (!anchor) return;
                        closeModal();
                    });
                }
            });

            // Handle browser back/forward cache restoring old open-modal state.
            window.addEventListener('pageshow', function () {
                resetUnifiedModalState();
            });
        </script>

        <script src="https://unpkg.com/aos@2.3.1/dist/aos.js" defer></script>
        <script>
            // Global banner offset sync (for nav + page content).
            window.syncGlobalBannerOffset = function () {
                const banner = document.getElementById('globalBanner');
                let height = 0;
                if (banner && window.getComputedStyle(banner).display !== 'none') {
                    height = Math.ceil(banner.getBoundingClientRect().height);
                }
                document.documentElement.style.setProperty('--global-banner-height', `${height}px`);
                if (window.syncMobileMenuOffset) {
                    window.syncMobileMenuOffset();
                }
            };

            window.syncMobileMenuOffset = function () {
                const nav = document.getElementById('mainNav');
                let top = 88;
                let navHeight = 88;
                if (nav) {
                    navHeight = Math.max(0, Math.ceil(nav.getBoundingClientRect().height));
                    top = Math.max(0, Math.ceil(nav.getBoundingClientRect().bottom));
                }
                document.documentElement.style.setProperty('--main-nav-height', `${navHeight}px`);
                document.documentElement.style.setProperty('--mobile-menu-top', `${top}px`);
            };

            document.addEventListener('DOMContentLoaded', function () {
                window.syncGlobalBannerOffset();
                window.syncMobileMenuOffset();
                const banner = document.getElementById('globalBanner');
                if (banner) {
                    const resizeObserver = new ResizeObserver(() => window.syncGlobalBannerOffset());
                    resizeObserver.observe(banner);
                    const mutationObserver = new MutationObserver(() => window.syncGlobalBannerOffset());
                    mutationObserver.observe(banner, { attributes: true, attributeFilter: ['style', 'class'] });
                }
            });

            window.addEventListener('resize', () => window.syncGlobalBannerOffset());
            window.addEventListener('resize', () => window.syncMobileMenuOffset());
            window.addEventListener('load', () => window.syncMobileMenuOffset());

            // Initialize Animate On Scroll
            document.addEventListener('DOMContentLoaded', function () {
                AOS.init({
                    once: true,
                    offset: 20,
                    duration: 800,
                    easing: 'ease-out-cubic',
                });
            });
            window.addEventListener('load', () => AOS.refresh());
            window.addEventListener('resize', () => AOS.refresh());
        </script>
        {% if user.is_authenticated %}
        <script>
            // Auto Logout Logic
            (function () {
                let timeoutMinutes = 360; // 내부 세션 정책값과 동기화
                let warningMinutes = 359; // 로그아웃 1분 전 경고 표시
                let logoutTimer;
                let warningTimer;
                let countdownInterval;
                let secondsLeft = 60;

                function startTimers() {
                    clearTimeout(logoutTimer);
                    clearTimeout(warningTimer);
                    clearInterval(countdownInterval);
                    document.getElementById('autoLogoutModal').classList.add('hidden');

                    // 경고창 표시 타이머
                    warningTimer = setTimeout(showWarning, warningMinutes * 60 * 1000);

                    // 실제 로그아웃 타이머 (실제 세션 만료보다 약간 먼저 로그아웃 처리)
                    logoutTimer = setTimeout(autoLogout, timeoutMinutes * 60 * 1000);
                }

                function showWarning() {
                    document.getElementById('autoLogoutModal').classList.remove('hidden');
                    secondsLeft = 60;
                    updateCountdown();
                    countdownInterval = setInterval(updateCountdown, 1000);
                }

                function updateCountdown() {
                    const timerEl = document.getElementById('logoutTimer');
                    if (timerEl) {
                        timerEl.textContent = secondsLeft;
                        if (secondsLeft <= 0) {
                            clearInterval(countdownInterval);
                        }
                        secondsLeft--;
                    }
                }

                function autoLogout() {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = "{% url 'account_logout' %}";
                    const csrf = document.createElement('input');
                    csrf.type = 'hidden';
                    csrf.name = 'csrfmiddlewaretoken';
                    csrf.value = '{{ csrf_token }}';
                    form.appendChild(csrf);
                    document.body.appendChild(form);
                    form.submit();
                }

                window.extendSession = function () {
                    // 단순히 아무 API나 호출하여 세션을 갱신 (CSRF 필요 없음, 세션 쿠키만 전송되면 됨)
                    fetch(window.location.href, { method: 'HEAD' })
                        .then(() => {
                            startTimers();
                            console.log('Session extended');
                        })
                        .catch(err => console.error('Failed to extend session', err));
                };

                // 사용자 활동 감지 (클릭, 키보드 입력 등)
                const activities = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
                let throttleTimer;

                function handleActivity() {
                    if (throttleTimer) return;

                    throttleTimer = setTimeout(() => {
                        // 경고창이 보이지 않을 때만 타이머 리셋
                        if (document.getElementById('autoLogoutModal').classList.contains('hidden')) {
                            startTimers();
                        }
                        throttleTimer = null;
                    }, 10000); // 10초마다 체크 (성능 최적화)
                }

                activities.forEach(activity => {
                    window.addEventListener(activity, handleActivity, true);
                });

                // 초기 타이머 시작
                startTimers();
            })();
        </script>
        {% endif %}


        <!-- Ctrl+K 검색 모달 (V2) -->
        {% if search_products_json %}
        <div id="searchModal" class="fixed inset-0 z-[110] hidden" role="dialog" aria-modal="true" aria-label="서비스 검색">
            <div id="searchModalBackdrop" class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm"></div>
            <div class="fixed inset-x-0 top-[15vh] z-10 flex justify-center px-4">
                <div class="w-full max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
                    <!-- 검색 입력 -->
                    <div class="flex items-center gap-3 px-5 py-4 border-b border-gray-100">
                        <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                        <input id="searchInput" type="text" placeholder="서비스 검색..." autocomplete="off" class="flex-1 text-base outline-none bg-transparent text-gray-800 placeholder-gray-400" />
                        <button type="button"
                                onclick="closeSearchModal()"
                                class="hidden sm:inline-flex items-center px-2 py-0.5 text-xs font-bold text-gray-500 bg-gray-100 rounded border border-gray-200 hover:bg-gray-200 transition-colors"
                                aria-label="검색 닫기"
                                title="닫기 (Esc)">
                            ESC
                        </button>
                    </div>
                    <!-- 검색 결과 -->
                    <div id="searchResults" class="max-h-[50vh] overflow-y-auto py-2">
                    </div>
                    <!-- 하단 안내 -->
                    <div class="flex items-center gap-4 px-5 py-2.5 border-t border-gray-100 text-xs text-gray-400">
                        <span><kbd class="px-1.5 py-0.5 bg-gray-100 rounded text-[10px] font-bold border border-gray-200">↑↓</kbd> 이동</span>
                        <span><kbd class="px-1.5 py-0.5 bg-gray-100 rounded text-[10px] font-bold border border-gray-200">Enter</kbd> 열기</span>
                        <span><kbd class="px-1.5 py-0.5 bg-gray-100 rounded text-[10px] font-bold border border-gray-200">ESC</kbd> 닫기</span>
                    </div>
                </div>
            </div>
        </div>
        <script>
        (function() {
            var products = {{ search_products_json|safe }};
            var modal = document.getElementById('searchModal');
            var input = document.getElementById('searchInput');
            var backdrop = document.getElementById('searchModalBackdrop');
            var results = document.getElementById('searchResults');
            var activeIdx = -1;
            var filteredItems = [];
            var RECENT_KEY = 'eduitit_recent_searches';
            var MAX_RECENT = 5;
            var prevBodyOverflow = null;

            var typeColors = {
                classroom: 'text-blue-500', work: 'text-emerald-500', game: 'text-red-500',
                counsel: 'text-violet-500', edutech: 'text-cyan-500', etc: 'text-slate-500'
            };

            function getRecent() {
                try { return JSON.parse(localStorage.getItem(RECENT_KEY) || '[]'); } catch(e) { return []; }
            }
            function addRecent(id) {
                var list = getRecent().filter(function(r) { return r !== id; });
                list.unshift(id);
                if (list.length > MAX_RECENT) list = list.slice(0, MAX_RECENT);
                localStorage.setItem(RECENT_KEY, JSON.stringify(list));
            }

            function renderItems(items, label) {
                if (!items.length) {
                    results.innerHTML = '<div class="px-5 py-8 text-center text-sm text-gray-400">검색 결과가 없습니다</div>';
                    filteredItems = [];
                    activeIdx = -1;
                    return;
                }
                filteredItems = items;
                activeIdx = -1;
                var html = '';
                if (label) html += '<div class="px-5 py-1.5 text-xs font-bold text-gray-400">' + label + '</div>';
                items.forEach(function(p, i) {
                    var iconHtml = (p.icon && p.icon.indexOf('fa-') !== -1)
                        ? '<i class="' + p.icon + ' ' + (typeColors[p.service_type] || 'text-slate-500') + '"></i>'
                        : '<span>' + (p.icon || '📦') + '</span>';
                    var sub = p.solve_text || p.description;
                    html += '<div class="search-result-item flex items-center gap-3 px-5 py-3 cursor-pointer hover:bg-indigo-50 transition-colors" data-idx="' + i + '" data-id="' + p.id + '">'
                        + '<span class="text-lg w-6 text-center flex-shrink-0">' + iconHtml + '</span>'
                        + '<div class="flex-1 min-w-0">'
                        + '<div class="font-bold text-sm text-gray-800 truncate">' + p.title + '</div>'
                        + (sub ? '<div class="text-xs text-gray-400 truncate">' + sub + '</div>' : '')
                        + '</div>'
                        + '</div>';
                });
                results.innerHTML = html;
                results.querySelectorAll('.search-result-item').forEach(function(el) {
                    el.addEventListener('click', function() {
                        selectItem(parseInt(this.dataset.idx));
                    });
                });
            }

            function highlightActive() {
                results.querySelectorAll('.search-result-item').forEach(function(el, i) {
                    if (i === activeIdx) {
                        el.classList.add('bg-indigo-50');
                        el.scrollIntoView({ block: 'nearest' });
                    } else {
                        el.classList.remove('bg-indigo-50');
                    }
                });
            }

            function selectItem(idx) {
                if (idx < 0 || idx >= filteredItems.length) return;
                var p = filteredItems[idx];
                addRecent(p.id);
                closeSearchModal();
                if (window.openModal) window.openModal(p.id);
            }

            function doSearch(q) {
                q = q.trim().toLowerCase();
                if (!q) {
                    var recentIds = getRecent();
                    if (recentIds.length) {
                        var recentItems = recentIds.map(function(id) { return products.find(function(p) { return p.id === id; }); }).filter(Boolean);
                        renderItems(recentItems, '최근 검색');
                    } else {
                        renderItems(products.slice(0, 8), '전체 서비스');
                    }
                    return;
                }
                var filtered = products.filter(function(p) {
                    return p.title.toLowerCase().indexOf(q) !== -1
                        || (p.solve_text && p.solve_text.toLowerCase().indexOf(q) !== -1)
                        || (p.description && p.description.toLowerCase().indexOf(q) !== -1);
                });
                renderItems(filtered, null);
            }

            function isSearchModalOpen() {
                return !modal.classList.contains('hidden');
            }

            function isUnifiedModalOpen() {
                var unifiedModal = document.getElementById('unifiedModal');
                return unifiedModal && !unifiedModal.classList.contains('hidden');
            }

            window.openSearchModal = function() {
                if (isSearchModalOpen() || isUnifiedModalOpen()) return;
                prevBodyOverflow = document.body.style.overflow;
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                input.value = '';
                doSearch('');
                setTimeout(function() { input.focus(); }, 50);
            };

            window.closeSearchModal = function() {
                if (!isSearchModalOpen()) return;
                modal.classList.add('hidden');
                document.body.style.overflow = prevBodyOverflow || '';
                prevBodyOverflow = null;
            };

            if (backdrop) {
                backdrop.addEventListener('click', function() {
                    closeSearchModal();
                });
            }

            modal.addEventListener('click', function(e) {
                if (e.target === modal || e.target === backdrop) {
                    closeSearchModal();
                }
            });

            input.addEventListener('input', function() { doSearch(this.value); });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (filteredItems.length) { activeIdx = (activeIdx + 1) % filteredItems.length; highlightActive(); }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (filteredItems.length) { activeIdx = activeIdx <= 0 ? filteredItems.length - 1 : activeIdx - 1; highlightActive(); }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (activeIdx >= 0) selectItem(activeIdx);
                    else if (filteredItems.length === 1) selectItem(0);
                } else if (e.key === 'Escape' && isSearchModalOpen()) {
                    e.preventDefault();
                    closeSearchModal();
                }
            });

            // Ctrl+K / Cmd+K 글로벌 단축키
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    if (isUnifiedModalOpen()) return;
                    if (modal.classList.contains('hidden')) { openSearchModal(); } else { closeSearchModal(); }
                }
            });

            // 입력창 포커스와 무관하게 Esc로 검색 모달 닫기 (검색 모달이 열린 경우에만)
            document.addEventListener('keydown', function(e) {
                if (e.key !== 'Escape') return;
                if (!isSearchModalOpen()) return;
                e.preventDefault();
                closeSearchModal();
            }, true);

            function getCsrfToken() {
                var el = document.querySelector('[name=csrfmiddlewaretoken]');
                if (el) return el.value;
                var match = document.cookie.match(/csrftoken=([^;]+)/);
                return match ? match[1] : '';
            }

            // 사용 기록 전송 (검색에서 선택 시)
            var origSelectItem = selectItem;
            selectItem = function(idx) {
                if (idx >= 0 && idx < filteredItems.length) {
                    var p = filteredItems[idx];
                    var token = getCsrfToken();
                    if (token) {
                        fetch('/api/track-usage/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': token },
                            body: JSON.stringify({ product_id: p.id, action: 'search', source: 'search' })
                        }).catch(function() {});
                    }
                }
                origSelectItem(idx);
            };
        })();
        </script>
        {% endif %}

        {% block extra_js %}{% endblock %}
    </div><!-- #app-root -->
</body>

</html>
