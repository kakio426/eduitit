{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<meta property="og:title" content="{{ session.session_name }} - í•™êµìƒí™œ MBTI" />
{% endblock %}

{% block extra_css %}
<style>
    .qr-container {
        background: white;
        border-radius: 20px;
        box-shadow: 8px 8px 16px #b8bec5, -8px -8px 16px #ffffff;
        padding: 2rem;
        text-align: center;
    }

    .qr-image {
        width: 280px;
        height: 280px;
        margin: 0 auto;
        border-radius: 12px;
    }

    .result-row {
        background: white;
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 0.75rem;
        box-shadow: 4px 4px 8px #b8bec5, -4px -4px 8px #ffffff;
        transition: all 0.2s;
    }

    .result-row:hover {
        transform: translateX(4px);
    }

    .fullscreen-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 100;
    }

    .qr-fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .qr-fullscreen img {
        width: 60vmin;
        height: 60vmin;
        max-width: 500px;
        max-height: 500px;
    }

    .stats-bar {
        height: 12px;
        border-radius: 6px;
        background: #e2e8f0;
        overflow: hidden;
    }

    .stats-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.5s ease;
    }
</style>
{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-6 min-h-screen bg-[#E0E5EC]" x-data="{showFullscreen: false}">
    <div class="max-w-6xl mx-auto">
        <!-- í—¤ë” -->
        <div class="flex items-center justify-between mb-8" data-aos="fade-up">
            <div>
                <a href="{% url 'studentmbti:dashboard' %}"
                    class="text-gray-500 hover:text-purple-600 transition mb-2 inline-block font-bold">
                    <i class="fa-solid fa-arrow-left mr-2"></i>ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                </a>
                <div class="flex items-center gap-3">
                    <span class="text-4xl">{{ service.icon|default:"ğŸ“" }}</span>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-700 font-title">
                        {{ session.session_name }}
                    </h1>
                </div>
                <p class="text-gray-500 mt-1">
                    <i class="fa-solid fa-calendar mr-1"></i>{{ session.created_at|date:"Yë…„ mì›” dì¼ H:i" }}
                </p>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'studentmbti:session_toggle' session.id %}"
                    class="px-4 py-2 rounded-xl font-bold transition {% if session.is_active %}bg-red-100 text-red-600 hover:bg-red-200{% else %}bg-green-100 text-green-600 hover:bg-green-200{% endif %}">
                    {% if session.is_active %}
                    <i class="fa-solid fa-stop mr-1"></i>ê²€ì‚¬ ì¢…ë£Œ
                    {% else %}
                    <i class="fa-solid fa-play mr-1"></i>ê²€ì‚¬ ì¬ê°œ
                    {% endif %}
                </a>
                <a href="{% url 'studentmbti:export_excel' session.id %}"
                    class="px-4 py-2 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600 transition">
                    <i class="fa-solid fa-file-excel mr-1"></i>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- QR ì½”ë“œ ì„¹ì…˜ -->
            <div class="lg:col-span-1" data-aos="fade-up">
                <div class="qr-container">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">
                        <i class="fa-solid fa-qrcode text-orange-500 mr-2"></i>
                        ê²€ì‚¬ QR ì½”ë“œ
                    </h2>
                    <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="QR Code" class="qr-image">

                    {% if session.access_code %}
                    <div class="mt-6 p-4 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl">
                        <p class="text-sm text-gray-600 mb-2">ì…ì¥ ì½”ë“œë¡œ ì ‘ì†</p>
                        <div class="text-4xl font-black text-purple-600 tracking-widest">
                            {{ session.access_code }}
                        </div>
                        <div class="mt-3 p-2 bg-white/70 rounded-lg">
                            <p class="text-xs text-gray-700 font-bold mb-1">ğŸ“± í•™ìƒ ì ‘ì† ë°©ë²•:</p>
                            <p class="text-sm text-purple-700 font-mono font-bold">eduitit.site/m/</p>
                            <p class="text-xs text-gray-500 mt-1">ìœ„ ì£¼ì†Œì—ì„œ ì…ì¥ ì½”ë“œ ì…ë ¥</p>
                        </div>
                    </div>
                    {% endif %}

                    <p class="text-gray-500 mt-4 text-sm">í•™ìƒë“¤ì´ ì´ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´<br>ê²€ì‚¬ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                    <button @click="showFullscreen = true"
                        class="mt-4 px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition">
                        <i class="fa-solid fa-expand mr-2"></i>
                        ì „ì²´í™”ë©´ìœ¼ë¡œ ë³´ê¸°
                    </button>

                    {% if session.is_active %}
                    <div class="mt-4 p-3 bg-green-100 rounded-xl text-green-700 text-sm">
                        <i class="fa-solid fa-circle-check mr-1"></i>
                        ê²€ì‚¬ê°€ í™œì„±í™” ìƒíƒœì…ë‹ˆë‹¤
                    </div>
                    {% else %}
                    <div class="mt-4 p-3 bg-red-100 rounded-xl text-red-600 text-sm">
                        <i class="fa-solid fa-circle-xmark mr-1"></i>
                        ê²€ì‚¬ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤
                    </div>
                    {% endif %}

                    <form action="{% url 'studentmbti:session_delete' session.id %}" method="post" class="mt-4"
                        onsubmit="return confirm('ì •ë§ë¡œ ì´ ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ê²°ê³¼ê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.');">
                        {% csrf_token %}
                        <button type="submit"
                            class="w-full px-4 py-2 bg-red-100 text-red-600 rounded-xl font-bold hover:bg-red-200 transition text-sm">
                            <i class="fa-solid fa-trash mr-1"></i>ì„¸ì…˜ ì‚­ì œ
                        </button>
                    </form>
                </div>

                <!-- í†µê³„ -->
                {% if mbti_stats %}
                <div class="clay-card p-6 mt-6">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">
                        <i class="fa-solid fa-chart-pie text-purple-500 mr-2"></i>
                        ìºë¦­í„° ë¶„í¬
                    </h3>
                    <div class="space-y-3">
                        {% for stat in mbti_stats %}
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-bold">{{ stat.theme.emoji }} {{ stat.animal_name }}</span>
                                <span class="text-gray-500">{{ stat.count }}ëª…</span>
                            </div>
                            <div class="stats-bar">
                                <div class="stats-fill" style="width: 0%;"
                                    x-init="setTimeout(() => $el.style.width = '{{ stat.percentage }}%', 50)"
                                    data-color="{{ stat.theme.primary }}"
                                    x-on:mouseover="$el.style.backgroundColor = $el.dataset.color"
                                    x-effect="$el.style.backgroundColor = $el.dataset.color"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- ê²°ê³¼ ëª©ë¡ -->
            <div class="lg:col-span-2" data-aos="fade-up" data-aos-delay="100">
                <div class="clay-card p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-700">
                            <i class="fa-solid fa-users text-blue-500 mr-2"></i>
                            ì°¸ì—¬ í•™ìƒ ëª©ë¡
                            <span class="text-orange-500 ml-2" id="total-count">{{ total_count }}ëª…</span>
                        </h2>
                        <div class="text-sm text-gray-400">
                            <i class="fa-solid fa-sync-alt mr-1"></i>5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
                        </div>
                    </div>

                    <div id="results-container">
                        <template x-if="!showFullscreen">
                            <div hx-get="{% url 'studentmbti:session_results_partial' session.id %}"
                                hx-trigger="every 5s" hx-swap="innerHTML">
                                {% include 'studentmbti/partials/results_list.html' %}
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì „ì²´í™”ë©´ ëª¨ë“œ (ë¶„í•  í™”ë©´) -->
    <div x-show="showFullscreen" x-cloak x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
        class="fixed inset-0 z-[1000] bg-[#F8F9FD] flex overflow-hidden">

        <!-- ì¢Œì¸¡: ì ‘ì† ì •ë³´ -->
        <div
            class="w-1/3 h-full bg-white shadow-2xl flex flex-col items-center p-8 relative z-10 border-r-2 border-purple-100 overflow-y-auto custom-scrollbar">
            <div class="my-auto w-full flex flex-col items-center">
                <div class="mb-6 text-center">
                    <span class="text-6xl mb-2 block">ğŸ“</span>
                    <h1 class="text-3xl font-black text-gray-800 font-title leading-tight">{{ session.session_name }}
                    </h1>
                </div>

                <div class="bg-white p-5 rounded-[30px] shadow-2xl border-4 border-purple-50 mb-8 max-w-full">
                    <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="QR Code"
                        class="w-[300px] h-[300px] max-w-full object-contain mx-auto">
                </div>

                <div class="w-full space-y-6">
                    <div class="text-center">
                        <p class="text-xl font-bold text-gray-400 mb-1">ì ‘ì† ì£¼ì†Œ</p>
                        <div
                            class="text-3xl font-black text-purple-600 font-mono tracking-tight bg-purple-50 py-3 px-5 rounded-xl inline-block border-2 border-purple-100">
                            eduitit.site/m/
                        </div>
                    </div>

                    <div class="text-center">
                        <p class="text-xl font-bold text-gray-400 mb-1">ì…ì¥ ì½”ë“œ</p>
                        <div class="text-7xl font-black text-purple-600 tracking-[0.2em] font-mono leading-none">
                            {{ session.access_code }}
                        </div>
                    </div>
                </div>

                <p class="text-xl text-gray-400 mt-10 font-bold animate-pulse text-center pb-8">
                    <i class="fa-solid fa-mobile-screen-button mr-2"></i>
                    ìŠ¤ë§ˆíŠ¸í°ìœ¼ë¡œ ì°¸ì—¬í•˜ì„¸ìš”!
                </p>
            </div>
        </div>

        <!-- ìš°ì¸¡: ì°¸ì—¬ í•™ìƒ ëª©ë¡ -->
        <div class="flex-1 h-full bg-[#E0E5EC]/30 flex flex-col">
            <!-- ë‹«ê¸° ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨) -->
            <div class="absolute top-8 right-8 z-20">
                <button @click="showFullscreen = false"
                    class="w-16 h-16 bg-white text-gray-400 hover:text-red-500 rounded-2xl shadow-xl flex items-center justify-center text-4xl transition-all hover:rotate-90">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="p-12 pb-6">
                <div class="flex items-end gap-4 mb-4">
                    <h2 class="text-5xl font-black text-gray-800 font-title">
                        ì°¸ì—¬ í•™ìƒ ëª©ë¡
                    </h2>
                    <span class="text-3xl font-black text-purple-600 mb-2" id="fs-total-count">{{ total_count }}ëª…</span>
                </div>
                <div class="h-1.5 w-full bg-purple-100 rounded-full overflow-hidden">
                    <div class="h-full bg-purple-500 animate-pulse" style="width: 100%;"></div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto px-6 h-full custom-scrollbar">
                <template x-if="showFullscreen">
                    <div id="fs-results-container"
                        hx-get="{% url 'studentmbti:session_results_partial' session.id %}?template=fullscreen"
                        hx-trigger="every 5s" hx-swap="innerHTML">
                        {% include 'studentmbti/partials/fullscreen_results.html' %}
                    </div>
                </template>
            </div>

            <div class="p-10 text-center text-gray-400 font-bold text-xl">
                <i class="fa-solid fa-sync fa-spin mr-2"></i> ì‹¤ì‹œê°„ìœ¼ë¡œ ìë™ ì—…ë°ì´íŠ¸ ì¤‘ì…ë‹ˆë‹¤
            </div>
        </div>
    </div>
</section>

<script>
    // QR ì „ì²´í™”ë©´ ë’¤ë¡œê°€ê¸° ì²˜ë¦¬
    document.addEventListener('alpine:init', () => {
        Alpine.data('qrFullscreenHandler', () => ({
            showFullscreen: false,
            init() {
                this.$watch('showFullscreen', (value) => {
                    if (value) {
                        // ì „ì²´í™”ë©´ ì—´ë¦´ ë•Œ íˆìŠ¤í† ë¦¬ ì¶”ê°€
                        history.pushState({ qrFullscreen: true }, '');
                    }
                });
            }
        }));
    });

    // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì²˜ë¦¬
    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.qrFullscreen) {
            // QR ì „ì²´í™”ë©´ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°ë§Œ í•˜ê³  í˜ì´ì§€ëŠ” ìœ ì§€
            const fullscreenEl = document.querySelector('[x-data]');
            if (fullscreenEl && fullscreenEl.__x) {
                fullscreenEl.__x.$data.showFullscreen = false;
            }
            // íˆìŠ¤í† ë¦¬ë¥¼ ë‹¤ì‹œ ì¶”ê°€í•˜ì—¬ í˜ì´ì§€ë¥¼ ìœ ì§€
            history.pushState(null, '');
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° íˆìŠ¤í† ë¦¬ ìƒíƒœ ì„¤ì •
    history.pushState(null, '');

    // ì°¸ì—¬ ì¸ì› ìˆ«ì ë™ê¸°í™” (HTMX ë¡œë“œ í›„)
    document.body.addEventListener('htmx:afterOnLoad', (event) => {
        if (event.detail.target.id === 'results-container' || event.detail.target.id === 'fs-results-container') {
            const totalCount = document.querySelector('#total-count')?.innerText;
            const fsTotalCount = document.querySelector('#fs-total-count');
            if (totalCount && fsTotalCount) {
                fsTotalCount.innerText = totalCount;
            }
        }
    });
</script>
{% endblock %}