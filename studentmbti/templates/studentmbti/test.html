{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<meta property="og:title" content="ë‚˜ì˜ í•™êµìƒí™œ ë™ë¬¼ ì°¾ê¸°" />
<meta property="og:description" content="{{ session.session_name }} - ë‚˜ëŠ” ì–´ë–¤ í•™êµìƒí™œ ë™ë¬¼ì¼ê¹Œ?" />
{% endblock %}

{% block extra_css %}
<style>
    .quiz-step {
        display: none;
        min-height: 350px;
    }

    .quiz-step.active {
        display: block;
        animation: slideIn 0.4s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .progress-bar {
        height: 10px;
        background: #e2e8f0;
        border-radius: 5px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #8B5CF6, #EC4899);
        transition: width 0.3s ease;
    }

    .option-btn {
        width: 100%;
        padding: 1.25rem 1.5rem;
        background: white;
        border-radius: 16px;
        box-shadow: 4px 4px 12px #d1d5db, -4px -4px 12px #ffffff;
        text-align: left;
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        transition: all 0.2s;
        border: 3px solid transparent;
        margin-bottom: 1rem;
    }

    .option-btn:hover {
        transform: translateY(-3px);
        box-shadow: 6px 6px 16px #d1d5db, -6px -6px 16px #ffffff;
    }

    .option-btn.selected {
        border-color: #8B5CF6;
        background: linear-gradient(135deg, #F3E8FF 0%, #FCE7F3 100%);
        color: #7C3AED;
    }

    .name-input {
        width: 100%;
        padding: 1rem 1.5rem;
        font-size: 1.25rem;
        border: 3px solid #E5E7EB;
        border-radius: 16px;
        text-align: center;
        transition: all 0.2s;
    }

    .name-input:focus {
        outline: none;
        border-color: #8B5CF6;
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
    }

    .animal-emoji {
        font-size: 3rem;
        animation: bounce 1s infinite;
    }

    @keyframes bounce {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="pt-24 pb-20 px-4 min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50">
    <div class="max-w-xl mx-auto">
        <!-- í—¤ë” -->
        <div class="text-center mb-8" data-aos="fade-up">
            <div class="animal-emoji mb-4">ğŸ“</div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700 font-title mb-2">
                ìš°ë¦¬ë°˜ ìºë¦­í„° ì¹œêµ¬ ì°¾ê¸°
            </h1>
            <p class="text-gray-500">{{ session.session_name }}</p>
        </div>

        <!-- ì§„í–‰ ìƒí™© -->
        <div class="mb-6" data-aos="fade-up">
            <div class="flex justify-between text-sm font-bold mb-2">
                <span class="text-purple-600" id="step-text">ì´ë¦„ ì…ë ¥</span>
                <span class="text-gray-400" id="step-counter">0 / {{ questions|length }}</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-bar" style="width: 0%;"></div>
            </div>
        </div>

        <!-- í€´ì¦ˆ ì¹´ë“œ -->
        <div class="clay-card p-6 md:p-14" data-aos="zoom-in">
            <form id="quiz-form" action="{% url 'studentmbti:analyze' session.id %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="mac_hash" id="mac-hash" value="">

                <!-- Step 0: ì´ë¦„ ì…ë ¥ -->
                <div class="quiz-step active" id="step-0">
                    <div class="text-center">
                        <div class="text-6xl mb-6">ğŸ‘‹</div>
                        <h2 class="text-2xl font-bold text-gray-700 mb-4">ì•ˆë…•! ì´ë¦„ì´ ë­ì•¼?</h2>
                        <p class="text-gray-500 mb-6">ê²€ì‚¬ ê²°ê³¼ì— ì´ë¦„ì´ í‘œì‹œë¼ìš”</p>
                        <input type="text" name="student_name" id="student-name" class="name-input" placeholder="ì˜ˆ: í–‡ì‚´1, ë¯¼ë“¤ë ˆ3"
                            required maxlength="20">
                        <p class="text-xs text-amber-600 mt-3">ì‹¤ëª… ëŒ€ì‹  ë³„ëª… ë˜ëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
                    </div>
                </div>

                <!-- ì§ˆë¬¸ë“¤ -->
                {% for q in questions %}
                <div class="quiz-step" id="step-{{ q.id }}">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-700 mb-6 leading-relaxed">
                        {{ q.title }}
                    </h2>
                    <div class="space-y-3">
                        {% for option in q.options %}
                        <button type="button" class="option-btn" data-q-id="{{ q.id }}"
                            data-option-idx="{{ forloop.counter0 }}" onclick="selectOption(this)">
                            {{ option }}
                        </button>
                        {% endfor %}
                        <input type="hidden" name="q{{ q.id }}" id="input-q{{ q.id }}" value="">
                    </div>
                </div>
                {% endfor %}

                <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="mt-8 flex justify-between items-center">
                    <button type="button" id="prev-btn" onclick="prevStep()"
                        class="hidden px-6 py-3 rounded-full text-gray-400 font-bold hover:text-gray-600 transition">
                        <i class="fa-solid fa-arrow-left mr-2"></i>ì´ì „
                    </button>
                    <button type="button" id="next-btn" onclick="nextStep()"
                        class="ml-auto px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full text-lg font-bold shadow-lg hover:shadow-xl transition transform hover:scale-105">
                        ì‹œì‘í•˜ê¸° <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                    <button type="submit" id="submit-btn"
                        class="hidden ml-auto px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full text-lg font-bold shadow-lg hover:shadow-xl transition transform hover:scale-105 animate-pulse">
                        ê²°ê³¼ ë³´ê¸° <i class="fa-solid fa-wand-magic-sparkles ml-2"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- ì•ˆë‚´ -->
        <p class="text-center text-sm text-gray-400 mt-6">
            ì†”ì§í•˜ê²Œ ë‹µí•´ì¤˜ìš”! ì •ë‹µì€ ì—†ì–´ìš” ğŸ˜Š
        </p>
    </div>
</section>

<script>
    let currentStep = 0;
    const totalSteps = {{ questions| length }};

    function updateUI() {
        // ëª¨ë“  ìŠ¤í… ìˆ¨ê¸°ê¸°
        document.querySelectorAll('.quiz-step').forEach(s => s.classList.remove('active'));
        document.getElementById(`step-${currentStep}`).classList.add('active');

        // ì§„í–‰ ë°” ì—…ë°ì´íŠ¸
        const stepRatio = currentStep / (totalSteps + 1);
        const progressVal = stepRatio * 100;
        document.getElementById('progress-bar').style.width = progressVal + '%';

        // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        if (currentStep === 0) {
            document.getElementById('step-text').innerText = 'ì´ë¦„ ì…ë ¥';
            document.getElementById('step-counter').innerText = '0 / ' + totalSteps;
        } else {
            document.getElementById('step-text').innerText = `ì§ˆë¬¸ ${currentStep}`;
            document.getElementById('step-counter').innerText = `${currentStep} / ${totalSteps}`;
        }

        // ë²„íŠ¼ ìƒíƒœ
        document.getElementById('prev-btn').classList.toggle('hidden', currentStep === 0);

        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');

        if (currentStep === 0) {
            nextBtn.innerHTML = 'ì‹œì‘í•˜ê¸° <i class="fa-solid fa-arrow-right ml-2"></i>';
            nextBtn.classList.remove('hidden');
            submitBtn.classList.add('hidden');
        } else if (currentStep === totalSteps) {
            // ë§ˆì§€ë§‰ ì§ˆë¬¸ì—ì„œ ë‹µë³€ì´ ìˆìœ¼ë©´ ì œì¶œ ë²„íŠ¼ í‘œì‹œ
            const lastAnswer = document.getElementById(`input-q${totalSteps}`).value;
            if (lastAnswer !== '') {
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.add('hidden');
                submitBtn.classList.add('hidden');
            }
        } else {
            nextBtn.classList.add('hidden');
            submitBtn.classList.add('hidden');
        }
    }

    function nextStep() {
        if (currentStep === 0) {
            const name = document.getElementById('student-name').value.trim();
            if (!name) {
                document.getElementById('student-name').focus();
                document.getElementById('student-name').classList.add('border-red-500');
                return;
            }
            document.getElementById('student-name').classList.remove('border-red-500');

            // ì„œë²„ì— í•™ìƒ ë“±ë¡ (ê¸°ì¡´ ë ˆì½”ë“œ ì´ë¦„ ì—…ë°ì´íŠ¸)
            fetch("{% url 'studentmbti:start_test' session.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new URLSearchParams({
                    'student_name': name,
                    'result_id': '{{ result_id }}',
                    'mac_hash': document.getElementById('mac-hash').value
                })
            }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Student registered:', data.result_id);
                    }
                })
                .catch(error => console.error('Registration error:', error));
        }

        if (currentStep < totalSteps) {
            currentStep++;
            updateUI();
        }
    }

    function prevStep() {
        if (currentStep > 0) {
            currentStep--;
            updateUI();
        }
    }

    function selectOption(btn) {
        const step = btn.dataset.qId;
        const value = btn.dataset.optionIdx;

        // ì„ íƒ í‘œì‹œ
        const buttons = document.getElementById(`step-${step}`).querySelectorAll('.option-btn');
        buttons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');

        // ê°’ ì €ì¥
        document.getElementById('input-q' + step).value = value;

        // ìë™ ë‹¤ìŒ ìŠ¤í…
        setTimeout(() => {
            if (currentStep < totalSteps) {
                nextStep();
            } else {
                updateUI();
            }
        }, 300);
    }

    async function generateMacHash() {
        const payload = [
            navigator.userAgent || '',
            navigator.platform || '',
            navigator.language || '',
            Intl.DateTimeFormat().resolvedOptions().timeZone || '',
            String(screen.width || ''),
            String(screen.height || ''),
            String(screen.colorDepth || ''),
        ].join('|');

        if (window.crypto && window.crypto.subtle) {
            const data = new TextEncoder().encode(payload);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(digest))
                .map((b) => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // Fallback hash when SubtleCrypto is unavailable
        let hash = 0;
        for (let i = 0; i < payload.length; i++) {
            hash = ((hash << 5) - hash + payload.charCodeAt(i)) | 0;
        }
        return Math.abs(hash).toString(16).padStart(64, '0').slice(0, 64);
    }

    async function ensureMacHash() {
        const input = document.getElementById('mac-hash');
        if (!input || input.value) return;
        input.value = await generateMacHash();
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await ensureMacHash();
        updateUI();
    });

    document.getElementById('quiz-form').addEventListener('submit', async (e) => {
        if (!document.getElementById('mac-hash').value) {
            e.preventDefault();
            await ensureMacHash();
            e.currentTarget.submit();
        }
    });
</script>
{% endblock %}
