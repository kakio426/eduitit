{% extends 'base.html' %}
{% load static %}

{% block title %}?ъ＜ 遺꾩꽍 ?곸꽭蹂닿린 - Eduitit{% endblock %}

{% block extra_css %}
<style>
    .pillar-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1.5rem 1rem;
        border-radius: 2rem;
        background: white;
        min-width: 90px;
        box-shadow: var(--clay-shadow);
        transition: transform 0.3s ease;
        border: 2px solid transparent;
    }

    .pillar-box:hover {
        transform: translateY(-5px);
        border-color: rgba(99, 102, 241, 0.2);
    }

    .pillar-top {
        font-size: 1rem;
        font-weight: 800;
        color: #94a3b8;
    }

    .pillar-main {
        font-size: 2.75rem;
        font-weight: 900;
        line-height: 1.1;
        font-family: 'NanumGothic', serif;
    }

    .pillar-sub {
        font-size: 0.8rem;
        font-weight: 700;
        color: #64748b;
    }

    /* Element Colors */
    .color-wood {
        color: #10b981;
    }

    /* Green */
    .color-fire {
        color: #ef4444;
    }

    /* Red */
    .color-earth {
        color: #f59e0b;
    }

    /* Yellow/Orange */
    .color-metal {
        color: #94a3b8;
    }

    /* Gray/Silver */
    .color-water {
        color: #3b82f6;
    }

    /* Blue */
    .color-black {
        color: #1e293b;
    }

    /* Alternative Water */

    .analysis-content h2 {
        font-size: 1.5rem;
        font-weight: 900;
        color: #1e293b;
        margin-top: 2.5rem;
        margin-bottom: 1.25rem;
        padding-left: 1rem;
        border-left: 5px solid #6366f1;
    }

    .analysis-content h3 {
        font-size: 1.25rem;
        font-weight: 800;
        color: #334155;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .analysis-content p {
        line-height: 1.8;
        color: #475569;
        margin-bottom: 1.25rem;
        word-break: keep-all;
    }

    .analysis-content ul {
        list-style-type: none;
        padding-left: 0;
    }

    .analysis-content li {
        margin-bottom: 0.75rem;
        padding-left: 1.5rem;
        position: relative;
    }

    .analysis-content li::before {
        content: "??;
        color: #6366f1;
        font-weight: bold;
        position: absolute;
        left: 0.5rem;
    }

    #markdown-output blockquote {
        border-left: 4px solid #e2e8f0;
        padding-left: 1rem;
        font-style: italic;
        color: #64748b;
        margin: 1.5rem 0;
    }

    @media print {
        .no-print {
            display: none;
        }

        .clay-card {
            box-shadow: none;
            border: 1px solid #e2e8f0;
        }

        body {
            background: white;
        }
    }
</style>
{% endblock %}

{% block content %}
<main class="pt-32 pb-20 px-4 max-w-4xl mx-auto min-h-screen">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4 no-print">
        <div>
            <nav class="flex text-sm font-bold text-slate-400 mb-2 gap-2">
                <a href="{% url 'fortune:history' %}" class="hover:text-indigo-500 transition">??蹂닿???/a>
                <span>/</span>
                <span class="text-slate-600">?곸꽭?댁뿭</span>
            </nav>
            <h1 class="text-4xl font-black text-slate-800">
                {% if item.mode == 'daily' %}
                ?뱟 {{ item.target_date|date:"m??d?? }}???댁꽭
                {% else %}
                ???뺥넻 ?ъ＜ ?곷떞 湲곕줉
                {% endif %}
            </h1>
            <p class="text-lg text-slate-500 font-medium mt-2">?곷떞 ?쇱떆: {{ item.created_at|date:"Y.m.d H:i" }}</p>
        </div>
        <div class="flex gap-3">
            <button onclick="window.print()"
                class="clay-card px-5 py-3 bg-white text-slate-600 font-bold hover:bg-slate-50 transition">
                <i class="fa-solid fa-print mr-2"></i>?몄뇙
            </button>
            <button onclick="deleteItem('{{ item.id }}')"
                class="clay-card px-5 py-3 bg-red-50 text-red-500 font-bold hover:bg-red-500 hover:text-white transition">
                <i class="fa-solid fa-trash-can mr-2"></i>??젣
            </button>
        </div>
    </div>

    <!-- Natal Chart Section -->
    {% if item.natal_chart %}
    <div class="clay-card p-6 md:p-10 mb-10 bg-gradient-to-br from-indigo-50/50 to-white border border-indigo-100">
        <h2 class="text-2xl font-black text-slate-700 mb-8 flex items-center gap-2">
            <i class="fa-solid fa-dharmachakra text-indigo-500"></i>
            遺꾩꽍 ????ъ＜ 紐낆떇
        </h2>

        <div class="grid grid-cols-4 gap-2 md:gap-6">
            <!-- ?쒖＜ -->
            <div class="pillar-box">
                <span class="pillar-top">?쒖＜</span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.hour|first }}"></span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.hour|last }}"></span>
                <span class="pillar-sub">留먮뀈??/span>
            </div>
            <!-- ?쇱＜ -->
            <div class="pillar-box border-indigo-400 bg-indigo-50/30">
                <span class="pillar-top text-indigo-600">?쇱＜</span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.day|first }}"></span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.day|last }}"></span>
                <span class="pillar-sub text-indigo-600">???먯떊</span>
            </div>
            <!-- ?붿＜ -->
            <div class="pillar-box">
                <span class="pillar-top">?붿＜</span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.month|first }}"></span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.month|last }}"></span>
                <span class="pillar-sub">?ы쉶??泥?뀈</span>
            </div>
            <!-- ?꾩＜ -->
            <div class="pillar-box">
                <span class="pillar-top">?꾩＜</span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.year|first }}"></span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.year|last }}"></span>
                <span class="pillar-sub">議곗긽/珥덈뀈</span>
            </div>
        </div>

        <div class="mt-8 flex flex-wrap justify-center gap-4">
            <div class="flex items-center gap-2 text-xs font-bold px-3 py-1 bg-green-100 text-green-700 rounded-full">??
                紐?Wood)</div>
            <div class="flex items-center gap-2 text-xs font-bold px-3 py-1 bg-red-100 text-red-700 rounded-full">??
                ??Fire)</div>
            <div class="flex items-center gap-2 text-xs font-bold px-3 py-1 bg-amber-100 text-amber-700 rounded-full">??
                ??Earth)</div>
            <div class="flex items-center gap-2 text-xs font-bold px-3 py-1 bg-slate-200 text-slate-700 rounded-full">??
                湲?Metal)</div>
            <div class="flex items-center gap-2 text-xs font-bold px-3 py-1 bg-blue-100 text-blue-700 rounded-full">??
                ??Water)</div>
        </div>
    </div>
    {% endif %}

    <!-- Analysis Text -->
    <div class="clay-card p-8 md:p-12 bg-white analysis-content">
        <div id="markdown-output" class="prose prose-slate max-w-none">
            {{ item.result_text }}
        </div>
    </div>

    <!-- Bottom Action -->
    <div class="mt-12 text-center no-print">
        <a href="{% url 'fortune:history' %}"
            class="inline-block px-10 py-5 bg-slate-900 text-white rounded-2xl font-black shadow-xl hover:-translate-y-1 transition">
            紐⑸줉?쇰줈 ?뚯븘媛湲?
        </a>
    </div>
</main>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Element Mapping
    const elementMap = {
        '??: 'wood', '阿?: 'wood', '野?: 'wood', '??: 'wood',
        '訝?: 'fire', '訝?: 'fire', '藥?: 'fire', '??: 'fire',
        '??: 'earth', '藥?: 'earth', '渦?: 'earth', '??: 'earth', '訝?: 'earth', '??: 'earth',
        '佯?: 'metal', '渦?: 'metal', '??: 'metal', '??: 'metal',
        '鶯?: 'water', '??: 'water', '雅?: 'water', '耶?: 'water'
    };

    // Initialize Coloring
    document.querySelectorAll('.natal-char').forEach(el => {
        const char = el.getAttribute('data-char');
        if (char && char !== '?') {
            el.innerText = char;
            const element = elementMap[char];
            if (element) el.classList.add(`color-${element}`);
        } else {
            el.innerText = '?';
            el.classList.add('text-slate-200');
        }
    });

    // Render Markdown
    const outputArea = document.getElementById('markdown-output');
    const rawText = outputArea.innerText;
    outputArea.innerHTML = marked.parse(rawText);

    async function deleteItem(id) {
        if (!confirm('??湲곕줉???곴뎄????젣?좉퉴??')) return;

        try {
            const response = await fetch(`/fortune/history/${id}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            if (response.ok) {
                location.href = "{% url 'fortune:history' %}";
            }
        } catch (e) {
            alert('??젣 以??ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        }
    }
</script>
{% endblock %}
