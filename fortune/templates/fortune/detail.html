{% extends 'base.html' %}
{% load static %}

{% block title %}ì‚¬ì£¼ ë¶„ì„ ìƒì„¸ë³´ê¸° - Eduitit{% endblock %}

{% block extra_css %}
<style>
    .pillar-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1.5rem 1rem;
        border-radius: 2rem;
        background: white;
        min-width: 90px;
        box-shadow: var(--clay-shadow);
        transition: transform 0.3s ease;
        border: 2px solid transparent;
    }

    .pillar-box:hover {
        transform: translateY(-5px);
        border-color: rgba(99, 102, 241, 0.2);
    }

    .pillar-top {
        font-size: 1rem;
        font-weight: 800;
        color: #94a3b8;
    }

    .pillar-main {
        font-size: 2.75rem;
        font-weight: 900;
        line-height: 1.1;
        font-family: 'NanumGothic', serif;
    }

    .pillar-sub {
        font-size: 0.8rem;
        font-weight: 700;
        color: #64748b;
    }

    /* Element Colors */
    .color-wood {
        color: #10b981;
    }

    /* Green */
    .color-fire {
        color: #ef4444;
    }

    /* Red */
    .color-earth {
        color: #f59e0b;
    }

    /* Yellow/Orange */
    .color-metal {
        color: #94a3b8;
    }

    /* Gray/Silver */
    .color-water {
        color: #3b82f6;
    }

    /* Blue */
    .color-black {
        color: #1e293b;
    }

    /* Alternative Water */

    .analysis-content h1 {
        font-size: 1.75rem;
        font-weight: 900;
        color: #1e293b;
        margin-top: 2rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 3px solid #6366f1;
    }

    .analysis-content h2 {
        font-size: 1.5rem;
        font-weight: 900;
        color: #1e293b;
        margin-top: 2.5rem;
        margin-bottom: 1.25rem;
        padding-left: 1rem;
        border-left: 5px solid #6366f1;
    }

    .analysis-content h3 {
        font-size: 1.25rem;
        font-weight: 800;
        color: #334155;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .analysis-content p {
        line-height: 1.9;
        color: #475569;
        margin-bottom: 1.5rem;
        word-break: keep-all;
        white-space: pre-wrap;
    }

    .analysis-content ul {
        list-style-type: none;
        padding-left: 0;
        margin-bottom: 1.5rem;
    }

    .analysis-content ol {
        padding-left: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .analysis-content li {
        margin-bottom: 0.75rem;
        padding-left: 1.5rem;
        position: relative;
        line-height: 1.8;
    }

    .analysis-content ul li::before {
        content: "â€¢";
        color: #6366f1;
        font-weight: bold;
        position: absolute;
        left: 0.5rem;
    }

    .analysis-content strong {
        color: #7c3aed;
        font-weight: 800;
    }

    .analysis-content em {
        color: #6366f1;
        font-style: italic;
    }

    .analysis-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5rem 0;
    }

    .analysis-content th,
    .analysis-content td {
        border: 1px solid #e2e8f0;
        padding: 0.75rem;
        text-align: left;
    }

    .analysis-content th {
        background-color: #f7fafc;
        font-weight: bold;
    }

    .analysis-content blockquote {
        border-left: 4px solid #e2e8f0;
        padding-left: 1rem;
        font-style: italic;
        color: #64748b;
        margin: 1.5rem 0;
        background: #f8fafc;
        padding: 1rem 1rem 1rem 1.5rem;
        border-radius: 0 8px 8px 0;
    }

    .analysis-content code {
        background: #f1f5f9;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }

    .analysis-content pre {
        background: #f1f5f9;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1.5rem 0;
    }

    @media print {
        .no-print {
            display: none;
        }

        .clay-card {
            box-shadow: none;
            border: 1px solid #e2e8f0;
        }

        body {
            background: white;
        }
    }
</style>
{% endblock %}

{% block content %}
<main class="pt-32 pb-20 px-4 max-w-4xl mx-auto min-h-screen">
    <!-- Navigation -->
    <div class="flex justify-between items-center px-2 mb-8 no-print">
        <a href="{% url 'fortune:history' %}"
            class="inline-flex items-center gap-2 text-gray-500 hover:text-purple-500 transition font-bold">
            <i class="fa-solid fa-arrow-left"></i> ë³´ê´€í•¨ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
        <span class="text-gray-400">{{ item.created_at|date:"Y.m.d H:i" }} ë¶„ì„</span>
    </div>

    <!-- 1. í—¤ë” ì¹´ë“œ (ì¼ê°„ ì´ë¯¸ì§€ & íƒ€ì´í‹€) -->
    <div class="clay-card p-10 text-center relative overflow-hidden mb-8" data-aos="fade-up">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-400 to-indigo-500"></div>

        <!-- ì¼ê°„ ì´ë¯¸ì§€ ì˜ì—­ -->
        <div class="inline-block p-4 rounded-full bg-white shadow-clay-inner mb-6 relative z-10"
            id="stemImageContainer">
            <!-- ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ, ì—†ìœ¼ë©´ ì´ëª¨ì§€ í‘œì‹œ -->
            <div class="w-48 h-48 flex items-center justify-center text-9xl" id="stemIcon">
                ğŸ”®
            </div>
        </div>

        <h2 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">
            <span class="text-purple-500 block text-2xl mb-2">ë‹¹ì‹ ì˜ ì¼ê°„ì€</span>
            <span id="stemName">ì‚¬ì£¼ ë¶„ì„</span>
        </h2>
        <p class="text-xl text-gray-600" id="stemDesc">{{ item.get_mode_display }} ìƒë‹´ ê²°ê³¼</p>
    </div>

    <!-- 2. ì‚¬ì£¼ ëª…ì‹ ì¹´ë“œ (ê°•ì¡°) -->
    {% if item.natal_chart %}
    <div class="clay-card p-8 md:p-10 mb-8 bg-gradient-to-br from-purple-50/50 to-indigo-50/50 border-2 border-purple-200"
        data-aos="fade-up">
        <h2 class="text-2xl font-black text-gray-800 mb-6 text-center flex items-center justify-center gap-2">
            <i class="fa-solid fa-yin-yang text-purple-500"></i>
            ì‚¬ì£¼ íŒ”ì ëª…ì‹
        </h2>

        <div class="grid grid-cols-4 gap-3 md:gap-6">
            <!-- ì‹œì£¼ -->
            <div class="pillar-box">
                <span class="pillar-top">ì‹œì£¼</span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.hour|first }}"></span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.hour|last }}"></span>
                <span class="pillar-sub">ë§ë…„ìš´</span>
            </div>
            <!-- ì¼ì£¼ (ê°•ì¡°) -->
            <div class="pillar-box border-4 border-purple-400 bg-purple-50/50 shadow-xl transform scale-105">
                <span class="pillar-top text-purple-600">ì¼ì£¼ â­</span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.day|first }}"
                    id="dayStemChar"></span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.day|last }}"></span>
                <span class="pillar-sub text-purple-600 font-black">ë‚˜ ìì‹ </span>
            </div>
            <!-- ì›”ì£¼ -->
            <div class="pillar-box">
                <span class="pillar-top">ì›”ì£¼</span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.month|first }}"></span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.month|last }}"></span>
                <span class="pillar-sub">ì‚¬íšŒ/ì²­ë…„</span>
            </div>
            <!-- ë…„ì£¼ -->
            <div class="pillar-box">
                <span class="pillar-top">ë…„ì£¼</span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.year|first }}"></span>
                <span class="pillar-main natal-char" data-char="{{ item.natal_chart.year|last }}"></span>
                <span class="pillar-sub">ì¡°ìƒ/ì´ˆë…„</span>
            </div>
        </div>

        <div class="mt-8 flex flex-wrap justify-center gap-3">
            <div
                class="flex items-center gap-2 text-sm font-bold px-4 py-2 bg-green-100 text-green-700 rounded-full shadow-sm">
                ğŸŒ³ ëª©(Wood)
            </div>
            <div
                class="flex items-center gap-2 text-sm font-bold px-4 py-2 bg-red-100 text-red-700 rounded-full shadow-sm">
                ğŸ”¥ í™”(Fire)
            </div>
            <div
                class="flex items-center gap-2 text-sm font-bold px-4 py-2 bg-amber-100 text-amber-700 rounded-full shadow-sm">
                â›°ï¸ í† (Earth)
            </div>
            <div
                class="flex items-center gap-2 text-sm font-bold px-4 py-2 bg-slate-200 text-slate-700 rounded-full shadow-sm">
                âš”ï¸ ê¸ˆ(Metal)
            </div>
            <div
                class="flex items-center gap-2 text-sm font-bold px-4 py-2 bg-blue-100 text-blue-700 rounded-full shadow-sm">
                ğŸ’§ ìˆ˜(Water)
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 3. AI ë¶„ì„ ë‚´ìš© -->
    <div class="clay-card p-8 md:p-12 bg-white analysis-content" data-aos="fade-up">
        <div id="markdown-output" class="prose prose-slate max-w-none">
            {{ item.result_text }}
        </div>
    </div>

    <!-- 4. ê³µìœ  ì•¡ì…˜ ì¹´ë“œ -->
    <div class="clay-card p-8 bg-white/50 border border-white/60 text-center mt-8 no-print" data-aos="fade-up">
        <h3 class="text-2xl font-bold text-gray-700 mb-6 font-title">
            ì¹œêµ¬ì—ê²Œë„ ê³µìœ í•˜ì„¸ìš”! ğŸ“¢
        </h3>
        <div class="flex flex-col md:flex-row gap-4 justify-center">
            <button onclick="shareToKakao()"
                class="px-8 py-4 bg-[#FEE500] text-[#3C1E1E] rounded-full font-bold flex items-center justify-center gap-2 hover:scale-105 transition shadow-clay text-lg">
                <i class="fa-solid fa-comment"></i> ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
            </button>
            <button onclick="copyLink()"
                class="px-8 py-4 bg-white text-gray-600 rounded-full font-bold flex items-center justify-center gap-2 hover:scale-105 transition shadow-clay border border-gray-100 text-lg">
                <i class="fa-solid fa-link"></i> ë§í¬ ë³µì‚¬
            </button>
            <button onclick="window.print()"
                class="px-8 py-4 bg-slate-100 text-gray-600 rounded-full font-bold flex items-center justify-center gap-2 hover:scale-105 transition shadow-clay border border-gray-100 text-lg">
                <i class="fa-solid fa-print"></i> ì¸ì‡„í•˜ê¸°
            </button>
            <a href="{% url 'fortune:saju' %}"
                class="px-8 py-4 bg-purple-500 text-white rounded-full font-bold flex items-center justify-center gap-2 hover:scale-105 transition shadow-clay text-lg">
                <i class="fa-solid fa-crystal-ball"></i> ë‚˜ë„ ì‚¬ì£¼ë³´ê¸°
            </a>
        </div>
    </div>
</main>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<!-- ì¹´ì¹´ì˜¤ SDK -->
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>

<!-- ë°ì´í„° ì•ˆì „ ì „ë‹¬ -->
{{ item.natal_chart|json_script:"natal-chart-data" }}

<script>
    // Element Mapping
    const elementMap = {
        'ç”²': 'wood', 'ä¹™': 'wood', 'å¯…': 'wood', 'å¯': 'wood',
        'ä¸™': 'fire', 'ä¸': 'fire', 'å·³': 'fire', 'åˆ': 'fire',
        'æˆŠ': 'earth', 'å·±': 'earth', 'è¾°': 'earth', 'æˆŒ': 'earth', 'ä¸‘': 'earth', 'æœª': 'earth',
        'åºš': 'metal', 'è¾›': 'metal', 'ç”³': 'metal', 'é…‰': 'metal',
        'å£¬': 'water', 'ç™¸': 'water', 'äº¥': 'water', 'å­': 'water'
    };

    // ì²œê°„ í•œê¸€ ë§¤í•‘
    const stemKoreanMap = {
        'ç”²': 'ê°‘ëª©', 'ä¹™': 'ì„ëª©',
        'ä¸™': 'ë³‘í™”', 'ä¸': 'ì •í™”',
        'æˆŠ': 'ë¬´í† ', 'å·±': 'ê¸°í† ',
        'åºš': 'ê²½ê¸ˆ', 'è¾›': 'ì‹ ê¸ˆ',
        'å£¬': 'ì„ìˆ˜', 'ç™¸': 'ê³„ìˆ˜'
    };

    // ì²œê°„ ì´ëª¨ì§€ ë§¤í•‘
    const stemEmojiMap = {
        'ç”²': 'ğŸŒ³', 'ä¹™': 'ğŸŒ¿',
        'ä¸™': 'â˜€ï¸', 'ä¸': 'ğŸ•¯ï¸',
        'æˆŠ': 'â›°ï¸', 'å·±': 'ğŸ”ï¸',
        'åºš': 'âš”ï¸', 'è¾›': 'ğŸ’',
        'å£¬': 'ğŸŒŠ', 'ç™¸': 'ğŸ’§'
    };

    // ì²œê°„ ì„¤ëª… ë§¤í•‘
    const stemDescMap = {
        'ç”²': 'í° ë‚˜ë¬´ì²˜ëŸ¼ ê³§ê³  ê°•í•œ ê¸°ìš´', 'ä¹™': 'í’€ê³¼ ë„ì¿¨ì²˜ëŸ¼ ë¶€ë“œëŸ½ê³  ìœ ì—°í•œ ê¸°ìš´',
        'ä¸™': 'íƒœì–‘ì²˜ëŸ¼ ë°ê³  ë”°ëœ»í•œ ê¸°ìš´', 'ä¸': 'ì´›ë¶ˆì²˜ëŸ¼ ì˜¨í™”í•˜ê³  ì„¬ì„¸í•œ ê¸°ìš´',
        'æˆŠ': 'í° ì‚°ì²˜ëŸ¼ ë“ ë“ í•˜ê³  í¬ìš©ë ¥ ìˆëŠ” ê¸°ìš´', 'å·±': 'ë…¼ë°­ì²˜ëŸ¼ ìƒì‚°ì ì´ê³  ì‹¤ìš©ì ì¸ ê¸°ìš´',
        'åºš': 'ì¹¼ê³¼ ë°”ìœ„ì²˜ëŸ¼ ê°•í•˜ê³  ì •ì˜ë¡œìš´ ê¸°ìš´', 'è¾›': 'ë³´ì„ì²˜ëŸ¼ ì•„ë¦„ë‹µê³  ì„¸ë ¨ëœ ê¸°ìš´',
        'å£¬': 'ë°”ë‹¤ì²˜ëŸ¼ ë„“ê³  ê¹Šì€ ê¸°ìš´', 'ç™¸': 'ë¹„ì™€ ì´ìŠ¬ì²˜ëŸ¼ ë¶€ë“œëŸ½ê³  ì§€í˜œë¡œìš´ ê¸°ìš´'
    };

    // Initialize Coloring
    let dayStemCharacter = null;
    document.querySelectorAll('.natal-char').forEach(el => {
        const char = el.getAttribute('data-char');
        if (char && char !== '?') {
            el.innerText = char;
            const element = elementMap[char];
            if (element) el.classList.add(`color-${element}`);

            // ì¼ì£¼ ì²œê°„ ì €ì¥
            if (el.id === 'dayStemChar') {
                dayStemCharacter = char;
            }
        } else {
            el.innerText = '?';
            el.classList.add('text-slate-200');
        }
    });

    // í—¤ë” ì¹´ë“œ ì—…ë°ì´íŠ¸ (ì¼ê°„ ì •ë³´)
    if (dayStemCharacter && stemKoreanMap[dayStemCharacter]) {
        const stemIcon = document.getElementById('stemIcon');
        const stemName = document.getElementById('stemName');
        const stemDesc = document.getElementById('stemDesc');

        if (stemIcon) stemIcon.textContent = stemEmojiMap[dayStemCharacter];
        if (stemName) stemName.textContent = stemKoreanMap[dayStemCharacter];
        if (stemDesc) stemDesc.textContent = stemDescMap[dayStemCharacter];
    }

    // Render Markdown with proper settings
    const outputArea = document.getElementById('markdown-output');
    const rawText = outputArea.innerText || outputArea.textContent;

    // Configure marked for better formatting
    marked.setOptions({
        breaks: true,        // ì¤„ë°”ê¿ˆ ì¸ì‹
        gfm: true,          // GitHub Flavored Markdown
        headerIds: false,
        mangle: false
    });

    // Pre-process text to ensure headers and lists are on new lines
    // 1. Ensure headers (##) have newlines before them
    rawText = rawText.replace(/(#{1,6}\s)/g, '\n\n$1');

    // 2. Ensure numbered lists (1. , 2. ) have newlines before them if they are following text
    // We look for "number. space" that is NOT at the start of the string
    rawText = rawText.replace(/([^\n])\s+(\d+\.\s)/g, '$1\n\n$2');

    // 3. Ensure bullet points (- ) have newlines
    rawText = rawText.replace(/([^\n])\s+(-\s)/g, '$1\n\n$2');

    // Parse and sanitize
    try {
        const parsedMarkdown = marked.parse(rawText);
        outputArea.innerHTML = DOMPurify.sanitize(parsedMarkdown);
    } catch (e) {
        console.error("Markdown rendering failed:", e);
        outputArea.innerHTML = rawText.replace(/\n/g, '<br>');
    }

    // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
    if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
        Kakao.init('{{ kakao_js_key }}');
    }

    // ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
    function shareToKakao() {
        try {
            const natalChart = JSON.parse(document.getElementById('natal-chart-data').textContent);
            const dayStem = natalChart.day ? natalChart.day[0] : '?';
            const stemKorean = stemKoreanMap[dayStem] || 'ì‚¬ì£¼';
            const stemEmoji = stemEmojiMap[dayStem] || 'ğŸ”®';

            const mode = '{{ item.get_mode_display }}';

            // Use the new image
            const imageUrl = window.location.origin + '/static/fortune/images/teacher_saju_card.png';
            const shareUrl = window.location.href;

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: `${stemEmoji} ${stemKorean} ê¸°ìš´ì˜ ì‚¬ì£¼ ê²°ê³¼`,
                    description: `${mode} ìƒë‹´ ê²°ê³¼ì…ë‹ˆë‹¤.\n\në‹¹ì‹ ì˜ ì‚¬ì£¼ëŠ” ì–´ë–¨ê¹Œìš”? ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”! ğŸ”®`,
                    imageUrl: imageUrl,
                    link: {
                        mobileWebUrl: shareUrl,
                        webUrl: shareUrl,
                    },
                },
                buttons: [
                    {
                        title: 'ë‚˜ë„ ì‚¬ì£¼ë³´ê¸° ğŸ”®',
                        link: {
                            mobileWebUrl: '{{ request.scheme }}://{{ request.get_host }}{% url "fortune:saju" %}',
                            webUrl: '{{ request.scheme }}://{{ request.get_host }}{% url "fortune:saju" %}',
                        },
                    },
                ],
            });
        } catch (e) {
            console.error("Kakao Share Error:", e);
            alert("ê³µìœ í•˜ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ë§í¬ ë³µì‚¬
    function copyLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });
    }

    async function deleteItem(id) {
        if (!confirm('ì´ ê¸°ë¡ì„ ì˜êµ¬íˆ ì‚­ì œí• ê¹Œìš”?')) return;

        try {
            const response = await fetch(`/fortune/history/${id}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });
            if (response.ok) {
                location.href = "{% url 'fortune:history' %}";
            }
        } catch (e) {
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // AOS ì´ˆê¸°í™” (ì• ë‹ˆë©”ì´ì…˜)
    if (typeof AOS !== 'undefined') {
        AOS.init({
            duration: 800,
            once: true
        });
    }
</script>
{% endblock %}