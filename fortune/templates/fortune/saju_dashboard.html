{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    /* Modern Mystique & Glassmorphism Theme */
    :root {
        --mystic-bg: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
        --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        --accent-gradient: linear-gradient(90deg, #FFD700 0%, #FDB931 100%);
        /* Golden for Fortune */
    }

    body {
        background: #f8fafc;
        /* Fallback for light mode base */
    }

    /* Dark Mode Override for this page if global dark mode isn't set */
    .saju-dashboard {
        background: radial-gradient(circle at 50% -20%, #2E1065, #0F172A);
        min-height: 100vh;
        color: white;
        font-family: 'NanumSquareRound', sans-serif;
    }

    /* Glass Card */
    .glass-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border-radius: 24px;
    }

    /* Input Field Style */
    .glass-input {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
    }

    .glass-input:focus {
        background: rgba(0, 0, 0, 0.4);
        border-color: #A78BFA;
        outline: none;
    }

    /* Pillar Character Styling */
    .pillar-char {
        font-family: 'Noto Serif KR', serif;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    /* Element Colors */
    .text-wood {
        color: #4ADE80;
    }

    .text-fire {
        color: #F87171;
    }

    .text-earth {
        color: #FBBF24;
    }

    .text-metal {
        color: #E2E8F0;
    }

    .text-water {
        color: #60A5FA;
    }

    /* Button Safety & Loading */
    .btn-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.8;
    }

    .btn-loading::after {
        content: "";
        position: absolute;
        width: 1.2em;
        height: 1.2em;
        top: 50%;
        left: 50%;
        margin-top: -0.6em;
        margin-left: -0.6em;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Markdown Content */
    .markdown-result h2 {
        font-size: 1.4rem;
        font-weight: bold;
        margin-top: 1.5rem;
        margin-bottom: 0.8rem;
        color: #ddd6fe;
        /* violet-200 */
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.5rem;
    }

    .markdown-result strong {
        color: #FDB931;
        /* Gold */
    }

    .markdown-result ul {
        list-style-type: disc;
        padding-left: 1.5rem;
        margin-bottom: 1rem;
    }

    .markdown-result li {
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="saju-dashboard pt-40 pb-20 px-4">
    <div class="max-w-4xl mx-auto">

        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">
                <i class="fa-solid fa-moon mr-2"></i>ìš´ì„¸ ì—°êµ¬ì†Œ
            </h1>
            <button onclick="toggleMyMenu()" class="text-white text-2xl p-2 hover:bg-white/10 rounded-full transition">
                <i class="fa-solid fa-bars"></i>
            </button>
        </header>

        <!-- STEP 1: Input Form (Tabbed Interface) -->
        <div id="inputSection" class="animate-in fade-in slide-in-from-bottom-4 duration-700 max-w-lg mx-auto">

            <!-- Tab Navigation -->
            <div class="flex justify-center mb-6 gap-3 px-2">
                <button type="button" onclick="switchInputMode('general')" id="tabGeneral"
                    class="flex-1 py-3 rounded-2xl font-bold transition-all text-white bg-white/20 hover:bg-white/30 ring-2 ring-white/50 shadow-lg backdrop-blur-md flex flex-col items-center gap-1 group">
                    <span class="text-2xl group-hover:scale-110 transition-transform">ğŸ™‚</span>
                    <span class="text-sm">ì¼ë°˜ ì‚¬ì£¼</span>
                </button>
                <button type="button" onclick="switchInputMode('teacher')" id="tabTeacher"
                    class="flex-1 py-3 rounded-2xl font-bold transition-all text-purple-200 bg-white/5 hover:bg-white/10 ring-1 ring-white/10 backdrop-blur-md flex flex-col items-center gap-1 group">
                    <span class="text-2xl group-hover:scale-110 transition-transform">ğŸ‘¨â€ğŸ«</span>
                    <span class="text-sm">êµì§ ìš´ì„¸</span>
                </button>
            </div>

            <div class="glass-card p-8 relative overflow-hidden transition-all duration-300 hover:shadow-[0_0_40px_rgba(139,92,246,0.3)]"
                style="backdrop-filter: blur(20px);">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold mb-2 text-white" id="formTitle">ë‚˜ì˜ ì‚¬ì£¼ ëª…í•¨ ë§Œë“¤ê¸°</h2>
                    <p class="text-purple-200 text-sm font-medium" id="formSubtitle">ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ë©´ í‰ìƒ ë³€ì¹˜ ì•ŠëŠ” ì‚¬ì£¼ë¥¼ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.
                    </p>
                </div>

                <form id="sajuForm" onsubmit="handleCalculate(event)" class="space-y-6 relative z-10">
                    <input type="hidden" name="mode" id="serviceMode" value="general">

                    <!-- Name & Gender -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-purple-200 text-sm font-bold mb-2 ml-1">ì´ë¦„</label>
                            <input type="text" name="name"
                                class="glass-input w-full p-4 rounded-2xl text-lg text-center font-bold placeholder-white/30"
                                placeholder="ì´ë¦„" required maxlength="10">
                        </div>
                        <div>
                            <label class="block text-purple-200 text-sm font-bold mb-2 ml-1">ì„±ë³„</label>
                            <div class="flex gap-3">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="gender" value="male" class="peer hidden" required>
                                    <div
                                        class="glass-input p-4 rounded-2xl text-center peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-transparent transition-all hover:bg-white/10 text-gray-300 font-bold">
                                        ë‚¨ì„±
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="gender" value="female" class="peer hidden">
                                    <div
                                        class="glass-input p-4 rounded-2xl text-center peer-checked:bg-pink-500 peer-checked:text-white peer-checked:border-transparent transition-all hover:bg-white/10 text-gray-300 font-bold">
                                        ì—¬ì„±
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Birth Date -->
                    <div>
                        <label class="block text-purple-200 text-sm font-bold mb-2 ml-1">ì–‘ë ¥ ìƒë…„ì›”ì¼</label>
                        <div class="grid grid-cols-3 gap-3">
                            <input type="number" name="birth_year"
                                class="glass-input p-4 rounded-2xl text-center font-bold text-lg placeholder-white/30"
                                placeholder="YYYY" required min="1900" max="2026">
                            <input type="number" name="birth_month"
                                class="glass-input p-4 rounded-2xl text-center font-bold text-lg placeholder-white/30"
                                placeholder="MM" required min="1" max="12">
                            <input type="number" name="birth_day"
                                class="glass-input p-4 rounded-2xl text-center font-bold text-lg placeholder-white/30"
                                placeholder="DD" required min="1" max="31">
                        </div>
                    </div>

                    <!-- Birth Time -->
                    <div>
                        <div class="flex justify-between items-center mb-2 ml-1">
                            <label class="text-purple-200 text-sm font-bold">íƒœì–´ë‚œ ì‹œê°„ <span
                                    class="text-purple-300/70 font-normal">(ì„ íƒ)</span></label>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" name="birth_hour"
                                class="glass-input p-4 rounded-2xl text-center font-bold text-lg placeholder-white/30"
                                placeholder="ì‹œ (0-23)" min="0" max="23">
                            <input type="number" name="birth_minute"
                                class="glass-input p-4 rounded-2xl text-center font-bold text-lg placeholder-white/30"
                                placeholder="ë¶„ (0-59)" min="0" max="59">
                        </div>
                        <p class="text-xs text-purple-300/50 mt-2 text-center">* ì‹œê°„ì„ ëª¨ë¥´ë©´ ì‚¼ì£¼(ä¸‰æŸ±)ë¡œ ë¶„ì„í•©ë‹ˆë‹¤</p>
                    </div>

                    <button type="submit" id="calculateBtn"
                        class="w-full py-5 bg-gradient-to-r from-violet-600 to-indigo-600 rounded-2xl font-bold text-xl text-white shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 hover:from-violet-500 hover:to-indigo-500 transition-all transform hover:-translate-y-1 relative overflow-hidden group border border-white/10">
                        <span class="relative z-10">ì‚¬ì£¼ ëª…í•¨ ë°œê¸‰ë°›ê¸° âœ¨</span>
                        <div
                            class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                        </div>
                    </button>
                </form>
            </div>
        </div>

        <!-- STEP 2: Dashboard (Hidden Initially) -->
        <div id="dashboardSection" class="hidden space-y-8 animate-in fade-in slide-in-from-bottom-8 duration-700">

            <!-- Hero: Identity Card -->
            <div id="sajuCard" class="glass-card p-0 overflow-hidden relative group">
                <!-- Background Pattern -->
                <div
                    class="absolute inset-0 opacity-30 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] mix-blend-overlay">
                </div>

                <div class="relative p-8 flex flex-col items-center">
                    <div class="flex justify-between w-full mb-4">
                        <span class="text-sm text-gray-400 tracking-widest">SAJU IDENTITY</span>
                        <div class="flex gap-2">
                            <button onclick="shareToKakao()" class="text-yellow-400 hover:text-yellow-300 transition"
                                title="ì¹´ì¹´ì˜¤í†¡ ê³µìœ ">
                                <i class="fa-solid fa-comment"></i>
                            </button>
                            <button onclick="saveAsImage()" class="text-blue-400 hover:text-blue-300 transition"
                                title="ì´ë¯¸ì§€ ì €ì¥">
                                <i class="fa-solid fa-image"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Day Master Icon (Center) -->
                    <div class="mb-6 relative">
                        <div
                            class="w-24 h-24 rounded-full bg-gradient-to-br from-white/10 to-white/5 border border-white/20 flex items-center justify-center text-5xl shadow-[0_0_30px_rgba(255,255,255,0.1)]">
                            <span id="dayMasterIcon">ğŸŒ²</span>
                        </div>
                        <div class="absolute -bottom-2 w-full text-center">
                            <span id="dayMasterLabel"
                                class="text-xs bg-black/50 px-2 py-1 rounded-full border border-white/10">ê°‘ëª© (í°
                                ë‚˜ë¬´)</span>
                        </div>
                    </div>

                    <!-- 8 Characters Grid -->
                    <div class="grid grid-cols-4 gap-2 md:gap-6 mb-8 w-full max-w-lg">
                        <!-- Labels -->
                        <div class="text-center text-xs text-gray-500">ì‹œì£¼</div>
                        <div class="text-center text-xs text-gray-500">ì¼ì£¼(ë‚˜)</div>
                        <div class="text-center text-xs text-gray-500">ì›”ì£¼</div>
                        <div class="text-center text-xs text-gray-500">ë…„ì£¼</div>

                        <!-- Pillars (Injected via JS) -->
                        <div class="pillar-box flex flex-col gap-2 items-center" id="colHour"></div>
                        <div class="pillar-box flex flex-col gap-2 items-center" id="colDay"></div>
                        <div class="pillar-box flex flex-col gap-2 items-center" id="colMonth"></div>
                        <div class="pillar-box flex flex-col gap-2 items-center" id="colYear"></div>
                    </div>

                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold mb-1" id="userNameDisplay">í™ê¸¸ë™ë‹˜</h2>
                        <p class="text-purple-200" id="userSummary">"ë‹¹ì‹ ì€ ê³§ê²Œ ë»—ì€ í‘¸ë¥¸ ì†Œë‚˜ë¬´ì…ë‹ˆë‹¤"</p>
                    </div>

                    <!-- Element Distribution -->
                    <div class="w-full max-w-sm bg-black/20 rounded-2xl p-4 border border-white/5">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500 uppercase tracking-widest">ì˜¤í–‰ ë¶„í¬ (8)</span>
                        </div>
                        <div class="flex gap-1 h-3 rounded-full overflow-hidden mb-2" id="elementBar">
                            <!-- Injected via JS -->
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400" id="elementCounts">
                            <!-- Injected via JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 0. Teacher Mode (New) -->
                <button onclick="requestAnalysis(this, 'teacher')"
                    class="glass-card p-6 text-left hover:bg-white/10 transition group relative overflow-hidden ring-2 ring-purple-500/50">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-chalkboard-user text-6xl"></i>
                    </div>
                    <div class="relative z-10">
                        <h3 class="text-xl font-bold text-purple-200 mb-2"><i
                                class="fa-solid fa-chalkboard-user mr-2"></i>êµì§ ìš´ì„¸</h3>
                        <p class="text-gray-400 text-sm">í•™ìƒ, í•™ë¶€ëª¨, ìŠ¹ì§„ ë“±<br>ì„ ìƒë‹˜ë§Œì„ ìœ„í•œ íŠ¹ë³„ ë¶„ì„.</p>
                    </div>
                </button>

                <!-- 1. Personality -->
                <button onclick="requestAnalysis(this, 'personality')"
                    class="glass-card p-6 text-left hover:bg-white/10 transition group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-fingerprint text-6xl"></i>
                    </div>
                    <div class="relative z-10">
                        <h3 class="text-xl font-bold text-purple-300 mb-2"><i
                                class="fa-solid fa-fingerprint mr-2"></i>íƒ€ê³ ë‚œ ê¸°ì§ˆ</h3>
                        <p class="text-gray-400 text-sm">ë‚˜ì˜ ìˆ¨ê²¨ì§„ ì„±ê²©ê³¼ ì¥ì ì„<br>í™•ì¸í•´ë³´ì„¸ìš”.</p>
                    </div>
                </button>

                <!-- 2. Wealth -->
                <button onclick="requestAnalysis(this, 'wealth')"
                    class="glass-card p-6 text-left hover:bg-white/10 transition group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-sack-dollar text-6xl"></i>
                    </div>
                    <div class="relative z-10">
                        <h3 class="text-xl font-bold text-yellow-400 mb-2"><i class="fa-solid fa-coins mr-2"></i>ì¬ë¬¼ìš´ ë¶„ì„
                        </h3>
                        <p class="text-gray-400 text-sm">ëˆì„ ë²„ëŠ” ìŠ¤íƒ€ì¼ê³¼<br>ì¬ë¬¼ì„ ì§€í‚¤ëŠ” íŒ.</p>
                    </div>
                </button>

                <!-- 3. Career -->
                <button onclick="requestAnalysis(this, 'career')"
                    class="glass-card p-6 text-left hover:bg-white/10 transition group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-briefcase text-6xl"></i>
                    </div>
                    <div class="relative z-10">
                        <h3 class="text-xl font-bold text-blue-400 mb-2"><i class="fa-solid fa-briefcase mr-2"></i>ì§ì—…ê³¼
                            ì ì„±</h3>
                        <p class="text-gray-400 text-sm">ë‚˜ì—ê²Œ ë”± ë§ëŠ” ì§ì—…ê³¼<br>ì¼í•˜ëŠ” ë°©ì‹.</p>
                    </div>
                </button>

                <!-- 4. Compatibility -->
                <button onclick="requestAnalysis(this, 'compatibility')"
                    class="glass-card p-6 text-left hover:bg-white/10 transition group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-heart text-6xl"></i>
                    </div>
                    <div class="relative z-10">
                        <h3 class="text-xl font-bold text-pink-400 mb-2"><i class="fa-solid fa-heart mr-2"></i>ì—°ì• ì™€ ì¸ì—°
                        </h3>
                        <p class="text-gray-400 text-sm">ë‚˜ì˜ ì‚¬ë‘ ìŠ¤íƒ€ì¼ê³¼<br>ì˜ ë§ëŠ” ì¸ì—° ì°¾ê¸°.</p>
                    </div>
                </button>
            </div>

            <!-- Result Area (Appears below grid when clicked) -->
            <div id="resultArea"
                class="hidden glass-card p-8 animate-in fade-in zoom-in duration-300 border-t-4 border-purple-500">
                <div class="flex justify-between items-start mb-6">
                    <h3 id="resultTitle" class="text-2xl font-bold text-white">ë¶„ì„ ê²°ê³¼</h3>
                    <button onclick="closeResult()" class="text-gray-400 hover:text-white">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div id="resultContent" class="markdown-result text-gray-200 leading-relaxed space-y-4">
                    <!-- Markdown content goes here -->
                </div>
            </div>

            <!-- Reset Button -->
            <div class="text-center pt-8">
                <button onclick="resetDashboard()" class="text-gray-500 hover:text-gray-300 text-sm underline">
                    ë‹¤ë¥¸ ì‚¬ì£¼ ë³´ê¸°
                </button>
            </div>
        </div>

    </div>
</div>

<!-- Hidden Elements for Logic -->
<div id="shareDescription" class="hidden"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.6.0/kakao.min.js"></script>
<script>
    // Constants & Global State
    let currentPillars = null;
    let currentUser = { name: '', gender: '', mode: 'general' };
    const KAKAO_KEY = "{{ kakao_js_key }}";

    // Cache for analysis results { 'personality': 'Markdown...', ... }
    const analysisCache = {};

    // Initialize Kakao
    if (KAKAO_KEY) {
        Kakao.init(KAKAO_KEY);
    }

    // --- Mode Switching ---
    function switchInputMode(mode) {
        const modeInput = document.getElementById('serviceMode');
        if (modeInput) modeInput.value = mode;

        const tabGen = document.getElementById('tabGeneral');
        const tabTea = document.getElementById('tabTeacher');

        // Base classes
        const baseClass = "flex-1 py-3 rounded-2xl font-bold transition-all flex flex-col items-center gap-1 group backdrop-blur-md";
        const activeClass = "text-white bg-white/20 hover:bg-white/30 ring-2 ring-white/50 shadow-lg";
        const inactiveClass = "text-purple-200 bg-white/5 hover:bg-white/10 ring-1 ring-white/10";

        if (mode === 'teacher') {
            tabGen.className = `${baseClass} ${inactiveClass}`;
            tabTea.className = `${baseClass} ${activeClass}`;
            document.getElementById('formTitle').textContent = "êµì§ ìš´ì„¸ ëª…í•¨ ë§Œë“¤ê¸°";
            document.getElementById('formSubtitle').textContent = "ì„ ìƒë‹˜ì„ ìœ„í•œ íŠ¹ë³„í•œ ì‚¬ì£¼ ë¶„ì„ê³¼ ëª…í•¨ì„ ì œê³µí•©ë‹ˆë‹¤.";
        } else {
            tabGen.className = `${baseClass} ${activeClass}`;
            tabTea.className = `${baseClass} ${inactiveClass}`;
            document.getElementById('formTitle').textContent = "ë‚˜ì˜ ì‚¬ì£¼ ëª…í•¨ ë§Œë“¤ê¸°";
            document.getElementById('formSubtitle').textContent = "ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ë©´ í‰ìƒ ë³€ì¹˜ ì•ŠëŠ” ì‚¬ì£¼ë¥¼ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.";
        }
    }

    // --- Step 1: Calculate Pillars (Backend API) ---
    async function handleCalculate(event) {
        event.preventDefault();
        const btn = document.getElementById('calculateBtn');
        const form = event.target;

        // Safety: Prevent Double Click
        if (btn.classList.contains('btn-loading')) return;

        try {
            // UI Loading State
            btn.classList.add('btn-loading');
            btn.textContent = 'ìš´ëª…ì˜ ë³„ì„ ì½ëŠ” ì¤‘...';

            // Gather Data
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Call API
            const response = await fetch('/fortune/api/v2/calculate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
                throw new Error(result.error || 'ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            // Success: Update State & UI
            currentPillars = result.pillars;
            currentUser = { name: data.name, gender: data.gender, mode: data.mode };

            renderHeroCard(result);

            // Transition UI
            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');

            // Save to LocalStorage for persistence check (optional)
            localStorage.setItem('saju_dashboard_cache', JSON.stringify({
                pillars: result.pillars,
                user: currentUser,
                timestamp: Date.now()
            }));

        } catch (e) {
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
        } finally {
            btn.classList.remove('btn-loading');
            btn.textContent = 'ì‚¬ì£¼ ëª…í•¨ ë°œê¸‰ë°›ê¸° âœ¨';
        }
    }

    // --- Step 2: Render Hero Card ---
    function renderHeroCard(data) {
        const p = data.pillars;
        const dm = data.day_master;

        // Helper to create Pillar HTML
        const createPillarHTML = (colData) => `
            <div class="text-3xl md:text-5xl font-bold pillar-char text-${colData.stem.element}">${colData.stem.char}</div>
            <div class="text-3xl md:text-5xl font-bold pillar-char text-${colData.branch.element}">${colData.branch.char}</div>
        `;

        document.getElementById('colYear').innerHTML = createPillarHTML(p.year);
        document.getElementById('colMonth').innerHTML = createPillarHTML(p.month);
        document.getElementById('colDay').innerHTML = createPillarHTML(p.day);
        document.getElementById('colHour').innerHTML = createPillarHTML(p.hour);

        // Day Master Detailed Label
        const dmLabels = {
            'ç”²': 'ê°‘ëª© (ê³§ê²Œ ë»—ì€ ê±°ëª©)', 'ä¹™': 'ì„ëª© (ìœ ì—°í•œ ë„ì¿¨í’€)',
            'ä¸™': 'ë³‘í™” (ê°•ë ¬í•œ íƒœì–‘)', 'ä¸': 'ì •í™” (ë”°ëœ»í•œ ë“±ë¶ˆ)',
            'æˆŠ': 'ë¬´í†  (ê´‘í™œí•œ ëŒ€ì§€)', 'å·±': 'ê¸°í†  (ë¹„ì˜¥í•œ ë…¼ë°­)',
            'åºš': 'ê²½ê¸ˆ (ë‹¨ë‹¨í•œ ì›ì„)', 'è¾›': 'ì‹ ê¸ˆ (ì •êµí•œ ë³´ì„)',
            'å£¬': 'ì„ìˆ˜ (ê¹Šì€ ë°”ë‹¤/í˜¸ìˆ˜)', 'ç™¸': 'ê³„ìˆ˜ (ë§‘ì€ ì´ìŠ¬ë¹„)'
        };

        const iconMap = {
            'wood': 'ğŸŒ²', 'fire': 'ğŸ”¥', 'earth': 'â›°ï¸', 'metal': 'ğŸ’', 'water': 'ğŸ’§'
        };

        document.getElementById('dayMasterIcon').textContent = iconMap[dm.element] || 'ğŸ”®';
        const fullDmLabel = dmLabels[dm.char] || `${dm.char}ì˜ ê¸°ìš´`;
        document.getElementById('dayMasterLabel').textContent = fullDmLabel;

        // Summary Text
        document.getElementById('userNameDisplay').textContent = `${currentUser.name}ë‹˜`;
        const summary = `ë‹¹ì‹ ì€ ${fullDmLabel.split(' ')[1]}ì˜ ê¸°ì§ˆì„ íƒ€ê³ ë‚œ ë¶„ì…ë‹ˆë‹¤.`;
        document.getElementById('userSummary').textContent = summary;
        document.getElementById('shareDescription').textContent = `${currentUser.name}ë‹˜: ${fullDmLabel}`;

        // Element Distribution Visualization
        renderElementGraph(data.element_counts);
    }

    function renderElementGraph(counts) {
        const bar = document.getElementById('elementBar');
        const countsDiv = document.getElementById('elementCounts');

        const colors = {
            wood: '#4ADE80', fire: '#F87171', earth: '#FBBF24', metal: '#E2E8F0', water: '#60A5FA'
        };
        const labels = {
            wood: 'ëª©', fire: 'í™”', earth: 'í† ', metal: 'ê¸ˆ', water: 'ìˆ˜'
        };

        bar.innerHTML = '';
        countsDiv.innerHTML = '';

        Object.entries(counts).forEach(([el, count]) => {
            if (count > 0) {
                const segment = document.createElement('div');
                segment.style.width = `${(count / 8) * 100}%`;
                segment.style.backgroundColor = colors[el];
                bar.appendChild(segment);
            }

            const labelSpan = document.createElement('span');
            labelSpan.innerHTML = `<span style="color:${colors[el]}">${labels[el]}</span> ${count}`;
            countsDiv.appendChild(labelSpan);
        });
    }

    function translateElement(el) {
        const map = { 'wood': 'ëª©(æœ¨)', 'fire': 'í™”(ç«)', 'earth': 'í† (åœŸ)', 'metal': 'ê¸ˆ(é‡‘)', 'water': 'ìˆ˜(æ°´)' };
        return map[el] || 'ë¯¸ì§€';
    }

    // --- Step 3: Request AI Analysis ---
    async function requestAnalysis(btn, topic) {
        // Safety: Check if already loading
        if (btn.disabled) return;

        const resultContent = document.getElementById('resultContent');
        const resultArea = document.getElementById('resultArea');
        const originalIcon = btn.querySelector('.fa-solid').className; // Backup icon

        try {
            // Check Cache
            if (analysisCache[topic]) {
                showResult(topic, analysisCache[topic]);
                return;
            }

            // UI Loading
            btn.disabled = true;
            btn.classList.add('opacity-70');
            const iconEl = btn.querySelector('i.mb-2') || btn.querySelector('i'); // Adjust selector as needed
            // Simple spinner inside button
            // Actually, let's just create a toast or change cursor. 
            // For better UX, let's open the output area with a loader.

            resultArea.classList.remove('hidden');
            resultContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12">
                    <div class="text-4xl animate-bounce mb-4">ğŸ”®</div>
                    <p class="text-purple-300">ìš´ëª…ì˜ ë©”ì‹œì§€ë¥¼ í•´ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            `;
            // Scroll to result
            resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Call API
            const response = await fetch('/fortune/api/v2/analyze/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    pillars: currentPillars,
                    topic: topic,
                    name: currentUser.name,
                    gender: currentUser.gender
                })
            });

            const result = await response.json();

            if (!result.success) throw new Error(result.error);

            // Cache & Show
            analysisCache[topic] = result.result;
            showResult(topic, result.result);

        } catch (e) {
            alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
            resultArea.classList.add('hidden'); // Hide if error
        } finally {
            btn.disabled = false;
            btn.classList.remove('opacity-70');
        }
    }

    function showResult(topic, markdownText) {
        const titleMap = {
            'teacher': 'ğŸ‘¨â€ğŸ« êµì§ ìš´ì„¸ ë° í•™êµ ìƒí™œ',
            'personality': 'íƒ€ê³ ë‚œ ê¸°ì§ˆ ë¶„ì„',
            'wealth': 'ì¬ë¬¼ìš´ ì‹¬ì¸µ ë¶„ì„',
            'career': 'ì§ì—…ê³¼ ì ì„± ë¶„ì„',
            'compatibility': 'ì—°ì• ì™€ ì¸ì—° ë¶„ì„'
        };

        document.getElementById('resultTitle').textContent = titleMap[topic] || 'ë¶„ì„ ê²°ê³¼';
        document.getElementById('resultContent').innerHTML = marked.parse(markdownText);

        const resultArea = document.getElementById('resultArea');
        resultArea.classList.remove('hidden');
        resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function closeResult() {
        document.getElementById('resultArea').classList.add('hidden');
    }

    function resetDashboard() {
        if (confirm('ìƒˆë¡œìš´ ì‚¬ì£¼ë¥¼ ì…ë ¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.location.reload();
        }
    }

    // --- Sharing Logic ---
    function shareToKakao() {
        const desc = document.getElementById('shareDescription').textContent;
        // Construct Link
        const link = window.location.href;

        Kakao.Share.sendDefault({
            objectType: 'feed',
            content: {
                title: 'ğŸ”® ë‚˜ì˜ ì‚¬ì£¼ ëª…í•¨',
                description: desc,
                imageUrl: 'https://eduitit.up.railway.app/static/images/saju_og_thumb.png', // Replace with generic or dynamic
                link: {
                    mobileWebUrl: link,
                    webUrl: link,
                },
            },
            buttons: [
                {
                    title: 'ë‚˜ë„ í™•ì¸í•˜ê¸°',
                    link: {
                        mobileWebUrl: link,
                        webUrl: link,
                    },
                },
            ],
        });
    }

    async function saveAsImage() {
        const card = document.getElementById('sajuCard');
        if (!card) return;

        try {
            const canvas = await html2canvas(card, {
                scale: 2,
                backgroundColor: null, // Transparent bg if possible, or force dark
                ignoreElements: (el) => el.tagName === 'BUTTON' // Hide buttons
            });

            const link = document.createElement('a');
            link.download = `saju_card_${currentUser.name}.png`;
            link.href = canvas.toDataURL();
            link.click();
        } catch (e) {
            console.error('Image save failed:', e);
            alert('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>
{% endblock %}