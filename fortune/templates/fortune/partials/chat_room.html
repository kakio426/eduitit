<div class="flex-1 flex flex-col h-full relative animate-in fade-in zoom-in duration-300" id="chat-room">
    <!-- Messages Scroll Area -->
    <div id="chat-messages-container" class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth">
        <!-- System Greeting -->
        <div class="flex flex-col space-y-2 fade-in slide-in-from-left-4 duration-500">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-indigo-600 flex items-center justify-center text-white text-lg shadow-lg shrink-0 border border-white/20">
                    ğŸ§™â€â™‚ï¸
                </div>
                <div class="glass-card p-4 max-w-[85%] rounded-tl-none text-gray-100 leading-relaxed shadow-lg backdrop-blur-md bg-white/5 border-l-4 border-l-purple-500">
                    <p class="font-bold text-purple-300 mb-1 text-sm">ì‚¬ì£¼ ì„ ìƒë‹˜</p>
                    <p>ì•ˆë…•í•˜ì„¸ìš”, <strong>{{ session.profile.person_name }}</strong>ë‹˜. <br>
                    ì˜¤ëŠ˜ì˜ ìš´ì„¸ì™€ ê³ ë¯¼ì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”.</p>
                    <p class="text-xs text-gray-400 mt-2 border-t border-white/10 pt-2">
                        ë‚¨ì€ ì§ˆë¬¸ íšŸìˆ˜: <span class="text-yellow-400 font-bold">{{ session.remaining_turns }}</span>íšŒ
                    </p>
                </div>
            </div>
        </div>

        <!-- History -->
        {% for message in session.messages.all %}
            {% include "fortune/partials/chat_message.html" %}
        {% endfor %}
        
        <!-- Live Messages Target -->
        <div id="new-messages"></div>
        
        <!-- Loading Indicator (Hidden by default, shown by HTMX) -->
        <div id="loading-indicator" class="htmx-indicator flex flex-col space-y-2">
            <div class="flex items-start gap-3">
                 <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-indigo-600 flex items-center justify-center text-white text-lg shadow-lg shrink-0 border border-white/20 animate-pulse">
                    ğŸ§™â€â™‚ï¸
                </div>
                <div class="glass-card p-4 rounded-tl-none bg-white/5 text-gray-300 flex items-center gap-2">
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-100"></span>
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-200"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="p-4 glass-card rounded-t-none border-t border-white/10 shrink-0 bg-black/20 backdrop-blur-xl">
        <div class="flex justify-between items-center mb-2 px-1">
            <span class="text-xs text-gray-400">{{ session.profile.person_name }}ë‹˜ê³¼ ìƒë‹´ ì¤‘</span>
            <span class="text-xs text-gray-400">ë‚¨ì€ ì§ˆë¬¸: <span class="text-yellow-400 font-bold" id="turnCounter">{{ session.remaining_turns }}</span>íšŒ</span>
        </div>
        <form hx-post="{% url 'fortune:send_chat_message' %}"
              hx-target="#new-messages"
              hx-swap="beforeend"
              hx-indicator="#loading-indicator"
              hx-on::after-request="this.reset(); document.getElementById('chat-messages-container').scrollTop = document.getElementById('chat-messages-container').scrollHeight; var c=document.getElementById('turnCounter'); if(c){var n=parseInt(c.textContent)-1; c.textContent=Math.max(0,n)}">
            {% csrf_token %}
            <input type="hidden" name="session_id" value="{{ session.id }}">
            
            <div class="flex gap-2 relative">
                <input type="text" name="message" 
                       class="glass-input flex-1 px-5 py-4 rounded-2xl focus:ring-2 focus:ring-purple-500 placeholder-white/30 text-white text-lg shadow-inner"
                       placeholder="ê¶ê¸ˆí•œ ì ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”..." 
                       autocomplete="off" required>
                       
                <button type="submit" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white px-6 rounded-2xl font-bold transition flex items-center justify-center shadow-lg shadow-purple-500/30 group w-16 md:w-auto">
                    <span class="hidden md:inline mr-2">ì „ì†¡</span>
                    <i class="fa-solid fa-paper-plane group-hover:-translate-y-1 group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
        </form>
    </div>
</div>
