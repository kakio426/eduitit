{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* ê²°ê³¼ ë°•ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
    [data-aos] {
        pointer-events: none;
    }

    [data-aos].aos-animate {
        pointer-events: auto;
    }

    /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
    .markdown-body {
        font-family: 'NanumSquareRound', sans-serif;
        font-size: 1.05rem;
        line-height: 1.7;
        color: #4a5568;
        word-break: keep-all;
        overflow-wrap: break-word;
        white-space: pre-wrap;
        /* ì¤„ë°”ê¿ˆ ë³´ì¡´ */
    }

    .markdown-body table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
        display: block;
        overflow-x: auto;
    }

    .markdown-body th,
    .markdown-body td {
        border: 1px solid #e2e8f0;
        padding: 0.75rem;
        text-align: left;
    }

    .markdown-body th {
        background-color: #f7fafc;
        font-weight: bold;
    }

    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3 {
        color: #2d3748;
        font-weight: bold;
        margin-top: 2rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid #edf2f7;
        padding-bottom: 0.5rem;
    }

    .markdown-body h1 {
        font-size: 1.75rem;
    }

    .markdown-body h2 {
        font-size: 1.5rem;
    }

    .markdown-body h3 {
        font-size: 1.25rem;
    }

    .markdown-body p {
        margin-bottom: 1.5rem;
        white-space: pre-wrap;
        /* ì¤„ë°”ê¿ˆ ë³´ì¡´ */
    }

    .markdown-body ul,
    .markdown-body ol {
        margin-bottom: 1.5rem;
        padding-left: 2rem;
    }

    .markdown-body li {
        margin-bottom: 0.5rem;
    }

    .markdown-body blockquote {
        border-left: 6px solid #a78bfa;
        background: #f3f4f6;
        padding: 1rem 1.5rem;
        border-radius: 0 16px 16px 0;
        margin: 1.5rem 0;
        font-style: italic;
    }

    .markdown-body strong {
        color: #7c3aed;
        background: linear-gradient(120deg, rgba(167, 139, 250, 0.2) 0%, rgba(167, 139, 250, 0.2) 100%);
        background-repeat: no-repeat;
        background-size: 100% 40%;
        background-position: 0 80%;
    }

    /* ì˜¤í–‰ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
    .element-badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 18px;
        border-radius: 100px;
        font-size: 1.1rem;
        font-weight: 800;
        color: white;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .element-badge.wood {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .element-badge.fire {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .element-badge.earth {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .element-badge.metal {
        background: linear-gradient(135deg, #94a3b8, #64748b);
    }

    .element-badge.water {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .element-icon {
        font-size: 2rem;
    }

    /* ========================================
       ê³µìœ  ë²„íŠ¼ ìŠ¤íƒ€ì¼
       ======================================== */
    .share-section {
        margin-top: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 24px;
        border: 2px solid #e2e8f0;
    }

    .share-title {
        font-size: 1.1rem;
        font-weight: 800;
        color: #64748b;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .share-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .share-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 14px 24px;
        border-radius: 16px;
        font-size: 1.4rem;
        font-weight: bold;
        border: none;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        text-decoration: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .share-btn:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }

    .share-btn:active {
        transform: translateY(0) scale(0.98);
    }

    .share-btn.kakao {
        background: #FEE500;
        color: #3C1E1E;
    }

    .share-btn.link {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
    }

    .share-btn.image {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        color: white;
    }

    /* ========================================
       ê³µìœ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ì´ë¯¸ì§€ ì €ì¥ìš©)
       ======================================== */
    .share-card {
        position: fixed;
        left: -9999px;
        width: 600px;
        padding: 40px;
        background: linear-gradient(145deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        border-radius: 32px;
        color: white;
        font-family: 'NanumSquareRound', sans-serif;
    }

    .share-card-inner {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 32px;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .share-card-header {
        text-align: center;
        margin-bottom: 24px;
    }

    .share-card-title {
        font-size: 2.8rem;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .share-card-element {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 100px;
        font-size: 2rem;
        font-weight: bold;
        margin: 16px 0;
    }

    .share-card-element .icon {
        font-size: 2.4rem;
    }

    .share-card-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
    }

    .share-card-keyword {
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 100px;
        font-size: 1.6rem;
    }

    .share-card-fortune {
        text-align: center;
        padding: 16px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        margin: 16px 0;
    }

    .share-card-fortune-label {
        font-size: 1.4rem;
        opacity: 0.9;
        margin-bottom: 8px;
    }

    .share-card-fortune-value {
        font-size: 1.8rem;
        font-weight: bold;
    }

    .share-card-footer {
        text-align: center;
        margin-top: 24px;
        font-size: 1.4rem;
        opacity: 0.8;
    }

    .share-card-footer .logo {
        font-size: 1.8rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    /* ========================================
       í¼ ìŠ¤íƒ€ì¼ë§ (í°íŠ¸ ì¦ê°€)
       ======================================== */
    .saju-input {
        width: 100%;
        padding: 1.2rem 1.5rem;
        background: #E0E5EC;
        border: none;
        border-radius: 18px;
        box-shadow: inset 6px 6px 10px 0 rgba(163, 177, 198, 0.7),
            inset -6px -6px 10px 0 rgba(255, 255, 255, 0.8);
        color: #4A5568;
        font-family: inherit;
        font-size: 1.6rem;
        transition: all 0.3s;
    }

    .saju-input:focus {
        outline: none;
        box-shadow: inset 8px 8px 12px 0 rgba(163, 177, 198, 0.8),
            inset -8px -8px 12px 0 rgba(255, 255, 255, 0.9);
    }

    .saju-input::placeholder {
        color: #a0aec0;
    }

    /* ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .radio-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .radio-group label {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.9rem 1.5rem;
        background: #E0E5EC;
        border-radius: 14px;
        box-shadow: 5px 5px 10px rgba(163, 177, 198, 0.5),
            -5px -5px 10px rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1.5rem;
    }

    .radio-group label:hover {
        transform: translateY(-2px);
    }

    .radio-group input[type="radio"] {
        width: 22px;
        height: 22px;
        accent-color: #7c3aed;
    }

    .radio-group input[type="radio"]:checked+span {
        color: #7c3aed;
        font-weight: bold;
    }

    /* ëª¨ë“œ í† ê¸€ ìŠ¤íƒ€ì¼ */
    .mode-toggle {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .mode-btn {
        flex: 1;
        padding: 1.5rem;
        background: #E0E5EC;
        border: none;
        border-radius: 22px;
        box-shadow: 7px 7px 14px rgba(163, 177, 198, 0.6),
            -7px -7px 14px rgba(255, 255, 255, 0.5);
        font-size: 1.6rem;
        font-weight: bold;
        color: #4A5568;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .mode-btn.active {
        background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%);
        color: white;
        box-shadow: inset 4px 4px 8px rgba(0, 0, 0, 0.1);
    }

    .mode-btn:not(.active):hover {
        transform: translateY(-2px);
        box-shadow: 9px 9px 18px rgba(163, 177, 198, 0.7),
            -9px -9px 18px rgba(255, 255, 255, 0.6);
    }

    .mode-btn span {
        display: block;
        font-size: 1.2rem;
        font-weight: normal;
        margin-top: 6px;
        opacity: 0.85;
    }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    .loading-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(224, 229, 236, 0.95);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 1.5rem;
    }

    .loading-overlay.show {
        display: flex;
    }

    .loading-spinner {
        width: 70px;
        height: 70px;
        border: 6px solid #e9d5ff;
        border-top: 6px solid #7c3aed;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .loading-text {
        font-size: 2rem;
        color: #7c3aed;
        text-align: center;
    }

    /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ê°œì„  */
    .toast {
        position: fixed;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: rgba(31, 41, 55, 0.95);
        /* ì„¸ë ¨ëœ ë‹¤í¬ ê·¸ë ˆì´ */
        backdrop-filter: blur(8px);
        color: white;
        padding: 14px 28px;
        border-radius: 20px;
        font-size: 1.2rem;
        font-weight: 600;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 9999;
        width: calc(100% - 40px);
        max-width: 450px;
        text-align: center;
        word-break: keep-all;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    /* í† ìŠ¤íŠ¸ ìƒ‰ìƒ í…Œë§ˆ */
    .toast.success {
        background: linear-gradient(135deg, #059669, #10b981);
    }

    .toast.error {
        background: linear-gradient(135deg, #dc2626, #ef4444);
    }

    .toast.info {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
    }

    /* ========================================
       í”„ë¡œí•„ ì¹´ë“œ ìŠ¤íƒ€ì¼
       ======================================== */
    .profile-card {
        min-width: 280px;
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .profile-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        border-color: rgba(139, 92, 246, 0.3);
    }

    .profile-card.default {
        border-color: #8b5cf6;
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
    }

    .profile-card-header {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }

    .profile-icon {
        width: 3.5rem;
        height: 3.5rem;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        flex-shrink: 0;
    }

    .profile-info {
        flex: 1;
    }

    .profile-label {
        font-size: 0.85rem;
        color: #8b5cf6;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .profile-name {
        font-size: 1.5rem;
        font-weight: 900;
        color: #1e293b;
        margin: 0.25rem 0;
    }

    .profile-date {
        font-size: 0.95rem;
        color: #64748b;
        font-weight: 600;
    }

    .default-badge {
        position: absolute;
        top: 0;
        right: 0;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 800;
    }

    .profile-card-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .profile-btn {
        padding: 0.75rem 1rem;
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.9rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
    }

    .profile-btn.primary {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
    }

    .profile-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    .profile-btn:not(.primary):not(.danger) {
        background: #f1f5f9;
        color: #64748b;
    }

    .profile-btn:not(.primary):not(.danger):hover {
        background: #e2e8f0;
    }

    .profile-btn.danger {
        background: #fee2e2;
        color: #dc2626;
    }

    .profile-btn.danger:hover {
        background: #fecaca;
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
        .profile-card {
            min-width: 260px;
        }

        #profileCardsContainer {
            -webkit-overflow-scrolling: touch;
        }

        #profileCardsContainer::-webkit-scrollbar {
            height: 4px;
        }

        #profileCardsContainer::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    }

    /* ========================================
       ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ìŠ¤íƒ€ì¼
       ======================================== */
    .favorite-date-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1rem;
        background: white;
        border-radius: 12px;
        border: 2px solid #f1f5f9;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .favorite-date-item:hover {
        border-color: #fbbf24;
        background: #fffbeb;
        transform: translateX(4px);
    }

    .favorite-date-item.past {
        opacity: 0.6;
    }

    .favorite-date-item.past:hover {
        opacity: 0.8;
        border-color: #cbd5e1;
        background: #f8fafc;
    }

    #favoriteDatesContainer::-webkit-scrollbar {
        width: 6px;
    }

    #favoriteDatesContainer::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block content %}
<main class="pt-32 pb-20 px-4 md:px-8 min-h-screen max-w-4xl mx-auto">

    <!-- ë¦¬ë§ˆì¸ë” ì•Œë¦¼ ë°°ë„ˆ -->
    <div id="reminderBanner" class="hidden mb-6 animate-in slide-in-from-top duration-500">
        <div class="clay-card p-6 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div
                        class="w-14 h-14 bg-amber-500 rounded-full flex items-center justify-center text-white text-2xl animate-bounce">
                        <i class="fa-solid fa-bell"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-black text-gray-800">ì˜¤ëŠ˜ì˜ ìš´ì„¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”! âœ¨</h3>
                        <p class="text-gray-600 font-medium">ì–´ì œ ì„¤ì •í•œ ì•Œë¦¼ì…ë‹ˆë‹¤</p>
                    </div>
                </div>
                <button onclick="dismissReminder()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- í—¤ë” -->
    <div class="text-center mb-12" data-aos="fade-down">
        <div class="w-28 h-28 mx-auto mb-6 rounded-full shadow-clay-inner flex items-center justify-center">
            <span class="text-6xl">ğŸ”®</span>
        </div>
        <h1 class="text-5xl md:text-6xl font-bold text-gray-700 mb-4">
            ì‚¬ì£¼ <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-indigo-500">ìš´ì„¸</span>
        </h1>
        <p class="text-xl text-gray-500 font-bold">
            AIê°€ ë¶„ì„í•˜ëŠ” ë‚˜ë§Œì˜ ì‚¬ì£¼íŒ”ìì™€ ìš´ì„¸
        </p>
    </div>

    {% if error %}
    <div class="clay-card p-6 mb-8 border-2 border-red-200 bg-red-50/50" data-aos="fade-up">
        <div class="flex items-start gap-4 text-red-600">
            <i class="fa-solid fa-circle-exclamation text-3xl mt-1"></i>
            <div>
                <h3 class="text-2xl font-bold mb-2">ë¶„ì„ ì¤‘ ì•Œë¦¼</h3>
                <p class="text-lg leading-relaxed">{{ error }}</p>
                {% if user.is_authenticated %}
                <a href="{% url 'settings' %}"
                    class="inline-block mt-4 px-6 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors">
                    ì„¤ì •ì—ì„œ API í‚¤ ë“±ë¡í•˜ê¸°
                </a>
                {% else %}
                <a href="{% url 'account_login' %}"
                    class="inline-block mt-4 px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-slate-800 transition-colors">
                    ë¡œê·¸ì¸/ê°€ì…í•˜ê¸°
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- í”„ë¡œí•„ ê´€ë¦¬ ì„¹ì…˜ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ) -->
    {% if user.is_authenticated %}
    <div id="profileManagerSection" class="mb-8">
        <div class="clay-card p-6 md:p-8" data-aos="fade-up">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-full flex items-center justify-center text-white text-2xl">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-gray-800">ë‚´ í”„ë¡œí•„</h3>
                        <p class="text-gray-600 font-medium text-base">ì—¬ëŸ¬ ì‚¬ëŒì˜ ì‚¬ì£¼ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
                    </div>
                </div>
                <button onclick="showProfileModal()"
                    class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl font-bold text-base hover:shadow-lg transition-all">
                    <i class="fa-solid fa-plus mr-2"></i>í”„ë¡œí•„ ì¶”ê°€
                </button>
            </div>

            <!-- í”„ë¡œí•„ ì¹´ë“œ ëª©ë¡ (ê°€ë¡œ ìŠ¤í¬ë¡¤) -->
            <div id="profileCardsContainer" class="overflow-x-auto pb-4 -mx-4 px-4">
                <div id="profileCards" class="flex gap-4 min-w-max">
                    <!-- í”„ë¡œí•„ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    <div class="text-center text-gray-400 py-8">
                        <i class="fa-solid fa-spinner fa-spin text-3xl mb-2"></i>
                        <p>í”„ë¡œí•„ ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¦ê²¨ì°¾ê¸° ë‚ ì§œ & í†µê³„ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ) -->
    {% if user.is_authenticated %}
    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <!-- ì¦ê²¨ì°¾ê¸° ë‚ ì§œ -->
        <div class="clay-card p-6" data-aos="fade-up">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-black text-gray-800">
                    <i class="fa-solid fa-star text-amber-500 mr-2"></i>
                    ì¦ê²¨ì°¾ê¸° ë‚ ì§œ
                </h3>
                <button onclick="showFavoriteDateModal()" class="text-amber-500 hover:text-amber-600">
                    <i class="fa-solid fa-plus text-2xl"></i>
                </button>
            </div>
            <div id="favoriteDatesContainer" class="space-y-2 max-h-60 overflow-y-auto">
                <p class="text-gray-400 text-center py-4">ë¡œë”© ì¤‘...</p>
            </div>
        </div>

        <!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
        <div class="clay-card p-6" data-aos="fade-up" data-aos-delay="100">
            <h3 class="text-xl font-black text-gray-800 mb-4">
                <i class="fa-solid fa-chart-line text-indigo-500 mr-2"></i>
                í™œë™ í†µê³„
            </h3>
            <div id="statisticsContainer" class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-indigo-50 rounded-xl">
                    <span class="text-gray-700 font-bold">ì´ ì‚¬ì£¼ ë¶„ì„</span>
                    <span id="statTotalAnalyses" class="text-2xl font-black text-indigo-600">-</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-purple-50 rounded-xl">
                    <span class="text-gray-700 font-bold">ì¼ì§„ ì¡°íšŒ</span>
                    <span id="statTotalDaily" class="text-2xl font-black text-purple-600">-</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-green-50 rounded-xl">
                    <span class="text-gray-700 font-bold">ìµœê·¼ 7ì¼ í™œë™</span>
                    <span id="statRecentActivity" class="text-2xl font-black text-green-600">-</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %} <!-- 742ë²ˆ ë¼ì¸ì˜ í”„ë¡œí•„ ê´€ë¦¬ ì„¹ì…˜ if ë‹«ê¸° -->

    <!-- ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ ì‚¬ì£¼ ì¹´ë“œ (ë¹ ë¥¸ ì ‘ê·¼) -->
    <div id="quickAccessContainer" class="hidden mb-8">
        <div class="clay-card p-8 md:p-10 bg-gradient-to-br from-purple-50/80 to-indigo-50/80 border-2 border-purple-200"
            data-aos="fade-up">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-16 h-16 bg-purple-600/10 rounded-full flex items-center justify-center text-4xl"
                    id="quickAccessIcon">
                    ğŸ”®
                </div>
                <div>
                    <h3 class="text-2xl font-black text-gray-800">ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ ì‚¬ì£¼</h3>
                    <p class="text-gray-600 font-medium">ì €ì¥ëœ ì •ë³´ë¡œ ë¹ ë¥´ê²Œ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”</p>
                </div>
            </div>

            <div class="bg-white/70 rounded-2xl p-6 mb-6">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">ì´ë¦„</div>
                        <div class="text-xl font-bold text-gray-800" id="quickAccessName">-</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">ì„±ë³„</div>
                        <div class="text-xl font-bold text-gray-800" id="quickAccessGender">-</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">ìƒë…„ì›”ì¼</div>
                        <div class="text-xl font-bold text-gray-800" id="quickAccessBirthDate">-</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">ìƒë‹´ ëª¨ë“œ</div>
                        <div class="text-xl font-bold text-gray-800" id="quickAccessMode">-</div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4">
                <button onclick="useLastSajuInfo()" class="flex-1 py-5 rounded-2xl text-white font-bold text-2xl transition-all
                    bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600
                    shadow-lg hover:shadow-xl hover:-translate-y-1">
                    <i class="fa-solid fa-bolt mr-2"></i>ì´ ì •ë³´ë¡œ ë‹¤ì‹œ ë³´ê¸°
                </button>
                <button onclick="showNewSajuForm()" class="flex-1 py-5 rounded-2xl font-bold text-2xl transition-all
                    bg-white text-gray-700 border-2 border-gray-300
                    hover:border-purple-400 hover:text-purple-600 hover:-translate-y-1">
                    <i class="fa-solid fa-user-plus mr-2"></i>ìƒˆë¡œìš´ ì‚¬ì£¼ ì…ë ¥
                </button>
            </div>
        </div>
    </div>

    <!-- ì…ë ¥ í¼ ì„¹ì…˜ -->
    <div id="formContainer" class="{% if result %}hidden{% endif %}">

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="flex justify-center mb-8 gap-4 px-4 relative z-20">
            <button type="button" onclick="switchMode('general')" id="tabGeneral"
                class="flex-1 max-w-[160px] py-4 rounded-2xl font-bold transition-all text-white bg-white/20 hover:bg-white/30 ring-2 ring-white/50 shadow-lg backdrop-blur-md flex flex-col items-center gap-1">
                <span class="text-2xl">ğŸ™‚</span>
                <span class="text-sm">ì¼ë°˜ ì‚¬ì£¼</span>
            </button>
            <button type="button" onclick="switchMode('teacher')" id="tabTeacher"
                class="flex-1 max-w-[160px] py-4 rounded-2xl font-bold transition-all text-purple-200 bg-white/5 hover:bg-white/10 ring-1 ring-white/10 backdrop-blur-md flex flex-col items-center gap-1">
                <span class="text-2xl">ğŸ‘¨â€ğŸ«</span>
                <span class="text-sm">êµì§ ìš´ì„¸</span>
            </button>
        </div>

        <div class="glass-card p-8 md:p-12 transform hover:scale-[1.01] transition-all duration-300 relative overflow-hidden"
            style="backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);">

            <h2 class="text-3xl font-bold text-center text-white mb-2" id="formTitle">
                ë‚˜ì˜ ì‚¬ì£¼ ëª…í•¨ ë§Œë“¤ê¸°
            </h2>
            <p class="text-center text-purple-200 mb-8 font-medium" id="formSubtitle">
                ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ë©´ í‰ìƒ ë³€ì¹˜ ì•ŠëŠ” ì‚¬ì£¼ë¥¼ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.
            </p>

            <form onsubmit="calculateSaju(event)" id="sajuForm" class="relative z-10">
                {% csrf_token %}
                <input type="hidden" name="mode" id="serviceMode" value="general">

                <!-- ì´ë¦„ -->
                <div class="mb-6">
                    <label for="id_name" class="block text-xl font-bold text-purple-100 mb-2">
                        ì´ë¦„
                    </label>
                    <input type="text" name="name" id="id_name"
                        class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-purple-200/50 text-lg focus:outline-none focus:ring-2 focus:ring-purple-400 focus:bg-white/20 transition-all"
                        placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required maxlength="20">
                </div>

                <!-- ì„±ë³„ -->
                <div class="mb-6">
                    <label class="block text-xl font-bold text-purple-100 mb-2">
                        ì„±ë³„
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="cursor-pointer">
                            <input type="radio" name="gender" value="male" class="peer sr-only" required>
                            <div
                                class="p-4 rounded-xl bg-white/5 border border-white/10 text-center text-purple-200 peer-checked:bg-indigo-500 peer-checked:text-white peer-checked:border-transparent transition-all hover:bg-white/10">
                                ë‚¨ì„±
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="gender" value="female" class="peer sr-only">
                            <div
                                class="p-4 rounded-xl bg-white/5 border border-white/10 text-center text-purple-200 peer-checked:bg-pink-500 peer-checked:text-white peer-checked:border-transparent transition-all hover:bg-white/10">
                                ì—¬ì„±
                            </div>
                        </label>
                    </div>
                </div>

                <!-- ìƒë…„ì›”ì¼ -->
                <div class="mb-6">
                    <label class="block text-xl font-bold text-purple-100 mb-2">
                        ì–‘ë ¥ ìƒë…„ì›”ì¼
                    </label>
                    <div class="grid grid-cols-3 gap-3">
                        <input type="number" name="birth_year"
                            class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-purple-200/50 text-center text-lg focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all"
                            placeholder="ë…„(YYYY)" required min="1900" max="2026">
                        <input type="number" name="birth_month"
                            class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-purple-200/50 text-center text-lg focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all"
                            placeholder="ì›”" required min="1" max="12">
                        <input type="number" name="birth_day"
                            class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-purple-200/50 text-center text-lg focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all"
                            placeholder="ì¼" required min="1" max="31">
                    </div>
                </div>

                <!-- íƒœì–´ë‚œ ì‹œê°„ -->
                <div class="mb-8">
                    <label class="block text-xl font-bold text-purple-100 mb-2">
                        íƒœì–´ë‚œ ì‹œê°„ (ì„ íƒ)
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" name="birth_hour"
                            class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-purple-200/50 text-center text-lg focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all"
                            placeholder="ì‹œ (0~23)" min="0" max="23">
                        <input type="number" name="birth_minute"
                            class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-purple-200/50 text-center text-lg focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all"
                            placeholder="ë¶„ (0~59)" min="0" max="59">
                    </div>
                    <p class="text-xs text-purple-300 mt-2 ml-1">* ì‹œê°„ì„ ëª¨ë¥´ë©´ ë¹„ì›Œë‘ì„¸ìš” (ì‚¼ì£¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤)</p>
                </div>

                <input type="hidden" name="calendar_type" value="solar">

                <!-- ì œì¶œ ë²„íŠ¼ -->
                <button type="submit"
                    class="w-full py-5 rounded-2xl text-white font-bold text-xl transition-all
                bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500
                shadow-lg hover:shadow-indigo-500/30 transform hover:-translate-y-1 border border-white/10 relative overflow-hidden group">
                    <span class="relative z-10 flex items-center justify-center gap-2">
                        ì‚¬ì£¼ ëª…í•¨ ë°œê¸‰ë°›ê¸° âœ¨
                    </span>
                    <div
                        class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                    </div>
                </button>
            </form>
        </div>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ ì„¹ì…˜ -->
    <div id="resultContainer" class="{% if not result %}hidden{% endif %}">
        <div class="clay-card p-8 md:p-12" data-aos="fade-up" id="resultCard">

            <!-- ì˜¤í–‰ ë°°ì§€ (JavaScriptë¡œ ë™ì  ìƒì„±) -->
            <div id="elementBadge" class="text-center mb-6"></div>

            <!-- ë§ˆí¬ë‹¤ìš´ ê²°ê³¼ -->
            <div class="markdown-body" id="markdownResult">
                {% if result %}{{ result|safe }}{% endif %}
            </div>

            <!-- ê³µìœ  ì„¹ì…˜ (JSë¡œ ì œì–´í•˜ê±°ë‚˜ í•­ìƒ í‘œì‹œ) -->
            <div id="shareSection" class="share-section {% if not result %}hidden{% endif %}">
                <div class="share-title">
                    <i class="fa-solid fa-share-nodes"></i>
                    ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ê¸°
                </div>
                <div class="share-buttons">
                    <button class="share-btn kakao" onclick="shareToKakao()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 3C6.48 3 2 6.48 2 10.5c0 2.53 1.67 4.75 4.17 6.02-.18.65-.66 2.35-.75 2.72-.12.47.17.46.36.34.15-.1 2.38-1.61 3.35-2.27.62.09 1.24.14 1.87.14 5.52 0 10-3.48 10-7.95S17.52 3 12 3z" />
                        </svg>
                        ì¹´ì¹´ì˜¤í†¡
                    </button>
                    <button class="share-btn link" onclick="copyLink()">
                        <i class="fa-solid fa-link"></i>
                        ë§í¬ ë³µì‚¬
                    </button>
                    <button class="share-btn image" onclick="saveAsImage()">
                        <i class="fa-solid fa-image"></i>
                        ì´ë¯¸ì§€ ì €ì¥
                    </button>
                </div>
            </div>

            <hr class="my-10 border-slate-200 {% if not result %}hidden{% endif %}" id="resultDivider">

            <!-- íŠ¹ì • ë‚ ì§œ ìš´ì„¸ (ì¼ì§„) -->
            <div id="dailyFortuneSection"
                class="bg-indigo-50/50 rounded-3xl p-8 border border-indigo-100 mb-8 {% if not result %}hidden{% endif %}">
                <div class="flex items-center gap-3 mb-6">
                    <div
                        class="w-10 h-10 bg-indigo-600/10 text-indigo-600 rounded-xl flex items-center justify-center text-xl">
                        <i class="fa-solid fa-calendar-check"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-700">ë‚ ì§œë³„ ìš´ì„¸ í™•ì¸</h3>
                        <p class="text-slate-500 font-medium">ì¤‘ìš”í•œ í–‰ì‚¬ë‚˜ ëª¨ì„ì´ ìˆëŠ” ë‚ ì˜ ìš´ì„¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.</p>
                    </div>
                </div>

                <!-- ë¹ ë¥¸ ë‚ ì§œ ì„ íƒ ë²„íŠ¼ -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <button type="button" onclick="setQuickDate(0)"
                        class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-xl font-bold text-base transition-all">
                        ì˜¤ëŠ˜
                    </button>
                    <button type="button" onclick="setQuickDate(1)"
                        class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-xl font-bold text-base transition-all">
                        ë‚´ì¼
                    </button>
                    <button type="button" onclick="setQuickDate(2)"
                        class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-xl font-bold text-base transition-all">
                        ëª¨ë ˆ
                    </button>
                    <button type="button" onclick="setQuickDate('weekend')"
                        class="px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-xl font-bold text-base transition-all">
                        ì´ë²ˆ ì£¼ë§
                    </button>
                </div>

                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <input type="date" id="targetDateInput" value="{% now 'Y-m-d' %}"
                        class="flex-1 w-full bg-white border-2 border-indigo-100 rounded-2xl p-4 text-xl font-bold text-slate-700 focus:outline-none focus:border-indigo-500 transition-all">
                    <button onclick="checkDailyFortune()"
                        class="w-full md:w-auto px-8 py-4 bg-indigo-600 hover:bg-neutral-800 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                        ìš´ì„¸ ë³´ê¸°
                    </button>
                    {% if user.is_authenticated %}
                    <button onclick="addFavoriteDate()" id="favoriteDateBtn"
                        class="w-full md:w-auto px-6 py-4 bg-amber-500 hover:bg-amber-600 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                        <i class="fa-solid fa-star"></i>
                    </button>
                    {% endif %}
                </div>

                <div id="dailyFortuneResult" class="mt-8 hidden animate-in fade-in slide-in-from-top duration-500">
                    <div class="bg-white rounded-2xl p-6 border border-indigo-50 shadow-sm markdown-body"
                        id="dailyFortuneContent">
                        <!-- JS Populated -->
                    </div>
                </div>
            </div>

            <!-- ì €ì¥/ê°€ì… ìœ ë„ ì„¹ì…˜ -->
            <div id="saveSection" class="{% if not result %}hidden{% endif %}">
                {% if user.is_authenticated %}
                <div class="space-y-4">
                    <div class="bg-purple-50/50 rounded-3xl p-8 border border-purple-100">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 bg-purple-600/10 text-purple-600 rounded-2xl flex items-center justify-center text-2xl">
                                    <i class="fa-solid fa-bookmark"></i>
                                </div>
                                <div class="text-left">
                                    <h4 class="text-xl font-black text-slate-700">ì´ ê²°ê³¼ ë³´ê´€í•˜ê¸°</h4>
                                    <p class="text-slate-500 font-medium">ì„ ìƒë‹˜ë§Œì˜ ìš´ì„¸ ë³´ê´€í•¨ì— ì €ì¥í•´ë‘ê³  ì–¸ì œë“  êº¼ë‚´ë³´ì„¸ìš”.</p>
                                </div>
                            </div>
                            <button onclick="saveToLibrary()"
                                class="px-8 py-4 bg-purple-600 hover:bg-neutral-800 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                                ë³´ê´€í•¨ì— ì €ì¥
                            </button>
                        </div>
                    </div>

                    <div class="bg-amber-50/50 rounded-3xl p-8 border border-amber-100">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 bg-amber-600/10 text-amber-600 rounded-2xl flex items-center justify-center text-2xl">
                                    <i class="fa-solid fa-bell"></i>
                                </div>
                                <div class="text-left">
                                    <h4 class="text-xl font-black text-slate-700">ë‚´ì¼ ìš´ì„¸ ì•Œë¦¼ ë°›ê¸°</h4>
                                    <p class="text-slate-500 font-medium">ë‚´ì¼ ë‹¤ì‹œ ë°©ë¬¸í•˜ë©´ ë¦¬ë§ˆì¸ë”ë¥¼ í‘œì‹œí•´ë“œë¦´ê²Œìš”.</p>
                                </div>
                            </div>
                            <button onclick="setTomorrowReminder()"
                                class="px-8 py-4 bg-amber-500 hover:bg-amber-600 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                                ì•Œë¦¼ ì„¤ì •
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="bg-slate-100/50 rounded-3xl p-8 border border-slate-200">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 bg-slate-400 text-white rounded-2xl flex items-center justify-center text-2xl">
                                <i class="fa-solid fa-lock"></i>
                            </div>
                            <div class="text-left">
                                <h4 class="text-xl font-black text-slate-700">ë¶„ì„ ê²°ê³¼ ë³´ê´€ ë° ë¯¸ë˜ ì¼ì§„ í™•ì¸</h4>
                                <p class="text-slate-500 font-medium">íšŒì›ì´ ë˜ì‹œë©´ ë¶„ì„ëœ ì‚¬ì£¼ë¥¼ ì˜êµ¬ ë³´ê´€í•˜ê³  ë‚´ì¼ì˜ ìš´ì„¸ë„ ë¯¸ë¦¬ ë³¼ ìˆ˜ ìˆì–´ìš”. ğŸ˜Š</p>
                            </div>
                        </div>
                        <a href="{% url 'account_signup' %}?next={% url 'fortune:saju' %}"
                            class="px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                            ê°€ì…í•˜ê³  í˜œíƒ ë°›ê¸°
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="mt-10 text-center" id="restartSection">
                <a href="{% url 'fortune:saju' %}" class="inline-block px-12 py-5 rounded-2xl text-white font-bold text-2xl
                    bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600
                    shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">
                    <i class="fa-solid fa-rotate-left mr-2"></i>ë‹¤ì‹œ ë³´ê¸°
                </a>
            </div>
        </div>
    </div>

    <!-- ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="favoriteDateModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4"
        onclick="closeFavoriteDateModalOnBackdrop(event)">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-black text-gray-800">
                    <i class="fa-solid fa-star text-amber-500 mr-2"></i>
                    ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ì¶”ê°€
                </h3>
                <button onclick="closeFavoriteDateModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <form id="favoriteDateForm" class="space-y-4">
                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ë‚ ì§œ</label>
                    <input type="date" id="favoriteDate" class="saju-input" required>
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ë¼ë²¨</label>
                    <input type="text" id="favoriteLabel" class="saju-input" placeholder="ì˜ˆ: ì‹œí—˜ì¼, ìƒì¼, ê¸°ë…ì¼" required
                        maxlength="50">
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ë©”ëª¨ (ì„ íƒ)</label>
                    <textarea id="favoriteMemo" class="saju-input" placeholder="ê°„ë‹¨í•œ ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”" rows="3"></textarea>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeFavoriteDateModal()"
                        class="flex-1 py-4 bg-gray-200 text-gray-700 rounded-2xl font-bold text-lg hover:bg-gray-300 transition">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit"
                        class="flex-1 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl font-bold text-lg hover:shadow-lg transition">
                        ì €ì¥
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- í”„ë¡œí•„ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="profileModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4"
        onclick="closeProfileModalOnBackdrop(event)">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-black text-gray-800">
                    <i class="fa-solid fa-user-plus text-purple-500 mr-2"></i>
                    <span id="modalTitle">í”„ë¡œí•„ ì¶”ê°€</span>
                </h3>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <form id="profileForm" class="space-y-4">
                <input type="hidden" id="profileId" value="">

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">í”„ë¡œí•„ ì´ë¦„</label>
                    <input type="text" id="profileName" class="saju-input" placeholder="ì˜ˆ: ë‚˜, ì—„ë§ˆ, ì¹œêµ¬" required
                        maxlength="20">
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ì‹¤ì œ ì´ë¦„</label>
                    <input type="text" id="personName" class="saju-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required
                        maxlength="20">
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ì„±ë³„</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="profileGender" value="male" required>
                            <span>ë‚¨ì</span>
                        </label>
                        <label>
                            <input type="radio" name="profileGender" value="female">
                            <span>ì—¬ì</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ìƒë…„ì›”ì¼</label>
                    <div class="grid grid-cols-3 gap-3">
                        <input type="number" id="profileBirthYear" class="saju-input" placeholder="ë…„ë„" required
                            min="1940" max="2025">
                        <input type="number" id="profileBirthMonth" class="saju-input" placeholder="ì›”" required min="1"
                            max="12">
                        <input type="number" id="profileBirthDay" class="saju-input" placeholder="ì¼" required min="1"
                            max="31">
                    </div>
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">íƒœì–´ë‚œ ì‹œê°„ (ì„ íƒ)</label>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="profileBirthHour" class="saju-input" placeholder="ì‹œ (0~23)" min="0"
                            max="23">
                        <input type="number" id="profileBirthMinute" class="saju-input" placeholder="ë¶„ (0~59)" min="0"
                            max="59">
                    </div>
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ì–‘ë ¥/ìŒë ¥</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="profileCalendarType" value="solar" checked>
                            <span>ì–‘ë ¥</span>
                        </label>
                        <label>
                            <input type="radio" name="profileCalendarType" value="lunar">
                            <span>ìŒë ¥</span>
                        </label>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeProfileModal()"
                        class="flex-1 py-4 bg-gray-200 text-gray-700 rounded-2xl font-bold text-lg hover:bg-gray-300 transition">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit"
                        class="flex-1 py-4 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-2xl font-bold text-lg hover:shadow-lg transition">
                        ì €ì¥
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ê³µìœ ì¹´ë“œ (ì´ë¯¸ì§€ ì €ì¥ìš©, í™”ë©´ì— ë³´ì´ì§€ ì•ŠìŒ) -->
    <div id="shareCardContainer" class="share-card">
        <div class="share-card-inner">
            <div class="share-card-header">
                <div class="share-card-title" id="shareCardTitle">ğŸ”® ì‚¬ì£¼ ë¶„ì„</div>
                <div class="share-card-element" id="shareCardElement">
                    <span class="icon">âš”ï¸</span>
                    <span id="shareCardElementText">ê²½ê¸ˆ(åºšé‡‘)</span>
                </div>
            </div>
            <div class="share-card-keywords" id="shareCardKeywords">
                <span class="share-card-keyword">"ìƒˆë¡œìš´ ì‹œì‘"</span>
                <span class="share-card-keyword">"ë„ì „"</span>
                <span class="share-card-keyword">"ì„±ì¥"</span>
            </div>
            <div class="share-card-fortune">
                <div class="share-card-fortune-label">ğŸ€ í–‰ìš´ì˜ ìƒ‰</div>
                <div class="share-card-fortune-value" id="shareCardLuckyColor">íŒŒë€ìƒ‰</div>
            </div>
            <div class="share-card-footer">
                <div class="logo">ğŸ”® Eduitit ì‚¬ì£¼ ìš´ì„¸</div>
                <div style="margin-top: 8px; font-size: 1.2rem;">eduitit.up.railway.app</div>
            </div>
        </div>
    </div>

</main>

<!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
<div id="toast" class="toast">
    <i class="fa-solid fa-check-circle mr-2"></i>
    <span id="toastMessage">ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">
        ì‚¬ì£¼ë¥¼ ë¶„ì„í•˜ê³  ìˆì–´ìš”...<br>
        <span class="text-xl opacity-70">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ë§ˆí¬ë‹¤ìš´ íŒŒì„œ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- XSS ë°©ì§€ìš© sanitizer -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<!-- ì´ë¯¸ì§€ ì €ì¥ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!-- ì¹´ì¹´ì˜¤ SDK -->
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.6.0/kakao.min.js"></script>

<script>
    // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
    if ("{{ kakao_js_key }}") {
        Kakao.init("{{ kakao_js_key }}");
        console.log("Kakao SDK Initialized:", Kakao.isInitialized());
    }

    // UI Safe-guard: Ensure form is visible if no result
    document.addEventListener('DOMContentLoaded', () => {
        const resultContainer = document.getElementById('resultContainer');
        const formContainer = document.getElementById('formContainer');
        const hasResult = document.getElementById('markdownResult')?.innerHTML.trim().length > 0;

        if (!hasResult && resultContainer && !resultContainer.classList.contains('hidden')) {
            console.warn('UI State Correction: Hiding empty result, showing form.');
            resultContainer.classList.add('hidden');
            formContainer.classList.remove('hidden');
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì´ì „ ê²°ê³¼ ë³µì› (ê°€ì… í›„ ëŒì•„ì˜¨ ê²½ìš°)
        restorePendingSajuResult();

        // ë§ˆì§€ë§‰ ì‚¬ì£¼ ì •ë³´ ë¡œë“œ ë° ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œ í‘œì‹œ
        loadLastSajuInfo();
    });

    // ë§ˆì§€ë§‰ ì‚¬ì£¼ ì •ë³´ ë¡œë“œ
    function loadLastSajuInfo() {
        const lastSajuInput = localStorage.getItem('lastSajuInput');
        const quickAccessContainer = document.getElementById('quickAccessContainer');
        const formContainer = document.getElementById('formContainer');

        // ê²°ê³¼ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œ í‘œì‹œí•˜ì§€ ì•ŠìŒ
        const hasResult = document.getElementById('markdownResult')?.innerHTML.trim().length > 0;
        if (hasResult) return;

        if (lastSajuInput) {
            try {
                const data = JSON.parse(lastSajuInput);

                // 7ì¼ ì´ë‚´ ë°ì´í„°ë§Œ í‘œì‹œ
                const age = Date.now() - data.timestamp;
                if (age > 7 * 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('lastSajuInput');
                    formContainer.classList.remove('hidden');
                    return;
                }

                // ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œ ì •ë³´ ì±„ìš°ê¸°
                const genderMap = { 'male': 'ë‚¨ì', 'female': 'ì—¬ì' };
                const modeMap = { 'teacher': 'êµì‚¬ ëª¨ë“œ', 'general': 'ì¼ë°˜ ëª¨ë“œ' };

                document.getElementById('quickAccessName').textContent = data.name || '-';
                document.getElementById('quickAccessGender').textContent = genderMap[data.gender] || '-';
                document.getElementById('quickAccessBirthDate').textContent =
                    `${data.birth_year}.${String(data.birth_month).padStart(2, '0')}.${String(data.birth_day).padStart(2, '0')}`;
                document.getElementById('quickAccessMode').textContent = modeMap[data.mode] || '-';

                // ì¼ê°„ ì•„ì´ì½˜ í‘œì‹œ (ì´ì „ ê²°ê³¼ê°€ ìˆìœ¼ë©´)
                if (data.daystem) {
                    const stemEmojiMap = {
                        'ê°‘': 'ğŸŒ³', 'ì„': 'ğŸŒ¿',
                        'ë³‘': 'â˜€ï¸', 'ì •': 'ğŸ•¯ï¸',
                        'ë¬´': 'â›°ï¸', 'ê¸°': 'ğŸ”ï¸',
                        'ê²½': 'âš”ï¸', 'ì‹ ': 'ğŸ’',
                        'ì„': 'ğŸŒŠ', 'ê³„': 'ğŸ’§'
                    };
                    const icon = stemEmojiMap[data.daystem] || 'ğŸ”®';
                    document.getElementById('quickAccessIcon').textContent = icon;
                }

                // UI ì „í™˜
                quickAccessContainer.classList.remove('hidden');
                formContainer.classList.add('hidden');
            } catch (e) {
                console.error('Failed to load last saju info:', e);
                localStorage.removeItem('lastSajuInput');
                formContainer.classList.remove('hidden');
            }
        } else {
            formContainer.classList.remove('hidden');
        }
    }

    // ì €ì¥ëœ ì •ë³´ë¡œ ë‹¤ì‹œ ë³´ê¸°
    function useLastSajuInfo() {
        const lastSajuInput = localStorage.getItem('lastSajuInput');
        if (!lastSajuInput) {
            showToast('ì €ì¥ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            const data = JSON.parse(lastSajuInput);

            // í¼ í•„ë“œ ì±„ìš°ê¸°
            document.querySelector('[name="name"]').value = data.name || '';
            document.querySelector(`[name="gender"][value="${data.gender}"]`).checked = true;
            document.querySelector('[name="birth_year"]').value = data.birth_year || '';
            document.querySelector('[name="birth_month"]').value = data.birth_month || '';
            document.querySelector('[name="birth_day"]').value = data.birth_day || '';
            document.querySelector('[name="birth_hour"]').value = data.birth_hour || '';
            document.querySelector('[name="birth_minute"]').value = data.birth_minute || '';
            document.querySelector(`[name="calendar_type"][value="${data.calendar_type}"]`).checked = true;

            // ëª¨ë“œ ì„¤ì •
            setMode(data.mode || 'teacher');

            // ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œ ìˆ¨ê¸°ê³  ê²°ê³¼ë¡œ ì´ë™
            document.getElementById('quickAccessContainer').classList.add('hidden');

            // í¼ ìë™ ì œì¶œ
            document.getElementById('sajuForm').dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        } catch (e) {
            console.error('Failed to use last saju info:', e);
            showToast('ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ìƒˆë¡œìš´ ì‚¬ì£¼ ì…ë ¥
    function showNewSajuForm() {
        // ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œ ìˆ¨ê¸°ê¸°
        document.getElementById('quickAccessContainer').classList.add('hidden');
        // í¼ í‘œì‹œ
        document.getElementById('formContainer').classList.remove('hidden');
        // í¼ ì´ˆê¸°í™”
        document.getElementById('sajuForm').reset();
        setMode('teacher');
    }

    // ============================================
    // í”„ë¡œí•„ ê´€ë¦¬ í•¨ìˆ˜
    // ============================================

    let currentProfiles = [];

    // í”„ë¡œí•„ ëª©ë¡ ë¡œë“œ
    async function loadProfiles() {
        const isAuthenticated = "{{ user.is_authenticated }}" === "True";
        if (!isAuthenticated) return;

        try {
            const response = await fetch('{% url "fortune:profile_list_api" %}');
            const data = await response.json();
            currentProfiles = data.profiles;
            renderProfileCards();
        } catch (e) {
            console.error('Failed to load profiles:', e);
        }
    }

    // í”„ë¡œí•„ ì¹´ë“œ ë Œë”ë§
    function renderProfileCards() {
        const container = document.getElementById('profileCards');
        if (!container) return;

        if (currentProfiles.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-400 py-8 w-full">
                    <i class="fa-solid fa-user-plus text-5xl mb-4 opacity-50"></i>
                    <p class="text-lg">í”„ë¡œí•„ì„ ì¶”ê°€í•˜ì—¬ ì—¬ëŸ¬ ì‚¬ëŒì˜ ì‚¬ì£¼ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
                </div>
            `;
            return;
        }

        container.innerHTML = currentProfiles.map(profile => `
            <div class="profile-card ${profile.is_default ? 'default' : ''}" data-profile-id="${profile.id}">
                <div class="profile-card-header">
                    <div class="profile-icon">
                        ${profile.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'}
                    </div>
                    <div class="profile-info">
                        <div class="profile-label">${profile.profile_name}</div>
                        <div class="profile-name">${profile.person_name}</div>
                        <div class="profile-date">${profile.birth_date}</div>
                    </div>
                    ${profile.is_default ? '<div class="default-badge">ê¸°ë³¸</div>' : ''}
                </div>
                <div class="profile-card-actions">
                    <button onclick="selectProfile(${profile.id})" class="profile-btn primary">
                        <i class="fa-solid fa-bolt"></i> ì‚¬ì£¼ ë³´ê¸°
                    </button>
                    <button onclick="editProfile(${profile.id})" class="profile-btn">
                        <i class="fa-solid fa-edit"></i>
                    </button>
                    <button onclick="deleteProfile(${profile.id})" class="profile-btn danger">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // í”„ë¡œí•„ ì„ íƒ (í¼ ìë™ ì±„ìš°ê¸°)
    function selectProfile(profileId) {
        const profile = currentProfiles.find(p => p.id === profileId);
        if (!profile) return;

        // í¼ í•„ë“œ ì±„ìš°ê¸°
        document.querySelector('[name="name"]').value = profile.person_name;
        document.querySelector(`[name="gender"][value="${profile.gender}"]`).checked = true;
        document.querySelector('[name="birth_year"]').value = profile.birth_year;
        document.querySelector('[name="birth_month"]').value = profile.birth_month;
        document.querySelector('[name="birth_day"]').value = profile.birth_day;
        document.querySelector('[name="birth_hour"]').value = profile.birth_hour || '';
        document.querySelector('[name="birth_minute"]').value = profile.birth_minute || '';
        document.querySelector(`[name="calendar_type"][value="${profile.calendar_type}"]`).checked = true;

        // ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œì™€ í”„ë¡œí•„ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        document.getElementById('quickAccessContainer')?.classList.add('hidden');
        document.getElementById('profileManagerSection')?.classList.add('hidden');

        // í¼ í‘œì‹œ ë° ìŠ¤í¬ë¡¤
        const formContainer = document.getElementById('formContainer');
        formContainer.classList.remove('hidden');
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

        showToast(`${profile.person_name} í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`, 'success');
    }

    // í”„ë¡œí•„ ëª¨ë‹¬ ì—´ê¸°
    function showProfileModal(profileId = null) {
        const modal = document.getElementById('profileModal');
        const form = document.getElementById('profileForm');
        const modalTitle = document.getElementById('modalTitle');

        form.reset();

        if (profileId) {
            const profile = currentProfiles.find(p => p.id === profileId);
            if (profile) {
                modalTitle.textContent = 'í”„ë¡œí•„ ìˆ˜ì •';
                document.getElementById('profileId').value = profile.id;
                document.getElementById('profileName').value = profile.profile_name;
                document.getElementById('personName').value = profile.person_name;
                document.querySelector(`[name="profileGender"][value="${profile.gender}"]`).checked = true;
                document.getElementById('profileBirthYear').value = profile.birth_year;
                document.getElementById('profileBirthMonth').value = profile.birth_month;
                document.getElementById('profileBirthDay').value = profile.birth_day;
                document.getElementById('profileBirthHour').value = profile.birth_hour || '';
                document.getElementById('profileBirthMinute').value = profile.birth_minute || '';
                document.querySelector(`[name="profileCalendarType"][value="${profile.calendar_type}"]`).checked = true;
            }
        } else {
            modalTitle.textContent = 'í”„ë¡œí•„ ì¶”ê°€';
            document.getElementById('profileId').value = '';
        }

        modal.classList.remove('hidden');
    }

    function editProfile(profileId) {
        showProfileModal(profileId);
    }

    // í”„ë¡œí•„ ëª¨ë‹¬ ë‹«ê¸°
    function closeProfileModal() {
        document.getElementById('profileModal').classList.add('hidden');
    }

    function closeProfileModalOnBackdrop(event) {
        if (event.target.id === 'profileModal') {
            closeProfileModal();
        }
    }

    // í”„ë¡œí•„ í¼ ì œì¶œ
    document.getElementById('profileForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const profileId = document.getElementById('profileId').value;
        const genderChecked = document.querySelector('[name="profileGender"]:checked');
        const calendarChecked = document.querySelector('[name="profileCalendarType"]:checked');

        if (!genderChecked || !calendarChecked) {
            showToast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const profileData = {
            profile_name: document.getElementById('profileName').value,
            person_name: document.getElementById('personName').value,
            gender: genderChecked.value,
            birth_year: parseInt(document.getElementById('profileBirthYear').value),
            birth_month: parseInt(document.getElementById('profileBirthMonth').value),
            birth_day: parseInt(document.getElementById('profileBirthDay').value),
            birth_hour: document.getElementById('profileBirthHour').value ? parseInt(document.getElementById('profileBirthHour').value) : null,
            birth_minute: document.getElementById('profileBirthMinute').value ? parseInt(document.getElementById('profileBirthMinute').value) : null,
            calendar_type: calendarChecked.value,
            is_default: currentProfiles.length === 0 // ì²« í”„ë¡œí•„ì´ë©´ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •
        };

        try {
            const url = profileId
                ? `{% url "fortune:profile_update_api" 0 %}`.replace('0', profileId)
                : '{% url "fortune:profile_create_api" %}';

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken.value
                },
                body: JSON.stringify(profileData)
            });

            const data = await response.json();

            if (data.success) {
                closeProfileModal();
                await loadProfiles();
                showToast(profileId ? 'í”„ë¡œí•„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'í”„ë¡œí•„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                showToast('ì˜¤ë¥˜: ' + data.error, 'error');
            }
        } catch (e) {
            console.error(e);
            showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    });

    // í”„ë¡œí•„ ì‚­ì œ
    async function deleteProfile(profileId) {
        if (!confirm('ì´ í”„ë¡œí•„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        try {
            const response = await fetch(`{% url "fortune:profile_delete_api" 0 %}`.replace('0', profileId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken.value
                }
            });

            const data = await response.json();

            if (data.success) {
                await loadProfiles();
                showToast('í”„ë¡œí•„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        } catch (e) {
            showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í”„ë¡œí•„ ë¡œë“œ
    if ("{{ user.is_authenticated }}" === "True") {
        loadProfiles();
        loadFavoriteDates();
        loadStatistics();
    }

    // ë¦¬ë§ˆì¸ë” í™•ì¸ (ëª¨ë“  ì‚¬ìš©ì)
    checkReminder();

    // ============================================
    // ì¦ê²¨ì°¾ê¸° ë‚ ì§œ í•¨ìˆ˜
    // ============================================

    let currentFavorites = [];

    // ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ë¡œë“œ
    async function loadFavoriteDates() {
        try {
            const response = await fetch('{% url "fortune:favorite_dates_api" %}');
            const data = await response.json();
            currentFavorites = data.favorites;
            renderFavoriteDates();
        } catch (e) {
            console.error('Failed to load favorites:', e);
        }
    }

    // ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ë Œë”ë§
    function renderFavoriteDates() {
        const container = document.getElementById('favoriteDatesContainer');
        if (!container) return;

        if (currentFavorites.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center py-4">ì¦ê²¨ì°¾ê¸°í•œ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤</p>';
            return;
        }

        container.innerHTML = currentFavorites.map(fav => {
            const isPast = fav.is_past;
            const daysText = isPast
                ? `${Math.abs(fav.days_until)}ì¼ ì „`
                : fav.days_until === 0
                    ? 'ì˜¤ëŠ˜'
                    : `D-${fav.days_until}`;

            return `
                <div class="favorite-date-item ${isPast ? 'past' : ''}" onclick="selectFavoriteDate('${fav.date}')">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-star text-amber-500"></i>
                            <span class="font-bold text-gray-800">${fav.label}</span>
                            <span class="text-sm ${isPast ? 'text-gray-400' : 'text-indigo-600'} font-bold">${daysText}</span>
                        </div>
                        <div class="text-sm text-gray-600 mt-1">${fav.date}</div>
                        ${fav.memo ? `<div class="text-sm text-gray-500 mt-1">${fav.memo}</div>` : ''}
                    </div>
                    <button onclick="deleteFavoriteDate(${fav.id}); event.stopPropagation();" class="text-red-400 hover:text-red-600">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `;
        }).join('');
    }

    // ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ì„ íƒ
    function selectFavoriteDate(dateStr) {
        document.getElementById('targetDateInput').value = dateStr;
        document.getElementById('targetDateInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
        showToast('ë‚ ì§œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // ì¦ê²¨ì°¾ê¸° ëª¨ë‹¬ ì—´ê¸°
    function showFavoriteDateModal() {
        const modal = document.getElementById('favoriteDateModal');
        document.getElementById('favoriteDateForm').reset();
        modal.classList.remove('hidden');
    }

    // ì¦ê²¨ì°¾ê¸° ëª¨ë‹¬ ë‹«ê¸°
    function closeFavoriteDateModal() {
        document.getElementById('favoriteDateModal').classList.add('hidden');
    }

    function closeFavoriteDateModalOnBackdrop(event) {
        if (event.target.id === 'favoriteDateModal') {
            closeFavoriteDateModal();
        }
    }

    // ì¦ê²¨ì°¾ê¸° ì¶”ê°€ (ì¼ì§„ í™•ì¸ í™”ë©´ì—ì„œ)
    async function addFavoriteDate() {
        const targetDateInput = document.getElementById('targetDateInput');
        if (!targetDateInput || !targetDateInput.value) {
            showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const label = prompt('ì´ ë‚ ì§œì˜ ë¼ë²¨ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‹œí—˜ì¼, ìƒì¼)');
        if (!label) return;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        try {
            const response = await fetch('{% url "fortune:favorite_date_add_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken.value
                },
                body: JSON.stringify({
                    date: targetDateInput.value,
                    label: label
                })
            });

            const data = await response.json();
            if (data.success) {
                await loadFavoriteDates();
                showToast('ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        } catch (e) {
            showToast('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // ì¦ê²¨ì°¾ê¸° í¼ ì œì¶œ
    document.getElementById('favoriteDateForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const favoriteData = {
            date: document.getElementById('favoriteDate').value,
            label: document.getElementById('favoriteLabel').value,
            memo: document.getElementById('favoriteMemo').value
        };

        try {
            const response = await fetch('{% url "fortune:favorite_date_add_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken.value
                },
                body: JSON.stringify(favoriteData)
            });

            const data = await response.json();
            if (data.success) {
                closeFavoriteDateModal();
                await loadFavoriteDates();
                showToast('ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        } catch (e) {
            showToast('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    });

    // ì¦ê²¨ì°¾ê¸° ì‚­ì œ
    async function deleteFavoriteDate(favoriteId) {
        if (!confirm('ì´ ì¦ê²¨ì°¾ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        try {
            const response = await fetch(`{% url "fortune:favorite_date_delete_api" 0 %}`.replace('0', favoriteId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken.value
                }
            });

            const data = await response.json();
            if (data.success) {
                await loadFavoriteDates();
                showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        } catch (e) {
            showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // ============================================
    // í†µê³„ í•¨ìˆ˜
    // ============================================

    // í†µê³„ ë¡œë“œ
    async function loadStatistics() {
        try {
            const response = await fetch('{% url "fortune:statistics_api" %}');
            const data = await response.json();

            document.getElementById('statTotalAnalyses').textContent = data.total_analyses;
            document.getElementById('statTotalDaily').textContent = data.total_daily_checks;
            document.getElementById('statRecentActivity').textContent = data.recent_activity;
        } catch (e) {
            console.error('Failed to load statistics:', e);
        }
    }

    // ============================================
    // ì•Œë¦¼/ë¦¬ë§ˆì¸ë” í•¨ìˆ˜
    // ============================================

    // ë‚´ì¼ ìš´ì„¸ ë¦¬ë§ˆì¸ë” ì„¤ì •
    function setTomorrowReminder() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);

        localStorage.setItem('fortuneReminder', tomorrow.getTime());
        showToast('ë‚´ì¼ ì•Œë¦¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ””', 'success');
    }

    // ë¦¬ë§ˆì¸ë” í™•ì¸
    function checkReminder() {
        const reminderTime = localStorage.getItem('fortuneReminder');
        if (!reminderTime) return;

        const now = new Date().getTime();
        const reminderDate = parseInt(reminderTime);

        // ë¦¬ë§ˆì¸ë” ë‚ ì§œê°€ ì§€ë‚¬ìœ¼ë©´ ë°°ë„ˆ í‘œì‹œ
        if (now >= reminderDate) {
            const banner = document.getElementById('reminderBanner');
            if (banner) {
                banner.classList.remove('hidden');
            }
        }
    }

    // ë¦¬ë§ˆì¸ë” ë°°ë„ˆ ë‹«ê¸°
    function dismissReminder() {
        document.getElementById('reminderBanner').classList.add('hidden');
        localStorage.removeItem('fortuneReminder');
    }

    // ì´ì „ ì‚¬ì£¼ ê²°ê³¼ ë³µì› í•¨ìˆ˜
    function restorePendingSajuResult() {
        const isAuthenticated = "{{ user.is_authenticated }}" === "True";
        const pendingData = localStorage.getItem('pendingSajuResult');

        if (!pendingData) return;

        try {
            const data = JSON.parse(pendingData);
            const age = Date.now() - data.timestamp;

            // 24ì‹œê°„ ì´ë‚´ ë°ì´í„°ë§Œ ë³µì›
            if (age > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('pendingSajuResult');
                return;
            }

            // ê²°ê³¼ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ë³µì›í•˜ì§€ ì•ŠìŒ
            const hasCurrentResult = document.getElementById('markdownResult')?.innerHTML.trim().length > 0;
            if (hasCurrentResult) return;

            // UI ì „í™˜
            document.getElementById('formContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.remove('hidden');
            document.getElementById('shareSection').classList.remove('hidden');
            document.getElementById('dailyFortuneSection').classList.remove('hidden');
            document.getElementById('saveSection').classList.remove('hidden');
            document.getElementById('resultDivider').classList.remove('hidden');

            // ê²°ê³¼ ë³µì›
            const resultTarget = document.getElementById('markdownResult');
            resultTarget.innerHTML = DOMPurify.sanitize(marked.parse(data.result));

            detectAndShowElement(data.result);
            updateShareCard(data.result);

            // ìŠ¤í¬ë¡¤
            setTimeout(() => {
                document.getElementById('resultContainer').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);

            // ë¡œê·¸ì¸í•œ ê²½ìš° ìë™ ì €ì¥ ì œì•ˆ
            if (isAuthenticated) {
                showToast('ì´ì „ ì‚¬ì£¼ ê²°ê³¼ë¥¼ ë³µì›í–ˆìŠµë‹ˆë‹¤!');

                // ìë™ìœ¼ë¡œ ë³´ê´€í•¨ì— ì €ì¥ ì œì•ˆ
                setTimeout(() => {
                    if (confirm('ë³µì›ëœ ì‚¬ì£¼ ê²°ê³¼ë¥¼ ë³´ê´€í•¨ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        // ì„ì‹œë¡œ chart ë°ì´í„° ì €ì¥
                        const chartDataContainer = document.createElement('script');
                        chartDataContainer.id = 'saju-chart-data';
                        chartDataContainer.type = 'application/json';
                        chartDataContainer.textContent = JSON.stringify(data.chart);
                        document.body.appendChild(chartDataContainer);

                        saveToLibrary();
                        localStorage.removeItem('pendingSajuResult');
                    }
                }, 1000);
            } else {
                showToast('ì´ì „ ì‚¬ì£¼ ê²°ê³¼ë¥¼ ë³µì›í–ˆìŠµë‹ˆë‹¤! íšŒì›ê°€ì…í•˜ë©´ ì˜êµ¬ ë³´ê´€í•  ìˆ˜ ìˆì–´ìš”.');
            }

        } catch (e) {
            console.error('Failed to restore pending result:', e);
            localStorage.removeItem('pendingSajuResult');
        }
    }

    // ì˜¤í–‰ë³„ ì´ëª¨í‹°ì½˜ ë§¤í•‘
    const ELEMENT_MAP = {
        'ê°‘': { element: 'wood', icon: 'ğŸŒ³', name: 'ê°‘ëª©(ç”²æœ¨)', desc: 'í° ë‚˜ë¬´' },
        'ì„': { element: 'wood', icon: 'ğŸŒ¿', name: 'ì„ëª©(ä¹™æœ¨)', desc: 'í’€, ë„ì¿¨' },
        'ë³‘': { element: 'fire', icon: 'â˜€ï¸', name: 'ë³‘í™”(ä¸™ç«)', desc: 'íƒœì–‘' },
        'ì •': { element: 'fire', icon: 'ğŸ•¯ï¸', name: 'ì •í™”(ä¸ç«)', desc: 'ì´›ë¶ˆ' },
        'ë¬´': { element: 'earth', icon: 'â›°ï¸', name: 'ë¬´í† (æˆŠí† )', desc: 'í° ì‚°' },
        'ê¸°': { element: 'earth', icon: 'ğŸ”ï¸', name: 'ê¸°í† (å·±åœŸ)', desc: 'ë…¼ë°­' },
        'ê²½': { element: 'metal', icon: 'âš”ï¸', name: 'ê²½ê¸ˆ(åºšé‡‘)', desc: 'ì¹¼, ë°”ìœ„' },
        'ì‹ ': { element: 'metal', icon: 'ğŸ’', name: 'ì‹ ê¸ˆ(è¾›é‡‘)', desc: 'ë³´ì„' },
        'ì„': { element: 'water', icon: 'ğŸŒŠ', name: 'ì„ìˆ˜(å£¬æ°´)', desc: 'ë°”ë‹¤' },
        'ê³„': { element: 'water', icon: 'ğŸ’§', name: 'ê³„ìˆ˜(ç™¸æ°´)', desc: 'ë¹„, ì´ìŠ¬' }
    };

    // ëª¨ë“œ í† ê¸€
    function setMode(mode) {
        document.getElementById('modeInput').value = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.mode === mode) {
                btn.classList.add('active');
            }
        });
    }

    // í¼ ì œì¶œ í•¸ë“¤ëŸ¬ (Streaming ì ìš©)
    document.getElementById('sajuForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);

        // localStorageì— ì…ë ¥ ì •ë³´ ì €ì¥
        const inputData = {
            name: formData.get('name'),
            gender: formData.get('gender'),
            birth_year: parseInt(formData.get('birth_year')),
            birth_month: parseInt(formData.get('birth_month')),
            birth_day: parseInt(formData.get('birth_day')),
            birth_hour: formData.get('birth_hour') ? parseInt(formData.get('birth_hour')) : '',
            birth_minute: formData.get('birth_minute') ? parseInt(formData.get('birth_minute')) : '',
            calendar_type: formData.get('calendar_type'),
            mode: formData.get('mode'),
            timestamp: Date.now()
        };
        localStorage.setItem('lastSajuInput', JSON.stringify(inputData));

        // UI ì „í™˜
        document.getElementById('formContainer').classList.add('hidden');
        document.getElementById('resultContainer').classList.remove('hidden');

        // ê²°ê³¼ ì„¹ì…˜ ë…¸ì¶œ (ì´ˆê¸°ì—” ìˆ¨ê²¨ì ¸ ìˆì„ ìˆ˜ ìˆìŒ)
        document.getElementById('shareSection').classList.remove('hidden');
        document.getElementById('dailyFortuneSection').classList.remove('hidden');
        document.getElementById('saveSection').classList.remove('hidden');
        document.getElementById('resultDivider').classList.remove('hidden');

        // ê²°ê³¼ ì˜ì—­ ìƒë‹¨ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
        const resultContainer = document.getElementById('resultContainer');
        if (resultContainer) {
            // ì•½ê°„ì˜ ì§€ì—° í›„ ìŠ¤í¬ë¡¤ (UI ì „í™˜ì´ ì™„ë£Œëœ í›„)
            setTimeout(() => {
                resultContainer.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
        }

        const resultTarget = document.getElementById('markdownResult');
        resultTarget.innerHTML = '<div class="flex items-center gap-3 text-purple-600 font-bold text-xl"><i class="fa-solid fa-spinner fa-spin"></i> ì£¼ì—­ì„ í’€ì´í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>';

        try {
            const response = await fetch('{% url "fortune:saju_streaming_api" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: formData
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let accumulatedText = '';

            resultTarget.innerHTML = ''; // ì´ˆê¸° ë¡œë”© ë©”ì‹œì§€ ì œê±°

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                accumulatedText += chunk;

                // [Error Detection] Check for error signatures in the stream
                // Sometimes backend streams an error message instead of failing the request
                if (accumulatedText.startsWith('[ì˜¤ë¥˜ ë°œìƒ:') || accumulatedText.startsWith('{"error":')) {
                    const errorMsg = accumulatedText.replace('[ì˜¤ë¥˜ ë°œìƒ:', '').replace(']', '').trim();
                    throw new Error(errorMsg || "ë¶„ì„ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }

                // ë§ˆí¬ë‹¤ìš´ ì‹¤ì‹œê°„ ë Œë”ë§
                resultTarget.innerHTML = DOMPurify.sanitize(marked.parse(accumulatedText));

                // ìŠ¤í¬ë¡¤ ì¡°ì ˆ (í•„ìš” ì‹œ)
                // window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }

            // ì™„ë£Œ í›„ ì¶”ê°€ ì²˜ë¦¬
            detectAndShowElement(accumulatedText);
            updateShareCard(accumulatedText);

            // ì¼ê°„ ì •ë³´ ì¶”ì¶œ ë° localStorage ì—…ë°ì´íŠ¸
            const daystemMatch = accumulatedText.match(/ì¼ì£¼[^:]*:\s*[\*\s]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/);
            if (daystemMatch) {
                const savedInput = localStorage.getItem('lastSajuInput');
                if (savedInput) {
                    const data = JSON.parse(savedInput);
                    data.daystem = daystemMatch[1];
                    localStorage.setItem('lastSajuInput', JSON.stringify(data));
                }
            }

            // ë¹„íšŒì› ê²°ê³¼ ë³´ì¡´: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            const chartDataElem = document.getElementById('saju-chart-data');
            const chartData = chartDataElem ? JSON.parse(chartDataElem.textContent) : {};

            localStorage.setItem('pendingSajuResult', JSON.stringify({
                result: accumulatedText,
                chart: chartData,
                name: "{{ name|default:'' }}",
                gender: "{{ gender|default:'' }}",
                mode: formData.get('mode'),
                timestamp: Date.now()
            }));

        } catch (err) {
            console.error(err);
            let userMessage = "ì„ ìƒë‹˜, ì ì‹œ AIì™€ì˜ ì—°ê²°ì´ ë¶ˆì•ˆì •í–ˆì–´ìš”. ğŸ˜¥<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì‹œë©´ ê¼¼ê¼¼í•˜ê²Œ ë¶„ì„í•´ë“œë¦´ê²Œìš”!";

            // íŒíŠ¸ ì œê³µ (ì„ íƒì )
            if (err.message && !err.message.includes('fetch')) {
                userMessage += `<br><span class="text-sm opacity-70 mt-2 block">(${err.message})</span>`;
            }

            resultTarget.innerHTML = `
                <div class="p-6 bg-red-50 text-red-700 rounded-2xl border border-red-200 text-center shadow-sm">
                    <div class="text-4xl mb-3">ğŸŒªï¸</div>
                    <div class="font-bold text-lg whitespace-pre-line">${userMessage}</div>
                    <button onclick="window.location.reload()" class="mt-4 px-6 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors shadow-md">
                        <i class="fa-solid fa-rotate-right mr-2"></i>ë‹¤ì‹œ ì‹œë„í•˜ê¸°
                    </button>
                </div>
            `;
        }
    });

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMessage');
        if (toast && toastMsg) {
            toastMsg.textContent = message;

            // ê¸°ì¡´ íƒ€ì… í´ë˜ìŠ¤ ì œê±°
            toast.classList.remove('success', 'error', 'info');
            toast.classList.add(type);

            toast.classList.add('show');

            // ì´ì „ íƒ€ì´ë¨¸ ìˆìœ¼ë©´ ì œê±°
            if (window.toastTimer) clearTimeout(window.toastTimer);

            window.toastTimer = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    }

    // --- Core UI & Analysis Functions ---

    // ì¼ê°„ ê°ì§€ ë° ì˜¤í–‰ ë°°ì§€ í‘œì‹œ
    function detectAndShowElement(markdown) {
        const badgeContainer = document.getElementById('elementBadge');
        if (!badgeContainer) return;

        // "ì¼ì£¼(ë‚˜): OO" ë˜ëŠ” "ì¼ê°„: O" íŒ¨í„´ì—ì„œ ì²« ê¸€ì(ì²œê°„) ì¶”ì¶œ
        const patterns = [
            /ì¼ì£¼[^:]*:\s*[\*\s]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/,
            /ì¼ê°„[^:]*:\s*[\*\s]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/,
            /ì¼ì£¼[^:]*:[^ê°€-í£]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/
        ];

        let detected = null;
        for (const pattern of patterns) {
            const match = markdown.match(pattern);
            if (match) {
                detected = match[1];
                break;
            }
        }

        if (detected && ELEMENT_MAP[detected]) {
            const info = ELEMENT_MAP[detected];
            badgeContainer.innerHTML = `
                <div class="element-badge ${info.element}">
                    <span class="element-icon">${info.icon}</span>
                    <span>${info.name}</span>
                    <span style="opacity: 0.8; font-weight: normal;">- ${info.desc}</span>
                </div>
            `;
        }
    }

    // ê³µìœ ì¹´ë“œ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ ì €ì¥ìš©)
    function updateShareCard(markdown) {
        const nameContext = "{{ name|default:'ì„ ìƒë‹˜' }}";
        const titleElem = document.getElementById('shareCardTitle');
        if (titleElem) titleElem.textContent = `ğŸ”® ${nameContext} ì„ ìƒë‹˜ì˜ ì‚¬ì£¼`;

        for (const [char, info] of Object.entries(ELEMENT_MAP)) {
            if (markdown.includes(char)) {
                const iconElem = document.getElementById('shareCardElement')?.querySelector('.icon');
                const textElem = document.getElementById('shareCardElementText');
                if (iconElem) iconElem.textContent = info.icon;
                if (textElem) textElem.textContent = info.name;
                break;
            }
        }

        const keywordMatch = markdown.match(/í‚¤ì›Œë“œ[^"]*"([^"]+)"[^"]*"([^"]+)"[^"]*"([^"]+)"/);
        if (keywordMatch) {
            const keywordsContainer = document.getElementById('shareCardKeywords');
            if (keywordsContainer) {
                keywordsContainer.innerHTML = `
                    <span class="share-card-keyword">"${keywordMatch[1]}"</span>
                    <span class="share-card-keyword">"${keywordMatch[2]}"</span>
                    <span class="share-card-keyword">"${keywordMatch[3]}"</span>
                `;
            }
        }
        const colorMatch = markdown.match(/í–‰ìš´[^:]*ìƒ‰[^:]*[:ï¼š]\s*([ê°€-í£]+ìƒ‰?)/);
        if (colorMatch) {
            const colorElem = document.getElementById('shareCardLuckyColor');
            if (colorElem) colorElem.textContent = colorMatch[1];
        }
    }

    // ì¹´ì¹´ì˜¤í†¡ ê³µìœ  (ì¹´ë“œ í˜•íƒœ)
    function shareToKakao() {
        try {
            if (typeof Kakao === 'undefined' || !Kakao.isInitialized()) {
                showToast('ì¹´ì¹´ì˜¤í†¡ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const nameContext = "{{ name|default:'ì„ ìƒë‹˜' }}";
            const resultText = document.getElementById('markdownResult')?.innerText || '';

            // ì¼ê°„ ì •ë³´ì— ë”°ë¥¸ ì•„ì´ì½˜/ì´ë¦„ ì¶”ì¶œ
            let elementIcon = 'ğŸ”®';
            let elementName = 'ì‚¬ì£¼ ë¶„ì„';
            for (const [char, info] of Object.entries(ELEMENT_MAP)) {
                if (resultText.includes(char)) {
                    elementIcon = info.icon;
                    elementName = info.name;
                    break;
                }
            }

            // ì €ì¥ëœ ê²°ê³¼ê°€ ìˆìœ¼ë©´ detail í˜ì´ì§€ë¡œ, ì—†ìœ¼ë©´ ë©”ì¸ í˜ì´ì§€ë¡œ
            let shareUrl = window.location.origin + '/fortune/saju/';
            if (typeof savedResultId !== 'undefined' && savedResultId) {
                shareUrl = window.location.origin + '/fortune/history/' + savedResultId + '/';
            }

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: `${elementIcon} ${nameContext} ì„ ìƒë‹˜ì˜ ì‚¬ì£¼ ê²°ê³¼`,
                    description: `${elementName} ê¸°ìš´ì„ ê°€ì§„ ì„ ìƒë‹˜ì„ ìœ„í•œ ë¶„ì„ì…ë‹ˆë‹¤.\n\në‹¹ì‹ ì˜ ì‚¬ì£¼ëŠ” ì–´ë–¨ê¹Œìš”? ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”! ğŸ”®`,
                    imageUrl: 'https://images.unsplash.com/photo-1515940175183-6798529cb860?q=80&w=800&auto=format&fit=crop',
                    link: {
                        mobileWebUrl: shareUrl,
                        webUrl: shareUrl,
                    },
                },
                buttons: [
                    {
                        title: 'ë‚˜ë„ ì‚¬ì£¼ë³´ê¸° ğŸ”®',
                        link: {
                            mobileWebUrl: window.location.origin + '/fortune/saju/',
                            webUrl: window.location.origin + '/fortune/saju/',
                        },
                    },
                ],
            });
        } catch (e) {
            console.error('Kakao Share Error:', e);
            if (navigator.share) {
                navigator.share({
                    title: 'ğŸ”® AI ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼',
                    text: 'Eduititì—ì„œ ë‚´ ì‚¬ì£¼ë¥¼ ë¶„ì„í•´ë´¤ì–´ìš”!',
                    url: window.location.origin + '/fortune/saju/'
                });
            } else {
                copyLink();
            }
        }
    }

    // ë§í¬ ë³µì‚¬ (ì¹´ì¹´ì˜¤í†¡ ê³µìœ ì™€ ë™ì¼í•œ ë¡œì§)
    function copyLink() {
        // ì €ì¥ëœ ê²°ê³¼ê°€ ìˆìœ¼ë©´ detail í˜ì´ì§€ë¡œ, ì—†ìœ¼ë©´ ë©”ì¸ í˜ì´ì§€ë¡œ
        let shareUrl = window.location.origin + '/fortune/saju/';
        if (typeof savedResultId !== 'undefined' && savedResultId) {
            shareUrl = window.location.origin + '/fortune/history/' + savedResultId + '/';
        }

        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = shareUrl;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });
    }

    // ì´ë¯¸ì§€ ì €ì¥ (í˜„ì¬ ê²°ê³¼ í™”ë©´ ì „ì²´ ìº¡ì²˜)
    function saveAsImage() {
        const resultCard = document.getElementById('resultCard');
        if (!resultCard) {
            showToast('ì €ì¥í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ë¡œë”© í‘œì‹œ
        showToast('ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

        // ìº¡ì²˜í•  ìš”ì†Œ ì¤€ë¹„ (no-print ìš”ì†Œë“¤ ì„ì‹œ ìˆ¨ê¹€)
        const noPrintElements = document.querySelectorAll('.no-print');
        noPrintElements.forEach(el => el.style.display = 'none');

        html2canvas(resultCard, {
            backgroundColor: '#E0E5EC',  // ë°°ê²½ìƒ‰
            scale: 2,  // ê³ í•´ìƒë„
            useCORS: true,
            logging: false,
            windowWidth: resultCard.scrollWidth,
            windowHeight: resultCard.scrollHeight
        }).then(canvas => {
            // no-print ìš”ì†Œë“¤ ë³µì›
            noPrintElements.forEach(el => el.style.display = '');

            const link = document.createElement('a');
            const nameContext = "{{ name|default:'ì‚¬ì£¼ê²°ê³¼' }}";
            link.download = `${nameContext}_ì‚¬ì£¼ë¶„ì„_${new Date().toISOString().split('T')[0]}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }).catch(err => {
            console.error(err);
            // no-print ìš”ì†Œë“¤ ë³µì›
            noPrintElements.forEach(el => el.style.display = '');
            showToast('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        });
    }

    // ë¹ ë¥¸ ë‚ ì§œ ì„ íƒ
    function setQuickDate(type) {
        const today = new Date();
        let targetDate = new Date(today);

        if (type === 'weekend') {
            // ì´ë²ˆ ì£¼ í† ìš”ì¼ ì°¾ê¸°
            const dayOfWeek = today.getDay(); // 0(ì¼) ~ 6(í† )
            const daysUntilSaturday = (6 - dayOfWeek + 7) % 7;
            targetDate.setDate(today.getDate() + (daysUntilSaturday === 0 ? 7 : daysUntilSaturday));
        } else {
            // ìˆ«ìë©´ ì¼ìˆ˜ ë”í•˜ê¸°
            targetDate.setDate(today.getDate() + type);
        }

        // YYYY-MM-DD í¬ë§·ìœ¼ë¡œ ë³€í™˜
        const year = targetDate.getFullYear();
        const month = String(targetDate.getMonth() + 1).padStart(2, '0');
        const day = String(targetDate.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;

        // ë‚ ì§œ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        document.getElementById('targetDateInput').value = dateString;

        // ë°”ë¡œ ìš´ì„¸ í™•ì¸ (ì„ íƒì )
        // checkDailyFortune();
    }

    // ì¼ì§„ í™•ì¸
    async function checkDailyFortune() {
        const targetDate = document.getElementById('targetDateInput').value;
        if (!targetDate) return;

        const chartDataElem = document.getElementById('saju-chart-data');
        let natalChart = {};

        if (chartDataElem) {
            natalChart = JSON.parse(chartDataElem.textContent);
        } else {
            const resultText = document.getElementById('markdownResult').innerText;
            // ë” ìœ ì—°í•œ ì •ê·œí‘œí˜„ì‹: ê´„í˜¸ ë‚´ í•œì í¬í•¨ ì§€ì› ë° ë¶ˆí•„ìš”í•œ ê³µë°±/ë³„í‘œ ë¬´ì‹œ
            const extractPillar = (type) => {
                const regex = new RegExp(type + '[^ê°€-í£]*[:ï¼š]?\\s*([ê°€-í£]{1,2}|[\\u4E00-\\u9FFF]{1,2})');
                const match = resultText.match(regex);
                return match ? match[1].substring(0, 2) : null;
            };

            natalChart.year = extractPillar('ë…„ì£¼');
            natalChart.month = extractPillar('ì›”ì£¼');
            natalChart.day = extractPillar('ì¼ì£¼') || extractPillar('ì¼ê°„');
            natalChart.hour = extractPillar('ì‹œì£¼');
        }

        if (!natalChart.day) {
            showToast('ë¶„ì„ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì‚¬ì£¼ ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const isGuest = "{{ user.is_authenticated }}" === "False";
        const selectedDate = new Date(targetDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (isGuest && selectedDate > today) {
            alert('ì„ ìƒë‹˜, ë¯¸ë˜ì˜ ìš´ì„¸ëŠ” íšŒì›ê°€ì… í›„ì— í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”! ğŸ˜Š');
            return;
        }

        document.getElementById('loadingOverlay').classList.add('show');

        try {
            const response = await fetch('{% url "fortune:daily_fortune_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    target_date: targetDate,
                    natal_chart: natalChart,
                    name: "{{ name|default:'ì„ ìƒë‹˜' }}",
                    gender: "{{ gender|default:'female' }}"
                })
            });

            const data = await response.json();
            document.getElementById('loadingOverlay').classList.remove('show');

            if (data.success) {
                const dailyResultDiv = document.getElementById('dailyFortuneResult');
                const dailyContentDiv = document.getElementById('dailyFortuneContent');
                dailyContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(data.result));
                dailyResultDiv.classList.remove('hidden');
                dailyResultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                showToast(data.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (e) {
            document.getElementById('loadingOverlay').classList.remove('show');
            showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì €ì¥ëœ ê²°ê³¼ IDë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let savedResultId = null;

    // ë³´ê´€í•¨ ì €ì¥
    async function saveToLibrary() {
        console.log("Saving to library...");

        if ("{{ user.is_authenticated }}" === "False") {
            alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. ğŸ˜Š');
            return;
        }

        const resultElem = document.getElementById('markdownResult');
        if (!resultElem) {
            console.error("Result element not found");
            return;
        }

        const resultText = resultElem.innerText;
        const chartDataElem = document.getElementById('saju-chart-data');
        let natalChart = {};

        if (chartDataElem) {
            try {
                natalChart = JSON.parse(chartDataElem.textContent);
            } catch (e) {
                console.error("Chart JSON parse error", e);
            }
        } else {
            // ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œì¸ ê²½ìš° í…ìŠ¤íŠ¸ì—ì„œ ê°„ë‹¨íˆ ì¼ì£¼ ë³´ì¡´
            const dayMatch = resultText.match(/ì¼ì£¼[^ê°€-í£]*[:ï¼š]\s*([ê°€-í£]{2})/);
            if (dayMatch) natalChart.day = dayMatch[1];
        }

        const dailyResultDiv = document.getElementById('dailyFortuneResult');
        const dailyContentDiv = document.getElementById('dailyFortuneContent');
        const dailyText = (dailyResultDiv && !dailyResultDiv.classList.contains('hidden') && dailyContentDiv) ? dailyContentDiv.innerText : null;

        try {
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfInput) {
                throw new Error("ë³´ì•ˆ í† í°(CSRF)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
            }

            const response = await fetch('{% url "fortune:save_fortune_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfInput.value
                },
                body: JSON.stringify({
                    mode: dailyText ? 'daily' : 'teacher',
                    natal_chart: natalChart,
                    result_text: dailyText ? dailyText : resultText,
                    target_date: dailyText ? document.getElementById('targetDateInput')?.value : null
                })
            });

            const data = await response.json();
            if (data.success) {
                savedResultId = data.result_id; // ì €ì¥ëœ ID ì €ì¥
                showToast('ë³´ê´€í•¨ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ');
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ì¤‘ë³µ ì €ì¥ ë°©ì§€)
                const saveBtn = document.querySelector('#saveSection button');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>ì €ì¥ ì™„ë£Œ';
                    saveBtn.classList.remove('bg-purple-600');
                    saveBtn.classList.add('bg-gray-400');
                }
            } else {
                showToast('ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        } catch (e) {
            console.error(e);
            showToast(e.message || 'ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>

{% if result %}
{{ result|json_script:"saju-result-data" }}
{{ chart|json_script:"saju-chart-data" }}
<script>
    // SSR ê²°ê³¼ ë Œë”ë§
    document.addEventListener('DOMContentLoaded', function () {
        const resultDataElem = document.getElementById('saju-result-data');
        if (resultDataElem) {
            const rawMarkdown = JSON.parse(resultDataElem.textContent);
            marked.setOptions({ breaks: true, gfm: true });
            const htmlContent = DOMPurify.sanitize(marked.parse(rawMarkdown));
            document.getElementById('markdownResult').innerHTML = htmlContent;

            detectAndShowElement(rawMarkdown);
            updateShareCard(rawMarkdown);
        }
    });
</script>
{% endif %}
{% endblock %}