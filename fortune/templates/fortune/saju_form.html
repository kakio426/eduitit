{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* ê²°ê³¼ ë°•ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
    [data-aos] {
        pointer-events: none;
    }

    [data-aos].aos-animate {
        pointer-events: auto;
    }

    /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
    .markdown-body {
        font-family: 'NanumSquareRound', sans-serif;
        font-size: 1.05rem;
        line-height: 1.7;
        color: #4a5568;
        word-break: keep-all;
        overflow-wrap: break-word;
    }

    .markdown-body table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
        display: block;
        overflow-x: auto;
    }

    .markdown-body th,
    .markdown-body td {
        border: 1px solid #e2e8f0;
        padding: 0.75rem;
        text-align: left;
    }

    .markdown-body th {
        background-color: #f7fafc;
        font-weight: bold;
    }

    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3 {
        color: #2d3748;
        font-weight: bold;
        margin-top: 2rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid #edf2f7;
        padding-bottom: 0.5rem;
    }

    .markdown-body h1 {
        font-size: 1.75rem;
    }

    .markdown-body h2 {
        font-size: 1.5rem;
    }

    .markdown-body h3 {
        font-size: 1.25rem;
    }

    .markdown-body p {
        margin-bottom: 1.2rem;
    }

    .markdown-body ul,
    .markdown-body ol {
        margin-bottom: 1.5rem;
        padding-left: 2rem;
    }

    .markdown-body li {
        margin-bottom: 0.5rem;
    }

    .markdown-body blockquote {
        border-left: 6px solid #a78bfa;
        background: #f3f4f6;
        padding: 1rem 1.5rem;
        border-radius: 0 16px 16px 0;
        margin: 1.5rem 0;
        font-style: italic;
    }

    .markdown-body strong {
        color: #7c3aed;
        background: linear-gradient(120deg, rgba(167, 139, 250, 0.2) 0%, rgba(167, 139, 250, 0.2) 100%);
        background-repeat: no-repeat;
        background-size: 100% 40%;
        background-position: 0 80%;
    }

    /* ì˜¤í–‰ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
    .element-badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 18px;
        border-radius: 100px;
        font-size: 1.1rem;
        font-weight: 800;
        color: white;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .element-badge.wood {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .element-badge.fire {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .element-badge.earth {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .element-badge.metal {
        background: linear-gradient(135deg, #94a3b8, #64748b);
    }

    .element-badge.water {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .element-icon {
        font-size: 2rem;
    }

    /* ========================================
       ê³µìœ  ë²„íŠ¼ ìŠ¤íƒ€ì¼
       ======================================== */
    .share-section {
        margin-top: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 24px;
        border: 2px solid #e2e8f0;
    }

    .share-title {
        font-size: 1.1rem;
        font-weight: 800;
        color: #64748b;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .share-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .share-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 14px 24px;
        border-radius: 16px;
        font-size: 1.4rem;
        font-weight: bold;
        border: none;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        text-decoration: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .share-btn:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }

    .share-btn:active {
        transform: translateY(0) scale(0.98);
    }

    .share-btn.kakao {
        background: #FEE500;
        color: #3C1E1E;
    }

    .share-btn.link {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
    }

    .share-btn.image {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        color: white;
    }

    /* ========================================
       ê³µìœ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ì´ë¯¸ì§€ ì €ì¥ìš©)
       ======================================== */
    .share-card {
        position: fixed;
        left: -9999px;
        width: 600px;
        padding: 40px;
        background: linear-gradient(145deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        border-radius: 32px;
        color: white;
        font-family: 'NanumSquareRound', sans-serif;
    }

    .share-card-inner {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 32px;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .share-card-header {
        text-align: center;
        margin-bottom: 24px;
    }

    .share-card-title {
        font-size: 2.8rem;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .share-card-element {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 100px;
        font-size: 2rem;
        font-weight: bold;
        margin: 16px 0;
    }

    .share-card-element .icon {
        font-size: 2.4rem;
    }

    .share-card-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
    }

    .share-card-keyword {
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 100px;
        font-size: 1.6rem;
    }

    .share-card-fortune {
        text-align: center;
        padding: 16px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        margin: 16px 0;
    }

    .share-card-fortune-label {
        font-size: 1.4rem;
        opacity: 0.9;
        margin-bottom: 8px;
    }

    .share-card-fortune-value {
        font-size: 1.8rem;
        font-weight: bold;
    }

    .share-card-footer {
        text-align: center;
        margin-top: 24px;
        font-size: 1.4rem;
        opacity: 0.8;
    }

    .share-card-footer .logo {
        font-size: 1.8rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    /* ========================================
       í¼ ìŠ¤íƒ€ì¼ë§ (í°íŠ¸ ì¦ê°€)
       ======================================== */
    .saju-input {
        width: 100%;
        padding: 1.2rem 1.5rem;
        background: #E0E5EC;
        border: none;
        border-radius: 18px;
        box-shadow: inset 6px 6px 10px 0 rgba(163, 177, 198, 0.7),
            inset -6px -6px 10px 0 rgba(255, 255, 255, 0.8);
        color: #4A5568;
        font-family: inherit;
        font-size: 1.6rem;
        transition: all 0.3s;
    }

    .saju-input:focus {
        outline: none;
        box-shadow: inset 8px 8px 12px 0 rgba(163, 177, 198, 0.8),
            inset -8px -8px 12px 0 rgba(255, 255, 255, 0.9);
    }

    .saju-input::placeholder {
        color: #a0aec0;
    }

    /* ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .radio-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .radio-group label {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.9rem 1.5rem;
        background: #E0E5EC;
        border-radius: 14px;
        box-shadow: 5px 5px 10px rgba(163, 177, 198, 0.5),
            -5px -5px 10px rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1.5rem;
    }

    .radio-group label:hover {
        transform: translateY(-2px);
    }

    .radio-group input[type="radio"] {
        width: 22px;
        height: 22px;
        accent-color: #7c3aed;
    }

    .radio-group input[type="radio"]:checked+span {
        color: #7c3aed;
        font-weight: bold;
    }

    /* ëª¨ë“œ í† ê¸€ ìŠ¤íƒ€ì¼ */
    .mode-toggle {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .mode-btn {
        flex: 1;
        padding: 1.5rem;
        background: #E0E5EC;
        border: none;
        border-radius: 22px;
        box-shadow: 7px 7px 14px rgba(163, 177, 198, 0.6),
            -7px -7px 14px rgba(255, 255, 255, 0.5);
        font-size: 1.6rem;
        font-weight: bold;
        color: #4A5568;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .mode-btn.active {
        background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%);
        color: white;
        box-shadow: inset 4px 4px 8px rgba(0, 0, 0, 0.1);
    }

    .mode-btn:not(.active):hover {
        transform: translateY(-2px);
        box-shadow: 9px 9px 18px rgba(163, 177, 198, 0.7),
            -9px -9px 18px rgba(255, 255, 255, 0.6);
    }

    .mode-btn span {
        display: block;
        font-size: 1.2rem;
        font-weight: normal;
        margin-top: 6px;
        opacity: 0.85;
    }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    .loading-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(224, 229, 236, 0.95);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 1.5rem;
    }

    .loading-overlay.show {
        display: flex;
    }

    .loading-spinner {
        width: 70px;
        height: 70px;
        border: 6px solid #e9d5ff;
        border-top: 6px solid #7c3aed;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .loading-text {
        font-size: 2rem;
        color: #7c3aed;
        text-align: center;
    }

    /* ë³µì‚¬ ì™„ë£Œ í† ìŠ¤íŠ¸ */
    .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 16px 32px;
        border-radius: 100px;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: all 0.4s;
        z-index: 9999;
    }

    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
</style>
{% endblock %}

{% block content %}
<main class="pt-32 pb-20 px-4 md:px-8 min-h-screen max-w-4xl mx-auto">

    <!-- í—¤ë” -->
    <div class="text-center mb-12" data-aos="fade-down">
        <div class="w-28 h-28 mx-auto mb-6 rounded-full shadow-clay-inner flex items-center justify-center">
            <span class="text-6xl">ğŸ”®</span>
        </div>
        <h1 class="text-5xl md:text-6xl font-bold text-gray-700 mb-4">
            ì‚¬ì£¼ <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-indigo-500">ìš´ì„¸</span>
        </h1>
        <p class="text-xl text-gray-500 font-bold">
            AIê°€ ë¶„ì„í•˜ëŠ” ë‚˜ë§Œì˜ ì‚¬ì£¼íŒ”ìì™€ ìš´ì„¸
        </p>
    </div>

    {% if error %}
    <div class="clay-card p-6 mb-8 border-2 border-red-200 bg-red-50/50" data-aos="fade-up">
        <div class="flex items-start gap-4 text-red-600">
            <i class="fa-solid fa-circle-exclamation text-3xl mt-1"></i>
            <div>
                <h3 class="text-2xl font-bold mb-2">ë¶„ì„ ì¤‘ ì•Œë¦¼</h3>
                <p class="text-lg leading-relaxed">{{ error }}</p>
                {% if user.is_authenticated %}
                <a href="{% url 'settings' %}"
                    class="inline-block mt-4 px-6 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors">
                    ì„¤ì •ì—ì„œ API í‚¤ ë“±ë¡í•˜ê¸°
                </a>
                {% else %}
                <a href="{% url 'account_login' %}"
                    class="inline-block mt-4 px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-slate-800 transition-colors">
                    ë¡œê·¸ì¸/ê°€ì…í•˜ê¸°
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ì…ë ¥ í¼ ì„¹ì…˜ -->
    <div id="formContainer" class="{% if result %}hidden{% endif %}">
        <div class="clay-card p-8 md:p-12" data-aos="fade-up">

            <form method="post" id="sajuForm">
                {% csrf_token %}

                <!-- ëª¨ë“œ ì„ íƒ -->
                <div class="mb-8">
                    <label class="block text-2xl font-bold text-gray-600 mb-4">
                        <i class="fa-solid fa-wand-magic-sparkles text-purple-500 mr-2"></i>ìƒë‹´ ëª¨ë“œ
                    </label>
                    <div class="mode-toggle">
                        <button type="button" class="mode-btn active" data-mode="teacher" onclick="setMode('teacher')">
                            <i class="fa-solid fa-chalkboard-user mr-2"></i>êµì‚¬ ëª¨ë“œ
                            <span>í•™êµìƒí™œ, í•™ìƒ ì¼€ë¯¸, ë™ë£Œ ê´€ê³„</span>
                        </button>
                        <button type="button" class="mode-btn" data-mode="general" onclick="setMode('general')">
                            <i class="fa-solid fa-star mr-2"></i>ì¼ë°˜ ëª¨ë“œ
                            <span>ì¬ë¬¼, ì—°ì• , ê±´ê°•, ì§ì—…ìš´</span>
                        </button>
                    </div>
                    <input type="hidden" name="mode" id="modeInput" value="teacher">
                </div>

                <!-- ì´ë¦„ -->
                <div class="mb-6">
                    <label for="id_name" class="block text-2xl font-bold text-gray-600 mb-3">
                        <i class="fa-solid fa-user text-purple-500 mr-2"></i>ì´ë¦„
                    </label>
                    <input type="text" name="name" id="id_name" class="saju-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required
                        maxlength="20">
                </div>

                <!-- ì„±ë³„ -->
                <div class="mb-6">
                    <label class="block text-2xl font-bold text-gray-600 mb-3">
                        <i class="fa-solid fa-venus-mars text-purple-500 mr-2"></i>ì„±ë³„
                    </label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="gender" value="male" required>
                            <span>ë‚¨ì</span>
                        </label>
                        <label>
                            <input type="radio" name="gender" value="female">
                            <span>ì—¬ì</span>
                        </label>
                    </div>
                </div>

                <!-- ìƒë…„ì›”ì¼ -->
                <div class="mb-6">
                    <label class="block text-2xl font-bold text-gray-600 mb-3">
                        <i class="fa-solid fa-cake-candles text-purple-500 mr-2"></i>ìƒë…„ì›”ì¼
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <input type="number" name="birth_year" class="saju-input" placeholder="ë…„ë„" required
                                min="1940" max="2025">
                        </div>
                        <div>
                            <input type="number" name="birth_month" class="saju-input" placeholder="ì›”" required min="1"
                                max="12">
                        </div>
                        <div>
                            <input type="number" name="birth_day" class="saju-input" placeholder="ì¼" required min="1"
                                max="31">
                        </div>
                    </div>
                </div>

                <!-- íƒœì–´ë‚œ ì‹œê°„ -->
                <div class="mb-6">
                    <label class="block text-2xl font-bold text-gray-600 mb-3">
                        <i class="fa-solid fa-clock text-purple-500 mr-2"></i>íƒœì–´ë‚œ ì‹œê°„ <span
                            class="text-gray-400 font-normal text-xl">(ì„ íƒ)</span>
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <input type="number" name="birth_hour" class="saju-input" placeholder="ì‹œ (0~23)" min="0"
                                max="23">
                        </div>
                        <div>
                            <input type="number" name="birth_minute" class="saju-input" placeholder="ë¶„ (0~59)" min="0"
                                max="59">
                        </div>
                    </div>
                    <p class="text-gray-400 text-xl mt-3 ml-1">ëª¨ë¥´ì‹œë©´ ë¹„ì›Œë‘ì„¸ìš”</p>
                </div>

                <!-- ì–‘ë ¥/ìŒë ¥ -->
                <div class="mb-8">
                    <label class="block text-2xl font-bold text-gray-600 mb-3">
                        <i class="fa-solid fa-calendar text-purple-500 mr-2"></i>ì–‘ë ¥/ìŒë ¥
                    </label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="calendar_type" value="solar" checked>
                            <span>ì–‘ë ¥</span>
                        </label>
                        <label>
                            <input type="radio" name="calendar_type" value="lunar">
                            <span>ìŒë ¥</span>
                        </label>
                    </div>
                </div>

                <!-- ì œì¶œ ë²„íŠ¼ -->
                <button type="submit" class="w-full py-5 rounded-2xl text-white font-bold text-2xl transition-all
                bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600
                shadow-lg hover:shadow-xl hover:-translate-y-1">
                    <i class="fa-solid fa-crystal-ball mr-2"></i>ì‚¬ì£¼ ë¶„ì„í•˜ê¸°
                </button>
            </form>
        </div>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ ì„¹ì…˜ -->
    <div id="resultContainer" class="{% if not result %}hidden{% endif %}">
        <div class="clay-card p-8 md:p-12" data-aos="fade-up" id="resultCard">

            {% if result %}
            <!-- ì˜¤í–‰ ë°°ì§€ (JavaScriptë¡œ ë™ì  ìƒì„±) -->
            <div id="elementBadge" class="text-center mb-6"></div>

            <!-- ë§ˆí¬ë‹¤ìš´ ê²°ê³¼ -->
            <div class="markdown-body" id="markdownResult"></div>

            <!-- ê³µìœ  ì„¹ì…˜ -->
            <div class="share-section">
                <div class="share-title">
                    <i class="fa-solid fa-share-nodes"></i>
                    ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ê¸°
                </div>
                <div class="share-buttons">
                    <button class="share-btn kakao" onclick="shareToKakao()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 3C6.48 3 2 6.48 2 10.5c0 2.53 1.67 4.75 4.17 6.02-.18.65-.66 2.35-.75 2.72-.12.47.17.46.36.34.15-.1 2.38-1.61 3.35-2.27.62.09 1.24.14 1.87.14 5.52 0 10-3.48 10-7.95S17.52 3 12 3z" />
                        </svg>
                        ì¹´ì¹´ì˜¤í†¡
                    </button>
                    <button class="share-btn link" onclick="copyLink()">
                        <i class="fa-solid fa-link"></i>
                        ë§í¬ ë³µì‚¬
                    </button>
                    <button class="share-btn image" onclick="saveAsImage()">
                        <i class="fa-solid fa-image"></i>
                        ì´ë¯¸ì§€ ì €ì¥
                    </button>
                </div>
            </div>

            <hr class="my-10 border-slate-200">

            <!-- íŠ¹ì • ë‚ ì§œ ìš´ì„¸ (ì¼ì§„) -->
            <div class="bg-indigo-50/50 rounded-3xl p-8 border border-indigo-100 mb-8">
                <div class="flex items-center gap-3 mb-6">
                    <div
                        class="w-10 h-10 bg-indigo-600/10 text-indigo-600 rounded-xl flex items-center justify-center text-xl">
                        <i class="fa-solid fa-calendar-check"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-700">ë‚ ì§œë³„ ìš´ì„¸ í™•ì¸</h3>
                        <p class="text-slate-500 font-medium">ì¤‘ìš”í•œ í–‰ì‚¬ë‚˜ ëª¨ì„ì´ ìˆëŠ” ë‚ ì˜ ìš´ì„¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <input type="date" id="targetDateInput" value="{% now 'Y-m-d' %}"
                        class="flex-1 w-full bg-white border-2 border-indigo-100 rounded-2xl p-4 text-xl font-bold text-slate-700 focus:outline-none focus:border-indigo-500 transition-all">
                    <button onclick="checkDailyFortune()"
                        class="w-full md:w-auto px-8 py-4 bg-indigo-600 hover:bg-neutral-800 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                        ìš´ì„¸ ë³´ê¸°
                    </button>
                </div>

                <div id="dailyFortuneResult" class="mt-8 hidden animate-in fade-in slide-in-from-top duration-500">
                    <div class="bg-white rounded-2xl p-6 border border-indigo-50 shadow-sm markdown-body"
                        id="dailyFortuneContent">
                        <!-- JS Populated -->
                    </div>
                </div>
            </div>

            {% if user.is_authenticated %}
            <div class="bg-purple-50/50 rounded-3xl p-8 border border-purple-100">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 bg-purple-600/10 text-purple-600 rounded-2xl flex items-center justify-center text-2xl">
                            <i class="fa-solid fa-bookmark"></i>
                        </div>
                        <div class="text-left">
                            <h4 class="text-xl font-black text-slate-700">ì´ ê²°ê³¼ ë³´ê´€í•˜ê¸°</h4>
                            <p class="text-slate-500 font-medium">ì„ ìƒë‹˜ë§Œì˜ ìš´ì„¸ ë³´ê´€í•¨ì— ì €ì¥í•´ë‘ê³  ì–¸ì œë“  êº¼ë‚´ë³´ì„¸ìš”.</p>
                        </div>
                    </div>
                    <button onclick="saveToLibrary()"
                        class="px-8 py-4 bg-purple-600 hover:bg-neutral-800 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                        ë³´ê´€í•¨ì— ì €ì¥
                    </button>
                </div>
            </div>
            {% else %}
            <div class="bg-slate-100/50 rounded-3xl p-8 border border-slate-200">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 bg-slate-400 text-white rounded-2xl flex items-center justify-center text-2xl">
                            <i class="fa-solid fa-lock"></i>
                        </div>
                        <div class="text-left">
                            <h4 class="text-xl font-black text-slate-700">ë¶„ì„ ê²°ê³¼ ë³´ê´€ ë° ë¯¸ë˜ ì¼ì§„ í™•ì¸</h4>
                            <p class="text-slate-500 font-medium">íšŒì›ì´ ë˜ì‹œë©´ ë¶„ì„ëœ ì‚¬ì£¼ë¥¼ ì˜êµ¬ ë³´ê´€í•˜ê³  ë‚´ì¼ì˜ ìš´ì„¸ë„ ë¯¸ë¦¬ ë³¼ ìˆ˜ ìˆì–´ìš”. ğŸ˜Š</p>
                        </div>
                    </div>
                    <a href="{% url 'account_signup' %}"
                        class="px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                        ê°€ì…í•˜ê³  í˜œíƒ ë°›ê¸°
                    </a>
                </div>
            </div>
            {% endif %}
            <div class="mt-10 text-center">
                <a href="{% url 'fortune:saju' %}" class="inline-block px-12 py-5 rounded-2xl text-white font-bold text-2xl
                    bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600
                    shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">
                    <i class="fa-solid fa-rotate-left mr-2"></i>ë‹¤ì‹œ ë³´ê¸°
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ê³µìœ ì¹´ë“œ (ì´ë¯¸ì§€ ì €ì¥ìš©, í™”ë©´ì— ë³´ì´ì§€ ì•ŠìŒ) -->
    <div id="shareCardContainer" class="share-card">
        <div class="share-card-inner">
            <div class="share-card-header">
                <div class="share-card-title" id="shareCardTitle">ğŸ”® ì‚¬ì£¼ ë¶„ì„</div>
                <div class="share-card-element" id="shareCardElement">
                    <span class="icon">âš”ï¸</span>
                    <span id="shareCardElementText">ê²½ê¸ˆ(åºšé‡‘)</span>
                </div>
            </div>
            <div class="share-card-keywords" id="shareCardKeywords">
                <span class="share-card-keyword">"ìƒˆë¡œìš´ ì‹œì‘"</span>
                <span class="share-card-keyword">"ë„ì „"</span>
                <span class="share-card-keyword">"ì„±ì¥"</span>
            </div>
            <div class="share-card-fortune">
                <div class="share-card-fortune-label">ğŸ€ í–‰ìš´ì˜ ìƒ‰</div>
                <div class="share-card-fortune-value" id="shareCardLuckyColor">íŒŒë€ìƒ‰</div>
            </div>
            <div class="share-card-footer">
                <div class="logo">ğŸ”® Eduitit ì‚¬ì£¼ ìš´ì„¸</div>
                <div style="margin-top: 8px; font-size: 1.2rem;">eduitit.up.railway.app</div>
            </div>
        </div>
    </div>

</main>

<!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
<div id="toast" class="toast">
    <i class="fa-solid fa-check-circle mr-2"></i>
    <span id="toastMessage">ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">
        ì‚¬ì£¼ë¥¼ ë¶„ì„í•˜ê³  ìˆì–´ìš”...<br>
        <span class="text-xl opacity-70">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ë§ˆí¬ë‹¤ìš´ íŒŒì„œ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- XSS ë°©ì§€ìš© sanitizer -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<!-- ì´ë¯¸ì§€ ì €ì¥ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!-- ì¹´ì¹´ì˜¤ SDK -->
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.6.0/kakao.min.js"></script>

<script>
    // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
    if ("{{ kakao_js_key }}") {
        Kakao.init("{{ kakao_js_key }}");
        console.log("Kakao SDK Initialized:", Kakao.isInitialized());
    }

    // UI Safe-guard: Ensure form is visible if no result
    document.addEventListener('DOMContentLoaded', () => {
        const resultContainer = document.getElementById('resultContainer');
        const formContainer = document.getElementById('formContainer');
        const hasResult = document.getElementById('markdownResult')?.innerHTML.trim().length > 0;

        if (!hasResult && resultContainer && !resultContainer.classList.contains('hidden')) {
            console.warn('UI State Correction: Hiding empty result, showing form.');
            resultContainer.classList.add('hidden');
            formContainer.classList.remove('hidden');
        }
    });

    // ì˜¤í–‰ë³„ ì´ëª¨í‹°ì½˜ ë§¤í•‘
    const ELEMENT_MAP = {
        'ê°‘': { element: 'wood', icon: 'ğŸŒ³', name: 'ê°‘ëª©(ç”²æœ¨)', desc: 'í° ë‚˜ë¬´' },
        'ì„': { element: 'wood', icon: 'ğŸŒ¿', name: 'ì„ëª©(ä¹™æœ¨)', desc: 'í’€, ë„ì¿¨' },
        'ë³‘': { element: 'fire', icon: 'â˜€ï¸', name: 'ë³‘í™”(ä¸™ç«)', desc: 'íƒœì–‘' },
        'ì •': { element: 'fire', icon: 'ğŸ•¯ï¸', name: 'ì •í™”(ä¸ç«)', desc: 'ì´›ë¶ˆ' },
        'ë¬´': { element: 'earth', icon: 'â›°ï¸', name: 'ë¬´í† (æˆŠí† )', desc: 'í° ì‚°' },
        'ê¸°': { element: 'earth', icon: 'ğŸ”ï¸', name: 'ê¸°í† (å·±åœŸ)', desc: 'ë…¼ë°­' },
        'ê²½': { element: 'metal', icon: 'âš”ï¸', name: 'ê²½ê¸ˆ(åºšé‡‘)', desc: 'ì¹¼, ë°”ìœ„' },
        'ì‹ ': { element: 'metal', icon: 'ğŸ’', name: 'ì‹ ê¸ˆ(è¾›é‡‘)', desc: 'ë³´ì„' },
        'ì„': { element: 'water', icon: 'ğŸŒŠ', name: 'ì„ìˆ˜(å£¬æ°´)', desc: 'ë°”ë‹¤' },
        'ê³„': { element: 'water', icon: 'ğŸ’§', name: 'ê³„ìˆ˜(ç™¸æ°´)', desc: 'ë¹„, ì´ìŠ¬' }
    };

    // ëª¨ë“œ í† ê¸€
    function setMode(mode) {
        document.getElementById('modeInput').value = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.mode === mode) {
                btn.classList.add('active');
            }
        });
    }

    // í¼ ì œì¶œ í•¸ë“¤ëŸ¬ (Streaming ì ìš©)
    document.getElementById('sajuForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);

        // UI ì „í™˜
        document.getElementById('formContainer').classList.add('hidden');
        document.getElementById('resultContainer').classList.remove('hidden');

        const resultTarget = document.getElementById('markdownResult');
        resultTarget.innerHTML = '<div class="flex items-center gap-3 text-purple-600 font-bold text-xl"><i class="fa-solid fa-spinner fa-spin"></i> ì£¼ì—­ì„ í’€ì´í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>';

        try {
            const response = await fetch('{% url "fortune:saju_streaming_api" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: formData
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let accumulatedText = '';

            resultTarget.innerHTML = ''; // ì´ˆê¸° ë¡œë”© ë©”ì‹œì§€ ì œê±°

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                accumulatedText += chunk;

                // [Error Detection] Check for error signatures in the stream
                // Sometimes backend streams an error message instead of failing the request
                if (accumulatedText.startsWith('[ì˜¤ë¥˜ ë°œìƒ:') || accumulatedText.startsWith('{"error":')) {
                    const errorMsg = accumulatedText.replace('[ì˜¤ë¥˜ ë°œìƒ:', '').replace(']', '').trim();
                    throw new Error(errorMsg || "ë¶„ì„ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }

                // ë§ˆí¬ë‹¤ìš´ ì‹¤ì‹œê°„ ë Œë”ë§
                resultTarget.innerHTML = DOMPurify.sanitize(marked.parse(accumulatedText));

                // ìŠ¤í¬ë¡¤ ì¡°ì ˆ (í•„ìš” ì‹œ)
                // window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }

            // ì™„ë£Œ í›„ ì¶”ê°€ ì²˜ë¦¬
            detectAndShowElement(accumulatedText);
            updateShareCard(accumulatedText);

        } catch (err) {
            console.error(err);
            let userMessage = "ì„ ìƒë‹˜, ì ì‹œ AIì™€ì˜ ì—°ê²°ì´ ë¶ˆì•ˆì •í–ˆì–´ìš”. ğŸ˜¥<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì‹œë©´ ê¼¼ê¼¼í•˜ê²Œ ë¶„ì„í•´ë“œë¦´ê²Œìš”!";

            // íŒíŠ¸ ì œê³µ (ì„ íƒì )
            if (err.message && !err.message.includes('fetch')) {
                userMessage += `<br><span class="text-sm opacity-70 mt-2 block">(${err.message})</span>`;
            }

            resultTarget.innerHTML = `
                <div class="p-6 bg-red-50 text-red-700 rounded-2xl border border-red-200 text-center shadow-sm">
                    <div class="text-4xl mb-3">ğŸŒªï¸</div>
                    <div class="font-bold text-lg whitespace-pre-line">${userMessage}</div>
                    <button onclick="window.location.reload()" class="mt-4 px-6 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors shadow-md">
                        <i class="fa-solid fa-rotate-right mr-2"></i>ë‹¤ì‹œ ì‹œë„í•˜ê¸°
                    </button>
                </div>
            `;
        }
    });

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showToast(message) {
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMessage');
        if (toast && toastMsg) {
            toastMsg.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    }

    // --- REFACTORED FUNCTIONS FOR STREAMING Support ---

    // ì¼ê°„ ê°ì§€ ë° ì˜¤í–‰ ë°°ì§€ í‘œì‹œ
    function detectAndShowElement(markdown) {
        const badgeContainer = document.getElementById('elementBadge');
        if (!badgeContainer) return;

        // "ì¼ì£¼(ë‚˜): OO" ë˜ëŠ” "ì¼ê°„: O" íŒ¨í„´ì—ì„œ ì²« ê¸€ì(ì²œê°„) ì¶”ì¶œ
        const patterns = [
            /ì¼ì£¼[^:]*:\s*[\*\s]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/,
            /ì¼ê°„[^:]*:\s*[\*\s]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/,
            /ì¼ì£¼[^:]*:[^ê°€-í£]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/
        ];

        let detected = null;
        for (const pattern of patterns) {
            const match = markdown.match(pattern);
            if (match) {
                detected = match[1];
                break;
            }
        }

        if (detected && ELEMENT_MAP[detected]) {
            const info = ELEMENT_MAP[detected];
            badgeContainer.innerHTML = `
                <div class="element-badge ${info.element}">
                    <span class="element-icon">${info.icon}</span>
                    <span>${info.name}</span>
                    <span style="opacity: 0.8; font-weight: normal;">- ${info.desc}</span>
                </div>
            `;
        }
    }

    // ê³µìœ ì¹´ë“œ ì—…ë°ì´íŠ¸
    function updateShareCard(markdown) {
        const nameContext = "{{ name|default:'ì„ ìƒë‹˜' }}";
        const titleElem = document.getElementById('shareCardTitle');
        if (titleElem) titleElem.textContent = `ğŸ”® ${nameContext} ì„ ìƒë‹˜ì˜ ì‚¬ì£¼`;

        for (const [char, info] of Object.entries(ELEMENT_MAP)) {
            if (markdown.includes(char)) {
                const iconElem = document.getElementById('shareCardElement')?.querySelector('.icon');
                const textElem = document.getElementById('shareCardElementText');
                if (iconElem) iconElem.textContent = info.icon;
                if (textElem) textElem.textContent = info.name;
                break;
            }
        }

        const keywordMatch = markdown.match(/í‚¤ì›Œë“œ[^"]*"([^"]+)"[^"]*"([^"]+)"[^"]*"([^"]+)"/);
        if (keywordMatch) {
            const keywordsContainer = document.getElementById('shareCardKeywords');
            if (keywordsContainer) {
                keywordsContainer.innerHTML = `
                    <span class="share-card-keyword">"${keywordMatch[1]}"</span>
                    <span class="share-card-keyword">"${keywordMatch[2]}"</span>
                    <span class="share-card-keyword">"${keywordMatch[3]}"</span>
                `;
            }
        }
        const colorMatch = markdown.match(/í–‰ìš´[^:]*ìƒ‰[^:]*[:ï¼š]\s*([ê°€-í£]+ìƒ‰?)/);
        if (colorMatch) {
            const colorElem = document.getElementById('shareCardLuckyColor');
            if (colorElem) colorElem.textContent = colorMatch[1];
        }
    }
</script>

{% if result %}
{{ result|json_script:"saju-result-data" }}
{{ chart|json_script:"saju-chart-data" }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const resultDataElem = document.getElementById('saju-result-data');
        if (resultDataElem) {
            const rawMarkdown = JSON.parse(resultDataElem.textContent);

            // marked ì˜µì…˜ ì„¤ì •
            marked.setOptions({
                breaks: true,
                gfm: true
            });

            // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜ (DOMPurifyë¡œ XSS ë°©ì§€)
            const htmlContent = DOMPurify.sanitize(marked.parse(rawMarkdown));
            document.getElementById('markdownResult').innerHTML = htmlContent;

            // ì˜¤í–‰ ë°°ì§€ ìƒì„±
            detectAndShowElement(rawMarkdown);

            // ê³µìœ ì¹´ë“œ ì—…ë°ì´íŠ¸
            updateShareCard(rawMarkdown);
        }
    });

    // ì¼ê°„ ê°ì§€ ë° ì˜¤í–‰ ë°°ì§€ í‘œì‹œ
    function detectAndShowElement(markdown) {
        const badgeContainer = document.getElementById('elementBadge');
        if (!badgeContainer) return;

        // "ì¼ì£¼(ë‚˜): OO" ë˜ëŠ” "ì¼ê°„: O" íŒ¨í„´ì—ì„œ ì²« ê¸€ì(ì²œê°„) ì¶”ì¶œ
        // ë§ˆí¬ë‹¤ìš´(**)ì´ë‚˜ ê³µë°±ì´ ì„ì—¬ ìˆì–´ë„ ì¸ì‹í•˜ë„ë¡ ìˆ˜ì •
        const patterns = [
            /ì¼ì£¼[^:]*:\s*[\*\s]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/,
            /ì¼ê°„[^:]*:\s*[\*\s]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/,
            /ì¼ì£¼[^:]*:[^ê°€-í£]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/  // ì•ˆì „ì¥ì¹˜: í•œê¸€ ë‚˜ì˜¤ê¸° ì „ê¹Œì§€ íŠ¹ìˆ˜ë¬¸ì ê±´ë„ˆë›°ê¸°
        ];

        let detected = null;
        for (const pattern of patterns) {
            const match = markdown.match(pattern);
            if (match) {
                detected = match[1];
                break;
            }
        }

        if (detected && ELEMENT_MAP[detected]) {
            const info = ELEMENT_MAP[detected];
            badgeContainer.innerHTML = `
                <div class="element-badge ${info.element}">
                    <span class="element-icon">${info.icon}</span>
                    <span>${info.name}</span>
                    <span style="opacity: 0.8; font-weight: normal;">- ${info.desc}</span>
                </div>
            `;
        }
    }

    // ê³µìœ ì¹´ë“œ ì—…ë°ì´íŠ¸
    function updateShareCard(markdown) {
        // í…œí”Œë¦¿ ë³€ìˆ˜ì—ì„œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ê°€ì¥ ì •í™•í•¨)
        const nameContext = "{{ name|default:'ì„ ìƒë‹˜' }}";
        const titleElem = document.getElementById('shareCardTitle');
        if (titleElem) titleElem.textContent = `ğŸ”® ${nameContext} ì„ ìƒë‹˜ì˜ ì‚¬ì£¼`;

        // ì¼ê°„ ì •ë³´ ì—…ë°ì´íŠ¸
        for (const [char, info] of Object.entries(ELEMENT_MAP)) {
            if (markdown.includes(char)) {
                const iconElem = document.getElementById('shareCardElement')?.querySelector('.icon');
                const textElem = document.getElementById('shareCardElementText');
                if (iconElem) iconElem.textContent = info.icon;
                if (textElem) textElem.textContent = info.name;
                break;
            }
        }

        // í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œë„ (ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’)
        const keywordMatch = markdown.match(/í‚¤ì›Œë“œ[^"]*"([^"]+)"[^"]*"([^"]+)"[^"]*"([^"]+)"/);
        if (keywordMatch) {
            const keywordsContainer = document.getElementById('shareCardKeywords');
            if (keywordsContainer) {
                keywordsContainer.innerHTML = `
                    <span class="share-card-keyword">"${keywordMatch[1]}"</span>
                    <span class="share-card-keyword">"${keywordMatch[2]}"</span>
                    <span class="share-card-keyword">"${keywordMatch[3]}"</span>
                `;
            }
        }
        // í–‰ìš´ì˜ ìƒ‰ ì¶”ì¶œ ì‹œë„
        const colorMatch = markdown.match(/í–‰ìš´[^:]*ìƒ‰[^:]*[:ï¼š]\s*([ê°€-í£]+ìƒ‰?)/);
        if (colorMatch) {
            const colorElem = document.getElementById('shareCardLuckyColor');
            if (colorElem) colorElem.textContent = colorMatch[1];
        }
    }

    // ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
    function shareToKakao() {
        try {
            if (!Kakao.isInitialized()) {
                showToast('ì¹´ì¹´ì˜¤í†¡ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê²°ê³¼ ë‚´ìš©ì—ì„œ ì œëª©ê³¼ ê°„ë‹¨í•œ ìš”ì•½ ì¶”ì¶œ ì‹œë„
            const resultText = document.getElementById('markdownResult')?.innerText || '';
            const summary = resultText.substring(0, 100).replace(/\n/g, ' ') + '...';

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: 'ğŸ”® Eduitit AI ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼',
                    description: summary || 'ë‚˜ì˜ ìš´ì„¸ì™€ ì˜¤í–‰ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!',
                    imageUrl: 'https://images.unsplash.com/photo-1534346953335-519bb5a67c4a?q=80&w=600&auto=format&fit=crop', // Mystical background
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href,
                    },
                },
                buttons: [
                    {
                        title: 'ê²°ê³¼ í™•ì¸í•˜ê¸°',
                        link: {
                            mobileWebUrl: window.location.href,
                            webUrl: window.location.href,
                        },
                    },
                    {
                        title: 'ë‚˜ë„ ì‚¬ì£¼ë³´ê¸°',
                        link: {
                            mobileWebUrl: window.location.origin + '/fortune/saju/',
                            webUrl: window.location.origin + '/fortune/saju/',
                        },
                    },
                ],
            });
        } catch (e) {
            console.error('Kakao Share Error:', e);
            if (navigator.share) {
                navigator.share({
                    title: 'ğŸ”® AI ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼',
                    text: 'Eduititì—ì„œ ë‚´ ì‚¬ì£¼ë¥¼ ë¶„ì„í•´ë´¤ì–´ìš”!',
                    url: window.location.href
                });
            } else {
                copyLink();
            }
        }
    }

    // ë§í¬ ë³µì‚¬
    function copyLink() {
        const url = window.location.origin + '/fortune/saju/';
        navigator.clipboard.writeText(url).then(() => {
            showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });
    }

    // ì´ë¯¸ì§€ ì €ì¥
    function saveAsImage() {
        const shareCard = document.getElementById('shareCardContainer');
        if (!shareCard) return;

        shareCard.style.left = '0';
        shareCard.style.position = 'absolute';
        shareCard.style.zIndex = '-1';

        html2canvas(shareCard, {
            backgroundColor: null,
            scale: 2,
            useCORS: true
        }).then(canvas => {
            shareCard.style.left = '-9999px';
            const link = document.createElement('a');
            link.download = 'saju-result.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }).catch(err => {
            console.error(err);
            showToast('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ì¼ì§„(í•˜ë£¨ ìš´ì„¸) í™•ì¸ ë¡œì§
    async function checkDailyFortune() {
        const targetDate = document.getElementById('targetDateInput').value;
        if (!targetDate) return;

        // ê²°ê³¼ ì˜ì—­ì—ì„œ ëª…ì‹ ì¶”ì¶œ (ë˜ëŠ” ì´ë¯¸ ì €ì¥ëœ ë°ì´í„° ì‚¬ìš©)
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ ì„œë²„ì—ì„œ ì•„ê¹Œ ê³„ì‚°í•´ì¤€ chart ì •ë³´ë¥¼ í™œìš©í•˜ê±°ë‚˜ íŒŒì‹±
        const chartDataElem = document.getElementById('saju-chart-data');
        let natalChart = {};

        if (chartDataElem) {
            natalChart = JSON.parse(chartDataElem.textContent);
        } else {
            // Fallback to parsing from markdown if chart-data is missing
            const resultText = document.getElementById('markdownResult').innerText;
            const yearMatch = resultText.match(/ë…„ì£¼[^ê°€-í£]*[:ï¼š]\s*([ê°€-í£]{2})/);
            const monthMatch = resultText.match(/ì›”ì£¼[^ê°€-í£]*[:ï¼š]\s*([ê°€-í£]{2})/);
            const dayMatch = resultText.match(/ì¼ì£¼[^ê°€-í£]*[:ï¼š]\s*([ê°€-í£]{2})/);
            const hourMatch = resultText.match(/ì‹œì£¼[^ê°€-í£]*[:ï¼š]\s*([ê°€-í£]{2})/);

            if (yearMatch) natalChart.year = yearMatch[1];
            if (monthMatch) natalChart.month = monthMatch[1];
            if (dayMatch) natalChart.day = dayMatch[1];
            if (hourMatch) natalChart.hour = hourMatch[1];
        }

        if (!natalChart.day) {
            showToast('ì›êµ­ ë¶„ì„ í›„ ì¼ì§„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
        }

        // ë¹„íšŒì› ë¯¸ë˜ ë‚ ì§œ ì œí•œ (ì˜ˆì‹œ)
        const isGuest = "{{ user.is_authenticated }}" === "False";
        const selectedDate = new Date(targetDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (isGuest && selectedDate > today) {
            alert('ì„ ìƒë‹˜, ë¯¸ë˜ì˜ ìš´ì„¸ëŠ” íšŒì›ê°€ì… í›„ì— í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”! ğŸ˜Š');
            return;
        }

        document.getElementById('loadingOverlay').classList.add('show');

        try {
            const response = await fetch('{% url "fortune:daily_fortune_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    target_date: targetDate,
                    natal_chart: natalChart,
                    name: "{{ name|default:'ì„ ìƒë‹˜' }}",
                    gender: "{{ gender|default:'female' }}"
                })
            });

            const data = await response.json();
            document.getElementById('loadingOverlay').classList.remove('show');

            if (response.status === 429) {
                alert(data.message);
                return;
            }

            if (data.success) {
                const dailyResultDiv = document.getElementById('dailyFortuneResult');
                const dailyContentDiv = document.getElementById('dailyFortuneContent');
                dailyContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(data.result));
                dailyResultDiv.classList.remove('hidden');
                dailyResultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                showToast(data.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (e) {
            document.getElementById('loadingOverlay').classList.remove('show');
            console.error(e);
            showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function saveToLibrary() {
        const resultText = document.getElementById('markdownResult').innerText;
        const chartDataElem = document.getElementById('saju-chart-data');
        let natalChart = {};

        if (chartDataElem) {
            natalChart = JSON.parse(chartDataElem.textContent);
        } else {
            const yearMatch = resultText.match(/ë…„ì£¼[^ê°€-í£]*[:ï¼š]\s*([ê°€-í£]{2})/);
            const monthMatch = resultText.match(/ì›”ì£¼[^ê°€-í£]*[:ï¼š]\s*([ê°€-í£]{2})/);
            const dayMatch = resultText.match(/ì¼ì£¼[^ê°€-í£]*[:ï¼š]\s*([ê°€-í£]{2})/);
            const hourMatch = resultText.match(/ì‹œì£¼[^ê°€-í£]*[:ï¼š]\s*([ê°€-í£]{2})/);

            if (yearMatch) natalChart.year = yearMatch[1];
            if (monthMatch) natalChart.month = monthMatch[1];
            if (dayMatch) natalChart.day = dayMatch[1];
            if (hourMatch) natalChart.hour = hourMatch[1];
        }

        // ì¼ì§„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ê°™ì´ ë³´ê´€ (ë˜ëŠ” ë”°ë¡œ ë³´ê´€)
        const dailyText = document.getElementById('dailyFortuneResult').classList.contains('hidden') ? null : document.getElementById('dailyFortuneContent').innerText;

        try {
            const response = await fetch('{% url "fortune:save_fortune_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    mode: dailyText ? 'daily' : 'teacher', // ê°„ë‹¨í•˜ê²Œ
                    natal_chart: natalChart,
                    result_text: dailyText ? dailyText : resultText,
                    target_date: dailyText ? document.getElementById('targetDateInput').value : null
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast('ì„±ê³µì ìœ¼ë¡œ ë³´ê´€í•¨ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ');
            } else {
                showToast('ì €ì¥ ì‹¤íŒ¨: ' + data.error);
            }
        } catch (e) {
            showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>
{% endif %}
{% endblock %}