{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* 寃곌낵 諛뺤뒪 ?좊땲硫붿씠??*/
    [data-aos] {
        pointer-events: none;
    }

    [data-aos].aos-animate {
        pointer-events: auto;
    }

    /* 留덊겕?ㅼ슫 ?ㅽ???而ㅼ뒪? */
    .markdown-body {
        font-family: 'NanumSquareRound', sans-serif;
        font-size: 1.05rem;
        line-height: 1.7;
        color: #4a5568;
        word-break: keep-all;
        overflow-wrap: break-word;
    }

    .markdown-body table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
        display: block;
        overflow-x: auto;
    }

    .markdown-body th,
    .markdown-body td {
        border: 1px solid #e2e8f0;
        padding: 0.75rem;
        text-align: left;
    }

    .markdown-body th {
        background-color: #f7fafc;
        font-weight: bold;
    }

    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3 {
        color: #2d3748;
        font-weight: bold;
        margin-top: 2rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid #edf2f7;
        padding-bottom: 0.5rem;
    }

    .markdown-body h1 {
        font-size: 1.75rem;
    }

    .markdown-body h2 {
        font-size: 1.5rem;
    }

    .markdown-body h3 {
        font-size: 1.25rem;
    }

    .markdown-body p {
        margin-bottom: 1.2rem;
    }

    .markdown-body ul,
    .markdown-body ol {
        margin-bottom: 1.5rem;
        padding-left: 2rem;
    }

    .markdown-body li {
        margin-bottom: 0.5rem;
    }

    .markdown-body blockquote {
        border-left: 6px solid #a78bfa;
        background: #f3f4f6;
        padding: 1rem 1.5rem;
        border-radius: 0 16px 16px 0;
        margin: 1.5rem 0;
        font-style: italic;
    }

    .markdown-body strong {
        color: #7c3aed;
        background: linear-gradient(120deg, rgba(167, 139, 250, 0.2) 0%, rgba(167, 139, 250, 0.2) 100%);
        background-repeat: no-repeat;
        background-size: 100% 40%;
        background-position: 0 80%;
    }

    /* ?ㅽ뻾 諭껋? ?ㅽ???*/
    .element-badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 8px 18px;
        border-radius: 100px;
        font-size: 1.1rem;
        font-weight: 800;
        color: white;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .element-badge.wood {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .element-badge.fire {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .element-badge.earth {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .element-badge.metal {
        background: linear-gradient(135deg, #94a3b8, #64748b);
    }

    .element-badge.water {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .element-icon {
        font-size: 2rem;
    }

    /* ========================================
       怨듭쑀 踰꾪듉 ?ㅽ???
       ======================================== */
    .share-section {
        margin-top: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 24px;
        border: 2px solid #e2e8f0;
    }

    .share-title {
        font-size: 1.1rem;
        font-weight: 800;
        color: #64748b;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .share-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .share-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 14px 24px;
        border-radius: 16px;
        font-size: 1.4rem;
        font-weight: bold;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
    }

    .share-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .share-btn.kakao {
        background: #FEE500;
        color: #3C1E1E;
    }

    .share-btn.link {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
    }

    .share-btn.image {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        color: white;
    }

    /* ========================================
       怨듭쑀移대뱶 ?ㅽ???(?대?吏 ??μ슜)
       ======================================== */
    .share-card {
        position: fixed;
        left: -9999px;
        width: 600px;
        padding: 40px;
        background: linear-gradient(145deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        border-radius: 32px;
        color: white;
        font-family: 'NanumSquareRound', sans-serif;
    }

    .share-card-inner {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 32px;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .share-card-header {
        text-align: center;
        margin-bottom: 24px;
    }

    .share-card-title {
        font-size: 2.8rem;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .share-card-element {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 100px;
        font-size: 2rem;
        font-weight: bold;
        margin: 16px 0;
    }

    .share-card-element .icon {
        font-size: 2.4rem;
    }

    .share-card-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
    }

    .share-card-keyword {
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 100px;
        font-size: 1.6rem;
    }

    .share-card-fortune {
        text-align: center;
        padding: 16px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        margin: 16px 0;
    }

    .share-card-fortune-label {
        font-size: 1.4rem;
        opacity: 0.9;
        margin-bottom: 8px;
    }

    .share-card-fortune-value {
        font-size: 1.8rem;
        font-weight: bold;
    }

    .share-card-footer {
        text-align: center;
        margin-top: 24px;
        font-size: 1.4rem;
        opacity: 0.8;
    }

    .share-card-footer .logo {
        font-size: 1.8rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    /* ========================================
       ???ㅽ??쇰쭅 (?고듃 利앷?)
       ======================================== */
    .saju-input {
        width: 100%;
        padding: 1.2rem 1.5rem;
        background: #E0E5EC;
        border: none;
        border-radius: 18px;
        box-shadow: inset 6px 6px 10px 0 rgba(163, 177, 198, 0.7),
            inset -6px -6px 10px 0 rgba(255, 255, 255, 0.8);
        color: #4A5568;
        font-family: inherit;
        font-size: 1.6rem;
        transition: all 0.3s;
    }

    .saju-input:focus {
        outline: none;
        box-shadow: inset 8px 8px 12px 0 rgba(163, 177, 198, 0.8),
            inset -8px -8px 12px 0 rgba(255, 255, 255, 0.9);
    }

    .saju-input::placeholder {
        color: #a0aec0;
    }

    /* ?쇰뵒??踰꾪듉 ?ㅽ???*/
    .radio-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .radio-group label {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.9rem 1.5rem;
        background: #E0E5EC;
        border-radius: 14px;
        box-shadow: 5px 5px 10px rgba(163, 177, 198, 0.5),
            -5px -5px 10px rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1.5rem;
    }

    .radio-group label:hover {
        transform: translateY(-2px);
    }

    .radio-group input[type="radio"] {
        width: 22px;
        height: 22px;
        accent-color: #7c3aed;
    }

    .radio-group input[type="radio"]:checked+span {
        color: #7c3aed;
        font-weight: bold;
    }

    /* 紐⑤뱶 ?좉? ?ㅽ???*/
    .mode-toggle {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .mode-btn {
        flex: 1;
        padding: 1.5rem;
        background: #E0E5EC;
        border: none;
        border-radius: 22px;
        box-shadow: 7px 7px 14px rgba(163, 177, 198, 0.6),
            -7px -7px 14px rgba(255, 255, 255, 0.5);
        font-size: 1.6rem;
        font-weight: bold;
        color: #4A5568;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .mode-btn.active {
        background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%);
        color: white;
        box-shadow: inset 4px 4px 8px rgba(0, 0, 0, 0.1);
    }

    .mode-btn:not(.active):hover {
        transform: translateY(-2px);
        box-shadow: 9px 9px 18px rgba(163, 177, 198, 0.7),
            -9px -9px 18px rgba(255, 255, 255, 0.6);
    }

    .mode-btn span {
        display: block;
        font-size: 1.2rem;
        font-weight: normal;
        margin-top: 6px;
        opacity: 0.85;
    }

    /* 濡쒕뵫 ?ㅻ쾭?덉씠 */
    .loading-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(224, 229, 236, 0.95);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        gap: 1.5rem;
    }

    .loading-overlay.show {
        display: flex;
    }

    .loading-spinner {
        width: 70px;
        height: 70px;
        border: 6px solid #e9d5ff;
        border-top: 6px solid #7c3aed;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .loading-text {
        font-size: 2rem;
        color: #7c3aed;
        text-align: center;
    }

    /* 蹂듭궗 ?꾨즺 ?좎뒪??*/
    .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 16px 32px;
        border-radius: 100px;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: all 0.4s;
        z-index: 9999;
    }

    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
</style>
{% endblock %}

{% block content %}
<main class="pt-32 pb-20 px-4 md:px-8 min-h-screen max-w-4xl mx-auto">

    <!-- ?ㅻ뜑 -->
    <div class="text-center mb-12" data-aos="fade-down">
        <div class="w-28 h-28 mx-auto mb-6 rounded-full shadow-clay-inner flex items-center justify-center">
            <span class="text-6xl">?뵰</span>
        </div>
        <h1 class="text-5xl md:text-6xl font-bold text-gray-700 mb-4">
            ?ъ＜ <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-indigo-500">?댁꽭</span>
        </h1>
        <p class="text-xl text-gray-500 font-bold">
            AI媛 遺꾩꽍?섎뒗 ?섎쭔???ъ＜?붿옄? ?댁꽭
        </p>
    </div>

    {% if not result %}
    <!-- ?낅젰 ??-->
    <div class="clay-card p-8 md:p-12" data-aos="fade-up">

        <form method="post" id="sajuForm">
            {% csrf_token %}

            <!-- 紐⑤뱶 ?좏깮 -->
            <div class="mb-8">
                <label class="block text-2xl font-bold text-gray-600 mb-4">
                    <i class="fa-solid fa-wand-magic-sparkles text-purple-500 mr-2"></i>?곷떞 紐⑤뱶
                </label>
                <div class="mode-toggle">
                    <button type="button" class="mode-btn active" data-mode="teacher" onclick="setMode('teacher')">
                        <i class="fa-solid fa-chalkboard-user mr-2"></i>援먯궗 紐⑤뱶
                        <span>?숆탳?앺솢, ?숈깮 耳誘? ?숇즺 愿怨?/span>
                    </button>
                    <button type="button" class="mode-btn" data-mode="general" onclick="setMode('general')">
                        <i class="fa-solid fa-star mr-2"></i>?쇰컲 紐⑤뱶
                        <span>?щЪ, ?곗븷, 嫄닿컯, 吏곸뾽??/span>
                    </button>
                </div>
                <input type="hidden" name="mode" id="modeInput" value="teacher">
            </div>

            <!-- ?대쫫 -->
            <div class="mb-6">
                <label for="id_name" class="block text-2xl font-bold text-gray-600 mb-3">
                    <i class="fa-solid fa-user text-purple-500 mr-2"></i>?대쫫
                </label>
                <input type="text" name="name" id="id_name" class="saju-input" placeholder="?대쫫???낅젰?댁＜?몄슂" required
                    maxlength="20">
            </div>

            <!-- ?깅퀎 -->
            <div class="mb-6">
                <label class="block text-2xl font-bold text-gray-600 mb-3">
                    <i class="fa-solid fa-venus-mars text-purple-500 mr-2"></i>?깅퀎
                </label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="gender" value="male" required>
                        <span>?⑥옄</span>
                    </label>
                    <label>
                        <input type="radio" name="gender" value="female">
                        <span>?ъ옄</span>
                    </label>
                </div>
            </div>

            <!-- ?앸뀈?붿씪 -->
            <div class="mb-6">
                <label class="block text-2xl font-bold text-gray-600 mb-3">
                    <i class="fa-solid fa-cake-candles text-purple-500 mr-2"></i>?앸뀈?붿씪
                </label>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <input type="number" name="birth_year" class="saju-input" placeholder="?꾨룄" required min="1940"
                            max="2025">
                    </div>
                    <div>
                        <input type="number" name="birth_month" class="saju-input" placeholder="?? required min="1"
                            max="12">
                    </div>
                    <div>
                        <input type="number" name="birth_day" class="saju-input" placeholder="?? required min="1"
                            max="31">
                    </div>
                </div>
            </div>

            <!-- ?쒖뼱???쒓컙 -->
            <div class="mb-6">
                <label class="block text-2xl font-bold text-gray-600 mb-3">
                    <i class="fa-solid fa-clock text-purple-500 mr-2"></i>?쒖뼱???쒓컙 <span
                        class="text-gray-400 font-normal text-xl">(?좏깮)</span>
                </label>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <input type="number" name="birth_hour" class="saju-input" placeholder="??(0~23)" min="0"
                            max="23">
                    </div>
                    <div>
                        <input type="number" name="birth_minute" class="saju-input" placeholder="遺?(0~59)" min="0"
                            max="59">
                    </div>
                </div>
                <p class="text-gray-400 text-xl mt-3 ml-1">紐⑤Ⅴ?쒕㈃ 鍮꾩썙?먯꽭??/p>
            </div>

            <!-- ?묐젰/?뚮젰 -->
            <div class="mb-8">
                <label class="block text-2xl font-bold text-gray-600 mb-3">
                    <i class="fa-solid fa-calendar text-purple-500 mr-2"></i>?묐젰/?뚮젰
                </label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="calendar_type" value="solar" checked>
                        <span>?묐젰</span>
                    </label>
                    <label>
                        <input type="radio" name="calendar_type" value="lunar">
                        <span>?뚮젰</span>
                    </label>
                </div>
            </div>

            <!-- ?쒖텧 踰꾪듉 -->
            <button type="submit" class="w-full py-5 rounded-2xl text-white font-bold text-2xl transition-all
                bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600
                shadow-lg hover:shadow-xl hover:-translate-y-1">
                <i class="fa-solid fa-crystal-ball mr-2"></i>?ъ＜ 遺꾩꽍?섍린
            </button>
        </form>
    </div>

    {% else %}
    <!-- 寃곌낵 ?붾㈃ -->
    <div class="clay-card p-8 md:p-12" data-aos="fade-up" id="resultCard">

        {% if error %}
        <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-6 mb-8">
            <div class="flex items-center gap-3 text-red-600">
                <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                <span class="text-xl font-bold">{{ error }}</span>
            </div>
        </div>
        {% endif %}

        {% if result %}
        <!-- ?ㅽ뻾 諛곗? (JavaScript濡??숈쟻 ?앹꽦) -->
        <div id="elementBadge" class="text-center mb-6"></div>

        <!-- 留덊겕?ㅼ슫 寃곌낵 -->
        <div class="markdown-body" id="markdownResult"></div>

        <!-- 怨듭쑀 ?뱀뀡 -->
        <div class="share-section">
            <div class="share-title">
                <i class="fa-solid fa-share-nodes"></i>
                移쒓뎄?먭쾶 怨듭쑀?섍린
            </div>
            <div class="share-buttons">
                <button class="share-btn kakao" onclick="shareToKakao()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 3C6.48 3 2 6.48 2 10.5c0 2.53 1.67 4.75 4.17 6.02-.18.65-.66 2.35-.75 2.72-.12.47.17.46.36.34.15-.1 2.38-1.61 3.35-2.27.62.09 1.24.14 1.87.14 5.52 0 10-3.48 10-7.95S17.52 3 12 3z" />
                    </svg>
                    移댁뭅?ㅽ넚
                </button>
                <button class="share-btn link" onclick="copyLink()">
                    <i class="fa-solid fa-link"></i>
                    留곹겕 蹂듭궗
                </button>
                <button class="share-btn image" onclick="saveAsImage()">
                    <i class="fa-solid fa-image"></i>
                    ?대?吏 ???
                </button>
            </div>
        </div>

        <hr class="my-10 border-slate-200">

        <!-- ?뱀젙 ?좎쭨 ?댁꽭 (?쇱쭊) -->
        <div class="bg-indigo-50/50 rounded-3xl p-8 border border-indigo-100 mb-8">
            <div class="flex items-center gap-3 mb-6">
                <div
                    class="w-10 h-10 bg-indigo-600/10 text-indigo-600 rounded-xl flex items-center justify-center text-xl">
                    <i class="fa-solid fa-calendar-check"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-black text-slate-700">?좎쭨蹂??댁꽭 ?뺤씤</h3>
                    <p class="text-slate-500 font-medium">以묒슂???됱궗??紐⑥엫???덈뒗 ?좎쓽 ?댁꽭瑜??뺤씤?대낫?몄슂.</p>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-center">
                <input type="date" id="targetDateInput" value="{% now 'Y-m-d' %}"
                    class="flex-1 w-full bg-white border-2 border-indigo-100 rounded-2xl p-4 text-xl font-bold text-slate-700 focus:outline-none focus:border-indigo-500 transition-all">
                <button onclick="checkDailyFortune()"
                    class="w-full md:w-auto px-8 py-4 bg-indigo-600 hover:bg-neutral-800 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                    ?댁꽭 蹂닿린
                </button>
            </div>

            <div id="dailyFortuneResult" class="mt-8 hidden animate-in fade-in slide-in-from-top duration-500">
                <div class="bg-white rounded-2xl p-6 border border-indigo-50 shadow-sm markdown-body"
                    id="dailyFortuneContent">
                    <!-- JS Populated -->
                </div>
            </div>
        </div>

        {% if user.is_authenticated %}
        <div class="bg-purple-50/50 rounded-3xl p-8 border border-purple-100">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 bg-purple-600/10 text-purple-600 rounded-2xl flex items-center justify-center text-2xl">
                        <i class="fa-solid fa-bookmark"></i>
                    </div>
                    <div class="text-left">
                        <h4 class="text-xl font-black text-slate-700">??寃곌낵 蹂닿??섍린</h4>
                        <p class="text-slate-500 font-medium">?좎깮?섎쭔???댁꽭 蹂닿??⑥뿉 ??ν빐?먭퀬 ?몄젣??爰쇰궡蹂댁꽭??</p>
                    </div>
                </div>
                <button onclick="saveToLibrary()"
                    class="px-8 py-4 bg-purple-600 hover:bg-neutral-800 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                    蹂닿??⑥뿉 ???
                </button>
            </div>
        </div>
        {% else %}
        <div class="bg-slate-100/50 rounded-3xl p-8 border border-slate-200">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 bg-slate-400 text-white rounded-2xl flex items-center justify-center text-2xl">
                        <i class="fa-solid fa-lock"></i>
                    </div>
                    <div class="text-left">
                        <h4 class="text-xl font-black text-slate-700">寃곌낵 ???諛??쇱쭊 臾댁젣???뺤씤</h4>
                        <p class="text-slate-500 font-medium">媛?낇븯?쒕㈃ ??寃곌낵瑜???ν븯怨?紐⑤뱺 ?좎쭨???댁꽭瑜?蹂????덉뼱?? ?삃</p>
                    </div>
                </div>
                <a href="{% url 'account_signup' %}"
                    class="px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                    媛?낇븯怨??쒗깮 諛쏄린
                </a>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <div class="mt-10 text-center">
            <a href="{% url 'fortune:saju' %}" class="inline-block px-12 py-5 rounded-2xl text-white font-bold text-2xl
                    bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600
                    shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">
                <i class="fa-solid fa-rotate-left mr-2"></i>?ㅼ떆 蹂닿린
            </a>
        </div>
    </div>

    <!-- 怨듭쑀移대뱶 (?대?吏 ??μ슜, ?붾㈃??蹂댁씠吏 ?딆쓬) -->
    <div id="shareCardContainer" class="share-card">
        <div class="share-card-inner">
            <div class="share-card-header">
                <div class="share-card-title" id="shareCardTitle">?뵰 ?ъ＜ 遺꾩꽍</div>
                <div class="share-card-element" id="shareCardElement">
                    <span class="icon">?뷂툘</span>
                    <span id="shareCardElementText">寃쎄툑(佯싮뇫)</span>
                </div>
            </div>
            <div class="share-card-keywords" id="shareCardKeywords">
                <span class="share-card-keyword">"?덈줈???쒖옉"</span>
                <span class="share-card-keyword">"?꾩쟾"</span>
                <span class="share-card-keyword">"?깆옣"</span>
            </div>
            <div class="share-card-fortune">
                <div class="share-card-fortune-label">?? ?됱슫????/div>
                <div class="share-card-fortune-value" id="shareCardLuckyColor">?뚮???/div>
            </div>
            <div class="share-card-footer">
                <div class="logo">?뵰 Eduitit ?ъ＜ ?댁꽭</div>
                <div style="margin-top: 8px; font-size: 1.2rem;">eduitit.up.railway.app</div>
            </div>
        </div>
    </div>
    {% endif %}

</main>

<!-- ?좎뒪??硫붿떆吏 -->
<div id="toast" class="toast">
    <i class="fa-solid fa-check-circle mr-2"></i>
    <span id="toastMessage">留곹겕媛 蹂듭궗?섏뿀?듬땲??</span>
</div>

<!-- 濡쒕뵫 ?ㅻ쾭?덉씠 -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">
        ?ъ＜瑜?遺꾩꽍?섍퀬 ?덉뼱??..<br>
        <span class="text-xl opacity-70">?좎떆留?湲곕떎?ㅼ＜?몄슂</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 留덊겕?ㅼ슫 ?뚯꽌 -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- XSS 諛⑹???sanitizer -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<!-- ?대?吏 ??μ슜 ?쇱씠釉뚮윭由?-->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!-- 移댁뭅??SDK -->
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.6.0/kakao.min.js"></script>

<script>
    // 移댁뭅??SDK 珥덇린??
    if ("{{ kakao_js_key }}") {
        Kakao.init("{{ kakao_js_key }}");
        console.log("Kakao SDK Initialized:", Kakao.isInitialized());
    }

    // ?ㅽ뻾蹂??대え?곗퐯 留ㅽ븨
    const ELEMENT_MAP = {
        '媛?: { element: 'wood', icon: '?뙰', name: '媛묐ぉ(?꿩쑉)', desc: '???섎Т' },
        '??: { element: 'wood', icon: '?뙼', name: '?꾨ぉ(阿숁쑉)', desc: '?, ?앹엥' },
        '蹂?: { element: 'fire', icon: '?截?, name: '蹂묓솕(訝숂겓)', desc: '?쒖뼇' },
        '??: { element: 'fire', icon: '?빉截?, name: '?뺥솕(訝곭겓)', desc: '珥쏅텋' },
        '臾?: { element: 'earth', icon: '?곤툘', name: '臾댄넗(?딇넗)', desc: '???? },
        '湲?: { element: 'earth', icon: '?룘截?, name: '湲고넗(藥긷쐿)', desc: '?쇰강' },
        '寃?: { element: 'metal', icon: '?뷂툘', name: '寃쎄툑(佯싮뇫)', desc: '移? 諛붿쐞' },
        '??: { element: 'metal', icon: '?뭿', name: '?좉툑(渦쏃뇫)', desc: '蹂댁꽍' },
        '??: { element: 'water', icon: '?뙄', name: '?꾩닔(鶯ф객)', desc: '諛붾떎' },
        '怨?: { element: 'water', icon: '?뮛', name: '怨꾩닔(?멩객)', desc: '鍮? ?댁뒳' }
    };

    // 紐⑤뱶 ?좉?
    function setMode(mode) {
        document.getElementById('modeInput').value = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.mode === mode) {
                btn.classList.add('active');
            }
        });
    }

    // ???쒖텧 ??濡쒕뵫 ?쒖떆
    document.getElementById('sajuForm')?.addEventListener('submit', function () {
        document.getElementById('loadingOverlay').classList.add('show');
    });

    // ?좎뒪??硫붿떆吏
    function showToast(message) {
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMessage');
        if (toast && toastMsg) {
            toastMsg.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    }
</script>

{% if result %}
{{ result|json_script:"saju-result-data" }}
{{ chart|json_script:"saju-chart-data" }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const resultDataElem = document.getElementById('saju-result-data');
        if (resultDataElem) {
            const rawMarkdown = JSON.parse(resultDataElem.textContent);

            // marked ?듭뀡 ?ㅼ젙
            marked.setOptions({
                breaks: true,
                gfm: true
            });

            // 留덊겕?ㅼ슫??HTML濡?蹂??(DOMPurify濡?XSS 諛⑹?)
            const htmlContent = DOMPurify.sanitize(marked.parse(rawMarkdown));
            document.getElementById('markdownResult').innerHTML = htmlContent;

            // ?ㅽ뻾 諛곗? ?앹꽦
            detectAndShowElement(rawMarkdown);

            // 怨듭쑀移대뱶 ?낅뜲?댄듃
            updateShareCard(rawMarkdown);
        }
    });

    // ?쇨컙 媛먯? 諛??ㅽ뻾 諛곗? ?쒖떆
    function detectAndShowElement(markdown) {
        const badgeContainer = document.getElementById('elementBadge');
        if (!badgeContainer) return;

        // ?쇨컙(泥쒓컙) 媛먯? ?⑦꽩
        const patterns = [
            /?쇨컙[^媛-??*[:\s]*[^\s]*\**(媛???蹂???臾?湲?寃?????怨?/i,
            /\**(媛???蹂???臾?湲?寃?????怨?\s*\(/i,
            /泥쒓컙[^媛-??*(媛???蹂???臾?湲?寃?????怨?/i
        ];

        let detected = null;
        for (const pattern of patterns) {
            const match = markdown.match(pattern);
            if (match) {
                detected = match[1];
                break;
            }
        }

        if (detected && ELEMENT_MAP[detected]) {
            const info = ELEMENT_MAP[detected];
            badgeContainer.innerHTML = `
                <div class="element-badge ${info.element}">
                    <span class="element-icon">${info.icon}</span>
                    <span>${info.name}</span>
                    <span style="opacity: 0.8; font-weight: normal;">- ${info.desc}</span>
                </div>
            `;
        }
    }

    // 怨듭쑀移대뱶 ?낅뜲?댄듃
    function updateShareCard(markdown) {
        // ?쒕ぉ?먯꽌 ?대쫫 異붿텧
        const nameMatch = markdown.match(/# ?뵰\s*([^\s]+)\s*(?좎깮????/);
        if (nameMatch) {
            const titleElem = document.getElementById('shareCardTitle');
            if (titleElem) titleElem.textContent = `?뵰 ${nameMatch[1]} ${nameMatch[2]}???ъ＜`;
        }

        // ?쇨컙 ?뺣낫 ?낅뜲?댄듃
        for (const [char, info] of Object.entries(ELEMENT_MAP)) {
            if (markdown.includes(char)) {
                const iconElem = document.getElementById('shareCardElement')?.querySelector('.icon');
                const textElem = document.getElementById('shareCardElementText');
                if (iconElem) iconElem.textContent = info.icon;
                if (textElem) textElem.textContent = info.name;
                break;
            }
        }

        // ?ㅼ썙??異붿텧 (?ы빐???ㅼ썙???뱀뀡?먯꽌)
        const keywordMatch = markdown.match(/?ㅼ썙??^"]*"([^"]+)"[^"]*"([^"]+)"[^"]*"([^"]+)"/);
        if (keywordMatch) {
            const keywordsContainer = document.getElementById('shareCardKeywords');
            if (keywordsContainer) {
                keywordsContainer.innerHTML = `
                    <span class="share-card-keyword">"${keywordMatch[1]}"</span>
                    <span class="share-card-keyword">"${keywordMatch[2]}"</span>
                    <span class="share-card-keyword">"${keywordMatch[3]}"</span>
                `;
            }
        }

        // ?됱슫????異붿텧
        const colorMatch = markdown.match(/?됱슫[^:]*??^:]*[:竊?\s*([媛-??+??)/);
        if (colorMatch) {
            const colorElem = document.getElementById('shareCardLuckyColor');
            if (colorElem) colorElem.textContent = colorMatch[1];
        }
    }

    // 移댁뭅?ㅽ넚 怨듭쑀
    function shareToKakao() {
        try {
            if (!Kakao.isInitialized()) {
                showToast('移댁뭅?ㅽ넚 ?곌껐 以묒엯?덈떎. ?좎떆 ???ㅼ떆 ?쒕룄?댁＜?몄슂.');
                return;
            }

            // 寃곌낵 ?댁슜?먯꽌 ?쒕ぉ怨?媛꾨떒???붿빟 異붿텧 ?쒕룄
            const resultText = document.getElementById('markdownResult')?.innerText || '';
            const summary = resultText.substring(0, 100).replace(/\n/g, ' ') + '...';

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: '?뵰 Eduitit AI ?ъ＜ 遺꾩꽍 寃곌낵',
                    description: summary || '?섏쓽 ?댁꽭? ?ㅽ뻾 遺꾩꽍 寃곌낵瑜??뺤씤?대낫?몄슂!',
                    imageUrl: 'https://images.unsplash.com/photo-1534346953335-519bb5a67c4a?q=80&w=600&auto=format&fit=crop', // Mystical background
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href,
                    },
                },
                buttons: [
                    {
                        title: '寃곌낵 ?뺤씤?섍린',
                        link: {
                            mobileWebUrl: window.location.href,
                            webUrl: window.location.href,
                        },
                    },
                    {
                        title: '?섎룄 ?ъ＜蹂닿린',
                        link: {
                            mobileWebUrl: window.location.origin + '/fortune/saju/',
                            webUrl: window.location.origin + '/fortune/saju/',
                        },
                    },
                ],
            });
        } catch (e) {
            console.error('Kakao Share Error:', e);
            if (navigator.share) {
                navigator.share({
                    title: '?뵰 AI ?ъ＜ 遺꾩꽍 寃곌낵',
                    text: 'Eduitit?먯꽌 ???ъ＜瑜?遺꾩꽍?대뇬?댁슂!',
                    url: window.location.href
                });
            } else {
                copyLink();
            }
        }
    }

    // 留곹겕 蹂듭궗
    function copyLink() {
        const url = window.location.origin + '/fortune/saju/';
        navigator.clipboard.writeText(url).then(() => {
            showToast('留곹겕媛 蹂듭궗?섏뿀?듬땲??');
        }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('留곹겕媛 蹂듭궗?섏뿀?듬땲??');
        });
    }

    // ?대?吏 ???
    function saveAsImage() {
        const shareCard = document.getElementById('shareCardContainer');
        if (!shareCard) return;

        shareCard.style.left = '0';
        shareCard.style.position = 'absolute';
        shareCard.style.zIndex = '-1';

        html2canvas(shareCard, {
            backgroundColor: null,
            scale: 2,
            useCORS: true
        }).then(canvas => {
            shareCard.style.left = '-9999px';
            const link = document.createElement('a');
            link.download = 'saju-result.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('?대?吏媛 ??λ릺?덉뒿?덈떎!');
        }).catch(err => {
            console.error(err);
            showToast('?대?吏 ??μ뿉 ?ㅽ뙣?덉뒿?덈떎.');
        });
    }

    // ?쇱쭊(?섎（ ?댁꽭) ?뺤씤 濡쒖쭅
    async function checkDailyFortune() {
        const targetDate = document.getElementById('targetDateInput').value;
        if (!targetDate) return;

        // 寃곌낵 ?곸뿭?먯꽌 紐낆떇 異붿텧 (?먮뒗 ?대? ??λ맂 ?곗씠???ъ슜)
        // ?ш린?쒕뒗 媛꾨떒?섍쾶 ?쒕쾭?먯꽌 ?꾧퉴 怨꾩궛?댁? chart ?뺣낫瑜??쒖슜?섍굅???뚯떛
        const chartDataElem = document.getElementById('saju-chart-data');
        let natalChart = {};

        if (chartDataElem) {
            natalChart = JSON.parse(chartDataElem.textContent);
        } else {
            // Fallback to parsing from markdown if chart-data is missing
            const resultText = document.getElementById('markdownResult').innerText;
            const yearMatch = resultText.match(/?꾩＜[^媛-??*[:竊?\s*([媛-??{2})/);
            const monthMatch = resultText.match(/?붿＜[^媛-??*[:竊?\s*([媛-??{2})/);
            const dayMatch = resultText.match(/?쇱＜[^媛-??*[:竊?\s*([媛-??{2})/);
            const hourMatch = resultText.match(/?쒖＜[^媛-??*[:竊?\s*([媛-??{2})/);

            if (yearMatch) natalChart.year = yearMatch[1];
            if (monthMatch) natalChart.month = monthMatch[1];
            if (dayMatch) natalChart.day = dayMatch[1];
            if (hourMatch) natalChart.hour = hourMatch[1];
        }

        if (!natalChart.day) {
            showToast('?먭뎅 遺꾩꽍 ???쇱쭊???뺤씤?????덉뒿?덈떎.');
            return;
        }

        // 鍮꾪쉶??誘몃옒 ?좎쭨 ?쒗븳 (?덉떆)
        const isGuest = "{{ user.is_authenticated }}" === "False";
        const selectedDate = new Date(targetDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (isGuest && selectedDate > today) {
            alert('?좎깮?? 誘몃옒???댁꽭???뚯썝媛???꾩뿉 ?뺤씤?섏떎 ???덉뼱?? ?삃');
            return;
        }

        document.getElementById('loadingOverlay').classList.add('show');

        try {
            const response = await fetch('{% url "fortune:daily_fortune_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    target_date: targetDate,
                    natal_chart: natalChart,
                    name: "{{ name|default:'?좎깮?? }}",
                    gender: "{{ gender|default:'female' }}"
                })
            });

            const data = await response.json();
            document.getElementById('loadingOverlay').classList.remove('show');

            if (response.status === 429) {
                alert(data.message);
                return;
            }

            if (data.success) {
                const dailyResultDiv = document.getElementById('dailyFortuneResult');
                const dailyContentDiv = document.getElementById('dailyFortuneContent');
                dailyContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(data.result));
                dailyResultDiv.classList.remove('hidden');
                dailyResultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                showToast(data.error || '遺꾩꽍 以??ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
            }
        } catch (e) {
            document.getElementById('loadingOverlay').classList.remove('show');
            console.error(e);
            showToast('?쒕쾭 ?듭떊 ?ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        }
    }

    async function saveToLibrary() {
        const resultText = document.getElementById('markdownResult').innerText;
        const chartDataElem = document.getElementById('saju-chart-data');
        let natalChart = {};

        if (chartDataElem) {
            natalChart = JSON.parse(chartDataElem.textContent);
        } else {
            const yearMatch = resultText.match(/?꾩＜[^媛-??*[:竊?\s*([媛-??{2})/);
            const monthMatch = resultText.match(/?붿＜[^媛-??*[:竊?\s*([媛-??{2})/);
            const dayMatch = resultText.match(/?쇱＜[^媛-??*[:竊?\s*([媛-??{2})/);
            const hourMatch = resultText.match(/?쒖＜[^媛-??*[:竊?\s*([媛-??{2})/);

            if (yearMatch) natalChart.year = yearMatch[1];
            if (monthMatch) natalChart.month = monthMatch[1];
            if (dayMatch) natalChart.day = dayMatch[1];
            if (hourMatch) natalChart.hour = hourMatch[1];
        }

        // ?쇱쭊 寃곌낵媛 ?덉쑝硫?媛숈씠 蹂닿? (?먮뒗 ?곕줈 蹂닿?)
        const dailyText = document.getElementById('dailyFortuneResult').classList.contains('hidden') ? null : document.getElementById('dailyFortuneContent').innerText;

        try {
            const response = await fetch('{% url "fortune:save_fortune_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    mode: dailyText ? 'daily' : 'teacher', // 媛꾨떒?섍쾶
                    natal_chart: natalChart,
                    result_text: dailyText ? dailyText : resultText,
                    target_date: dailyText ? document.getElementById('targetDateInput').value : null
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast('?깃났?곸쑝濡?蹂닿??⑥뿉 ??λ릺?덉뒿?덈떎! ?럞');
            } else {
                showToast('????ㅽ뙣: ' + data.error);
            }
        } catch (e) {
            showToast('?쒕쾭 ?듭떊 ?ㅻ쪟媛 諛쒖깮?덉뒿?덈떎.');
        }
    }
</script>
{% endif %}
{% endblock %}
