{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* ê²°ê³¼ ë°•ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
    [data-aos] {
        pointer-events: none;
    }

    [data-aos].aos-animate {
        pointer-events: auto;
    }

    /* ========================================
       Premium Result Design Variables
       ======================================== */
    :root {
        --main-bg: #f8fafc;
        --premium-purple: #7c3aed;
        --premium-indigo: #6366f1;
        --glass-bg: rgba(255, 255, 255, 0.7);
        --glass-border: 1px solid rgba(255, 255, 255, 0.5);
        --clay-shadow: 8px 8px 16px rgba(160, 170, 190, 0.2), -6px -6px 14px rgba(255, 255, 255, 0.8);
    }

    /* Result Pillar styling (Refined Alignment) */
    .pillar-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.1rem;
        padding: 0.75rem 0.25rem;
        border-radius: 1.25rem;
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: var(--clay-shadow);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: var(--glass-border);
        min-width: 60px;
        aspect-ratio: 1 / 1.6;
    }

    .pillar-top {
        font-size: 0.7rem;
        letter-spacing: -0.02em;
        font-weight: 800;
        color: #94a3b8;
        margin-bottom: 2px;
    }

    .pillar-main {
        font-size: 1.8rem;
        font-weight: 900;
        line-height: 1;
        font-family: 'NanumGothic', serif;
    }

    .pillar-sub {
        font-size: 0.7rem;
        font-weight: 700;
        color: #64748b;
        margin-top: 4px;
    }

    /* Hero Section Visual Hierarchy */
    .shadow-clay-inner {
        box-shadow: inset 4px 4px 8px rgba(165, 175, 195, 0.15), inset -4px -4px 8px rgba(255, 255, 255, 0.8);
    }

    #stemIconBig {
        min-width: 4.5rem;
        min-height: 4.5rem;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .clay-card {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.7);
        border-radius: 2rem;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
    }

    /* Mobile Optimization: Horizontal Scroll Prevention */
    body {
        overflow-x: hidden;
        touch-action: pan-y;
    }

    /* Capture Only Styles */
    .capture-active {
        width: 800px !important;
        margin: 0 auto !important;
        background-color: #F8FAF6 !important;
        padding-top: 20px !important;
    }

    .capture-active .no-print {
        display: none !important;
    }

    .capture-active #markdownResult {
        columns: 1 !important;
    }

    /* Fix Alignment & Rendering for html2canvas */
    /* Fix Alignment & Rendering for html2canvas */
    .capture-active #premiumBadge {
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        height: auto !important;
        line-height: 1.2 !important;
        padding: 4px 10px !important;
        /* Adjusted padding for vertical center */
        border-radius: 9999px !important;
        backdrop-filter: none !important;
        background-color: white !important;
        border: 1px solid #e2e8f0 !important;
        vertical-align: middle !important;
        margin-top: -2px !important;
        /* Slight visual lift */
    }

    .capture-active #badgeIcon {
        display: inline-block !important;
        vertical-align: middle !important;
        margin-right: 4px !important;
        margin-bottom: 2px !important;
        /* Icon adjustment */
    }

    .capture-active #badgeText {
        display: inline-block !important;
        vertical-align: middle !important;
        font-size: 0.9rem !important;
        margin-top: 1px !important;
        /* Text baseline adjustment */
    }

    .capture-active #stemIconBig {
        display: table-cell !important;
        /* The Primitive Fix: Table Cell always holds vertical center */
        vertical-align: middle !important;
        text-align: center !important;
        width: 4.5rem !important;
        height: 4.5rem !important;
        background-color: white !important;
        box-shadow: none !important;
        border: 1px solid #e2e8f0 !important;
        padding: 0 !important;
        font-size: 2.5rem !important;
        border-radius: 1rem !important;
    }

    .capture-active #stemStaticName {
        background: none !important;
        background-image: none !important;
        -webkit-background-clip: initial !important;
        background-clip: initial !important;
        color: #4f46e5 !important;
        -webkit-text-fill-color: initial !important;
        font-weight: 900 !important;
        display: block !important;
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1.2 !important;
    }

    /* Highlight Alignment Fix (html2canvas baseline correction) */
    /* Highlight Alignment Fix: Solid background for html2canvas */
    .capture-active .analysis-content strong {
        background: rgba(124, 58, 237, 0.1) !important;
        box-shadow: none !important;
        padding: 0 0.2rem !important;
        border-radius: 4px !important;
        display: inline !important;
        line-height: inherit !important;
        vertical-align: baseline !important;
        margin: 0 !important;
        color: #7c3aed !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    /* Simulate slight padding without layout shift */


    .capture-active .pillar-box {
        display: block !important;
        text-align: center !important;
        padding: 12px 4px !important;
        backdrop-filter: none !important;
        background-color: white !important;
        height: auto !important;
    }

    .capture-active .pillar-main {
        display: block !important;
        line-height: 1.2 !important;
        margin: 2px 0 !important;
    }

    .capture-active .pillar-top,
    .capture-active .pillar-sub {
        display: block !important;
        line-height: 1 !important;
    }

    .analysis-content p {
        font-size: 1.05rem;
        line-height: 1.6;
        color: #334155;
        margin-bottom: 1.25rem;
        text-align: justify;
    }

    .analysis-content strong {
        color: var(--premium-purple);
        font-weight: 800;
        background: linear-gradient(120deg, rgba(124, 58, 237, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%);
        padding: 0 0.2rem;
        border-radius: 4px;
    }

    .analysis-content li {
        position: relative;
        padding-left: 1.5rem;
        margin-bottom: 0.75rem;
        font-size: 1.05rem;
        line-height: 1.5;
    }

    .analysis-content li::before {
        content: "âœ¦";
        position: absolute;
        left: 0;
        color: var(--premium-purple);
        opacity: 0.7;
    }

    /* ========================================
       Element Colors (Oí–‰ ìƒ‰ìƒ)
       ======================================== */
    .color-wood {
        color: #10b981 !important;
    }

    .color-fire {
        color: #ef4444 !important;
    }

    .color-earth {
        color: #f59e0b !important;
    }

    .color-metal {
        color: #8b5cf6 !important;
    }

    .color-water {
        color: #3b82f6 !important;
    }

    /* ========================================
       ê³µìœ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ì´ë¯¸ì§€ ì €ì¥ìš©)
       ======================================== */
    .share-card {
        position: fixed;
        left: -9999px;
        width: 600px;
        padding: 40px;
        background: linear-gradient(145deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        border-radius: 32px;
        color: white;
        font-family: 'NanumSquareRound', sans-serif;
    }

    .share-card-inner {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 32px;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .share-card-header {
        text-align: center;
        margin-bottom: 24px;
    }

    .share-card-title {
        font-size: 2.8rem;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .share-card-element {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        background: rgba(255, 255, 255, 0.25);
        border-radius: 100px;
        font-size: 2rem;
        font-weight: bold;
        margin: 16px 0;
    }

    .share-card-element .icon {
        font-size: 2.4rem;
    }

    .share-card-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
    }

    .share-card-keyword {
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 100px;
        font-size: 1.6rem;
    }

    .share-card-fortune {
        text-align: center;
        padding: 16px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        margin: 16px 0;
    }

    .share-card-fortune-label {
        font-size: 1.4rem;
        opacity: 0.9;
        margin-bottom: 8px;
    }

    .share-card-fortune-value {
        font-size: 1.8rem;
        font-weight: bold;
    }

    .share-card-footer {
        text-align: center;
        margin-top: 24px;
        font-size: 1.4rem;
        opacity: 0.8;
    }

    .share-card-footer .logo {
        font-size: 1.8rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    /* ========================================
       í¼ ìŠ¤íƒ€ì¼ë§ (í°íŠ¸ ì¦ê°€)
       ======================================== */
    .saju-input {
        width: 100%;
        padding: 1.2rem 1.5rem;
        background: #E0E5EC;
        border: none;
        border-radius: 18px;
        box-shadow: inset 6px 6px 10px 0 rgba(163, 177, 198, 0.7),
            inset -6px -6px 10px 0 rgba(255, 255, 255, 0.8);
        color: #4A5568;
        font-family: inherit;
        font-size: 1.6rem;
        transition: all 0.3s;
    }

    .saju-input:focus {
        outline: none;
        box-shadow: inset 8px 8px 12px 0 rgba(163, 177, 198, 0.8),
            inset -8px -8px 12px 0 rgba(255, 255, 255, 0.9);
    }

    .saju-input::placeholder {
        color: #a0aec0;
    }

    /* ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .radio-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .radio-group label {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.9rem 1.5rem;
        background: #E0E5EC;
        border-radius: 14px;
        box-shadow: 5px 5px 10px rgba(163, 177, 198, 0.5),
            -5px -5px 10px rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1.5rem;
    }

    .radio-group label:hover {
        transform: translateY(-2px);
    }

    .radio-group input[type="radio"] {
        width: 22px;
        height: 22px;
        accent-color: #7c3aed;
    }

    .radio-group input[type="radio"]:checked+span {
        color: #7c3aed;
        font-weight: bold;
    }

    /* ëª¨ë“œ í† ê¸€ ìŠ¤íƒ€ì¼ */
    .mode-toggle {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .mode-btn {
        flex: 1;
        padding: 1.5rem;
        background: #E0E5EC;
        border: none;
        border-radius: 22px;
        box-shadow: 7px 7px 14px rgba(163, 177, 198, 0.6),
            -7px -7px 14px rgba(255, 255, 255, 0.5);
        font-size: 1.6rem;
        font-weight: bold;
        color: #4A5568;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .mode-btn.active {
        background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%);
        color: white;
        box-shadow: inset 4px 4px 8px rgba(0, 0, 0, 0.1);
    }

    .mode-btn:not(.active):hover {
        transform: translateY(-2px);
        box-shadow: 9px 9px 18px rgba(163, 177, 198, 0.7),
            -9px -9px 18px rgba(255, 255, 255, 0.6);
    }

    .mode-btn span {
        display: block;
        font-size: 1.2rem;
        font-weight: normal;
        margin-top: 6px;
        opacity: 0.85;
    }

    /* í”„ë¦¬ë¯¸ì—„ ë¡œë”© ëª¨ë‹¬ */
    .loading-modal {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .loading-modal.show {
        display: flex;
    }

    .modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(12px);
    }

    .modal-content {
        position: relative;
        background: linear-gradient(145deg, #7c3aed, #4f46e5);
        border-radius: 32px;
        padding: 3.5rem 2.5rem;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        color: white;
    }

    .bagua-spinner {
        font-size: 5rem;
        animation: rotate360 4s linear infinite;
        margin-bottom: 2rem;
        filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.4));
    }

    @keyframes rotate360 {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes scaleIn {
        from {
            transform: scale(0.9);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .modal-title {
        font-size: 1.75rem;
        font-weight: 900;
        margin-bottom: 0.75rem;
        letter-spacing: -0.025em;
    }

    .modal-subtitle {
        font-size: 1.125rem;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 2.5rem;
        line-height: 1.6;
        font-weight: 500;
    }

    .loading-progress-bar {
        height: 10px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 100px;
        overflow: hidden;
        margin-bottom: 1.5rem;
        position: relative;
    }

    .loading-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #fbbf24, #f59e0b);
        border-radius: 100px;
        width: 0%;
        transition: width 0.3s ease;
        box-shadow: 0 0 15px rgba(245, 158, 11, 0.6);
    }

    .modal-tip {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        font-style: normal;
        font-weight: 500;
    }

    /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ê°œì„  */
    .toast {
        position: fixed;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: rgba(31, 41, 55, 0.95);
        /* ì„¸ë ¨ëœ ë‹¤í¬ ê·¸ë ˆì´ */
        backdrop-filter: blur(8px);
        color: white;
        padding: 14px 28px;
        border-radius: 20px;
        font-size: 1.2rem;
        font-weight: 600;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 9999;
        width: calc(100% - 40px);
        max-width: 450px;
        text-align: center;
        word-break: keep-all;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    /* í† ìŠ¤íŠ¸ ìƒ‰ìƒ í…Œë§ˆ */
    .toast.success {
        background: linear-gradient(135deg, #059669, #10b981);
    }

    .toast.error {
        background: linear-gradient(135deg, #dc2626, #ef4444);
    }

    .toast.info {
        background: linear-gradient(135deg, #4f46e5, #6366f1);
    }

    /* ========================================
       í”„ë¡œí•„ ì¹´ë“œ ìŠ¤íƒ€ì¼
       ======================================== */
    .profile-card {
        min-width: 280px;
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .profile-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        border-color: rgba(139, 92, 246, 0.3);
    }

    .profile-card.default {
        border-color: #8b5cf6;
        background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
    }

    .profile-card-header {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }

    .profile-icon {
        width: 3.5rem;
        height: 3.5rem;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        flex-shrink: 0;
    }

    .profile-info {
        flex: 1;
    }

    .profile-label {
        font-size: 0.85rem;
        color: #8b5cf6;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .profile-name {
        font-size: 1.5rem;
        font-weight: 900;
        color: #1e293b;
        margin: 0.25rem 0;
    }

    .profile-date {
        font-size: 0.95rem;
        color: #64748b;
        font-weight: 600;
    }

    .default-badge {
        position: absolute;
        top: 0;
        right: 0;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 800;
    }

    .profile-card-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .profile-btn {
        padding: 0.75rem 1rem;
        border-radius: 12px;
        font-weight: 700;
        font-size: 0.9rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
        white-space: nowrap;
    }

    .profile-btn.primary {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
        flex: 1.5;
    }

    .profile-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    .profile-btn:not(.primary):not(.danger) {
        background: #f1f5f9;
        color: #64748b;
    }

    .profile-btn:not(.primary):not(.danger):hover {
        background: #e2e8f0;
    }

    .profile-btn.danger {
        background: #fee2e2;
        color: #dc2626;
    }

    .profile-btn.danger:hover {
        background: #fecaca;
    }

    /* ========================================
       ì¼ì§„ ê²°ê³¼ ìŠ¤íƒ€ì¼ (ê°€ë…ì„± í–¥ìƒ)
       ======================================== */
    #dailyFortuneContent {
        font-size: 1.05rem;
        line-height: 1.8;
    }

    #dailyFortuneContent h2 {
        font-size: 1.75rem;
        font-weight: 800;
        margin-top: 2rem;
        margin-bottom: 1rem;
        color: #4338ca;
        border-bottom: 3px solid #e0e7ff;
        padding-bottom: 0.5rem;
    }

    #dailyFortuneContent h2:first-child {
        margin-top: 0;
    }

    #dailyFortuneContent h3 {
        font-size: 1.35rem;
        font-weight: 700;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        color: #5b21b6;
    }

    #dailyFortuneContent hr {
        border: none;
        border-top: 2px dashed #e0e7ff;
        margin: 2rem 0;
    }

    #dailyFortuneContent ul {
        list-style: none;
        padding-left: 0;
        margin: 1rem 0;
    }

    #dailyFortuneContent li {
        padding-left: 1.5rem;
        margin-bottom: 0.75rem;
        position: relative;
    }

    #dailyFortuneContent li::before {
        content: "âœ¦";
        position: absolute;
        left: 0;
        color: #818cf8;
        font-weight: bold;
    }

    #dailyFortuneContent strong {
        color: #4338ca;
        font-weight: 700;
    }

    #dailyFortuneContent p {
        margin-bottom: 1rem;
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
        .profile-card {
            min-width: 260px;
        }

        #profileCardsContainer {
            -webkit-overflow-scrolling: touch;
        }

        #profileCardsContainer::-webkit-scrollbar {
            height: 4px;
        }

        #profileCardsContainer::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    }

    /* ========================================
       ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ìŠ¤íƒ€ì¼
       ======================================== */
    .favorite-date-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1rem;
        background: white;
        border-radius: 12px;
        border: 2px solid #f1f5f9;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .favorite-date-item:hover {
        border-color: #fbbf24;
        background: #fffbeb;
        transform: translateX(4px);
    }

    .favorite-date-item.past {
        opacity: 0.6;
    }

    .favorite-date-item.past:hover {
        opacity: 0.8;
        border-color: #cbd5e1;
        background: #f8fafc;
    }

    #favoriteDatesContainer::-webkit-scrollbar {
        width: 6px;
    }

    #favoriteDatesContainer::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block content %}
<main class="pt-32 pb-20 px-3 md:px-8 min-h-screen max-w-4xl mx-auto">

    <!-- ë¦¬ë§ˆì¸ë” ì•Œë¦¼ ë°°ë„ˆ -->
    <div id="reminderBanner" class="hidden mb-6 animate-in slide-in-from-top duration-500">
        <div class="clay-card p-6 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div
                        class="w-14 h-14 bg-amber-500 rounded-full flex items-center justify-center text-white text-2xl animate-bounce">
                        <i class="fa-solid fa-bell"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-black text-gray-800">ì˜¤ëŠ˜ì˜ ìš´ì„¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”! âœ¨</h3>
                        <p class="text-gray-600 font-medium">ì–´ì œ ì„¤ì •í•œ ì•Œë¦¼ì…ë‹ˆë‹¤</p>
                    </div>
                </div>
                <button onclick="dismissReminder()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="mb-8 no-print">
        <a href="{% url 'home' %}"
            class="inline-flex items-center gap-2 text-gray-500 hover:text-purple-500 transition font-bold">
            <i class="fa-solid fa-arrow-left"></i> ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
    </div>

    <!-- í—¤ë” -->
    <div class="text-center mb-12" data-aos="fade-down">
        <div class="w-28 h-28 mx-auto mb-6 rounded-full shadow-clay-inner flex items-center justify-center">
            <span class="text-6xl">ğŸ”®</span>
        </div>
        <h1 class="text-5xl md:text-6xl font-bold text-gray-700 mb-4">
            ì‚¬ì£¼ <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-indigo-500">ìš´ì„¸</span>
        </h1>
        <p class="text-xl text-gray-500 font-bold">
            AIê°€ ë¶„ì„í•˜ëŠ” ë‚˜ë§Œì˜ ì‚¬ì£¼íŒ”ìì™€ ìš´ì„¸
        </p>
    </div>

    {% if error %}
    <div class="clay-card p-6 mb-8 border-2 border-red-200 bg-red-50/50" data-aos="fade-up">
        <div class="flex items-start gap-4 text-red-600">
            <i class="fa-solid fa-circle-exclamation text-3xl mt-1"></i>
            <div>
                <h3 class="text-2xl font-bold mb-2">ë¶„ì„ ì¤‘ ì•Œë¦¼</h3>
                <p class="text-lg leading-relaxed">{{ error }}</p>
                {% if user.is_authenticated %}
                <a href="{% url 'settings' %}"
                    class="inline-block mt-4 px-6 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors">
                    ì„¤ì •ì—ì„œ API í‚¤ ë“±ë¡í•˜ê¸°
                </a>
                {% else %}
                <a href="{% url 'account_login' %}"
                    class="inline-block mt-4 px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-slate-800 transition-colors">
                    ë¡œê·¸ì¸/ê°€ì…í•˜ê¸°
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- í”„ë¡œí•„ ê´€ë¦¬ ì„¹ì…˜ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ) -->
    {% if user.is_authenticated %}
    <div id="profileManagerSection" class="mb-8">
        <div class="clay-card p-6 md:p-8" data-aos="fade-up">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-full flex items-center justify-center text-white text-2xl">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-gray-800">ë‚´ í”„ë¡œí•„</h3>
                        <p class="text-gray-600 font-medium text-base">ì—¬ëŸ¬ ì‚¬ëŒì˜ ì‚¬ì£¼ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
                    </div>
                </div>
                <button onclick="showProfileModal()"
                    class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl font-bold text-base hover:shadow-lg transition-all">
                    <i class="fa-solid fa-plus mr-2"></i>í”„ë¡œí•„ ì¶”ê°€
                </button>
            </div>

            <!-- í”„ë¡œí•„ ì¹´ë“œ ëª©ë¡ (ê°€ë¡œ ìŠ¤í¬ë¡¤) -->
            <div id="profileCardsContainer" class="overflow-x-auto pb-4 -mx-4 px-4">
                <div id="profileCards" class="flex gap-4 min-w-max">
                    <!-- í”„ë¡œí•„ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    <div class="text-center text-gray-400 py-8">
                        <i class="fa-solid fa-spinner fa-spin text-3xl mb-2"></i>
                        <p>í”„ë¡œí•„ ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¦ê²¨ì°¾ê¸° ë‚ ì§œ & í†µê³„ (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ) -->
    <!--
    {% if user.is_authenticated %}
    <div class="grid md:grid-cols-2 gap-6 mb-8">
        
        <div class="clay-card p-6" data-aos="fade-up">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-black text-gray-800">
                    <i class="fa-solid fa-star text-amber-500 mr-2"></i>
                    ì¦ê²¨ì°¾ê¸° ë‚ ì§œ
                </h3>
                <button onclick="showFavoriteDateModal()" class="text-amber-500 hover:text-amber-600">
                    <i class="fa-solid fa-plus text-2xl"></i>
                </button>
            </div>
            <div id="favoriteDatesContainer" class="space-y-2 max-h-60 overflow-y-auto">
                <p class="text-gray-400 text-center py-4">ë¡œë”© ì¤‘...</p>
            </div>
        </div>

        
        <div class="clay-card p-6" data-aos="fade-up" data-aos-delay="100">
            <h3 class="text-xl font-black text-gray-800 mb-4">
                <i class="fa-solid fa-chart-line text-indigo-500 mr-2"></i>
                í™œë™ í†µê³„
            </h3>
            <div id="statisticsContainer" class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-indigo-50 rounded-xl">
                    <span class="text-gray-700 font-bold">ì´ ì‚¬ì£¼ ë¶„ì„</span>
                    <span id="statTotalAnalyses" class="text-2xl font-black text-indigo-600">-</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-purple-50 rounded-xl">
                    <span class="text-gray-700 font-bold">ì¼ì§„ ì¡°íšŒ</span>
                    <span id="statTotalDaily" class="text-2xl font-black text-purple-600">-</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-green-50 rounded-xl">
                    <span class="text-gray-700 font-bold">ìµœê·¼ 7ì¼ í™œë™</span>
                    <span id="statRecentActivity" class="text-2xl font-black text-green-600">-</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    -->
    {% endif %} <!-- 742ë²ˆ ë¼ì¸ì˜ í”„ë¡œí•„ ê´€ë¦¬ ì„¹ì…˜ if ë‹«ê¸° -->

    <!-- ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ ì‚¬ì£¼ ì¹´ë“œ (ë¹ ë¥¸ ì ‘ê·¼) -->
    <div id="quickAccessContainer" class="hidden mb-8">
        <div class="clay-card p-8 md:p-10 bg-gradient-to-br from-purple-50/80 to-indigo-50/80 border-2 border-purple-200"
            data-aos="fade-up">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-16 h-16 bg-purple-600/10 rounded-full flex items-center justify-center text-4xl"
                    id="quickAccessIcon">
                    ğŸ”®
                </div>
                <div>
                    <h3 class="text-2xl font-black text-gray-800">ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ ì‚¬ì£¼</h3>
                    <p class="text-gray-600 font-medium">ì €ì¥ëœ ì •ë³´ë¡œ ë¹ ë¥´ê²Œ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”</p>
                </div>
            </div>

            <div class="bg-white/70 rounded-2xl p-6 mb-6">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">ì´ë¦„</div>
                        <div class="text-xl font-bold text-gray-800" id="quickAccessName">-</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">ì„±ë³„</div>
                        <div class="text-xl font-bold text-gray-800" id="quickAccessGender">-</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">ìƒë…„ì›”ì¼</div>
                        <div class="text-xl font-bold text-gray-800" id="quickAccessBirthDate">-</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500 mb-1">ìƒë‹´ ëª¨ë“œ</div>
                        <div class="text-xl font-bold text-gray-800" id="quickAccessMode">-</div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-3">
                <button onclick="manualRestoreResult()" id="quickViewResultBtn" class="hidden flex-1 py-5 rounded-2xl text-white font-bold text-2xl transition-all
                    bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600
                    shadow-lg hover:shadow-xl hover:-translate-y-1">
                    <i class="fa-solid fa-eye mr-2"></i>ë§ˆì§€ë§‰ ê²°ê³¼ ë°”ë¡œë³´ê¸°
                </button>
                <button onclick="showNewSajuForm()" class="flex-1 py-5 rounded-2xl font-bold text-2xl transition-all
                    bg-white text-gray-700 border-2 border-gray-300
                    hover:border-purple-400 hover:text-purple-600 hover:-translate-y-1">
                    <i class="fa-solid fa-plus mr-2"></i>ìƒˆë¡œìš´ ì‚¬ì£¼ ë¶„ì„í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- ì…ë ¥ í¼ ì„¹ì…˜ -->
    <div id="formContainer" class="{% if result %}hidden{% endif %}">
        <div id="globalErrorDisplay"
            class="hidden clay-card p-6 mb-8 border-2 border-red-200 bg-red-50/50 text-red-600 font-bold"
            data-aos="fade-up"></div>
        <div class="clay-card p-5 md:p-12" data-aos="fade-up">

            <form method="post" id="sajuForm">
                {% csrf_token %}

                <!-- ëª¨ë“œ ì„ íƒ (ì¼ë°˜ ëª¨ë“œ ì„ì‹œ ìˆ¨ê¹€ â€” ì¬í™œì„±í™”: ì•„ë˜ ì£¼ì„ í•´ì œ) -->
                <!-- MODE_TOGGLE_START
                <div class="mb-8">
                    <label class="block text-2xl font-bold text-gray-600 mb-4">
                        <i class="fa-solid fa-wand-magic-sparkles text-purple-500 mr-2"></i>ìƒë‹´ ëª¨ë“œ
                    </label>
                    <div class="mode-toggle">
                        <button type="button" class="mode-btn active" data-mode="teacher" onclick="setMode('teacher')">
                            <i class="fa-solid fa-chalkboard-user mr-2"></i>êµì‚¬ ëª¨ë“œ
                            <span>í•™êµìƒí™œ, í•™ìƒ ì¼€ë¯¸, ë™ë£Œ ê´€ê³„</span>
                        </button>
                        <button type="button" class="mode-btn" data-mode="general" onclick="setMode('general')">
                            <i class="fa-solid fa-moon mr-2"></i>ì¼ë°˜ ëª¨ë“œ
                            <span>ì¬ë¬¼, ì—°ì• , ê±´ê°•, ì§ì—…ìš´</span>
                        </button>
                    </div>
                </div>
                MODE_TOGGLE_END -->
                <input type="hidden" name="mode" id="modeInput" value="teacher">

                <!-- ì´ë¦„ -->
                <div class="mb-6">
                    <label for="id_name" class="block text-2xl font-bold text-gray-600 mb-3">
                        <i class="fa-solid fa-user text-purple-500 mr-2"></i>ì´ë¦„
                    </label>
                    <input type="text" name="name" id="id_name" class="saju-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required
                        maxlength="20">
                </div>

                <!-- ì„±ë³„ -->
                <div class="mb-6">
                    <label class="block text-2xl font-bold text-gray-600 mb-3">
                        <i class="fa-solid fa-venus-mars text-purple-500 mr-2"></i>ì„±ë³„
                    </label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="gender" value="male" required>
                            <span>ë‚¨ì</span>
                        </label>
                        <label>
                            <input type="radio" name="gender" value="female">
                            <span>ì—¬ì</span>
                        </label>
                    </div>
                </div>

                <!-- ìƒë…„ì›”ì¼ -->
                <div class="mb-6">
                    <label class="block text-2xl font-bold text-gray-600 mb-3">
                        <i class="fa-solid fa-cake-candles text-purple-500 mr-2"></i>ìƒë…„ì›”ì¼
                    </label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <input type="number" name="birth_year" class="saju-input" placeholder="ë…„ë„" required
                                min="1940" max="2025">
                        </div>
                        <div>
                            <input type="number" name="birth_month" class="saju-input" placeholder="ì›”" required min="1"
                                max="12">
                        </div>
                        <div>
                            <input type="number" name="birth_day" class="saju-input" placeholder="ì¼" required min="1"
                                max="31">
                        </div>
                    </div>
                </div>

                <!-- íƒœì–´ë‚œ ì‹œê°„ -->
                <div class="mb-6">
                    <label class="block text-2xl font-bold text-gray-600 mb-3">
                        <i class="fa-solid fa-clock text-purple-500 mr-2"></i>íƒœì–´ë‚œ ì‹œê°„ <span
                            class="text-gray-400 font-normal text-xl">(ì„ íƒ)</span>
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <input type="number" name="birth_hour" class="saju-input" placeholder="ì‹œ (0~23)" min="0"
                                max="23">
                        </div>
                        <div>
                            <input type="number" name="birth_minute" class="saju-input" placeholder="ë¶„ (0~59)" min="0"
                                max="59">
                        </div>
                    </div>
                    <p class="text-gray-400 text-xl mt-3 ml-1">ëª¨ë¥´ì‹œë©´ ë¹„ì›Œë‘ì„¸ìš”</p>
                </div>

                <!-- ì–‘ë ¥/ìŒë ¥ -->
                <div class="mb-8">
                    <label class="block text-2xl font-bold text-gray-600 mb-3">
                        <i class="fa-solid fa-calendar text-purple-500 mr-2"></i>ì–‘ë ¥/ìŒë ¥
                    </label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="calendar_type" value="solar" checked>
                            <span>ì–‘ë ¥</span>
                        </label>
                        <label>
                            <input type="radio" name="calendar_type" value="lunar">
                            <span>ìŒë ¥</span>
                        </label>
                    </div>
                </div>

                <!-- ì œì¶œ ë²„íŠ¼ -->
                <button type="submit" class="w-full py-5 rounded-2xl text-white font-bold text-2xl transition-all
                bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600
                shadow-lg hover:shadow-xl hover:-translate-y-1">
                    <i class="fa-solid fa-crystal-ball mr-2"></i>ì‚¬ì£¼ ë¶„ì„í•˜ê¸°
                </button>
            </form>
        </div>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ ì„¹ì…˜ (Compact Premium Redesign) -->
    <div id="resultContainer" class="{% if not result %}hidden{% endif %}">

        <!-- ìº¡ì²˜ ì˜ì—­ (íˆì–´ë¡œ ì¹´ë“œ + ë¶„ì„ ë‚´ìš© í¬í•¨) -->
        <div id="capture-area" class="relative z-10">
            <!-- 1. íˆì–´ë¡œ í†µí•© ì¹´ë“œ (ì¼ê°„ + ì‚¬ì£¼ ëª…ì‹) -->
            <div class="mb-8">
                <div class="clay-card overflow-hidden transition-transform hover:scale-[1.005]">
                    <div id="hero-bg" class="absolute inset-0 opacity-30 transition-colors duration-1000"></div>
                    <div class="relative p-4 md:p-8 grid md:grid-cols-12 gap-6 md:gap-10 items-center">
                        <!-- Left: Identity Section -->
                        <div
                            class="md:col-span-5 flex flex-col items-center md:items-start border-b md:border-b-0 md:border-r border-slate-200 border-dashed pb-6 md:pb-0 md:pr-6">
                            <div class="w-full flex justify-center md:justify-start mb-4">
                                <div class="inline-flex items-center justify-center gap-1 text-sm py-1 px-3 rounded-full border bg-white/50 backdrop-blur-sm shadow-sm"
                                    id="premiumBadge">
                                    <span id="badgeIcon">ğŸ”®</span> <span id="badgeText" class="font-bold">ë¶„ì„ ì¤‘...</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 w-full justify-center md:justify-start">
                                <div class="flex items-center justify-center text-4xl bg-white rounded-2xl shadow-clay-inner"
                                    id="stemIconBig">ğŸ”®</div>
                                <div class="flex-1 text-center md:text-left">
                                    <h2 class="text-2xl font-black leading-tight"><span id="stemStaticName"
                                            class="text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-indigo-600">...</span>
                                    </h2>
                                    <p class="text-sm text-gray-500 font-medium mt-1 leading-snug break-keep"
                                        id="stemStaticDesc">ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.</p>
                                </div>
                            </div>
                        </div>
                        <!-- Right: Natal Chart -->
                        <div class="md:col-span-7 w-full">
                            <div
                                class="bg-white/40 backdrop-blur-sm rounded-2xl p-4 border border-white/50 shadow-inner">
                                <div id="sajuChartDisplay" class="grid grid-cols-4 gap-2 md:gap-4">
                                    <!-- JS will populate chart here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. íƒ­ ë„¤ë¹„ê²Œì´ì…˜ (ìº¡ì²˜ ì œì™¸) -->
            <div class="flex overflow-x-auto gap-2 mb-6 scrollbar-hide px-1 no-print" id="analysisTabs">
                <button onclick="switchTab(this, 'summary')"
                    class="tab-btn active px-4 py-2 rounded-full font-bold whitespace-nowrap transition-all text-sm border border-transparent shadow-sm bg-white/80">ğŸ“Œ
                    í•µì‹¬ìš”ì•½</button>
                <button onclick="switchTab(this, 'personality')"
                    class="tab-btn px-4 py-2 rounded-full font-bold whitespace-nowrap transition-all text-sm border border-transparent hover:bg-white/80">ğŸ“œ
                    ê¸°ì§ˆ/ì„±ê²©</button>
                <button onclick="switchTab(this, 'wealth')"
                    class="tab-btn px-4 py-2 rounded-full font-bold whitespace-nowrap transition-all text-sm border border-transparent hover:bg-white/80">ğŸ’°
                    ì¬ë¬¼ìš´</button>
                <button onclick="switchTab(this, 'career')"
                    class="tab-btn px-4 py-2 rounded-full font-bold whitespace-nowrap transition-all text-sm border border-transparent hover:bg-white/80">ğŸ’¼
                    ì§ì—…/ì§„ë¡œ</button>
                <button onclick="switchTab(this, 'compatibility')"
                    class="tab-btn px-4 py-2 rounded-full font-bold whitespace-nowrap transition-all text-sm border border-transparent hover:bg-white/80">â¤ï¸
                    ì• ì •/ì¸ì—°</button>
            </div>

            <!-- 3. AI ë¶„ì„ ë‚´ìš© -->
            <div class="analysis-card relative overflow-hidden mb-10">
                <div id="markdownResult" class="analysis-content prose prose-slate max-w-none md:columns-2 md:gap-10">
                    {% if result %}{{ result|safe }}{% endif %}
                </div>
            </div>
        </div>

        <!-- 4. ê³µìœ  ì•¡ì…˜ ì¹´ë“œ -->
        <div class="clay-card p-6 bg-white/50 border border-white/60 mb-10 no-print" id="shareSection">
            <div class="flex flex-wrap gap-4 justify-center">
                <button onclick="shareToKakao()"
                    class="px-6 py-3 bg-[#FEE500] rounded-full font-bold flex items-center gap-2 hover:scale-105 transition shadow-sm"><i
                        class="fa-solid fa-comment"></i> ì¹´ì¹´ì˜¤ ê³µìœ </button>
                <button onclick="saveAsImage()"
                    class="px-6 py-3 bg-rose-500 text-white rounded-full font-bold flex items-center gap-2 hover:scale-105 transition shadow-sm"><i
                        class="fa-solid fa-image"></i> ì´ë¯¸ì§€ ì €ì¥</button>
                <button onclick="copyLink()"
                    class="px-6 py-3 bg-white rounded-full font-bold flex items-center gap-2 hover:scale-105 transition shadow-sm border border-gray-100"><i
                        class="fa-solid fa-link"></i> ë§í¬ ë³µì‚¬</button>
                <a href="{% url 'fortune:saju' %}"
                    class="px-6 py-3 bg-purple-500 text-white rounded-full font-bold flex items-center gap-2 hover:scale-105 transition shadow-sm"><i
                        class="fa-solid fa-house"></i> ì²˜ìŒìœ¼ë¡œ</a>
            </div>
        </div>

        <!-- íŠ¹ì • ë‚ ì§œ ìš´ì„¸ (ì¼ì§„) -->
        <div id="dailyFortuneSection"
            class="bg-indigo-50/50 rounded-3xl p-5 md:p-8 border border-indigo-100 mb-8 {% if not result %}hidden{% endif %}">
            <div class="flex items-center gap-3 mb-6">
                <div
                    class="w-10 h-10 bg-indigo-600/10 text-indigo-600 rounded-xl flex items-center justify-center text-xl">
                    <i class="fa-solid fa-calendar-check"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-black text-slate-700">ë‚ ì§œë³„ ìš´ì„¸ í™•ì¸</h3>
                    <p class="text-slate-500 font-medium">ì¤‘ìš”í•œ í–‰ì‚¬ë‚˜ ëª¨ì„ì´ ìˆëŠ” ë‚ ì˜ ìš´ì„¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.</p>
                </div>
            </div>

            <!-- ë¹ ë¥¸ ë‚ ì§œ ì„ íƒ ë²„íŠ¼ -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button type="button" onclick="setQuickDate(0)"
                    class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-xl font-bold text-base transition-all">
                    ì˜¤ëŠ˜
                </button>
                <button type="button" onclick="setQuickDate(1)"
                    class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-xl font-bold text-base transition-all">
                    ë‚´ì¼
                </button>
                <button type="button" onclick="setQuickDate(2)"
                    class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-xl font-bold text-base transition-all">
                    ëª¨ë ˆ
                </button>
                <button type="button" onclick="setQuickDate('weekend')"
                    class="px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-xl font-bold text-base transition-all">
                    ì´ë²ˆ ì£¼ë§
                </button>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-center">
                <input type="date" id="targetDateInput" value="{% now 'Y-m-d' %}"
                    class="flex-1 w-full bg-white border-2 border-indigo-100 rounded-2xl p-4 text-xl font-bold text-slate-700 focus:outline-none focus:border-indigo-500 transition-all">
                <button onclick="checkDailyFortune()"
                    class="w-full md:w-auto px-10 py-4 bg-indigo-600 hover:bg-neutral-800 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                    ìš´ì„¸ ë³´ê¸°
                </button>
            </div>

            <div id="dailyFortuneResult" class="mt-8 hidden animate-in fade-in slide-in-from-top duration-500">
                <!-- ì¼ì§„ ê²°ê³¼ ì¹´ë“œ -->
                <div
                    class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 rounded-3xl p-5 md:p-8 border border-indigo-100 shadow-lg">
                    <!-- ê²°ê³¼ ë‚´ìš© -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 border border-indigo-50 shadow-sm prose prose-slate max-w-none"
                        id="dailyFortuneContent">
                        <!-- JS Populated -->
                    </div>

                    <!-- ê³µìœ  ë²„íŠ¼ -->
                    <div class="flex flex-wrap gap-3 justify-center mt-6 pt-6 border-t border-indigo-100">
                        <button onclick="shareDailyToKakao()"
                            class="px-6 py-3 bg-[#FEE500] hover:bg-[#FDD835] rounded-full font-bold flex items-center gap-2 transition shadow-sm hover:shadow-md">
                            <i class="fa-solid fa-comment"></i> ì¹´ì¹´ì˜¤ ê³µìœ 
                        </button>
                        <button onclick="saveDailyAsImage()"
                            class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full font-bold flex items-center gap-2 transition shadow-sm hover:shadow-md">
                            <i class="fa-solid fa-image"></i> ì´ë¯¸ì§€ ì €ì¥
                        </button>
                        <button onclick="copyDailyLink()"
                            class="px-6 py-3 bg-white hover:bg-gray-50 rounded-full font-bold flex items-center gap-2 transition shadow-sm hover:shadow-md border border-gray-200">
                            <i class="fa-solid fa-link"></i> ë§í¬ ë³µì‚¬
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì €ì¥/ê°€ì… ìœ ë„ ì„¹ì…˜ (User Requested Removal) -->
        <!--
        <div id="saveSection" class="{% if not result %}hidden{% endif %}">
            {% if user.is_authenticated %}
            <div class="space-y-4">
                <div class="bg-purple-50/50 rounded-3xl p-8 border border-purple-100">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 bg-purple-600/10 text-purple-600 rounded-2xl flex items-center justify-center text-2xl">
                                <i class="fa-solid fa-bookmark"></i>
                            </div>
                            <div class="text-left">
                                <h4 class="text-xl font-black text-slate-700">ì´ ê²°ê³¼ ë³´ê´€í•˜ê¸°</h4>
                                <p class="text-slate-500 font-medium">ì„ ìƒë‹˜ë§Œì˜ ìš´ì„¸ ë³´ê´€í•¨ì— ì €ì¥í•´ë‘ê³  ì–¸ì œë“  êº¼ë‚´ë³´ì„¸ìš”.
                                </p>
                            </div>
                        </div>
                        <button onclick="saveToLibrary()"
                            class="px-8 py-4 bg-purple-600 hover:bg-neutral-800 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                            ë³´ê´€í•¨ì— ì €ì¥
                        </button>
                    </div>
                </div>

                <div class="bg-amber-50/50 rounded-3xl p-8 border border-amber-100">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 bg-amber-600/10 text-amber-600 rounded-2xl flex items-center justify-center text-2xl">
                                <i class="fa-solid fa-bell"></i>
                            </div>
                            <div class="text-left">
                                <h4 class="text-xl font-black text-slate-700">ë‚´ì¼ ìš´ì„¸ ì•Œë¦¼ ë°›ê¸°</h4>
                                <p class="text-slate-500 font-medium">ë‚´ì¼ ë‹¤ì‹œ ë°©ë¬¸í•˜ë©´ ë¦¬ë§ˆì¸ë”ë¥¼ í‘œì‹œí•´ë“œë¦´ê²Œìš”.</p>
                            </div>
                        </div>
                        <button onclick="setTomorrowReminder()"
                            class="px-8 py-4 bg-amber-500 hover:bg-amber-600 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                            ì•Œë¦¼ ì„¤ì •
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="bg-slate-100/50 rounded-3xl p-8 border border-slate-200">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 bg-slate-400 text-white rounded-2xl flex items-center justify-center text-2xl">
                            <i class="fa-solid fa-lock"></i>
                        </div>
                        <div class="text-left">
                            <h4 class="text-xl font-black text-slate-700">ë¶„ì„ ê²°ê³¼ ë³´ê´€ ë° ë¯¸ë˜ ì¼ì§„ í™•ì¸</h4>
                            <p class="text-slate-500 font-medium">íšŒì›ì´ ë˜ì‹œë©´ ë¶„ì„ëœ ì‚¬ì£¼ë¥¼ ì˜êµ¬ ë³´ê´€í•˜ê³  ë‚´ì¼ì˜ ìš´ì„¸ë„ ë¯¸ë¦¬
                                ë³¼ ìˆ˜ ìˆì–´ìš”. ğŸ˜Š</p>
                        </div>
                    </div>
                    <a href="{% url 'account_signup' %}?next={% url 'fortune:saju' %}"
                        class="px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black text-xl transition-all shadow-lg hover:-translate-y-1">
                        ê°€ì…í•˜ê³  í˜œíƒ ë°›ê¸°
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
        -->

        <div class="mt-10 text-center" id="restartSection">
            <button type="button" onclick="resetToForm()" class="inline-block px-12 py-5 rounded-2xl text-white font-bold text-2xl
                    bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600
                    shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">
                <i class="fa-solid fa-rotate-left mr-2"></i>ì •ë³´ ìˆ˜ì • / ë‹¤ë¥¸ ì‚¬ì£¼ ë³´ê¸°
            </button>
        </div>
    </div>
    </div>

    <!-- ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="favoriteDateModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4"
        onclick="closeFavoriteDateModalOnBackdrop(event)">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-black text-gray-800">
                    <i class="fa-solid fa-star text-amber-500 mr-2"></i>
                    ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ì¶”ê°€
                </h3>
                <button onclick="closeFavoriteDateModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <form id="favoriteDateForm" class="space-y-4">
                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ë‚ ì§œ</label>
                    <input type="date" id="favoriteDate" class="saju-input" required>
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ë¼ë²¨</label>
                    <input type="text" id="favoriteLabel" class="saju-input" placeholder="ì˜ˆ: ì‹œí—˜ì¼, ìƒì¼, ê¸°ë…ì¼" required
                        maxlength="50">
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ë©”ëª¨ (ì„ íƒ)</label>
                    <textarea id="favoriteMemo" class="saju-input" placeholder="ê°„ë‹¨í•œ ë©”ëª¨ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”" rows="3"></textarea>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeFavoriteDateModal()"
                        class="flex-1 py-4 bg-gray-200 text-gray-700 rounded-2xl font-bold text-lg hover:bg-gray-300 transition">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit"
                        class="flex-1 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl font-bold text-lg hover:shadow-lg transition">
                        ì €ì¥
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- í”„ë¡œí•„ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="profileModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4"
        onclick="closeProfileModalOnBackdrop(event)">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-black text-gray-800">
                    <i class="fa-solid fa-user-plus text-purple-500 mr-2"></i>
                    <span id="modalTitle">í”„ë¡œí•„ ì¶”ê°€</span>
                </h3>
                <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <form id="profileForm" class="space-y-4">
                <input type="hidden" id="profileId" value="">

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">í”„ë¡œí•„ ì´ë¦„</label>
                    <input type="text" id="profileName" class="saju-input" placeholder="ì˜ˆ: ë‚˜, ì—„ë§ˆ, ì¹œêµ¬" required
                        maxlength="20">
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ì‹¤ì œ ì´ë¦„</label>
                    <input type="text" id="personName" class="saju-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required
                        maxlength="20">
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ì„±ë³„</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="profileGender" value="male" required>
                            <span>ë‚¨ì</span>
                        </label>
                        <label>
                            <input type="radio" name="profileGender" value="female">
                            <span>ì—¬ì</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ìƒë…„ì›”ì¼</label>
                    <div class="grid grid-cols-3 gap-3">
                        <input type="number" id="profileBirthYear" class="saju-input" placeholder="ë…„ë„" required
                            min="1940" max="2025">
                        <input type="number" id="profileBirthMonth" class="saju-input" placeholder="ì›”" required min="1"
                            max="12">
                        <input type="number" id="profileBirthDay" class="saju-input" placeholder="ì¼" required min="1"
                            max="31">
                    </div>
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">íƒœì–´ë‚œ ì‹œê°„ (ì„ íƒ)</label>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="profileBirthHour" class="saju-input" placeholder="ì‹œ (0~23)" min="0"
                            max="23">
                        <input type="number" id="profileBirthMinute" class="saju-input" placeholder="ë¶„ (0~59)" min="0"
                            max="59">
                    </div>
                </div>

                <div>
                    <label class="block text-base font-bold text-gray-700 mb-2">ì–‘ë ¥/ìŒë ¥</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="profileCalendarType" value="solar" checked>
                            <span>ì–‘ë ¥</span>
                        </label>
                        <label>
                            <input type="radio" name="profileCalendarType" value="lunar">
                            <span>ìŒë ¥</span>
                        </label>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="closeProfileModal()"
                        class="flex-1 py-4 bg-gray-200 text-gray-700 rounded-2xl font-bold text-lg hover:bg-gray-300 transition">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit"
                        class="flex-1 py-4 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-2xl font-bold text-lg hover:shadow-lg transition">
                        ì €ì¥
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ê³µìœ ì¹´ë“œ (ì´ë¯¸ì§€ ì €ì¥ìš©, í™”ë©´ì— ë³´ì´ì§€ ì•ŠìŒ) -->
    <div id="shareCardContainer" class="share-card">
        <div class="share-card-inner">
            <div class="share-card-header">
                <div class="share-card-title" id="shareCardTitle">ğŸ”® ì‚¬ì£¼ ë¶„ì„</div>
                <div class="share-card-element" id="shareCardElement">
                    <span class="icon">âš”ï¸</span>
                    <span id="shareCardElementText">ê²½ê¸ˆ(åºšé‡‘)</span>
                </div>
            </div>
            <div class="share-card-keywords" id="shareCardKeywords">
                <span class="share-card-keyword">"ìƒˆë¡œìš´ ì‹œì‘"</span>
                <span class="share-card-keyword">"ë„ì „"</span>
                <span class="share-card-keyword">"ì„±ì¥"</span>
            </div>
            <div class="share-card-fortune">
                <div class="share-card-fortune-label">ğŸ€ í–‰ìš´ì˜ ìƒ‰</div>
                <div class="share-card-fortune-value" id="shareCardLuckyColor">íŒŒë€ìƒ‰</div>
            </div>
            <div class="share-card-footer">
                <div class="logo">ğŸ”® Eduitit ì‚¬ì£¼ ìš´ì„¸</div>
                <div style="margin-top: 8px; font-size: 1.2rem;">eduitit.site</div>
            </div>
        </div>
    </div>

</main>

<!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
<div id="toast" class="toast">
    <i class="fa-solid fa-check-circle mr-2"></i>
    <span id="toastMessage">ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
</div>

<!-- í”„ë¦¬ë¯¸ì—„ ë¡œë”© ëª¨ë‹¬ -->
<div id="loadingModal" class="loading-modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="bagua-spinner">ğŸ”®</div>
        <h2 class="modal-title" id="loadingTitle">ìš´ëª…ì˜ ì‹¤ì„ í’€ì–´ë‚´ëŠ” ì¤‘...</h2>
        <p class="modal-subtitle" id="loadingSubtitle">í•˜ëŠ˜ì˜ ë³„ì´ ë‹¹ì‹ ì˜ ì‚¬ì£¼ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>

        <div class="loading-progress-bar">
            <div id="loadingProgress" class="loading-progress-fill"></div>
        </div>

        <div class="modal-tip">
            ğŸ’¡ <b>Tip:</b> <span id="loadingTip">ì‹œê°„ì„ ëª¨ë¥¼ ê²½ìš° ì •ì˜¤(12ì‹œ)ë¡œ ê³„ì‚°ë¼ìš”</span>
        </div>

        <!-- ëŒ€ê¸° ì•ˆë‚´ (15ì´ˆ ì´ìƒ ê±¸ë¦´ ë•Œ í‘œì‹œ) -->
        <div id="loadingQueueNotice" style="display:none; margin-top:1.25rem; padding:1rem 1.25rem; background:rgba(124,58,237,0.08); border-radius:1rem; border:1px solid rgba(124,58,237,0.15); text-align:center;">
            <p style="font-size:0.95rem; color:#ffffff; font-weight:700; margin-bottom:0.3rem;">
                â˜• ì§€ê¸ˆ ë§ì€ ë¶„ë“¤ì´ ì‚¬ì£¼ë¥¼ ë³´ê³  ê³„ì„¸ìš”!
            </p>
            <p style="font-size:0.85rem; color:#ffffff; line-height:1.5;">
                ìˆœì„œëŒ€ë¡œ ë¶„ì„í•˜ê³  ìˆìœ¼ë‹ˆ ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.<br>
                í˜ì´ì§€ë¥¼ ë‹«ì§€ ì•Šìœ¼ì‹œë©´ ìë™ìœ¼ë¡œ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ë§ˆí¬ë‹¤ìš´ íŒŒì„œ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- XSS ë°©ì§€ìš© sanitizer -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<!-- ì´ë¯¸ì§€ ì €ì¥ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!-- ì¹´ì¹´ì˜¤ SDK -->
<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.6.0/kakao.min.js"></script>

<script>
    // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
    if ("{{ kakao_js_key }}") {
        Kakao.init("{{ kakao_js_key }}");
        console.log("Kakao SDK Initialized:", Kakao.isInitialized());
    }

    // Global State for Caching & Auto-Save
    window.currentSajuState = {
        natal_chart: null,
        mode: 'teacher',
        savedId: null,
        result_text: null
    };

    /**
     * Safe JSON Parse Helper
     * Prevents errors when parsing invalid JSON or HTML error pages
     * @param {string} text - Text to parse
     * @param {*} fallback - Fallback value if parsing fails
     * @returns {*} Parsed JSON or fallback value
     */
    function safeJSONParse(text, fallback = null) {
        if (!text) {
            console.warn("safeJSONParse: Empty text provided");
            return fallback;
        }

        try {
            const trimmed = text.trim();

            // Detect HTML error pages (starts with <!doctype or <html)
            if (trimmed.startsWith('<')) {
                console.error("safeJSONParse: HTML detected instead of JSON");
                return fallback;
            }

            // Attempt to parse
            return JSON.parse(trimmed);
        } catch (e) {
            console.error("safeJSONParse: JSON parse error:", e);
            console.error("safeJSONParse: Failed text:", text.substring(0, 100));
            return fallback;
        }
    }


    // UI Safe-guard: Ensure form is visible if no result
    document.addEventListener('DOMContentLoaded', () => {
        const resultContainer = document.getElementById('resultContainer');
        const formContainer = document.getElementById('formContainer');
        const hasResult = document.getElementById('markdownResult')?.innerHTML.trim().length > 0;

        if (!hasResult && resultContainer && !resultContainer.classList.contains('hidden')) {
            console.warn('UI State Correction: Hiding empty result, showing form.');
            resultContainer.classList.add('hidden');
            formContainer.classList.remove('hidden');
        }

        // Note: Automatic restoration removed to prevent confusion.
        // Restoration is now manual via the "Quick View Last Result" button.

        // [Restoration Plan] ë¯¸ì™„ë£Œëœ(ì—ëŸ¬ ë“±) ì…ë ¥ì´ ìˆìœ¼ë©´ ë³µêµ¬ ì‹œë„
        const pendingInput = localStorage.getItem('pending_saju_input');
        if (pendingInput) {
            try {
                const data = JSON.parse(pendingInput);
                const age = Date.now() - (data.timestamp || 0);
                if (age < 60 * 60 * 1000) { // 1ì‹œê°„ ì´ë‚´ ë°ì´í„°ë§Œ
                    restoreFormInputs(data);
                    showToast('ì…ë ¥í•˜ì‹œë˜ ì •ë³´ë¥¼ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤. âœ¨', 'info');
                }
                localStorage.removeItem('pending_saju_input');
            } catch (e) { console.warn("Restore failed", e); }
        }

        // ë§ˆì§€ë§‰ ì‚¬ì£¼ ì •ë³´ ë¡œë“œ ë° ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œ í‘œì‹œ
        loadLastSajuInfo();
    });

    // í¼ ì…ë ¥ê°’ ë³µêµ¬ í•¨ìˆ˜
    function restoreFormInputs(data) {
        const form = document.getElementById('sajuForm');
        if (!form) return;

        for (const [key, value] of Object.entries(data)) {
            const input = form.elements[key];
            if (input) {
                if (input.type === 'radio') {
                    const target = Array.from(form.elements[key]).find(r => r.value === value);
                    if (target) target.checked = true;
                } else {
                    input.value = value;
                }
            }
        }
        // ëª¨ë“œ í† ê¸€ ë™ê¸°í™”
        if (data.mode) setMode(data.mode);
    }

    // ë§ˆì§€ë§‰ ì‚¬ì£¼ ì •ë³´ ë¡œë“œ
    function loadLastSajuInfo() {
        const lastSajuInput = localStorage.getItem('lastSajuInput');
        const pendingResult = localStorage.getItem('pendingSajuResult');
        const quickAccessContainer = document.getElementById('quickAccessContainer');
        const formContainer = document.getElementById('formContainer');

        // ê²°ê³¼ê°€ ì´ë¯¸ í™”ë©´ì— ìˆìœ¼ë©´ ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œ í‘œì‹œí•˜ì§€ ì•ŠìŒ
        const hasResult = document.getElementById('markdownResult')?.innerHTML.trim().length > 0;
        if (hasResult) return;

        if (lastSajuInput) {
            try {
                const data = safeJSONParse(lastSajuInput, null);

                // 7ì¼ ì´ë‚´ ë°ì´í„°ë§Œ í‘œì‹œ
                const age = Date.now() - data.timestamp;
                if (age > 7 * 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('lastSajuInput');
                    formContainer?.classList.remove('hidden');
                    return;
                }

                // ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œ ì •ë³´ ì±„ìš°ê¸°
                const genderMap = { 'male': 'ë‚¨ì', 'female': 'ì—¬ì' };
                const modeMap = { 'teacher': 'êµì‚¬ ëª¨ë“œ', 'general': 'ì¼ë°˜ ëª¨ë“œ' };

                const nameEl = document.getElementById('quickAccessName');
                const genderEl = document.getElementById('quickAccessGender');
                const birthEl = document.getElementById('quickAccessBirthDate');
                const modeEl = document.getElementById('quickAccessMode');

                if (nameEl) nameEl.textContent = data.name || '-';
                if (genderEl) genderEl.textContent = genderMap[data.gender] || '-';
                if (birthEl) birthEl.textContent = `${data.birth_year}.${String(data.birth_month).padStart(2, '0')}.${String(data.birth_day).padStart(2, '0')}`;
                if (modeEl) modeEl.textContent = modeMap[data.mode] || '-';

                // ì¼ê°„ ì•„ì´ì½˜ í‘œì‹œ
                if (data.daystem && ELEMENT_MAP[data.daystem]) {
                    const iconEl = document.getElementById('quickAccessIcon');
                    if (iconEl) iconEl.textContent = ELEMENT_MAP[data.daystem].icon;
                }

                // ì €ì¥ëœ ê²°ê³¼ê°€ ìˆìœ¼ë©´ "ë°”ë¡œë³´ê¸°" ë²„íŠ¼ í™œì„±í™”
                if (pendingResult) {
                    const btn = document.getElementById('quickViewResultBtn');
                    if (btn) btn.classList.remove('hidden');
                }

                // UI ì „í™˜
                quickAccessContainer?.classList.remove('hidden');
                formContainer?.classList.add('hidden');
            } catch (e) {
                console.error('Failed to load last saju info:', e);
                localStorage.removeItem('lastSajuInput');
                formContainer?.classList.remove('hidden');
            }
        } else {
            formContainer?.classList.remove('hidden');
        }
    }

    // ìˆ˜ë™ ê²°ê³¼ ë³µì› (ë²„íŠ¼ í´ë¦­ ì‹œ)
    function manualRestoreResult() {
        document.getElementById('quickAccessContainer')?.classList.add('hidden');
        restorePendingSajuResult();
        showToast('ì´ì „ ë¶„ì„ ê²°ê³¼ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
    }

    // í¼ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ëŒì•„ê°€ê¸°
    function resetToForm() {
        const resultContainer = document.getElementById('resultContainer');
        const formContainer = document.getElementById('formContainer');

        if (resultContainer) resultContainer.classList.add('hidden');
        if (formContainer) {
            formContainer.classList.remove('hidden');
            // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // ì €ì¥ëœ ì •ë³´ë¡œ ë‹¤ì‹œ ë³´ê¸°
    function useLastSajuInfo() {
        const lastSajuInput = localStorage.getItem('lastSajuInput');
        if (!lastSajuInput) {
            showToast('ì €ì¥ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            const data = safeJSONParse(lastSajuInput, null);
            if (!data) {
                showToast('ì €ì¥ëœ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                localStorage.removeItem('lastSajuInput');
                return;
            }

            // í¼ í•„ë“œ ì±„ìš°ê¸°
            document.querySelector('[name="name"]').value = data.name || '';
            document.querySelector(`[name="gender"][value="${data.gender}"]`).checked = true;
            document.querySelector('[name="birth_year"]').value = data.birth_year || '';
            document.querySelector('[name="birth_month"]').value = data.birth_month || '';
            document.querySelector('[name="birth_day"]').value = data.birth_day || '';
            document.querySelector('[name="birth_hour"]').value = data.birth_hour || '';
            document.querySelector('[name="birth_minute"]').value = data.birth_minute || '';
            document.querySelector(`[name="calendar_type"][value="${data.calendar_type}"]`).checked = true;

            // ëª¨ë“œ ì„¤ì •
            setMode(data.mode || 'teacher');

            // ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œ ìˆ¨ê¸°ê³  ê²°ê³¼ë¡œ ì´ë™
            document.getElementById('quickAccessContainer').classList.add('hidden');

            // í¼ ìë™ ì œì¶œ
            document.getElementById('sajuForm').dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        } catch (e) {
            console.error('Failed to use last saju info:', e);
            showToast('ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ìƒˆë¡œìš´ ì‚¬ì£¼ ì…ë ¥
    function showNewSajuForm() {
        // ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œ ìˆ¨ê¸°ê¸°
        document.getElementById('quickAccessContainer').classList.add('hidden');
        // í¼ í‘œì‹œ
        document.getElementById('formContainer').classList.remove('hidden');
        // í¼ ì´ˆê¸°í™”
        document.getElementById('sajuForm').reset();
        setMode('teacher');
    }

    // ============================================
    // í”„ë¡œí•„ ê´€ë¦¬ í•¨ìˆ˜
    // ============================================

    let currentProfiles = [];

    // í”„ë¡œí•„ ëª©ë¡ ë¡œë“œ
    async function loadProfiles() {
        const isAuthenticated = "{{ user.is_authenticated }}" === "True";
        if (!isAuthenticated) return;

        try {
            const response = await fetch('{% url "fortune:profile_list_api" %}');
            const contentType = response.headers.get('content-type');

            if (contentType && contentType.includes('application/json')) {
                const data = await response.json();
                currentProfiles = data.profiles;
                renderProfileCards();
            } else {
                console.warn("[Mobile Debug] loadProfiles: Non-JSON response", response.status);
            }
        } catch (e) {
            console.error('Failed to load profiles:', e);
        }
    }

    // í”„ë¡œí•„ ì¹´ë“œ ë Œë”ë§
    function renderProfileCards() {
        const container = document.getElementById('profileCards');
        if (!container) return;

        if (currentProfiles.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-400 py-8 w-full">
                    <i class="fa-solid fa-user-plus text-5xl mb-4 opacity-50"></i>
                    <p class="text-lg">í”„ë¡œí•„ì„ ì¶”ê°€í•˜ì—¬ ì—¬ëŸ¬ ì‚¬ëŒì˜ ì‚¬ì£¼ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
                </div>
            `;
            return;
        }

        container.innerHTML = currentProfiles.map(profile => `
            <div class="profile-card ${profile.is_default ? 'default' : ''}" data-profile-id="${profile.id}">
                <div class="profile-card-header">
                    <div class="profile-icon">
                        ${profile.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'}
                    </div>
                    <div class="profile-info">
                        <div class="profile-label">${profile.profile_name}</div>
                        <div class="profile-name">${profile.person_name}</div>
                        <div class="profile-date">${profile.birth_date}</div>
                    </div>
                    ${profile.is_default ? '<div class="default-badge">ê¸°ë³¸</div>' : ''}
                </div>
                <div class="profile-card-actions">
                    <button onclick="selectProfile(${profile.id})" class="profile-btn primary">
                        <i class="fa-solid fa-bolt"></i> ì‚¬ì£¼ ë³´ê¸°
                    </button>
                    <button onclick="editProfile(${profile.id})" class="profile-btn">
                        <i class="fa-solid fa-edit"></i>
                    </button>
                    <button onclick="deleteProfile(${profile.id})" class="profile-btn danger">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // í”„ë¡œí•„ ì„ íƒ (í¼ ìë™ ì±„ìš°ê¸°)
    function selectProfile(profileId) {
        const profile = currentProfiles.find(p => p.id === profileId);
        if (!profile) return;

        // í¼ í•„ë“œ ì±„ìš°ê¸°
        document.querySelector('[name="name"]').value = profile.person_name;
        document.querySelector(`[name="gender"][value="${profile.gender}"]`).checked = true;
        document.querySelector('[name="birth_year"]').value = profile.birth_year;
        document.querySelector('[name="birth_month"]').value = profile.birth_month;
        document.querySelector('[name="birth_day"]').value = profile.birth_day;
        document.querySelector('[name="birth_hour"]').value = profile.birth_hour || '';
        document.querySelector('[name="birth_minute"]').value = profile.birth_minute || '';
        document.querySelector(`[name="calendar_type"][value="${profile.calendar_type}"]`).checked = true;

        // ë¹ ë¥¸ ì ‘ê·¼ ì¹´ë“œì™€ í”„ë¡œí•„ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        document.getElementById('quickAccessContainer')?.classList.add('hidden');
        document.getElementById('profileManagerSection')?.classList.add('hidden');

        // í¼ í‘œì‹œ ë° ìŠ¤í¬ë¡¤
        const formContainer = document.getElementById('formContainer');
        formContainer.classList.remove('hidden');
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

        showToast(`${profile.person_name} í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`, 'success');
    }

    // í”„ë¡œí•„ ëª¨ë‹¬ ì—´ê¸°
    function showProfileModal(profileId = null) {
        const modal = document.getElementById('profileModal');
        const form = document.getElementById('profileForm');
        const modalTitle = document.getElementById('modalTitle');

        form.reset();

        if (profileId) {
            const profile = currentProfiles.find(p => p.id === profileId);
            if (profile) {
                modalTitle.textContent = 'í”„ë¡œí•„ ìˆ˜ì •';
                document.getElementById('profileId').value = profile.id;
                document.getElementById('profileName').value = profile.profile_name;
                document.getElementById('personName').value = profile.person_name;
                document.querySelector(`[name="profileGender"][value="${profile.gender}"]`).checked = true;
                document.getElementById('profileBirthYear').value = profile.birth_year;
                document.getElementById('profileBirthMonth').value = profile.birth_month;
                document.getElementById('profileBirthDay').value = profile.birth_day;
                document.getElementById('profileBirthHour').value = profile.birth_hour || '';
                document.getElementById('profileBirthMinute').value = profile.birth_minute || '';
                document.querySelector(`[name="profileCalendarType"][value="${profile.calendar_type}"]`).checked = true;
            }
        } else {
            modalTitle.textContent = 'í”„ë¡œí•„ ì¶”ê°€';
            document.getElementById('profileId').value = '';
        }

        modal.classList.remove('hidden');
    }

    function editProfile(profileId) {
        showProfileModal(profileId);
    }

    // í”„ë¡œí•„ ëª¨ë‹¬ ë‹«ê¸°
    function closeProfileModal() {
        document.getElementById('profileModal').classList.add('hidden');
    }

    function closeProfileModalOnBackdrop(event) {
        if (event.target.id === 'profileModal') {
            closeProfileModal();
        }
    }

    // í”„ë¡œí•„ í¼ ì œì¶œ
    document.getElementById('profileForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const profileId = document.getElementById('profileId').value;
        const genderChecked = document.querySelector('[name="profileGender"]:checked');
        const calendarChecked = document.querySelector('[name="profileCalendarType"]:checked');

        if (!genderChecked || !calendarChecked) {
            showToast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const profileData = {
            profile_name: document.getElementById('profileName').value,
            person_name: document.getElementById('personName').value,
            gender: genderChecked.value,
            birth_year: parseInt(document.getElementById('profileBirthYear').value),
            birth_month: parseInt(document.getElementById('profileBirthMonth').value),
            birth_day: parseInt(document.getElementById('profileBirthDay').value),
            birth_hour: document.getElementById('profileBirthHour').value ? parseInt(document.getElementById('profileBirthHour').value) : null,
            birth_minute: document.getElementById('profileBirthMinute').value ? parseInt(document.getElementById('profileBirthMinute').value) : null,
            calendar_type: calendarChecked.value,
            is_default: currentProfiles.length === 0 // ì²« í”„ë¡œí•„ì´ë©´ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •
        };

        try {
            const url = profileId
                ? `{% url "fortune:profile_update_api" 0 %}`.replace('0', profileId)
                : '{% url "fortune:profile_create_api" %}';

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken.value
                },
                body: JSON.stringify(profileData)
            });

            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const errText = await response.text();
                console.error("[Mobile Debug] saveProfile Non-JSON:", errText.substring(0, 200));
                throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${response.status})`);
            }

            const data = await response.json();

            if (data.success) {
                closeProfileModal();
                await loadProfiles();
                showToast(profileId ? 'í”„ë¡œí•„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'í”„ë¡œí•„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                showToast('ì˜¤ë¥˜: ' + data.error, 'error');
            }
        } catch (e) {
            console.error(e);
            showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    });

    // í”„ë¡œí•„ ì‚­ì œ
    async function deleteProfile(profileId) {
        if (!confirm('ì´ í”„ë¡œí•„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        try {
            const response = await fetch(`{% url "fortune:profile_delete_api" 0 %}`.replace('0', profileId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken.value
                }
            });

            const data = await response.json();

            if (data.success) {
                await loadProfiles();
                showToast('í”„ë¡œí•„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        } catch (e) {
            showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í”„ë¡œí•„ ë¡œë“œ ë° ìºì‹œ ì •ë¦¬
    if ("{{ user.is_authenticated }}" === "True") {
        loadProfiles();
        loadFavoriteDates();
        loadStatistics();

        // Cleanup old saju caches (Invaliding v1 for new prompt)
        try {
            const todayStr = new Date().toISOString().split('T')[0];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key) continue;

                // 1. Clear ALL old v1 caches
                if (key.startsWith('saju_result_cache_') || key.startsWith('daily_saju_cache_')) {
                    localStorage.removeItem(key);
                    i--;
                    continue;
                }

                // 2. Clear expired v2 daily caches (keep only today)
                if (key.startsWith('daily_saju_v2_')) {
                    if (!key.endsWith(todayStr)) {
                        localStorage.removeItem(key);
                        i--;
                    }
                }
            }
        } catch (e) {
            console.warn("Cache cleanup failed", e);
        }
    }


    // ë¦¬ë§ˆì¸ë” í™•ì¸ (ëª¨ë“  ì‚¬ìš©ì)
    checkReminder();

    // ============================================
    // ì¦ê²¨ì°¾ê¸° ë‚ ì§œ í•¨ìˆ˜
    // ============================================

    let currentFavorites = [];

    // ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ë¡œë“œ
    async function loadFavoriteDates() {
        try {
            const response = await fetch('{% url "fortune:favorite_dates_api" %}');
            const contentType = response.headers.get('content-type');

            if (contentType && contentType.includes('application/json')) {
                const data = await response.json();
                currentFavorites = data.favorites;
                renderFavoriteDates();
            }
        } catch (e) {
            console.error('Failed to load favorites:', e);
        }
    }

    // ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ë Œë”ë§
    function renderFavoriteDates() {
        const container = document.getElementById('favoriteDatesContainer');
        if (!container) return;

        if (currentFavorites.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center py-4">ì¦ê²¨ì°¾ê¸°í•œ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤</p>';
            return;
        }

        container.innerHTML = currentFavorites.map(fav => {
            const isPast = fav.is_past;
            const daysText = isPast
                ? `${Math.abs(fav.days_until)}ì¼ ì „`
                : fav.days_until === 0
                    ? 'ì˜¤ëŠ˜'
                    : `D-${fav.days_until}`;

            return `
                <div class="favorite-date-item ${isPast ? 'past' : ''}" onclick="selectFavoriteDate('${fav.date}')">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-star text-amber-500"></i>
                            <span class="font-bold text-gray-800">${fav.label}</span>
                            <span class="text-sm ${isPast ? 'text-gray-400' : 'text-indigo-600'} font-bold">${daysText}</span>
                        </div>
                        <div class="text-sm text-gray-600 mt-1">${fav.date}</div>
                        ${fav.memo ? `<div class="text-sm text-gray-500 mt-1">${fav.memo}</div>` : ''}
                    </div>
                    <button onclick="deleteFavoriteDate(${fav.id}); event.stopPropagation();" class="text-red-400 hover:text-red-600">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `;
        }).join('');
    }

    // ì¦ê²¨ì°¾ê¸° ë‚ ì§œ ì„ íƒ
    function selectFavoriteDate(dateStr) {
        document.getElementById('targetDateInput').value = dateStr;
        document.getElementById('targetDateInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
        showToast('ë‚ ì§œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }

    // ì¦ê²¨ì°¾ê¸° ëª¨ë‹¬ ì—´ê¸°
    function showFavoriteDateModal() {
        const modal = document.getElementById('favoriteDateModal');
        document.getElementById('favoriteDateForm').reset();
        modal.classList.remove('hidden');
    }

    // ì¦ê²¨ì°¾ê¸° ëª¨ë‹¬ ë‹«ê¸°
    function closeFavoriteDateModal() {
        document.getElementById('favoriteDateModal').classList.add('hidden');
    }

    function closeFavoriteDateModalOnBackdrop(event) {
        if (event.target.id === 'favoriteDateModal') {
            closeFavoriteDateModal();
        }
    }

    // ì¦ê²¨ì°¾ê¸° ì¶”ê°€ (ì¼ì§„ í™•ì¸ í™”ë©´ì—ì„œ)
    async function addFavoriteDate() {
        const targetDateInput = document.getElementById('targetDateInput');
        if (!targetDateInput || !targetDateInput.value) {
            showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const label = prompt('ì´ ë‚ ì§œì˜ ë¼ë²¨ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‹œí—˜ì¼, ìƒì¼)');
        if (!label) return;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        try {
            const response = await fetch('{% url "fortune:favorite_date_add_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken.value
                },
                body: JSON.stringify({
                    date: targetDateInput.value,
                    label: label
                })
            });

            const data = await response.json();
            if (data.success) {
                await loadFavoriteDates();
                showToast('ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        } catch (e) {
            showToast('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // ì¦ê²¨ì°¾ê¸° í¼ ì œì¶œ
    document.getElementById('favoriteDateForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        const favoriteData = {
            date: document.getElementById('favoriteDate').value,
            label: document.getElementById('favoriteLabel').value,
            memo: document.getElementById('favoriteMemo').value
        };

        try {
            const response = await fetch('{% url "fortune:favorite_date_add_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken.value
                },
                body: JSON.stringify(favoriteData)
            });

            const data = await response.json();
            if (data.success) {
                closeFavoriteDateModal();
                await loadFavoriteDates();
                showToast('ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        } catch (e) {
            showToast('ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    });

    // ì¦ê²¨ì°¾ê¸° ì‚­ì œ
    async function deleteFavoriteDate(favoriteId) {
        if (!confirm('ì´ ì¦ê²¨ì°¾ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showToast('í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”', 'error');
            return;
        }

        try {
            const response = await fetch(`{% url "fortune:favorite_date_delete_api" 0 %}`.replace('0', favoriteId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken.value
                }
            });

            const data = await response.json();
            if (data.success) {
                await loadFavoriteDates();
                showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        } catch (e) {
            showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // ============================================
    // í†µê³„ í•¨ìˆ˜
    // ============================================

    // í†µê³„ ë¡œë“œ
    async function loadStatistics() {
        try {
            const response = await fetch('{% url "fortune:statistics_api" %}');
            const contentType = response.headers.get('content-type');

            if (contentType && contentType.includes('application/json')) {
                const data = await response.json();

                // JS Check: Ensure elements exist before setting (since they might be removed)
                const statTotalEl = document.getElementById('statTotalAnalyses');
                if (statTotalEl) {
                    statTotalEl.textContent = data.total_analyses;
                    document.getElementById('statTotalDaily').textContent = data.total_daily_checks;
                    document.getElementById('statRecentActivity').textContent = data.recent_activity;
                }
            }
        } catch (e) {
            console.error('Failed to load statistics:', e);
        }
    }

    // ============================================
    // ì•Œë¦¼/ë¦¬ë§ˆì¸ë” í•¨ìˆ˜
    // ============================================

    // ë‚´ì¼ ìš´ì„¸ ë¦¬ë§ˆì¸ë” ì„¤ì •
    function setTomorrowReminder() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);

        localStorage.setItem('fortuneReminder', tomorrow.getTime());
        showToast('ë‚´ì¼ ì•Œë¦¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ””', 'success');
    }

    // ë¦¬ë§ˆì¸ë” í™•ì¸
    function checkReminder() {
        const reminderTime = localStorage.getItem('fortuneReminder');
        if (!reminderTime) return;

        const now = new Date().getTime();
        const reminderDate = parseInt(reminderTime);

        // ë¦¬ë§ˆì¸ë” ë‚ ì§œê°€ ì§€ë‚¬ìœ¼ë©´ ë°°ë„ˆ í‘œì‹œ
        if (now >= reminderDate) {
            const banner = document.getElementById('reminderBanner');
            if (banner) {
                banner.classList.remove('hidden');
            }
        }
    }

    // ë¦¬ë§ˆì¸ë” ë°°ë„ˆ ë‹«ê¸°
    function dismissReminder() {
        document.getElementById('reminderBanner').classList.add('hidden');
        localStorage.removeItem('fortuneReminder');
    }

    // ì´ì „ ì‚¬ì£¼ ê²°ê³¼ ë³µì› í•¨ìˆ˜
    function restorePendingSajuResult() {
        const isAuthenticated = "{{ user.is_authenticated }}" === "True";
        const pendingData = localStorage.getItem('pendingSajuResult');

        if (!pendingData) return;

        try {
            const data = safeJSONParse(pendingData, null);
            const age = Date.now() - data.timestamp;

            // 24ì‹œê°„ ì´ë‚´ ë°ì´í„°ë§Œ ë³µì›
            if (age > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('pendingSajuResult');
                return;
            }

            // ê²°ê³¼ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ë³µì›í•˜ì§€ ì•ŠìŒ
            const hasCurrentResult = document.getElementById('markdownResult')?.innerHTML.trim().length > 0;
            if (hasCurrentResult) return;

            // UI ì „í™˜
            document.getElementById('formContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.remove('hidden');
            document.getElementById('shareSection').classList.remove('hidden');
            document.getElementById('dailyFortuneSection').classList.remove('hidden');
            document.getElementById('formContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.remove('hidden');
            document.getElementById('shareSection').classList.remove('hidden');
            document.getElementById('dailyFortuneSection').classList.remove('hidden');
            // document.getElementById('saveSection').classList.remove('hidden'); // Removed functionality

            updatePremiumUI(data.result, data.chart, data.mode, data.day_master, data.name);

            // Chart Data ë³µì› (Daily Fortune ë“±ì„ ìœ„í•´ í•„ìˆ˜)
            // ê¸°ì¡´ ìš”ì†Œê°€ ìˆìœ¼ë©´ ì œê±° í›„ ì¬ìƒì„±
            const existingChartData = document.getElementById('saju-chart-data');
            if (existingChartData) existingChartData.remove();

            const chartDataContainer = document.createElement('script');
            chartDataContainer.id = 'saju-chart-data';
            chartDataContainer.type = 'application/json';
            chartDataContainer.textContent = JSON.stringify(data.chart);
            document.body.appendChild(chartDataContainer);

            // ì„¹ì…˜ ê·¸ë£¹í™” ì ìš©
            groupMarkdownSections();

            // ìŠ¤í¬ë¡¤
            setTimeout(() => {
                document.getElementById('resultContainer').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);

            // ë¡œê·¸ì¸í•œ ê²½ìš° ìë™ ì €ì¥ ì œì•ˆ - ê°€ì… ìœ ë„ ë©”ì‹œì§€ ë¶„ë¦¬
            if (isAuthenticated) {
                showToast('ì´ì „ ì‚¬ì£¼ ê²°ê³¼ë¥¼ ë³µì›í–ˆìŠµë‹ˆë‹¤!');

                // Cache Restoration
                window.currentSajuState = {
                    natal_chart: data.chart,
                    mode: data.mode || 'teacher',
                    savedId: null, // Reset saved ID on restore to potentially allow re-save if needed, or check DB?
                    result_text: data.result
                };

                // Trigger Auto-Save (if not already saved in session)
                autoSaveResult();
            } else {
                showToast('ì´ì „ ì‚¬ì£¼ ê²°ê³¼ë¥¼ ë³µì›í–ˆìŠµë‹ˆë‹¤! íšŒì›ê°€ì…í•˜ë©´ ì˜êµ¬ ë³´ê´€í•  ìˆ˜ ìˆì–´ìš”.');
                // Helper for guests
                window.currentSajuState = {
                    natal_chart: data.chart,
                    mode: data.mode || 'teacher',
                    savedId: null,
                    result_text: data.result
                };
            }

        } catch (e) {
            console.error('Failed to restore pending result:', e);
            localStorage.removeItem('pendingSajuResult');
        }
    }

    const ELEMENT_MAP = {
        'ç”²': { element: 'wood', icon: 'ğŸŒ³', name: 'ê°‘ëª©(ç”²æœ¨)', desc: 'í° ë‚˜ë¬´ì²˜ëŸ¼ ê³§ê³  ê°•í•œ ê¸°ìš´' },
        'ä¹™': { element: 'wood', icon: 'ğŸŒ¿', name: 'ì„ëª©(ä¹™æœ¨)', desc: 'í’€ê³¼ ë„ì¿¨ì²˜ëŸ¼ ë¶€ë“œëŸ½ê³  ìœ ì—°í•œ ê¸°ìš´' },
        'ä¸™': { element: 'fire', icon: 'â˜€ï¸', name: 'ë³‘í™”(ä¸™ç«)', desc: 'íƒœì–‘ì²˜ëŸ¼ ë°ê³  ë”°ëœ»í•œ ê¸°ìš´' },
        'ä¸': { element: 'fire', icon: 'ğŸ•¯ï¸', name: 'ì •í™”(ä¸ç«)', desc: 'ì´›ë¶ˆì²˜ëŸ¼ ì˜¨í™”í•˜ê³  ì„¬ì„¸í•œ ê¸°ìš´' },
        'æˆŠ': { element: 'earth', icon: 'â›°ï¸', name: 'ë¬´í† (æˆŠåœŸ)', desc: 'í° ì‚°ì²˜ëŸ¼ ë“ ë“ í•˜ê³  í¬ìš©ë ¥ ìˆëŠ” ê¸°ìš´' },
        'å·±': { element: 'earth', icon: 'ğŸ”ï¸', name: 'ê¸°í† (å·±åœŸ)', desc: 'ë…¼ë°­ì²˜ëŸ¼ ìƒì‚°ì ì´ê³  ì‹¤ìš©ì ì¸ ê¸°ìš´' },
        'åºš': { element: 'metal', icon: 'âš”ï¸', name: 'ê²½ê¸ˆ(åºšé‡‘)', desc: 'ì¹¼ê³¼ ë°”ìœ„ì²˜ëŸ¼ ê°•í•˜ê³  ì •ì˜ë¡œìš´ ê¸°ìš´' },
        'è¾›': { element: 'metal', icon: 'ğŸ’', name: 'ì‹ ê¸ˆ(è¾›é‡‘)', desc: 'ë³´ì„ì²˜ëŸ¼ ì•„ë¦„ë‹µê³  ì„¸ë ¨ëœ ê¸°ìš´' },
        'å£¬': { element: 'water', icon: 'ğŸŒŠ', name: 'ì„ìˆ˜(å£¬æ°´)', desc: 'ë°”ë‹¤ì²˜ëŸ¼ ë„“ê³  ê¹Šì€ ê¸°ìš´' },
        'ç™¸': { element: 'water', icon: 'ğŸ’§', name: 'ê³„ìˆ˜(ç™¸æ°´)', desc: 'ë¹„ì™€ ì´ìŠ¬ì²˜ëŸ¼ ë¶€ë“œëŸ½ê³  ì§€í˜œë¡œìš´ ê¸°ìš´' }
    };

    const elementBadgeStyles = {
        'wood': 'bg-emerald-50 text-emerald-600 border-emerald-200',
        'fire': 'bg-rose-50 text-rose-600 border-rose-200',
        'earth': 'bg-amber-50 text-amber-600 border-amber-200',
        'metal': 'bg-purple-50 text-purple-600 border-purple-200',
        'water': 'bg-blue-50 text-blue-600 border-blue-200'
    };

    // ëª¨ë“œ í† ê¸€
    function setMode(mode) {
        document.getElementById('modeInput').value = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.mode === mode) {
                btn.classList.add('active');
            }
        });
    }

    // ìœ„íŠ¸ ìˆëŠ” ë¡œë”© ë©”ì‹œì§€
    const loadingMessages = [
        { title: "ìš´ëª…ì˜ ì‹¤ì„ í’€ì–´ë‚´ëŠ” ì¤‘...", subtitle: "í•˜ëŠ˜ì˜ ë³„ì´ ë‹¹ì‹ ì˜ ì‚¬ì£¼ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤." },
        { title: "ìŒì–‘ì˜¤í–‰ì„ ì¡°ìœ¨í•˜ëŠ” ì¤‘...", subtitle: "ë‹¹ì‹ ì˜ íƒœì–´ë‚œ ìˆœê°„, ìš°ì£¼ì˜ ê¸°ìš´ì„ ëª¨ìœ¼ê³  ìˆì–´ìš”." },
        { title: "ì²œê°„ì§€ì§€ë¥¼ ë°°ì—´í•˜ëŠ” ì¤‘...", subtitle: "ë³µì¡í•˜ê²Œ ì–½íŒ ìš´ëª…ì˜ ì§€ë„ë¥¼ ê·¸ë ¤ë‚´ê³  ìˆìŠµë‹ˆë‹¤." },
        { title: "ë‹¹ì‹ ë§Œì˜ ìš´ëª… ì§€ë„ë¥¼ ì‘ì„±í•˜ëŠ” ì¤‘...", subtitle: "ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”, ê±°ì˜ ë‹¤ ë˜ì—ˆìŠµë‹ˆë‹¤." }
    ];

    const loadingTips = [
        "ì‹œê°„ì„ ëª¨ë¥¼ ê²½ìš° ì •ì˜¤(12ì‹œ)ë¡œ ê³„ì‚°í•˜ë©´ ê°€ì¥ ì •í™•í•´ìš”.",
        "ì‚¬ì£¼ëŠ” í†µê³„í•™ì— ê¸°ë°˜í•œ ì‚¶ì˜ ì´ì •í‘œì¼ ë¿ì…ë‹ˆë‹¤.",
        "ê¸ì •ì ì¸ ë§ˆìŒê°€ì§ì´ ìš´ëª…ì„ ë°”ê¾¸ëŠ” ê°€ì¥ í° ì—´ì‡ ì˜ˆìš”.",
    ];

    // ì‚¬ì£¼ ì…ë ¥ ë°ì´í„° ê¸°ë°˜ ê³ ìœ  ìºì‹œ í‚¤ ìƒì„± (ì´ë¦„, ì„±ë³„, ìƒë…„ì›”ì¼ì‹œ, ëª¨ë“œ í¬í•¨)
    function getSajuCacheKey(formData) {
        const keyParts = [
            formData.get('name') || '',
            formData.get('gender') || '',
            formData.get('birth_year') || '',
            formData.get('birth_month') || '',
            formData.get('birth_day') || '',
            formData.get('birth_hour') || '',
            formData.get('calendar_type') || '',
            formData.get('mode') || 'teacher'
        ];
        const rawKey = keyParts.join('|');
        // í•œê¸€ í¬í•¨ í‚¤ë¥¼ ì•ˆì „í•˜ê²Œ í•´ì‹± (Base64 í™œìš©)
        const hash = btoa(unescape(encodeURIComponent(rawKey))).substring(0, 24);
        return `saju_result_v2_${hash}`;
    }

    // í¼ ì œì¶œ í•¸ë“¤ëŸ¬ (Premium Loading ì ìš©)
    document.getElementById('sajuForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);

        // [í•˜ë£¨ 5íšŒ ì œí•œ ê²€ì‚¬] - ê°œì¸ API í‚¤ ì‚¬ìš©ìëŠ” ë¬´ì œí•œ
        // Django templateì—ì„œ ë³€ìˆ˜ ì£¼ì… (Falseë©´ ë¬¸ìì—´ "False")
        const hasPersonalApiKey = "{{ has_personal_api_key|default:'False' }}" === "True";

        if (!hasPersonalApiKey) {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const usageKey = `saju_usage_${today}`;
            let usageCount = parseInt(localStorage.getItem(usageKey) || '0');

            if (usageCount >= 5) {
                alert("ì˜¤ëŠ˜ì˜ ì‚¬ì£¼ ë¶„ì„ íšŸìˆ˜(5íšŒ)ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.\në‚´ì¼ ë‹¤ì‹œ ì´ìš©í•´ì£¼ì„¸ìš”! ğŸ€\n\n(ê°œì¸ API Keyë¥¼ ë“±ë¡í•˜ë©´ ë¬´ì œí•œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤)");
                return;
            }
        }

        // [Restoration Plan] ë¶„ì„ ì‹œì‘ ì „ ë°±ì—…
        try {
            const currentInputs = Object.fromEntries(formData.entries());
            localStorage.setItem('pending_saju_input', JSON.stringify({
                ...currentInputs,
                timestamp: Date.now()
            }));
        } catch (e) {
            console.warn("Input backup failed", e);
        }

        // UI ì „í™˜ ë° ëª¨ë‹¬ í‘œì‹œ
        const loadingModal = document.getElementById('loadingModal');
        const loadingProgress = document.getElementById('loadingProgress');
        const loadingTitle = document.getElementById('loadingTitle');
        const loadingSubtitle = document.getElementById('loadingSubtitle');
        const loadingTip = document.getElementById('loadingTip');

        // [ì¤‘ë³µ ë¶„ì„ ë°©ì§€: ìºì‹œ ì²´í¬]
        const cacheKey = getSajuCacheKey(formData);
        const cachedResult = localStorage.getItem(cacheKey);

        if (cachedResult) {
            console.log("Found cached saju result, simulating deep analysis for reliability.");
            try {
                const data = safeJSONParse(cachedResult, null);

                // ë¡œë”© ëª¨ë‹¬ í‘œì‹œ ë° ê°€ì§œ í”„ë¡œê·¸ë ˆìŠ¤ ì‹œì‘
                loadingModal.classList.add('show');
                const randomMsg = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
                loadingTitle.textContent = randomMsg.title;
                loadingSubtitle.textContent = randomMsg.subtitle;
                loadingTip.textContent = loadingTips[Math.floor(Math.random() * loadingTips.length)];

                // ìºì‹œëœ ê²°ê³¼ì´ë¯€ë¡œ ì¢€ ë” ë¹ ë¥´ê²Œ(1.5ì´ˆ ì •ë„) ë¡œë”© ì—°ì¶œ
                let cacheProgress = 0;
                const cacheInterval = setInterval(() => {
                    cacheProgress += 10;
                    loadingProgress.style.width = `${cacheProgress}%`;
                    if (cacheProgress >= 100) clearInterval(cacheInterval);
                }, 150);

                setTimeout(() => {
                    clearInterval(cacheInterval);
                    loadingModal.classList.remove('show');

                    updatePremiumUI(data.result, data.chart, data.mode, data.day_master, data.name);
                    groupMarkdownSections();

                    document.getElementById('formContainer').classList.add('hidden');
                    document.getElementById('resultContainer').classList.remove('hidden');
                    document.getElementById('shareSection').classList.remove('hidden');
                    document.getElementById('dailyFortuneSection').classList.remove('hidden');

                    window.currentSajuState = {
                        natal_chart: data.chart,
                        mode: data.mode || 'teacher',
                        savedId: null,
                        result_text: data.result
                    };

                    setTimeout(() => {
                        document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);

                    showToast('ì´ì „ì— ë¶„ì„í•œ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. âœ¨', 'success');
                }, 1500);

                return; // API í˜¸ì¶œ ì¤‘ë‹¨
            } catch (e) {
                console.warn("Cached result parse error, proceeding with API:", e);
                localStorage.removeItem(cacheKey);
            }
        }

        loadingModal.classList.add('show');

        // ëœë¤ ë©”ì‹œì§€ ì„¤ì •
        const randomMsg = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
        loadingTitle.textContent = randomMsg.title;
        loadingSubtitle.textContent = randomMsg.subtitle;
        loadingTip.textContent = loadingTips[Math.floor(Math.random() * loadingTips.length)];

        // ê°€ì§œ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì‹œì‘
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += Math.random() * 5;
                if (progress > 90) progress = 90;
                loadingProgress.style.width = `${progress}%`;
            }
        }, 400);

        // 15ì´ˆ í›„ ëŒ€ê¸° ì•ˆë‚´ í‘œì‹œ
        const queueNotice = document.getElementById('loadingQueueNotice');
        const queueTimer = setTimeout(() => {
            if (queueNotice) queueNotice.style.display = 'block';
        }, 15000);

        try {
            // non-streaming API í˜¸ì¶œ
            const response = await fetch('{% url "fortune:saju_api" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });

            // [Mobile Robustness] Content-Type ì²´í¬ ë° ì•ˆì „í•œ íŒŒì‹±
            const contentType = response.headers.get('content-type');
            let data;

            if (contentType && contentType.includes('application/json')) {
                try {
                    data = await response.json();
                } catch (e) {
                    console.error("[Mobile Debug] JSON Parse Error:", e);
                    throw new Error('ì‘ë‹µ ë°ì´í„°ë¥¼ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } else {
                // JSONì´ ì•„ë‹Œ ê²½ìš° (ë³´í†µ HTML ì—ëŸ¬ í˜ì´ì§€)
                const errorBody = await response.text();
                console.error("[Mobile Debug] Non-JSON Response:", {
                    status: response.status,
                    contentType: contentType,
                    userAgent: navigator.userAgent
                });

                if (response.status === 429) {
                    throw new Error(`í•œêº¼ë²ˆì— ë§ì€ ìš”ì²­ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤.`);
                } else if (response.status >= 500) {
                    throw new Error(`ì„œë²„ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
                } else {
                    throw new Error(`ì¼ì‹œì ì¸ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
                }
            }

            // ì„±ê³µ ì‹œ ì¹´ìš´íŠ¸ ì¦ê°€ (ê°œì¸ API í‚¤ ì—†ì„ ë•Œë§Œ)
            if (response.ok && data.success && !hasPersonalApiKey) {
                const today = new Date().toISOString().split('T')[0];
                const usageKey = `saju_usage_${today}`;
                let currentCount = parseInt(localStorage.getItem(usageKey) || '0');
                localStorage.setItem(usageKey, currentCount + 1);
            }

            if (!response.ok) {
                throw new Error(data.message || data.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }

            // ì™„ë£Œ ì²˜ë¦¬
            clearInterval(progressInterval);
            clearTimeout(queueTimer);
            if (queueNotice) queueNotice.style.display = 'none';
            loadingProgress.style.width = '100%';

            // ê²°ê³¼ ë°ì´í„° ì¶”ì¶œ
            const accumulatedText = data.result;

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì…ë ¥ ì •ë³´ ì €ì¥ (ê²°ê³¼ í¬í•¨)
            const inputData = {
                name: formData.get('name'),
                gender: formData.get('gender'),
                birth_year: parseInt(formData.get('birth_year')),
                birth_month: parseInt(formData.get('birth_month')),
                birth_day: parseInt(formData.get('birth_day')),
                birth_hour: formData.get('birth_hour') ? parseInt(formData.get('birth_hour')) : '',
                birth_minute: formData.get('birth_minute') ? parseInt(formData.get('birth_minute')) : '',
                calendar_type: formData.get('calendar_type'),
                mode: formData.get('mode'),
                timestamp: Date.now(),
                daystem: (accumulatedText.match(/ì¼ì£¼[^:]*:\s*[\*\s]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/) || [])[1]
            };
            localStorage.setItem('lastSajuInput', JSON.stringify(inputData));

            // ìºì‹œ ì €ì¥ (3ì¼ê°„ ìœ íš¨í•˜ë„ë¡ íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨)
            const cacheEntry = {
                result: accumulatedText,
                chart: data.chart,
                name: data.name,
                gender: formData.get('gender'),
                mode: formData.get('mode'),
                day_master: data.day_master,
                timestamp: Date.now()
            };
            localStorage.setItem(cacheKey, JSON.stringify(cacheEntry));

            // ë¹„íšŒì› ê²°ê³¼ ë³´ì¡´ (ìµœì‹  1ê±´)
            localStorage.setItem('pendingSajuResult', JSON.stringify(cacheEntry));

            // ì•½ê°„ì˜ ì§€ì—° í›„ ê²°ê³¼ í‘œì‹œ (UXë¥¼ ìœ„í•´)
            setTimeout(() => {
                loadingModal.classList.remove('show');

                // UI ì „í™˜
                document.getElementById('formContainer').classList.add('hidden');
                document.getElementById('resultContainer').classList.remove('hidden');
                document.getElementById('shareSection').classList.remove('hidden');
                document.getElementById('dailyFortuneSection').classList.remove('hidden');
                // document.getElementById('saveSection').classList.remove('hidden');

                // ê²°ê³¼ ë Œë”ë§ (day_master ì „ë‹¬)
                updatePremiumUI(accumulatedText, data.chart, data.mode, data.day_master, data.name);

                // ì„¹ì…˜ ê·¸ë£¹í™” ì ìš©
                groupMarkdownSections();

                // ìŠ¤í¬ë¡¤
                setTimeout(() => {
                    document.getElementById('resultContainer').scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 100);

                // Update Global Cache
                window.currentSajuState = {
                    natal_chart: data.chart,
                    mode: data.mode || 'teacher',
                    savedId: null,
                    result_text: accumulatedText
                };

                // Trigger Auto-Save
                autoSaveResult();
            }, 800);

        } catch (err) {
            clearInterval(progressInterval);
            clearTimeout(queueTimer);
            if (queueNotice) queueNotice.style.display = 'none';
            loadingModal.classList.remove('show');
            console.error(err);

            // [Restoration Plan] ì—ëŸ¬ ì‹œ í¼ì„ ìˆ¨ê¸°ì§€ ì•Šê³  ì…ë ¥ê°’ ìœ ì§€
            const formContainer = document.getElementById('formContainer');
            if (formContainer) {
                formContainer.classList.remove('hidden');
                // ê²°ê³¼ì°½ì´ ì—´ë ¤ìˆì—ˆë‹¤ë©´ ë‹«ê¸°
                document.getElementById('resultContainer')?.classList.add('hidden');
            }

            let userMessage = "ì„ ìƒë‹˜, ì ì‹œ AIì™€ì˜ ì—°ê²°ì´ ë¶ˆì•ˆì •í–ˆì–´ìš”. ğŸ˜¥<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì‹œë©´ ê¼¼ê¼¼í•˜ê²Œ ë¶„ì„í•´ë“œë¦´ê²Œìš”!";
            if (err.message && (err.message.includes('í•œêº¼ë²ˆì—') || err.message.includes('ì„œë²„') || err.message.includes('ì—°ê²°'))) {
                userMessage = `ì‚¬ì£¼ ë¶„ì„ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ğŸ˜¥<br>${err.message}`;
            }

            // í† ìŠ¤íŠ¸ë¡œ ì—ëŸ¬ í‘œì‹œ (HTML í¬í•¨ ê°€ëŠ¥í•˜ë„ë¡ ì²˜ë¦¬í•˜ê±°ë‚˜ í…ìŠ¤íŠ¸ë§Œ)
            showToast('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');

            // ì „ì—­ ì—ëŸ¬ ì•Œë¦¼ ì˜ì—­ì´ ìˆë‹¤ë©´ í‘œì‹œ (ì—†ìœ¼ë©´ alert fallback)
            const errorDisplay = document.getElementById('globalErrorDisplay');
            if (errorDisplay) {
                errorDisplay.innerHTML = userMessage;
                errorDisplay.classList.remove('hidden');
                errorDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                alert(userMessage.replace(/<br>/g, '\n').replace(/<[^>]*>/g, ''));
            }
        }
    });

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMessage');
        if (toast && toastMsg) {
            toastMsg.textContent = message;

            // ê¸°ì¡´ íƒ€ì… í´ë˜ìŠ¤ ì œê±°
            toast.classList.remove('success', 'error', 'info');
            toast.classList.add(type);

            toast.classList.add('show');

            // ì´ì „ íƒ€ì´ë¨¸ ìˆìœ¼ë©´ ì œê±°
            if (window.toastTimer) clearTimeout(window.toastTimer);

            window.toastTimer = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    }

    // --- Core UI & Analysis Functions ---

    // --- Premium UI & Analysis Functions ---

    function updatePremiumUI(markdown, chart, mode = 'teacher', dayMaster = null, userName = '') {
        console.log("Updating Premium UI - Mode:", mode);

        // Mode-specific Honorific
        const isTeacher = (mode === 'teacher');
        const honorific = isTeacher ? 'ì„ ìƒë‹˜' : 'ë‹˜';

        // 1. Render Natal Chart FIRST from API data (to use as reliable identity source)
        if (chart) {
            renderPremiumNatalChart(chart);
        }

        // 2. Render Markdown
        if (markdown) {
            marked.setOptions({ breaks: true, gfm: true });
            const htmlContent = DOMPurify.sanitize(marked.parse(markdown));
            const resultElem = document.getElementById('markdownResult');
            if (resultElem) {
                resultElem.innerHTML = htmlContent;
                if (typeof groupMarkdownSections === 'function') {
                    groupMarkdownSections();
                }
            }
        }

        // 3. Identify Day Master (Strict Priority: Data > DOM > Context-Regex)
        let dayStemChar = (dayMaster) ? dayMaster.char : '';
        let dayStemElement = (dayMaster) ? dayMaster.element : '';

        // Prioritize DOM ID if explicit dayMaster (from AJAX/SSR) is missing
        if (!dayStemChar) {
            const domDayStem = document.getElementById('natalDayStem');
            if (domDayStem && domDayStem.textContent.trim() !== '?') {
                dayStemChar = domDayStem.textContent.trim();
            }
        }

        // Final fallback: Context-aware Regex (must mention keywords)
        if (!dayStemChar && markdown) {
            const pattern = /(?:ì¼ì£¼|ì¼ê°„|ì¤‘ì‹¬ ê¸°ìš´)[^:]*[:ï¼š]?\s*[\*\s]*([ê°‘ì„ë³‘ì •ë¬´ê¸°ê²½ì‹ ì„ê³„])/;
            const match = markdown.match(pattern);
            if (match) {
                dayStemChar = match[1];
            }
        }

        // Update UI Elements
        if (dayStemChar && ELEMENT_MAP[dayStemChar]) {
            const info = ELEMENT_MAP[dayStemChar];

            // Header Identity Card: Restore Person Name if available
            document.getElementById('stemIconBig').textContent = info.icon;
            document.getElementById('stemStaticName').textContent = userName ? `${userName} ${honorific}` : info.name;
            document.getElementById('stemStaticDesc').textContent = info.desc;

            // Badge & Background
            const badge = document.getElementById('premiumBadge');
            const bg = document.getElementById('hero-bg');
            if (badge) {
                document.getElementById('badgeIcon').textContent = info.icon;
                document.getElementById('badgeText').textContent = info.name;
                badge.className = `inline-flex items-center justify-center gap-1 text-sm py-1 px-3 rounded-full border shadow-sm backdrop-blur-sm ${elementBadgeStyles[info.element] || 'bg-white/50 border-slate-200'}`;
            }
            if (bg) {
                const colors = { wood: '#10b981', fire: '#ef4444', earth: '#f59e0b', metal: '#8b5cf6', water: '#3b82f6' };
                bg.style.background = `linear-gradient(135deg, ${colors[info.element] || '#6366f1'}, transparent)`;
            }
        }

        // 4. Render Tabs and Update Share Card
        renderDynamicTabs(mode);
        updateShareCard(markdown);
    }

    function renderDynamicTabs(mode) {
        const tabContainer = document.getElementById('analysisTabs');
        if (!tabContainer) return;

        const teacherTabs = [
            { id: 'summary', icon: 'ğŸ“Œ', label: 'í•µì‹¬ìš”ì•½' },
            { id: 'pillars', icon: 'ğŸ“œ', label: 'ì‚¬ì£¼ ì›êµ­' },
            { id: 'personality', icon: 'ğŸ«', label: 'êµì‹¤ ê¸°ì§ˆ' },
            { id: 'students', icon: 'ğŸ£', label: 'í•™ìƒ ì§€ë„' },
            { id: 'colleagues', icon: 'ğŸ‘¥', label: 'ë™ë£Œ ê´€ê³„' },
            { id: 'healing', icon: 'ğŸ“…', label: 'ìš´ì„¸/íë§' }
        ];

        const generalTabs = [
            { id: 'summary', icon: 'ğŸ“Œ', label: 'í•µì‹¬ìš”ì•½' },
            { id: 'pillars', icon: 'ğŸ“œ', label: 'ì›êµ­ ë¶„ì„' },
            { id: 'personality', icon: 'ğŸ’¡', label: 'ê¸°ì§ˆ/ì„±ê²©' },
            { id: 'wealth', icon: 'ğŸ’°', label: 'ì¬ë¬¼/ì§ì—…' },
            { id: 'romance', icon: 'â¤ï¸', label: 'ì• ì •/ê´€ê³„' },
            { id: 'luck', icon: 'ğŸ“…', label: 'ìš´ì„¸/ê°œìš´' }
        ];

        const tabs = (mode === 'teacher') ? teacherTabs : generalTabs;
        tabContainer.innerHTML = tabs.map((t, idx) => `
            <button onclick="switchTab(this, '${t.id}')"
                class="tab-btn ${idx === 0 ? 'active bg-purple-100 text-purple-700 border-purple-200' : 'border-transparent hover:bg-white/80'} px-4 py-2 rounded-full font-bold whitespace-nowrap transition-all text-sm border shadow-sm ${idx === 0 ? '' : 'bg-white/80'}">
                ${t.icon} ${t.label}
            </button>
        `).join('');
    }

    function renderPremiumNatalChart(chart) {
        const container = document.getElementById('sajuChartDisplay');
        if (!container) return;

        const pillars = [
            { label: 'ì‹œì£¼', key: 'hour', sub: 'ë§ë…„' },
            { label: 'ì¼ì£¼', key: 'day', sub: 'ë‚˜', special: true },
            { label: 'ì›”ì£¼', key: 'month', sub: 'ì‚¬íšŒ' },
            { label: 'ë…„ì£¼', key: 'year', sub: 'ì¡°ìƒ' }
        ];

        container.innerHTML = pillars.map(p => {
            let chars = chart[p.key] || ['?', '?'];

            // Handle string format like "ç”²å­"
            if (typeof chars === 'string') {
                chars = chars.split('');
            }

            // Explicitly handle array of strings from backend
            const stem = (chars && chars.length > 0) ? chars[0] : '?';
            const branch = (chars && chars.length > 1) ? chars[1] : '?';

            const stemColor = (stem && ELEMENT_MAP[stem]) ? `color-${ELEMENT_MAP[stem].element}` : '';
            const branchColor = (branch && ELEMENT_MAP[branch]) ? `color-${ELEMENT_MAP[branch].element}` : '';

            const specialClass = p.special ? 'border-2 border-purple-400/50 bg-purple-50/80 scale-105 shadow-md' : '';
            const topColor = p.special ? 'text-purple-600' : 'text-slate-400';

            // Add ID for Day Stem to ensure reliable identification
            const stemIdAttr = p.special ? 'id="natalDayStem"' : '';

            return `
                <div class="pillar-box ${specialClass} relative group">
                    <span class="pillar-top ${topColor}">${p.label}</span>
                    <span class="pillar-main ${stemColor}" ${stemIdAttr}>${stem}</span>
                    <span class="pillar-main ${branchColor}">${branch}</span>
                    <span class="pillar-sub text-[10px] sm:text-xs mt-1 font-bold text-slate-500">${p.sub}</span>
                </div>
            `;
        }).join('');
    }

    function switchTab(el, tab) {
        if (!el) return;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn?.classList.remove('active', 'bg-purple-100', 'text-purple-700', 'border-purple-200');
            btn?.classList.add('border-transparent');
            if (btn) btn.style.backgroundColor = '';
        });
        el.classList.remove('border-transparent');
        el.classList.add('active', 'bg-purple-100', 'text-purple-700', 'border-purple-200');

        const headers = document.querySelectorAll('#markdownResult h1, #markdownResult h2');
        const tabKeywords = {
            'summary': ['ìš”ì•½', 'í•µì‹¬'],
            'pillars': ['ëª…ì‹', 'ì›êµ­', 'íŒ”ì'],
            'personality': ['ì„±ê²©', 'ê¸°ì§ˆ', 'íŠ¹ì„±', 'êµì‹¤'],
            'wealth': ['ì¬ë¬¼', 'ê¸ˆì „', 'ëˆ'],
            'career': ['ì§ì—…', 'ì§„ë¡œ', 'ì ì„±'],
            'students': ['í•™ìƒ', 'ì§€ë„', 'ì¼€ë¯¸'],
            'colleagues': ['ë™ë£Œ', 'ê´€ê³„', 'í¬ì§€ì…˜'],
            'healing': ['íë§', 'ì²˜ë°©', 'ìŠ¤íŠ¸ë ˆìŠ¤'],
            'romance': ['ì• ì •', 'ì—°ì• ', 'ê¶í•©', 'ê²°í˜¼'],
            'compatibility': ['ì• ì •', 'ì—°ì• ', 'ê¶í•©', 'ê²°í˜¼'],
            'luck': ['ìš´ì„¸', 'ê°œìš´', '2026']
        };

        const keywords = tabKeywords[tab];
        if (keywords) {
            for (let h of headers) {
                if (keywords.some(k => h.innerText.includes(k))) {
                    h.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    h.classList?.add('bg-yellow-100');
                    setTimeout(() => h.classList?.remove('bg-yellow-100'), 1500);
                    break;
                }
            }
        }
    }

    // ê³µìœ ì¹´ë“œ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ ì €ì¥ìš©)
    function updateShareCard(markdown) {
        const nameContext = "{{ name|default:'' }}";
        const mode = document.getElementById('modeInput').value;
        const honorific = (mode === 'teacher') ? 'ì„ ìƒë‹˜' : 'ë‹˜';
        const displayName = nameContext ? `${nameContext} ${honorific}` : (mode === 'teacher' ? 'ì„ ìƒë‹˜' : 'ë‹¹ì‹ ');

        const titleElem = document.getElementById('shareCardTitle');
        if (titleElem) titleElem.textContent = `ğŸ”® ${displayName}ì˜ ì‚¬ì£¼`;

        for (const [char, info] of Object.entries(ELEMENT_MAP)) {
            if (markdown.includes(char)) {
                const iconElem = document.getElementById('shareCardElement')?.querySelector('.icon');
                const textElem = document.getElementById('shareCardElementText');
                if (iconElem) iconElem.textContent = info.icon;
                if (textElem) textElem.textContent = info.name;
                break;
            }
        }

        // Robust Keyword Regex: Handles quotes, commas, spaces flexibly
        const keywordMatch = markdown.match(/í‚¤ì›Œë“œ[^:]*:\s*["']?([^"',\s]+)["']?[\s,]+["']?([^"',\s]+)["']?[\s,]+["']?([^"',\s]+)["']?/);
        if (keywordMatch) {
            const keywordsContainer = document.getElementById('shareCardKeywords');
            if (keywordsContainer) {
                keywordsContainer.innerHTML = `
                    <span class="share-card-keyword">"${keywordMatch[1]}"</span>
                    <span class="share-card-keyword">"${keywordMatch[2]}"</span>
                    <span class="share-card-keyword">"${keywordMatch[3]}"</span>
                `;
            }
        }
        const colorMatch = markdown.match(/í–‰ìš´[^:]*ìƒ‰[^:]*[:ï¼š]\s*([ê°€-í£]+ìƒ‰?)/);
        if (colorMatch) {
            const colorElem = document.getElementById('shareCardLuckyColor');
            if (colorElem) colorElem.textContent = colorMatch[1];
        }
    }

    // ì¹´ì¹´ì˜¤í†¡ ê³µìœ  (ì¹´ë“œ í˜•íƒœ)
    function shareToKakao() {
        try {
            if (typeof Kakao === 'undefined' || !Kakao.isInitialized()) {
                showToast('ì¹´ì¹´ì˜¤í†¡ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const nameContext = "{{ name|default:'ì„ ìƒë‹˜' }}";
            const resultText = document.getElementById('markdownResult')?.innerText || '';

            // ì¼ê°„ ì •ë³´ì— ë”°ë¥¸ ì•„ì´ì½˜/ì´ë¦„ ì¶”ì¶œ
            let elementIcon = 'ğŸ”®';
            let elementName = 'ì‚¬ì£¼ ë¶„ì„';

            // 1. DOMì—ì„œ í™•ì •ëœ ì¼ê°„ ì •ë³´ ìš°ì„  íƒìƒ‰ (ì •í™•ë„ í–¥ìƒ)
            // (1) ë°°ì§€ í…ìŠ¤íŠ¸ í™œìš© (ì˜ˆ: "ì‹ ê¸ˆ(è¾›é‡‘)")
            const badgeText = document.getElementById('badgeText')?.textContent;
            // (2) ì¼ì£¼ ê¸€ì í™œìš© (ì˜ˆ: "è¾›")
            const natalDayStem = document.getElementById('natalDayStem')?.textContent;

            let found = false;

            // ë°°ì§€ í…ìŠ¤íŠ¸ë¡œ ê²€ìƒ‰
            if (badgeText) {
                for (const [char, info] of Object.entries(ELEMENT_MAP)) {
                    if (badgeText.includes(info.name.split('(')[0])) { // "ì‹ ê¸ˆ" ë§¤ì¹­
                        elementIcon = info.icon;
                        elementName = info.name;
                        found = true;
                        break;
                    }
                }
            }

            // ë°°ì§€ ì‹¤íŒ¨ ì‹œ ì¼ì£¼ ê¸€ìë¡œ ê²€ìƒ‰
            if (!found && natalDayStem) {
                const info = ELEMENT_MAP[natalDayStem.trim()];
                if (info) {
                    elementIcon = info.icon;
                    elementName = info.name;
                    found = true;
                }
            }

            // ìµœí›„ì˜ ìˆ˜ë‹¨: ë³¸ë¬¸ ê²€ìƒ‰ (ê¸°ì¡´ ë¡œì§)
            if (!found) {
                for (const [char, info] of Object.entries(ELEMENT_MAP)) {
                    if (resultText.includes(char)) {
                        elementIcon = info.icon;
                        elementName = info.name;
                        break;
                    }
                }
            }

            // ì €ì¥ëœ ê²°ê³¼ê°€ ìˆìœ¼ë©´ detail í˜ì´ì§€ë¡œ, ì—†ìœ¼ë©´ ë©”ì¸ í˜ì´ì§€ë¡œ
            let shareUrl = window.location.origin + '/fortune/saju/';
            if (typeof savedResultId !== 'undefined' && savedResultId) {
                shareUrl = window.location.origin + '/fortune/history/' + savedResultId + '/';
            }

            // ì´ë¦„ ì²˜ë¦¬ (ì¤‘ë³µ ë°©ì§€)
            let displayTitle = `${nameContext} ì„ ìƒë‹˜ì˜ ì‚¬ì£¼ ê²°ê³¼`;
            if (nameContext === 'ì„ ìƒë‹˜') {
                displayTitle = `ì„ ìƒë‹˜ì˜ ì‚¬ì£¼ ê²°ê³¼`;
            } else if (nameContext.endsWith('ì„ ìƒë‹˜')) {
                displayTitle = `${nameContext}ì˜ ì‚¬ì£¼ ê²°ê³¼`;
            }

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: `${elementIcon} ${displayTitle}`,
                    description: `${elementName} ê¸°ìš´ì„ ê°€ì§„ ì„ ìƒë‹˜ì„ ìœ„í•œ ë¶„ì„ì…ë‹ˆë‹¤.\n\në‹¹ì‹ ì˜ ì‚¬ì£¼ëŠ” ì–´ë–¨ê¹Œìš”? ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”! ğŸ”®`,
                    imageUrl: window.location.origin + '/static/fortune/images/teacher_saju_card.png',
                    link: {
                        mobileWebUrl: shareUrl,
                        webUrl: shareUrl,
                    },
                },
                buttons: [
                    {
                        title: 'ë‚˜ë„ ì‚¬ì£¼ë³´ê¸° ğŸ”®',
                        link: {
                            mobileWebUrl: window.location.origin + '/fortune/saju/',
                            webUrl: window.location.origin + '/fortune/saju/',
                        },
                    },
                ],
            });
        } catch (e) {
            console.error('Kakao Share Error:', e);
            if (navigator.share) {
                navigator.share({
                    title: 'ğŸ”® AI ì‚¬ì£¼ ë¶„ì„ ê²°ê³¼',
                    text: 'Eduititì—ì„œ ë‚´ ì‚¬ì£¼ë¥¼ ë¶„ì„í•´ë´¤ì–´ìš”!',
                    url: window.location.origin + '/fortune/saju/'
                });
            } else {
                copyLink();
            }
        }
    }

    // ë§í¬ ë³µì‚¬ (ì¹´ì¹´ì˜¤í†¡ ê³µìœ ì™€ ë™ì¼í•œ ë¡œì§)
    function copyLink() {
        // ì €ì¥ëœ ê²°ê³¼ê°€ ìˆìœ¼ë©´ detail í˜ì´ì§€ë¡œ, ì—†ìœ¼ë©´ ë©”ì¸ í˜ì´ì§€ë¡œ
        let shareUrl = window.location.origin + '/fortune/saju/';
        if (typeof savedResultId !== 'undefined' && savedResultId) {
            shareUrl = window.location.origin + '/fortune/history/' + savedResultId + '/';
        }

        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = shareUrl;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });
    }

    // ì´ë¯¸ì§€ ì €ì¥ (í˜„ì¬ ê²°ê³¼ í™”ë©´ ì „ì²´ ìº¡ì²˜ ê³ ë„í™”)
    function saveAsImage() {
        const captureArea = document.getElementById('capture-area');
        if (!captureArea) {
            showToast('ì €ì¥í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ìº¡ì²˜ ì „ìš© ìŠ¤íƒ€ì¼ ì ìš©
        captureArea.classList.add('capture-active');
        showToast('ê³ í™”ì§ˆ ë¦¬í¬íŠ¸ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

        // ìº¡ì²˜ ì˜µì…˜ ìµœì í™”
        const options = {
            backgroundColor: '#F8FAF6',
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            windowWidth: 800, // ë·°í¬íŠ¸ ê³ ì • (PC/ëª¨ë°”ì¼ ë™ì¼ í’ˆì§ˆ)
            onclone: (clonedDoc) => {
                const clonedArea = clonedDoc.getElementById('capture-area');
                if (clonedArea) {
                    clonedArea.style.width = '800px'; // ë„ˆë¹„ ê°•ì œ ê³ ì •
                    clonedArea.style.padding = '40px';
                    clonedArea.style.borderRadius = '0';
                    clonedArea.style.transform = 'none';
                    clonedArea.style.backgroundColor = '#F8FAF6';

                    // ìº¡ì²˜ ì‹œ ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±°
                    const noPrint = clonedDoc.querySelectorAll('.no-print');
                    noPrint.forEach(el => el.style.display = 'none');

                    // ëª¨ë“  ë¸”ëŸ¬ íš¨ê³¼ ì œê±° (í˜¸í™˜ì„±)
                    const blurred = clonedDoc.querySelectorAll('.backdrop-blur-sm, .backdrop-blur-md');
                    blurred.forEach(el => {
                        el.style.backdropFilter = 'none';
                        el.style.webkitBackdropFilter = 'none';
                        el.style.backgroundColor = 'white';
                    });

                    // ì´ë¦„ ë Œë”ë§ ê°•ì œ ë³´ì •
                    const nameElem = clonedDoc.getElementById('stemStaticName');
                    if (nameElem) {
                        nameElem.style.background = 'none';
                        nameElem.style.backgroundImage = 'none';
                        nameElem.style.color = '#4f46e5';
                        nameElem.style.display = 'block';
                    }
                }
            }
        };

        html2canvas(captureArea, options).then(canvas => {
            captureArea.classList.remove('capture-active');

            const link = document.createElement('a');
            const nameContext = "{{ name|default:'ì‚¬ì£¼ê²°ê³¼' }}";
            link.download = `${nameContext}_ì‚¬ì£¼ë¶„ì„ë¦¬í¬íŠ¸_${new Date().toISOString().split('T')[0]}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
            showToast('ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }).catch(err => {
            console.error(err);
            captureArea.classList.remove('capture-active');
            showToast('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ë¹ ë¥¸ ë‚ ì§œ ì„ íƒ
    function setQuickDate(type) {
        const today = new Date();
        let targetDate = new Date(today);

        if (type === 'weekend') {
            // ì´ë²ˆ ì£¼ í† ìš”ì¼ ì°¾ê¸°
            const dayOfWeek = today.getDay(); // 0(ì¼) ~ 6(í† )
            const daysUntilSaturday = (6 - dayOfWeek + 7) % 7;
            targetDate.setDate(today.getDate() + (daysUntilSaturday === 0 ? 7 : daysUntilSaturday));
        } else {
            // ìˆ«ìë©´ ì¼ìˆ˜ ë”í•˜ê¸°
            targetDate.setDate(today.getDate() + type);
        }

        // YYYY-MM-DD í¬ë§·ìœ¼ë¡œ ë³€í™˜
        const year = targetDate.getFullYear();
        const month = String(targetDate.getMonth() + 1).padStart(2, '0');
        const day = String(targetDate.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;

        // ë‚ ì§œ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        document.getElementById('targetDateInput').value = dateString;

        // ë°”ë¡œ ìš´ì„¸ í™•ì¸ (ì„ íƒì )
        // checkDailyFortune();
    }

    // ì¼ì§„ í™•ì¸
    async function checkDailyFortune() {
        const targetDate = document.getElementById('targetDateInput').value;
        if (!targetDate) return;

        const chartDataElem = document.getElementById('saju-chart-data');
        let natalChart = {};

        // Cache Strategy: Use Global State first
        if (window.currentSajuState && window.currentSajuState.natal_chart) {
            natalChart = window.currentSajuState.natal_chart;
        } else if (chartDataElem) {
            natalChart = safeJSONParse(chartDataElem.textContent, {});
            // If parsing failed or returned empty object, fall through to text extraction
            if (!natalChart || Object.keys(natalChart).length === 0) {
                console.warn("Chart data parsing failed, will extract from text");
            }
        } else {
            const resultText = document.getElementById('markdownResult').innerText;
            // ë” ìœ ì—°í•œ ì •ê·œí‘œí˜„ì‹: ê´„í˜¸ ë‚´ í•œì í¬í•¨ ì§€ì› ë° ë¶ˆí•„ìš”í•œ ê³µë°±/ë³„í‘œ ë¬´ì‹œ
            const extractPillar = (type) => {
                const regex = new RegExp(type + '[^ê°€-í£]*[:ï¼š]?\\s*([ê°€-í£]{1,2}|[\\u4E00-\\u9FFF]{1,2})');
                const match = resultText.match(regex);
                return match ? match[1].substring(0, 2) : null;
            };

            natalChart.year = extractPillar('ë…„ì£¼');
            natalChart.month = extractPillar('ì›”ì£¼');
            natalChart.day = extractPillar('ì¼ì£¼') || extractPillar('ì¼ê°„');
            natalChart.hour = extractPillar('ì‹œì£¼');
        }

        if (!natalChart || !natalChart.day) {
            showToast('ë¶„ì„ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì‚¬ì£¼ ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const isGuest = "{{ user.is_authenticated }}" === "False";
        const selectedDate = new Date(targetDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (isGuest && selectedDate > today) {
            alert('ì„ ìƒë‹˜, ë¯¸ë˜ì˜ ìš´ì„¸ëŠ” íšŒì›ê°€ì… í›„ì— í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”! ğŸ˜Š');
            return;
        }

        // Caching Logic: Unique key based on natal chart, date, AND mode
        const currentMode = document.getElementById('modeInput').value || 'teacher';
        const natalKey = Object.values(natalChart).join('_');
        const cacheKey = `daily_saju_v2_${btoa(unescape(encodeURIComponent(natalKey))).substring(0, 16)}_${targetDate}_${currentMode}`;
        const cachedResult = localStorage.getItem(cacheKey);

        if (cachedResult) {
            console.log("Using cached daily fortune, simulating analysis for reliability...");

            // ë¡œë”© ëª¨ë‹¬ í‘œì‹œ ë° ì—°ì¶œ
            loadingModal.classList.add('show');
            // ì¼ì§„ í™•ì¸ì— ì–´ìš¸ë¦¬ëŠ” ë©”ì‹œì§€ ì„ íƒ
            loadingTitle.textContent = "ì˜¤ëŠ˜ì˜ ê¸°ìš´ì„ ë¶„ì„í•˜ëŠ” ì¤‘... ğŸ€";
            loadingSubtitle.textContent = `${targetDate}ì˜ ìš°ì£¼ ì—ë„ˆì§€ë¥¼ ë‹¹ì‹ ì˜ ì‚¬ì£¼ì™€ ë§ì¶”ê³  ìˆìŠµë‹ˆë‹¤.`;

            let cacheProgress = 0;
            const cacheInterval = setInterval(() => {
                cacheProgress += 15;
                if (cacheProgress > 100) cacheProgress = 100;
                loadingProgress.style.width = `${cacheProgress}%`;
            }, 100);

            setTimeout(() => {
                clearInterval(cacheInterval);
                loadingModal.classList.remove('show');

                // ì „ì—­ ìƒíƒœì— ì¼ì§„ ê²°ê³¼ ì €ì¥ (ìºì‹œ)
                window.lastDailyFortune = {
                    date: targetDate,
                    result: cachedResult,
                    timestamp: Date.now()
                };

                const dailyResultDiv = document.getElementById('dailyFortuneResult');
                const dailyContentDiv = document.getElementById('dailyFortuneContent');
                dailyContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(cachedResult));
                dailyResultDiv.classList.remove('hidden');
                dailyResultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                showToast('ì˜¤ëŠ˜ì˜ ìš´ì„¸ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
            }, 1200);

            return;
        }

        loadingModal.classList.add('show');
        loadingTitle.textContent = loadingMessages[0].title;
        loadingSubtitle.textContent = loadingMessages[0].subtitle;

        // ì§„í–‰ ë°” ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += Math.random() * 5;
                if (progress > 90) progress = 90;
                loadingProgress.style.width = `${progress}%`;
            }
        }, 400);

        try {
            const response = await fetch('{% url "fortune:daily_fortune_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    target_date: targetDate,
                    natal_chart: natalChart,
                    name: "{{ name|default:'' }}",
                    gender: "{{ gender|default:'female' }}",
                    mode: currentMode
                })
            });

            // [Mobile Robustness] Content-Type ì²´í¬ ë° ì•ˆì „í•œ íŒŒì‹±
            const contentType = response.headers.get('content-type');
            let data;

            if (contentType && contentType.includes('application/json')) {
                try {
                    data = await response.json();
                } catch (jsonErr) {
                    console.error("[Mobile Debug] Daily Fortune JSON Parse Error:", jsonErr);
                    throw new Error('ì˜¤ëŠ˜ì˜ ìš´ì„¸ ë°ì´í„°ë¥¼ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } else {
                const errorBody = await response.text();
                console.error("[Mobile Debug] Daily Fortune Non-JSON Response:", {
                    status: response.status,
                    contentType: contentType,
                    preview: errorBody.substring(0, 300),
                    userAgent: navigator.userAgent
                });

                if (response.status === 429) {
                    throw new Error('í•œêº¼ë²ˆì— ë§ì€ ìš”ì²­ì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } else if (response.status >= 500) {
                    throw new Error('ì„œë²„ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
                } else {
                    throw new Error(`ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤. (${response.status})`);
                }
            }


            // ì§„í–‰ ë°” ì™„ë£Œ ì²˜ë¦¬
            clearInterval(progressInterval);
            loadingProgress.style.width = '100%';

            // ì•½ê°„ì˜ ì§€ì—° í›„ ëª¨ë‹¬ ë‹«ê¸°
            setTimeout(() => {
                document.getElementById('loadingModal').classList.remove('show');

                if (data.success) {
                    // Save to cache
                    localStorage.setItem(cacheKey, data.result);

                    // ì „ì—­ ìƒíƒœì— ì¼ì§„ ê²°ê³¼ ì €ì¥
                    window.lastDailyFortune = {
                        date: targetDate,
                        result: data.result,
                        timestamp: Date.now()
                    };

                    const dailyResultDiv = document.getElementById('dailyFortuneResult');
                    const dailyContentDiv = document.getElementById('dailyFortuneContent');
                    dailyContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(data.result));
                    dailyResultDiv.classList.remove('hidden');
                    dailyResultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    showToast(data.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }, 500);
        } catch (e) {
            clearInterval(progressInterval);
            document.getElementById('loadingModal').classList.remove('show');
            showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

    }

    // ============================================
    // ì¼ì§„ ê³µìœ  ê¸°ëŠ¥
    // ============================================

    // ì¹´ì¹´ì˜¤í†¡ ê³µìœ  (ì¼ì§„)
    function shareDailyToKakao() {
        if (!window.lastDailyFortune) {
            showToast('ê³µìœ í•  ìš´ì„¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            const nameContext = "{{ name|default:'' }}";
            const mode = document.getElementById('modeInput').value;
            const honorific = (mode === 'teacher') ? 'ì„ ìƒë‹˜' : 'ë‹˜';
            const displayName = nameContext ? `${nameContext} ${honorific}` : (mode === 'teacher' ? 'ì„ ìƒë‹˜' : 'ë‹¹ì‹ ');

            const dateStr = window.lastDailyFortune.date;
            const dateObj = new Date(dateStr);
            const formattedDate = `${dateObj.getMonth() + 1}ì›” ${dateObj.getDate()}ì¼`;

            // ê²°ê³¼ì—ì„œ ì—ë„ˆì§€ ì§€ìˆ˜ ì¶”ì¶œ (ìˆìœ¼ë©´)
            const resultText = window.lastDailyFortune.result;
            let energyScore = '';
            const scoreMatch = resultText.match(/ì¢…í•© ìš´ì„¸[:\s]*([â˜…â˜†]+)/);
            if (scoreMatch) {
                energyScore = scoreMatch[1];
            }

            let shareUrl = window.location.origin + '/fortune/saju/';

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: `ğŸ“… ${formattedDate} ${displayName}ì˜ ìš´ì„¸`,
                    description: `${energyScore ? energyScore + '\n' : ''}ì˜¤ëŠ˜ì˜ ìš´ì„¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!\n\në‹¹ì‹ ì˜ ìš´ì„¸ëŠ” ì–´ë–¨ê¹Œìš”? ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•´ë³´ì„¸ìš”! ğŸ”®`,
                    imageUrl: window.location.origin + '/static/fortune/images/teacher_saju_card.png',
                    link: {
                        mobileWebUrl: shareUrl,
                        webUrl: shareUrl,
                    },
                },
                buttons: [
                    {
                        title: 'ë‚´ ìš´ì„¸ ë³´ê¸° ğŸ”®',
                        link: {
                            mobileWebUrl: shareUrl,
                            webUrl: shareUrl,
                        },
                    },
                ],
            });
        } catch (e) {
            console.error('Kakao Share Error:', e);
            if (navigator.share) {
                navigator.share({
                    title: 'ğŸ“… ì˜¤ëŠ˜ì˜ ìš´ì„¸',
                    text: 'Eduititì—ì„œ ì˜¤ëŠ˜ì˜ ìš´ì„¸ë¥¼ í™•ì¸í•´ë´¤ì–´ìš”!',
                    url: window.location.origin + '/fortune/saju/'
                });
            } else {
                copyDailyLink();
            }
        }
    }

    // ë§í¬ ë³µì‚¬ (ì¼ì§„)
    function copyDailyLink() {
        const shareUrl = window.location.origin + '/fortune/saju/';

        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹œêµ¬ë“¤ê³¼ ê³µìœ í•´ë³´ì„¸ìš” ğŸ˜Š');
        }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = shareUrl;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });
    }

    // ì´ë¯¸ì§€ ì €ì¥ (ì¼ì§„)
    function saveDailyAsImage() {
        if (!window.lastDailyFortune) {
            showToast('ì €ì¥í•  ìš´ì„¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        const captureArea = document.getElementById('dailyFortuneContent');
        if (!captureArea) {
            showToast('ì €ì¥í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        showToast('ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

        const options = {
            backgroundColor: '#ffffff',
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            windowWidth: 800,
            onclone: (clonedDoc) => {
                const clonedArea = clonedDoc.getElementById('dailyFortuneContent');
                if (clonedArea) {
                    clonedArea.style.width = '800px';
                    clonedArea.style.padding = '40px';
                    clonedArea.style.borderRadius = '16px';
                    clonedArea.style.backgroundColor = '#ffffff';

                    // ë¸”ëŸ¬ íš¨ê³¼ ì œê±°
                    const blurred = clonedDoc.querySelectorAll('.backdrop-blur-sm, .backdrop-blur-md');
                    blurred.forEach(el => {
                        el.style.backdropFilter = 'none';
                        el.style.webkitBackdropFilter = 'none';
                        el.style.backgroundColor = 'white';
                    });
                }
            }
        };

        html2canvas(captureArea, options).then(canvas => {
            const link = document.createElement('a');
            const nameContext = "{{ name|default:'ìš´ì„¸' }}";
            const dateStr = window.lastDailyFortune.date;
            link.download = `${nameContext}_${dateStr}_ì¼ì§„ìš´ì„¸.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
            showToast('ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }).catch(err => {
            console.error(err);
            showToast('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        });
    }

    // ì €ì¥ëœ ê²°ê³¼ IDë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let savedResultId = null;

    // ìë™ ì €ì¥ (Silent Auto-Save)
    async function autoSaveResult() {
        if ("{{ user.is_authenticated }}" !== "True") return;
        if (!window.currentSajuState || !window.currentSajuState.result_text) return;
        if (window.currentSajuState.savedId) return; // Already saved

        console.log("Auto-saving results...");

        try {
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfInput) return;

            const response = await fetch('{% url "fortune:save_fortune_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfInput.value
                },
                body: JSON.stringify({
                    mode: window.currentSajuState.mode || 'teacher',
                    natal_chart: window.currentSajuState.natal_chart,
                    result_text: window.currentSajuState.result_text,
                    target_date: null // Main analysis, not daily
                })
            });

            // [Mobile Robustness] Content-Type ì²´í¬ ë° ì•ˆì „í•œ íŒŒì‹±
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                console.warn("[Mobile Debug] Auto-save Non-JSON Response", response.status);
                return; // Auto-save failure is silent but logged
            }

            const data = await response.json();
            if (data.success) {
                window.currentSajuState.savedId = data.result_id;
                savedResultId = data.result_id; // For sharing link
                showToast('ê²°ê³¼ê°€ ë³´ê´€í•¨ì— ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‚');
            }
        } catch (e) {
            console.error("Auto-save failed", e);
        }
    }

    // ë³´ê´€í•¨ ì €ì¥
    async function saveToLibrary() {
        console.log("Saving to library...");

        if ("{{ user.is_authenticated }}" === "False") {
            alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. ğŸ˜Š');
            return;
        }

        const resultElem = document.getElementById('markdownResult');
        if (!resultElem) {
            console.error("Result element not found");
            return;
        }

        const resultText = resultElem.innerText;
        const chartDataElem = document.getElementById('saju-chart-data');
        let natalChart = {};

        if (chartDataElem) {
            try {
                natalChart = safeJSONParse(chartDataElem.textContent, {});
            } catch (e) {
                console.error("Chart JSON parse error", e);
            }
        } else {
            // ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œì¸ ê²½ìš° í…ìŠ¤íŠ¸ì—ì„œ ê°„ë‹¨íˆ ì¼ì£¼ ë³´ì¡´
            const dayMatch = resultText.match(/ì¼ì£¼[^ê°€-í£]*[:ï¼š]\s*([ê°€-í£]{2})/);
            if (dayMatch) natalChart.day = dayMatch[1];
        }

        const dailyResultDiv = document.getElementById('dailyFortuneResult');
        const dailyContentDiv = document.getElementById('dailyFortuneContent');
        const dailyText = (dailyResultDiv && !dailyResultDiv.classList.contains('hidden') && dailyContentDiv) ? dailyContentDiv.innerText : null;

        try {
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfInput) {
                throw new Error("ë³´ì•ˆ í† í°(CSRF)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
            }

            const response = await fetch('{% url "fortune:save_fortune_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfInput.value
                },
                body: JSON.stringify({
                    mode: dailyText ? 'daily' : 'teacher',
                    natal_chart: natalChart,
                    result_text: dailyText ? dailyText : resultText,
                    target_date: dailyText ? document.getElementById('targetDateInput')?.value : null
                })
            });

            // [Mobile Robustness] Content-Type ì²´í¬ ë° ì•ˆì „í•œ íŒŒì‹±
            const contentType = response.headers.get('content-type');
            let data;

            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else {
                const errorText = await response.text();
                console.error("[Mobile Debug] Save Library Non-JSON Response:", errorText.substring(0, 200));
                throw new Error('ì„œë²„ì™€ í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (JSON í˜•ì‹ ì•„ë‹˜)');
            }

            if (data.success) {
                savedResultId = data.result_id; // ì €ì¥ëœ ID ì €ì¥
                showToast('ë³´ê´€í•¨ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ');
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ì¤‘ë³µ ì €ì¥ ë°©ì§€)
                const saveBtn = document.querySelector('#saveSection button');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>ì €ì¥ ì™„ë£Œ';
                    saveBtn.classList.remove('bg-purple-600');
                    saveBtn.classList.add('bg-gray-400');
                }
            } else {
                showToast('ì €ì¥ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        } catch (e) {
            console.error(e);
            showToast(e.message || 'ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì„œë¹„ìŠ¤ ì•ˆë‚´ ëª¨ë‹¬ ì œì–´
    function showInfoModal() {
        document.getElementById('infoModal').classList.remove('hidden');
        document.getElementById('infoModal').classList.add('flex');
    }

    function closeInfoModal() {
        document.getElementById('infoModal').classList.add('hidden');
        document.getElementById('infoModal').classList.remove('flex');
    }

    function closeInfoModalOnBackdrop(event) {
        if (event.target === event.currentTarget) {
            closeInfoModal();
        }
    }

    // ë§ˆí¬ë‹¤ìš´ ì„¹ì…˜ ê·¸ë£¹í™” (ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€)
    function groupMarkdownSections() {
        const container = document.getElementById('markdownResult');
        if (!container) return;

        const children = Array.from(container.children);
        const newContent = document.createDocumentFragment();
        let currentSection = null;

        children.forEach(child => {
            // í—¤ë”(H1~H4)ë¥¼ ë§Œë‚˜ë©´ ìƒˆë¡œìš´ ì„¹ì…˜ ì‹œì‘
            if (['H1', 'H2', 'H3', 'H4'].includes(child.tagName)) {
                if (currentSection) {
                    newContent.appendChild(currentSection);
                }
                currentSection = document.createElement('div');
                currentSection.style.pageBreakInside = 'avoid';
                currentSection.style.breakInside = 'avoid';
                currentSection.style.marginBottom = '1.5rem';
                currentSection.appendChild(child);
            } else {
                // í—¤ë”ê°€ ì•„ë‹ˆë©´ í˜„ì¬ ì„¹ì…˜ì— ì¶”ê°€ (ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì¶”ê°€)
                if (currentSection) {
                    currentSection.appendChild(child);
                } else {
                    // ì²« í—¤ë”ê°€ ë‚˜ì˜¤ê¸° ì „ì˜ ì½˜í…ì¸ ë“¤ (ì˜ˆ: ì„œë¡ )
                    const wrapper = document.createElement('div');
                    wrapper.style.breakInside = 'avoid';
                    wrapper.appendChild(child);
                    newContent.appendChild(wrapper);
                }
            }
        });

        // ë§ˆì§€ë§‰ ì„¹ì…˜ ì¶”ê°€
        if (currentSection) {
            newContent.appendChild(currentSection);
        }

        // ì»¨í…Œì´ë„ˆ ë¹„ìš°ê³  ìƒˆë¡œ ì±„ìš°ê¸°
        container.innerHTML = '';
        container.appendChild(newContent);
    }
</script>

{% if result %}
{{ result|json_script:"saju-result-data" }}
{{ chart|json_script:"saju-chart-data" }}
<script>
    // SSR ê²°ê³¼ ë Œë”ë§
    document.addEventListener('DOMContentLoaded', function () {
        const resultDataElem = document.getElementById('saju-result-data');
        if (resultDataElem) {
            const rawMarkdown = safeJSONParse(resultDataElem.textContent, '');
            marked.setOptions({ breaks: true, gfm: true });
            // SSR ê²°ê³¼ ë Œë”ë§
            const chartDataElem = document.getElementById('saju-chart-data');
            let chartData = null;
            if (chartDataElem) {
                try {
                    chartData = safeJSONParse(chartDataElem.textContent, null);
                } catch (e) { console.error("Chart data parse error:", e); }
            }

            // Template contextì—ì„œ day_master ê°€ì ¸ì˜¤ê¸°
            const dayMaster = {
                char: "{{ day_master.char|default:'' }}",
                element: "{{ day_master.element|default:'' }}"
            };

            updatePremiumUI(rawMarkdown, chartData, "{{ mode|default:'teacher' }}", dayMaster.char ? dayMaster : null, "{{ name|default:'' }}");
        }
    });
</script>
{% endif %}
{% endblock %}