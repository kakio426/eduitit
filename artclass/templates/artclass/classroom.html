{% extends 'base.html' %}
{% load static %}

{% block title %}진행 중 - 몽글몽글 미술수업{% endblock %}

{% block content %}
<main class="min-h-screen pt-32 pb-4 bg-gray-900 overflow-hidden flex flex-col">
    <!-- Header Controls -->
    <header class="h-16 px-6 flex items-center justify-between bg-gray-800/80 backdrop-blur-sm z-50">
        <div class="flex items-center gap-4">
            <a href="{% url 'artclass:setup' %}"
                class="flex items-center gap-2 text-white/80 hover:text-white transition-colors text-xl font-bold px-4 py-2 rounded-xl hover:bg-white/10">
                <i class="fa-solid fa-chevron-left"></i> 나가기
            </a>
            <h1 class="text-xl font-bold text-white hidden md:block">{{ art_class.title|default:"미술 수업" }} 진행 중...</h1>
        </div>

        <button id="btnFullscreen"
            class="text-white/80 hover:text-white p-2 rounded-xl hover:bg-white/10 transition-colors">
            <i class="fa-solid fa-expand text-2xl"></i>
        </button>
    </header>

    <!-- Main Content: Split Screen -->
    <div class="flex-1 flex flex-col lg:flex-row gap-6 p-6 overflow-hidden">

        <!-- Video Section (Left) -->
        <div class="flex-1 bg-black rounded-[2rem] shadow-2xl overflow-hidden relative group">
            <div id="player" class="w-full h-full"></div>
            <!-- Video Overlay Controls -->
            <div
                class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-black/60 backdrop-blur-md px-6 py-3 rounded-full flex gap-6 text-white text-xl z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                <button id="btnLoop" class="hover:text-purple-400 transition" title="구간 반복 설정">
                    <i class="fa-solid fa-repeat"></i> <span id="loopStatus">OFF</span>
                </button>
                <div class="w-px bg-white/30"></div>
                <span class="font-hand" id="totalTimer">00:00</span>
            </div>
        </div>

        <!-- Featured Step Card (Right) -->
        <div class="flex-1 min-w-[400px] flex flex-col gap-6">
            <!-- Current Step Display (Big Card) -->
            <div class="flex-1 relative rounded-[2rem] overflow-hidden shadow-2xl">
                <!-- Step Image Background -->
                <div id="stepImageBg" class="absolute inset-0 bg-gradient-to-br from-purple-600 to-blue-500">
                    <img id="stepImage" src="" alt="" class="w-full h-full object-cover hidden">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
                </div>

                <!-- Step Content -->
                <div class="absolute inset-0 flex flex-col justify-end p-8">
                    <div class="flex items-center gap-4 mb-4">
                        <div id="stepBadge"
                            class="px-6 py-2 rounded-full bg-white/20 backdrop-blur-sm text-white font-bold text-2xl">
                            단계 <span id="currentStepNum">1</span> / <span id="totalStepNum">{{ steps|length }}</span>
                        </div>
                    </div>
                    <p id="stepText"
                        class="text-4xl md:text-5xl font-bold text-white leading-relaxed font-round drop-shadow-lg">
                        {% if steps %}{{ steps.0.description }}{% else %}준비된 단계가 없습니다.{% endif %}
                    </p>
                </div>

                <!-- Timer Progress Bar -->
                <div class="absolute top-0 left-0 right-0 h-2 bg-black/30">
                    <div id="stepProgress" class="h-full bg-purple-400 transition-all duration-100" style="width: 0%">
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="clay-card p-6 bg-[#E0E5EC] rounded-[1.5rem] space-y-4">
                <!-- Speed Control -->
                <div class="flex items-center justify-between gap-4">
                    <span class="text-xl font-bold text-gray-600"><i
                            class="fa-solid fa-stopwatch mr-2 text-blue-500"></i>단계 지속 시간</span>
                    <div class="flex items-center gap-3">
                        <button id="btnDecreaseTime"
                            class="w-12 h-12 rounded-full shadow-clay bg-[#E0E5EC] text-gray-600 hover:text-purple-600 transition text-2xl font-bold">-</button>
                        <span id="currentInterval" class="text-3xl font-bold text-purple-600 w-20 text-center">{{ data.stepInterval }}초</span>
                        <button id="btnIncreaseTime"
                            class="w-12 h-12 rounded-full shadow-clay bg-[#E0E5EC] text-gray-600 hover:text-purple-600 transition text-2xl font-bold">+</button>
                    </div>
                </div>

                <!-- Timer Display -->
                <div class="flex items-center justify-between gap-4 py-2">
                    <span class="text-xl font-bold text-gray-600"><i
                            class="fa-solid fa-hourglass-half mr-2 text-purple-500"></i>다음 단계까지</span>
                    <span id="remainingTime" class="text-4xl font-bold text-purple-600 font-round">{{ data.stepInterval }}</span>
                </div>

                <!-- Main Controls -->
                <div class="flex gap-4">
                    <button id="btnPrev"
                        class="flex-1 py-4 rounded-2xl shadow-clay bg-[#E0E5EC] text-gray-600 hover:text-purple-600 font-bold text-xl transition hover:scale-[1.02] active:scale-95">
                        <i class="fa-solid fa-backward mr-2"></i>이전
                    </button>

                    <button id="btnFreeze"
                        class="flex-1 py-4 rounded-2xl shadow-clay bg-amber-100 text-amber-600 font-bold text-xl transition hover:scale-[1.02] active:scale-95">
                        <i class="fa-solid fa-pause" id="freezeIcon"></i>
                        <span id="freezeText" class="ml-2">일시정지</span>
                    </button>

                    <button id="btnNext"
                        class="flex-1 py-4 rounded-2xl shadow-clay bg-[#E0E5EC] text-gray-600 hover:text-purple-600 font-bold text-xl transition hover:scale-[1.02] active:scale-95">
                        다음<i class="fa-solid fa-forward ml-2"></i>
                    </button>
                </div>

                <!-- Loop Indicator -->
                <div id="loopIndicator" class="text-center text-xl font-hand text-purple-500 hidden">
                    <i class="fa-solid fa-infinity mr-2"></i> 무한 반복 활성화됨
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // Data from Django
    const stepsData = JSON.parse('{{ data_json|escapejs }}');
    const VIDEO_ID = "{{ data.videoUrl }}".match(/(?:v=|youtu\.be\/)([^&?]+)/)?.[1] || '';
    let INTERVAL_MS = parseInt("{{ data.stepInterval }}") * 1000;

    // State
    let currentStep = 0;
    let isPlaying = true;
    let isFrozen = false;
    let timer = 0;
    let lastTime = Date.now();
    let player;
    let loopStart = 0;
    let loopEnd = 0;
    let isLooping = false;

    // Elements
    const stepImage = document.getElementById('stepImage');
    const stepImageBg = document.getElementById('stepImageBg');
    const stepText = document.getElementById('stepText');
    const currentStepNum = document.getElementById('currentStepNum');
    const progressBar = document.getElementById('stepProgress');
    const remainingTimeEl = document.getElementById('remainingTime');
    const currentIntervalEl = document.getElementById('currentInterval');
    const btnFullscreen = document.getElementById('btnFullscreen');
    const loopStatus = document.getElementById('loopStatus');
    const totalTimer = document.getElementById('totalTimer');
    const freezeIcon = document.getElementById('freezeIcon');
    const freezeText = document.getElementById('freezeText');
    const loopIndicator = document.getElementById('loopIndicator');

    // YouTube IFrame API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        if (VIDEO_ID) {
            player = new YT.Player('player', {
                videoId: VIDEO_ID,
                playerVars: {
                    'playsinline': 1,
                    'autoplay': 1,
                    'controls': 1
                },
                events: {
                    'onReady': onPlayerReady
                }
            });
        } else {
            startTimer();
        }
    }

    function onPlayerReady(event) {
        startTimer();
    }

    // Update Featured Step Display
    function updateStepDisplay() {
        const step = stepsData.steps[currentStep];
        if (!step) return;

        // Update text
        stepText.textContent = step.text || '(설명 없음)';
        currentStepNum.textContent = currentStep + 1;

        // Update image
        if (step.image_url) {
            stepImage.src = step.image_url;
            stepImage.classList.remove('hidden');
        } else {
            stepImage.classList.add('hidden');
        }

        // Reset timer for new step
        timer = 0;
    }

    // Timer Loop
    function startTimer() {
        requestAnimationFrame(updateLoop);
    }

    function updateLoop() {
        const now = Date.now();
        const dt = now - lastTime;
        lastTime = now;

        if (isPlaying && !isFrozen) {
            timer += dt;

            // Progress Bar
            const progress = Math.min((timer / INTERVAL_MS) * 100, 100);
            progressBar.style.width = `${progress}%`;

            // Remaining time display
            const remaining = Math.max(0, Math.ceil((INTERVAL_MS - timer) / 1000));
            remainingTimeEl.textContent = remaining;

            // Total Timer
            const totalSeconds = Math.floor(timer / 1000);
            const mins = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
            const secs = String(totalSeconds % 60).padStart(2, '0');
            totalTimer.textContent = `${mins}:${secs}`;

            // Next Step Trigger
            if (timer >= INTERVAL_MS) {
                timer = 0;
                // INFINITE LOOP: Go back to first step after last
                if (currentStep < stepsData.steps.length - 1) {
                    currentStep++;
                } else {
                    currentStep = 0; // Loop back to first step
                    loopIndicator.classList.remove('hidden');
                    setTimeout(() => loopIndicator.classList.add('hidden'), 3000);
                }
                updateStepDisplay();
            }
        }

        // YouTube Loop Logic
        if (player && player.getCurrentTime && isLooping) {
            const curr = player.getCurrentTime();
            if (curr >= loopEnd) {
                player.seekTo(loopStart);
            }
        }

        requestAnimationFrame(updateLoop);
    }

    // Freeze Control
    document.getElementById('btnFreeze').addEventListener('click', () => {
        isFrozen = !isFrozen;
        if (isFrozen) {
            freezeIcon.classList.remove('fa-pause');
            freezeIcon.classList.add('fa-play');
            freezeText.textContent = '계속하기';
            document.getElementById('btnFreeze').classList.add('bg-purple-200', 'text-purple-700');
            document.getElementById('btnFreeze').classList.remove('bg-amber-100', 'text-amber-600');
        } else {
            freezeIcon.classList.remove('fa-play');
            freezeIcon.classList.add('fa-pause');
            freezeText.textContent = '일시정지';
            lastTime = Date.now();
            document.getElementById('btnFreeze').classList.remove('bg-purple-200', 'text-purple-700');
            document.getElementById('btnFreeze').classList.add('bg-amber-100', 'text-amber-600');
        }
    });

    // Speed Control
    document.getElementById('btnIncreaseTime').addEventListener('click', () => {
        INTERVAL_MS += 5000;
        currentIntervalEl.textContent = `${INTERVAL_MS / 1000}초`;
    });

    document.getElementById('btnDecreaseTime').addEventListener('click', () => {
        if (INTERVAL_MS > 5000) {
            INTERVAL_MS -= 5000;
            currentIntervalEl.textContent = `${INTERVAL_MS / 1000}초`;
        }
    });

    // Navigation
    document.getElementById('btnPrev').addEventListener('click', () => {
        if (currentStep > 0) {
            currentStep--;
            updateStepDisplay();
        }
    });

    document.getElementById('btnNext').addEventListener('click', () => {
        if (currentStep < stepsData.steps.length - 1) {
            currentStep++;
        } else {
            currentStep = 0; // Loop
        }
        updateStepDisplay();
    });

    // Fullscreen
    btnFullscreen.addEventListener('click', () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            btnFullscreen.innerHTML = '<i class="fa-solid fa-compress text-2xl"></i>';
        } else {
            document.exitFullscreen();
            btnFullscreen.innerHTML = '<i class="fa-solid fa-expand text-2xl"></i>';
        }
    });

    // Loop Feature
    document.getElementById('btnLoop').addEventListener('click', () => {
        if (!isLooping) {
            if (player && player.getCurrentTime) {
                const now = player.getCurrentTime();
                loopStart = Math.max(0, now - 5);
                loopEnd = now + 5;
                isLooping = true;
                loopStatus.textContent = "ON";
                loopStatus.classList.add('text-purple-400', 'font-bold');
            }
        } else {
            isLooping = false;
            loopStatus.textContent = "OFF";
            loopStatus.classList.remove('text-purple-400', 'font-bold');
        }
    });

    // Init
    updateStepDisplay();
</script>
{% endblock %}