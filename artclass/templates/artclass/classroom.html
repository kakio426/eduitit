{% extends 'base.html' %}
{% load static %}

{% block title %}?섏뾽 吏꾪뻾 以?- Eduitit{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #1a1a1a;
        overflow-x: hidden;
    }

    nav {
        display: none !important;
    }

    /* Hide global nav in classroom mode */

    .text-jumbo {
        font-size: clamp(1.75rem, 4vw, 3rem);
        line-height: 1.3;
        font-weight: 800;
    }

    .glass-dark {
        background: rgba(30, 30, 30, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #stepProgress {
        transition: width 0.1s linear;
    }

    .font-heavy {
        font-weight: 800;
    }

    /* Animation for step change */
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-up {
        animation: slideUp 0.5s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }

    /* Auto-hiding header styles */
    header {
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
    }

    .header-hidden {
        transform: translateY(-100%);
        opacity: 0;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<main class="min-h-screen flex flex-col pt-0 md:pt-0">
    <!-- Top Minimal Bar -->
    <header id="classroomHeader"
        class="h-16 flex items-center justify-between px-6 glass-dark text-white z-50 fixed top-0 w-full">
        <div class="flex items-center gap-4">
            <a href="{% url 'artclass:setup_edit' art_class.pk %}"
                class="flex items-center gap-2 hover:bg-white/10 px-4 py-2 rounded-xl transition-all">
                <i class="fa-solid fa-arrow-left"></i> <span class="font-bold">?몄쭛?쇰줈 ?뚯븘媛湲?/span>
            </a>
            <div class="h-6 w-px bg-white/20"></div>
            <h1 class="text-lg font-bold text-white/80 hidden md:block">?렓 {{ art_class.title|default:"誘몄닠 ?섏뾽" }}</h1>
        </div>
        <div class="flex items-center gap-2">
            <button id="btnFullscreen" class="p-3 hover:bg-white/10 rounded-full transition-all">
                <i class="fa-solid fa-expand text-xl"></i>
            </button>
        </div>
    </header>

    <!-- Split Workspace -->
    <div class="flex-1 flex flex-col lg:flex-row gap-0 overflow-hidden">

        <!-- Left: YouTube Theater -->
        <div class="lg:w-3/5 xl:w-[65%] bg-black relative group flex items-center justify-center">
            <div id="player" class="w-full h-full"></div>

            <!-- Quick Overlays (Bottom) -->
            <div
                class="absolute bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-4 glass-dark px-6 py-3 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-20">
                <button id="btnLoop"
                    class="flex items-center gap-2 text-white font-bold hover:text-purple-400 transition"
                    title="?꾩옱 ?λ㈃ 10珥?援ш컙 諛섎났">
                    <i class="fa-solid fa-repeat"></i> <span id="loopStatus">援ш컙 諛섎났 OFF</span>
                </button>
                <div class="h-4 w-px bg-white/20"></div>
                <span id="totalTimer" class="font-mono text-white/80">00:00</span>
            </div>
        </div>

        <!-- Right: Activity Status Panel -->
        <div class="lg:w-2/5 xl:w-[35%] bg-[#E0E5EC] flex flex-col shadow-2xl relative z-10">

            <!-- Current Activity Feature -->
            <div class="flex-grow flex flex-col">
                <!-- Large Image Context -->
                <div class="h-[30vh] md:h-[40vh] relative bg-gray-300 overflow-hidden">
                    <img id="stepImage" src="" alt="" class="w-full h-full object-cover hidden">
                    <div id="noImage"
                        class="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
                        <i class="fa-solid fa-paintbrush text-6xl mb-4 opacity-30"></i>
                        <p class="font-bold opacity-50">?쒕룞 ?대?吏媛 ?놁뒿?덈떎</p>
                    </div>
                </div>

                <!-- Step Description Card -->
                <div class="p-8 md:p-12 space-y-6">
                    <div class="flex items-center gap-3">
                        <span id="currentStepBadge"
                            class="px-3 py-1 bg-purple-600 text-white rounded-lg font-heavy text-base uppercase shadow-lg">
                            STEP <span id="currentStepNum">1</span>
                        </span>
                        <div class="flex-grow h-1 bg-gray-200 rounded-full overflow-hidden">
                            <div id="stepProgress" class="h-full bg-purple-600" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="stepTextContainer">
                        <p id="stepText" class="text-gray-800 text-jumbo leading-tight break-keep">
                            濡쒕뵫 以?..
                        </p>
                    </div>
                </div>
            </div>

            <!-- Controller Dashboard -->
            <div class="p-6 md:p-8 border-t border-gray-300/50 bg-[#E0E5EC]/80 backdrop-blur-sm space-y-6">
                <!-- Interval Setup & Loop Mode -->
                <div class="flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs font-black text-gray-400 uppercase tracking-widest">?먮룞 ?꾪솚 紐⑤뱶</span>
                        <button id="btnStepRepeat"
                            class="w-14 h-14 rounded-2xl shadow-clay bg-[#E0E5EC] text-gray-400 flex items-center justify-center transition-all relative group"
                            title="?꾩껜 諛섎났 / ???④퀎 諛섎났 ?ㅼ젙">
                            <i class="fa-solid fa-arrows-rotate text-2xl"></i>
                            <span id="stepRepeatBadge"
                                class="absolute top-3 right-3 w-4 h-4 bg-purple-600 text-white text-[10px] flex items-center justify-center rounded-full font-black hidden">1</span>
                        </button>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-xs font-black text-gray-400 uppercase tracking-widest">?ㅼ쓬 ?④퀎源뚯?</span>
                        <div class="flex items-center gap-4">
                            <button id="btnDecreaseTime"
                                class="w-10 h-10 rounded-xl shadow-clay bg-[#E0E5EC] text-gray-600 font-heavy text-xl active:scale-95 transition-all">-</button>
                            <span id="remainingTime"
                                class="text-3xl font-heavy text-purple-600 min-w-[2.5rem] text-center">0</span>
                            <button id="btnIncreaseTime"
                                class="w-10 h-10 rounded-xl shadow-clay bg-[#E0E5EC] text-gray-600 font-heavy text-xl active:scale-95 transition-all">+</button>
                        </div>
                    </div>
                </div>

                <!-- Main Action Buttons -->
                <div class="grid grid-cols-3 gap-4">
                    <button id="btnPrev"
                        class="px-3 py-4 rounded-xl shadow-clay bg-[#E0E5EC] text-gray-600 font-heavy hover:text-purple-600 transition-all flex flex-col items-center gap-2 active:scale-95">
                        <i class="fa-solid fa-backward-step"></i> <span class="text-sm">?댁쟾</span>
                    </button>
                    <button id="btnFreeze"
                        class="px-3 py-4 rounded-xl shadow-clay bg-amber-100 text-amber-600 font-heavy hover:bg-amber-200 transition-all flex flex-col items-center gap-2 active:scale-95">
                        <i id="freezeIcon" class="fa-solid fa-pause"></i> <span id="freezeText"
                            class="text-sm">?쇱떆?뺤?</span>
                    </button>
                    <button id="btnNext"
                        class="px-3 py-4 rounded-xl shadow-clay bg-[#E0E5EC] text-gray-600 font-heavy hover:text-purple-600 transition-all flex flex-col items-center gap-2 active:scale-95">
                        <i class="fa-solid fa-forward-step"></i> <span class="text-sm">?ㅼ쓬</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    const stepsData = JSON.parse('{{ data_json|escapejs }}');
    const VIDEO_ID = "{{ data.videoUrl }}".match(/(?:v=|youtu\.be\/|shorts\/)([^&?]+)/)?.[1] || '';
    let INTERVAL_MS = parseInt("{{ data.stepInterval }}") * 1000;

    let currentStep = 0;
    let isFrozen = false;
    let timer = 0;
    let lastTime = Date.now();
    let player;
    let isLooping = false; // Video section loop
    let loopStart = 0;
    let loopEnd = 0;

    /**
     * Step Repeat Mode
     * 0: None (Stop at last step)
     * 1: Loop All (Loop through all steps)
     * 2: Loop One (Stay on current step)
     */
    let stepRepeatMode = 0;

    // YouTube API Load
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: VIDEO_ID,
            playerVars: {
                'autoplay': 1,
                'controls': 1,
                'playsinline': 1,
                'rel': 0,
                'origin': window.location.origin
            },
            events: { 'onReady': startTimer }
        });
    }

    function updateDisplay() {
        const step = stepsData.steps[currentStep];
        const stepText = document.getElementById('stepText');
        const stepImage = document.getElementById('stepImage');
        const noImage = document.getElementById('noImage');

        // Refresh Animation
        stepText.parentElement.classList.remove('animate-slide-up');
        void stepText.offsetWidth;
        stepText.parentElement.classList.add('animate-slide-up');

        stepText.textContent = step.text || '(?ㅻ챸 ?놁쓬)';
        document.getElementById('currentStepNum').textContent = currentStep + 1;

        if (step.image_url) {
            stepImage.src = step.image_url;
            stepImage.classList.remove('hidden');
            noImage.classList.add('hidden');
        } else {
            stepImage.classList.add('hidden');
            noImage.classList.remove('hidden');
        }
        timer = 0;
    }

    function startTimer() {
        requestAnimationFrame(gameLoop);
    }

    function gameLoop() {
        const now = Date.now();
        const dt = now - lastTime;
        lastTime = now;

        if (!isFrozen) {
            timer += dt;
            const progress = (timer / INTERVAL_MS) * 100;
            document.getElementById('stepProgress').style.width = Math.min(progress, 100) + '%';
            document.getElementById('remainingTime').textContent = Math.max(0, Math.ceil((INTERVAL_MS - timer) / 1000));

            if (timer >= INTERVAL_MS) {
                if (stepRepeatMode === 2) {
                    // Loop One: Stay on current step, just reset timer
                    timer = 0;
                    // Trigger simple refresh animation
                    const stepText = document.getElementById('stepText');
                    stepText.parentElement.classList.remove('animate-slide-up');
                    void stepText.offsetWidth;
                    stepText.parentElement.classList.add('animate-slide-up');
                } else {
                    // Move logic
                    if (currentStep < stepsData.steps.length - 1) {
                        currentStep++;
                        updateDisplay();
                    } else if (stepRepeatMode === 1) {
                        // Loop All: Go back to start
                        currentStep = 0;
                        updateDisplay();
                    } else {
                        // None: Just stay at the end and freeze progress
                        timer = INTERVAL_MS;
                    }
                }
            }
        }

        // Loop Logic
        if (player && player.getCurrentTime && isLooping) {
            if (player.getCurrentTime() >= loopEnd) player.seekTo(loopStart);
        }

        requestAnimationFrame(gameLoop);
    }

    // Controls
    document.getElementById('btnPrev').onclick = () => { if (currentStep > 0) { currentStep--; updateDisplay(); } };
    document.getElementById('btnNext').onclick = () => { currentStep = (currentStep + 1) % stepsData.steps.length; updateDisplay(); };

    document.getElementById('btnFreeze').onclick = () => {
        isFrozen = !isFrozen;
        const icon = document.getElementById('freezeIcon');
        const text = document.getElementById('freezeText');
        const btn = document.getElementById('btnFreeze');

        if (isFrozen) {
            icon.className = 'fa-solid fa-play';
            text.textContent = '怨꾩냽?섍린';
            btn.classList.replace('bg-amber-100', 'bg-blue-600');
            btn.classList.replace('text-amber-600', 'text-white');
        } else {
            icon.className = 'fa-solid fa-pause';
            text.textContent = '?쇱떆?뺤?';
            btn.classList.replace('bg-blue-600', 'bg-amber-100');
            btn.classList.replace('text-white', 'text-amber-600');
            lastTime = Date.now();
        }
    };

    document.getElementById('btnIncreaseTime').onclick = () => { INTERVAL_MS += 5000; };
    document.getElementById('btnDecreaseTime').onclick = () => { if (INTERVAL_MS > 5000) INTERVAL_MS -= 5000; };

    document.getElementById('btnLoop').onclick = () => {
        if (!isLooping) {
            const now = player.getCurrentTime();
            loopStart = Math.max(0, now - 5);
            loopEnd = now + 5;
            isLooping = true;
            document.getElementById('loopStatus').textContent = "援ш컙 諛섎났 ON";
            document.getElementById('loopStatus').style.color = "#a855f7";
        } else {
            isLooping = false;
            document.getElementById('loopStatus').textContent = "援ш컙 諛섎났 OFF";
            document.getElementById('loopStatus').style.color = "white";
        }
    };

    // Step Repeat Mode Toggle
    document.getElementById('btnStepRepeat').onclick = () => {
        stepRepeatMode = (stepRepeatMode + 1) % 3;
        const btn = document.getElementById('btnStepRepeat');
        const badge = document.getElementById('stepRepeatBadge');

        if (stepRepeatMode === 0) {
            // None
            btn.classList.remove('text-purple-600');
            btn.classList.add('text-gray-400');
            badge.classList.add('hidden');
        } else if (stepRepeatMode === 1) {
            // Loop All
            btn.classList.remove('text-gray-400');
            btn.classList.add('text-purple-600');
            badge.classList.add('hidden');
        } else {
            // Loop One
            btn.classList.remove('text-gray-400');
            btn.classList.add('text-purple-600');
            badge.classList.remove('hidden');
        }
    };

    document.getElementById('btnFullscreen').onclick = () => {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else document.exitFullscreen();
    };

    // Auto-hiding Header Logic
    const header = document.getElementById('classroomHeader');
    let headerTimeout;

    function showHeader() {
        header.classList.remove('header-hidden');
        clearTimeout(headerTimeout);

        // Hide after 3 seconds of inactivity
        headerTimeout = setTimeout(() => {
            // Only hide if not interacting with menus (optional)
            header.classList.add('header-hidden');
        }, 3000);
    }

    // Event listeners to trigger showing the header
    document.addEventListener('mousemove', showHeader);
    document.addEventListener('touchstart', showHeader);
    document.addEventListener('keydown', showHeader);

    // Initial trigger
    showHeader();

    // Init
    updateDisplay();
</script>
{% endblock %}
