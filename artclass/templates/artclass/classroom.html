{% extends 'base.html' %}
{% load static %}

{% block title %}ìˆ˜ì—… ì§„í–‰ ì¤‘ - Eduitit{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #1a1a1a;
        overflow-x: hidden;
    }

    nav {
        display: none !important;
    }

    /* Hide global nav in classroom mode */

    .text-jumbo {
        font-size: clamp(1.75rem, 4vw, 3rem);
        line-height: 1.3;
        font-weight: 800;
    }

    .glass-dark {
        background: rgba(30, 30, 30, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #stepProgress {
        transition: width 0.1s linear;
    }

    .font-heavy {
        font-weight: 800;
    }

    /* Animation for step change */
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-up {
        animation: slideUp 0.5s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }

    /* Auto-hiding header styles */
    header {
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
    }

    .header-hidden {
        transform: translateY(-100%);
        opacity: 0;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<main class="h-[100dvh] pt-16 overflow-hidden">
    <!-- Top Minimal Bar -->
    <header id="classroomHeader"
        class="h-16 flex items-center justify-between px-6 glass-dark text-white z-50 fixed top-0 w-full">
        <div class="flex items-center gap-4">
            <a href="{% url 'artclass:setup_edit' art_class.pk %}"
                class="flex items-center gap-2 hover:bg-white/10 px-4 py-2 rounded-xl transition-all">
                <i class="fa-solid fa-arrow-left"></i> <span class="font-bold">í¸ì§‘ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
            </a>
            <div class="h-6 w-px bg-white/20"></div>
            <h1 class="text-lg font-bold text-white/80 hidden md:block">ğŸ¨ {{ art_class.title|default:"ë¯¸ìˆ  ìˆ˜ì—…" }}</h1>
        </div>
        <div class="flex items-center gap-2">
            <span id="externalWindowStatusBadge"
                class="hidden px-2.5 py-1 rounded-full text-[11px] font-black tracking-wide bg-gray-700/70 text-gray-200 border border-white/10">
                ì˜ìƒ ì°½ ë‹«í˜
            </span>
            <button id="btnStartSplitMode"
                class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-sm font-bold transition-all flex items-center gap-2">
                <i class="fa-solid fa-table-columns"></i> í™”ë©´ ë¶„í•  ì‹œì‘
            </button>
            <button id="btnFullscreen" class="p-3 hover:bg-white/10 rounded-full transition-all">
                <i class="fa-solid fa-expand text-xl"></i>
            </button>
        </div>
    </header>

    <!-- Split Workspace -->
    <div class="h-full min-h-0 flex flex-col lg:flex-row gap-0 overflow-hidden">

        <!-- Left: YouTube Theater -->
        <div id="videoPanel" class="lg:w-3/5 xl:w-[65%] bg-black relative group flex items-center justify-center">
            <div id="player" class="w-full h-full"></div>
            <div id="externalVideoOverlay" class="absolute inset-0 hidden items-center justify-center bg-black/70 p-6 z-10">
                <div class="max-w-xl w-full rounded-2xl bg-white/95 text-gray-900 p-6 md:p-8 shadow-2xl">
                    <div class="flex items-start gap-3">
                        <div class="w-11 h-11 rounded-full bg-red-100 text-red-600 flex items-center justify-center shrink-0">
                            <i class="fa-brands fa-youtube text-xl"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <h3 class="text-lg font-black text-gray-900">ìƒˆ ì°½ ì¬ìƒ ëª¨ë“œ</h3>
                            <p id="externalVideoMessage" class="text-sm text-gray-700 mt-2 leading-relaxed">
                                ìœ íŠœë¸Œ ì˜ìƒì„ ìƒˆ ì°½ìœ¼ë¡œ ì—´ì–´ ìˆ˜ì—…ì„ ê³„ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                            <div class="mt-3 rounded-xl border border-amber-200 bg-amber-50 p-3">
                                <p class="text-[11px] font-black text-amber-700 uppercase tracking-widest">í•œ ì˜ìƒ ë°˜ë³µ ì¬ìƒ íŒ</p>
                                <p class="mt-1 text-xs text-amber-800 leading-relaxed">
                                    ìƒˆ ì°½ ìœ íŠœë¸Œ í™”ë©´ì—ì„œ <strong>ë§ˆìš°ìŠ¤ ì˜¤ë¥¸ìª½ í´ë¦­</strong> í›„
                                    <strong>ë™ì˜ìƒ ì—°ì† ì¬ìƒ</strong>ì„ ì¼œ ì£¼ì„¸ìš”.
                                    (ë°˜ë³µ ì¬ìƒ URLë„ í•¨ê»˜ ì ìš©ë©ë‹ˆë‹¤)
                                </p>
                            </div>
                            <p class="mt-3 text-xs text-gray-600 leading-relaxed">
                                ë¸Œë¼ìš°ì € ì •ì±…ìƒ ì°½ì„ ìë™ìœ¼ë¡œ <strong>í•­ìƒ ìœ„</strong>ë¡œ ê³ ì •í•  ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤.
                                ëŒ€ì‹  ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì˜ìƒ ì°½ì„ ì•ìœ¼ë¡œ ê°€ì ¸ì˜¤ê±°ë‚˜, ìƒˆ ì°½ ìœ íŠœë¸Œ ë©”ë‰´ì˜
                                <strong>í™”ë©´ ì† í™”ë©´(PiP)</strong>ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.
                            </p>
                        </div>
                    </div>
                    <div class="mt-5 flex flex-wrap gap-2">
                        <button id="btnOpenExternalVideo"
                            class="px-4 py-2.5 rounded-xl bg-red-600 text-white text-sm font-bold hover:bg-red-700 transition-all">
                            ìƒˆ ì°½ ì—´ê¸°(ë°˜ë³µ ì¬ìƒ)
                        </button>
                        <button id="btnFocusExternalVideo"
                            class="px-4 py-2.5 rounded-xl bg-white/90 text-gray-700 border border-gray-300 text-sm font-semibold hover:bg-white transition-all disabled:opacity-40 disabled:cursor-not-allowed">
                            ì˜ìƒ ì°½ ì•ìœ¼ë¡œ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Overlays (Bottom) -->
            <div
                class="absolute bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-4 glass-dark px-6 py-3 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-20">
                <button id="btnLoop"
                    class="flex items-center gap-2 text-white font-bold hover:text-purple-400 transition"
                    title="í˜„ì¬ ì¥ë©´ 10ì´ˆ êµ¬ê°„ ë°˜ë³µ">
                    <i class="fa-solid fa-repeat"></i> <span id="loopStatus">êµ¬ê°„ ë°˜ë³µ OFF</span>
                </button>
                <div class="h-4 w-px bg-white/20"></div>
                <span id="totalTimer" class="font-mono text-white/80">00:00</span>
            </div>
        </div>

        <!-- Right: Activity Status Panel -->
        <div class="lg:w-2/5 xl:w-[35%] bg-[#E0E5EC] flex flex-col min-h-0 shadow-2xl relative z-10">

            <!-- Current Activity Feature -->
            <div class="flex-grow flex flex-col min-h-0 overflow-hidden">
                <!-- Large Image Context -->
                <div class="h-[22vh] sm:h-[26vh] md:h-[30vh] xl:h-[34vh] shrink-0 relative bg-gray-300 overflow-hidden">
                    <img id="stepImage" src="" alt="" class="w-full h-full object-cover hidden">
                    <div id="noImage"
                        class="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
                        <i class="fa-solid fa-paintbrush text-6xl mb-4 opacity-30"></i>
                        <p class="font-bold opacity-50">í™œë™ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>

                <!-- Step Description Card -->
                <div class="p-8 md:p-12 space-y-6 flex-1 flex flex-col overflow-hidden">
                    <div class="flex items-center gap-3 shrink-0">
                        <span id="currentStepBadge"
                            class="px-3 py-1 bg-purple-600 text-white rounded-lg font-heavy text-base uppercase shadow-lg">
                            STEP <span id="currentStepNum">1</span>
                        </span>
                        <div class="flex-grow h-1 bg-gray-200 rounded-full overflow-hidden">
                            <div id="stepProgress" class="h-full bg-purple-600" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="stepTextContainer" class="min-h-0 flex-1 overflow-y-auto pr-2 dt-scrollbar">
                        <p id="stepText" class="text-gray-800 text-jumbo leading-tight break-keep mb-6">
                            ë¡œë”© ì¤‘...
                        </p>
                    </div>
                </div>
            </div>

            <!-- Controller Dashboard -->
            <div class="shrink-0 p-6 md:p-8 border-t border-gray-300/50 bg-[#E0E5EC]/80 backdrop-blur-sm space-y-6">
                <!-- Interval Setup & Loop Mode -->
                <div class="flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs font-black text-gray-400 uppercase tracking-widest">ìë™ ì „í™˜ ëª¨ë“œ</span>
                        <button id="btnStepRepeat"
                            class="w-14 h-14 rounded-2xl shadow-clay bg-[#E0E5EC] text-gray-400 flex items-center justify-center transition-all relative group"
                            title="ì „ì²´ ë°˜ë³µ / í•œ ë‹¨ê³„ ë°˜ë³µ ì„¤ì •">
                            <i class="fa-solid fa-arrows-rotate text-2xl"></i>
                            <span id="stepRepeatBadge"
                                class="absolute top-3 right-3 w-4 h-4 bg-purple-600 text-white text-[10px] flex items-center justify-center rounded-full font-black hidden">1</span>
                        </button>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-xs font-black text-gray-400 uppercase tracking-widest">ë‹¤ìŒ ë‹¨ê³„ê¹Œì§€</span>
                        <div class="flex items-center gap-4">
                            <button id="btnDecreaseTime"
                                class="w-10 h-10 rounded-xl shadow-clay bg-[#E0E5EC] text-gray-600 font-heavy text-xl active:scale-95 transition-all">-</button>
                            <span id="remainingTime"
                                class="text-3xl font-heavy text-purple-600 min-w-[2.5rem] text-center">0</span>
                            <button id="btnIncreaseTime"
                                class="w-10 h-10 rounded-xl shadow-clay bg-[#E0E5EC] text-gray-600 font-heavy text-xl active:scale-95 transition-all">+</button>
                        </div>
                    </div>
                </div>

                <!-- Main Action Buttons -->
                <div class="grid grid-cols-3 gap-4">
                    <button id="btnPrev"
                        class="px-3 py-4 rounded-xl shadow-clay bg-[#E0E5EC] text-gray-600 font-heavy hover:text-purple-600 transition-all flex flex-col items-center gap-2 active:scale-95">
                        <i class="fa-solid fa-backward-step"></i> <span class="text-sm">ì´ì „</span>
                    </button>
                    <button id="btnFreeze"
                        class="px-3 py-4 rounded-xl shadow-clay bg-amber-100 text-amber-600 font-heavy hover:bg-amber-200 transition-all flex flex-col items-center gap-2 active:scale-95">
                        <i id="freezeIcon" class="fa-solid fa-pause"></i> <span id="freezeText"
                            class="text-sm">ì¼ì‹œì •ì§€</span>
                    </button>
                    <button id="btnNext"
                        class="px-3 py-4 rounded-xl shadow-clay bg-[#E0E5EC] text-gray-600 font-heavy hover:text-purple-600 transition-all flex flex-col items-center gap-2 active:scale-95">
                        <i class="fa-solid fa-forward-step"></i> <span class="text-sm">ë‹¤ìŒ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    const stepsData = JSON.parse('{{ data_json|escapejs }}');
    const CLASSROOM_ID = Number('{{ art_class.pk }}');
    const PLAYBACK_MODE_UPDATE_URL = '{% url "artclass:update_playback_mode_api" art_class.pk %}';
    const VIDEO_URL = "{{ data.videoUrl|escapejs }}";
    const VIDEO_ID = extractYouTubeVideoId(VIDEO_URL);
    const PLAYBACK_MODE_STORAGE_KEY = `artclass_playback_mode_${CLASSROOM_ID}`;
    const savedPlaybackMode = localStorage.getItem(PLAYBACK_MODE_STORAGE_KEY);
    const defaultPlaybackMode = stepsData.playbackMode || 'embed';
    let playbackMode = isValidPlaybackMode(savedPlaybackMode) ? savedPlaybackMode : defaultPlaybackMode;
    let INTERVAL_MS = parseInt("{{ data.stepInterval }}", 10) * 1000;

    let currentStep = 0;
    let isFrozen = false;
    let timer = 0;
    let lastTime = Date.now();
    let player;
    let currentPlayerHost = 'https://www.youtube-nocookie.com';
    let youtubeApiRequested = false;
    let externalVideoPopup = null;
    let isLooping = false; // Video section loop
    let loopStart = 0;
    let loopEnd = 0;
    let timerStarted = false;

    /**
     * Step Repeat Mode
     * 0: None (Stop at last step)
     * 1: Loop All (Loop through all steps)
     * 2: Loop One (Stay on current step)
     */
    let stepRepeatMode = 0;

    const loopStatusEl = document.getElementById('loopStatus');
    const btnLoopEl = document.getElementById('btnLoop');
    const externalVideoOverlayEl = document.getElementById('externalVideoOverlay');
    const externalVideoMessageEl = document.getElementById('externalVideoMessage');
    const videoPanelEl = document.getElementById('videoPanel');
    const playerEl = document.getElementById('player');
    const btnOpenExternalVideoEl = document.getElementById('btnOpenExternalVideo');
    const btnFocusExternalVideoEl = document.getElementById('btnFocusExternalVideo');
    const btnStartSplitModeEl = document.getElementById('btnStartSplitMode');
    const externalWindowStatusBadgeEl = document.getElementById('externalWindowStatusBadge');

    function setExternalWindowStatus(status) {
        if (!externalWindowStatusBadgeEl) return;
        externalWindowStatusBadgeEl.classList.remove(
            'hidden',
            'bg-emerald-500/20',
            'text-emerald-200',
            'border-emerald-300/30',
            'bg-gray-700/70',
            'text-gray-200',
            'border-white/10'
        );
        if (status === 'connected') {
            externalWindowStatusBadgeEl.textContent = 'ì˜ìƒ ì°½ ì—°ê²°ë¨';
            externalWindowStatusBadgeEl.classList.add('bg-emerald-500/20', 'text-emerald-200', 'border-emerald-300/30');
            if (btnFocusExternalVideoEl) btnFocusExternalVideoEl.disabled = false;
            return;
        }
        externalWindowStatusBadgeEl.textContent = 'ì˜ìƒ ì°½ ë‹«í˜';
        externalWindowStatusBadgeEl.classList.add('bg-gray-700/70', 'text-gray-200', 'border-white/10');
        if (btnFocusExternalVideoEl) btnFocusExternalVideoEl.disabled = true;
    }

    function isValidPlaybackMode(mode) {
        return mode === 'embed' || mode === 'external_window';
    }

    function extractYouTubeVideoId(url) {
        if (!url) return '';

        try {
            const parsed = new URL(url, window.location.origin);
            const hostname = parsed.hostname.replace(/^www\./, '');

            if (hostname === 'youtu.be') {
                return parsed.pathname.split('/').filter(Boolean)[0] || '';
            }
            if (hostname.endsWith('youtube.com')) {
                if (parsed.pathname === '/watch') {
                    return parsed.searchParams.get('v') || '';
                }
                const pathParts = parsed.pathname.split('/').filter(Boolean);
                const key = pathParts[0];
                if (key === 'embed' || key === 'shorts' || key === 'live') {
                    return pathParts[1] || '';
                }
            }
        } catch (_) {
            // URL parsing failed, fall through to regex fallback.
        }

        return url.match(/(?:v=|youtu\.be\/|shorts\/|embed\/|live\/)([A-Za-z0-9_-]{6,})/)?.[1] || '';
    }

    function escapeHtml(value) {
        return String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function setExternalOverlay(visible, message = '') {
        if (visible) {
            externalVideoMessageEl.textContent = message || 'ìœ íŠœë¸Œ ì˜ìƒì„ ìƒˆ ì°½ìœ¼ë¡œ ì—´ì–´ ìˆ˜ì—…ì„ ê³„ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            externalVideoOverlayEl.classList.remove('hidden');
            externalVideoOverlayEl.classList.add('flex');
            return;
        }
        externalVideoOverlayEl.classList.remove('flex');
        externalVideoOverlayEl.classList.add('hidden');
    }

    function setLoopControlEnabled(enabled) {
        if (enabled) {
            btnLoopEl.disabled = false;
            btnLoopEl.classList.remove('opacity-40', 'cursor-not-allowed');
            if (!isLooping) {
                loopStatusEl.textContent = 'êµ¬ê°„ ë°˜ë³µ OFF';
                loopStatusEl.style.color = 'white';
            }
            return;
        }
        isLooping = false;
        loopStatusEl.textContent = 'ì™¸ë¶€ì°½ ëª¨ë“œ';
        loopStatusEl.style.color = '#fbbf24';
        btnLoopEl.disabled = true;
        btnLoopEl.classList.add('opacity-40', 'cursor-not-allowed');
    }

    function applyLocalPlaybackMode(mode) {
        playbackMode = mode;
        localStorage.setItem(PLAYBACK_MODE_STORAGE_KEY, mode);
    }

    async function persistPlaybackMode(mode) {
        if (!isValidPlaybackMode(mode)) return;
        applyLocalPlaybackMode(mode);
        try {
            const response = await fetch(PLAYBACK_MODE_UPDATE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ mode }),
            });
            if (!response.ok) {
                throw new Error(`status=${response.status}`);
            }
        } catch (err) {
            console.error('Playback mode save failed:', err);
        }
    }

    function buildExternalVideoUrl() {
        if (!VIDEO_ID) return VIDEO_URL;
        try {
            const loopUrl = new URL('https://www.youtube.com/watch');
            loopUrl.searchParams.set('v', VIDEO_ID);
            loopUrl.searchParams.set('loop', '1');
            loopUrl.searchParams.set('playlist', VIDEO_ID);
            loopUrl.searchParams.set('autoplay', '1');
            return loopUrl.toString();
        } catch (_) {
            return `https://www.youtube.com/watch?v=${encodeURIComponent(VIDEO_ID)}&loop=1&playlist=${encodeURIComponent(VIDEO_ID)}&autoplay=1`;
        }
    }

    function focusExternalVideoWindow() {
        if (!externalVideoPopup) return false;
        try {
            if (externalVideoPopup.closed) {
                externalVideoPopup = null;
                setExternalWindowStatus('closed');
                return false;
            }
            externalVideoPopup.focus();
            setExternalWindowStatus('connected');
            return true;
        } catch (_) {
            externalVideoPopup = null;
            setExternalWindowStatus('closed');
            return false;
        }
    }

    function openExternalVideoWindow(options = {}) {
        const split = options.split === true;
        const forceReopen = options.forceReopen === true;
        if (!VIDEO_URL) {
            setExternalOverlay(true, 'ì˜ìƒ ì£¼ì†Œê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. í¸ì§‘ í™”ë©´ì—ì„œ ìœ íŠœë¸Œ ì£¼ì†Œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
            return false;
        }
        if (!forceReopen && focusExternalVideoWindow()) {
            setExternalOverlay(true, 'ì—´ë ¤ ìˆëŠ” ì˜ìƒ ì°½ì„ ì•ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤. í•­ìƒ ìœ„ê°€ í•„ìš”í•˜ë©´ ìƒˆ ì°½ì—ì„œ í™”ë©´ ì† í™”ë©´(PiP)ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
            return true;
        }
        let width;
        let height;
        let left;
        let top;

        if (split) {
            const screenWidth = window.screen.availWidth || window.innerWidth;
            const screenHeight = window.screen.availHeight || window.innerHeight;
            width = Math.max(540, Math.floor(screenWidth / 2));
            height = Math.max(420, screenHeight);
            left = typeof window.screen.availLeft === 'number' ? window.screen.availLeft : 0;
            top = typeof window.screen.availTop === 'number' ? window.screen.availTop : 0;
        } else {
            const rect = videoPanelEl.getBoundingClientRect();
            width = Math.max(720, Math.round(rect.width));
            height = Math.max(420, Math.round(rect.height));
            left = Math.max(0, Math.round(window.screenX + rect.left));
            top = Math.max(0, Math.round(window.screenY + rect.top));
        }

        const popup = window.open(
            buildExternalVideoUrl(),
            `artclass_video_${CLASSROOM_ID}`,
            `popup=yes,width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
        );
        if (!popup) {
            setExternalOverlay(true, 'íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì—ì„œ íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì—´ì–´ ì£¼ì„¸ìš”.');
            setExternalWindowStatus('closed');
            return false;
        }
        externalVideoPopup = popup;
        setExternalWindowStatus('connected');
        popup.focus();
        setExternalOverlay(true, 'ìƒˆ ì°½ì—ì„œ ì˜ìƒì„ ì¬ìƒ ì¤‘ì…ë‹ˆë‹¤. ì˜ìƒ ì°½ì´ ê°€ë ¤ì¡Œë‹¤ë©´ ë‹¤ì‹œ ì—´ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.');
        return true;
    }

    function tryMoveCurrentWindowToRightHalf() {
        const screenWidth = window.screen.availWidth || window.innerWidth;
        const screenHeight = window.screen.availHeight || window.innerHeight;
        const halfWidth = Math.max(540, Math.floor(screenWidth / 2));
        const baseLeft = typeof window.screen.availLeft === 'number' ? window.screen.availLeft : 0;
        const baseTop = typeof window.screen.availTop === 'number' ? window.screen.availTop : 0;

        try {
            window.resizeTo(halfWidth, screenHeight);
            window.moveTo(baseLeft + halfWidth, baseTop);
        } catch (_) {
            // Browser may block move/resize for non-popup windows.
        }
    }

    function destroyPlayerSafely() {
        if (player && typeof player.destroy === 'function') {
            player.destroy();
        }
        player = null;
        playerEl.innerHTML = '';
    }

    function switchToExternalMode(message, persist = true) {
        destroyPlayerSafely();
        setLoopControlEnabled(false);
        setExternalOverlay(true, message);
        if (persist) {
            persistPlaybackMode('external_window');
        }
        startTimer();
    }

    function loadYouTubeApi() {
        if (youtubeApiRequested) return;
        youtubeApiRequested = true;
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        tag.onerror = () => {
            console.error('YouTube Iframe API load failed');
            switchToExternalMode('ìœ íŠœë¸Œ í”Œë ˆì´ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•´ ìƒˆ ì°½ ì¬ìƒ ëª¨ë“œë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.', false);
        };
        document.head.appendChild(tag);
    }

    function handleYouTubeError(errorCode) {
        console.error('YouTube Player Error:', errorCode);
        if (currentPlayerHost === 'https://www.youtube-nocookie.com') {
            createYouTubePlayer('https://www.youtube.com');
            return;
        }
        if (errorCode === 101 || errorCode === 150) {
            switchToExternalMode('ì´ ì˜ìƒì€ ìœ íŠœë¸Œ ì •ì±…ìœ¼ë¡œ ë‚´ì¥ ì¬ìƒì´ ì œí•œë˜ì–´ ìƒˆ ì°½ ì¬ìƒ ëª¨ë“œë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.');
            return;
        }
        switchToExternalMode('ì˜ìƒì„ ì¬ìƒí•˜ì§€ ëª»í•´ ìƒˆ ì°½ ì¬ìƒ ëª¨ë“œë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.', false);
    }

    function createYouTubePlayer(host) {
        if (!VIDEO_ID) {
            switchToExternalMode('ìœ íš¨í•œ ìœ íŠœë¸Œ ì˜ìƒ ì£¼ì†Œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.', false);
            return;
        }
        if (!(window.YT && window.YT.Player)) {
            loadYouTubeApi();
            return;
        }
        currentPlayerHost = host;
        setExternalOverlay(false);
        setLoopControlEnabled(true);
        destroyPlayerSafely();
        player = new YT.Player('player', {
            videoId: VIDEO_ID,
            host,
            playerVars: {
                autoplay: 1,
                mute: 1,
                controls: 1,
                playsinline: 1,
                rel: 0,
                modestbranding: 1,
                enablejsapi: 1,
                origin: window.location.origin,
            },
            events: {
                onReady: (event) => {
                    try {
                        event.target.mute();
                        event.target.playVideo();
                    } catch (_) {
                        // autoplay policy
                    }
                    startTimer();
                },
                onError: (e) => handleYouTubeError(e.data),
            },
        });
    }

    function initVideoPlayback() {
        if (playbackMode === 'external_window') {
            switchToExternalMode('ì´ ìˆ˜ì—…ì€ ìƒˆ ì°½ ì¬ìƒ ëª¨ë“œë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.', false);
            return;
        }
        createYouTubePlayer('https://www.youtube-nocookie.com');
    }

    window.onYouTubeIframeAPIReady = function onYouTubeIframeAPIReady() {
        if (playbackMode !== 'embed') return;
        createYouTubePlayer('https://www.youtube-nocookie.com');
    };

    function parseStepText(rawText) {
        if (!rawText) return { mainText: '(ì„¤ëª… ì—†ìŒ)', materials: null, tip: null };

        const lines = String(rawText)
            .replace(/\r\n?/g, '\n')
            .split('\n')
            .map((line) => line.trim())
            .filter(Boolean)
            .map((line) => line.replace(/^\[\s*\d{1,2}:\d{2}\s*[-~]\s*\d{1,2}:\d{2}\s*\]\s*/g, ''))
            .map((line) => line.replace(/^[-*â€¢]\s*/, '').trim())
            .filter(Boolean);

        const mainLines = [];
        const materials = [];
        const tips = [];

        lines.forEach((line) => {
            const materialMatch = line.match(/^ì¤€ë¹„ë¬¼\s*:\s*(.+)$/);
            if (materialMatch) {
                materialMatch[1]
                    .split(/\s*[,/Â·ã†]\s*/g)
                    .map((item) => item.trim())
                    .filter(Boolean)
                    .forEach((item) => materials.push(item));
                return;
            }

            const tipMatch = line.match(/^êµì‚¬\s*íŒ\s*:\s*(.+)$/);
            if (tipMatch) {
                tips.push(tipMatch[1].trim());
                return;
            }

            mainLines.push(line);
        });

        const uniqueMaterials = [...new Set(materials)];
        return {
            mainText: mainLines.join('\n').trim() || '(ì„¤ëª… ì—†ìŒ)',
            materials: uniqueMaterials.length ? uniqueMaterials : null,
            tip: tips.length ? tips.join(' ') : null
        };
    }

    function updateDisplay() {
        const step = stepsData.steps[currentStep];
        const stepTextContainer = document.getElementById('stepTextContainer');
        const stepImage = document.getElementById('stepImage');
        const noImage = document.getElementById('noImage');

        // Refresh Animation
        stepTextContainer.parentElement.classList.remove('animate-slide-up');
        void stepTextContainer.offsetWidth;
        stepTextContainer.parentElement.classList.add('animate-slide-up');

        const parsed = parseStepText(step.text);

        let html = `<p id="stepText" class="text-gray-800 text-jumbo leading-tight break-keep whitespace-pre-line ${parsed.materials || parsed.tip ? 'mb-6' : 'mb-0'}">${escapeHtml(parsed.mainText)}</p>`;

        if (parsed.materials) {
            const materialBadges = parsed.materials
                .map((material) => `<span class="inline-flex items-center px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-bold border border-indigo-200">${escapeHtml(material)}</span>`)
                .join('');
            html += `
                <div class="mt-4">
                    <p class="text-[11px] uppercase tracking-widest text-indigo-500/80 mb-2 font-black">ì¤€ë¹„ë¬¼</p>
                    <div class="flex flex-wrap gap-2">
                        ${materialBadges}
                    </div>
                </div>
            `;
        }
        if (parsed.tip) {
            html += `
                <div class="mt-4 p-5 bg-amber-50 text-amber-800 rounded-2xl border border-amber-200 flex items-start gap-4 shadow-sm">
                    <div class="mt-1 w-10 h-10 flex items-center justify-center bg-amber-200 rounded-full shrink-0">
                        <i class="fa-solid fa-lightbulb text-amber-600 text-lg"></i>
                    </div>
                    <div>
                        <p class="text-[11px] uppercase tracking-widest text-amber-600/80 mb-1 font-black">êµì‚¬ íŒ / ì¶”ê°€ ì•ˆë‚´</p>
                        <p class="text-base md:text-lg font-bold whitespace-pre-line">${escapeHtml(parsed.tip)}</p>
                    </div>
                </div>
            `;
        }

        stepTextContainer.innerHTML = html;
        stepTextContainer.scrollTop = 0;
        document.getElementById('currentStepNum').textContent = currentStep + 1;

        if (step.image_url) {
            stepImage.src = step.image_url;
            stepImage.classList.remove('hidden');
            noImage.classList.add('hidden');
        } else {
            stepImage.classList.add('hidden');
            noImage.classList.remove('hidden');
        }
        timer = 0;
    }

    function startTimer() {
        if (timerStarted) return;
        timerStarted = true;
        lastTime = Date.now();
        requestAnimationFrame(gameLoop);
    }

    function gameLoop() {
        const now = Date.now();
        const dt = now - lastTime;
        lastTime = now;

        if (!isFrozen) {
            timer += dt;
            const progress = (timer / INTERVAL_MS) * 100;
            document.getElementById('stepProgress').style.width = Math.min(progress, 100) + '%';
            document.getElementById('remainingTime').textContent = Math.max(0, Math.ceil((INTERVAL_MS - timer) / 1000));

            if (timer >= INTERVAL_MS) {
                if (stepRepeatMode === 2) {
                    // Loop One: Stay on current step, just reset timer
                    timer = 0;
                    // Trigger simple refresh animation
                    const stepText = document.getElementById('stepText');
                    stepText.parentElement.classList.remove('animate-slide-up');
                    void stepText.offsetWidth;
                    stepText.parentElement.classList.add('animate-slide-up');
                } else {
                    // Move logic
                    if (currentStep < stepsData.steps.length - 1) {
                        currentStep++;
                        updateDisplay();
                    } else if (stepRepeatMode === 1) {
                        // Loop All: Go back to start
                        currentStep = 0;
                        updateDisplay();
                    } else {
                        // None: Just stay at the end and freeze progress
                        timer = INTERVAL_MS;
                    }
                }
            }
        }

        // Loop Logic
        if (playbackMode === 'embed' && player && player.getCurrentTime && isLooping) {
            if (player.getCurrentTime() >= loopEnd) player.seekTo(loopStart);
        }

        requestAnimationFrame(gameLoop);
    }

    // Controls
    document.getElementById('btnPrev').onclick = () => { if (currentStep > 0) { currentStep--; updateDisplay(); } };
    document.getElementById('btnNext').onclick = () => { currentStep = (currentStep + 1) % stepsData.steps.length; updateDisplay(); };

    document.getElementById('btnFreeze').onclick = () => {
        isFrozen = !isFrozen;
        const icon = document.getElementById('freezeIcon');
        const text = document.getElementById('freezeText');
        const btn = document.getElementById('btnFreeze');

        if (isFrozen) {
            icon.className = 'fa-solid fa-play';
            text.textContent = 'ê³„ì†í•˜ê¸°';
            btn.classList.replace('bg-amber-100', 'bg-blue-600');
            btn.classList.replace('text-amber-600', 'text-white');
        } else {
            icon.className = 'fa-solid fa-pause';
            text.textContent = 'ì¼ì‹œì •ì§€';
            btn.classList.replace('bg-blue-600', 'bg-amber-100');
            btn.classList.replace('text-white', 'text-amber-600');
            lastTime = Date.now();
        }
    };

    document.getElementById('btnIncreaseTime').onclick = () => { INTERVAL_MS += 5000; };
    document.getElementById('btnDecreaseTime').onclick = () => { if (INTERVAL_MS > 5000) INTERVAL_MS -= 5000; };

    btnLoopEl.onclick = () => {
        if (playbackMode !== 'embed' || !player || typeof player.getCurrentTime !== 'function') {
            return;
        }

        if (!isLooping) {
            const now = player.getCurrentTime();
            loopStart = Math.max(0, now - 5);
            loopEnd = now + 5;
            isLooping = true;
            loopStatusEl.textContent = "êµ¬ê°„ ë°˜ë³µ ON";
            loopStatusEl.style.color = "#a855f7";
        } else {
            isLooping = false;
            loopStatusEl.textContent = "êµ¬ê°„ ë°˜ë³µ OFF";
            loopStatusEl.style.color = "white";
        }
    };

    btnOpenExternalVideoEl.onclick = async () => {
        const opened = openExternalVideoWindow();
        if (!opened) return;
        await persistPlaybackMode('external_window');
    };

    if (btnFocusExternalVideoEl) {
        btnFocusExternalVideoEl.onclick = async () => {
            if (focusExternalVideoWindow()) {
                setExternalOverlay(true, 'ì—´ë ¤ ìˆëŠ” ì˜ìƒ ì°½ì„ ì•ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.');
                return;
            }
            const opened = openExternalVideoWindow();
            if (!opened) return;
            await persistPlaybackMode('external_window');
        };
    }

    setInterval(() => {
        if (!externalVideoPopup) return;
        if (externalVideoPopup.closed) {
            externalVideoPopup = null;
            setExternalWindowStatus('closed');
        }
    }, 1500);

    if (btnStartSplitModeEl) {
        btnStartSplitModeEl.onclick = () => {
            const opened = openExternalVideoWindow({ split: true });
            if (!opened) return;
            tryMoveCurrentWindowToRightHalf();
            switchToExternalMode('í™”ë©´ ë¶„í•  ëª¨ë“œë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤. ì™¼ìª½ ì°½ì€ ìœ íŠœë¸Œ, ì˜¤ë¥¸ìª½ ì°½ì€ ìˆ˜ì—… ì•ˆë‚´ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.');
        };
    }

    // Step Repeat Mode Toggle
    document.getElementById('btnStepRepeat').onclick = () => {
        stepRepeatMode = (stepRepeatMode + 1) % 3;
        const btn = document.getElementById('btnStepRepeat');
        const badge = document.getElementById('stepRepeatBadge');

        if (stepRepeatMode === 0) {
            // None
            btn.classList.remove('text-purple-600');
            btn.classList.add('text-gray-400');
            badge.classList.add('hidden');
        } else if (stepRepeatMode === 1) {
            // Loop All
            btn.classList.remove('text-gray-400');
            btn.classList.add('text-purple-600');
            badge.classList.add('hidden');
        } else {
            // Loop One
            btn.classList.remove('text-gray-400');
            btn.classList.add('text-purple-600');
            badge.classList.remove('hidden');
        }
    };

    document.getElementById('btnFullscreen').onclick = () => {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else document.exitFullscreen();
    };

    // Auto-hiding Header Logic
    const header = document.getElementById('classroomHeader');
    let headerTimeout;

    function showHeader() {
        header.classList.remove('header-hidden');
        clearTimeout(headerTimeout);

        // Hide after 3 seconds of inactivity
        headerTimeout = setTimeout(() => {
            // Only hide if not interacting with menus (optional)
            header.classList.add('header-hidden');
        }, 3000);
    }

    // Event listeners to trigger showing the header
    document.addEventListener('mousemove', showHeader);
    document.addEventListener('touchstart', showHeader);
    document.addEventListener('keydown', showHeader);

    // Initial trigger
    showHeader();

    // Init
    setExternalWindowStatus('closed');
    updateDisplay();
    initVideoPlayback();
</script>
{% endblock %}
