{% extends 'base.html' %}
{% load static %}

{% block title %}진행 중 - 몽글몽글 미술수업{% endblock %}

{% block content %}
<main class="min-h-screen pt-32 pb-4 bg-gray-900 overflow-hidden flex flex-col">
    <!-- Header Controls -->
    <header class="h-16 px-6 flex items-center justify-between bg-gray-800/80 backdrop-blur-sm z-50">
        <div class="flex items-center gap-4">
            <a href="{% url 'artclass:setup' %}"
                class="flex items-center gap-2 text-white/80 hover:text-white transition-colors text-xl font-bold px-4 py-2 rounded-xl hover:bg-white/10">
                <i class="fa-solid fa-chevron-left"></i> 나가기
            </a>
            <h1 class="text-xl font-bold text-white hidden md:block">미술 수업 진행 중...</h1>
        </div>

        <button id="btnFullscreen"
            class="text-white/80 hover:text-white p-2 rounded-xl hover:bg-white/10 transition-colors">
            <i class="fa-solid fa-expand text-2xl"></i>
        </button>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col lg:flex-row gap-6 p-6 overflow-hidden">

        <!-- Video Section (Leading) -->
        <div class="flex-[1.5] bg-black rounded-[2rem] shadow-2xl overflow-hidden relative group">
            <div id="player" class="w-full h-full"></div>
            <!-- Video Overlay Controls (Loop) -->
            <div
                class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-black/60 backdrop-blur-md px-6 py-3 rounded-full flex gap-6 text-white text-xl z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                <button id="btnLoop" class="hover:text-purple-400 transition" title="구간 반복 설정">
                    <i class="fa-solid fa-repeat"></i> <span id="loopStatus">OFF</span>
                </button>
                <div class="w-px bg-white/30"></div>
                <span class="font-hand" id="timerDisplay">00:00</span>
            </div>
        </div>

        <!-- Instructions Section (Trailing) -->
        <div
            class="flex-1 min-w-[350px] bg-gray-800/50 backdrop-blur-md rounded-[2rem] border border-white/10 relative overflow-hidden flex flex-col">
            <!-- Progress Bar -->
            <div class="h-2 bg-gray-700 w-full">
                <div id="stepProgress" class="h-full bg-purple-500 transition-all duration-300" style="width: 0%"></div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth" id="stepsContainer">
                {% for step in data.steps %}
                <div id="step-{{ forloop.counter0 }}"
                    class="step-item p-6 rounded-2xl bg-gray-700/50 text-gray-300 transition-all duration-500 border border-transparent scale-95 opacity-60">
                    <div class="flex gap-4">
                        <div class="text-3xl font-bold opacity-50">{{ forloop.counter }}</div>
                        <p class="text-2xl font-hand leading-relaxed">{{ step.text }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Controls -->
            <div class="p-6 bg-gray-800/80 border-t border-white/10 flex justify-between items-center gap-4">
                <button id="btnPrev"
                    class="p-4 rounded-full bg-gray-700 text-white hover:bg-gray-600 transition shadow-lg">
                    <i class="fa-solid fa-backward text-xl"></i>
                </button>

                <button id="btnPlayPause"
                    class="flex-1 py-4 rounded-full bg-purple-600 text-white font-bold text-2xl hover:bg-purple-700 transition shadow-lg flex items-center justify-center gap-3">
                    <i class="fa-solid fa-pause" id="playIcon"></i>
                    <span id="playText">일시정지</span>
                </button>

                <button id="btnNext"
                    class="p-4 rounded-full bg-gray-700 text-white hover:bg-gray-600 transition shadow-lg">
                    <i class="fa-solid fa-forward text-xl"></i>
                </button>
            </div>
        </div>
    </div>
</main>

<script>
    // Data from Django
    const stepsData = {{ data_json| safe }};
    const VIDEO_ID = "{{ data.videoUrl }}".match(/(?:v=|youtu\.be\/)([^&?]+)/)[1];
    const INTERVAL_MS = parseInt("{{ data.stepInterval }}") * 1000;

    // State
    let currentStep = 0;
    let isPlaying = true;
    let timer = 0;
    let lastTime = Date.now();
    let player;
    let loopStart = 0;
    let loopEnd = 0;
    let isLooping = false;

    // Elements
    const container = document.getElementById('stepsContainer');
    const playBtn = document.getElementById('btnPlayPause');
    const playIcon = document.getElementById('playIcon');
    const playText = document.getElementById('playText');
    const progressBar = document.getElementById('stepProgress');
    const btnFullscreen = document.getElementById('btnFullscreen');
    const loopStatus = document.getElementById('loopStatus');
    const timerDisplay = document.getElementById('timerDisplay');

    // YouTube IFrame API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            videoId: VIDEO_ID,
            playerVars: {
                'playsinline': 1,
                'autoplay': 1,
                'controls': 1
            },
            events: {
                'onReady': onPlayerReady
            }
        });
    }

    function onPlayerReady(event) {
        startTimer();
    }

    // Step Management
    function updateStepsUI() {
        // Update styling
        document.querySelectorAll('.step-item').forEach((el, index) => {
            if (index === currentStep) {
                el.classList.add('bg-purple-600', 'text-white', 'scale-100', 'opacity-100', 'shadow-clay');
                el.classList.remove('bg-gray-700/50', 'text-gray-300', 'scale-95', 'opacity-60', 'border-transparent');

                // Scroll into view
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                el.classList.remove('bg-purple-600', 'text-white', 'scale-100', 'opacity-100', 'shadow-clay');
                el.classList.add('bg-gray-700/50', 'text-gray-300', 'scale-95', 'opacity-60', 'border-transparent');
            }
        });

        // Loop Logic (Optional Future: Link steps to timestamps)
    }

    // Timer Loop
    function startTimer() {
        requestAnimationFrame(updateLoop);
    }

    function updateLoop() {
        const now = Date.now();
        const dt = now - lastTime;
        lastTime = now;

        if (isPlaying) {
            timer += dt;

            // Progress Bar
            const progress = (timer % INTERVAL_MS) / INTERVAL_MS * 100;
            progressBar.style.width = `${progress}%`;

            // Display Timer
            const totalSeconds = Math.floor(timer / 1000);
            const mins = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
            const secs = String(totalSeconds % 60).padStart(2, '0');
            timerDisplay.textContent = `${mins}:${secs}`;

            // Next Step Trigger
            if (timer >= INTERVAL_MS) {
                timer = 0;
                if (currentStep < stepsData.steps.length - 1) {
                    currentStep++;
                    updateStepsUI();
                } else {
                    // End of class
                    isPlaying = false;
                    updatePlayButton();
                }
            }
        }

        // YouTube Loop Logic
        if (player && player.getCurrentTime && isLooping) {
            const curr = player.getCurrentTime();
            if (curr >= loopEnd) {
                player.seekTo(loopStart);
            }
        }

        requestAnimationFrame(updateLoop);
    }

    // Controls
    function togglePlay() {
        isPlaying = !isPlaying;
        updatePlayButton();
    }

    function updatePlayButton() {
        if (isPlaying) {
            playIcon.classList.remove('fa-play');
            playIcon.classList.add('fa-pause');
            playText.textContent = "일시정지";
            lastTime = Date.now(); // Reset delta to prevent jump
        } else {
            playIcon.classList.remove('fa-pause');
            playIcon.classList.add('fa-play');
            playText.textContent = "다시 시작";
        }
    }

    document.getElementById('btnPrev').addEventListener('click', () => {
        if (currentStep > 0) {
            currentStep--;
            timer = 0;
            updateStepsUI();
        }
    });

    document.getElementById('btnNext').addEventListener('click', () => {
        if (currentStep < stepsData.steps.length - 1) {
            currentStep++;
            timer = 0;
            updateStepsUI();
        }
    });

    playBtn.addEventListener('click', togglePlay);

    // Fullscreen
    btnFullscreen.addEventListener('click', () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            btnFullscreen.innerHTML = '<i class="fa-solid fa-compress text-2xl"></i>';
        } else {
            document.exitFullscreen();
            btnFullscreen.innerHTML = '<i class="fa-solid fa-expand text-2xl"></i>';
        }
    });

    // Loop Feature (Simple A-B Loop implementation concept)
    document.getElementById('btnLoop').addEventListener('click', () => {
        if (!isLooping) {
            // Set Loop Point A (Current - 5s) to B (Current + 5s) for demo
            if (player && player.getCurrentTime) {
                const now = player.getCurrentTime();
                loopStart = Math.max(0, now - 5);
                loopEnd = now + 5;
                isLooping = true;
                loopStatus.textContent = "ON (-5s/+5s)";
                loopStatus.classList.add('text-purple-400', 'font-bold');
            }
        } else {
            isLooping = false;
            loopStatus.textContent = "OFF";
            loopStatus.classList.remove('text-purple-400', 'font-bold');
        }
    });

    // Init UI
    updateStepsUI();

</script>
{% endblock %}