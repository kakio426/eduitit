{% extends 'base.html' %}
{% load static %}

{% block title %}?섎쭔??誘몄닠 ?섏뾽 - Eduitit{% endblock %}

{% block extra_css %}
<style>
    /* NanumSquareRound Optimized Styles */
    .art-container {
        font-family: 'NanumSquareRound', sans-serif;
    }

    .font-heavy {
        font-weight: 800;
    }

    .step-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .step-card:hover {
        transform: translateY(-4px);
    }

    textarea::placeholder {
        color: #A0AEC0;
        font-weight: 400;
    }
</style>
{% endblock %}

{% block content %}
<main class="min-h-screen pt-24 md:pt-32 pb-20 px-4 art-container">
    <div class="max-w-6xl mx-auto">

        <!-- Welcome Header -->
        <div class="text-center mb-10" data-aos="fade-down">
            <h1 class="text-3xl md:text-4xl font-heavy text-gray-800 mb-3">?렓 紐쎄?紐쎄? 誘몄닠 援먯떎</h1>
            <p class="text-lg md:text-xl text-gray-500 mb-8">?좎깮?섏쓣 ?꾪븳 媛??媛꾪렪??誘몄닠 ?섏뾽 ?꾩슦誘?/p>

            <div class="flex flex-wrap justify-center gap-4">
                <a href="{% url 'artclass:library' %}"
                    class="px-6 py-3 rounded-2xl bg-white text-purple-600 font-heavy shadow-clay hover:shadow-clay-hover hover:-translate-y-1 transition-all flex items-center gap-2">
                    <i class="fa-solid fa-book-open"></i> ?ㅻⅨ ?좎깮???섏뾽 ?섎윭蹂닿린
                </a>
            </div>
        </div>

        <form id="setupForm" method="POST" action="{% url 'artclass:setup' %}" enctype="multipart/form-data"
            class="space-y-8">
            {% csrf_token %}
            <input type="hidden" name="step_count" id="stepCountInput" value="0">

            <!-- 1. URL & AI Section -->
            <div class="clay-card p-6 md:p-10 bg-white/80 backdrop-blur-sm">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-center">
                    <div class="lg:col-span-2 space-y-4">
                        <label class="flex items-center gap-2 text-lg font-heavy text-gray-700">
                            <i class="fa-brands fa-youtube text-red-500 text-xl"></i> ?좏뒠釉??곸긽 二쇱냼
                        </label>
                        <input type="text" name="videoUrl" id="videoUrl"
                            class="w-full px-5 py-3 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-purple-300 focus:bg-white transition-all text-base shadow-inner outline-none"
                            placeholder="https://www.youtube.com/watch?v=..."
                            value="{{ art_class.youtube_url|default:'' }}" required>
                    </div>
                    <div>
                        <button type="button" id="btnAiGenerate"
                            class="w-full h-[54px] md:mt-8 rounded-2xl bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-lg font-heavy shadow-lg hover:shadow-purple-200 transition-all flex items-center justify-center gap-2 group">
                            <i class="fa-solid fa-wand-magic-sparkles group-hover:rotate-12 transition-transform"></i>
                            AI ?섏뾽 ?ㅺ퀎
                        </button>
                    </div>
                </div>
                <p id="aiStatus" class="mt-4 text-center text-purple-600 font-bold hidden"></p>
            </div>

            <!-- 2. Main Lab Area -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">

                <!-- Left: Video Preview & Help (Sticky) -->
                <div class="lg:col-span-5 lg:sticky lg:top-36 space-y-6">
                    <div id="youtubePreviewContainer" class="hidden animate-in fade-in duration-500">
                        <div
                            class="rounded-[2rem] overflow-hidden shadow-2xl bg-black aspect-video border-4 border-white/50">
                            <iframe id="youtubePreviewFrame" class="w-full h-full" frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                allowfullscreen></iframe>
                        </div>
                        <div class="mt-4 flex justify-between items-center px-2">
                            <span class="text-sm font-bold text-gray-400">Previewing Active Video</span>
                            <a id="youtubeDirectLink" href="#" target="_blank"
                                class="text-purple-500 text-sm font-bold hover:underline">
                                ?좏뒠釉뚯뿉???ш쾶 蹂닿린 <i class="fa-solid fa-external-link text-xs"></i>
                            </a>
                        </div>
                    </div>

                    <div class="clay-card p-6 bg-purple-50/50 border-purple-100">
                        <h3 class="font-heavy text-purple-700 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-lightbulb"></i> 珥덇컙????
                        </h3>
                        <ul class="text-sm text-purple-900/70 space-y-2 leading-relaxed">
                            <li>???곸긽??蹂대떎媛 ?꾩슂???λ㈃?먯꽌 <code class="bg-purple-100 px-1 rounded">Win + Shift + S</code> 罹≪쿂
                            </li>
                            <li>???④퀎蹂?<span class="text-purple-600 font-bold">?뱥 遺숈뿬?ｊ린</span> 踰꾪듉???꾨Ⅴ硫?利됱떆 ?대?吏 ?깅줉!</li>
                        </ul>
                    </div>
                </div>

                <!-- Right: Steps Editor -->
                <div class="lg:col-span-7 space-y-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-2xl font-heavy text-gray-700">?뱥 ?④퀎蹂??쒕룞 援ъ꽦</h2>
                        <button type="button" id="btnAddStep"
                            class="px-5 py-2 rounded-xl bg-white text-purple-600 font-heavy shadow-sm hover:shadow-md transition-all flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> ?④퀎 異붽?
                        </button>
                    </div>

                    <div id="stepsList" class="space-y-6">
                        <!-- Step Cards will be injected here -->
                        <div id="emptyState"
                            class="text-center py-24 bg-white/30 rounded-[2rem] border-2 border-dashed border-gray-300">
                            <i class="fa-solid fa-magic text-4xl text-gray-300 mb-4 block"></i>
                            <p class="text-gray-400 font-bold">?좏뒠釉?二쇱냼瑜??ｊ퀬 AI 遺꾩꽍???쒖옉?섍굅??<br>吏곸젒 ?④퀎瑜?異붽???二쇱꽭??</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Final Settings & Start -->
            <div class="clay-card p-8 bg-white/80 text-center">
                <div class="max-w-xs mx-auto mb-8">
                    <label class="block text-gray-600 font-heavy mb-4">?먮룞 ?꾪솚 媛꾧꺽 (珥?</label>
                    <div class="flex items-center gap-4 bg-gray-50 rounded-2xl p-2 shadow-inner">
                        <input type="number" name="stepInterval" id="stepInterval"
                            value="{{ art_class.default_interval|default:15 }}" min="5"
                            class="w-full bg-transparent text-2xl font-heavy text-center outline-none">
                        <span class="pr-4 text-gray-400 font-bold">珥?/span>
                    </div>
                </div>

                <button type="submit"
                    class="w-full md:w-auto px-12 py-4 rounded-full bg-green-500 text-white text-2xl font-heavy shadow-lg hover:bg-green-600 hover:scale-105 active:scale-95 transition-all">
                    ?섏뾽 ?쒖옉?섍린 <i class="fa-solid fa-play ml-2 text-xl"></i>
                </button>
            </div>
        </form>
    </div>
</main>

<script>
    let steps = JSON.parse('{{ initial_steps_json|safe|default:"[]" }}');
    const stepsListEl = document.getElementById('stepsList');
    const emptyStateEl = document.getElementById('emptyState');
    const stepCountInput = document.getElementById('stepCountInput');
    const videoUrlEl = document.getElementById('videoUrl');
    const btnAiGenerate = document.getElementById('btnAiGenerate');
    const aiStatusEl = document.getElementById('aiStatus');
    const youtubePreviewContainer = document.getElementById('youtubePreviewContainer');
    const youtubePreviewFrame = document.getElementById('youtubePreviewFrame');
    const youtubeDirectLink = document.getElementById('youtubeDirectLink');

    function extractVideoId(url) {
        const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?|shorts)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
        const match = url.match(regex);
        return match ? match[1] : null;
    }

    function updateYoutubePreview() {
        const videoId = extractVideoId(videoUrlEl.value.trim());
        if (videoId) {
            // Use the absolute simplest embed URL first to see if it bypasses local restrictions
            const embedUrl = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&rel=0&origin=${encodeURIComponent(window.location.origin)}`;
            youtubePreviewFrame.src = embedUrl;
            youtubeDirectLink.href = `https://www.youtube.com/watch?v=${videoId}`;
            youtubePreviewContainer.classList.remove('hidden');
        } else {
            youtubePreviewFrame.src = '';
            youtubePreviewContainer.classList.add('hidden');
        }
    }

    videoUrlEl.addEventListener('input', updateYoutubePreview);

    function renderSteps() {
        stepCountInput.value = steps.length;
        if (steps.length === 0) {
            stepsListEl.innerHTML = '';
            stepsListEl.appendChild(emptyStateEl);
            emptyStateEl.classList.remove('hidden');
        } else {
            emptyStateEl.classList.add('hidden');
            stepsListEl.innerHTML = steps.map((step, index) => `
                <div class="clay-card p-6 bg-white step-card border-l-8 border-purple-500 relative group animate-in slide-in-from-right-4 duration-300">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- Left: Index -->
                        <div class="flex-none">
                            <div class="w-12 h-12 rounded-2xl bg-purple-600 text-white flex items-center justify-center text-xl font-heavy shadow-lg">
                                ${index + 1}
                            </div>
                        </div>
                        
                        <!-- Middle: Content -->
                        <div class="flex-grow space-y-4">
                            <textarea name="step_text_${index}" 
                                class="w-full p-4 rounded-xl bg-gray-50 border-2 border-transparent focus:border-purple-200 focus:bg-white outline-none transition-all text-lg font-medium resize-none"
                                rows="2" placeholder="???④퀎?먯꽌 ???쒕룞???곸뼱二쇱꽭??(?? 援щ쫫 臾대뒳 洹몃━湲?"
                                oninput="updateStep(${index}, this.value)">${step.text}</textarea>
                            
                            <div class="flex flex-wrap items-center gap-3">
                                <label class="flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-50 text-indigo-700 font-bold cursor-pointer hover:bg-indigo-100 transition-all text-sm">
                                    <i class="fa-solid fa-image"></i> ?대?吏 ?좏깮
                                    <input type="file" name="step_image_${index}" accept="image/*" class="hidden" onchange="previewImage(${index}, this)">
                                </label>
                                <button type="button" onclick="handleClipboardPaste(${index})"
                                    class="flex items-center gap-2 px-4 py-2 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-700 transition-all text-sm">
                                    <i class="fa-solid fa-paste"></i> ?뱥 遺숈뿬?ｊ린
                                </button>
                                <div id="imagePreview_${index}" class="flex-grow">
                                    ${step.imagePreview ? `<img src="${step.imagePreview}" class="h-16 rounded-lg shadow-sm">` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Right: Actions -->
                        <div class="flex md:flex-col justify-end gap-2">
                             <button type="button" onclick="removeStep(${index})" class="p-3 text-red-300 hover:text-red-500 transition-colors">
                                <i class="fa-solid fa-trash-can text-xl"></i>
                             </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    window.updateStep = (index, val) => steps[index].text = val;
    window.removeStep = (index) => { steps.splice(index, 1); renderSteps(); };

    window.previewImage = (index, input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                steps[index].imagePreview = e.target.result;
                document.getElementById(`imagePreview_${index}`).innerHTML = `<img src="${e.target.result}" class="h-16 rounded-lg shadow-sm">`;
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    window.handleClipboardPaste = async (index) => {
        try {
            const items = await navigator.clipboard.read();
            for (const item of items) {
                if (item.types.some(t => t.startsWith('image/'))) {
                    const blob = await item.getType(item.types.find(t => t.startsWith('image/')));
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        steps[index].imagePreview = e.target.result;
                        document.getElementById(`imagePreview_${index}`).innerHTML = `<img src="${e.target.result}" class="h-16 rounded-lg shadow-sm">`;
                        const file = new File([blob], "paste.png", { type: blob.type });
                        const dt = new DataTransfer(); dt.items.add(file);
                        document.querySelector(`input[name="step_image_${index}"]`).files = dt.files;
                    };
                    reader.readAsDataURL(blob);
                    return;
                }
            }
        } catch (e) { alert("?대┰蹂대뱶???대?吏媛 ?녾굅??釉뚮씪?곗? 沅뚰븳???놁뒿?덈떎."); }
    };

    document.getElementById('btnAddStep').addEventListener('click', () => {
        steps.push({ text: '', imagePreview: null });
        renderSteps();
    });

    btnAiGenerate.addEventListener('click', async () => {
        const url = videoUrlEl.value.trim();
        if (!url) return alert('?좏뒠釉?URL???낅젰??二쇱꽭??');

        btnAiGenerate.disabled = true;
        btnAiGenerate.innerHTML = `<i class="fa-solid fa-sync fa-spin"></i> 遺꾩꽍 以?..`;
        aiStatusEl.textContent = 'AI媛 ?곸긽??遺꾩꽍?섍퀬 ?덉뒿?덈떎. ?좎떆留?湲곕떎??二쇱꽭??..';
        aiStatusEl.classList.remove('hidden');

        try {
            const res = await fetch('{% url "artclass:generate_steps_api" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ videoUrl: url })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || '遺꾩꽍 ?ㅽ뙣');
            steps = data.steps.map(s => ({ text: s.text, imagePreview: null }));
            renderSteps();
            aiStatusEl.textContent = '諛섏쁺?섏뿀?듬땲??';
        } catch (e) { alert(e.message); aiStatusEl.classList.add('hidden'); }
        finally { btnAiGenerate.disabled = false; btnAiGenerate.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> AI ?섏뾽 ?ㅺ퀎`; }
    });

    // Init
    updateYoutubePreview();
    renderSteps();
</script>
{% endblock %}
