{% extends 'base.html' %}
{% load static %}

{% block title %}몽글몽글 미술수업 - Eduitit{% endblock %}

{% block content %}
<main class="min-h-screen pt-32 pb-20 px-4">
    <div class="max-w-4xl mx-auto clay-card p-8 md:p-12 bg-[#E0E5EC]">
        
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="inline-flex p-6 bg-[#E0E5EC] rounded-3xl shadow-clay-inner mb-6">
                <i class="fa-solid fa-paintbrush text-5xl text-purple-500"></i>
            </div>
            <h1 class="text-6xl md:text-7xl font-round font-bold text-gray-700 mb-2">몽글몽글 미술 수업</h1>
            <p class="text-3xl text-gray-500 font-hand">선생님을 위한 말랑말랑 수업 도우미 ✨</p>
        </div>

        <form id="setupForm" method="POST" action="{% url 'artclass:classroom' %}">
            {% csrf_token %}
            <!-- Hidden JSON input to store steps array -->
            <input type="hidden" name="steps" id="stepsInput">
            
            <!-- Settings Section -->
            <div class="grid md:grid-cols-3 gap-8 mb-10">
                <div class="md:col-span-2">
                    <label class="block text-2xl font-bold text-gray-600 mb-2">
                        <i class="fa-brands fa-youtube text-red-500 mr-2"></i> 유튜브 영상 주소
                    </label>
                    <input type="text" name="videoUrl" id="videoUrl" 
                        class="w-full px-6 py-3 rounded-2xl bg-[#E0E5EC] shadow-clay-inner focus:shadow-clay border-none outline-none text-xl transition-all"
                        placeholder="https://www.youtube.com/watch?v=..." required>
                </div>
                <div>
                    <label class="block text-2xl font-bold text-gray-600 mb-2">
                        <i class="fa-solid fa-stopwatch text-blue-500 mr-2"></i> 간격 (초)
                    </label>
                    <input type="number" name="stepInterval" id="stepInterval" value="10" min="1"
                        class="w-full px-6 py-3 rounded-2xl bg-[#E0E5EC] shadow-clay-inner focus:shadow-clay border-none outline-none text-xl transition-all text-center">
                </div>
            </div>

            <!-- AI Action Section -->
            <div class="mb-12 text-center">
                <button type="button" id="btnAiGenerate" 
                    class="w-full md:w-2/3 py-4 rounded-full bg-gradient-to-r from-purple-400 to-blue-400 text-white text-3xl font-bold shadow-clay hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-3">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> AI로 수업 단계 자동 생성
                </button>
                <p id="aiStatus" class="mt-3 text-xl font-hand text-gray-500 hidden"></p>
            </div>

            <!-- Steps Section -->
            <div class="mb-12">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-4xl font-bold text-gray-700">수업 단계</h2>
                    <button type="button" id="btnAddStep" 
                        class="px-6 py-2 rounded-xl bg-[#E0E5EC] text-gray-600 font-bold shadow-clay hover:text-purple-600 transition-all">
                        <i class="fa-solid fa-plus mr-2"></i>추가
                    </button>
                </div>

                <div id="stepsList" class="space-y-6">
                    <!-- Steps will be injected here -->
                    <div class="text-center py-10 text-gray-400 font-hand text-2xl" id="emptyState">
                        <i class="fa-solid fa-layer-group text-4xl mb-3 block"></i>
                        단계를 추가하거나 AI로 생성해보세요.
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <div class="text-center">
                <button type="submit" id="btnStart"
                    class="px-12 py-5 rounded-full bg-green-500 text-white text-4xl font-bold shadow-clay hover:bg-green-600 hover:scale-105 active:scale-95 transition-all">
                    수업 시작하기 <i class="fa-solid fa-play ml-2"></i>
                </button>
            </div>
        </form>
    </div>
</main>

<script>
    let steps = [];

    const stepsListEl = document.getElementById('stepsList');
    const emptyStateEl = document.getElementById('emptyState');
    const stepsInputEl = document.getElementById('stepsInput');
    const videoUrlEl = document.getElementById('videoUrl');
    const btnAiGenerate = document.getElementById('btnAiGenerate');
    const aiStatusEl = document.getElementById('aiStatus');

    // Render Steps
    function renderSteps() {
        if (steps.length === 0) {
            stepsListEl.innerHTML = '';
            stepsListEl.appendChild(emptyStateEl);
            emptyStateEl.style.display = 'block';
        } else {
            emptyStateEl.style.display = 'none';
            stepsListEl.innerHTML = steps.map((step, index) => `
                <div class="flex gap-4 items-start animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <div class="w-10 h-10 rounded-full bg-[#E0E5EC] shadow-clay flex items-center justify-center font-bold text-gray-500 shrink-0 mt-1">
                        ${index + 1}
                    </div>
                    <div class="flex-1">
                        <textarea class="w-full px-5 py-3 rounded-2xl bg-[#E0E5EC] shadow-clay-inner focus:shadow-clay border-none outline-none text-xl resize-none transition-all"
                            rows="2" placeholder="단계 내용을 입력하세요"
                            oninput="updateStep(${index}, this.value)">${step.text}</textarea>
                    </div>
                    <button type="button" onclick="removeStep(${index})" class="mt-2 text-red-400 hover:text-red-600 transition-colors">
                        <i class="fa-solid fa-trash text-xl"></i>
                    </button>
                </div>
            `).join('');
        }
        updateHiddenInput();
    }

    window.updateStep = (index, value) => {
        steps[index].text = value;
        updateHiddenInput();
    };

    window.removeStep = (index) => {
        steps.splice(index, 1);
        renderSteps();
    };

    function updateHiddenInput() {
        stepsInputEl.value = JSON.stringify(steps);
    }

    document.getElementById('btnAddStep').addEventListener('click', () => {
        steps.push({ id: Date.now(), text: '' });
        renderSteps();
    });

    // AI Generate
    btnAiGenerate.addEventListener('click', async () => {
        const url = videoUrlEl.value.trim();
        if (!url) {
            alert('유튜브 URL을 입력해주세요.');
            return;
        }

        // UI Loading
        const originHTML = btnAiGenerate.innerHTML;
        btnAiGenerate.disabled = true;
        btnAiGenerate.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 분석 중...';
        aiStatusEl.textContent = '영상 정보를 분석하고 단계를 생성하고 있습니다...';
        aiStatusEl.className = 'mt-3 text-xl font-hand text-purple-500 block animate-pulse';

        try {
            const response = await fetch('{% url "artclass:generate_steps_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ videoUrl: url })
            });

            const data = await response.json();

            if (!response.ok) {
                if (data.error === 'LOW_INFO') {
                    throw new Error('영상의 설명이 부족하여 요약할 수 없습니다. 직접 입력해주세요.');
                }
                throw new Error(data.error || '오류가 발생했습니다.');
            }

            // Success
            steps = data.steps;
            renderSteps();
            aiStatusEl.textContent = '성공적으로 생성되었습니다!';
            aiStatusEl.className = 'mt-3 text-xl font-hand text-green-500 block';

        } catch (error) {
            console.error(error);
            alert(error.message);
            aiStatusEl.textContent = '오류가 발생했습니다.';
            aiStatusEl.className = 'mt-3 text-xl font-hand text-red-500 block';
        } finally {
            btnAiGenerate.disabled = false;
            btnAiGenerate.innerHTML = originHTML;
        }
    });

    // Form Submit Validation
    document.getElementById('setupForm').addEventListener('submit', (e) => {
        if (steps.length === 0) {
            e.preventDefault();
            alert('최소 1개 이상의 수업 단계를 입력해주세요.');
        }
    });

    // Init
    updateHiddenInput();
</script>
{% endblock %}
