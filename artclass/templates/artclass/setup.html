{% extends 'base.html' %}
{% load static %}

{% block title %}ë‚˜ë§Œì˜ ë¯¸ìˆ  ìˆ˜ì—… - Eduitit{% endblock %}

{% block extra_css %}
<style>
    /* NanumSquareRound Optimized Styles */
    .art-container {
        font-family: 'NanumSquareRound', sans-serif;
    }

    .font-heavy {
        font-weight: 800;
    }

    .step-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .step-card:hover {
        transform: translateY(-4px);
    }

    textarea::placeholder {
        color: #A0AEC0;
        font-weight: 400;
    }
</style>
{% endblock %}

{% block content %}
<main class="min-h-screen pt-24 md:pt-32 pb-20 px-4 art-container">
    <div class="max-w-6xl mx-auto">

        <!-- Welcome Header -->
        <div class="text-center mb-10" data-aos="fade-down">
            <h1 class="text-3xl md:text-4xl font-heavy text-gray-800 mb-3">ğŸ¨ ëª½ê¸€ëª½ê¸€ ë¯¸ìˆ  êµì‹¤</h1>
            <p class="text-lg md:text-xl text-gray-500 mb-8">ì„ ìƒë‹˜ì„ ìœ„í•œ ê°€ì¥ ê°„í¸í•œ ë¯¸ìˆ  ìˆ˜ì—… ë„ìš°ë¯¸</p>

            <div class="flex flex-wrap justify-center gap-4">
                <a href="{% url 'artclass:library' %}"
                    class="px-6 py-3 rounded-2xl bg-white text-purple-600 font-heavy shadow-clay hover:shadow-clay-hover hover:-translate-y-1 transition-all flex items-center gap-2">
                    <i class="fa-solid fa-book-open"></i> ë‹¤ë¥¸ ì„ ìƒë‹˜ ìˆ˜ì—… ë‘˜ëŸ¬ë³´ê¸°
                </a>
            </div>
        </div>

        <form id="setupForm" method="POST" action="{% url 'artclass:setup' %}" enctype="multipart/form-data"
            class="space-y-8">
            {% csrf_token %}
            <input type="hidden" name="step_count" id="stepCountInput" value="0">

            <!-- 1. URL & AI Section -->
            <div class="clay-card p-6 md:p-10 bg-white/80 backdrop-blur-sm">
                <div class="grid grid-cols-1 gap-8 items-center">
                    <div class="space-y-4">
                        <label class="flex items-center gap-2 text-lg font-heavy text-gray-700">
                            <i class="fa-brands fa-youtube text-red-500 text-xl"></i> ìˆ˜ì—…ìš© ìœ íŠœë¸Œ ì˜ìƒ ì£¼ì†Œ
                        </label>
                        <input type="text" name="videoUrl" id="videoUrl"
                            class="w-full px-5 py-3 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-purple-300 focus:bg-white focus:ring-2 focus:ring-purple-300 transition-all text-base shadow-inner outline-none"
                            placeholder="https://www.youtube.com/watch?v=..."
                            value="{{ art_class.youtube_url|default:'' }}" required>
                    </div>
                </div>

                <div class="mt-8 border-t border-purple-100 pt-6">
                    <div class="rounded-2xl bg-indigo-50/70 border border-indigo-100 p-5 md:p-6 space-y-4">
                        <h3 class="text-lg font-heavy text-indigo-900 flex items-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Gemini ë¹ ë¥¸ ë³µì‚¬-ë¶™ì—¬ë„£ê¸°
                        </h3>
                        <p class="text-sm text-indigo-900/80 leading-relaxed">
                            êµì‚¬ê°€ í—·ê°ˆë¦¬ì§€ ì•Šë„ë¡ íë¦„ì„ ìµœì†Œ í´ë¦­ìœ¼ë¡œ ì¤„ì˜€ìŠµë‹ˆë‹¤.
                            ì•„ë˜ ìˆœì„œëŒ€ë¡œ í•˜ë©´ ë¶™ì—¬ë„£ëŠ” ì¦‰ì‹œ ë‹¨ê³„ê°€ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.
                        </p>
                        <ol class="list-decimal pl-5 space-y-1 text-sm text-indigo-900/85">
                            <li>ìœ íŠœë¸Œ ì£¼ì†Œë¥¼ ë¨¼ì € ì…ë ¥í•©ë‹ˆë‹¤.</li>
                            <li><b>ì œë¯¸ë‚˜ì´ ì—´ê¸° + í”„ë¡¬í”„íŠ¸ ìë™ ë³µì‚¬</b> ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.</li>
                            <li>Gemini ë‹µë³€(JSON ê¶Œì¥)ì„ ì•„ë˜ ê²°ê³¼ ì¹¸ì— ë¶™ì—¬ë„£ìœ¼ë©´ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.</li>
                        </ol>
                        <p class="text-xs text-indigo-800">
                            ê¶Œì¥ ì¶œë ¥ í˜•ì‹: JSON ê°ì²´ + <code>steps</code> ë°°ì—´. ê° stepì€
                            <code>summary</code> í•„ìˆ˜, <code>start/end</code> ì„ íƒì…ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="mt-5 p-4 rounded-xl bg-white border border-indigo-100 space-y-2">
                        <label for="geminiTargetVideoUrl" class="text-sm font-heavy text-gray-700">
                            í”„ë¡¬í”„íŠ¸ìš© ëŒ€ìƒ ì˜ìƒ URL
                        </label>
                        <div class="flex flex-col md:flex-row gap-2">
                            <input type="text" id="geminiTargetVideoUrl"
                                class="w-full px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 focus:border-indigo-300 focus:ring-2 focus:ring-indigo-200 outline-none text-sm"
                                placeholder="Gemini í”„ë¡¬í”„íŠ¸ì— ë„£ì„ ì˜ìƒ URL (ë¹„ì›Œë‘ë©´ ìœ„ ì£¼ì†Œ ìë™ ì‚¬ìš©)">
                            <button type="button" id="btnUseMainVideoUrl"
                                class="px-4 py-2.5 rounded-xl bg-white border border-indigo-200 text-indigo-700 text-xs font-heavy hover:bg-indigo-50 transition-all whitespace-nowrap">
                                ë©”ì¸ ì£¼ì†Œ ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>
                        </div>
                        <p class="text-xs text-indigo-800/90">
                            ë‹¨ê³„ëŠ” 6~12ê°œë¥¼ ê¶Œì¥í•˜ë©°, 24ê°œ ì´ˆê³¼ ì‹œ ì• 24ê°œë§Œ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-5 mt-5">
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label for="geminiPromptBox" class="text-sm font-heavy text-gray-700">1) ì œë¯¸ë‚˜ì´ ì—´ê¸° (í”„ë¡¬í”„íŠ¸ ìë™ ë³µì‚¬)</label>
                                <button type="button" id="btnLaunchGeminiFlow"
                                    class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-xs font-heavy hover:bg-indigo-700 transition-all">
                                    ì œë¯¸ë‚˜ì´ ì—´ê¸° + í”„ë¡¬í”„íŠ¸ ìë™ ë³µì‚¬
                                </button>
                            </div>
                            <textarea id="geminiPromptBox" readonly
                                class="w-full h-56 p-3 rounded-xl bg-gray-900 text-gray-100 text-xs leading-relaxed shadow-inner border border-gray-800">{{ manual_prompt_template }}</textarea>
                            <p class="text-[11px] text-gray-500">ë³µì‚¬ê°€ ì°¨ë‹¨ëœ ë¸Œë¼ìš°ì €ì—ì„œëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ì§ì ‘ ì„ íƒí•´ ë³µì‚¬í•´ ì£¼ì„¸ìš”.</p>
                        </div>

                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label for="geminiResultInput" class="text-sm font-heavy text-gray-700">2) Gemini ê²°ê³¼ ë¶™ì—¬ë„£ê¸° (ìë™ ì ìš©)</label>
                                <button type="button" id="btnApplyGeminiResult"
                                    class="px-3 py-1.5 rounded-lg bg-white border border-emerald-200 text-emerald-700 text-xs font-heavy hover:bg-emerald-50 transition-all">
                                    ìˆ˜ë™ ì ìš©
                                </button>
                            </div>
                            <textarea id="geminiResultInput"
                                class="w-full h-56 p-3 rounded-xl bg-white border-2 border-gray-200 focus:border-indigo-300 focus:ring-2 focus:ring-indigo-200 outline-none text-sm"
                                placeholder='ì˜ˆ: {"steps":[{"start":"00:35","summary":"..."}]}'></textarea>
                            <p class="text-[11px] text-gray-500">ë¶™ì—¬ë„£ê¸°(Ctrl+V)í•˜ë©´ ì¦‰ì‹œ ê²€ì¦ í›„ ë‹¨ê³„ ëª©ë¡ì— ë°˜ì˜ë©ë‹ˆë‹¤.</p>
                            <p id="geminiManualStatus" class="text-sm font-bold text-indigo-700 hidden"></p>
                            <ul id="geminiWarningList" class="space-y-1 text-xs text-amber-700 hidden"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Main Lab Area -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">

                <!-- Left: Video Preview & Help (Sticky) -->
                <div class="lg:col-span-5 lg:sticky lg:top-36 space-y-6">
                    <div class="clay-card p-6 bg-purple-50/50 border-purple-100">
                        <h3 class="font-heavy text-purple-700 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-lightbulb"></i> ì´ˆê°„ë‹¨ íŒ
                        </h3>
                        <ul class="text-sm text-purple-900/70 space-y-2 leading-relaxed">
                            <li>â€¢ ì˜ìƒì„ ë³´ë‹¤ê°€ í•„ìš”í•œ ì¥ë©´ì—ì„œ <code class="bg-purple-100 px-1 rounded">Win + Shift + S</code> ìº¡ì²˜
                            </li>
                            <li>â€¢ ë‹¨ê³„ë³„ <span class="text-purple-600 font-bold">ğŸ“‹ ë¶™ì—¬ë„£ê¸°</span> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¦‰ì‹œ ì´ë¯¸ì§€ ë“±ë¡!</li>
                        </ul>
                    </div>
                </div>

                <!-- Right: Steps Editor -->
                <div class="lg:col-span-7 space-y-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-2xl font-heavy text-gray-700">ğŸ“‹ ë‹¨ê³„ë³„ í™œë™ êµ¬ì„±</h2>
                        <button type="button" id="btnAddStep"
                            class="px-5 py-2 rounded-xl bg-white text-purple-600 font-heavy shadow-sm hover:shadow-md transition-all flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> ë‹¨ê³„ ì¶”ê°€
                        </button>
                    </div>

                    <div id="stepsList" class="space-y-6">
                        <!-- Step Cards will be injected here -->
                        <div id="emptyState"
                            class="text-center py-24 bg-white/30 rounded-[2rem] border-2 border-dashed border-gray-300">
                            <i class="fa-solid fa-magic text-4xl text-gray-300 mb-4 block"></i>
                            <p class="text-gray-400 font-bold">ìœ íŠœë¸Œ ì£¼ì†Œë¥¼ ë„£ê³  Gemini ê²°ê³¼ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜,<br>ì§ì ‘ ë‹¨ê³„ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Final Settings & Start -->
            <div class="clay-card p-8 bg-white/80 text-center">
                <div class="max-w-xl mx-auto mb-8 text-left">
                    <label for="playbackMode" class="block text-gray-600 font-heavy mb-3">ì˜ìƒ ì¬ìƒ ë°©ì‹</label>
                    <select name="playbackMode" id="playbackMode"
                        class="w-full px-4 py-3 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-purple-300 focus:bg-white focus:ring-2 focus:ring-purple-300 outline-none transition-all">
                        <option value="embed" {% if art_class.playback_mode == "embed" or not art_class %}selected{% endif %}>ë‚´ì¥ í”Œë ˆì´ì–´ (ê¸°ë³¸)</option>
                        <option value="external_window" {% if art_class.playback_mode == "external_window" %}selected{% endif %}>ìƒˆ ì°½ ì¬ìƒ (ì„ë² ë“œ ê¸ˆì§€ ì˜ìƒìš©)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-2">
                        ìœ íŠœë¸Œ ì •ì±…ìœ¼ë¡œ ë‚´ì¥ ì¬ìƒì´ ë§‰íˆëŠ” ì˜ìƒì€ ìƒˆ ì°½ ì¬ìƒ ëª¨ë“œë¥¼ ì„ íƒí•˜ë©´ ìˆ˜ì—… ì§„í–‰ì´ ëŠê¸°ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </p>
                    <p class="text-xs text-gray-500 mt-1">
                        ìˆ˜ì—… í™”ë©´ ìƒë‹¨ì˜ <b>í™”ë©´ ë¶„í•  ì‹œì‘</b> ë²„íŠ¼ìœ¼ë¡œ ìœ íŠœë¸Œì™€ ì•ˆë‚´ í™”ë©´ì„ ë°˜ë°˜ ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>

                <div class="max-w-xs mx-auto mb-8">
                    <label class="block text-gray-600 font-heavy mb-4">ìë™ ì „í™˜ ê°„ê²© (ì´ˆ)</label>
                    <div class="flex items-center gap-4 bg-gray-50 rounded-2xl p-2 shadow-inner">
                            <input type="number" name="stepInterval" id="stepInterval"
                            value="{{ art_class.default_interval|default:15 }}" min="5"
                            class="w-full bg-transparent text-2xl font-heavy text-center outline-none focus:ring-2 focus:ring-purple-300 rounded">
                        <span class="pr-4 text-gray-400 font-bold">ì´ˆ</span>
                    </div>
                </div>

                <button type="submit"
                    class="w-full md:w-auto px-12 py-4 rounded-full bg-green-500 text-white text-2xl font-heavy shadow-lg hover:bg-green-600 hover:scale-105 active:scale-95 transition-all">
                    ìˆ˜ì—… ì‹œì‘í•˜ê¸° <i class="fa-solid fa-play ml-2 text-xl"></i>
                </button>
            </div>
        </form>

        {% include 'core/partials/service_suggestion.html' with service_key='artclass' %}
    </div>
</main>

<script>
    let steps = JSON.parse('{{ initial_steps_json|safe|default:"[]" }}');
    const stepsListEl = document.getElementById('stepsList');
    const emptyStateEl = document.getElementById('emptyState');
    const stepCountInput = document.getElementById('stepCountInput');
    const videoUrlEl = document.getElementById('videoUrl');
    const geminiTargetVideoUrlEl = document.getElementById('geminiTargetVideoUrl');
    const btnUseMainVideoUrlEl = document.getElementById('btnUseMainVideoUrl');
    const geminiPromptBoxEl = document.getElementById('geminiPromptBox');
    const geminiResultInputEl = document.getElementById('geminiResultInput');
    const geminiManualStatusEl = document.getElementById('geminiManualStatus');
    const geminiWarningListEl = document.getElementById('geminiWarningList');
    const btnLaunchGeminiFlowEl = document.getElementById('btnLaunchGeminiFlow');
    const btnApplyGeminiResultEl = document.getElementById('btnApplyGeminiResult');
    let geminiTargetTouched = false;
    let geminiApplyInProgress = false;
    let lastAppliedGeminiText = '';

    function buildGeminiPrompt(videoUrl) {
        const targetUrl = videoUrl || '(ì—¬ê¸°ì— ìœ íŠœë¸Œ URL ì…ë ¥)';
        return `ë‹¹ì‹ ì€ ì´ˆë“± ë¯¸ìˆ  ìˆ˜ì—… ì„¤ê³„ ë„ìš°ë¯¸ì…ë‹ˆë‹¤.
ì•„ë˜ ì˜ìƒ/ìë£Œë¥¼ ë³´ê³  í•™ìƒì´ ë”°ë¼ í•˜ê¸° ì‰¬ìš´ ë‹¨ê³„ë³„ ìˆ˜ì—…ì•ˆì„ JSONìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”.

ëŒ€ìƒ ì˜ìƒ URL: ${targetUrl}

ì¶œë ¥ ê·œì¹™:
1) ë°˜ë“œì‹œ JSONë§Œ ì¶œë ¥ (ì½”ë“œë¸”ë¡/ì„¤ëª…ë¬¸/ì¸ì‚¬ë§ ê¸ˆì§€)
2) ìµœìƒìœ„ëŠ” ê°ì²´ì´ë©° steps ë°°ì—´ í•„ìˆ˜
3) stepsëŠ” 6~12ê°œ ê¶Œì¥, ì ˆëŒ€ 24ê°œë¥¼ ë„˜ê¸°ì§€ ì•Šê¸°
4) ê°€ëŠ¥í•œ ê²½ìš° start/endë¥¼ MM:SS í˜•ì‹ìœ¼ë¡œ í¬í•¨
5) summaryëŠ” í•™ìƒ í™œë™ ì¤‘ì‹¬ì˜ ì§§ì€ ë¬¸ì¥
6) materialsëŠ” ë°°ì—´, teacher_tipì€ ë¬¸ìì—´

JSON ìŠ¤í‚¤ë§ˆ ì˜ˆì‹œ:
{
  "video_title": "ìˆ˜ì—… ì œëª©",
  "steps": [
    {
      "start": "00:35",
      "end": "01:20",
      "summary": "ë„í™”ì§€ ì¤‘ì•™ì— í° ì›ì„ ê·¸ë¦¬ê³  ë°°ê²½ ìƒ‰ì„ ê³ ë¥¸ë‹¤.",
      "materials": ["ë„í™”ì§€", "ì—°í•„", "ìƒ‰ì—°í•„"],
      "teacher_tip": "ì„  êµµê¸°ë¥¼ ë‹¬ë¦¬í•˜ë©´ ì…ì²´ê°ì´ ì‚´ì•„ë‚œë‹¤."
    }
  ]
}`;
    }

    function updateGeminiPrompt() {
        if (!geminiPromptBoxEl) return;
        const promptTargetUrl = (geminiTargetVideoUrlEl?.value || videoUrlEl.value || '').trim();
        geminiPromptBoxEl.value = buildGeminiPrompt(promptTargetUrl);
    }

    function syncGeminiTargetFromMain(force = false) {
        if (!geminiTargetVideoUrlEl) {
            updateGeminiPrompt();
            return;
        }
        const mainUrl = (videoUrlEl?.value || '').trim();
        if (force || !geminiTargetTouched || !geminiTargetVideoUrlEl.value.trim()) {
            geminiTargetVideoUrlEl.value = mainUrl;
        }
        updateGeminiPrompt();
    }

    function setGeminiStatus(message, tone = 'indigo') {
        if (!geminiManualStatusEl) return;
        geminiManualStatusEl.textContent = message || '';
        geminiManualStatusEl.classList.remove('hidden', 'text-indigo-700', 'text-emerald-700', 'text-red-700');
        if (!message) {
            geminiManualStatusEl.classList.add('hidden');
            return;
        }
        const classByTone = {
            indigo: 'text-indigo-700',
            success: 'text-emerald-700',
            error: 'text-red-700',
        };
        geminiManualStatusEl.classList.add(classByTone[tone] || classByTone.indigo);
    }

    function renderGeminiWarnings(warnings) {
        if (!geminiWarningListEl) return;
        const items = Array.isArray(warnings) ? warnings.filter(Boolean) : [];
        if (!items.length) {
            geminiWarningListEl.innerHTML = '';
            geminiWarningListEl.classList.add('hidden');
            return;
        }
        geminiWarningListEl.innerHTML = items.map(msg => `<li>â€¢ ${msg}</li>`).join('');
        geminiWarningListEl.classList.remove('hidden');
    }

    if (videoUrlEl) {
        videoUrlEl.addEventListener('input', () => syncGeminiTargetFromMain(false));
    }
    if (geminiTargetVideoUrlEl) {
        geminiTargetVideoUrlEl.addEventListener('input', () => {
            geminiTargetTouched = true;
            updateGeminiPrompt();
        });
    }
    if (btnUseMainVideoUrlEl) {
        btnUseMainVideoUrlEl.addEventListener('click', () => {
            geminiTargetTouched = false;
            syncGeminiTargetFromMain(true);
            setGeminiStatus('ë©”ì¸ ì£¼ì†Œë¥¼ í”„ë¡¬í”„íŠ¸ ëŒ€ìƒ URLë¡œ ë°˜ì˜í–ˆìŠµë‹ˆë‹¤.', 'indigo');
        });
    }

    function renderSteps() {
        stepCountInput.value = steps.length;
        if (steps.length === 0) {
            stepsListEl.innerHTML = '';
            stepsListEl.appendChild(emptyStateEl);
            emptyStateEl.classList.remove('hidden');
        } else {
            emptyStateEl.classList.add('hidden');
            stepsListEl.innerHTML = steps.map((step, index) => `
                <div class="clay-card p-6 bg-white step-card border-l-8 border-purple-500 relative group animate-in slide-in-from-right-4 duration-300">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- Left: Index -->
                        <div class="flex-none">
                            <div class="w-12 h-12 rounded-2xl bg-purple-600 text-white flex items-center justify-center text-xl font-heavy shadow-lg">
                                ${index + 1}
                            </div>
                        </div>
                        
                        <!-- Middle: Content -->
                        <div class="flex-grow space-y-4">
                            <textarea name="step_text_${index}" 
                                class="w-full p-4 rounded-xl bg-gray-50 border-2 border-transparent focus:border-purple-200 focus:bg-white outline-none focus:ring-2 focus:ring-purple-300 transition-all text-lg font-medium resize-none"
                                rows="2" placeholder="ì´ ë‹¨ê³„ì—ì„œ í•  í™œë™ì„ ì ì–´ì£¼ì„¸ìš” (ì˜ˆ: êµ¬ë¦„ ë¬´ëŠ¬ ê·¸ë¦¬ê¸°)"
                                oninput="updateStep(${index}, this.value)">${step.text}</textarea>
                            
                            <div class="flex flex-wrap items-center gap-3">
                                <label class="flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-50 text-indigo-700 font-bold cursor-pointer hover:bg-indigo-100 transition-all text-sm">
                                    <i class="fa-solid fa-image"></i> ì´ë¯¸ì§€ ì„ íƒ
                                    <input type="file" name="step_image_${index}" accept="image/*" class="hidden" onchange="previewImage(${index}, this)">
                                </label>
                                <button type="button" onclick="handleClipboardPaste(${index})"
                                    class="flex items-center gap-2 px-4 py-2 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-700 transition-all text-sm">
                                    <i class="fa-solid fa-paste"></i> ğŸ“‹ ë¶™ì—¬ë„£ê¸°
                                </button>
                                <div id="imagePreview_${index}" class="flex-grow">
                                    ${step.imagePreview ? `<img src="${step.imagePreview}" alt="" class="h-16 rounded-lg shadow-sm">` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Right: Actions -->
                        <div class="flex md:flex-col justify-end gap-2">
                             <button type="button" onclick="removeStep(${index})" class="p-3 text-red-300 hover:text-red-500 transition-colors">
                                <i class="fa-solid fa-trash-can text-xl"></i>
                             </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    window.updateStep = (index, val) => steps[index].text = val;
    window.removeStep = (index) => { steps.splice(index, 1); renderSteps(); };

    window.previewImage = (index, input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                steps[index].imagePreview = e.target.result;
                document.getElementById(`imagePreview_${index}`).innerHTML = `<img src="${e.target.result}" alt="" class="h-16 rounded-lg shadow-sm">`;
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    window.handleClipboardPaste = async (index) => {
        try {
            const items = await navigator.clipboard.read();
            for (const item of items) {
                if (item.types.some(t => t.startsWith('image/'))) {
                    const blob = await item.getType(item.types.find(t => t.startsWith('image/')));
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        steps[index].imagePreview = e.target.result;
                        document.getElementById(`imagePreview_${index}`).innerHTML = `<img src="${e.target.result}" alt="" class="h-16 rounded-lg shadow-sm">`;
                        const file = new File([blob], "paste.png", { type: blob.type });
                        const dt = new DataTransfer(); dt.items.add(file);
                        document.querySelector(`input[name="step_image_${index}"]`).files = dt.files;
                    };
                    reader.readAsDataURL(blob);
                    return;
                }
            }
        } catch (e) { alert("í´ë¦½ë³´ë“œì— ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ë¸Œë¼ìš°ì € ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."); }
    };

    document.getElementById('btnAddStep').addEventListener('click', () => {
        steps.push({ text: '', imagePreview: null });
        renderSteps();
    });

    async function copyGeminiPrompt() {
        updateGeminiPrompt();
        try {
            await navigator.clipboard.writeText(geminiPromptBoxEl.value);
            return true;
        } catch (_) {
            return false;
        }
    }

    async function applyGeminiResult(options = {}) {
        const source = options.source || 'manual';
        const rawText = (geminiResultInputEl?.value || '').trim();
        if (!rawText) {
            if (!options.silentNoInput) {
                setGeminiStatus('Gemini ê²°ê³¼ë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.', 'error');
            }
            return;
        }
        if (geminiApplyInProgress) return;
        if (source !== 'manual' && rawText === lastAppliedGeminiText) return;

        geminiApplyInProgress = true;
        if (btnApplyGeminiResultEl) {
            btnApplyGeminiResultEl.disabled = true;
            btnApplyGeminiResultEl.textContent = 'ê²€ì¦ ì¤‘...';
        }
        setGeminiStatus(source === 'paste'
            ? 'ë¶™ì—¬ë„£ê¸°ë¥¼ ê°ì§€í–ˆìŠµë‹ˆë‹¤. í˜•ì‹ì„ ì ê²€í•˜ê³  ë‹¨ê³„ë¡œ ë³€í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤...'
            : 'í˜•ì‹ì„ ì ê²€í•˜ê³  ë‹¨ê³„ë¡œ ë³€í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'indigo');
        renderGeminiWarnings([]);

        try {
            const response = await fetch('{% url "artclass:parse_gemini_steps_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    rawText,
                    videoUrl: (geminiTargetVideoUrlEl?.value || videoUrlEl.value || '').trim(),
                }),
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || data.error || 'ê²°ê³¼ë¥¼ í•´ì„í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }

            steps = (data.steps || []).map(step => ({
                text: step.text || '',
                imagePreview: null,
            }));
            renderSteps();
            renderGeminiWarnings(data.warnings || []);

            lastAppliedGeminiText = rawText;
            const parsedCount = data?.meta?.step_count || steps.length;
            setGeminiStatus(`ê²€ì¦ ì™„ë£Œ: ${parsedCount}ê°œ ë‹¨ê³„ë¥¼ ë°˜ì˜í–ˆìŠµë‹ˆë‹¤.`, 'success');
        } catch (err) {
            setGeminiStatus(err.message || 'ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        } finally {
            geminiApplyInProgress = false;
            if (btnApplyGeminiResultEl) {
                btnApplyGeminiResultEl.disabled = false;
                btnApplyGeminiResultEl.textContent = 'ìˆ˜ë™ ì ìš©';
            }
        }
    }

    if (btnLaunchGeminiFlowEl) {
        btnLaunchGeminiFlowEl.addEventListener('click', async () => {
            const copied = await copyGeminiPrompt();
            const popup = window.open('https://gemini.google.com/app', '_blank', 'noopener,noreferrer');
            if (!popup) {
                setGeminiStatus('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error');
                return;
            }
            if (copied) {
                setGeminiStatus('Geminië¥¼ ì—´ê³  í”„ë¡¬í”„íŠ¸ë¥¼ ìë™ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. Gemini ì…ë ¥ì°½ì— ë°”ë¡œ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.', 'success');
                return;
            }
            setGeminiStatus('Geminië¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤. í”„ë¡¬í”„íŠ¸ ìë™ ë³µì‚¬ê°€ ì°¨ë‹¨ë˜ì–´ ì•„ë˜ ë°•ìŠ¤ì—ì„œ ì§ì ‘ ë³µì‚¬í•´ ì£¼ì„¸ìš”.', 'error');
        });
    }

    if (btnApplyGeminiResultEl) {
        btnApplyGeminiResultEl.addEventListener('click', () => {
            applyGeminiResult({ source: 'manual' });
        });
    }

    if (geminiResultInputEl) {
        geminiResultInputEl.addEventListener('paste', () => {
            setTimeout(() => {
                applyGeminiResult({ source: 'paste', silentNoInput: true });
            }, 0);
        });
    }

    // Init
    syncGeminiTargetFromMain(true);
    renderGeminiWarnings([]);
    renderSteps();
</script>
{% endblock %}

