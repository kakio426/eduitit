{% extends 'base.html' %}
{% load static %}

{% block title %}ëª½ê¸€ëª½ê¸€ ë¯¸ìˆ ìˆ˜ì—… - Eduitit{% endblock %}

{% block content %}
<main class="min-h-screen pt-32 pb-20 px-4">
    <div class="max-w-5xl mx-auto clay-card p-8 md:p-12 bg-[#E0E5EC]">

        <!-- Header -->
        <div class="text-center mb-12">
            <div class="inline-flex p-6 bg-[#E0E5EC] rounded-3xl shadow-clay-inner mb-6">
                <i class="fa-solid fa-paintbrush text-5xl text-purple-500"></i>
            </div>
            <h1 class="text-6xl md:text-7xl font-round font-bold text-gray-700 mb-2">ëª½ê¸€ëª½ê¸€ ë¯¸ìˆ  ìˆ˜ì—…</h1>
            <p class="text-3xl text-gray-500 font-hand">ì„ ìƒë‹˜ì„ ìœ„í•œ ë§ë‘ë§ë‘ ìˆ˜ì—… ë„ìš°ë¯¸ âœ¨</p>
        </div>

        <form id="setupForm" method="POST" action="{% url 'artclass:setup' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="step_count" id="stepCountInput" value="0">

            <!-- URL Input Section -->
            <div class="mb-10">
                <label class="block text-2xl font-bold text-gray-600 mb-3">
                    <i class="fa-brands fa-youtube text-red-500 mr-2"></i> ìœ íŠœë¸Œ ì˜ìƒ ì£¼ì†Œ
                </label>
                <input type="text" name="videoUrl" id="videoUrl"
                    class="w-full px-8 py-4 rounded-2xl bg-[#E0E5EC] shadow-clay-inner focus:shadow-clay border-none outline-none text-2xl transition-all"
                    placeholder="https://www.youtube.com/watch?v=..." required>
            </div>

            <!-- AI Action Section -->
            <div class="mb-12 text-center">
                <button type="button" id="btnAiGenerate"
                    class="w-full md:w-2/3 py-4 rounded-full bg-gradient-to-r from-purple-400 to-blue-400 text-white text-3xl font-bold shadow-clay hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-3 mx-auto">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> AIë¡œ ìˆ˜ì—… ë‹¨ê³„ ìë™ ìƒì„±
                </button>
                <p id="aiStatus" class="mt-3 text-xl font-hand text-gray-500 hidden"></p>
            </div>

            <!-- Main Editor Area: Side by Side on Desktop -->
            <div class="flex flex-col md:flex-row gap-10 items-start">

                <!-- Left: Sticky YouTube Preview -->
                <div id="youtubePreviewContainer" class="w-full md:w-[40%] md:sticky md:top-36 hidden z-10">
                    <label class="block text-2xl font-bold text-gray-600 mb-4">
                        <i class="fa-solid fa-video text-purple-500 mr-2"></i> ì˜ìƒ ì°¸ê³ í•˜ê¸°
                    </label>
                    <div class="rounded-3xl overflow-hidden shadow-clay bg-black aspect-video">
                        <iframe id="youtubePreviewFrame" class="w-full h-full" frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                    </div>
                    <div class="mt-4 p-5 bg-white/40 rounded-3xl text-gray-600 font-hand text-xl shadow-clay-inner">
                        <p class="mb-2"><i class="fa-solid fa-lightbulb text-yellow-500 mr-2"></i> <b>ê¿€íŒ! ì´ˆìŠ¤í”¼ë“œ ì´ë¯¸ì§€
                                ë“±ë¡</b></p>
                        <p class="text-lg opacity-80 leading-relaxed">
                            1. ì˜ìƒì„ ë³´ë‹¤ê°€ í•„ìš”í•œ ì¥ë©´ì—ì„œ <span
                                class="px-2 py-0.5 bg-gray-700 text-white rounded text-sm">Win+Shift+S</span> í‚¤ë¡œ
                            ìº¡ì²˜í•˜ì„¸ìš”.<br>
                            2. ì•„ë˜ ë‹¨ê³„ì˜ <span class="text-purple-600 font-bold">ğŸ“‹ ë¶™ì—¬ë„£ê¸°</span> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¦‰ì‹œ ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤!
                        </p>
                    </div>
                </div>

                <!-- Right: Steps Section -->
                <div class="flex-1 w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-4xl font-bold text-gray-700">ìˆ˜ì—… ë‹¨ê³„ ì‘ì„±</h2>
                        <button type="button" id="btnAddStep"
                            class="px-6 py-3 rounded-2xl bg-white/50 text-purple-600 font-bold shadow-clay hover:shadow-clay-hover transition-all">
                            <i class="fa-solid fa-plus mr-2"></i>ë‹¨ê³„ ì¶”ê°€
                        </button>
                    </div>

                    <div id="stepsList" class="space-y-8">
                        <div class="text-center py-20 bg-white/20 rounded-3xl border-2 border-dashed border-gray-300 text-gray-400 font-hand text-2xl"
                            id="emptyState">
                            <i class="fa-solid fa-layer-group text-5xl mb-3 block opacity-30"></i>
                            ì˜ìƒì„ ë¶„ì„í•˜ê±°ë‚˜ ë‹¨ê³„ë¥¼ ì§ì ‘ ì¶”ê°€í•´ë³´ì„¸ìš”.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Class Settings (Bottom Section) -->
            <div class="mt-16 p-8 md:p-12 rounded-[2.5rem] bg-white/40 shadow-clay-inner">
                <h3 class="text-3xl font-bold text-gray-600 mb-8 border-b border-gray-300 pb-4">
                    <i class="fa-solid fa-sliders mr-2"></i> ìˆ˜ì—… ì‹œì‘ ì „ ì„¤ì •
                </h3>

                <div class="max-w-md mx-auto">
                    <label class="block text-2xl font-bold text-gray-600 mb-3 text-center">
                        <i class="fa-solid fa-stopwatch text-blue-500 mr-2"></i> ë‹¨ê³„ë³„ ë³´ì—¬ì§€ëŠ” ì‹œê°„ (ì´ˆ)
                    </label>
                    <div class="flex items-center gap-4">
                        <input type="number" name="stepInterval" id="stepInterval" value="10" min="1"
                            class="flex-1 px-8 py-4 rounded-2xl bg-[#E0E5EC] shadow-clay-inner focus:shadow-clay border-none outline-none text-2xl text-center font-bold">
                        <span class="text-2xl font-bold text-gray-500">ì´ˆ ê°„ê²©</span>
                    </div>
                    <p class="mt-3 text-center text-gray-400 font-hand text-lg">êµì‹¤ì—ì„œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ìë™ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ê°„ê²©ì…ë‹ˆë‹¤.</p>
                </div>

                <div class="mt-12 text-center">
                    <button type="submit" id="btnStart"
                        class="w-full md:w-auto px-20 py-6 rounded-full bg-green-500 text-white text-4xl font-bold shadow-clay hover:bg-green-600 hover:scale-105 active:scale-95 transition-all">
                        ìˆ˜ì—… ì‹œì‘í•˜ê¸° <i class="fa-solid fa-play ml-2"></i>
                    </button>
                </div>
            </div>

        </form>
    </div>
</main>

<script>
    let steps = [];

    const stepsListEl = document.getElementById('stepsList');
    const emptyStateEl = document.getElementById('emptyState');
    const stepCountInput = document.getElementById('stepCountInput');
    const videoUrlEl = document.getElementById('videoUrl');
    const btnAiGenerate = document.getElementById('btnAiGenerate');
    const aiStatusEl = document.getElementById('aiStatus');
    const youtubePreviewContainer = document.getElementById('youtubePreviewContainer');
    const youtubePreviewFrame = document.getElementById('youtubePreviewFrame');

    // Extract YouTube Video ID
    function extractVideoId(url) {
        const match = url.match(/(?:v=|youtu\.be\/)([^&?]+)/);
        return match ? match[1] : null;
    }

    // Update YouTube Preview
    function updateYoutubePreview() {
        const url = videoUrlEl.value.trim();
        const videoId = extractVideoId(url);
        if (videoId) {
            youtubePreviewFrame.src = `https://www.youtube.com/embed/${videoId}`;
            youtubePreviewContainer.classList.remove('hidden');
        } else {
            youtubePreviewContainer.classList.add('hidden');
            youtubePreviewFrame.src = '';
        }
    }

    videoUrlEl.addEventListener('input', updateYoutubePreview);
    videoUrlEl.addEventListener('paste', () => setTimeout(updateYoutubePreview, 100));

    // Render Steps
    function renderSteps() {
        stepCountInput.value = steps.length;

        if (steps.length === 0) {
            stepsListEl.innerHTML = '';
            stepsListEl.appendChild(emptyStateEl);
            emptyStateEl.style.display = 'block';
        } else {
            emptyStateEl.style.display = 'none';
            stepsListEl.innerHTML = steps.map((step, index) => `
                <div class="clay-card p-6 bg-white/50 animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <div class="flex gap-4 items-start">
                        <div class="w-12 h-12 rounded-full bg-purple-100 shadow-clay-inner flex items-center justify-center font-bold text-purple-600 text-xl shrink-0">
                            ${index + 1}
                        </div>
                        <div class="flex-1 space-y-4">
                            <textarea name="step_text_${index}" 
                                class="w-full px-5 py-3 rounded-2xl bg-[#E0E5EC] shadow-clay-inner focus:shadow-clay border-none outline-none text-xl resize-none transition-all"
                                rows="2" placeholder="ë‹¨ê³„ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
                                onpaste="handleTextareaPaste(event, ${index})"
                                oninput="updateStep(${index}, this.value)">${step.text}</textarea>
                            
                            <!-- Image Upload & Paste -->
                            <div class="flex flex-wrap items-center gap-4">
                                <label class="flex items-center gap-3 px-5 py-3 rounded-2xl bg-[#E0E5EC] shadow-clay cursor-pointer hover:shadow-clay-hover transition-all text-gray-600 hover:text-purple-600">
                                    <i class="fa-solid fa-image text-xl"></i>
                                    <span class="font-bold">ì´ë¯¸ì§€ ì„ íƒ</span>
                                    <input type="file" name="step_image_${index}" accept="image/*" class="hidden" onchange="previewImage(${index}, this)">
                                </label>
                                
                                <button type="button" onclick="handleClipboardPaste(${index})"
                                    class="flex items-center gap-3 px-5 py-3 rounded-2xl bg-purple-500 text-white shadow-clay hover:bg-purple-600 transition-all font-bold">
                                    <i class="fa-solid fa-paste text-xl"></i>
                                    <span>ğŸ“‹ ë¶™ì—¬ë„£ê¸°</span>
                                </button>

                                <div id="imagePreview_${index}" class="flex-1 min-w-[100px]">
                                    ${step.imagePreview ? `<img src="${step.imagePreview}" class="h-24 w-auto rounded-xl object-cover shadow-clay">` : '<span class="text-gray-400 text-sm font-hand">ì´ë¯¸ì§€ ì—†ìŒ</span>'}
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="removeStep(${index})" class="mt-2 text-red-400 hover:text-red-600 transition-colors p-2">
                            <i class="fa-solid fa-trash text-xl"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
    }

    window.updateStep = (index, value) => {
        steps[index].text = value;
    };

    window.removeStep = (index) => {
        steps.splice(index, 1);
        renderSteps();
    };

    // Handle File Input Preview
    window.previewImage = (index, input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                steps[index].imagePreview = e.target.result;
                const previewDiv = document.getElementById(`imagePreview_${index}`);
                previewDiv.innerHTML = `<img src="${e.target.result}" class="h-24 w-auto rounded-xl object-cover shadow-clay">`;
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    // Handle Clipboard Paste Button
    window.handleClipboardPaste = async (index) => {
        try {
            const items = await navigator.clipboard.read();
            for (const item of items) {
                if (item.types.some(type => type.startsWith('image/'))) {
                    const blob = await item.getType(item.types.find(type => type.startsWith('image/')));
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        steps[index].imagePreview = e.target.result;
                        const previewDiv = document.getElementById(`imagePreview_${index}`);
                        previewDiv.innerHTML = `<img src="${e.target.result}" class="h-24 w-auto rounded-xl object-cover shadow-clay">`;

                        // Create a file to be sent with the form
                        const file = new File([blob], "pasted_image.png", { type: blob.type });
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        document.querySelector(`input[name="step_image_${index}"]`).files = dataTransfer.files;
                    };
                    reader.readAsDataURL(blob);
                    return;
                }
            }
            alert("í´ë¦½ë³´ë“œì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. Win+Shift+S ë“±ìœ¼ë¡œ ìº¡ì²˜ í›„ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
        } catch (err) {
            console.error("Clipboard access failed:", err);
            alert("í´ë¦½ë³´ë“œ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
    };

    // Handle Direct Textarea Paste
    window.handleTextareaPaste = (event, index) => {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf("image") !== -1) {
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                reader.onload = (e) => {
                    steps[index].imagePreview = e.target.result;
                    const previewDiv = document.getElementById(`imagePreview_${index}`);
                    previewDiv.innerHTML = `<img src="${e.target.result}" class="h-24 w-auto rounded-xl object-cover shadow-clay">`;

                    const file = new File([blob], "pasted_image.png", { type: blob.type });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    document.querySelector(`input[name="step_image_${index}"]`).files = dataTransfer.files;
                };
                reader.readAsDataURL(blob);
            }
        }
    };

    document.getElementById('btnAddStep').addEventListener('click', () => {
        steps.push({ id: Date.now(), text: '', imagePreview: null });
        renderSteps();
    });

    // AI Generate
    btnAiGenerate.addEventListener('click', async () => {
        const url = videoUrlEl.value.trim();
        if (!url) {
            alert('ìœ íŠœë¸Œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const originHTML = btnAiGenerate.innerHTML;
        btnAiGenerate.disabled = true;
        btnAiGenerate.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë¶„ì„ ì¤‘...';
        aiStatusEl.textContent = 'ì˜ìƒ ì •ë³´ë¥¼ ë¶„ì„í•˜ê³  ë‹¨ê³„ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        aiStatusEl.className = 'mt-3 text-xl font-hand text-purple-500 block animate-pulse';

        try {
            const response = await fetch('{% url "artclass:generate_steps_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ videoUrl: url })
            });

            const data = await response.json();

            if (!response.ok) {
                if (data.error === 'LOW_INFO') {
                    throw new Error('ì˜ìƒì˜ ì„¤ëª…ì´ ë¶€ì¡±í•˜ì—¬ ìš”ì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                throw new Error(data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }

            steps = data.steps.map(s => ({ id: s.id, text: s.text, imagePreview: null }));
            renderSteps();
            aiStatusEl.textContent = 'ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!';
            aiStatusEl.className = 'mt-3 text-xl font-hand text-green-500 block';

        } catch (error) {
            console.error(error);
            alert(error.message);
            aiStatusEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            aiStatusEl.className = 'mt-3 text-xl font-hand text-red-500 block';
        } finally {
            btnAiGenerate.disabled = false;
            btnAiGenerate.innerHTML = originHTML;
        }
    });

    // Form Submit Validation
    document.getElementById('setupForm').addEventListener('submit', (e) => {
        if (steps.length === 0) {
            e.preventDefault();
            alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ìˆ˜ì—… ë‹¨ê³„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
    });

    // Init
    renderSteps();
</script>
{% endblock %}