{% extends 'base.html' %}
{% load static %}

{% block title %}나만의 미술 수업 - Eduitit{% endblock %}

{% block extra_css %}
<style>
    /* NanumSquareRound Optimized Styles */
    .art-container {
        font-family: 'NanumSquareRound', sans-serif;
    }

    .font-heavy {
        font-weight: 800;
    }

    .step-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .step-card:hover {
        transform: translateY(-4px);
    }

    textarea::placeholder {
        color: #A0AEC0;
        font-weight: 400;
    }
</style>
{% endblock %}

{% block content %}
<main class="min-h-screen pt-24 md:pt-32 pb-20 px-4 art-container">
    <div class="max-w-6xl mx-auto">

        <!-- Welcome Header -->
        <div class="text-center mb-10" data-aos="fade-down">
            <h1 class="text-3xl md:text-4xl font-heavy text-gray-800 mb-3">🎨 몽글몽글 미술 교실</h1>
            <p class="text-lg md:text-xl text-gray-500 mb-8">선생님을 위한 가장 간편한 미술 수업 도우미</p>

            <div class="flex flex-wrap justify-center gap-4">
                <a href="{% url 'artclass:library' %}"
                    class="px-6 py-3 rounded-2xl bg-white text-purple-600 font-heavy shadow-clay hover:shadow-clay-hover hover:-translate-y-1 transition-all flex items-center gap-2">
                    <i class="fa-solid fa-book-open"></i> 다른 선생님 수업 둘러보기
                </a>
            </div>
        </div>

        <form id="setupForm" method="POST" action="{% url 'artclass:setup' %}" enctype="multipart/form-data"
            class="space-y-8">
            {% csrf_token %}
            <input type="hidden" name="step_count" id="stepCountInput" value="0">

            <!-- 1. URL & AI Section -->
            <div class="clay-card p-6 md:p-10 bg-white/80 backdrop-blur-sm">
                <div class="grid grid-cols-1 gap-8 items-center">
                    <div class="space-y-4">
                        <label class="flex items-center gap-2 text-lg font-heavy text-gray-700">
                            <i class="fa-brands fa-youtube text-red-500 text-xl"></i> 수업용 유튜브 영상 주소
                        </label>
                        <input type="text" name="videoUrl" id="videoUrl"
                            class="w-full px-5 py-3 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-purple-300 focus:bg-white focus:ring-2 focus:ring-purple-300 transition-all text-base shadow-inner outline-none"
                            placeholder="https://www.youtube.com/watch?v=..."
                            value="{{ art_class.youtube_url|default:'' }}" required>
                    </div>
                </div>

                <div class="mt-8 border-t border-purple-100 pt-6">
                    <div class="rounded-2xl bg-indigo-50/70 border border-indigo-100 p-5 md:p-6 space-y-4">
                        <h3 class="text-lg font-heavy text-indigo-900 flex items-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Gemini 빠른 복사-붙여넣기
                        </h3>
                        <p class="text-[11px] text-indigo-700/80">
                            ※ 유튜브 영상 정리는 지금 <b>Gemini</b>에서만 됩니다.
                            ChatGPT/Perplexity에서 만든 답변은 여기서 바로 적용되지 않습니다.
                        </p>
                        <p class="text-sm text-indigo-900/80 leading-relaxed">
                            교사가 헷갈리지 않도록 흐름을 최소 클릭으로 줄였습니다.
                            아래 순서대로 하면 붙여넣는 즉시 단계가 자동 반영됩니다.
                        </p>
                        <ol class="list-decimal pl-5 space-y-1 text-sm text-indigo-900/85">
                            <li>유튜브 주소를 먼저 입력합니다.</li>
                            <li><b>제미나이 열기 + 프롬프트 자동 복사</b> 버튼을 누릅니다.</li>
                            <li>Gemini 답변(JSON 권장)을 아래 결과 칸에 붙여넣으면 자동 반영됩니다.</li>
                        </ol>
                        <p class="text-xs text-indigo-800">
                            권장 출력 형식: JSON 객체 + <code>steps</code> 배열. 각 step은
                            <code>summary</code> 필수, <code>start/end</code> 선택입니다.
                        </p>
                    </div>

                    <div class="mt-5 p-4 rounded-xl bg-white border border-indigo-100 space-y-2">
                        <label for="geminiTargetVideoUrl" class="text-sm font-heavy text-gray-700">
                            프롬프트용 대상 영상 URL
                        </label>
                        <div class="flex flex-col md:flex-row gap-2">
                            <input type="text" id="geminiTargetVideoUrl"
                                class="w-full px-4 py-2.5 rounded-xl bg-gray-50 border border-gray-200 focus:border-indigo-300 focus:ring-2 focus:ring-indigo-200 outline-none text-sm"
                                placeholder="Gemini 프롬프트에 넣을 영상 URL (비워두면 위 주소 자동 사용)">
                            <button type="button" id="btnUseMainVideoUrl"
                                class="px-4 py-2.5 rounded-xl bg-white border border-indigo-200 text-indigo-700 text-xs font-heavy hover:bg-indigo-50 transition-all whitespace-nowrap">
                                메인 주소 불러오기
                            </button>
                        </div>
                        <p class="text-xs text-indigo-800/90">
                            단계는 6~12개를 권장하며, 24개 초과 시 앞 24개만 자동 반영됩니다.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-5 mt-5">
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label for="geminiPromptBox" class="text-sm font-heavy text-gray-700">1) 제미나이 열기 (프롬프트 자동 복사)</label>
                                <button type="button" id="btnLaunchGeminiFlow"
                                    class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-xs font-heavy hover:bg-indigo-700 transition-all">
                                    제미나이 열기 + 프롬프트 자동 복사
                                </button>
                            </div>
                            <textarea id="geminiPromptBox" readonly
                                class="w-full h-56 p-3 rounded-xl bg-gray-900 text-gray-100 text-xs leading-relaxed shadow-inner border border-gray-800">{{ manual_prompt_template }}</textarea>
                            <p class="text-[11px] text-gray-500">복사가 차단된 브라우저에서는 프롬프트를 직접 선택해 복사해 주세요.</p>
                        </div>

                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label for="geminiResultInput" class="text-sm font-heavy text-gray-700">2) Gemini 결과 붙여넣기 (자동 적용)</label>
                                <button type="button" id="btnApplyGeminiResult"
                                    class="px-3 py-1.5 rounded-lg bg-white border border-emerald-200 text-emerald-700 text-xs font-heavy hover:bg-emerald-50 transition-all">
                                    수동 적용
                                </button>
                            </div>
                            <textarea id="geminiResultInput"
                                class="w-full h-56 p-3 rounded-xl bg-white border-2 border-gray-200 focus:border-indigo-300 focus:ring-2 focus:ring-indigo-200 outline-none text-sm"
                                placeholder='예: {"steps":[{"start":"00:35","summary":"..."}]}'></textarea>
                            <p class="text-[11px] text-gray-500">붙여넣기(Ctrl+V)하면 즉시 검증 후 단계 목록에 반영됩니다.</p>
                            <p id="geminiManualStatus" class="text-sm font-bold text-indigo-700 hidden"></p>
                            <ul id="geminiWarningList" class="space-y-1 text-xs text-amber-700 hidden"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Main Lab Area -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">

                <!-- Left: Video Preview & Help (Sticky) -->
                <div class="lg:col-span-5 lg:sticky lg:top-36 space-y-6">
                    <div class="clay-card p-6 bg-purple-50/50 border-purple-100">
                        <h3 class="font-heavy text-purple-700 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-lightbulb"></i> 초간단 팁
                        </h3>
                        <ul class="text-sm text-purple-900/70 space-y-2 leading-relaxed">
                            <li>• 영상을 보다가 필요한 장면에서 <code class="bg-purple-100 px-1 rounded">Win + Shift + S</code> 캡처
                            </li>
                            <li>• 단계별 <span class="text-purple-600 font-bold">📋 붙여넣기</span> 버튼을 누르면 즉시 이미지 등록!</li>
                        </ul>
                    </div>
                </div>

                <!-- Right: Steps Editor -->
                <div class="lg:col-span-7 space-y-6">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-2xl font-heavy text-gray-700">📋 단계별 활동 구성</h2>
                        <button type="button" id="btnAddStep"
                            class="px-5 py-2 rounded-xl bg-white text-purple-600 font-heavy shadow-sm hover:shadow-md transition-all flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> 단계 추가
                        </button>
                    </div>

                    <div id="stepsList" class="space-y-6">
                        <!-- Step Cards will be injected here -->
                        <div id="emptyState"
                            class="text-center py-24 bg-white/30 rounded-[2rem] border-2 border-dashed border-gray-300">
                            <i class="fa-solid fa-magic text-4xl text-gray-300 mb-4 block"></i>
                            <p class="text-gray-400 font-bold">유튜브 주소를 넣고 Gemini 결과를 붙여넣거나,<br>직접 단계를 추가해 주세요.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Final Settings & Start -->
            <div class="clay-card p-8 bg-white/80 text-center">
                <div class="max-w-xl mx-auto mb-8 text-left">
                    <label for="playbackMode" class="block text-gray-600 font-heavy mb-3">영상 재생 방식</label>
                    <select name="playbackMode" id="playbackMode"
                        class="w-full px-4 py-3 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-purple-300 focus:bg-white focus:ring-2 focus:ring-purple-300 outline-none transition-all">
                        <option value="embed" {% if art_class.playback_mode == "embed" or not art_class %}selected{% endif %}>내장 플레이어 (기본)</option>
                        <option value="external_window" {% if art_class.playback_mode == "external_window" %}selected{% endif %}>새 창 재생 (임베드 금지 영상용)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-2">
                        유튜브 정책으로 내장 재생이 막히는 영상은 새 창 재생 모드를 선택하면 수업 진행이 끊기지 않습니다.
                    </p>
                    <p class="text-xs text-gray-500 mt-1">
                        수업 화면 상단의 <b>화면 분할 시작</b> 버튼으로 유튜브와 안내 화면을 반반 배치할 수 있습니다.
                    </p>
                    <div class="mt-4 rounded-2xl border border-emerald-200 bg-emerald-50 p-4">
                        <p class="text-sm font-heavy text-emerald-900">
                            정식 운영은 교사용 런처 설치가 필요합니다.
                        </p>
                        <p class="text-xs text-emerald-800 mt-1">
                            외부 재생(임베드 차단 영상) 수업은 런처가 좌/우 분할 화면을 자동으로 만들어 줍니다.
                        </p>
                        {% if launcher_download_url %}
                        <a href="{{ launcher_download_url }}" target="_blank" rel="noopener noreferrer"
                            class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-heavy hover:bg-emerald-700 transition-all">
                            <i class="fa-solid fa-download"></i> 런처 설치파일 다운로드
                        </a>
                        {% else %}
                        <p class="text-xs font-bold text-amber-700 mt-2">
                            런처 다운로드 링크가 아직 설정되지 않았습니다. 운영팀에 설치 링크 설정을 요청해 주세요.
                        </p>
                        {% endif %}
                    </div>
                </div>

                <div class="max-w-xs mx-auto mb-8">
                    <label class="block text-gray-600 font-heavy mb-4">자동 전환 간격 (초)</label>
                    <div class="flex items-center gap-4 bg-gray-50 rounded-2xl p-2 shadow-inner">
                            <input type="number" name="stepInterval" id="stepInterval"
                            value="{{ art_class.default_interval|default:15 }}" min="5"
                            class="w-full bg-transparent text-2xl font-heavy text-center outline-none focus:ring-2 focus:ring-purple-300 rounded">
                        <span class="pr-4 text-gray-400 font-bold">초</span>
                    </div>
                </div>

                <button type="submit"
                    class="w-full md:w-auto px-12 py-4 rounded-full bg-green-500 text-white text-2xl font-heavy shadow-lg hover:bg-green-600 hover:scale-105 active:scale-95 transition-all">
                    수업 시작하기 <i class="fa-solid fa-play ml-2 text-xl"></i>
                </button>
            </div>
        </form>

        {% include 'core/partials/service_suggestion.html' with service_key='artclass' %}
    </div>
</main>

<script>
    let steps = JSON.parse('{{ initial_steps_json|safe|default:"[]" }}').map(step => ({
        text: step.text || '',
        imagePreview: step.imagePreview || null,
        existingStepId: step.id || step.existingStepId || null,
    }));
    const stepsListEl = document.getElementById('stepsList');
    const emptyStateEl = document.getElementById('emptyState');
    const stepCountInput = document.getElementById('stepCountInput');
    const videoUrlEl = document.getElementById('videoUrl');
    const geminiTargetVideoUrlEl = document.getElementById('geminiTargetVideoUrl');
    const btnUseMainVideoUrlEl = document.getElementById('btnUseMainVideoUrl');
    const geminiPromptBoxEl = document.getElementById('geminiPromptBox');
    const geminiResultInputEl = document.getElementById('geminiResultInput');
    const geminiManualStatusEl = document.getElementById('geminiManualStatus');
    const geminiWarningListEl = document.getElementById('geminiWarningList');
    const btnLaunchGeminiFlowEl = document.getElementById('btnLaunchGeminiFlow');
    const btnApplyGeminiResultEl = document.getElementById('btnApplyGeminiResult');
    let geminiTargetTouched = false;
    let geminiApplyInProgress = false;
    let lastAppliedGeminiText = '';

    function buildGeminiPrompt(videoUrl) {
        const targetUrl = videoUrl || '(여기에 유튜브 URL 입력)';
        return `당신은 초등 미술 수업 설계 도우미입니다.
아래 영상/자료를 보고 학생이 따라 하기 쉬운 단계별 수업안을 JSON으로만 출력하세요.

대상 영상 URL: ${targetUrl}

출력 규칙:
1) 반드시 JSON만 출력 (코드블록/설명문/인사말 금지)
2) 최상위는 객체이며 steps 배열 필수
3) steps는 6~12개 권장, 절대 24개를 넘기지 않기
4) 가능한 경우 start/end를 MM:SS 형식으로 포함
5) summary는 학생 활동 중심의 짧은 문장
6) materials는 배열, teacher_tip은 문자열

JSON 스키마 예시:
{
  "video_title": "수업 제목",
  "steps": [
    {
      "start": "00:35",
      "end": "01:20",
      "summary": "도화지 중앙에 큰 원을 그리고 배경 색을 고른다.",
      "materials": ["도화지", "연필", "색연필"],
      "teacher_tip": "선 굵기를 달리하면 입체감이 살아난다."
    }
  ]
}`;
    }

    function updateGeminiPrompt() {
        if (!geminiPromptBoxEl) return;
        const promptTargetUrl = (geminiTargetVideoUrlEl?.value || videoUrlEl.value || '').trim();
        geminiPromptBoxEl.value = buildGeminiPrompt(promptTargetUrl);
    }

    function syncGeminiTargetFromMain(force = false) {
        if (!geminiTargetVideoUrlEl) {
            updateGeminiPrompt();
            return;
        }
        const mainUrl = (videoUrlEl?.value || '').trim();
        if (force || !geminiTargetTouched || !geminiTargetVideoUrlEl.value.trim()) {
            geminiTargetVideoUrlEl.value = mainUrl;
        }
        updateGeminiPrompt();
    }

    function setGeminiStatus(message, tone = 'indigo') {
        if (!geminiManualStatusEl) return;
        geminiManualStatusEl.textContent = message || '';
        geminiManualStatusEl.classList.remove('hidden', 'text-indigo-700', 'text-emerald-700', 'text-red-700');
        if (!message) {
            geminiManualStatusEl.classList.add('hidden');
            return;
        }
        const classByTone = {
            indigo: 'text-indigo-700',
            success: 'text-emerald-700',
            error: 'text-red-700',
        };
        geminiManualStatusEl.classList.add(classByTone[tone] || classByTone.indigo);
    }

    function renderGeminiWarnings(warnings) {
        if (!geminiWarningListEl) return;
        const items = Array.isArray(warnings) ? warnings.filter(Boolean) : [];
        if (!items.length) {
            geminiWarningListEl.innerHTML = '';
            geminiWarningListEl.classList.add('hidden');
            return;
        }
        geminiWarningListEl.innerHTML = items.map(msg => `<li>• ${msg}</li>`).join('');
        geminiWarningListEl.classList.remove('hidden');
    }

    if (videoUrlEl) {
        videoUrlEl.addEventListener('input', () => syncGeminiTargetFromMain(false));
    }
    if (geminiTargetVideoUrlEl) {
        geminiTargetVideoUrlEl.addEventListener('input', () => {
            geminiTargetTouched = true;
            updateGeminiPrompt();
        });
    }
    if (btnUseMainVideoUrlEl) {
        btnUseMainVideoUrlEl.addEventListener('click', () => {
            geminiTargetTouched = false;
            syncGeminiTargetFromMain(true);
            setGeminiStatus('메인 주소를 프롬프트 대상 URL로 반영했습니다.', 'indigo');
        });
    }

    function renderSteps() {
        stepCountInput.value = steps.length;
        if (steps.length === 0) {
            stepsListEl.innerHTML = '';
            stepsListEl.appendChild(emptyStateEl);
            emptyStateEl.classList.remove('hidden');
        } else {
            emptyStateEl.classList.add('hidden');
            stepsListEl.innerHTML = steps.map((step, index) => `
                <div class="clay-card p-6 bg-white step-card border-l-8 border-purple-500 relative group animate-in slide-in-from-right-4 duration-300">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- Left: Index -->
                        <div class="flex-none">
                            <div class="w-12 h-12 rounded-2xl bg-purple-600 text-white flex items-center justify-center text-xl font-heavy shadow-lg">
                                ${index + 1}
                            </div>
                        </div>
                        
                        <!-- Middle: Content -->
                        <div class="flex-grow space-y-4">
                            <input type="hidden" name="step_existing_id_${index}" value="${step.existingStepId || ''}">
                            <textarea name="step_text_${index}" 
                                class="w-full p-4 rounded-xl bg-gray-50 border-2 border-transparent focus:border-purple-200 focus:bg-white outline-none focus:ring-2 focus:ring-purple-300 transition-all text-lg font-medium resize-none"
                                rows="2" placeholder="이 단계에서 할 활동을 적어주세요 (예: 구름 무늬 그리기)"
                                oninput="updateStep(${index}, this.value)">${step.text}</textarea>
                            
                            <div class="flex flex-wrap items-center gap-3">
                                <label class="flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-50 text-indigo-700 font-bold cursor-pointer hover:bg-indigo-100 transition-all text-sm">
                                    <i class="fa-solid fa-image"></i> 이미지 선택
                                    <input type="file" name="step_image_${index}" accept="image/*" class="hidden" onchange="previewImage(${index}, this)">
                                </label>
                                <button type="button" onclick="handleClipboardPaste(${index})"
                                    class="flex items-center gap-2 px-4 py-2 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-700 transition-all text-sm">
                                    <i class="fa-solid fa-paste"></i> 📋 붙여넣기
                                </button>
                                <div id="imagePreview_${index}" class="flex-grow">
                                    ${step.imagePreview ? `<img src="${step.imagePreview}" alt="" class="h-16 rounded-lg shadow-sm">` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Right: Actions -->
                        <div class="flex md:flex-col justify-end gap-2">
                             <button type="button" onclick="removeStep(${index})" class="p-3 text-red-300 hover:text-red-500 transition-colors">
                                <i class="fa-solid fa-trash-can text-xl"></i>
                             </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    window.updateStep = (index, val) => steps[index].text = val;
    window.removeStep = (index) => { steps.splice(index, 1); renderSteps(); };

    window.previewImage = (index, input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                steps[index].imagePreview = e.target.result;
                document.getElementById(`imagePreview_${index}`).innerHTML = `<img src="${e.target.result}" alt="" class="h-16 rounded-lg shadow-sm">`;
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    window.handleClipboardPaste = async (index) => {
        try {
            const items = await navigator.clipboard.read();
            for (const item of items) {
                if (item.types.some(t => t.startsWith('image/'))) {
                    const blob = await item.getType(item.types.find(t => t.startsWith('image/')));
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        steps[index].imagePreview = e.target.result;
                        document.getElementById(`imagePreview_${index}`).innerHTML = `<img src="${e.target.result}" alt="" class="h-16 rounded-lg shadow-sm">`;
                        const file = new File([blob], "paste.png", { type: blob.type });
                        const dt = new DataTransfer(); dt.items.add(file);
                        document.querySelector(`input[name="step_image_${index}"]`).files = dt.files;
                    };
                    reader.readAsDataURL(blob);
                    return;
                }
            }
        } catch (e) { alert("클립보드에 이미지가 없거나 브라우저 권한이 없습니다."); }
    };

    document.getElementById('btnAddStep').addEventListener('click', () => {
        steps.push({ text: '', imagePreview: null, existingStepId: null });
        renderSteps();
    });

    async function copyGeminiPrompt() {
        updateGeminiPrompt();
        try {
            await navigator.clipboard.writeText(geminiPromptBoxEl.value);
            return true;
        } catch (_) {
            return false;
        }
    }

    async function applyGeminiResult(options = {}) {
        const source = options.source || 'manual';
        const rawText = (geminiResultInputEl?.value || '').trim();
        if (!rawText) {
            if (!options.silentNoInput) {
                setGeminiStatus('Gemini 결과를 붙여넣어 주세요.', 'error');
            }
            return;
        }
        if (geminiApplyInProgress) return;
        if (source !== 'manual' && rawText === lastAppliedGeminiText) return;

        geminiApplyInProgress = true;
        if (btnApplyGeminiResultEl) {
            btnApplyGeminiResultEl.disabled = true;
            btnApplyGeminiResultEl.textContent = '검증 중...';
        }
        setGeminiStatus(source === 'paste'
            ? '붙여넣기를 감지했습니다. 형식을 점검하고 단계로 변환하고 있습니다...'
            : '형식을 점검하고 단계로 변환하고 있습니다...', 'indigo');
        renderGeminiWarnings([]);

        try {
            const response = await fetch('{% url "artclass:parse_gemini_steps_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    rawText,
                    videoUrl: (geminiTargetVideoUrlEl?.value || videoUrlEl.value || '').trim(),
                }),
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || data.error || '결과를 해석하지 못했습니다.');
            }

            steps = (data.steps || []).map(step => ({
                text: step.text || '',
                imagePreview: null,
                existingStepId: null,
            }));
            renderSteps();
            renderGeminiWarnings(data.warnings || []);

            lastAppliedGeminiText = rawText;
            const parsedCount = data?.meta?.step_count || steps.length;
            setGeminiStatus(`검증 완료: ${parsedCount}개 단계를 반영했습니다.`, 'success');
        } catch (err) {
            setGeminiStatus(err.message || '결과 처리 중 오류가 발생했습니다.', 'error');
        } finally {
            geminiApplyInProgress = false;
            if (btnApplyGeminiResultEl) {
                btnApplyGeminiResultEl.disabled = false;
                btnApplyGeminiResultEl.textContent = '수동 적용';
            }
        }
    }

    if (btnLaunchGeminiFlowEl) {
        btnLaunchGeminiFlowEl.addEventListener('click', async () => {
            const copied = await copyGeminiPrompt();
            const popup = window.open('https://gemini.google.com/app', '_blank', 'noopener,noreferrer');
            if (!popup) {
                setGeminiStatus('팝업이 차단되었습니다. 팝업 허용 후 다시 시도해 주세요.', 'error');
                return;
            }
            if (copied) {
                setGeminiStatus('Gemini를 열고 프롬프트를 자동 복사했습니다. Gemini 입력창에 바로 붙여넣어 주세요.', 'success');
                return;
            }
            setGeminiStatus('Gemini를 열었습니다. 프롬프트 자동 복사가 차단되어 아래 박스에서 직접 복사해 주세요.', 'error');
        });
    }

    if (btnApplyGeminiResultEl) {
        btnApplyGeminiResultEl.addEventListener('click', () => {
            applyGeminiResult({ source: 'manual' });
        });
    }

    if (geminiResultInputEl) {
        geminiResultInputEl.addEventListener('paste', () => {
            setTimeout(() => {
                applyGeminiResult({ source: 'paste', silentNoInput: true });
            }, 0);
        });
    }

    // Init
    syncGeminiTargetFromMain(true);
    renderGeminiWarnings([]);
    renderSteps();
</script>
{% endblock %}

