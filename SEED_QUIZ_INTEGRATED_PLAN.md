# Seed Quiz 최종 통합 계획안

기준일: 2026-02-21  
목표: 교사 업무 제로화, API 비용 최소화, 태블릿 학생 UX 안정화

## 1. 최종 전략 요약

운영 기본은 `공식 문제은행 + CSV`로 고정하고, `RAG`는 제한형 보완 기능으로 운영한다.

- 기본 운영 비율: `90% 비API(공식/CSV)` + `10% 제한형 RAG`
- 교사는 API 키를 다루지 않는다. 모든 외부 API는 서버에서만 호출한다.
- 교사 기본 동선은 `선택 -> 미리보기 -> 배포` 3단계로 고정한다.

## 2. 교사 입장에서 API 사용 지점

교사에게 노출되는 기능별 외부 AI API 호출 여부:

1. `오늘의 공식 퀴즈 적용`: 호출 없음
2. `CSV 업로드`: 호출 없음
3. `맞춤 생성(RAG, 제한형)`: 서버에서만 호출 있음
4. `월간 배치 공장`: 관리자/스케줄러만 호출

결론: 교사 일상 사용은 대부분 API 호출 없이 동작한다.

## 3. 아키텍처 역할 분리

1. `SQQuizBank`: 공유 가능한 원본 콘텐츠 저장소
2. `SQQuizSet`: 교실/날짜 배포본(런타임 객체)
3. `SQAttempt`: 학생 풀이/채점/보상 기록
4. `SQBatchJob`: 월간 배치 작업 추적

핵심 원칙:

- 교사는 은행 콘텐츠를 선택해서 배포본(`SQQuizSet`)으로 복사해 사용
- 학생 플로우(게이트/풀이/보상)는 기존 안정 로직 유지

## 4. 파이프라인 설계

### A. 중앙 공식 배달 (권장 기본)

- 관리자 검수 완료 콘텐츠를 `official`로 게시
- 교사 대시보드에 `오늘의 공식 퀴즈 적용` 목록 제공
- 적용 시 `copy_bank_to_draft()` 후 즉시 미리보기/배포

### B. 월간 Batch 공장

- 매월 25일 다음 달 세트 대량 생성 요청
- 결과 수집 후 공통 validator 검증
- 승인 전 `review`, 승인 후 `official`로 전환

### C. 교사 CSV 업로드

- 템플릿 기반 업로드 -> 행 번호 단위 검증 오류 반환
- 흐름: `parse -> preview -> confirm`
- 공개 체크 시 즉시 공개하지 않고 `review` 대기 후 승인 공개

### D. 제한형 RAG 맞춤 생성

- 교사 입력 텍스트 기반 문제 생성
- 기본 제한: 교실당 하루 1회
- 비용 안전장치: `top_k 3~5`, 출력 토큰 상한, 캐시 적용

## 5. 데이터 모델 확장 (요약)

### SQQuizBank

- `visibility`: official/public/private
- `quality_status`: draft/review/approved/rejected
- `available_from`, `available_to`
- `share_opt_in`, `reviewed_by`, `reviewed_at`

### SQBatchJob (신규)

- `provider`, `batch_id`, `status`
- `input_file_id`, `output_file_id`, `error_file_id`
- `target_month`, `requested_count`, `success_count`, `failed_count`
- `meta_json`, `started_at`, `completed_at`

## 6. 교사 대시보드 최종 UX

버튼 3개만 제공:

1. `오늘의 공식 퀴즈 적용` (기본 탭)
2. `CSV 업로드`
3. `맞춤 생성(RAG)` (권한/횟수 제한)

기존 `AI 즉시 생성` 버튼은 기본 UI에서 제거하거나 관리자 플래그로 숨긴다.

## 7. RAG 비용 최소화 설계

1. 문서를 규격화해서 DB 저장
2. 업로드 시 임베딩 1회 생성 후 재사용
3. 질의 시 관련 청크만 추출해 LLM에 전달
4. 동일 조건 질의는 캐시 재사용

주의:

- 긴 원문을 매번 LLM에 통째로 보내면 비용 절감 효과가 사라진다.

## 8. 안정성/품질/보안 기준

1. 보상은 기존 멱등성/트랜잭션 정책 유지
2. 교사 권한 검증(`classroom.teacher == request.user`) 강제
3. 학생 URL 변조 방지를 위한 세션-DB 교차검증 유지
4. 공통 validator로 정답 누락/중복 보기/깨진 문자 차단
5. 공개 콘텐츠는 승인 전 미노출

## 9. 단계별 오픈 로드맵

### Phase 1 (즉시)

- 은행 선택 중심 교사 UI 전환
- 공식 콘텐츠 적용 흐름 안정화

### Phase 2

- CSV 업로드 + 미리보기 + 확정 배포
- 공개 공유 승인 워크플로우 추가

### Phase 3

- 월간 Batch 생성/수집 파이프라인 운영화
- 관리 대시보드에서 승인 일괄 처리

### Phase 4

- 제한형 RAG 파일럿 오픈
- 사용량/비용/품질 지표 기반 점진 확대

## 10. 완료 기준 (DoD)

1. 교사가 30초 내 퀴즈 배포 가능
2. 월간 공식 세트 100개 이상 안정 공급
3. CSV 오류 메시지 행 번호 단위 제공
4. 학생 풀이/보상 회귀 테스트 통과
5. 운영 2주간 중복 보상/정답 누락/배포 실패 0건
