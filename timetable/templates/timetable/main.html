{% extends 'base.html' %}

{% block title %}ì „ë‹´ ì‹œê°„í‘œÂ·íŠ¹ë³„ì‹¤ ë°°ì¹˜ ë„ìš°ë¯¸{% endblock %}

{% block content %}
<section class="pt-32 pb-20 px-4 min-h-screen bg-slate-50">
    <div class="max-w-6xl mx-auto space-y-6">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8">
            <div class="flex items-start gap-4">
                <div class="w-14 h-14 rounded-xl bg-indigo-100 text-indigo-600 text-2xl flex items-center justify-center shrink-0">
                    ğŸ“˜
                </div>
                <div class="space-y-2">
                    <h1 class="text-2xl md:text-3xl font-black text-slate-800">ì „ë‹´ ì‹œê°„í‘œÂ·íŠ¹ë³„ì‹¤ ë°°ì¹˜ ë„ìš°ë¯¸</h1>
                    <p class="text-slate-600 leading-relaxed">
                        ì „ë‹´ ì„ ìƒë‹˜ ì‹œê°„í‘œë¥¼ ë¨¼ì € ë§Œë“¤ê³ , ê²¹ì¹¨ ì—¬ë¶€ë¥¼ ì ê²€í•œ ë’¤ íŠ¹ë³„ì‹¤ ìš´ì˜ ë°©ì‹ê¹Œì§€ ì—°ê²°í•©ë‹ˆë‹¤.
                        ë¨¼ì € ì…ë ¥ ì–‘ì‹ì„ ë‚´ë ¤ë°›ì•„ ì‘ì„±í•œ í›„ ì—…ë¡œë“œ ì ê²€ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.
                    </p>
                    <div class="flex flex-wrap gap-2 pt-1">
                        {% if service %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-indigo-50 text-indigo-700">
                            {{ service.get_service_type_display }}
                        </span>
                        {% endif %}
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-emerald-50 text-emerald-700">
                            êµì‚¬ìš© ì‰¬ìš´ ìš©ì–´ ì ìš©
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-lg font-black text-slate-800 mb-4">1ë‹¨ê³„: ì…ë ¥ ì–‘ì‹ ë‚´ë ¤ë°›ê¸°</h2>
                <p class="text-sm text-slate-600 mb-4">ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ í‘œì¤€ ì–‘ì‹ì„ ë°›ì•„ ê·¸ëŒ€ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.</p>
                <a href="{% url 'timetable:download_template' %}"
                    class="inline-flex items-center justify-center w-full md:w-auto px-5 py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition-colors">
                    <i class="fa-solid fa-download mr-2"></i>
                    ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                </a>

                <div class="mt-5">
                    <h3 class="text-sm font-bold text-slate-700 mb-2">í•„ìˆ˜ ì‹œíŠ¸</h3>
                    <div class="flex flex-wrap gap-2">
                        {% for sheet_name in required_sheet_names %}
                        <span class="px-2.5 py-1 rounded-lg text-xs font-semibold bg-slate-100 text-slate-700">{{ sheet_name }}</span>
                        {% endfor %}
                    </div>
                    {% if optional_sheet_names %}
                    <h3 class="text-sm font-bold text-slate-700 mt-4 mb-2">ì„ íƒ ì‹œíŠ¸ (ê³ ê¸‰)</h3>
                    <p class="text-xs text-slate-500 mb-2">ì—†ì–´ë„ ìë™ ë°°ì¹˜ëŠ” ê°€ëŠ¥í•©ë‹ˆë‹¤. ì„¸ë°€ ì¡°ì •ì´ í•„ìš”í•  ë•Œë§Œ ì‘ì„±í•˜ì„¸ìš”.</p>
                    <div class="flex flex-wrap gap-2">
                        {% for sheet_name in optional_sheet_names %}
                        <span class="px-2.5 py-1 rounded-lg text-xs font-semibold bg-indigo-50 text-indigo-700 border border-indigo-100">{{ sheet_name }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="mt-5 rounded-xl border border-indigo-200 bg-indigo-50 px-4 py-3 space-y-1">
                    <p class="text-xs font-bold text-indigo-900">ë°°ì¹˜ì¡°ê±´ ì…ë ¥ í•µì‹¬</p>
                    <p class="text-xs text-indigo-900">ê¸°ë³¸ì€ ê°™ì€ í•™ê¸‰Â·êµê³¼ í•˜ë£¨ 1íšŒì…ë‹ˆë‹¤. 2ì‹œê°„ ì´ìƒì€ `ë‚˜ëˆ ë°°ì¹˜(ì˜ˆ: 2+1)`ë¥¼ ë„£ì–´ì•¼ í—ˆìš©ë©ë‹ˆë‹¤.</p>
                    <p class="text-xs text-indigo-900">ìˆœí™˜ë°°ì¹˜ëŠ” ê¸°ë³¸ ONì´ë©°, í•„ìš”í•˜ë©´ ë°°ì¹˜ì¡°ê±´ì—ì„œ `ìˆœí™˜ë°°ì¹˜ / OFF`ë¡œ í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-lg font-black text-slate-800 mb-4">2ë‹¨ê³„: ì‘ì„± íŒŒì¼ ì ê²€í•˜ê¸°</h2>
                <form method="post" enctype="multipart/form-data" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="generate">
                    <div>
                        <label for="{{ form.reservation_school_slug.id_for_label }}" class="block text-sm font-bold text-slate-700 mb-2">ì˜ˆì•½ ë°˜ì˜ í•™êµ (ì„ íƒ)</label>
                        {{ form.reservation_school_slug }}
                        {% if form.reservation_school_slug.help_text %}
                        <p class="text-xs text-slate-500 mt-2">{{ form.reservation_school_slug.help_text }}</p>
                        {% endif %}
                        {% if form.reservation_school_slug.errors %}
                        <div class="mt-2 text-sm text-red-600">
                            {% for error in form.reservation_school_slug.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% if can_use_overwrite_option %}
                    <div class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">
                        <label class="inline-flex items-start gap-2 text-sm text-slate-700">
                            {{ form.overwrite_existing }}
                            <span>
                                <span class="font-bold text-slate-800">{{ form.overwrite_existing.label }}</span>
                                {% if form.overwrite_existing.help_text %}
                                <span class="block text-xs text-slate-500 mt-1">{{ form.overwrite_existing.help_text }}</span>
                                {% endif %}
                            </span>
                        </label>
                    </div>
                    {% endif %}
                    <div>
                        <label for="{{ form.excel_file.id_for_label }}" class="block text-sm font-bold text-slate-700 mb-2">ì‹œê°„í‘œ ì—‘ì…€ íŒŒì¼</label>
                        {{ form.excel_file }}
                        {% if form.excel_file.help_text %}
                        <p class="text-xs text-slate-500 mt-2">{{ form.excel_file.help_text }}</p>
                        {% endif %}
                        {% if form.excel_file.errors %}
                        <div class="mt-2 text-sm text-red-600">
                            {% for error in form.excel_file.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <button type="submit"
                        class="inline-flex items-center justify-center w-full md:w-auto px-5 py-3 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700 transition-colors">
                        <i class="fa-solid fa-check mr-2"></i>
                        ì—…ë¡œë“œí•˜ê³  ì ê²€í•˜ê¸°
                    </button>
                </form>
            </div>
        </div>

        {% if check_result %}
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 space-y-5">
            <div class="flex items-center gap-3">
                {% if check_result.is_valid %}
                <span class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center text-lg">
                    <i class="fa-solid fa-circle-check"></i>
                </span>
                <div>
                    <h2 class="text-lg font-black text-emerald-700">ì ê²€ ì™„ë£Œ: ì…ë ¥ í˜•ì‹ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤.</h2>
                    <p class="text-sm text-slate-600">ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ìë™ ë°°ì¹˜ ê¸°ëŠ¥ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                {% else %}
                <span class="w-10 h-10 rounded-full bg-red-100 text-red-700 flex items-center justify-center text-lg">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </span>
                <div>
                    <h2 class="text-lg font-black text-red-700">ì ê²€ ê²°ê³¼: ìˆ˜ì •ì´ í•„ìš”í•œ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.</h2>
                    <p class="text-sm text-slate-600">ì•„ë˜ ì˜¤ë¥˜ë¥¼ ë¨¼ì € í•´ê²°í•œ ë’¤ ë‹¤ì‹œ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</p>
                </div>
                {% endif %}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="rounded-xl bg-slate-50 p-4 border border-slate-200">
                    <p class="text-xs text-slate-500">í•„ìˆ˜ ì‹œíŠ¸ ìˆ˜</p>
                    <p class="text-xl font-black text-slate-800">{{ check_result.summary.í•„ìˆ˜ì‹œíŠ¸ìˆ˜ }}</p>
                </div>
                <div class="rounded-xl bg-slate-50 p-4 border border-slate-200">
                    <p class="text-xs text-slate-500">í™•ì¸ëœ ì‹œíŠ¸ ìˆ˜</p>
                    <p class="text-xl font-black text-slate-800">{{ check_result.summary.í™•ì¸ëœì‹œíŠ¸ìˆ˜ }}</p>
                </div>
                <div class="rounded-xl bg-slate-50 p-4 border border-slate-200">
                    <p class="text-xs text-slate-500">ì´ ì…ë ¥ í–‰ ìˆ˜</p>
                    <p class="text-xl font-black text-slate-800">{{ check_result.summary.ì´ì…ë ¥í–‰ìˆ˜ }}</p>
                </div>
            </div>

            {% if check_result.errors %}
            <div>
                <h3 class="text-sm font-black text-red-700 mb-2">ì˜¤ë¥˜</h3>
                <ul class="space-y-2">
                    {% for item in check_result.errors %}
                    <li class="text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg px-3 py-2">{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if check_result.warnings %}
            <div>
                <h3 class="text-sm font-black text-amber-700 mb-2">ì•ˆë‚´</h3>
                <ul class="space-y-2">
                    {% for item in check_result.warnings %}
                    <li class="text-sm text-amber-800 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2">{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if check_result.sheet_stats %}
            <div>
                <h3 class="text-sm font-black text-slate-700 mb-2">ì‹œíŠ¸ë³„ ì…ë ¥ í˜„í™©</h3>
                <div class="overflow-x-auto border border-slate-200 rounded-xl">
                    <table class="w-full min-w-[420px] text-sm">
                        <thead class="bg-slate-100 text-slate-700">
                            <tr>
                                <th class="text-left px-4 py-2 font-bold">ì‹œíŠ¸ ì´ë¦„</th>
                                <th class="text-right px-4 py-2 font-bold">ì…ë ¥ëœ í–‰ ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in check_result.sheet_stats %}
                            <tr class="border-t border-slate-200">
                                <td class="px-4 py-2 text-slate-700">{{ row.sheet_name }}</td>
                                <td class="px-4 py-2 text-right text-slate-700">{{ row.data_rows }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if generated_result %}
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 space-y-6">
            <div class="flex items-center gap-3">
                {% if generated_result.is_success %}
                <span class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center text-lg">
                    <i class="fa-solid fa-circle-check"></i>
                </span>
                <div>
                    <h2 class="text-lg font-black text-emerald-700">ìë™ ë°°ì¹˜ ì™„ë£Œ</h2>
                    <p class="text-sm text-slate-600">ì „ë‹´ ì‹œê°„í‘œì™€ íŠ¹ë³„ì‹¤ ê²°ê³¼ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
                </div>
                {% else %}
                <span class="w-10 h-10 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center text-lg">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </span>
                <div>
                    <h2 class="text-lg font-black text-amber-700">ë¶€ë¶„ ì™„ë£Œ</h2>
                    <p class="text-sm text-slate-600">ë°°ì¹˜ ê²°ê³¼ì™€ ì˜¤ë¥˜ ì•ˆë‚´ë¥¼ í•¨ê»˜ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
                </div>
                {% endif %}
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="rounded-xl bg-slate-50 p-4 border border-slate-200">
                    <p class="text-xs text-slate-500">í•„ìš” ìˆ˜ì—…ì¹¸</p>
                    <p class="text-xl font-black text-slate-800">{{ generated_result.summary.total_needed }}</p>
                </div>
                <div class="rounded-xl bg-slate-50 p-4 border border-slate-200">
                    <p class="text-xs text-slate-500">ë°°ì¹˜ëœ ìˆ˜ì—…ì¹¸</p>
                    <p class="text-xl font-black text-slate-800">{{ generated_result.summary.placed_count }}</p>
                </div>
                <div class="rounded-xl bg-slate-50 p-4 border border-slate-200">
                    <p class="text-xs text-slate-500">ë‚¨ì€ ìˆ˜ì—…ì¹¸</p>
                    <p class="text-xl font-black {% if generated_result.summary.unplaced_count > 0 %}text-red-700{% else %}text-emerald-700{% endif %}">
                        {{ generated_result.summary.unplaced_count }}
                    </p>
                </div>
                <div class="rounded-xl bg-slate-50 p-4 border border-slate-200">
                    <p class="text-xs text-slate-500">ê²¹ì¹¨ ìˆ˜</p>
                    <p class="text-xl font-black text-slate-800">{{ generated_result.summary.overlap_count }}</p>
                </div>
            </div>

            {% if integration_result %}
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-4 space-y-3">
                <h3 class="text-sm font-black text-slate-800">ì˜ˆì•½ ì‹œìŠ¤í…œ ë°˜ì˜ ê²°ê³¼ ({{ integration_result.school_name }})</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <div class="rounded-lg bg-white border border-slate-200 px-3 py-2">
                        <p class="text-xs text-slate-500">ìƒˆë¡œ ë°˜ì˜</p>
                        <p class="text-lg font-black text-slate-800">{{ integration_result.applied_count }}</p>
                    </div>
                    <div class="rounded-lg bg-white border border-slate-200 px-3 py-2">
                        <p class="text-xs text-slate-500">ì´ë¦„ ê°±ì‹ </p>
                        <p class="text-lg font-black text-slate-800">{{ integration_result.updated_count }}</p>
                    </div>
                    <div class="rounded-lg bg-white border border-slate-200 px-3 py-2">
                        <p class="text-xs text-slate-500">ê±´ë„ˆëœ€</p>
                        <p class="text-lg font-black text-slate-800">{{ integration_result.skipped_count }}</p>
                    </div>
                    <div class="rounded-lg bg-white border border-slate-200 px-3 py-2">
                        <p class="text-xs text-slate-500">ê¸°ì¡´ê°’ ì¶©ëŒ</p>
                        <p class="text-lg font-black text-slate-800">{{ integration_result.conflict_count }}</p>
                    </div>
                    <div class="rounded-lg bg-white border border-slate-200 px-3 py-2">
                        <p class="text-xs text-slate-500">ì‹ ê·œ íŠ¹ë³„ì‹¤</p>
                        <p class="text-lg font-black text-slate-800">{{ integration_result.room_created_count }}</p>
                    </div>
                </div>
                {% if integration_result.messages %}
                <ul class="space-y-2">
                    {% for message in integration_result.messages %}
                    <li class="text-sm text-amber-800 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2">{{ message }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% if integration_result.reservation_url %}
                <div class="flex flex-wrap gap-2 pt-1">
                    <a href="{{ integration_result.reservation_url }}" class="inline-flex items-center px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm font-bold hover:bg-indigo-700">
                        ì˜ˆì•½ í™”ë©´ ë³´ê¸°
                    </a>
                    <a href="{{ integration_result.reservation_admin_url }}" class="inline-flex items-center px-3 py-2 rounded-lg bg-slate-700 text-white text-sm font-bold hover:bg-slate-800">
                        ì˜ˆì•½ ê´€ë¦¬ì í™”ë©´ ë³´ê¸°
                    </a>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if preview_apply_info and preview_apply_info.preview_count > 0 %}
            <div class="rounded-xl border border-indigo-200 bg-indigo-50 p-4 space-y-3">
                <h3 class="text-sm font-black text-indigo-800">ë¯¸ë¦¬ë³´ê¸° í•­ëª© ìˆ˜ë™ ë°˜ì˜</h3>
                <p class="text-sm text-indigo-800">
                    í˜„ì¬ <span class="font-black">{{ preview_apply_info.preview_count }}</span>ê°œ í•­ëª©ì´ `ë¯¸ë¦¬ë³´ê¸°`ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                    ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì˜ˆì•½ ì‹œìŠ¤í…œì— ë°˜ì˜ë©ë‹ˆë‹¤.
                </p>
                <form method="post" class="space-y-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="apply_preview">
                    <input type="hidden" name="sync_token" value="{{ preview_apply_info.token }}">
                    <input type="hidden" name="school_slug" value="{{ preview_apply_info.school_slug }}">
                    {% if can_use_overwrite_option %}
                    <label class="inline-flex items-start gap-2 text-sm text-indigo-900">
                        <input type="checkbox" name="overwrite_existing" class="h-4 w-4 rounded border-indigo-300 text-indigo-600 focus:ring-indigo-500">
                        <span>ê¸°ì¡´ ê³ ì •ì‹œê°„í‘œ ë®ì–´ì“°ê¸° (ê´€ë¦¬ì ì „ìš©)</span>
                    </label>
                    {% endif %}
                    <div>
                        <button type="submit" class="inline-flex items-center px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-bold hover:bg-indigo-700">
                            ë¯¸ë¦¬ë³´ê¸° í•­ëª© ì˜ˆì•½ ë°˜ì˜í•˜ê¸°
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}

            {% if generated_result.errors %}
            <div>
                <h3 class="text-sm font-black text-red-700 mb-2">ì˜¤ë¥˜ ì•ˆë‚´</h3>
                <ul class="space-y-2">
                    {% for item in generated_result.errors %}
                    <li class="text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg px-3 py-2">{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if generated_result.warnings %}
            <div>
                <h3 class="text-sm font-black text-amber-700 mb-2">ì¶”ê°€ ì•ˆë‚´</h3>
                <ul class="space-y-2">
                    {% for item in generated_result.warnings %}
                    <li class="text-sm text-amber-800 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2">{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="space-y-4">
                <h3 class="text-base font-black text-slate-800">ì „ë‹´ ì„ ìƒë‹˜ ì‹œê°„í‘œ</h3>
                {% for table in generated_result.teacher_tables %}
                <div class="border border-slate-200 rounded-xl overflow-x-auto">
                    <div class="px-4 py-3 bg-slate-100 border-b border-slate-200">
                        <p class="text-sm font-black text-slate-800">{{ table.teacher_name }} <span class="text-slate-500 font-semibold">({{ table.teacher_id }})</span></p>
                    </div>
                    <table class="w-full min-w-[680px] text-sm">
                        <thead class="bg-white text-slate-700">
                            <tr>
                                <th class="text-left px-3 py-2 font-bold border-b border-slate-200">ì‹œê°„ì¹¸</th>
                                {% for day in generated_result.days %}
                                <th class="text-left px-3 py-2 font-bold border-b border-slate-200">{{ day }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in table.rows %}
                            <tr class="border-b border-slate-100">
                                <td class="px-3 py-2 font-bold text-slate-700 bg-slate-50">{{ row.slot_label }}</td>
                                {% for cell in row.cells %}
                                <td class="px-3 py-2 text-slate-700">
                                    {% if cell %}
                                    <span class="inline-flex px-2 py-1 rounded-md bg-indigo-50 text-indigo-700 font-semibold">{{ cell }}</span>
                                    {% else %}
                                    <span class="text-slate-300">-</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>

            {% if generated_result.class_tables %}
            <details class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                <summary class="cursor-pointer text-sm font-black text-slate-800">ë‹´ì„ ì°¸ê³ ìš©: í•™ê¸‰ë³„ ì „ë‹´ ì ìœ í‘œ ë³´ê¸°</summary>
                <div class="mt-4 space-y-4">
                    {% for table in generated_result.class_tables %}
                    <div class="border border-slate-200 rounded-xl overflow-x-auto bg-white">
                        <div class="px-4 py-3 bg-slate-100 border-b border-slate-200">
                            <p class="text-sm font-black text-slate-800">{{ table.class_id }}</p>
                        </div>
                        <table class="w-full min-w-[680px] text-sm">
                            <thead class="bg-white text-slate-700">
                                <tr>
                                    <th class="text-left px-3 py-2 font-bold border-b border-slate-200">ì‹œê°„ì¹¸</th>
                                    {% for day in generated_result.days %}
                                    <th class="text-left px-3 py-2 font-bold border-b border-slate-200">{{ day }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in table.rows %}
                                <tr class="border-b border-slate-100">
                                    <td class="px-3 py-2 font-bold text-slate-700 bg-slate-50">{{ row.slot_label }}</td>
                                    {% for cell in row.cells %}
                                    <td class="px-3 py-2 text-slate-700">
                                        {% if cell %}
                                        <span class="inline-flex px-2 py-1 rounded-md bg-purple-50 text-purple-700 font-semibold">{{ cell }}</span>
                                        {% else %}
                                        <span class="text-slate-300">-</span>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endfor %}
                </div>
            </details>
            {% endif %}

            {% if generated_result.room_tables %}
            <div class="space-y-4">
                <h3 class="text-base font-black text-slate-800">íŠ¹ë³„ì‹¤ ìë™ë°°ì¹˜ ì‹œê°„í‘œ</h3>
                {% for table in generated_result.room_tables %}
                <div class="border border-slate-200 rounded-xl overflow-x-auto">
                    <div class="px-4 py-3 bg-slate-100 border-b border-slate-200">
                        <p class="text-sm font-black text-slate-800">{{ table.room_name }}</p>
                    </div>
                    <table class="w-full min-w-[680px] text-sm">
                        <thead class="bg-white text-slate-700">
                            <tr>
                                <th class="text-left px-3 py-2 font-bold border-b border-slate-200">ì‹œê°„ì¹¸</th>
                                {% for day in generated_result.days %}
                                <th class="text-left px-3 py-2 font-bold border-b border-slate-200">{{ day }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in table.rows %}
                            <tr class="border-b border-slate-100">
                                <td class="px-3 py-2 font-bold text-slate-700 bg-slate-50">{{ row.slot_label }}</td>
                                {% for cell in row.cells %}
                                <td class="px-3 py-2 text-slate-700">
                                    {% if cell %}
                                    <span class="inline-flex px-2 py-1 rounded-md bg-emerald-50 text-emerald-700 font-semibold">{{ cell }}</span>
                                    {% else %}
                                    <span class="text-slate-300">-</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if generated_result.reservation_rows %}
            <div class="space-y-3">
                <h3 class="text-base font-black text-slate-800">ì˜ˆì•½ ì—°ë™ ëŒ€ìƒ ëª©ë¡</h3>
                <div class="overflow-x-auto border border-slate-200 rounded-xl">
                    <table class="w-full min-w-[760px] text-sm">
                        <thead class="bg-slate-100 text-slate-700">
                            <tr>
                                <th class="text-left px-3 py-2 font-bold">íŠ¹ë³„ì‹¤</th>
                                <th class="text-left px-3 py-2 font-bold">ìš”ì¼</th>
                                <th class="text-left px-3 py-2 font-bold">ì‹œê°„ì¹¸</th>
                                <th class="text-left px-3 py-2 font-bold">í•™ê¸‰</th>
                                <th class="text-left px-3 py-2 font-bold">êµê³¼</th>
                                <th class="text-left px-3 py-2 font-bold">ì „ë‹´ ì„ ìƒë‹˜</th>
                                <th class="text-left px-3 py-2 font-bold">ì—°ë™ ì„ íƒ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in generated_result.reservation_rows %}
                            <tr class="border-t border-slate-200">
                                <td class="px-3 py-2">{{ item.room_name }}</td>
                                <td class="px-3 py-2">{{ item.day }}</td>
                                <td class="px-3 py-2">{{ item.slot_label }}</td>
                                <td class="px-3 py-2">{{ item.class_id }}</td>
                                <td class="px-3 py-2">{{ item.subject }}</td>
                                <td class="px-3 py-2">{{ item.teacher_name }}</td>
                                <td class="px-3 py-2">{{ item.sync_option }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <div class="space-y-3">
                <h3 class="text-base font-black text-slate-800">ë°°ì •ë³„ ì§„í–‰ í˜„í™©</h3>
                <div class="overflow-x-auto border border-slate-200 rounded-xl">
                    <table class="w-full min-w-[760px] text-sm">
                        <thead class="bg-slate-100 text-slate-700">
                            <tr>
                                <th class="text-left px-3 py-2 font-bold">ë°°ì •ë²ˆí˜¸</th>
                                <th class="text-left px-3 py-2 font-bold">ì „ë‹´ ì„ ìƒë‹˜</th>
                                <th class="text-left px-3 py-2 font-bold">êµê³¼</th>
                                <th class="text-left px-3 py-2 font-bold">í•™ê¸‰</th>
                                <th class="text-right px-3 py-2 font-bold">í•„ìš”</th>
                                <th class="text-right px-3 py-2 font-bold">ë°°ì¹˜ë¨</th>
                                <th class="text-right px-3 py-2 font-bold">ë‚¨ìŒ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in generated_result.assignment_status_rows %}
                            <tr class="border-t border-slate-200">
                                <td class="px-3 py-2">{{ row.assignment_id }}</td>
                                <td class="px-3 py-2">{{ row.teacher_name }}</td>
                                <td class="px-3 py-2">{{ row.subject }}</td>
                                <td class="px-3 py-2">{{ row.class_id }}</td>
                                <td class="px-3 py-2 text-right">{{ row.needed_hours }}</td>
                                <td class="px-3 py-2 text-right">{{ row.placed_hours }}</td>
                                <td class="px-3 py-2 text-right {% if row.remaining_hours > 0 %}text-red-700 font-bold{% else %}text-emerald-700 font-bold{% endif %}">
                                    {{ row.remaining_hours }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if request.user.is_authenticated %}
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 space-y-3">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <h2 class="text-lg font-black text-slate-800">ìµœê·¼ ì˜ˆì•½ ë°˜ì˜ ë‚´ì—­</h2>
                <a href="{% url 'timetable:download_sync_logs_csv' %}{% if csv_download_query %}?{{ csv_download_query }}{% endif %}"
                    class="inline-flex items-center px-3 py-2 rounded-lg bg-slate-800 text-white text-sm font-bold hover:bg-slate-900">
                    <i class="fa-solid fa-file-csv mr-2"></i>
                    CSV ë‹¤ìš´ë¡œë“œ
                </a>
            </div>
            <div class="rounded-xl border border-indigo-200 bg-indigo-50 px-4 py-4 space-y-2">
                <h3 class="text-sm font-black text-indigo-900">ì‚¬ìš© ë°©ë²• (ì²˜ìŒ ì“°ëŠ” ì„ ìƒë‹˜ìš©)</h3>
                <p class="text-sm text-indigo-900">ì•„ë˜ ìˆœì„œëŒ€ë¡œ í•˜ë©´ ì›í•˜ëŠ” ë°˜ì˜ ë‚´ì—­ë§Œ ë¹ ë¥´ê²Œ ì°¾ê³ , ê°™ì€ ì¡°ê±´ìœ¼ë¡œ CSVë¥¼ ë‚´ë ¤ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                {% if request.user.is_superuser %}
                <p class="text-xs text-indigo-800">ê´€ë¦¬ì ê³„ì •ì€ ì „ì²´ í•™êµ/ì „ì²´ ì‚¬ìš©ì ë°˜ì˜ ë‚´ì—­ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                {% else %}
                <p class="text-xs text-indigo-800">ì¼ë°˜ ê³„ì •ì€ ë‚´ ê³„ì •ìœ¼ë¡œ ì‹¤í–‰í•œ ë°˜ì˜ ë‚´ì—­ë§Œ ë³´ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì„ ìƒë‹˜/ë‹¤ë¥¸ í•™êµ ë‚´ì—­ì€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                {% endif %}
                <ol class="list-decimal pl-5 space-y-1 text-sm text-indigo-900">
                    <li><span class="font-bold">í•™êµ ì„ íƒ</span>:
                        {% if request.user.is_superuser %}
                        í•œ í•™êµë§Œ ë³´ê³  ì‹¶ìœ¼ë©´ í•™êµë¥¼ ê³ ë¥´ê³ , ì „ì²´ë¥¼ ë³´ê³  ì‹¶ìœ¼ë©´ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
                        {% else %}
                        ë‚´ê°€ ë°˜ì˜í•œ í•™êµ ì¤‘ í•œ í•™êµë§Œ ë³´ê³  ì‹¶ìœ¼ë©´ í•™êµë¥¼ ê³ ë¥´ê³ , ì—¬ëŸ¬ í•™êµë¥¼ ë³´ë ¤ë©´ <span class="font-bold">ë‚´ í•™êµ ì „ì²´</span>ë¡œ ë‘¡ë‹ˆë‹¤.
                        {% endif %}
                    </li>
                    <li><span class="font-bold">ë‚ ì§œ ì…ë ¥</span>: ì‹œì‘ ë‚ ì§œì™€ ë ë‚ ì§œë¥¼ ë„£ê³  <span class="font-bold">ì¡°íšŒí•˜ê¸°</span>ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.</li>
                    <li><span class="font-bold">CSV ë‹¤ìš´ë¡œë“œ</span>: ì§€ê¸ˆ ë³´ì´ëŠ” ì¡°ê±´ ê·¸ëŒ€ë¡œ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.</li>
                </ol>
                <p class="text-xs text-indigo-800">
                    ì˜ˆì‹œ: 2026-03-01ë¶€í„° 2026-03-31ê¹Œì§€ í•œ í•™êµë§Œ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´, í•™êµë¥¼ ê³ ë¥¸ ë’¤ ì‹œì‘ ë‚ ì§œ/ë ë‚ ì§œë¥¼ ì…ë ¥í•˜ê³  ì¡°íšŒí•˜ë©´ ë©ë‹ˆë‹¤.
                </p>
                <p class="text-xs text-indigo-800">
                    ì¡°ê±´ì„ ë‹¤ì‹œ ì²˜ìŒìœ¼ë¡œ ëŒë¦¬ê³  ì‹¶ìœ¼ë©´ <span class="font-bold">ì¡°ê±´ ì´ˆê¸°í™”</span>ë¥¼ ëˆ„ë¥´ì„¸ìš”.
                </p>
            </div>
            <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-600 mb-1">í•™êµ ì„ íƒ</label>
                    <select name="log_school_slug" class="w-full rounded-lg border-slate-300 text-sm">
                        <option value="">
                            {% if request.user.is_superuser %}ì „ì²´ í•™êµ{% else %}ë‚´ í•™êµ ì „ì²´{% endif %}
                        </option>
                        {% for slug, name in log_school_options %}
                        <option value="{{ slug }}" {% if log_filters.school_slug == slug %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1">ì‹œì‘ ë‚ ì§œ</label>
                    <input type="date" name="log_date_from" value="{{ log_filters.date_from_text }}" class="w-full rounded-lg border-slate-300 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1">ë ë‚ ì§œ</label>
                    <input type="date" name="log_date_to" value="{{ log_filters.date_to_text }}" class="w-full rounded-lg border-slate-300 text-sm">
                </div>
                <div class="md:col-span-4 flex flex-wrap gap-2">
                    <button type="submit" class="inline-flex items-center px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm font-bold hover:bg-indigo-700">
                        ì¡°íšŒí•˜ê¸°
                    </button>
                    <a href="{% url 'timetable:main' %}" class="inline-flex items-center px-3 py-2 rounded-lg bg-slate-100 text-slate-700 text-sm font-bold hover:bg-slate-200">
                        ì¡°ê±´ ì´ˆê¸°í™”
                    </a>
                </div>
            </form>
            <div class="overflow-x-auto border border-slate-200 rounded-xl">
                <table class="w-full min-w-[980px] text-sm">
                    <thead class="bg-slate-100 text-slate-700">
                        <tr>
                            <th class="text-left px-3 py-2 font-bold">ì‹¤í–‰ ì‹œê°</th>
                            <th class="text-left px-3 py-2 font-bold">ì‹¤í–‰ì</th>
                            <th class="text-left px-3 py-2 font-bold">í•™êµ</th>
                            <th class="text-left px-3 py-2 font-bold">ë°˜ì˜ ë°©ì‹</th>
                            <th class="text-left px-3 py-2 font-bold">ì˜µì…˜</th>
                            <th class="text-right px-3 py-2 font-bold">ìƒˆë¡œ ë°˜ì˜</th>
                            <th class="text-right px-3 py-2 font-bold">ì´ë¦„ ê°±ì‹ </th>
                            <th class="text-right px-3 py-2 font-bold">ì¶©ëŒ</th>
                            <th class="text-left px-3 py-2 font-bold">ìš”ì•½</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_sync_logs %}
                        {% for row in recent_sync_logs %}
                        <tr class="border-t border-slate-200">
                            <td class="px-3 py-2">{{ row.created_at|date:"Y-m-d H:i" }}</td>
                            <td class="px-3 py-2">{{ row.user.username|default:"(ì‹œìŠ¤í…œ)" }}</td>
                            <td class="px-3 py-2">{{ row.school_name|default:row.school_slug }}</td>
                            <td class="px-3 py-2">{{ row.get_sync_mode_display }}</td>
                            <td class="px-3 py-2">
                                {{ row.sync_options_text }}
                                {% if row.overwrite_existing %}
                                <span class="ml-1 inline-flex px-2 py-0.5 rounded bg-amber-100 text-amber-800 text-xs font-bold">ë®ì–´ì“°ê¸°</span>
                                {% endif %}
                            </td>
                            <td class="px-3 py-2 text-right">{{ row.applied_count }}</td>
                            <td class="px-3 py-2 text-right">{{ row.updated_count }}</td>
                            <td class="px-3 py-2 text-right">{{ row.conflict_count }}</td>
                            <td class="px-3 py-2">{{ row.summary_text }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr class="border-t border-slate-200">
                            <td colspan="9" class="px-3 py-6 text-center text-slate-500">ì¡°ê±´ì— ë§ëŠ” ë°˜ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}
